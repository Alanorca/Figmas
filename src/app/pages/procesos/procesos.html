<div class="process-editor-v2">
  <!-- Sidebar Oscuro - Nodos -->
  <aside class="dark-sidebar" [class.collapsed]="sidebarCollapsed()">
    <div class="sidebar-header-dark">
      <div class="sidebar-title-row">
        <span class="sidebar-title">Nodos</span>
        <button class="close-sidebar-btn" (click)="sidebarCollapsed.set(true)">
          <i class="pi pi-times"></i>
        </button>
      </div>
    </div>

    <div class="sidebar-nodes-list">
      @for (nodeType of nodeTypes; track nodeType.type) {
        <div
          class="sidebar-node-item"
          draggable="true"
          (dragstart)="onDragStart($event, nodeType.type)"
          (dragend)="onDragEnd($event)"
          (click)="addNodeToCanvas(nodeType.type)">
          <div class="node-item-icon">
            <span class="material-icons">{{ nodeType.icon }}</span>
          </div>
          <div class="node-item-info">
            <span class="node-item-name">{{ nodeType.title }}</span>
            <span class="node-item-desc">{{ nodeType.descripcion }}</span>
          </div>
          <span class="node-drag-handle">
            <i class="pi pi-bars"></i>
          </span>
        </div>
      }
    </div>
  </aside>

  <!-- Main Content -->
  <div class="main-editor-content">
    <!-- Top Header -->
    <header class="top-header-bar">
      <div class="breadcrumb-section">
        <div class="page-title-section">
          <div class="title-with-icon">
            <div class="page-icon">
              <i class="pi pi-file-edit"></i>
            </div>
            <div class="title-text">
              <h1>{{ processService.currentProceso()?.nombre || 'Procesos' }}</h1>
              <p>{{ processService.currentProceso()?.descripcion || 'Orca@Securityby Design' }}</p>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Toolbar -->
    <div class="editor-toolbar">
      <div class="toolbar-left">
        <p-select
          [options]="nodeTypeOptions"
          [(ngModel)]="selectedNodeTypeToAdd"
          placeholder="Seleccionar nodo"
          (onChange)="onNodeTypeSelect($event)"
          styleClass="toolbar-select">
          <ng-template pTemplate="selectedItem" let-selected>
            @if (selected) {
              <span>{{ selected.label }}</span>
            } @else {
              <span>Seleccionar nodo</span>
            }
          </ng-template>
        </p-select>

        <div class="toolbar-divider"></div>

        <div class="toolbar-buttons">
          <button class="toolbar-icon-btn" pTooltip="Zoom -" (click)="zoomOut()">
            <i class="pi pi-search-minus"></i>
          </button>
          <button class="toolbar-icon-btn" pTooltip="Zoom +" (click)="zoomIn()">
            <i class="pi pi-search-plus"></i>
          </button>
          <button class="toolbar-icon-btn" pTooltip="Ajustar vista" (click)="fitView()">
            <i class="pi pi-expand"></i>
          </button>
          <button class="toolbar-icon-btn" pTooltip="Capas" (click)="toggleLayers()">
            <i class="pi pi-clone"></i>
          </button>
        </div>
      </div>

      <div class="toolbar-center">
        <span class="p-input-icon-left toolbar-search">
          <i class="pi pi-search"></i>
          <input pInputText type="text" placeholder="Buscar" [(ngModel)]="searchQuery" class="search-input" />
        </span>
      </div>

      <div class="toolbar-right">
        <p-button
          icon="pi pi-play"
          severity="secondary"
          [outlined]="true"
          (onClick)="navegarRunner()"
          pTooltip="Ejecutar proceso">
        </p-button>
        <p-button
          icon="pi pi-save"
          label="Guardar"
          severity="success"
          (onClick)="openSaveDialog()">
        </p-button>
      </div>
    </div>

    <!-- Canvas Area -->
    <div class="canvas-wrapper"
         (dragover)="onDragOver($event)"
         (drop)="onDrop($event)">

      <!-- FAB para abrir sidebar -->
      @if (sidebarCollapsed()) {
        <button class="fab-open-sidebar" (click)="sidebarCollapsed.set(false)">
          <i class="pi pi-plus"></i>
        </button>
      }

      <!-- Botones flotantes -->
      <div class="floating-actions">
        <button class="floating-btn primary" (click)="executeProcess()" [disabled]="processService.isExecuting()" pTooltip="Ejecutar proceso">
          @if (processService.isExecuting()) {
            <i class="pi pi-spin pi-spinner"></i>
          } @else {
            <i class="pi pi-play"></i>
          }
        </button>
        <button class="floating-btn" (click)="openAiAssistant()" pTooltip="Asistente IA">
          <i class="pi pi-sparkles"></i>
        </button>
        <button class="floating-btn" (click)="openApiKeyDialog()" pTooltip="API Key">
          <i class="pi pi-key"></i>
        </button>
        <button class="floating-btn" (click)="clearCanvas()" pTooltip="Limpiar">
          <i class="pi pi-trash"></i>
        </button>
      </div>

      <vflow
        [nodes]="vflowNodes()"
        [edges]="vflowEdges()"
        (onConnect)="onConnect($event)"
        view="auto"
        [background]="vflowBackground()">

        <ng-template nodeHtml let-ctx>
          <div
            class="node-card-figma"
            [class.selected]="processService.selectedNode()?.id === ctx.node.id"
            (click)="onNodeSelect(ctx.node.id)">

            <!-- Node Header: Icono + Título + Acciones -->
            <div class="node-figma-header">
              <div class="node-figma-header-left">
                <span class="material-icons node-figma-icon">{{ getNodeIcon(ctx.node.data?.nodeType) }}</span>
                <span class="node-figma-title">{{ ctx.node.data?.label || getNodeMeta(ctx.node.data?.nodeType)?.title }}</span>
              </div>
              <div class="node-figma-actions">
                <button class="node-figma-action-btn" (click)="$event.stopPropagation()" pTooltip="Agregar">
                  <i class="pi pi-plus"></i>
                </button>
                <button class="node-figma-action-btn danger" (click)="deleteNodeById(ctx.node.id); $event.stopPropagation()" pTooltip="Eliminar">
                  <i class="pi pi-trash"></i>
                </button>
              </div>
            </div>

            <!-- Node Body: Contenido específico por tipo -->
            <div class="node-figma-body">
              <!-- Descripción del nodo -->
              <p class="node-figma-description">{{ getNodeMeta(ctx.node.data?.nodeType)?.descripcion }}</p>

              <!-- ========== NODO CSV/ARCHIVO ========== -->
              @if (ctx.node.data?.nodeType === 'csv') {
                <div class="node-figma-form">
                  <input type="text" class="node-figma-input" [value]="ctx.node.data?.config?.fileName || ''" placeholder="Nombre del Nodo:" (click)="$event.stopPropagation()" />

                  <!-- Botones Choose/Upload/Cancel -->
                  <div class="node-figma-btn-group">
                    <button class="figma-btn choose" [class.active]="ctx.node.data?.config?.loadMode === 'choose'" (click)="updateNodeConfigById(ctx.node.id, { loadMode: 'choose' }); $event.stopPropagation()">
                      <i class="pi pi-check"></i> Choose
                    </button>
                    <button class="figma-btn upload" [class.active]="ctx.node.data?.config?.loadMode === 'upload'" (click)="updateNodeConfigById(ctx.node.id, { loadMode: 'upload' }); $event.stopPropagation()">
                      <i class="pi pi-upload"></i> Upload
                    </button>
                    <button class="figma-btn cancel" [class.active]="ctx.node.data?.config?.loadMode === 'cancel'" (click)="updateNodeConfigById(ctx.node.id, { loadMode: 'cancel' }); $event.stopPropagation()">
                      <i class="pi pi-times"></i> Cancel
                    </button>
                  </div>

                  <!-- Dropzone -->
                  <div class="node-figma-dropzone" (click)="$event.stopPropagation()">
                    <span>Arrastra y suelta tus archivos aquí para subirlos.</span>
                    <i class="pi pi-cloud-upload"></i>
                  </div>

                  <!-- Selector delimitador -->
                  <div class="node-figma-field">
                    <label>Delimitador (CSV):</label>
                    <select class="node-figma-select" (click)="$event.stopPropagation()">
                      <option value=",">,</option>
                      <option value=";">;</option>
                      <option value="|">|</option>
                      <option value="tab">Tab</option>
                    </select>
                  </div>

                  <!-- Botón cargar datos -->
                  <button class="figma-btn-primary" (click)="loadData(); $event.stopPropagation()">
                    Cargar Datos
                  </button>
                </div>
              }

              <!-- ========== NODO ACTIVO ========== -->
              @if (ctx.node.data?.nodeType === 'activo') {
                <div class="node-figma-form">
                  <div class="node-figma-field">
                    <label>Área del Activo:</label>
                    <select class="node-figma-select" (click)="$event.stopPropagation()">
                      <option value="">Seleccionar área...</option>
                      @for (area of areaOptions; track area.value) {
                        <option [value]="area.value">{{ area.label }}</option>
                      }
                    </select>
                  </div>

                  <div class="node-figma-field">
                    <label>Activo:</label>
                    <select class="node-figma-select" (click)="$event.stopPropagation()">
                      <option value="">Seleccionar activo...</option>
                    </select>
                  </div>

                  <button class="figma-btn-primary" (click)="vincularActivo(); $event.stopPropagation()">
                    Vincular activos
                  </button>
                </div>
              }

              <!-- ========== NODO LLM/PROMPT ========== -->
              @if (ctx.node.data?.nodeType === 'llm') {
                <div class="node-figma-form">
                  <div class="node-figma-field">
                    <label>Modelo:</label>
                    <select class="node-figma-select" (click)="$event.stopPropagation()">
                      @for (model of llmModelOptions; track model.value) {
                        <option [value]="model.value">{{ model.label }}</option>
                      }
                    </select>
                  </div>

                  <div class="node-figma-field">
                    <label>Prompt:</label>
                    <textarea class="node-figma-textarea" rows="3" placeholder="Escribe tu prompt aquí..." (click)="$event.stopPropagation()"></textarea>
                  </div>

                  <div class="node-figma-field">
                    <label>Formato de salida:</label>
                    <select class="node-figma-select" (click)="$event.stopPropagation()">
                      <option value="json">JSON</option>
                      <option value="text">Texto plano</option>
                      <option value="table">Tabla</option>
                      <option value="markdown">Markdown</option>
                    </select>
                  </div>
                </div>
              }

              <!-- ========== NODO CONDICIONAL ========== -->
              @if (ctx.node.data?.nodeType === 'condicional') {
                <div class="node-figma-form">
                  <div class="node-figma-field">
                    <label>Variable a evaluar:</label>
                    <input type="text" class="node-figma-input" placeholder="nombre_variable" (click)="$event.stopPropagation()" />
                  </div>

                  <div class="node-figma-field">
                    <label>Operador:</label>
                    <select class="node-figma-select" (click)="$event.stopPropagation()">
                      @for (op of operadorOptions; track op.value) {
                        <option [value]="op.value">{{ op.label }}</option>
                      }
                    </select>
                  </div>

                  <div class="node-figma-field">
                    <label>Valor a comparar:</label>
                    <input type="text" class="node-figma-input" placeholder="valor" (click)="$event.stopPropagation()" />
                  </div>
                </div>
              }

              <!-- ========== NODO TRANSFORMACIÓN ========== -->
              @if (ctx.node.data?.nodeType === 'transformacion') {
                <div class="node-figma-form">
                  <div class="node-figma-field">
                    <label>Operación:</label>
                    <select class="node-figma-select" (click)="$event.stopPropagation()">
                      @for (op of operacionOptions; track op.value) {
                        <option [value]="op.value">{{ op.label }}</option>
                      }
                    </select>
                  </div>

                  <div class="node-figma-field">
                    <label>Expresión / Mapeo:</label>
                    <textarea class="node-figma-textarea" rows="2" placeholder="Escribe la expresión..." (click)="$event.stopPropagation()"></textarea>
                  </div>
                </div>
              }

              <!-- ========== NODO ESTADO ========== -->
              @if (ctx.node.data?.nodeType === 'estado') {
                <div class="node-figma-form">
                  <div class="node-figma-field">
                    <label>Estado:</label>
                    <select class="node-figma-select" (click)="$event.stopPropagation()">
                      <option value="pending">Pending</option>
                      <option value="running">Running</option>
                      <option value="complete">Complete</option>
                      <option value="fail">Fail</option>
                      <option value="post">Post</option>
                      <option value="canceled">Canceled</option>
                    </select>
                  </div>

                  <div class="node-figma-field">
                    <label>Motivo:</label>
                    <input type="text" class="node-figma-input" placeholder="Motivo del cambio" (click)="$event.stopPropagation()" />
                  </div>
                </div>
              }

              <!-- ========== NODO MATEMÁTICO ========== -->
              @if (ctx.node.data?.nodeType === 'matematico') {
                <div class="node-figma-form">
                  <div class="node-figma-field">
                    <label>Fórmula:</label>
                    <div class="node-figma-formula-toolbar">
                      <button class="formula-op" (click)="$event.stopPropagation()">+</button>
                      <button class="formula-op" (click)="$event.stopPropagation()">-</button>
                      <button class="formula-op" (click)="$event.stopPropagation()">×</button>
                      <button class="formula-op" (click)="$event.stopPropagation()">÷</button>
                      <button class="formula-op" (click)="$event.stopPropagation()">(</button>
                      <button class="formula-op" (click)="$event.stopPropagation()">)</button>
                    </div>
                    <input type="text" class="node-figma-input mono" placeholder="(a + b) * c" (click)="$event.stopPropagation()" />
                  </div>
                </div>
              }

              <!-- ========== NODO BRANCHING ========== -->
              @if (ctx.node.data?.nodeType === 'branching') {
                <div class="node-figma-form">
                  <div class="node-figma-field">
                    <label>Cantidad de ramas:</label>
                    <input type="number" class="node-figma-input" min="2" max="10" value="2" (click)="$event.stopPropagation()" />
                  </div>

                  <div class="node-figma-field">
                    <label>Estrategia:</label>
                    <select class="node-figma-select" (click)="$event.stopPropagation()">
                      <option value="parallel">Paralelo</option>
                      <option value="sequential">Secuencial</option>
                    </select>
                  </div>
                </div>
              }

              <!-- ========== NODO ML ========== -->
              @if (ctx.node.data?.nodeType === 'ml') {
                <div class="node-figma-form">
                  <div class="node-figma-field">
                    <label>Nombre del modelo:</label>
                    <input type="text" class="node-figma-input" placeholder="Mi modelo ML" (click)="$event.stopPropagation()" />
                  </div>

                  <div class="node-figma-field">
                    <label>Tipo de modelo:</label>
                    <select class="node-figma-select" (click)="$event.stopPropagation()">
                      <option value="classification">Clasificación</option>
                      <option value="regression">Regresión</option>
                      <option value="clustering">Clustering</option>
                    </select>
                  </div>

                  <div class="node-figma-field">
                    <label>Endpoint:</label>
                    <input type="text" class="node-figma-input" placeholder="https://api.ml/predict" (click)="$event.stopPropagation()" />
                  </div>
                </div>
              }

              <!-- ========== NODO INTEGRACIÓN ========== -->
              @if (ctx.node.data?.nodeType === 'integracion') {
                <div class="node-figma-form">
                  <div class="node-figma-badge-dev">
                    <i class="pi pi-wrench"></i> En desarrollo
                  </div>
                  <p class="node-figma-hint">Próximamente: conexión con bases de datos y APIs externas.</p>
                </div>
              }
            </div>

            <handle type="source" position="right" />
            <handle type="target" position="left" />
          </div>
        </ng-template>
      </vflow>
    </div>
  </div>

  <!-- Panel de Propiedades (derecha) -->
  @if (showConfigSidebar() && processService.selectedNode(); as node) {
    <aside class="properties-panel-v2">
      <!-- Header -->
      <div class="props-panel-header">
        <div class="props-header-info">
          <div class="props-icon">
            <span class="material-icons">{{ getNodeIcon(node.type) }}</span>
          </div>
          <div class="props-title-text">
            <h3>{{ getNodeMeta(node.type)?.title }}</h3>
            <p>{{ getNodeDescription(node.type) }}</p>
          </div>
        </div>
        <button class="close-panel-btn" (click)="closeConfigSidebar()">
          <i class="pi pi-times"></i>
        </button>
      </div>

      <!-- TabView para configuracion -->
      <p-tabs [(value)]="activeTab" styleClass="props-tabs">
        <p-tablist>
          <p-tab value="config">
            <i class="pi pi-cog mr-2"></i>
            Configuracion
          </p-tab>
          <p-tab value="input">
            <i class="pi pi-sign-in mr-2"></i>
            Entrada
          </p-tab>
          <p-tab value="output">
            <i class="pi pi-sign-out mr-2"></i>
            Salida
          </p-tab>
        </p-tablist>

        <p-tabpanels>
          <!-- TAB: CONFIGURACION -->
          <p-tabpanel value="config">
            <div class="props-section">
              <label class="props-label">Nombre del Nodo</label>
              <input pInputText [ngModel]="node.label" (ngModelChange)="updateNodeLabel($event)" class="w-full" />
            </div>

            <!-- Configuracion especifica por tipo -->
            @switch (node.type) {
              @case ('csv') {
                <div class="props-section">
                  <label class="props-label">Nombre del archivo</label>
                  <input pInputText [ngModel]="getConfigValue(node, 'fileName')"
                         (ngModelChange)="updateNodeConfig({ fileName: $event })"
                         placeholder="datos.csv" class="w-full" />
                </div>

                <div class="props-section">
                  <label class="props-label">Modo de carga</label>
                  <div class="btn-group-choice">
                    <button class="choice-btn" [class.active]="getConfigValue(node, 'loadMode') === 'choose'"
                            (click)="updateNodeConfig({ loadMode: 'choose' })">
                      <i class="pi pi-check"></i> Choose
                    </button>
                    <button class="choice-btn" [class.active]="getConfigValue(node, 'loadMode') === 'upload'"
                            (click)="updateNodeConfig({ loadMode: 'upload' })">
                      <i class="pi pi-upload"></i> Upload
                    </button>
                    <button class="choice-btn" [class.active]="getConfigValue(node, 'loadMode') === 'cancel'"
                            (click)="updateNodeConfig({ loadMode: 'cancel' })">
                      <i class="pi pi-times"></i> Cancel
                    </button>
                  </div>
                </div>

                <div class="props-section">
                  <label class="props-label">Arrastra y suelta tus archivos aqui para subirlos.</label>
                  <div class="file-drop-zone">
                    <i class="pi pi-cloud-upload"></i>
                  </div>
                </div>

                <div class="props-section">
                  <label class="props-label">Delimitador (CSV):</label>
                  <p-select [options]="delimiterOptions" [ngModel]="getConfigValue(node, 'delimiter')"
                            (ngModelChange)="updateNodeConfig({ delimiter: $event })" styleClass="w-full"></p-select>
                </div>

                <button class="props-action-btn primary" (click)="loadData()">
                  Cargar Datos
                </button>
              }

              @case ('activo') {
                <!-- Selección del Activo -->
                <div class="activo-seleccion-section">
                  <div class="props-section">
                    <label class="props-label" for="area-select">
                      <span class="material-symbols-rounded icon-label">domain</span>
                      Departamento
                    </label>
                    <p-select
                      id="area-select"
                      [options]="areaOptions"
                      [ngModel]="getConfigValue(node, 'area')"
                      (ngModelChange)="onAreaChange($event)"
                      placeholder="Filtrar por departamento..."
                      styleClass="w-full"
                    ></p-select>
                  </div>

                  <div class="props-section">
                    <label class="props-label" for="activo-select">
                      <span class="material-symbols-rounded icon-label">category</span>
                      Activo
                      @if (activoOptions().length === 0 && areaSeleccionadaActivo()) {
                        <span class="label-hint">(sin activos en esta área)</span>
                      }
                    </label>
                    <p-select
                      id="activo-select"
                      [options]="activoOptions()"
                      [ngModel]="getConfigValue(node, 'activoId')"
                      (ngModelChange)="onActivoChange($event)"
                      placeholder="Seleccionar activo..."
                      styleClass="w-full"
                      [filter]="true"
                      filterPlaceholder="Buscar activo..."
                    ></p-select>
                  </div>
                </div>

                <!-- Info del activo seleccionado -->
                @if (activoSeleccionadoParaNodo(); as activo) {
                  <div class="activo-info-card">
                    <div class="activo-info-header">
                      <span class="material-symbols-rounded activo-icon">category</span>
                      <div class="activo-info-text">
                        <strong>{{ activo.nombre }}</strong>
                        <small>{{ activo.tipo | titlecase }}</small>
                      </div>
                      <p-tag
                        [value]="activo.criticidad | titlecase"
                        [severity]="activo.criticidad === 'alta' ? 'danger' : activo.criticidad === 'media' ? 'warn' : 'success'"
                        styleClass="criticidad-badge"
                      ></p-tag>
                    </div>
                    @if (activo.descripcion) {
                      <p class="activo-descripcion">{{ activo.descripcion }}</p>
                    }
                    @if (plantillaDelActivo(); as plantilla) {
                      <div class="activo-plantilla">
                        <span class="material-symbols-rounded">description</span>
                        {{ plantilla.nombre }}
                      </div>
                    }
                  </div>

                  <!-- Panel: Propiedades a Exponer -->
                  <p-panel
                    header="Propiedades a Exponer"
                    [toggleable]="true"
                    styleClass="activo-panel"
                  >
                    <ng-template pTemplate="headericons">
                      @if (contadorPropiedadesBase() + contadorPropiedadesCustom() > 0) {
                        <p-tag [value]="(contadorPropiedadesBase() + contadorPropiedadesCustom()).toString()" severity="info" styleClass="panel-counter"></p-tag>
                      }
                    </ng-template>

                    <div class="panel-content">
                      <!-- Propiedades Base -->
                      <div class="props-subsection">
                        <label class="props-sublabel">
                          <span class="material-symbols-rounded icon-small">output</span>
                          Base
                          @if (contadorPropiedadesBase() > 0) {
                            <span class="counter-badge">{{ contadorPropiedadesBase() }}</span>
                          }
                        </label>
                        <p-multiselect
                          [options]="propiedadesBaseOptionsForSelect"
                          [ngModel]="propiedadesExpuestasSeleccionadas()"
                          (ngModelChange)="onPropiedadesExpuestasChange($event)"
                          optionLabel="label"
                          optionValue="value"
                          [filter]="true"
                          filterPlaceHolder="Buscar..."
                          placeholder="Seleccionar propiedades base..."
                          display="chip"
                          styleClass="w-full"
                          [showClear]="true"
                          [showToggleAll]="true"
                          aria-label="Propiedades base del activo"
                        ></p-multiselect>
                      </div>

                      <!-- Propiedades Custom -->
                      @if (propiedadesCustomOptionsForSelect().length > 0) {
                        <div class="props-subsection">
                          <label class="props-sublabel">
                            <span class="material-symbols-rounded icon-small">tune</span>
                            Custom
                            @if (contadorPropiedadesCustom() > 0) {
                              <span class="counter-badge">{{ contadorPropiedadesCustom() }}</span>
                            }
                          </label>
                          <p-multiselect
                            [options]="propiedadesCustomOptionsForSelect()"
                            [ngModel]="propiedadesCustomExpuestasSeleccionadas()"
                            (ngModelChange)="onPropiedadesCustomExpuestasChange($event)"
                            optionLabel="label"
                            optionValue="value"
                            [filter]="true"
                            filterPlaceHolder="Buscar..."
                            placeholder="Seleccionar propiedades custom..."
                            display="chip"
                            styleClass="w-full"
                            [showClear]="true"
                            [showToggleAll]="true"
                            aria-label="Propiedades custom del activo"
                          ></p-multiselect>
                        </div>
                      }
                    </div>
                  </p-panel>

                  <!-- Panel: Datos Relacionados -->
                  @if (activo.riesgos.length > 0 || activo.incidentes.length > 0 || activo.defectos.length > 0) {
                    <p-panel
                      header="Datos Relacionados"
                      [toggleable]="true"
                      [collapsed]="true"
                      styleClass="activo-panel"
                    >
                      <ng-template pTemplate="headericons">
                        @if (contadorRiesgos() + contadorIncidentes() + contadorDefectos() > 0) {
                          <p-tag [value]="(contadorRiesgos() + contadorIncidentes() + contadorDefectos()).toString()" severity="info" styleClass="panel-counter"></p-tag>
                        }
                      </ng-template>

                      <div class="panel-content">
                        <!-- Riesgos -->
                        @if (activo.riesgos.length > 0) {
                          <div class="props-subsection">
                            <label class="props-sublabel riesgos-label">
                              <span class="material-symbols-rounded icon-small">gpp_maybe</span>
                              Riesgos
                              <span class="total-badge">{{ activo.riesgos.length }}</span>
                              @if (contadorRiesgos() > 0) {
                                <span class="counter-badge selected">{{ contadorRiesgos() }} sel.</span>
                              }
                            </label>
                            <p-multiselect
                              [options]="riesgosOptionsForSelect()"
                              [ngModel]="riesgosSeleccionados()"
                              (ngModelChange)="onRiesgosSeleccionadosChange($event)"
                              optionLabel="label"
                              optionValue="value"
                              [filter]="true"
                              filterPlaceHolder="Buscar riesgo..."
                              placeholder="Seleccionar riesgos..."
                              display="chip"
                              styleClass="w-full"
                              [showClear]="true"
                              [showToggleAll]="true"
                              aria-label="Riesgos relacionados al activo"
                            ></p-multiselect>
                          </div>
                        }

                        <!-- Incidentes -->
                        @if (activo.incidentes.length > 0) {
                          <div class="props-subsection">
                            <label class="props-sublabel incidentes-label">
                              <span class="material-symbols-rounded icon-small">report</span>
                              Incidentes
                              <span class="total-badge">{{ activo.incidentes.length }}</span>
                              @if (contadorIncidentes() > 0) {
                                <span class="counter-badge selected">{{ contadorIncidentes() }} sel.</span>
                              }
                            </label>
                            <p-multiselect
                              [options]="incidentesOptionsForSelect()"
                              [ngModel]="incidentesSeleccionados()"
                              (ngModelChange)="onIncidentesSeleccionadosChange($event)"
                              optionLabel="label"
                              optionValue="value"
                              [filter]="true"
                              filterPlaceHolder="Buscar incidente..."
                              placeholder="Seleccionar incidentes..."
                              display="chip"
                              styleClass="w-full"
                              [showClear]="true"
                              [showToggleAll]="true"
                              aria-label="Incidentes relacionados al activo"
                            ></p-multiselect>
                          </div>
                        }

                        <!-- Defectos -->
                        @if (activo.defectos.length > 0) {
                          <div class="props-subsection">
                            <label class="props-sublabel defectos-label">
                              <span class="material-symbols-rounded icon-small">bug_report</span>
                              Defectos
                              <span class="total-badge">{{ activo.defectos.length }}</span>
                              @if (contadorDefectos() > 0) {
                                <span class="counter-badge selected">{{ contadorDefectos() }} sel.</span>
                              }
                            </label>
                            <p-multiselect
                              [options]="defectosOptionsForSelect()"
                              [ngModel]="defectosSeleccionados()"
                              (ngModelChange)="onDefectosSeleccionadosChange($event)"
                              optionLabel="label"
                              optionValue="value"
                              [filter]="true"
                              filterPlaceHolder="Buscar defecto..."
                              placeholder="Seleccionar defectos..."
                              display="chip"
                              styleClass="w-full"
                              [showClear]="true"
                              [showToggleAll]="true"
                              aria-label="Defectos relacionados al activo"
                            ></p-multiselect>
                          </div>
                        }
                      </div>
                    </p-panel>
                  }

                  <!-- Panel: Variables de Salida -->
                  <p-panel
                    header="Variables de Salida"
                    [toggleable]="true"
                    styleClass="activo-panel variables-panel"
                  >
                    <ng-template pTemplate="headericons">
                      @if (variablesSalidaActivo().length > 0) {
                        <p-tag [value]="variablesSalidaActivo().length.toString()" severity="success" styleClass="panel-counter"></p-tag>
                      }
                    </ng-template>

                    <div class="output-vars-container">
                      @if (variablesSalidaActivo().length > 0) {
                        <div class="output-vars-grid">
                          @for (variable of variablesSalidaActivo(); track variable) {
                            <div class="output-var-item" pTooltip="Click para copiar" tooltipPosition="top">
                              <code>{{ '{{' }}{{ variable }}{{ '}}' }}</code>
                              <button class="copy-btn" (click)="copyToClipboard('{{' + variable + '}}')" type="button">
                                <span class="material-symbols-rounded">content_copy</span>
                              </button>
                            </div>
                          }
                        </div>
                      } @else {
                        <div class="empty-vars-state">
                          <span class="material-symbols-rounded">code_off</span>
                          <p>Selecciona propiedades para generar variables de salida</p>
                        </div>
                      }
                    </div>
                  </p-panel>
                } @else {
                  <!-- Estado vacío -->
                  <div class="props-empty-state">
                    <span class="material-symbols-rounded">category</span>
                    <p>Selecciona un activo para configurar sus propiedades</p>
                    <small>Puedes filtrar por área para encontrar activos más rápido</small>
                  </div>
                }
              }

              @case ('llm') {
                <div class="props-section">
                  <label class="props-label">Modelo</label>
                  <p-select [options]="llmModelOptions" [ngModel]="getConfigValue(node, 'model')"
                            (ngModelChange)="updateNodeConfig({ model: $event })" styleClass="w-full"></p-select>
                </div>

                <div class="props-section">
                  <label class="props-label">System Prompt</label>
                  <textarea pTextarea [ngModel]="getConfigValue(node, 'systemPrompt')"
                            (ngModelChange)="updateNodeConfig({ systemPrompt: $event })"
                            rows="3" class="w-full font-mono" placeholder="Eres un asistente experto en..."></textarea>
                </div>

                <div class="props-section">
                  <label class="props-label">Prompt</label>
                  <textarea pTextarea [ngModel]="getConfigValue(node, 'prompt')"
                            (ngModelChange)="updateNodeConfig({ prompt: $event })"
                            rows="4" class="w-full font-mono" [placeholder]="'Analiza: ' + '{{variable}}'"></textarea>
                  <small class="props-help">Usa {{ '{{' }}variable{{ '}}' }} para insertar datos</small>
                </div>

                <div class="props-section">
                  <div class="props-row">
                    <div class="props-col">
                      <label class="props-label">Temperatura</label>
                      <p-inputNumber [ngModel]="getConfigValue(node, 'temperature') || 0.7"
                                     (ngModelChange)="updateNodeConfig({ temperature: $event })"
                                     [min]="0" [max]="2" [step]="0.1" mode="decimal" styleClass="w-full"></p-inputNumber>
                    </div>
                    <div class="props-col">
                      <label class="props-label">Max Tokens</label>
                      <p-inputNumber [ngModel]="getConfigValue(node, 'maxTokens') || 2048"
                                     (ngModelChange)="updateNodeConfig({ maxTokens: $event })"
                                     [min]="256" [max]="8192" [step]="256" styleClass="w-full"></p-inputNumber>
                    </div>
                  </div>
                </div>
              }

              @case ('condicional') {
                <!-- CON-001: Definición de Condición Simple -->
                <div class="props-section">
                  <label class="props-label">Variable a Evaluar</label>
                  <input pInputText [ngModel]="getConfigValue(node, 'variable')"
                         (ngModelChange)="updateNodeConfig({ variable: $event })"
                         placeholder="nombre_variable" class="w-full" />
                  <small class="props-help">Nombre de la variable del contexto</small>
                </div>

                <!-- Variables disponibles -->
                <div class="props-section">
                  <label class="props-label">Variables Disponibles</label>
                  <div class="condition-variables">
                    @for (variable of availableVariables(); track variable.name) {
                      <p-chip
                        [label]="variable.name"
                        [pTooltip]="'Tipo: ' + variable.type + ' | Fuente: ' + variable.source"
                        styleClass="cursor-pointer variable-chip"
                        (click)="updateNodeConfig({ variable: variable.name })">
                      </p-chip>
                    }
                  </div>
                </div>

                <!-- CON-002: Operadores de Comparación -->
                <div class="props-section">
                  <label class="props-label">Operador</label>
                  <p-select [options]="operadorOptions" [ngModel]="getConfigValue(node, 'operador')"
                            (ngModelChange)="updateNodeConfig({ operador: $event })" styleClass="w-full"></p-select>
                  <small class="props-help">{{ getOperadorDescription(getConfigValue(node, 'operador')) }}</small>
                </div>

                <!-- CON-003: Tipo de Comparación -->
                <div class="props-section">
                  <label class="props-label">Tipo de Comparación</label>
                  <p-select [options]="tipoComparacionOptions" [ngModel]="getConfigValue(node, 'tipoComparacion') ?? 'string'"
                            (ngModelChange)="updateNodeConfig({ tipoComparacion: $event })" styleClass="w-full"></p-select>
                  <small class="props-help">Los valores se convertirán a este tipo antes de comparar</small>
                </div>

                <div class="props-section">
                  <label class="props-label">Valor a Comparar</label>
                  <input pInputText [ngModel]="getConfigValue(node, 'valor')"
                         (ngModelChange)="updateNodeConfig({ valor: $event })"
                         placeholder="valor" class="w-full" />
                </div>

                <!-- CON-005: Preview de Evaluación -->
                <div class="props-section">
                  <label class="props-label">Vista Previa de la Condición</label>
                  <div class="condition-preview">
                    @if (getConfigValue(node, 'variable') && getConfigValue(node, 'operador')) {
                      <div class="preview-condition-box">
                        <div class="condition-expression">
                          <code>{{ getConfigValue(node, 'variable') }}</code>
                          <span class="condition-operator">{{ getOperadorSymbol(getConfigValue(node, 'operador')) }}</span>
                          <code>{{ getConfigValue(node, 'valor') || '?' }}</code>
                        </div>
                        <div class="condition-result">
                          <span class="result-label">Resultado con ejemplo:</span>
                          <div class="branches-preview">
                            <div class="branch-item" [class.active]="evaluateConditionPreview()">
                              <span class="material-icons text-green-500">check_circle</span>
                              <span>TRUE</span>
                            </div>
                            <div class="branch-item" [class.active]="!evaluateConditionPreview()">
                              <span class="material-icons text-red-500">cancel</span>
                              <span>FALSE</span>
                            </div>
                          </div>
                        </div>
                      </div>
                    } @else {
                      <div class="preview-empty-condition">
                        <span class="material-icons">help_outline</span>
                        <span>Configura la variable y operador para ver el preview</span>
                      </div>
                    }
                  </div>
                </div>

                <!-- CON-004: Ramas de Salida (Información) -->
                <div class="props-section">
                  <p-message severity="info" [closable]="false" styleClass="w-full">
                    <span class="flex align-items-center gap-2">
                      <span class="material-icons text-sm">info</span>
                      Este nodo tiene 2 salidas: <strong>TRUE</strong> (condición cumplida) y <strong>FALSE</strong> (no cumplida)
                    </span>
                  </p-message>
                </div>
              }

              @case ('webhook') {
                <!-- Configuración de Webhook -->
                <div class="props-section">
                  <label class="props-label">Método HTTP</label>
                  <p-select [options]="webhookMethodOptions" [ngModel]="webhookConfig()?.method"
                            (ngModelChange)="onWebhookMethodChange($event)" styleClass="w-full"
                            optionLabel="label" optionValue="value"></p-select>
                </div>
                <div class="props-section">
                  <label class="props-label">URL</label>
                  <input pInputText [ngModel]="webhookConfig()?.url"
                         (ngModelChange)="onWebhookUrlChange($event)"
                         placeholder="https://api.ejemplo.com/endpoint" class="w-full" />
                </div>
                <div class="props-section">
                  <label class="props-label">Autenticación</label>
                  <p-select [options]="webhookAuthTypeOptions" [ngModel]="webhookAuthType()"
                            (ngModelChange)="onWebhookAuthTypeChange($event)" styleClass="w-full"
                            optionLabel="label" optionValue="value"></p-select>
                </div>
                @if (webhookAuthType() === 'bearer') {
                  <div class="props-section">
                    <label class="props-label">Token</label>
                    <input pInputText [ngModel]="getWebhookAuthField('token')"
                           (ngModelChange)="updateWebhookAuth('token', $event)"
                           placeholder="Bearer token" class="w-full" type="password" />
                  </div>
                }
                @if (webhookAuthType() === 'basic') {
                  <div class="props-section">
                    <label class="props-label">Usuario</label>
                    <input pInputText [ngModel]="getWebhookAuthField('username')"
                           (ngModelChange)="updateWebhookAuth('username', $event)"
                           placeholder="usuario" class="w-full" />
                  </div>
                  <div class="props-section">
                    <label class="props-label">Contraseña</label>
                    <input pInputText [ngModel]="getWebhookAuthField('password')"
                           (ngModelChange)="updateWebhookAuth('password', $event)"
                           placeholder="contraseña" class="w-full" type="password" />
                  </div>
                }
                @if (webhookAuthType() === 'apiKey') {
                  <div class="props-section">
                    <label class="props-label">Nombre del header/param</label>
                    <input pInputText [ngModel]="getWebhookAuthField('key')"
                           (ngModelChange)="updateWebhookAuth('key', $event)"
                           placeholder="X-API-Key" class="w-full" />
                  </div>
                  <div class="props-section">
                    <label class="props-label">Valor</label>
                    <input pInputText [ngModel]="getWebhookAuthField('value')"
                           (ngModelChange)="updateWebhookAuth('value', $event)"
                           placeholder="tu-api-key" class="w-full" type="password" />
                  </div>
                }
                <div class="props-section">
                  <label class="props-label">Variable de salida</label>
                  <input pInputText [ngModel]="webhookConfig()?.outputKey"
                         (ngModelChange)="updateNodeConfig({ outputKey: $event })"
                         placeholder="webhookResponse" class="w-full" />
                </div>
                <div class="props-section">
                  <label class="props-label">Timeout (ms)</label>
                  <p-inputNumber [ngModel]="webhookConfig()?.timeout"
                                 (ngModelChange)="updateNodeConfig({ timeout: $event })"
                                 [min]="1000" [max]="120000" [step]="1000" styleClass="w-full"></p-inputNumber>
                </div>
                <div class="props-section">
                  <p-button label="Probar conexión" icon="pi pi-play" severity="secondary"
                            [loading]="isTestRunning()" (onClick)="testWebhookConnection()"></p-button>
                </div>
              }

              @case ('transformacion') {
                <!-- Configuración de Transformación Expandida -->
                <div class="props-section">
                  <label class="props-label">Operación</label>
                  <p-select [options]="operacionOptions" [ngModel]="transformOperation()"
                            (ngModelChange)="onTransformOperationChange($event)" styleClass="w-full"
                            optionLabel="label" optionValue="value">
                    <ng-template pTemplate="item" let-item>
                      <div class="flex align-items-center gap-2">
                        <span class="material-icons text-sm">{{ item.icon }}</span>
                        <span>{{ item.label }}</span>
                      </div>
                    </ng-template>
                  </p-select>
                  <small class="props-hint">{{ getOperationDescription(transformOperation()) }}</small>
                </div>

                <div class="props-section">
                  <label class="props-label">Variable de entrada</label>
                  <input pInputText [ngModel]="transformConfig()?.inputKey"
                         (ngModelChange)="onTransformInputKeyChange($event)"
                         placeholder="datos" class="w-full" />
                </div>

                <div class="props-section">
                  <label class="props-label">Variable de salida</label>
                  <input pInputText [ngModel]="transformConfig()?.outputKey"
                         (ngModelChange)="onTransformOutputKeyChange($event)"
                         placeholder="datosTransformados" class="w-full" />
                </div>

                <!-- Configuración específica por operación -->
                @switch (transformOperation()) {
                  @case ('filter') {
                    <div class="props-section">
                      <div class="section-header">
                        <label class="props-label">Condiciones de filtro</label>
                        <p-button icon="pi pi-plus" size="small" [text]="true" (onClick)="addFilterCondition()"></p-button>
                      </div>
                      <div class="filter-logic-toggle" (click)="toggleFilterLogic()">
                        <span class="logic-badge">{{ transformConfig()?.filterConfig?.conditionGroup?.logic || 'AND' }}</span>
                      </div>
                      @for (condition of filterConditions(); track $index) {
                        <div class="condition-row">
                          <input pInputText [ngModel]="condition.field"
                                 (ngModelChange)="updateFilterCondition($index, 'field', $event)"
                                 placeholder="campo" class="field-input" />
                          <p-select [options]="filterOperatorOptions" [ngModel]="condition.operator"
                                    (ngModelChange)="updateFilterCondition($index, 'operator', $event)"
                                    optionLabel="label" optionValue="value" styleClass="operator-select"></p-select>
                          <input pInputText [ngModel]="condition.value"
                                 (ngModelChange)="updateFilterCondition($index, 'value', $event)"
                                 placeholder="valor" class="value-input" />
                          <button class="remove-btn" (click)="removeFilterCondition($index)">
                            <i class="pi pi-times"></i>
                          </button>
                        </div>
                      }
                    </div>
                  }

                  @case ('sort') {
                    <div class="props-section">
                      <div class="section-header">
                        <label class="props-label">Campos de ordenamiento</label>
                        <p-button icon="pi pi-plus" size="small" [text]="true" (onClick)="addSortField()"></p-button>
                      </div>
                      @for (field of sortFields(); track $index) {
                        <div class="sort-row">
                          <input pInputText [ngModel]="field.field"
                                 (ngModelChange)="updateSortField($index, 'field', $event)"
                                 placeholder="campo" class="field-input" />
                          <p-select [options]="[{label: 'Ascendente', value: 'asc'}, {label: 'Descendente', value: 'desc'}]"
                                    [ngModel]="field.direction"
                                    (ngModelChange)="updateSortField($index, 'direction', $event)"
                                    optionLabel="label" optionValue="value" styleClass="direction-select"></p-select>
                          <button class="remove-btn" (click)="removeSortField($index)">
                            <i class="pi pi-times"></i>
                          </button>
                        </div>
                      }
                    </div>
                  }

                  @case ('aggregate') {
                    <div class="props-section">
                      <label class="props-label">Agrupar por (GROUP BY)</label>
                      <input pInputText [ngModel]="aggregateGroupBy().join(', ')"
                             (ngModelChange)="parseAndUpdateGroupBy($event)"
                             placeholder="campo1, campo2" class="w-full" />
                    </div>
                    <div class="props-section">
                      <div class="section-header">
                        <label class="props-label">Agregaciones</label>
                        <p-button icon="pi pi-plus" size="small" [text]="true" (onClick)="addAggregateField()"></p-button>
                      </div>
                      @for (agg of aggregateFields(); track $index) {
                        <div class="aggregate-row">
                          <p-select [options]="aggregateFunctionOptions" [ngModel]="agg.function"
                                    (ngModelChange)="updateAggregateField($index, 'function', $event)"
                                    optionLabel="label" optionValue="value" styleClass="func-select"></p-select>
                          <input pInputText [ngModel]="agg.field"
                                 (ngModelChange)="updateAggregateField($index, 'field', $event)"
                                 placeholder="campo" class="field-input" />
                          <input pInputText [ngModel]="agg.alias"
                                 (ngModelChange)="updateAggregateField($index, 'alias', $event)"
                                 placeholder="alias" class="alias-input" />
                          <button class="remove-btn" (click)="removeAggregateField($index)">
                            <i class="pi pi-times"></i>
                          </button>
                        </div>
                      }
                    </div>
                  }

                  @case ('map') {
                    <div class="props-section">
                      <div class="section-header">
                        <label class="props-label">Mapeo de campos</label>
                        <p-button icon="pi pi-plus" size="small" [text]="true" (onClick)="addMapField()"></p-button>
                      </div>
                      @for (mapping of mapFields(); track $index) {
                        <div class="map-row">
                          <input pInputText [ngModel]="mapping.sourceField"
                                 (ngModelChange)="updateMapField($index, 'sourceField', $event)"
                                 placeholder="origen" class="source-input" />
                          <span class="arrow-icon"><i class="pi pi-arrow-right"></i></span>
                          <input pInputText [ngModel]="mapping.targetField"
                                 (ngModelChange)="updateMapField($index, 'targetField', $event)"
                                 placeholder="destino" class="target-input" />
                          <button class="remove-btn" (click)="removeMapField($index)">
                            <i class="pi pi-times"></i>
                          </button>
                        </div>
                      }
                    </div>
                    <div class="props-section">
                      <p-checkbox [ngModel]="transformConfig()?.mapConfig?.keepUnmapped"
                                  (ngModelChange)="updateMapConfig('keepUnmapped', $event)"
                                  [binary]="true" label="Mantener campos no mapeados"></p-checkbox>
                    </div>
                  }

                  @case ('deduplicate') {
                    <div class="props-section">
                      <label class="props-label">Campos clave (determina duplicados)</label>
                      <input pInputText [ngModel]="deduplicateKeyFields().join(', ')"
                             (ngModelChange)="parseAndUpdateDeduplicateKeys($event)"
                             placeholder="id, email" class="w-full" />
                      <small class="props-hint">Campos separados por coma que determinan unicidad</small>
                    </div>
                    <div class="props-section">
                      <label class="props-label">Estrategia de conservación</label>
                      <p-select [options]="deduplicateStrategyOptions"
                                [ngModel]="transformConfig()?.deduplicateConfig?.keepStrategy || 'first'"
                                (ngModelChange)="updateDeduplicateConfig('keepStrategy', $event)"
                                styleClass="w-full" optionLabel="label" optionValue="value"></p-select>
                    </div>
                    @if (transformConfig()?.deduplicateConfig?.keepStrategy === 'max' || transformConfig()?.deduplicateConfig?.keepStrategy === 'min') {
                      <div class="props-section">
                        <label class="props-label">Campo para comparación</label>
                        <input pInputText [ngModel]="transformConfig()?.deduplicateConfig?.keepField"
                               (ngModelChange)="updateDeduplicateConfig('keepField', $event)"
                               placeholder="fecha, score" class="w-full" />
                      </div>
                    }
                  }

                  @case ('enrich') {
                    <div class="props-section">
                      <label class="props-label">Origen de datos</label>
                      <p-select [options]="enrichSourceTypeOptions"
                                [ngModel]="transformConfig()?.enrichConfig?.sourceType || 'context'"
                                (ngModelChange)="updateEnrichConfig('sourceType', $event)"
                                styleClass="w-full" optionLabel="label" optionValue="value"></p-select>
                    </div>
                    @if (transformConfig()?.enrichConfig?.sourceType === 'context') {
                      <div class="props-section">
                        <label class="props-label">Variable del contexto</label>
                        <input pInputText [ngModel]="transformConfig()?.enrichConfig?.contextVariable"
                               (ngModelChange)="updateEnrichConfig('contextVariable', $event)"
                               placeholder="lookupData" class="w-full" />
                      </div>
                    }
                    <div class="props-section">
                      <label class="props-label">Campo clave de búsqueda (origen)</label>
                      <input pInputText [ngModel]="transformConfig()?.enrichConfig?.lookupKey"
                             (ngModelChange)="updateEnrichConfig('lookupKey', $event)"
                             placeholder="customerId" class="w-full" />
                    </div>
                    <div class="props-section">
                      <label class="props-label">Campo clave en datos de enriquecimiento</label>
                      <input pInputText [ngModel]="getEnrichMappingField('sourceField')"
                             (ngModelChange)="updateEnrichMappingField('sourceField', $event)"
                             placeholder="id" class="w-full" />
                    </div>
                    <div class="props-section">
                      <label class="props-label">Campos a agregar (separados por coma)</label>
                      <input pInputText [ngModel]="getEnrichFieldsToAdd()"
                             (ngModelChange)="updateEnrichFieldsToAdd($event)"
                             placeholder="name, email, tier" class="w-full" />
                      <small class="props-hint">Usa * para agregar todos los campos</small>
                    </div>
                    <div class="props-section">
                      <label class="props-label">Si no encuentra coincidencia</label>
                      <p-select [options]="enrichOnNotFoundOptions"
                                [ngModel]="transformConfig()?.enrichConfig?.onNotFound || 'null'"
                                (ngModelChange)="updateEnrichConfig('onNotFound', $event)"
                                styleClass="w-full" optionLabel="label" optionValue="value"></p-select>
                    </div>
                  }

                  @case ('flatten') {
                    <div class="props-section">
                      <label class="props-label">Campo a aplanar</label>
                      <input pInputText [ngModel]="transformConfig()?.flattenConfig?.field"
                             (ngModelChange)="updateFlattenConfig('field', $event)"
                             placeholder="items, details" class="w-full" />
                    </div>
                    <div class="props-section">
                      <label class="props-label">Modo</label>
                      <p-select [options]="flattenModeOptions"
                                [ngModel]="transformConfig()?.flattenConfig?.mode || 'expand'"
                                (ngModelChange)="updateFlattenConfig('mode', $event)"
                                styleClass="w-full" optionLabel="label" optionValue="value"></p-select>
                      <small class="props-hint">Expand: un registro por elemento. Extract: extrae campos anidados</small>
                    </div>
                    <div class="props-section">
                      <label class="props-label">Prefijo para campos</label>
                      <input pInputText [ngModel]="transformConfig()?.flattenConfig?.prefix"
                             (ngModelChange)="updateFlattenConfig('prefix', $event)"
                             placeholder="item_" class="w-full" />
                    </div>
                    <div class="props-section">
                      <label class="props-label">Profundidad máxima</label>
                      <p-inputNumber [ngModel]="transformConfig()?.flattenConfig?.depth || 1"
                                     (ngModelChange)="updateFlattenConfig('depth', $event)"
                                     [min]="1" [max]="10" styleClass="w-full"></p-inputNumber>
                    </div>
                  }

                  @case ('group') {
                    <div class="props-section">
                      <label class="props-label">Campos de agrupación</label>
                      <input pInputText [ngModel]="groupKeyFields().join(', ')"
                             (ngModelChange)="parseAndUpdateGroupKeys($event)"
                             placeholder="region, categoria" class="w-full" />
                      <small class="props-hint">Los registros se agruparán por estos campos</small>
                    </div>
                    <div class="props-section">
                      <label class="props-label">Nombre del campo para el grupo</label>
                      <input pInputText [ngModel]="transformConfig()?.groupConfig?.valueField"
                             (ngModelChange)="updateGroupConfig('valueField', $event)"
                             placeholder="items" class="w-full" />
                    </div>
                    <div class="props-section">
                      <p-checkbox [ngModel]="transformConfig()?.groupConfig?.includeCount"
                                  (ngModelChange)="updateGroupConfig('includeCount', $event)"
                                  [binary]="true" label="Incluir conteo de registros"></p-checkbox>
                    </div>
                  }

                  @case ('pivot') {
                    <div class="props-section">
                      <label class="props-label">Campos de fila</label>
                      <input pInputText [ngModel]="pivotRowFields().join(', ')"
                             (ngModelChange)="parseAndUpdatePivotRows($event)"
                             placeholder="producto, categoria" class="w-full" />
                    </div>
                    <div class="props-section">
                      <label class="props-label">Campo de columna (valores serán columnas)</label>
                      <input pInputText [ngModel]="transformConfig()?.pivotConfig?.columnField"
                             (ngModelChange)="updatePivotConfig('columnField', $event)"
                             placeholder="mes" class="w-full" />
                    </div>
                    <div class="props-section">
                      <label class="props-label">Campo de valor</label>
                      <input pInputText [ngModel]="transformConfig()?.pivotConfig?.valueField"
                             (ngModelChange)="updatePivotConfig('valueField', $event)"
                             placeholder="ventas" class="w-full" />
                    </div>
                    <div class="props-section">
                      <label class="props-label">Función de agregación</label>
                      <p-select [options]="aggregateFunctionOptions"
                                [ngModel]="transformConfig()?.pivotConfig?.aggregateFunction || 'sum'"
                                (ngModelChange)="updatePivotConfig('aggregateFunction', $event)"
                                styleClass="w-full" optionLabel="label" optionValue="value"></p-select>
                    </div>
                  }

                  @case ('unpivot') {
                    <div class="props-section">
                      <label class="props-label">Campos clave (se mantienen)</label>
                      <input pInputText [ngModel]="unpivotKeyFields().join(', ')"
                             (ngModelChange)="parseAndUpdateUnpivotKeys($event)"
                             placeholder="id, nombre" class="w-full" />
                    </div>
                    <div class="props-section">
                      <label class="props-label">Columnas a despivotar</label>
                      <input pInputText [ngModel]="unpivotColumns().join(', ')"
                             (ngModelChange)="parseAndUpdateUnpivotColumns($event)"
                             placeholder="enero, febrero, marzo" class="w-full" />
                    </div>
                    <div class="props-section">
                      <label class="props-label">Nombre columna variable</label>
                      <input pInputText [ngModel]="transformConfig()?.unpivotConfig?.variableColumnName"
                             (ngModelChange)="updateUnpivotConfig('variableColumnName', $event)"
                             placeholder="mes" class="w-full" />
                    </div>
                    <div class="props-section">
                      <label class="props-label">Nombre columna valor</label>
                      <input pInputText [ngModel]="transformConfig()?.unpivotConfig?.valueColumnName"
                             (ngModelChange)="updateUnpivotConfig('valueColumnName', $event)"
                             placeholder="ventas" class="w-full" />
                    </div>
                  }

                  @case ('split') {
                    <div class="props-section">
                      <label class="props-label">Campo a dividir</label>
                      <input pInputText [ngModel]="transformConfig()?.splitConfig?.field"
                             (ngModelChange)="updateSplitConfig('field', $event)"
                             placeholder="tags" class="w-full" />
                    </div>
                    <div class="props-section">
                      <label class="props-label">Delimitador</label>
                      <input pInputText [ngModel]="transformConfig()?.splitConfig?.delimiter"
                             (ngModelChange)="updateSplitConfig('delimiter', $event)"
                             placeholder="," class="w-full" />
                    </div>
                    <div class="props-section">
                      <label class="props-label">Modo</label>
                      <p-select [options]="splitModeOptions"
                                [ngModel]="transformConfig()?.splitConfig?.mode || 'expand'"
                                (ngModelChange)="updateSplitConfig('mode', $event)"
                                styleClass="w-full" optionLabel="label" optionValue="value"></p-select>
                      <small class="props-hint">Expand: crea múltiples registros. Array: convierte en array</small>
                    </div>
                    <div class="props-section">
                      <label class="props-label">Campo destino</label>
                      <input pInputText [ngModel]="transformConfig()?.splitConfig?.targetField"
                             (ngModelChange)="updateSplitConfig('targetField', $event)"
                             placeholder="tag" class="w-full" />
                    </div>
                  }

                  @case ('merge') {
                    <div class="props-section">
                      <label class="props-label">Fuentes de datos (separadas por coma)</label>
                      <input pInputText [ngModel]="mergeSources().join(', ')"
                             (ngModelChange)="parseAndUpdateMergeSources($event)"
                             placeholder="ordenes, clientes" class="w-full" />
                    </div>
                    <div class="props-section">
                      <label class="props-label">Tipo de Join</label>
                      <p-select [options]="mergeJoinTypeOptions"
                                [ngModel]="transformConfig()?.mergeConfig?.joinType || 'left'"
                                (ngModelChange)="updateMergeConfig('joinType', $event)"
                                styleClass="w-full" optionLabel="label" optionValue="value"></p-select>
                    </div>
                    <div class="props-section">
                      <label class="props-label">Campo clave izquierdo</label>
                      <input pInputText [ngModel]="getMergeJoinKey('left')"
                             (ngModelChange)="updateMergeJoinKey('left', $event)"
                             placeholder="customerId" class="w-full" />
                    </div>
                    <div class="props-section">
                      <label class="props-label">Campo clave derecho</label>
                      <input pInputText [ngModel]="getMergeJoinKey('right')"
                             (ngModelChange)="updateMergeJoinKey('right', $event)"
                             placeholder="id" class="w-full" />
                    </div>
                    <div class="props-section">
                      <label class="props-label">Resolución de conflictos</label>
                      <p-select [options]="mergeConflictOptions"
                                [ngModel]="transformConfig()?.mergeConfig?.conflictResolution || 'left'"
                                (ngModelChange)="updateMergeConfig('conflictResolution', $event)"
                                styleClass="w-full" optionLabel="label" optionValue="value"></p-select>
                    </div>
                  }

                  @case ('expression') {
                    <div class="props-section">
                      <label class="props-label">Campo de salida</label>
                      <input pInputText [ngModel]="transformConfig()?.expressionConfig?.outputField"
                             (ngModelChange)="updateExpressionConfig('outputField', $event)"
                             placeholder="resultado" class="w-full" />
                    </div>
                    <div class="props-section">
                      <label class="props-label">Expresión JEXL</label>
                      <textarea pTextarea [ngModel]="transformConfig()?.expressionConfig?.expression"
                                (ngModelChange)="updateExpressionConfig('expression', $event)"
                                rows="4" placeholder="record.precio * record.cantidad" class="w-full expression-textarea"></textarea>
                      <small class="props-hint">Usa 'record' para acceder a los campos del registro actual</small>
                    </div>
                    <div class="props-section">
                      <label class="props-label">Tipo de salida</label>
                      <p-select [options]="expressionOutputTypeOptions"
                                [ngModel]="transformConfig()?.expressionConfig?.outputType || 'string'"
                                (ngModelChange)="updateExpressionConfig('outputType', $event)"
                                styleClass="w-full" optionLabel="label" optionValue="value"></p-select>
                    </div>
                    <div class="props-section expression-help">
                      <strong>Funciones disponibles:</strong>
                      <div class="expression-functions">
                        <span class="func">round(n)</span>
                        <span class="func">ceil(n)</span>
                        <span class="func">floor(n)</span>
                        <span class="func">abs(n)</span>
                        <span class="func">upper(s)</span>
                        <span class="func">lower(s)</span>
                        <span class="func">trim(s)</span>
                        <span class="func">if(cond, then, else)</span>
                        <span class="func">isEmpty(v)</span>
                        <span class="func">coalesce(a, b)</span>
                      </div>
                    </div>
                  }

                  @default {
                    <div class="props-section">
                      <p class="text-muted">Selecciona una operación para configurar</p>
                    </div>
                  }
                }

                <div class="props-section">
                  <p-button label="Previsualizar" icon="pi pi-eye" severity="secondary"
                            [loading]="isTestRunning()" (onClick)="previewTransform()"></p-button>
                </div>
              }

              @case ('estado') {
                <div class="props-section">
                  <label class="props-label">Tipo de estado</label>
                  <p-select [options]="tipoEstadoOptions" [ngModel]="getConfigValue(node, 'tipoEstado')"
                            (ngModelChange)="updateNodeConfig({ tipoEstado: $event })" styleClass="w-full"></p-select>
                </div>
                <div class="props-section">
                  <label class="props-label">Nombre del estado</label>
                  <input pInputText [ngModel]="getConfigValue(node, 'nombreEstado')"
                         (ngModelChange)="updateNodeConfig({ nombreEstado: $event })"
                         placeholder="Completado" class="w-full" />
                </div>
                <div class="props-section">
                  <label class="props-label">Mensaje</label>
                  <textarea pTextarea [ngModel]="getConfigValue(node, 'mensaje')"
                            (ngModelChange)="updateNodeConfig({ mensaje: $event })"
                            rows="2" class="w-full"></textarea>
                </div>
              }

              @case ('matematico') {
                <!-- MAT-001: Definición de Fórmula -->
                <div class="props-section">
                  <label class="props-label">Fórmula Matemática</label>

                  <!-- MAT-002: Barra de Operadores (organizada por grupos) -->
                  <div class="formula-toolbar">
                    <div class="op-group">
                      <span class="op-group-label">Básicos</span>
                      <button class="op-btn" pTooltip="Suma" (click)="appendToFormula(' + ')">+</button>
                      <button class="op-btn" pTooltip="Resta" (click)="appendToFormula(' - ')">−</button>
                      <button class="op-btn" pTooltip="Multiplicación" (click)="appendToFormula(' * ')">×</button>
                      <button class="op-btn" pTooltip="División" (click)="appendToFormula(' / ')">÷</button>
                    </div>
                    <div class="op-group">
                      <span class="op-group-label">Agrupación</span>
                      <button class="op-btn" pTooltip="Paréntesis izquierdo" (click)="appendToFormula('(')">(</button>
                      <button class="op-btn" pTooltip="Paréntesis derecho" (click)="appendToFormula(')')">)</button>
                    </div>
                    <div class="op-group">
                      <span class="op-group-label">Avanzados</span>
                      <button class="op-btn" pTooltip="Potencia (ej: x^2)" (click)="appendToFormula('^')">^</button>
                      <button class="op-btn" pTooltip="Módulo (residuo)" (click)="appendToFormula(' % ')">%</button>
                      <button class="op-btn" pTooltip="Raíz cuadrada" (click)="appendToFormula('sqrt(')">√</button>
                      <button class="op-btn" pTooltip="Valor absoluto" (click)="appendToFormula('abs(')">|x|</button>
                    </div>
                    <div class="op-group">
                      <span class="op-group-label">Funciones</span>
                      <button class="op-btn op-fn" pTooltip="Redondear" (click)="appendToFormula('round(')">round</button>
                      <button class="op-btn op-fn" pTooltip="Mínimo" (click)="appendToFormula('min(')">min</button>
                      <button class="op-btn op-fn" pTooltip="Máximo" (click)="appendToFormula('max(')">max</button>
                    </div>
                  </div>

                  <!-- Campo de fórmula con validación visual -->
                  <div class="formula-input-container">
                    <textarea pInputTextarea
                              [ngModel]="getConfigValue(node, 'formula')"
                              (ngModelChange)="onFormulaChange($event)"
                              placeholder="Ej: (precio * cantidad) * (1 + impuesto)"
                              rows="2"
                              class="w-full font-mono formula-input"
                              [class.formula-valid]="formulaIsValid()"
                              [class.formula-invalid]="getConfigValue(node, 'formula') && !formulaIsValid()">
                    </textarea>
                    @if (getConfigValue(node, 'formula')) {
                      <span class="formula-status" [class.valid]="formulaIsValid()">
                        @if (formulaIsValid()) {
                          <span class="material-icons text-green-500">check_circle</span>
                        } @else {
                          <span class="material-icons text-red-500">error</span>
                        }
                      </span>
                    }
                  </div>
                  @if (getConfigValue(node, 'formula') && !formulaIsValid()) {
                    <small class="text-red-500">{{ formulaError() }}</small>
                  }
                </div>

                <!-- MAT-003: Variables Disponibles -->
                <div class="props-section">
                  <label class="props-label">Variables Disponibles</label>
                  <p class="props-help mb-2">Haz clic para insertar en la fórmula</p>
                  <div class="formula-variables">
                    @for (variable of availableVariables(); track variable.name) {
                      @if (variable.type === 'number' || variable.type === 'string') {
                        <p-chip
                          [label]="variable.name"
                          [pTooltip]="'Tipo: ' + variable.type + ' | Fuente: ' + variable.source"
                          styleClass="cursor-pointer variable-chip"
                          (click)="appendToFormula(variable.name)">
                        </p-chip>
                      }
                    }
                    @if (numericVariablesCount() === 0) {
                      <span class="text-gray-400 text-sm">No hay variables numéricas disponibles</span>
                    }
                  </div>
                </div>

                <!-- Variable de salida -->
                <div class="props-section">
                  <label class="props-label">Variable de Salida</label>
                  <input pInputText
                         [ngModel]="getConfigValue(node, 'variablesSalida')"
                         (ngModelChange)="updateNodeConfig({ variablesSalida: $event })"
                         placeholder="resultado"
                         class="w-full" />
                  <small class="props-help">Nombre de la variable donde se guardará el resultado</small>
                </div>

                <!-- MAT-005: Configuración de Precisión -->
                <div class="props-section">
                  <label class="props-label">Precisión Decimal</label>
                  <div class="flex align-items-center gap-3">
                    <p-inputNumber [ngModel]="getConfigValue(node, 'precision') ?? 2"
                                   (ngModelChange)="updateNodeConfig({ precision: $event })"
                                   [min]="0" [max]="10" [showButtons]="true" styleClass="w-6rem"></p-inputNumber>
                    <span class="text-sm text-gray-500">
                      Ej: {{ getPrecisionExample() }}
                    </span>
                  </div>
                </div>

                <!-- MAT-004: Preview de Resultado -->
                <div class="props-section">
                  <label class="props-label">Vista Previa del Cálculo</label>
                  <div class="formula-preview">
                    @if (getConfigValue(node, 'formula') && formulaIsValid()) {
                      <div class="preview-content">
                        <div class="preview-formula">
                          <span class="preview-label">Fórmula:</span>
                          <code>{{ getConfigValue(node, 'formula') }}</code>
                        </div>
                        <div class="preview-expanded">
                          <span class="preview-label">Expandida:</span>
                          <code>{{ getFormulaExpanded() }}</code>
                        </div>
                        <div class="preview-result">
                          <span class="preview-label">Resultado:</span>
                          <strong class="result-value">{{ evaluateFormulaPreview() }}</strong>
                        </div>
                      </div>
                    } @else {
                      <div class="preview-empty">
                        <span class="material-icons text-gray-400">calculate</span>
                        <span class="text-gray-400">Ingresa una fórmula válida para ver el resultado</span>
                      </div>
                    }
                  </div>
                </div>
              }

              @case ('branching') {
                <!-- BRA-002/003/004: Selección de Estrategia -->
                <div class="props-section">
                  <label class="props-label">Estrategia de Ejecución</label>
                  <p-select [options]="estrategiaBranchingOptions" [ngModel]="getConfigValue(node, 'estrategia') ?? 'paralela'"
                            (ngModelChange)="updateNodeConfig({ estrategia: $event })" styleClass="w-full"></p-select>
                  <small class="props-help">{{ getEstrategiaDescription(getConfigValue(node, 'estrategia') ?? 'paralela') }}</small>
                </div>

                <!-- BRA-001: Configuración de Ramas -->
                <div class="props-section">
                  <div class="flex justify-content-between align-items-center mb-2">
                    <label class="props-label mb-0">Ramas ({{ getBranchCount() }})</label>
                    <button pButton type="button" icon="pi pi-plus" class="p-button-sm p-button-text"
                            pTooltip="Agregar rama" (click)="addBranch()"
                            [disabled]="getBranchCount() >= 10"></button>
                  </div>

                  <div class="branches-list">
                    @for (rama of getBranches(); track rama.id; let i = $index) {
                      <div class="branch-config-item">
                        <div class="branch-header">
                          <span class="branch-number">{{ i + 1 }}</span>
                          <input pInputText [(ngModel)]="rama.nombre"
                                 (ngModelChange)="updateBranchName(rama.id, $event)"
                                 [placeholder]="'Rama ' + (i + 1)"
                                 class="branch-name-input" />
                          <button pButton type="button" icon="pi pi-trash" class="p-button-sm p-button-text p-button-danger"
                                  pTooltip="Eliminar rama" (click)="removeBranch(rama.id)"
                                  [disabled]="getBranchCount() <= 2"></button>
                        </div>

                        <!-- BRA-005: Condición opcional por rama -->
                        <div class="branch-condition">
                          <p-checkbox [(ngModel)]="rama.tieneCondicion"
                                      (ngModelChange)="updateBranchCondition(rama.id, 'tieneCondicion', $event)"
                                      [binary]="true" inputId="cond-{{rama.id}}"
                                      label="Condición"></p-checkbox>
                          @if (rama.tieneCondicion) {
                            <input pInputText [(ngModel)]="rama.condicion"
                                   (ngModelChange)="updateBranchCondition(rama.id, 'condicion', $event)"
                                   placeholder="Ej: score > 80"
                                   class="condition-input mt-2" />
                          }
                        </div>
                      </div>
                    }
                  </div>
                </div>

                <!-- Vista previa visual de las ramas -->
                <div class="props-section">
                  <label class="props-label">Vista Previa</label>
                  <div class="branching-preview">
                    <div class="branch-flow">
                      <div class="branch-start">
                        <span class="material-icons">call_split</span>
                      </div>
                      <div class="branch-lines">
                        @for (rama of getBranches(); track rama.id; let i = $index) {
                          <div class="branch-line" [style.--branch-index]="i">
                            <span class="branch-dot"></span>
                            <span class="branch-label">{{ rama.nombre || 'Rama ' + (i + 1) }}</span>
                            @if (rama.tieneCondicion && rama.condicion) {
                              <span class="branch-cond-badge" pTooltip="{{rama.condicion}}">
                                <span class="material-icons text-xs">filter_alt</span>
                              </span>
                            }
                          </div>
                        }
                      </div>
                    </div>
                    <div class="strategy-badge">
                      {{ getEstrategiaLabel(getConfigValue(node, 'estrategia') ?? 'paralela') }}
                    </div>
                  </div>
                </div>

                <!-- Información sobre estrategia -->
                <div class="props-section">
                  @switch (getConfigValue(node, 'estrategia') ?? 'paralela') {
                    @case ('paralela') {
                      <p-message severity="info" [closable]="false" styleClass="w-full">
                        <span class="text-sm">Todas las ramas se ejecutarán simultáneamente. El proceso continúa cuando todas terminen.</span>
                      </p-message>
                    }
                    @case ('secuencial') {
                      <p-message severity="info" [closable]="false" styleClass="w-full">
                        <span class="text-sm">Las ramas se ejecutan en orden. Si una falla, las siguientes no se ejecutan.</span>
                      </p-message>
                    }
                    @case ('race') {
                      <p-message severity="warn" [closable]="false" styleClass="w-full">
                        <span class="text-sm">Todas las ramas inician, pero solo la primera en terminar continúa. Las demás se cancelan.</span>
                      </p-message>
                    }
                    @case ('prioridad') {
                      <p-message severity="info" [closable]="false" styleClass="w-full">
                        <span class="text-sm">Se ejecuta la primera rama cuya condición sea verdadera.</span>
                      </p-message>
                    }
                  }
                </div>
              }

              @case ('ml') {
                <div class="props-section">
                  <label class="props-label">Nombre del modelo</label>
                  <input pInputText [ngModel]="getConfigValue(node, 'modeloNombre')"
                         (ngModelChange)="updateNodeConfig({ modeloNombre: $event })"
                         placeholder="Mi modelo ML" class="w-full" />
                </div>
                <div class="props-section">
                  <label class="props-label">Tipo de modelo</label>
                  <p-select [options]="tipoModeloOptions" [ngModel]="getConfigValue(node, 'tipoModelo')"
                            (ngModelChange)="updateNodeConfig({ tipoModelo: $event })" styleClass="w-full"></p-select>
                </div>
                <div class="props-section">
                  <label class="props-label">Endpoint</label>
                  <input pInputText [ngModel]="getConfigValue(node, 'endpoint')"
                         (ngModelChange)="updateNodeConfig({ endpoint: $event })"
                         placeholder="https://api.ml/predict" class="w-full" />
                </div>
              }

              @case ('kpi') {
                <div class="props-section">
                  <label class="props-label">KPI a actualizar</label>
                  @if (kpisDisponibles().length > 0) {
                    <p-select
                      [options]="kpisDisponibles()"
                      optionLabel="nombre"
                      optionValue="id"
                      [ngModel]="getConfigValue(node, 'kpiId')"
                      (ngModelChange)="onKpiSelect($event)"
                      placeholder="Seleccionar KPI..."
                      styleClass="w-full">
                    </p-select>
                  } @else {
                    <p-message severity="warn" text="No hay KPIs configurados en este proceso. Configúralos en la creación del proceso." [closable]="false" styleClass="w-full"></p-message>
                  }
                </div>

                @if (getConfigValue(node, 'kpiId')) {
                  <div class="props-section">
                    <label class="props-label">Unidad</label>
                    <input pInputText [ngModel]="getConfigValue(node, 'kpiUnidad')" disabled class="w-full" />
                  </div>

                  <div class="props-section">
                    <label class="props-label">Origen del valor</label>
                    <p-select
                      [options]="origenValorOptions"
                      [ngModel]="getConfigValue(node, 'origenValor')"
                      (ngModelChange)="updateNodeConfig({ origenValor: $event })"
                      styleClass="w-full">
                    </p-select>
                  </div>

                  @if (getConfigValue(node, 'origenValor') === 'variable') {
                    <div class="props-section">
                      <label class="props-label">Variable de entrada</label>
                      <input pInputText [ngModel]="getConfigValue(node, 'variableOrigen')"
                             (ngModelChange)="updateNodeConfig({ variableOrigen: $event })"
                             placeholder="nombre_variable" class="w-full" />
                      <small class="props-help">Variable del flujo que contiene el valor</small>
                    </div>
                  }

                  @if (getConfigValue(node, 'origenValor') === 'fijo') {
                    <div class="props-section">
                      <label class="props-label">Valor fijo</label>
                      <p-inputNumber [ngModel]="getConfigValue(node, 'valorFijo')"
                                     (ngModelChange)="updateNodeConfig({ valorFijo: $event })"
                                     mode="decimal" styleClass="w-full"></p-inputNumber>
                    </div>
                  }

                  <div class="props-section">
                    <p-checkbox
                      [ngModel]="getConfigValue(node, 'alertasHabilitadas')"
                      (ngModelChange)="updateNodeConfig({ alertasHabilitadas: $event })"
                      [binary]="true"
                      label="Habilitar alertas">
                    </p-checkbox>
                  </div>

                  @if (getConfigValue(node, 'alertasHabilitadas')) {
                    <div class="props-section">
                      <label class="props-label">Umbral de advertencia</label>
                      <p-inputNumber [ngModel]="getUmbralValue(node, 'advertencia')"
                                     (ngModelChange)="updateUmbral('advertencia', $event)"
                                     mode="decimal" styleClass="w-full"></p-inputNumber>
                    </div>
                    <div class="props-section">
                      <label class="props-label">Umbral crítico</label>
                      <p-inputNumber [ngModel]="getUmbralValue(node, 'critico')"
                                     (ngModelChange)="updateUmbral('critico', $event)"
                                     mode="decimal" styleClass="w-full"></p-inputNumber>
                    </div>
                    <div class="props-section">
                      <label class="props-label">Dirección de alerta</label>
                      <p-select [options]="direccionAlertaOptions"
                                [ngModel]="getUmbralValue(node, 'direccion')"
                                (ngModelChange)="updateUmbral('direccion', $event)"
                                styleClass="w-full"></p-select>
                    </div>
                  }
                }
              }

              @default {
                <div class="props-section">
                  <p class="text-500">Selecciona un nodo para ver su configuracion</p>
                </div>
              }
            }
          </p-tabpanel>

          <!-- TAB: ENTRADA -->
          <p-tabpanel value="input">
            <div class="props-section">
              <label class="props-label">Variables de entrada disponibles</label>
              <p class="props-help">Variables de nodos anteriores conectados.</p>

              <div class="variable-list">
                @for (variable of availableVariables(); track variable.name) {
                  <div class="variable-item" [class.selected]="isVariableSelected(variable.name)"
                       (click)="toggleVariable(variable.name)">
                    <i class="pi pi-check-circle" *ngIf="isVariableSelected(variable.name)"></i>
                    <i class="pi pi-circle" *ngIf="!isVariableSelected(variable.name)"></i>
                    <span class="var-name">{{ variable.name }}</span>
                    <span class="var-type">{{ variable.type }}</span>
                  </div>
                } @empty {
                  <p-message severity="info" text="Conecta nodos anteriores" [closable]="false" styleClass="w-full"></p-message>
                }
              </div>
            </div>
          </p-tabpanel>

          <!-- TAB: SALIDA -->
          <p-tabpanel value="output">
            <div class="props-section">
              <label class="props-label">Variable de salida</label>
              <input pInputText [ngModel]="getConfigValue(node, 'outputVariable')"
                     (ngModelChange)="updateNodeConfig({ outputVariable: $event })"
                     placeholder="output_nombre" class="w-full" />
              <small class="props-help">Otros nodos usaran este nombre para acceder al resultado.</small>
            </div>
          </p-tabpanel>
        </p-tabpanels>
      </p-tabs>

      <!-- Footer -->
      <div class="props-panel-footer">
        <button class="props-footer-btn" (click)="duplicateNode()">
          <i class="pi pi-copy"></i> Duplicar
        </button>
        <button class="props-footer-btn danger" (click)="deleteSelectedNode()">
          <i class="pi pi-trash"></i> Eliminar
        </button>
      </div>
    </aside>
  }

  <!-- Panel de Previsualizacion (opcional) -->
  @if (showPreviewPanel()) {
    <aside class="preview-panel-v2">
      <div class="preview-panel-header">
        <h3>Previsualizador</h3>
        <button class="close-panel-btn" (click)="showPreviewPanel.set(false)">
          <i class="pi pi-times"></i>
        </button>
      </div>
      <div class="preview-panel-body">
        <p-table [value]="previewData()" [scrollable]="true" scrollHeight="400px" styleClass="p-datatable-sm">
          @for (col of previewColumns(); track col) {
            <ng-template pTemplate="header">
              <tr>
                @for (c of previewColumns(); track c) {
                  <th>{{ c }}</th>
                }
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-row>
              <tr>
                @for (c of previewColumns(); track c) {
                  <td>{{ row[c] }}</td>
                }
              </tr>
            </ng-template>
          }
        </p-table>
      </div>

      <div class="preview-panel-footer">
        <div class="preview-section">
          <label>Columna clasificadora</label>
          <p-select [options]="previewColumns()" placeholder="Selecciona una opcion" styleClass="w-full"></p-select>
        </div>
        <div class="preview-section">
          <label>Selecciona las columnas para analizar</label>
          <p-multiSelect [options]="previewColumns()" placeholder="Selecciona multiples opciones" styleClass="w-full"></p-multiSelect>
        </div>
        <button class="props-action-btn primary" (click)="guardarConfiguracionColumnas()">
          Guardar
        </button>
      </div>
    </aside>
  }
</div>

<!-- Confirm Dialog para eliminación -->
<p-confirmDialog></p-confirmDialog>

<!-- Dialog API Key Groq -->
<p-dialog header="Configurar API Key de Groq" [modal]="true" [(visible)]="showApiKeyDialog" [style]="{width: '450px'}">
  <div class="flex flex-column gap-4">
    <div class="surface-ground border-round p-3">
      <div class="flex align-items-center gap-2 mb-2">
        <i class="pi pi-info-circle text-primary"></i>
        <span class="font-semibold text-900">Informacion</span>
      </div>
      <p class="text-600 text-sm m-0 line-height-3">
        Ingresa tu API Key de Groq para habilitar los nodos de LLM.
        <a href="https://console.groq.com" target="_blank" class="text-primary font-medium">Obtener API Key</a>
      </p>
    </div>

    <div class="flex flex-column gap-2">
      <label for="apiKey" class="font-semibold text-900">API Key</label>
      <input pInputText id="apiKey" type="password" [(ngModel)]="apiKeyInput" placeholder="gsk_..." class="w-full" />
    </div>

    @if (groqService.isConfigured) {
      <div class="flex align-items-center gap-2 p-3 bg-green-50 border-round">
        <i class="pi pi-check-circle text-green-500"></i>
        <span class="text-green-700 font-medium">API Key configurada correctamente</span>
      </div>
    }
  </div>
  <ng-template pTemplate="footer">
    <p-button label="Cancelar" severity="secondary" [text]="true" (onClick)="showApiKeyDialog.set(false)"></p-button>
    <p-button label="Guardar" icon="pi pi-check" (onClick)="saveApiKey()"></p-button>
  </ng-template>
</p-dialog>

<!-- Dialog Guardar Proceso -->
<p-dialog header="Guardar Proceso" [modal]="true" [(visible)]="showSaveDialog" [style]="{width: '450px'}">
  <div class="flex flex-column gap-4">
    <div class="flex flex-column gap-2">
      <label for="nombre" class="font-semibold text-900">Nombre del proceso *</label>
      <input pInputText id="nombre" [(ngModel)]="procesoNombre" placeholder="Mi proceso" class="w-full" />
    </div>
    <div class="flex flex-column gap-2">
      <label for="descripcion" class="font-semibold text-900">Descripcion</label>
      <textarea pTextarea id="descripcion" [(ngModel)]="procesoDescripcion" rows="3" placeholder="Descripcion del proceso..." class="w-full"></textarea>
    </div>
  </div>
  <ng-template pTemplate="footer">
    <p-button label="Cancelar" severity="secondary" [text]="true" (onClick)="showSaveDialog.set(false)"></p-button>
    <p-button label="Guardar" icon="pi pi-save" (onClick)="saveProceso()"></p-button>
  </ng-template>
</p-dialog>

<!-- Dialog Resultados de Ejecucion - Process Runner Mejorado -->
<p-dialog header="Ejecutor de Procesos" [modal]="true" [(visible)]="showExecutionDialog" [style]="{width: '900px', maxHeight: '90vh'}" styleClass="process-runner-dialog">
  <div class="process-runner">
    @if (processService.currentExecution(); as execution) {
      <!-- Header con estado y progreso -->
      <div class="runner-header">
        <div class="status-banner" [class]="'status-' + execution.status">
          <div class="status-icon">
            @switch (execution.status) {
              @case ('running') { <i class="pi pi-spin pi-spinner"></i> }
              @case ('completed') { <i class="pi pi-check-circle"></i> }
              @case ('failed') { <i class="pi pi-times-circle"></i> }
              @case ('cancelled') { <i class="pi pi-ban"></i> }
            }
          </div>
          <div class="status-text">
            <span class="status-label">
              {{ execution.status === 'running' ? 'Ejecutando' :
                 execution.status === 'completed' ? 'Completado' :
                 execution.status === 'failed' ? 'Fallido' : 'Cancelado' }}
            </span>
            <span class="status-detail">
              @if (execution.status === 'running') {
                Nodo {{ processService.currentNodeIndex() }} de {{ processService.totalExecutionNodes() }}
                @if (processService.currentExecutingNode(); as node) {
                  - {{ node.label }}
                }
              } @else {
                {{ execution.results.length }} nodos en {{ getExecutionDuration(execution) }}ms
              }
            </span>
          </div>
          @if (execution.status === 'running') {
            <p-button icon="pi pi-stop" label="Cancelar" severity="danger" size="small" (onClick)="cancelExecution()"></p-button>
          }
        </div>

        <!-- Barra de progreso -->
        @if (execution.status === 'running' || execution.status === 'completed') {
          <div class="progress-section">
            <p-progressBar
              [value]="processService.executionProgress()"
              [showValue]="true"
              [style]="{height: '8px'}"
              [styleClass]="execution.status === 'completed' ? 'completed-progress' : ''">
            </p-progressBar>
          </div>
        }
      </div>

      <!-- Tabs de contenido -->
      <p-tabs [value]="runnerActiveTab()" (valueChange)="runnerActiveTab.set($any($event))" styleClass="runner-tabs">
        <p-tablist>
          <p-tab value="flow">
            <i class="pi pi-sitemap mr-2"></i>
            Flujo
          </p-tab>
          <p-tab value="variables">
            <i class="pi pi-database mr-2"></i>
            Variables
          </p-tab>
          <p-tab value="context">
            <i class="pi pi-code mr-2"></i>
            Contexto
          </p-tab>
          <p-tab value="history">
            <i class="pi pi-history mr-2"></i>
            Historial
          </p-tab>
        </p-tablist>

        <p-tabpanels>
          <!-- Tab: Flujo de Nodos -->
          <p-tabpanel value="flow">
            <div class="flow-visualization">
              @for (result of processService.executionResults(); track result.nodeId; let i = $index) {
                <div class="flow-node" [class]="'status-' + result.status">
                  <div class="node-order">{{ i + 1 }}</div>
                  <div class="node-content">
                    <div class="node-header">
                      <div class="node-icon">
                        @switch (result.status) {
                          @case ('pending') { <i class="pi pi-clock"></i> }
                          @case ('running') { <i class="pi pi-spin pi-spinner"></i> }
                          @case ('success') { <i class="pi pi-check"></i> }
                          @case ('error') { <i class="pi pi-times"></i> }
                          @case ('skipped') { <i class="pi pi-forward"></i> }
                        }
                      </div>
                      <span class="node-name">{{ result.nodeName }}</span>
                      @if (result.duration) {
                        <span class="node-duration">{{ result.duration }}ms</span>
                      }
                    </div>
                    @if (result.error) {
                      <div class="node-error">
                        <i class="pi pi-exclamation-triangle"></i>
                        <span>{{ result.error }}</span>
                      </div>
                    }
                  </div>
                  @if (i < processService.executionResults().length - 1) {
                    <div class="flow-connector">
                      <i class="pi pi-arrow-down"></i>
                    </div>
                  }
                </div>
              }
            </div>
          </p-tabpanel>

          <!-- Tab: Variables de Salida -->
          <p-tabpanel value="variables">
            <div class="variables-panel">
              @if (processService.executionVariables().length > 0) {
                <div class="variables-grid">
                  @for (variable of processService.executionVariables(); track variable.key) {
                    <div class="variable-card" (click)="showVariableDetail(variable)">
                      <div class="variable-icon">
                        <i class="pi" [ngClass]="processService.getVariableIcon(variable.type)"></i>
                      </div>
                      <div class="variable-info">
                        <span class="variable-name">{{ variable.key }}</span>
                        <span class="variable-preview">{{ variable.preview }}</span>
                      </div>
                      <div class="variable-type">
                        <p-tag [value]="variable.typeLabel" [severity]="getVariableTypeSeverity(variable.type)"></p-tag>
                      </div>
                    </div>
                  }
                </div>
              } @else {
                <div class="empty-state">
                  <i class="pi pi-inbox text-4xl text-400"></i>
                  <p>No hay variables de salida</p>
                </div>
              }
            </div>
          </p-tabpanel>

          <!-- Tab: Contexto JSON -->
          <p-tabpanel value="context">
            <div class="context-panel">
              @if (Object.keys(execution.context).length > 0) {
                <pre class="context-json">{{ execution.context | json }}</pre>
              } @else {
                <div class="empty-state">
                  <i class="pi pi-file text-4xl text-400"></i>
                  <p>El contexto esta vacio</p>
                </div>
              }
            </div>
          </p-tabpanel>

          <!-- Tab: Historial -->
          <p-tabpanel value="history">
            <div class="history-panel">
              @if (processService.getProcessExecutionHistory().length > 0) {
                <div class="history-list">
                  @for (exec of processService.getProcessExecutionHistory().slice(0, 10); track exec.id) {
                    <div class="history-item" [class.active]="exec.id === execution.id" (click)="loadHistoryExecution(exec.id)">
                      <div class="history-status">
                        @switch (exec.status) {
                          @case ('completed') { <i class="pi pi-check-circle text-green-500"></i> }
                          @case ('failed') { <i class="pi pi-times-circle text-red-500"></i> }
                          @case ('cancelled') { <i class="pi pi-ban text-yellow-500"></i> }
                          @default { <i class="pi pi-clock text-400"></i> }
                        }
                      </div>
                      <div class="history-info">
                        <span class="history-id">{{ exec.id }}</span>
                        <span class="history-date">{{ formatHistoryDate(exec.startTime) }}</span>
                      </div>
                      <div class="history-stats">
                        <span>{{ exec.results.length }} nodos</span>
                      </div>
                    </div>
                  }
                </div>
              } @else {
                <div class="empty-state">
                  <i class="pi pi-clock text-4xl text-400"></i>
                  <p>No hay ejecuciones anteriores</p>
                </div>
              }
            </div>
          </p-tabpanel>
        </p-tabpanels>
      </p-tabs>
    } @else {
      <div class="empty-state">
        <i class="pi pi-play-circle text-6xl text-400"></i>
        <h4>Sin ejecucion activa</h4>
        <p>Ejecuta el proceso para ver los resultados aqui</p>
      </div>
    }
  </div>

  <ng-template pTemplate="footer">
    <div class="runner-footer">
      @if (processService.currentExecution(); as execution) {
        @if (execution.status !== 'running') {
          <p-button
            icon="pi pi-download"
            label="Exportar JSON"
            severity="secondary"
            [outlined]="true"
            (onClick)="exportExecutionContext()">
          </p-button>
        }
      }
      <p-button label="Cerrar" icon="pi pi-times" (onClick)="showExecutionDialog.set(false)"></p-button>
    </div>
  </ng-template>
</p-dialog>

<!-- Dialog Detalle de Variable -->
<p-dialog header="Detalle de Variable" [modal]="true" [(visible)]="showVariableDetailDialog" [style]="{width: '600px'}">
  @if (selectedVariable(); as variable) {
    <div class="variable-detail">
      <div class="detail-header">
        <div class="detail-icon">
          <i class="pi" [ngClass]="processService.getVariableIcon(variable.type)"></i>
        </div>
        <div class="detail-info">
          <h4>{{ variable.key }}</h4>
          <p-tag [value]="variable.typeLabel" [severity]="getVariableTypeSeverity(variable.type)"></p-tag>
        </div>
      </div>
      <div class="detail-content">
        <pre class="detail-value">{{ variable.value | json }}</pre>
      </div>
      <div class="detail-actions">
        <p-button icon="pi pi-copy" label="Copiar valor" severity="secondary" [outlined]="true" (onClick)="copyVariableValue(variable)"></p-button>
      </div>
    </div>
  }
</p-dialog>

<!-- Modal Asistente IA -->
<p-dialog
  header="Asistente IA para Procesos"
  [modal]="true"
  [(visible)]="showAiAssistantModal"
  [style]="{width: '600px', height: '80vh'}"
  [contentStyle]="{'padding': '0', 'display': 'flex', 'flex-direction': 'column'}"
  styleClass="ai-assistant-dialog">

  <div class="ai-assistant-header">
    <div class="flex align-items-center gap-3">
      <div class="ai-avatar">
        <i class="pi pi-sparkles"></i>
      </div>
      <div>
        <h4 class="m-0 text-900 font-semibold">Asistente de Flujos</h4>
        <p class="m-0 text-500 text-sm">Crea y configura nodos con lenguaje natural</p>
      </div>
    </div>
    <p-button icon="pi pi-refresh" [rounded]="true" [text]="true" severity="secondary" (onClick)="clearAiChat()" pTooltip="Limpiar chat"></p-button>
  </div>

  <div class="ai-chat-container">
    @for (msg of aiMessages(); track $index) {
      <div class="ai-message" [class.user]="msg.role === 'user'" [class.assistant]="msg.role === 'assistant'">
        @if (msg.role === 'assistant') {
          <div class="message-avatar">
            <i class="pi pi-sparkles"></i>
          </div>
        }
        <div class="message-content">
          <div class="message-bubble">
            {{ msg.content }}
          </div>
        </div>
        @if (msg.role === 'user') {
          <div class="message-avatar user">
            <i class="pi pi-user"></i>
          </div>
        }
      </div>
    }

    @if (aiIsProcessing()) {
      <div class="ai-message assistant">
        <div class="message-avatar">
          <i class="pi pi-sparkles"></i>
        </div>
        <div class="message-content">
          <div class="message-bubble typing">
            <span class="typing-dot"></span>
            <span class="typing-dot"></span>
            <span class="typing-dot"></span>
          </div>
        </div>
      </div>
    }
  </div>

  @if (aiSuggestion() && aiSuggestion()?.accion !== 'explicar') {
    <div class="ai-suggestion-bar">
      <div class="suggestion-info">
        <i class="pi pi-bolt text-primary"></i>
        <span>
          @switch (aiSuggestion()?.accion) {
            @case ('crear_nodo') { Crear nodo: {{ aiSuggestion()?.tipo_nodo }} }
            @case ('configurar') { Aplicar configuracion }
            @case ('ejecutar') { Ejecutar proceso }
            @default { Accion }
          }
        </span>
      </div>
      <p-button
        [label]="getAiActionLabel()"
        icon="pi pi-check"
        size="small"
        (onClick)="aplicarSugerenciaAi()">
      </p-button>
    </div>
  }

  <div class="ai-input-area">
    <div class="ai-quick-actions">
      <button class="quick-action" (click)="aiInputMessage.set('Crea un nodo CSV')">CSV</button>
      <button class="quick-action" (click)="aiInputMessage.set('Crea un nodo LLM')">LLM</button>
      <button class="quick-action" (click)="aiInputMessage.set('Crea un condicional')">Condicional</button>
      <button class="quick-action" (click)="aiInputMessage.set('Ejecuta el proceso')">Ejecutar</button>
    </div>
    <div class="ai-input-wrapper">
      <input
        pInputText
        [(ngModel)]="aiInputMessage"
        placeholder="Escribe lo que necesitas crear o configurar..."
        class="ai-input"
        (keydown.enter)="sendAiMessage()"
        [disabled]="aiIsProcessing()" />
      <p-button
        icon="pi pi-send"
        [rounded]="true"
        (onClick)="sendAiMessage()"
        [loading]="aiIsProcessing()"
        [disabled]="!aiInputMessage() || aiIsProcessing()">
      </p-button>
    </div>
  </div>
</p-dialog>
