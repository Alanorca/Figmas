<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Procesos - Sistema de Nodos</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #fafafa;
            color: #1a1a1a;
            height: 100vh;
            overflow: hidden;
        }

        /* Layout Container */
        .container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar izquierda oscura */
        .sidebar {
            width: 280px;
            background: #1a1a1a;
            color: white;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #333;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #333;
        }

        .sidebar-title {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #999;
            margin-bottom: 12px;
        }

        .close-panel {
            float: right;
            background: none;
            border: none;
            color: #999;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-panel:hover {
            color: white;
        }

        .nodes-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .node-item {
            padding: 14px;
            margin-bottom: 8px;
            background: #2a2a2a;
            border-radius: 8px;
            cursor: grab;
            transition: all 0.2s;
            border: 2px solid transparent;
            user-select: none;
        }

        .node-item:hover {
            background: #333;
            border-color: #10b981;
        }

        .node-item:active {
            cursor: grabbing;
        }

        .node-item.dragging {
            opacity: 0.5;
        }

        .node-item-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 6px;
        }

        .node-icon {
            font-size: 18px;
        }

        .node-name {
            font-weight: 600;
            font-size: 14px;
        }

        .node-drag-handle {
            margin-left: auto;
            color: #666;
            font-size: 16px;
        }

        .node-description {
            font-size: 12px;
            color: #999;
            line-height: 1.4;
        }

        /* Main Content Area */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Top Header */
        .top-header {
            background: white;
            padding: 16px 32px;
            border-bottom: 1px solid #e8e8e8;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #757575;
        }

        .breadcrumb-separator {
            color: #bdbdbd;
        }

        .page-title-section h1 {
            font-size: 20px;
            font-weight: 600;
            color: #1a1a1a;
            margin-top: 4px;
        }

        .page-subtitle {
            font-size: 12px;
            color: #757575;
            margin-top: 2px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-secondary {
            background: white;
            color: #1a1a1a;
            border: 1px solid #e0e0e0;
        }

        .btn-secondary:hover {
            background: #fafafa;
            border-color: #bdbdbd;
        }

        .btn-primary {
            background: #10b981;
            color: white;
        }

        .btn-primary:hover {
            background: #059669;
        }

        /* Toolbar */
        .toolbar {
            background: white;
            padding: 12px 32px;
            border-bottom: 1px solid #e8e8e8;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toolbar select {
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 13px;
            background: white;
            cursor: pointer;
            min-width: 200px;
        }

        .toolbar-button {
            width: 32px;
            height: 32px;
            border: none;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #757575;
            transition: all 0.2s;
        }

        .toolbar-button:hover {
            background: #fafafa;
            color: #1a1a1a;
        }

        .search-box {
            flex: 1;
            max-width: 400px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 8px 12px 8px 36px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 13px;
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }

        /* Canvas Area */
        .canvas-area {
            flex: 1;
            overflow: auto;
            background: #fafafa;
            position: relative;
        }

        .canvas {
            position: relative;
            min-width: 2000px;
            min-height: 2000px;
            padding: 40px;
        }

        .canvas.drag-over {
            background: linear-gradient(45deg, #f0fdf4 25%, transparent 25%, transparent 75%, #f0fdf4 75%),
                        linear-gradient(45deg, #f0fdf4 25%, transparent 25%, transparent 75%, #f0fdf4 75%);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
        }

        .canvas-area.drag-over {
            outline: 3px dashed #10b981;
            outline-offset: -3px;
        }

        /* Node Card */
        .node-card {
            position: absolute;
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            padding: 24px;
            width: 520px;
            cursor: move;
            user-select: none;
            transition: box-shadow 0.2s;
        }

        .node-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .node-card.dragging {
            opacity: 0.8;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            cursor: grabbing;
            z-index: 1000;
        }

        .node-card .node-card-header {
            cursor: grab;
        }

        .node-card.dragging .node-card-header {
            cursor: grabbing;
        }

        .node-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #f0f0f0;
        }

        .node-card-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .node-card-title-icon {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .node-card-title-text h3 {
            font-size: 16px;
            font-weight: 600;
            color: #1a1a1a;
        }

        .node-card-title-text p {
            font-size: 12px;
            color: #757575;
            margin-top: 2px;
        }

        .node-card-actions {
            display: flex;
            gap: 8px;
        }

        .icon-button {
            width: 32px;
            height: 32px;
            border: none;
            background: #fafafa;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #757575;
            transition: all 0.2s;
        }

        .icon-button:hover {
            background: #f0f0f0;
            color: #1a1a1a;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: #1a1a1a;
            margin-bottom: 8px;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            color: #1a1a1a;
            transition: all 0.2s;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 13px;
        }

        .form-help {
            font-size: 12px;
            color: #757575;
            margin-top: 4px;
        }

        /* Mini operator buttons for Math node */
        .operator-btn-mini {
            padding: 6px 10px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
            color: #c05621;
        }

        .operator-btn-mini:hover {
            background: #feebc8;
            border-color: #c05621;
        }

        /* File Upload */
        .file-upload-area {
            border: 2px dashed #e0e0e0;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .file-upload-area:hover {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .file-upload-icon {
            font-size: 40px;
            color: #bdbdbd;
            margin-bottom: 12px;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #fafafa;
            border-radius: 6px;
            margin-top: 12px;
        }

        .file-icon {
            font-size: 32px;
        }

        .file-details {
            flex: 1;
            text-align: left;
        }

        .file-name {
            font-size: 13px;
            font-weight: 500;
            color: #1a1a1a;
        }

        .file-size {
            font-size: 12px;
            color: #757575;
        }

        .file-status {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            background: #fff3e0;
            color: #ef6c00;
        }

        .file-remove {
            color: #e74c3c;
            cursor: pointer;
            font-size: 18px;
        }

        /* Condition Item */
        .condition-item {
            padding: 16px;
            background: #fafafa;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 3px solid #10b981;
        }

        .condition-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .condition-label {
            font-weight: 600;
            font-size: 13px;
            color: #1a1a1a;
        }

        .remove-condition {
            color: #e74c3c;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 16px;
        }

        .add-condition-btn {
            width: 100%;
            padding: 12px;
            background: #fafafa;
            border: 2px dashed #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            color: #757575;
            font-weight: 500;
            transition: all 0.2s;
        }

        .add-condition-btn:hover {
            border-color: #10b981;
            color: #10b981;
            background: #f0fdf4;
        }

        /* Tree Selector */
        .tree-selector {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        .tree-item {
            padding: 8px;
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .tree-item:hover {
            background: #fafafa;
        }

        .tree-item-checkbox {
            margin-right: 8px;
        }

        /* Fullscreen Editor Modal */
        .fullscreen-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fullscreen-modal.hidden {
            display: none;
        }

        .fullscreen-editor-container {
            width: 90vw;
            height: 85vh;
            background: white;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .fullscreen-editor-header {
            padding: 16px 24px;
            background: #1a1a1a;
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .fullscreen-editor-title {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .fullscreen-editor-body {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .fullscreen-editor-sidebar {
            width: 280px;
            background: #f8fafc;
            border-right: 1px solid #e2e8f0;
            overflow-y: auto;
            padding: 16px;
        }

        .fullscreen-editor-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .fullscreen-textarea {
            flex: 1;
            width: 100%;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            line-height: 1.6;
            resize: none;
        }

        .fullscreen-textarea:focus {
            outline: none;
            border-color: #7b1fa2;
            box-shadow: 0 0 0 3px rgba(123, 31, 162, 0.1);
        }

        .fullscreen-editor-footer {
            padding: 16px 24px;
            background: #f8fafc;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* Field Tree Selector */
        .field-tree {
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .field-tree-header {
            padding: 10px 12px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .field-tree-item {
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: background 0.15s;
            border-bottom: 1px solid #f1f5f9;
        }

        .field-tree-item:last-child {
            border-bottom: none;
        }

        .field-tree-item:hover {
            background: #f0fdf4;
        }

        .field-tree-item.selected {
            background: #d1fae5;
        }

        .field-tree-item input[type="checkbox"] {
            margin: 0;
        }

        .field-type-badge {
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .field-type-badge.string {
            background: #dbeafe;
            color: #1e40af;
        }

        .field-type-badge.number {
            background: #fef3c7;
            color: #92400e;
        }

        .field-type-badge.date {
            background: #e0e7ff;
            color: #3730a3;
        }

        .field-type-badge.boolean {
            background: #fce7f3;
            color: #9d174d;
        }

        /* Right Sidebar Panel */
        .right-sidebar {
            width: 480px;
            background: white;
            border-left: 1px solid #e8e8e8;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .right-sidebar.hidden {
            display: none;
        }

        /* Preview Panel */
        .preview-panel {
            width: 100%;
            background: white;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .preview-header {
            padding: 20px;
            border-bottom: 1px solid #e8e8e8;
        }

        .preview-title {
            font-size: 16px;
            font-weight: 600;
            color: #1a1a1a;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .preview-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .preview-table {
            width: 100%;
            font-size: 12px;
            border-collapse: collapse;
        }

        .preview-table th {
            padding: 8px;
            text-align: left;
            font-weight: 600;
            color: #757575;
            border-bottom: 2px solid #e8e8e8;
            font-size: 11px;
            text-transform: uppercase;
        }

        .preview-table td {
            padding: 8px;
            border-bottom: 1px solid #f0f0f0;
            color: #1a1a1a;
        }

        /* Status Badges */
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-badge.active {
            background: #d1fae5;
            color: #065f46;
        }

        .status-badge.pending {
            background: #fff3e0;
            color: #92400e;
        }

        .status-badge.complete {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-badge.fail {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Formula Editor */
        .formula-editor {
            position: relative;
        }

        .formula-editor-fullscreen {
            position: absolute;
            top: 8px;
            right: 8px;
            background: white;
            border: 1px solid #e0e0e0;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            color: #757575;
        }

        .formula-editor-fullscreen:hover {
            background: #fafafa;
            color: #1a1a1a;
        }

        /* Operator Buttons */
        .operator-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        .operator-btn {
            padding: 6px 12px;
            background: #fafafa;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .operator-btn:hover {
            background: #10b981;
            color: white;
            border-color: #10b981;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #757575;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .empty-state-title {
            font-size: 18px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 8px;
        }

        .empty-state-text {
            font-size: 14px;
        }

        /* Scrollbar Styles */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f0f0f0;
        }

        ::-webkit-scrollbar-thumb {
            background: #bdbdbd;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #999;
        }

        /* Connection Points & Lines */
        .node-card {
            position: relative;
        }

        .connection-point {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #10b981;
            border: 2px solid white;
            border-radius: 50%;
            cursor: crosshair;
            opacity: 0;
            transition: opacity 0.2s, transform 0.2s;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.4);
        }

        .connection-point.output {
            right: -6px;
            top: 50%;
            transform: translateY(-50%);
        }

        .connection-point.input {
            left: -6px;
            top: 50%;
            transform: translateY(-50%);
        }

        .node-card:hover .connection-point {
            opacity: 1;
        }

        .connection-point:hover {
            transform: translateY(-50%) scale(1.3);
            background: #059669;
            box-shadow: 0 2px 12px rgba(16, 185, 129, 0.6);
        }

        .connection-point.active {
            opacity: 1 !important;
            transform: translateY(-50%) scale(1.5);
            animation: pulse 1s infinite;
        }

        .connection-point.highlight {
            opacity: 1 !important;
            transform: translateY(-50%) scale(1.4);
            background: #fbbf24;
            border-color: #f59e0b;
            box-shadow: 0 2px 12px rgba(251, 191, 36, 0.8);
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 2px 8px rgba(16, 185, 129, 0.4);
            }
            50% {
                box-shadow: 0 2px 16px rgba(16, 185, 129, 0.8);
            }
        }

        /* Connection Lines SVG Container */
        #connectionsSvg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .connection-line {
            stroke: #10b981;
            stroke-width: 2;
            fill: none;
            stroke-linecap: round;
        }

        .connection-line.dragging {
            stroke: #60a5fa;
            stroke-width: 2;
            stroke-dasharray: 5, 5;
            animation: dash 0.5s linear infinite;
        }

        @keyframes dash {
            to {
                stroke-dashoffset: -10;
            }
        }

        .connection-line-arrow {
            fill: #10b981;
        }

        /* Connection Labels */
        .connection-label {
            position: absolute;
            background: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            color: #1a1a1a;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            pointer-events: none;
            z-index: 5;
        }

        /* ========== RIGHT SIDEBAR - NODE CONFIGURATION ========== */
        .node-config-sidebar {
            width: 520px;
            background: white;
            border-left: 1px solid #e8e8e8;
            display: flex;
            flex-direction: column;
            height: 100%;
            transition: transform 0.3s ease;
        }

        .node-config-sidebar.hidden {
            display: none;
        }

        .config-header {
            padding: 20px;
            border-bottom: 1px solid #e8e8e8;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #fafafa;
        }

        .config-header-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .config-header-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .config-header-text h3 {
            font-size: 16px;
            font-weight: 600;
            color: #1a1a1a;
            margin: 0;
        }

        .config-header-text p {
            font-size: 12px;
            color: #757575;
            margin: 2px 0 0 0;
        }

        /* Tabs for Input/Output */
        .config-tabs {
            display: flex;
            border-bottom: 1px solid #e8e8e8;
            background: white;
        }

        .config-tab {
            flex: 1;
            padding: 14px 20px;
            background: none;
            border: none;
            font-size: 14px;
            font-weight: 500;
            color: #757575;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .config-tab:hover {
            background: #fafafa;
            color: #1a1a1a;
        }

        .config-tab.active {
            color: #10b981;
            background: white;
        }

        .config-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: #10b981;
        }

        .config-tab-badge {
            background: #e8e8e8;
            color: #757575;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }

        .config-tab.active .config-tab-badge {
            background: #d1fae5;
            color: #065f46;
        }

        .config-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .config-section {
            margin-bottom: 24px;
        }

        .config-section-title {
            font-size: 12px;
            font-weight: 600;
            color: #757575;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .config-section-title::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #e8e8e8;
        }

        /* Variable chips for inputs */
        .variable-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .variable-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 6px;
            font-size: 13px;
            color: #0369a1;
            cursor: pointer;
            transition: all 0.2s;
        }

        .variable-chip:hover {
            background: #e0f2fe;
            border-color: #7dd3fc;
        }

        .variable-chip.selected {
            background: #0ea5e9;
            color: white;
            border-color: #0ea5e9;
        }

        .variable-chip-type {
            font-size: 10px;
            padding: 2px 6px;
            background: rgba(0,0,0,0.1);
            border-radius: 3px;
        }

        .variable-chip.selected .variable-chip-type {
            background: rgba(255,255,255,0.2);
        }

        /* Output schema builder */
        .schema-builder {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }

        .schema-field {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            background: white;
        }

        .schema-field:last-child {
            border-bottom: none;
        }

        .schema-field:hover {
            background: #fafafa;
        }

        .schema-field-name {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 13px;
        }

        .schema-field-type {
            width: 120px;
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 13px;
            background: white;
        }

        .schema-field-required {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            color: #757575;
        }

        .schema-field-remove {
            width: 28px;
            height: 28px;
            border: none;
            background: #fee2e2;
            color: #dc2626;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .schema-field-remove:hover {
            background: #fecaca;
        }

        .add-schema-field {
            width: 100%;
            padding: 12px;
            background: #fafafa;
            border: none;
            color: #757575;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .add-schema-field:hover {
            background: #f0fdf4;
            color: #10b981;
        }

        /* Model parameters slider */
        .param-slider-group {
            margin-bottom: 16px;
        }

        .param-slider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .param-slider-label {
            font-size: 13px;
            font-weight: 500;
            color: #1a1a1a;
        }

        .param-slider-value {
            font-size: 13px;
            color: #10b981;
            font-weight: 600;
            background: #f0fdf4;
            padding: 2px 8px;
            border-radius: 4px;
        }

        .param-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e8e8e8;
            outline: none;
            -webkit-appearance: none;
        }

        .param-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #10b981;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(16, 185, 129, 0.4);
        }

        .param-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #10b981;
            cursor: pointer;
            border: none;
        }

        /* Provider/Model selector */
        .model-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .model-option {
            padding: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .model-option:hover {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .model-option.selected {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .model-option-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .model-option-name {
            font-size: 14px;
            font-weight: 600;
            color: #1a1a1a;
        }

        .model-option-provider {
            font-size: 11px;
            color: #757575;
        }

        /* Prompt editor enhanced */
        .prompt-editor-container {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }

        .prompt-editor-toolbar {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #fafafa;
            border-bottom: 1px solid #e0e0e0;
        }

        .prompt-toolbar-btn {
            padding: 6px 10px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .prompt-toolbar-btn:hover {
            background: #10b981;
            color: white;
            border-color: #10b981;
        }

        .prompt-editor-textarea {
            width: 100%;
            min-height: 150px;
            padding: 16px;
            border: none;
            resize: vertical;
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
        }

        .prompt-editor-textarea:focus {
            outline: none;
        }

        .prompt-editor-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #fafafa;
            border-top: 1px solid #e0e0e0;
            font-size: 12px;
            color: #757575;
        }

        .token-counter {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .token-count {
            font-weight: 600;
            color: #1a1a1a;
        }

        /* Variables autocomplete dropdown */
        .variables-dropdown {
            position: absolute;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .variables-dropdown.show {
            display: block;
        }

        .variable-option {
            padding: 10px 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.2s;
        }

        .variable-option:hover {
            background: #f0fdf4;
        }

        .variable-option-name {
            font-weight: 500;
            color: #1a1a1a;
        }

        .variable-option-source {
            font-size: 11px;
            color: #757575;
            margin-left: auto;
        }

        /* Test mode panel */
        .test-panel {
            background: #fffbeb;
            border: 1px solid #fcd34d;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .test-panel-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .test-panel-title {
            font-weight: 600;
            color: #92400e;
        }

        .test-panel-badge {
            background: #fcd34d;
            color: #78350f;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .test-sample-data {
            background: white;
            border: 1px solid #fcd34d;
            border-radius: 6px;
            padding: 12px;
            font-family: monospace;
            font-size: 12px;
            max-height: 150px;
            overflow-y: auto;
        }

        .test-actions {
            display: flex;
            gap: 12px;
            margin-top: 12px;
        }

        .btn-test {
            flex: 1;
            padding: 10px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-test-run {
            background: #f59e0b;
            color: white;
            border: none;
        }

        .btn-test-run:hover {
            background: #d97706;
        }

        .btn-test-preview {
            background: white;
            color: #92400e;
            border: 1px solid #fcd34d;
        }

        .btn-test-preview:hover {
            background: #fffbeb;
        }

        /* Error handling config */
        .error-config {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 16px;
        }

        .error-config-title {
            font-weight: 600;
            color: #991b1b;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .error-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .error-option:hover {
            background: #fff5f5;
        }

        .error-option.selected {
            border: 2px solid #ef4444;
        }

        .error-option input[type="radio"] {
            accent-color: #ef4444;
        }

        /* Preview result panel */
        .result-preview {
            background: #f0fdf4;
            border: 1px solid #86efac;
            border-radius: 8px;
            padding: 16px;
            margin-top: 20px;
        }

        .result-preview-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .result-preview-title {
            font-weight: 600;
            color: #166534;
        }

        .result-preview-content {
            background: white;
            border: 1px solid #86efac;
            border-radius: 6px;
            padding: 12px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }

        /* Node selected state */
        .node-card.selected {
            box-shadow: 0 0 0 3px #10b981, 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* System prompt section */
        .system-prompt-section {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .system-prompt-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .system-prompt-title {
            font-weight: 600;
            color: #475569;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .system-prompt-toggle {
            padding: 4px 10px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }

        .system-prompt-toggle:hover {
            background: #f1f5f9;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar with Node Types -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">
                    Nodos
                    <button class="close-panel" onclick="toggleSidebar()">√ó</button>
                </div>
            </div>
            <div class="nodes-list">
                <!-- Nodo Condicional -->
                <div class="node-item" onclick="addNode('conditional')">
                    <div class="node-item-header">
                        <span class="node-icon">‚ö°</span>
                        <span class="node-name">Nodo Condicional (If / Case)</span>
                        <span class="node-drag-handle">‚ãÆ‚ãÆ</span>
                    </div>
                    <div class="node-description">
                        Permite bifurcar el flujo seg√∫n condiciones definidas por el usuario.
                    </div>
                </div>

                <!-- Nodo Archivos -->
                <div class="node-item" onclick="addNode('file')">
                    <div class="node-item-header">
                        <span class="node-icon">üìÅ</span>
                        <span class="node-name">Nodo Archivos (CSV / Excel)</span>
                        <span class="node-drag-handle">‚ãÆ‚ãÆ</span>
                    </div>
                    <div class="node-description">
                        Gestiona la carga o selecci√≥n de archivos para alimentar el proceso.
                    </div>
                </div>

                <!-- Nodo Activos -->
                <div class="node-item" onclick="addNode('asset')">
                    <div class="node-item-header">
                        <span class="node-icon">üè¶</span>
                        <span class="node-name">Nodo Activos</span>
                        <span class="node-drag-handle">‚ãÆ‚ãÆ</span>
                    </div>
                    <div class="node-description">
                        Integra activos del negocio al flujo del proceso.
                    </div>
                </div>

                <!-- Nodo Transformaci√≥n -->
                <div class="node-item" onclick="addNode('transformation')">
                    <div class="node-item-header">
                        <span class="node-icon">üîÑ</span>
                        <span class="node-name">Nodo Transformaci√≥n</span>
                        <span class="node-drag-handle">‚ãÆ‚ãÆ</span>
                    </div>
                    <div class="node-description">
                        Realiza operaciones sobre datos para adaptarlos al contexto.
                    </div>
                </div>

                <!-- Nodo Prompt LLM -->
                <div class="node-item" onclick="addNode('prompt')">
                    <div class="node-item-header">
                        <span class="node-icon">ü§ñ</span>
                        <span class="node-name">Nodo Prompt LLM</span>
                        <span class="node-drag-handle">‚ãÆ‚ãÆ</span>
                    </div>
                    <div class="node-description">
                        Invoca modelos de lenguaje para generar respuestas basadas en contexto.
                    </div>
                </div>

                <!-- Nodo Cambio de Estado -->
                <div class="node-item" onclick="addNode('status')">
                    <div class="node-item-header">
                        <span class="node-icon">üîÑ</span>
                        <span class="node-name">Nodo Cambio de Estado del Proceso</span>
                        <span class="node-drag-handle">‚ãÆ‚ãÆ</span>
                    </div>
                    <div class="node-description">
                        Actualiza el estado del proceso en ejecuci√≥n.
                    </div>
                </div>

                <!-- Nodo Branching -->
                <div class="node-item" onclick="addNode('branching')">
                    <div class="node-item-header">
                        <span class="node-icon">üåø</span>
                        <span class="node-name">Nodo Branching</span>
                        <span class="node-drag-handle">‚ãÆ‚ãÆ</span>
                    </div>
                    <div class="node-description">
                        Define ramas paralelas con estrategias de ejecuci√≥n.
                    </div>
                </div>

                <!-- Nodo Matem√°tico -->
                <div class="node-item" onclick="addNode('math')">
                    <div class="node-item-header">
                        <span class="node-icon">üî¢</span>
                        <span class="node-name">Nodo Matem√°tico</span>
                        <span class="node-drag-handle">‚ãÆ‚ãÆ</span>
                    </div>
                    <div class="node-description">
                        C√°lculos y f√≥rmulas personalizadas sobre datos.
                    </div>
                </div>

                <!-- Nodo ML -->
                <div class="node-item" onclick="addNode('ml')">
                    <div class="node-item-header">
                        <span class="node-icon">üß†</span>
                        <span class="node-name">Nodo Machine Learning</span>
                        <span class="node-drag-handle">‚ãÆ‚ãÆ</span>
                    </div>
                    <div class="node-description">
                        Modelos ML para predicci√≥n, clasificaci√≥n y an√°lisis.
                    </div>
                </div>

                <!-- Nodo Integraci√≥n (futuro) -->
                <div class="node-item" onclick="alert('Nodo en desarrollo - Disponible pr√≥ximamente')" style="opacity: 0.5;">
                    <div class="node-item-header">
                        <span class="node-icon">üîó</span>
                        <span class="node-name">Nodo Integraci√≥n (futuro)</span>
                        <span class="node-drag-handle">‚ãÆ‚ãÆ</span>
                    </div>
                    <div class="node-description">
                        Conexi√≥n con sistemas externos y bases de datos relacionales.
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Header -->
            <div class="top-header">
                <div class="page-title-section">
                    <div class="breadcrumb">
                        üè† <span class="breadcrumb-separator">‚Ä∫</span> Electronics <span class="breadcrumb-separator">‚Ä∫</span> Computer <span class="breadcrumb-separator">‚Ä∫</span> Accessories <span class="breadcrumb-separator">‚Ä∫</span> Keyboard <span class="breadcrumb-separator">‚Ä∫</span> Wireless
                    </div>
                    <h1>Procesos</h1>
                    <p class="page-subtitle">Orca@SecurityBy Design</p>
                </div>
                <div class="header-actions">
                    <button class="btn btn-secondary">üîç Buscar</button>
                    <button class="btn btn-primary" onclick="saveProcess()">üíæ Guardar</button>
                </div>
            </div>

            <!-- Toolbar -->
            <div class="toolbar">
                <select id="nodeTypeSelect">
                    <option value="">Seleccionar nodo</option>
                    <option value="conditional">Nodo Condicional</option>
                    <option value="file">Nodo Archivos</option>
                    <option value="asset">Nodo Activos</option>
                    <option value="transformation">Nodo Transformaci√≥n</option>
                    <option value="prompt">Nodo Prompt LLM</option>
                    <option value="status">Nodo Cambio de Estado</option>
                </select>
                <button class="toolbar-button" title="Validar flujo">‚úì</button>
                <button class="toolbar-button" title="Zoom in">+</button>
                <button class="toolbar-button" title="Zoom out">-</button>
                <button class="toolbar-button" title="Ajustar vista">‚ä°</button>
                <div class="search-box">
                    <span class="search-icon">üîç</span>
                    <input type="text" placeholder="Buscar">
                </div>
            </div>

            <!-- Canvas Area -->
            <div class="canvas-area">
                <div class="canvas" id="canvas">
                    <!-- SVG for connection lines -->
                    <svg id="connectionsSvg">
                        <defs>
                            <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                                <polygon points="0 0, 10 3, 0 6" class="connection-line-arrow" />
                            </marker>
                        </defs>
                    </svg>

                    <!-- Empty State -->
                    <div class="empty-state" id="emptyState">
                        <div class="empty-state-icon">üìã</div>
                        <div class="empty-state-title">Adquisici√≥n de Cr√©ditos Hipotecarios</div>
                        <div class="empty-state-text">
                            Selecciona un tipo de nodo desde el panel izquierdo o el men√∫ desplegable para comenzar a construir tu proceso.
                        </div>
                    </div>

                    <!-- Los nodos se agregar√°n din√°micamente aqu√≠ -->
                </div>
            </div>
        </div>

        <!-- Right Sidebar Panel - Node Configuration -->
        <div class="node-config-sidebar hidden" id="nodeConfigSidebar">
            <!-- Header -->
            <div class="config-header">
                <div class="config-header-title">
                    <div class="config-header-icon" id="configHeaderIcon" style="background: #e0f7fa;">ü§ñ</div>
                    <div class="config-header-text">
                        <h3 id="configHeaderTitle">Nodo Prompt LLM</h3>
                        <p id="configHeaderSubtitle">Configuraci√≥n del nodo</p>
                    </div>
                </div>
                <button class="close-panel" onclick="closeNodeConfig()">√ó</button>
            </div>

            <!-- Tabs: Entrada / Salida / Configuraci√≥n -->
            <div class="config-tabs">
                <button class="config-tab active" onclick="switchConfigTab('input')" data-tab="input">
                    ‚¨áÔ∏è Entrada
                    <span class="config-tab-badge" id="inputBadge">0</span>
                </button>
                <button class="config-tab" onclick="switchConfigTab('output')" data-tab="output">
                    ‚¨ÜÔ∏è Salida
                    <span class="config-tab-badge" id="outputBadge">0</span>
                </button>
                <button class="config-tab" onclick="switchConfigTab('config')" data-tab="config">
                    ‚öôÔ∏è Config
                </button>
            </div>

            <!-- Tab Content -->
            <div class="config-body" id="configBody">
                <!-- INPUT TAB -->
                <div id="inputTabContent" class="tab-content">
                    <div class="config-section">
                        <div class="config-section-title">Variables de entrada disponibles</div>
                        <p class="form-help" style="margin-bottom: 12px;">
                            Selecciona las variables que deseas usar en el prompt. Provienen de nodos conectados.
                        </p>
                        <div class="variable-list" id="inputVariablesList">
                            <!-- Variables din√°micas de nodos conectados -->
                            <div class="variable-chip selected" onclick="toggleVariableSelection(this)">
                                <span>archivo.nombre</span>
                                <span class="variable-chip-type">string</span>
                            </div>
                            <div class="variable-chip selected" onclick="toggleVariableSelection(this)">
                                <span>archivo.email</span>
                                <span class="variable-chip-type">string</span>
                            </div>
                            <div class="variable-chip" onclick="toggleVariableSelection(this)">
                                <span>archivo.position</span>
                                <span class="variable-chip-type">string</span>
                            </div>
                            <div class="variable-chip" onclick="toggleVariableSelection(this)">
                                <span>archivo.status</span>
                                <span class="variable-chip-type">string</span>
                            </div>
                            <div class="variable-chip selected" onclick="toggleVariableSelection(this)">
                                <span>activo.nombre</span>
                                <span class="variable-chip-type">string</span>
                            </div>
                            <div class="variable-chip" onclick="toggleVariableSelection(this)">
                                <span>activo.valor</span>
                                <span class="variable-chip-type">number</span>
                            </div>
                            <div class="variable-chip" onclick="toggleVariableSelection(this)">
                                <span>activo.area</span>
                                <span class="variable-chip-type">string</span>
                            </div>
                        </div>
                    </div>

                    <div class="config-section">
                        <div class="config-section-title">Vista previa del contexto</div>
                        <div class="test-sample-data" id="contextPreview">
{
  "archivo": {
    "nombre": "Alice Johnson Smith",
    "email": "alice@sns.com"
  },
  "activo": {
    "nombre": "Sistema ERP Financiero"
  }
}
                        </div>
                    </div>

                    <div class="config-section">
                        <div class="config-section-title">Nodos conectados como entrada</div>
                        <div id="connectedInputNodes">
                            <div style="padding: 12px; background: #f0f9ff; border-radius: 6px; margin-bottom: 8px; display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 20px;">üìÅ</span>
                                <div>
                                    <div style="font-weight: 500; color: #1a1a1a;">Nodo Radio Archivo</div>
                                    <div style="font-size: 12px; color: #757575;">4 columnas disponibles</div>
                                </div>
                            </div>
                            <div style="padding: 12px; background: #f0fdf4; border-radius: 6px; display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 20px;">üè¶</span>
                                <div>
                                    <div style="font-weight: 500; color: #1a1a1a;">Nodo Activo</div>
                                    <div style="font-size: 12px; color: #757575;">3 propiedades disponibles</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- OUTPUT TAB -->
                <div id="outputTabContent" class="tab-content" style="display: none;">
                    <div class="config-section">
                        <div class="config-section-title">Formato de salida</div>
                        <select class="form-select" id="outputFormatSelect" onchange="updateOutputFormat(this.value)">
                            <option value="json">JSON estructurado</option>
                            <option value="text">Texto plano</option>
                            <option value="table">Tabla de datos</option>
                            <option value="markdown">Markdown</option>
                        </select>
                    </div>

                    <div class="config-section" id="schemaBuilderSection">
                        <div class="config-section-title">Schema de salida (JSON)</div>
                        <p class="form-help" style="margin-bottom: 12px;">
                            Define los campos que el LLM debe extraer/generar.
                        </p>
                        <div class="schema-builder" id="schemaBuilder">
                            <div class="schema-field">
                                <input type="text" class="schema-field-name" value="tipo_riesgo" placeholder="Nombre del campo">
                                <select class="schema-field-type">
                                    <option value="string" selected>String</option>
                                    <option value="number">Number</option>
                                    <option value="boolean">Boolean</option>
                                    <option value="array">Array</option>
                                    <option value="object">Object</option>
                                </select>
                                <label class="schema-field-required">
                                    <input type="checkbox" checked> Req.
                                </label>
                                <button class="schema-field-remove" onclick="removeSchemaField(this)">√ó</button>
                            </div>
                            <div class="schema-field">
                                <input type="text" class="schema-field-name" value="severidad" placeholder="Nombre del campo">
                                <select class="schema-field-type">
                                    <option value="string" selected>String</option>
                                    <option value="number">Number</option>
                                    <option value="boolean">Boolean</option>
                                    <option value="array">Array</option>
                                    <option value="object">Object</option>
                                </select>
                                <label class="schema-field-required">
                                    <input type="checkbox" checked> Req.
                                </label>
                                <button class="schema-field-remove" onclick="removeSchemaField(this)">√ó</button>
                            </div>
                            <div class="schema-field">
                                <input type="text" class="schema-field-name" value="acciones_recomendadas" placeholder="Nombre del campo">
                                <select class="schema-field-type">
                                    <option value="string">String</option>
                                    <option value="number">Number</option>
                                    <option value="boolean">Boolean</option>
                                    <option value="array" selected>Array</option>
                                    <option value="object">Object</option>
                                </select>
                                <label class="schema-field-required">
                                    <input type="checkbox"> Req.
                                </label>
                                <button class="schema-field-remove" onclick="removeSchemaField(this)">√ó</button>
                            </div>
                            <button class="add-schema-field" onclick="addSchemaField()">
                                + Agregar campo
                            </button>
                        </div>
                    </div>

                    <div class="config-section">
                        <div class="config-section-title">Variable de salida</div>
                        <input type="text" class="form-input" id="outputVariableName" value="respuesta_llm" placeholder="Nombre de la variable">
                        <p class="form-help">Esta variable estar√° disponible para los nodos siguientes.</p>
                    </div>

                    <div class="config-section">
                        <div class="config-section-title">Vista previa del schema</div>
                        <div class="test-sample-data" id="schemaPreview">
{
  "tipo_riesgo": "string (requerido)",
  "severidad": "string (requerido)",
  "acciones_recomendadas": "array (opcional)"
}
                        </div>
                    </div>
                </div>

                <!-- CONFIG TAB -->
                <div id="configTabContent" class="tab-content" style="display: none;">
                    <!-- Model Selection -->
                    <div class="config-section">
                        <div class="config-section-title">Proveedor y Modelo</div>
                        <div class="form-group">
                            <label class="form-label">Proveedor</label>
                            <select class="form-select" id="providerSelect" onchange="updateModelOptions(this.value)">
                                <option value="openai">OpenAI</option>
                                <option value="anthropic">Anthropic</option>
                                <option value="google">Google</option>
                                <option value="xai">xAI</option>
                                <option value="custom">Personalizado</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Modelo</label>
                            <select class="form-select" id="modelSelect">
                                <option value="gpt-4-turbo">GPT-4 Turbo</option>
                                <option value="gpt-4">GPT-4</option>
                                <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                            </select>
                        </div>
                    </div>

                    <!-- Model Parameters -->
                    <div class="config-section">
                        <div class="config-section-title">Par√°metros del modelo</div>

                        <div class="param-slider-group">
                            <div class="param-slider-header">
                                <span class="param-slider-label">Temperature</span>
                                <span class="param-slider-value" id="tempValue">0.7</span>
                            </div>
                            <input type="range" class="param-slider" id="temperatureSlider" min="0" max="2" step="0.1" value="0.7" oninput="updateSliderValue('temp', this.value)">
                            <p class="form-help">Menor = m√°s determin√≠stico, Mayor = m√°s creativo</p>
                        </div>

                        <div class="param-slider-group">
                            <div class="param-slider-header">
                                <span class="param-slider-label">Max Tokens</span>
                                <span class="param-slider-value" id="maxTokensValue">2048</span>
                            </div>
                            <input type="range" class="param-slider" id="maxTokensSlider" min="256" max="8192" step="256" value="2048" oninput="updateSliderValue('maxTokens', this.value)">
                            <p class="form-help">Longitud m√°xima de la respuesta</p>
                        </div>

                        <div class="param-slider-group">
                            <div class="param-slider-header">
                                <span class="param-slider-label">Top P</span>
                                <span class="param-slider-value" id="topPValue">1.0</span>
                            </div>
                            <input type="range" class="param-slider" id="topPSlider" min="0" max="1" step="0.05" value="1" oninput="updateSliderValue('topP', this.value)">
                            <p class="form-help">Nucleus sampling - controla diversidad</p>
                        </div>
                    </div>

                    <!-- System Prompt -->
                    <div class="config-section">
                        <div class="config-section-title">System Prompt</div>
                        <div class="system-prompt-section">
                            <div class="system-prompt-header">
                                <span class="system-prompt-title">üéØ Instrucciones del sistema</span>
                                <button class="system-prompt-toggle" onclick="toggleSystemPrompt()">Expandir</button>
                            </div>
                            <textarea class="form-textarea" id="systemPromptText" style="min-height: 80px;" placeholder="Eres un asistente experto en an√°lisis de riesgos GRC...">Eres un asistente experto en an√°lisis de riesgos GRC. Tu objetivo es analizar datos y extraer informaci√≥n relevante de manera estructurada.</textarea>
                        </div>
                    </div>

                    <!-- User Prompt -->
                    <div class="config-section">
                        <div class="config-section-title">Prompt de usuario</div>
                        <div class="prompt-editor-container">
                            <div class="prompt-editor-toolbar">
                                <button class="prompt-toolbar-btn" onclick="insertVariable()">{{var}}</button>
                                <button class="prompt-toolbar-btn" onclick="insertTemplate('analisis')">üìä An√°lisis</button>
                                <button class="prompt-toolbar-btn" onclick="insertTemplate('clasificacion')">üè∑Ô∏è Clasificar</button>
                                <button class="prompt-toolbar-btn" onclick="insertTemplate('extraccion')">üìù Extraer</button>
                                <button class="prompt-toolbar-btn" style="margin-left: auto;" onclick="openFullscreenPrompt()">‚õ∂</button>
                            </div>
                            <textarea class="prompt-editor-textarea" id="userPromptText" placeholder="Escribe tu prompt aqu√≠...

Usa {{variable}} para insertar datos del contexto.">Analiza el siguiente registro de empleado y determina:

1. Tipo de riesgo asociado a su rol
2. Nivel de severidad (alto, medio, bajo)
3. Acciones recomendadas

Datos del empleado:
- Nombre: {{archivo.nombre}}
- Email: {{archivo.email}}
- Activo asociado: {{activo.nombre}}</textarea>
                            <div class="prompt-editor-footer">
                                <div class="token-counter">
                                    <span>Tokens estimados:</span>
                                    <span class="token-count" id="tokenCount">~145</span>
                                </div>
                                <div>
                                    <span id="variablesDetected">3 variables detectadas</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Test Mode -->
                    <div class="config-section">
                        <div class="config-section-title">Modo de prueba</div>
                        <div class="test-panel">
                            <div class="test-panel-header">
                                <span>üß™</span>
                                <span class="test-panel-title">Probar con datos de muestra</span>
                                <span class="test-panel-badge">1 registro</span>
                            </div>
                            <div class="test-sample-data">
{
  "archivo": {
    "nombre": "Alice Johnson Smith",
    "email": "alice@sns.com",
    "position": "Financial Analyst"
  },
  "activo": {
    "nombre": "Sistema ERP Financiero"
  }
}
                            </div>
                            <div class="test-actions">
                                <button class="btn-test btn-test-preview" onclick="previewPrompt()">üëÅÔ∏è Ver prompt final</button>
                                <button class="btn-test btn-test-run" onclick="runTest()">‚ñ∂Ô∏è Ejecutar prueba</button>
                            </div>
                        </div>
                    </div>

                    <!-- Error Handling -->
                    <div class="config-section">
                        <div class="config-section-title">Manejo de errores</div>
                        <div class="error-config">
                            <div class="error-config-title">
                                ‚ö†Ô∏è Acci√≥n en caso de error
                            </div>
                            <label class="error-option">
                                <input type="radio" name="errorAction" value="retry" checked>
                                <div>
                                    <div style="font-weight: 500;">Reintentar (3 intentos)</div>
                                    <div style="font-size: 12px; color: #757575;">Reintenta autom√°ticamente antes de fallar</div>
                                </div>
                            </label>
                            <label class="error-option">
                                <input type="radio" name="errorAction" value="skip">
                                <div>
                                    <div style="font-weight: 500;">Saltar registro</div>
                                    <div style="font-size: 12px; color: #757575;">Contin√∫a con el siguiente registro</div>
                                </div>
                            </label>
                            <label class="error-option">
                                <input type="radio" name="errorAction" value="fail">
                                <div>
                                    <div style="font-weight: 500;">Detener proceso</div>
                                    <div style="font-size: 12px; color: #757575;">Marca el proceso como fallido</div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Result Preview (shown after test) -->
                    <div class="result-preview" id="resultPreview" style="display: none;">
                        <div class="result-preview-header">
                            <span>‚úÖ</span>
                            <span class="result-preview-title">Resultado de prueba</span>
                        </div>
                        <div class="result-preview-content" id="resultPreviewContent">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer Actions -->
            <div style="padding: 16px 20px; border-top: 1px solid #e8e8e8; display: flex; gap: 12px;">
                <button class="btn btn-secondary" style="flex: 1;" onclick="closeNodeConfig()">Cancelar</button>
                <button class="btn btn-primary" style="flex: 1;" onclick="saveNodeConfig()">üíæ Guardar</button>
            </div>
        </div>
    </div>

    <script>
        // Node templates
        const nodeTemplates = {
            conditional: `
                <div class="node-card">
                    <div class="node-card-header">
                        <div class="node-card-title">
                            <div class="node-card-title-icon" style="background: #e3f2fd; color: #1976d2;">‚ö°</div>
                            <div class="node-card-title-text">
                                <h3>Nodo Condicional</h3>
                                <p>Define condiciones para ramificaci√≥n del flujo</p>
                            </div>
                        </div>
                        <div class="node-card-actions">
                            <button class="icon-button" onclick="editNode(this)">‚úèÔ∏è</button>
                            <button class="icon-button" onclick="deleteNode(this)">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tipo de estructura</label>
                        <select class="form-select">
                            <option value="if">If (simple)</option>
                            <option value="case">Case (m√∫ltiples casos)</option>
                        </select>
                        <p class="form-help">Selecciona el tipo de l√≥gica condicional</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Condiciones</label>
                        <div id="conditionsList">
                            <div class="condition-item">
                                <div class="condition-header">
                                    <span class="condition-label">Condici√≥n 1</span>
                                    <button class="remove-condition">√ó</button>
                                </div>
                                <input type="text" class="form-input" placeholder="Variable o expresi√≥n (ej: monto > 1000)" style="margin-bottom: 8px;">
                                <select class="form-select" style="margin-bottom: 8px;">
                                    <option value="">Selecciona nodo destino</option>
                                    <option value="node2">Nodo Transformaci√≥n</option>
                                    <option value="node3">Nodo Prompt LLM</option>
                                </select>
                            </div>
                        </div>
                        <button class="add-condition-btn">+ Agregar condici√≥n</button>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Caso por defecto (default)</label>
                        <select class="form-select">
                            <option value="">Seleccionar acci√≥n...</option>
                            <option value="node">Conectar a nodo espec√≠fico</option>
                            <option value="complete">Completar proceso</option>
                            <option value="fail">Marcar como fallido</option>
                            <option value="cancel">Cancelar proceso</option>
                        </select>
                        <p class="form-help">Acci√≥n cuando ninguna condici√≥n se cumple</p>
                    </div>
                </div>
            `,
            file: `
                <div class="node-card">
                    <div class="node-card-header">
                        <div class="node-card-title">
                            <div class="node-card-title-icon" style="background: #fff3e0; color: #ef6c00;">üìÅ</div>
                            <div class="node-card-title-text">
                                <h3>Nodo Radio Archivo</h3>
                                <p>Integra archivos delimitados (XLS, CSV) como fuente de datos</p>
                            </div>
                        </div>
                        <div class="node-card-actions">
                            <button class="icon-button" onclick="showPreview()">üëÅÔ∏è</button>
                            <button class="icon-button" onclick="editNode(this)">‚úèÔ∏è</button>
                            <button class="icon-button" onclick="deleteNode(this)">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Nombre del Nodo</label>
                        <input type="text" class="form-input" placeholder="Datos Bancarios" value="Datos Bancarios">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Seleccionar archivo</label>
                        <div class="file-upload-area">
                            <div class="file-upload-icon">üìÑ</div>
                            <p style="margin-bottom: 8px; font-weight: 500;">Choose | Upload | Cancel</p>
                            <p style="font-size: 12px; color: #757575;">Arrastra y suelta tus archivos aqu√≠ para subirlos</p>
                        </div>
                        <div class="file-info">
                            <span class="file-icon">üìä</span>
                            <div class="file-details">
                                <div class="file-name">5mmj7jgQg8u81.png</div>
                                <div class="file-size">124.488 KB</div>
                            </div>
                            <span class="file-status">Pending</span>
                            <span class="file-remove">√ó</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Delimitador (CSV)</label>
                        <select class="form-select">
                            <option value=",">Coma (,)</option>
                            <option value=";">Punto y coma (;)</option>
                            <option value="|">Pipe (|)</option>
                            <option value="tab">Tabulaci√≥n</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Columna clasificadora</label>
                        <select class="form-select">
                            <option value="">Selecciona una opci√≥n</option>
                            <option value="col1">Nombre</option>
                            <option value="col2">Email</option>
                            <option value="col3">Position</option>
                        </select>
                        <p class="form-help">Define la columna para agrupar/clasificar los datos</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Selecciona las columnas para analizar</label>
                        <select class="form-select" multiple style="min-height: 100px;">
                            <option value="col1">Nombre</option>
                            <option value="col2">Email</option>
                            <option value="col3">Position</option>
                            <option value="col4">Status</option>
                            <option value="col5">Rol</option>
                        </select>
                        <p class="form-help">Mant√©n presionado Ctrl/Cmd para seleccionar m√∫ltiples</p>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-secondary" style="flex: 1;">Previsualizar</button>
                        <button class="btn btn-primary" style="flex: 1;">Siguiente</button>
                    </div>
                </div>
            `,
            asset: `
                <div class="node-card">
                    <div class="node-card-header">
                        <div class="node-card-title">
                            <div class="node-card-title-icon" style="background: #e8f5e9; color: #2e7d32;">üè¶</div>
                            <div class="node-card-title-text">
                                <h3>Nodo Activo</h3>
                                <p>Vincula un activo espec√≠fico del √°rea correspondiente al flujo del proceso</p>
                            </div>
                        </div>
                        <div class="node-card-actions">
                            <button class="icon-button" onclick="editNode(this)">‚úèÔ∏è</button>
                            <button class="icon-button" onclick="deleteNode(this)">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">√Årea del Activo</label>
                        <select class="form-select" onchange="loadAssets(this.value)">
                            <option value="">Selecciona un √°rea...</option>
                            <option value="finanzas">Finanzas</option>
                            <option value="operaciones">Operaciones</option>
                            <option value="ti">Tecnolog√≠a</option>
                            <option value="rrhh">Recursos Humanos</option>
                        </select>
                        <p class="form-help">Selecciona el √°rea organizacional del activo</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Activo</label>
                        <select class="form-select">
                            <option value="">Primero selecciona un √°rea...</option>
                        </select>
                        <p class="form-help">El activo incluir√° todas sus propiedades y metadatos autom√°ticamente</p>
                    </div>
                    <button class="btn btn-primary" style="width: 100%;">Vincular activos</button>
                </div>
            `,
            transformation: `
                <div class="node-card">
                    <div class="node-card-header">
                        <div class="node-card-title">
                            <div class="node-card-title-icon" style="background: #f3e5f5; color: #7b1fa2;">üîÑ</div>
                            <div class="node-card-title-text">
                                <h3>Nodo Transformaci√≥n</h3>
                                <p>Mapeo, filtrado y enriquecimiento de datos</p>
                            </div>
                        </div>
                        <div class="node-card-actions">
                            <button class="icon-button" onclick="editNode(this)">‚úèÔ∏è</button>
                            <button class="icon-button" onclick="deleteNode(this)">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tipo de operaci√≥n</label>
                        <select class="form-select" onchange="showTransformOperation(this.value)">
                            <option value="">Seleccionar...</option>
                            <option value="map">Mapeo de campos</option>
                            <option value="filter">Filtrado</option>
                            <option value="enrich">Enriquecimiento (c√°lculos)</option>
                            <option value="sort">Ordenar</option>
                            <option value="dedupe">Eliminar duplicados</option>
                            <option value="aggregate">Agregaci√≥n (sum, promedio, etc.)</option>
                        </select>
                    </div>
                    <div id="transformOperationArea">
                        <div class="form-group">
                            <label class="form-label">Propiedad de entrada</label>
                            <input type="text" class="form-input" placeholder="Selecciona o escribe el nombre del campo">
                        </div>
                        <div class="form-group">
                            <label class="form-label">F√≥rmula / Expresi√≥n</label>
                            <div class="formula-editor">
                                <button class="formula-editor-fullscreen" onclick="openFullscreenEditor()">‚õ∂ Pantalla completa</button>
                                <textarea class="form-textarea" placeholder="Ej: campo1 + campo2 * 0.16&#10;Ej: IF(monto > 1000, 'alto', 'bajo')&#10;Ej: SUM(valores)"></textarea>
                            </div>
                            <div class="operator-buttons">
                                <button class="operator-btn">+</button>
                                <button class="operator-btn">-</button>
                                <button class="operator-btn">*</button>
                                <button class="operator-btn">/</button>
                                <button class="operator-btn">SUM</button>
                                <button class="operator-btn">AVG</button>
                                <button class="operator-btn">MIN</button>
                                <button class="operator-btn">MAX</button>
                                <button class="operator-btn">STDEV</button>
                                <button class="operator-btn">IF</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Guardar resultado en</label>
                            <input type="text" class="form-input" placeholder="Nombre de la nueva propiedad">
                            <p class="form-help">Nombre de la variable donde se guardar√° el resultado</p>
                        </div>
                    </div>
                </div>
            `,
            prompt: `
                <div class="node-card">
                    <div class="node-card-header">
                        <div class="node-card-title">
                            <div class="node-card-title-icon" style="background: #e0f7fa; color: #00838f;">ü§ñ</div>
                            <div class="node-card-title-text">
                                <h3>Nodo Prompt LLM</h3>
                                <p>Procesa informaci√≥n con modelos de lenguaje</p>
                            </div>
                        </div>
                        <div class="node-card-actions">
                            <button class="icon-button" onclick="editNode(this)">‚úèÔ∏è</button>
                            <button class="icon-button" onclick="deleteNode(this)">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Seleccionar modelo</label>
                        <select class="form-select">
                            <option value="grok">Grok (xAI)</option>
                            <option value="gpt4">GPT-4 (OpenAI)</option>
                            <option value="gpt35">GPT-3.5 (OpenAI)</option>
                            <option value="gemini">Gemini (Google)</option>
                            <option value="claude">Claude (Anthropic)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Prompt</label>
                        <textarea class="form-textarea" placeholder="Escribe tu prompt aqu√≠...&#10;&#10;Puedes referenciar variables del contexto usando {{variable}}"></textarea>
                        <p class="form-help">Usa {{nombreVariable}} para insertar datos del contexto</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Formato de salida</label>
                        <select class="form-select">
                            <option value="json">JSON</option>
                            <option value="text">Texto plano</option>
                            <option value="table">Tabla de datos</option>
                            <option value="markdown">Markdown</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Guardar respuesta en</label>
                        <input type="text" class="form-input" placeholder="Nombre de la variable">
                        <p class="form-help">Variable donde se almacenar√° la respuesta del LLM</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Propiedades del contexto a enviar</label>
                        <div class="tree-selector">
                            <div class="tree-item">
                                <input type="checkbox" class="tree-item-checkbox" id="selectAll">
                                <label for="selectAll"><strong>Select All</strong></label>
                            </div>
                            <div class="tree-item" style="padding-left: 20px;">
                                <input type="checkbox" class="tree-item-checkbox">
                                <label>activo.nombre</label>
                            </div>
                            <div class="tree-item" style="padding-left: 20px;">
                                <input type="checkbox" class="tree-item-checkbox">
                                <label>activo.valor</label>
                            </div>
                            <div class="tree-item" style="padding-left: 20px;">
                                <input type="checkbox" class="tree-item-checkbox">
                                <label>proceso.descripcion</label>
                            </div>
                            <div class="tree-item" style="padding-left: 20px;">
                                <input type="checkbox" class="tree-item-checkbox">
                                <label>datos.columnas</label>
                            </div>
                        </div>
                        <p class="form-help">El sistema paginar√° autom√°ticamente si excede el tama√±o del contexto</p>
                    </div>
                </div>
            `,
            status: `
                <div class="node-card">
                    <div class="node-card-header">
                        <div class="node-card-title">
                            <div class="node-card-title-icon" style="background: #ede7f6; color: #5e35b1;">üîÑ</div>
                            <div class="node-card-title-text">
                                <h3>Nodo Cambio de Estado</h3>
                                <p>Actualiza el estado del proceso en ejecuci√≥n</p>
                            </div>
                        </div>
                        <div class="node-card-actions">
                            <button class="icon-button" onclick="editNode(this)">‚úèÔ∏è</button>
                            <button class="icon-button" onclick="deleteNode(this)">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Nuevo estado</label>
                        <select class="form-select">
                            <option value="pending">Pending - En espera</option>
                            <option value="running">Running - En ejecuci√≥n</option>
                            <option value="complete">Complete - Completado</option>
                            <option value="fail">Fail - Fallido</option>
                            <option value="post">Post - Post procesamiento</option>
                            <option value="canceled">Canceled - Cancelado</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Motivo del cambio</label>
                        <textarea class="form-textarea" placeholder="Describe el motivo del cambio de estado (ej: condici√≥n no cumplida, error en validaci√≥n, etc.)" style="min-height: 80px;"></textarea>
                        <p class="form-help">Este texto se registrar√° en el log de ejecuci√≥n</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Acci√≥n despu√©s del cambio</label>
                        <select class="form-select">
                            <option value="continue">Continuar flujo normal</option>
                            <option value="stop">Detener proceso</option>
                            <option value="notify">Enviar notificaci√≥n</option>
                            <option value="rollback">Revertir cambios</option>
                        </select>
                    </div>
                </div>
            `
        };

        // Connection state
        let isDraggingConnection = false;
        let currentLine = null;
        let sourcePoint = null;
        let connections = [];
        let nodeIdCounter = 0;

        // Node data storage for synchronization (moved here so it's available for addNode)
        const nodeDataStore = {};

        // Node dragging state
        let isDraggingNode = false;
        let draggedNode = null;
        let dragOffsetX = 0;
        let dragOffsetY = 0;

        // Sidebar drag state
        let draggedNodeType = null;

        // Add node to canvas - SIMPLIFIED VERSION
        function addNode(type, x = null, y = null) {
            const canvas = document.getElementById('canvas');
            const emptyState = document.getElementById('emptyState');

            // Hide empty state
            if (emptyState) {
                emptyState.style.display = 'none';
            }

            // Map types for compatibility
            const typeMap = {
                'prompt': 'llm',
                'status': 'state',
                'transformation': 'transform'
            };
            const mappedType = typeMap[type] || type;

            // Node configurations
            const nodeConfigs = {
                conditional: { icon: '‚ö°', color: '#e3f2fd', iconColor: '#1976d2', title: 'Nodo Condicional', desc: 'Define condiciones para ramificaci√≥n' },
                file: { icon: 'üìÅ', color: '#fff3e0', iconColor: '#ef6c00', title: 'Nodo Archivo', desc: 'Carga archivos XLS/CSV como datos' },
                asset: { icon: 'üè¶', color: '#e8f5e9', iconColor: '#2e7d32', title: 'Nodo Activo', desc: 'Vincula activos al proceso' },
                transform: { icon: 'üîÑ', color: '#f3e5f5', iconColor: '#7b1fa2', title: 'Nodo Transformaci√≥n', desc: 'Mapeo y filtrado de datos' },
                llm: { icon: 'ü§ñ', color: '#e0f7fa', iconColor: '#00838f', title: 'Nodo Prompt LLM', desc: 'Procesa con modelos de lenguaje' },
                state: { icon: 'üìä', color: '#ede7f6', iconColor: '#5e35b1', title: 'Nodo Estado', desc: 'Cambia el estado del proceso' },
                branching: { icon: 'üåø', color: '#c6f6d5', iconColor: '#22543d', title: 'Nodo Branching', desc: 'Flujos paralelos con estrategias' },
                math: { icon: 'üî¢', color: '#feebc8', iconColor: '#c05621', title: 'Nodo Matem√°tico', desc: 'C√°lculos y f√≥rmulas' },
                ml: { icon: 'üß†', color: '#b2f5ea', iconColor: '#234e52', title: 'Nodo ML', desc: 'Machine Learning' }
            };

            const config = nodeConfigs[mappedType];
            if (!config) {
                console.error('Unknown node type:', type, 'mapped to:', mappedType);
                return;
            }

            const nodeId = 'node-' + (++nodeIdCounter);

            // Initialize node data store
            if (typeof nodeDataStore !== 'undefined') {
                nodeDataStore[nodeId] = {
                    type: mappedType,
                    label: config.title,
                    config: {}
                };
            }

            // Create node element
            const nodeEl = document.createElement('div');
            nodeEl.className = 'node-card';
            nodeEl.setAttribute('data-node-id', nodeId);
            nodeEl.setAttribute('data-node-type', mappedType);

            // Set position
            if (x !== null && y !== null) {
                nodeEl.style.left = x + 'px';
                nodeEl.style.top = y + 'px';
            } else {
                const defaultX = 100 + (nodeIdCounter * 30);
                const defaultY = 100 + (nodeIdCounter * 30);
                nodeEl.style.left = defaultX + 'px';
                nodeEl.style.top = defaultY + 'px';
            }

            // Generate simplified content based on type
            let customContent = '';

            if (mappedType === 'file') {
                if (typeof nodeDataStore !== 'undefined') nodeDataStore[nodeId].config = { fileName: null, columns: [], rows: 0 };
                customContent = `
                    <div class="form-group">
                        <div id="fileStatus-${nodeId}" class="node-status-box" style="padding: 16px; background: #fafafa; border: 2px dashed #e0e0e0; border-radius: 8px; text-align: center; cursor: pointer;" onclick="openNodeConfig(this.closest('.node-card'))">
                            <div style="font-size: 28px; margin-bottom: 6px;">üìÅ</div>
                            <div style="font-weight: 500; color: #757575;">Sin archivo</div>
                            <div style="font-size: 11px; color: #10b981; margin-top: 4px;">Click para configurar</div>
                        </div>
                    </div>
                `;
            } else if (mappedType === 'asset') {
                if (typeof nodeDataStore !== 'undefined') nodeDataStore[nodeId].config = { area: null, assetId: null, assetName: null };
                customContent = `
                    <div class="form-group">
                        <label class="form-label">√Årea organizacional</label>
                        <select class="form-select" id="assetAreaSimple-${nodeId}" onchange="updateNodeAssetArea('${nodeId}', this.value)">
                            <option value="">Selecciona un √°rea...</option>
                            <option value="ti">üñ•Ô∏è TI (Tecnolog√≠a)</option>
                            <option value="finanzas">üí∞ Finanzas</option>
                            <option value="operaciones">‚öôÔ∏è Operaciones</option>
                            <option value="rrhh">üë• Recursos Humanos</option>
                            <option value="legal">‚öñÔ∏è Legal y Compliance</option>
                            <option value="marketing">üì¢ Marketing</option>
                        </select>
                    </div>
                    <div id="assetTreeContainer-${nodeId}" style="display: none; margin-top: 8px;">
                        <label class="form-label">√Årbol de activos</label>
                        <div id="assetTree-${nodeId}" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; max-height: 180px; overflow-y: auto;">
                        </div>
                    </div>
                    <div id="assetSelected-${nodeId}" style="display: none; margin-top: 10px; padding: 10px; background: #f0fdf4; border: 1px solid #86efac; border-radius: 6px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 20px;" id="assetSelectedIcon-${nodeId}">üè¢</span>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 13px; color: #1a1a1a;" id="assetSelectedName-${nodeId}">-</div>
                                <div style="font-size: 11px; color: #059669;" id="assetSelectedArea-${nodeId}">-</div>
                            </div>
                            <span id="assetSelectedBadge-${nodeId}" style="padding: 2px 8px; background: #fee2e2; color: #991b1b; border-radius: 10px; font-size: 10px; font-weight: 600;">Alta</span>
                        </div>
                    </div>
                `;
            } else if (mappedType === 'llm') {
                if (typeof nodeDataStore !== 'undefined') nodeDataStore[nodeId].config = { model: 'gpt-4-turbo', prompt: '', temperature: 0.7 };
                customContent = `
                    <div class="form-group">
                        <label class="form-label">Modelo</label>
                        <select class="form-select" id="llmModelSimple-${nodeId}" onchange="updateNodeLLMModel('${nodeId}', this.value)">
                            <option value="gpt-4-turbo">üü¢ GPT-4 Turbo</option>
                            <option value="claude-3-opus">üü£ Claude 3 Opus</option>
                            <option value="gemini-pro">üîµ Gemini Pro</option>
                        </select>
                    </div>
                    <div id="llmSummary-${nodeId}" style="padding: 10px; background: #f8fafc; border-radius: 6px; margin-top: 8px;">
                        <div style="display: flex; justify-content: space-between; font-size: 12px;">
                            <span style="color: #757575;">Entradas: <strong id="llmInputs-${nodeId}">0</strong></span>
                            <span style="color: #757575;">Tokens: <strong id="llmTokens-${nodeId}">~0</strong></span>
                        </div>
                        <div style="font-size: 11px; color: #10b981; margin-top: 6px; cursor: pointer;" onclick="openNodeConfig(this.closest('.node-card'))">‚öôÔ∏è Configurar prompt...</div>
                    </div>
                `;
            } else if (mappedType === 'conditional') {
                if (typeof nodeDataStore !== 'undefined') nodeDataStore[nodeId].config = { variable: '', operator: '==', value: '' };
                customContent = `
                    <div class="form-group">
                        <label class="form-label">Condici√≥n</label>
                        <div id="condPreviewSimple-${nodeId}" style="padding: 10px; background: #fefce8; border: 1px solid #fde047; border-radius: 6px; font-family: monospace; font-size: 11px;">
                            <span style="color: #a16207;">if</span> (<span style="color: #757575;">sin configurar</span>)
                        </div>
                    </div>
                    <div style="display: flex; gap: 6px; margin-top: 8px;">
                        <div style="flex: 1; padding: 6px; background: #fee2e2; border-radius: 4px; text-align: center; font-size: 11px;">
                            <div style="color: #991b1b;">‚úì True</div>
                        </div>
                        <div style="flex: 1; padding: 6px; background: #d1fae5; border-radius: 4px; text-align: center; font-size: 11px;">
                            <div style="color: #065f46;">‚úó False</div>
                        </div>
                    </div>
                    <div style="font-size: 11px; color: #10b981; margin-top: 8px; text-align: center; cursor: pointer;" onclick="openNodeConfig(this.closest('.node-card'))">‚öôÔ∏è Editar condici√≥n...</div>
                `;
            } else if (mappedType === 'state') {
                if (typeof nodeDataStore !== 'undefined') nodeDataStore[nodeId].config = { stateType: 'success', stateName: 'Estado', notify: false };
                customContent = `
                    <div class="form-group">
                        <label class="form-label">Tipo de estado</label>
                        <select class="form-select" id="stateTypeSimple-${nodeId}" onchange="updateNodeStateType('${nodeId}', this.value)">
                            <option value="success">‚úÖ OK</option>
                            <option value="alert">üö® Alerta</option>
                            <option value="warning">‚ö†Ô∏è Advertencia</option>
                            <option value="pending">‚è≥ Pendiente</option>
                        </select>
                    </div>
                    <div id="stateSummary-${nodeId}" style="padding: 8px; background: #d1fae5; border-radius: 6px; margin-top: 8px; text-align: center;">
                        <span style="font-size: 20px;">‚úÖ</span>
                        <div style="font-size: 12px; font-weight: 500; color: #059669;" id="stateLabel-${nodeId}">Estado</div>
                    </div>
                    <div style="font-size: 11px; color: #10b981; margin-top: 8px; text-align: center; cursor: pointer;" onclick="openNodeConfig(this.closest('.node-card'))">‚öôÔ∏è Configurar acciones...</div>
                `;
            } else if (mappedType === 'transform') {
                if (typeof nodeDataStore !== 'undefined') nodeDataStore[nodeId].config = { transformType: 'map', mappings: [] };
                customContent = `
                    <div class="form-group">
                        <label class="form-label">Operaci√≥n</label>
                        <select class="form-select" id="transformTypeSimple-${nodeId}" onchange="updateNodeTransformType('${nodeId}', this.value)">
                            <option value="map">üîÑ Mapear</option>
                            <option value="filter">üîç Filtrar</option>
                            <option value="aggregate">üìä Agregar</option>
                        </select>
                    </div>
                    <div id="transformSummary-${nodeId}" style="padding: 8px; background: #f8fafc; border-radius: 6px; margin-top: 8px; font-size: 12px; color: #757575;">
                        0 transformaciones configuradas
                    </div>
                    <div style="font-size: 11px; color: #10b981; margin-top: 8px; text-align: center; cursor: pointer;" onclick="openNodeConfig(this.closest('.node-card'))">‚öôÔ∏è Configurar...</div>
                `;
            } else if (mappedType === 'branching') {
                if (typeof nodeDataStore !== 'undefined') nodeDataStore[nodeId].config = { branchCount: 2, strategy: 'parallel', branches: ['Rama 1', 'Rama 2'] };
                customContent = `
                    <div class="form-group">
                        <label class="form-label">N√∫mero de ramas</label>
                        <input type="number" class="form-input" id="branchCount-${nodeId}" value="2" min="2" max="10" onchange="updateNodeBranchCount('${nodeId}', this.value)" style="text-align: center;">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Estrategia</label>
                        <select class="form-select" id="branchStrategy-${nodeId}" onchange="updateNodeBranchStrategy('${nodeId}', this.value)">
                            <option value="parallel">‚ö° Paralela</option>
                            <option value="sequential">‚û°Ô∏è Secuencial</option>
                            <option value="priority">üéØ Por Prioridad</option>
                            <option value="race">üèÅ Race</option>
                        </select>
                    </div>
                    <div id="branchPreview-${nodeId}" style="display: flex; gap: 4px; flex-wrap: wrap; margin-top: 8px;">
                        <span style="padding: 4px 8px; background: #c6f6d5; border-radius: 4px; font-size: 11px;">Rama 1</span>
                        <span style="padding: 4px 8px; background: #c6f6d5; border-radius: 4px; font-size: 11px;">Rama 2</span>
                    </div>
                    <div style="font-size: 11px; color: #10b981; margin-top: 8px; text-align: center; cursor: pointer;" onclick="openNodeConfig(this.closest('.node-card'))">‚öôÔ∏è Configurar ramas...</div>
                `;
            } else if (mappedType === 'math') {
                if (typeof nodeDataStore !== 'undefined') nodeDataStore[nodeId].config = { formula: '', outputField: 'resultado' };
                customContent = `
                    <div class="form-group">
                        <label class="form-label">F√≥rmula</label>
                        <input type="text" class="form-input" id="mathFormula-${nodeId}" placeholder="(impacto * probabilidad) / 100" style="font-family: monospace; font-size: 12px;" onchange="updateNodeMathFormula('${nodeId}', this.value)">
                    </div>
                    <div style="display: flex; gap: 4px; flex-wrap: wrap; margin-top: 8px;">
                        <button class="operator-btn-mini" onclick="insertMathOp('${nodeId}', '+')">+</button>
                        <button class="operator-btn-mini" onclick="insertMathOp('${nodeId}', '-')">‚àí</button>
                        <button class="operator-btn-mini" onclick="insertMathOp('${nodeId}', '*')">√ó</button>
                        <button class="operator-btn-mini" onclick="insertMathOp('${nodeId}', '/')">√∑</button>
                        <button class="operator-btn-mini" onclick="insertMathOp('${nodeId}', '^')">^</button>
                        <button class="operator-btn-mini" onclick="insertMathOp('${nodeId}', 'sqrt')">‚àö</button>
                    </div>
                    <div class="form-group" style="margin-top: 10px;">
                        <label class="form-label">Campo de salida</label>
                        <input type="text" class="form-input" id="mathOutput-${nodeId}" placeholder="resultado" style="font-size: 12px;">
                    </div>
                    <div style="font-size: 11px; color: #10b981; margin-top: 8px; text-align: center; cursor: pointer;" onclick="openNodeConfig(this.closest('.node-card'))">‚öôÔ∏è M√°s opciones...</div>
                `;
            } else if (mappedType === 'ml') {
                if (typeof nodeDataStore !== 'undefined') nodeDataStore[nodeId].config = { model: '', confidence: 0.85 };
                customContent = `
                    <div class="form-group">
                        <label class="form-label">Modelo ML</label>
                        <select class="form-select" id="mlModel-${nodeId}" onchange="updateNodeMLModel('${nodeId}', this.value)">
                            <option value="">Seleccionar modelo...</option>
                            <option value="risk_predictor">üéØ Predictor de Riesgos</option>
                            <option value="anomaly_detector">üîç Detector de Anomal√≠as</option>
                            <option value="classifier">üìä Clasificador de Incidentes</option>
                            <option value="regression">üìà Regresi√≥n</option>
                            <option value="clustering">üé≤ Clustering</option>
                        </select>
                    </div>
                    <div id="mlModelInfo-${nodeId}" style="display: none; padding: 8px; background: #e6fffa; border-radius: 6px; margin-top: 8px; font-size: 11px; color: #234e52;"></div>
                    <div class="form-group" style="margin-top: 10px;">
                        <label class="form-label">Confianza m√≠nima</label>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="range" id="mlConfidence-${nodeId}" min="0" max="100" value="85" style="flex: 1;" onchange="document.getElementById('mlConfVal-${nodeId}').textContent = this.value + '%'">
                            <span id="mlConfVal-${nodeId}" style="font-size: 12px; font-weight: 600; color: #234e52;">85%</span>
                        </div>
                    </div>
                    <div style="font-size: 11px; color: #10b981; margin-top: 8px; text-align: center; cursor: pointer;" onclick="openNodeConfig(this.closest('.node-card'))">‚öôÔ∏è Configurar modelo...</div>
                `;
            }

            // Build full node HTML
            nodeEl.innerHTML = `
                <div class="node-card-header">
                    <div class="node-card-title">
                        <div class="node-card-title-icon" style="background: ${config.color}; color: ${config.iconColor};">${config.icon}</div>
                        <div class="node-card-title-text">
                            <h3>${config.title}</h3>
                            <p>${config.desc}</p>
                        </div>
                    </div>
                    <div class="node-card-actions">
                        <button class="icon-button" onclick="openNodeConfig(this.closest('.node-card'))">‚úèÔ∏è</button>
                        <button class="icon-button" onclick="deleteNode(this)">üóëÔ∏è</button>
                    </div>
                </div>
                ${customContent}
            `;

            // Add connection points
            const inputPoint = document.createElement('div');
            inputPoint.className = 'connection-point input';
            inputPoint.setAttribute('data-type', 'input');
            inputPoint.setAttribute('data-node-id', nodeId);

            const outputPoint = document.createElement('div');
            outputPoint.className = 'connection-point output';
            outputPoint.setAttribute('data-type', 'output');
            outputPoint.setAttribute('data-node-id', nodeId);

            nodeEl.appendChild(inputPoint);
            nodeEl.appendChild(outputPoint);

            // Add event listeners for connection points
            outputPoint.addEventListener('mousedown', startConnection);
            inputPoint.addEventListener('mouseenter', highlightConnectionPoint);
            inputPoint.addEventListener('mouseleave', unhighlightConnectionPoint);

            // Add event listeners for node dragging
            const header = nodeEl.querySelector('.node-card-header');
            header.addEventListener('mousedown', startNodeDrag);

            canvas.appendChild(nodeEl);

            // Update connections after adding
            setTimeout(updateAllConnections, 10);

            return nodeEl;
        }

        // Start dragging node from sidebar
        function initSidebarDrag() {
            const nodeItems = document.querySelectorAll('.node-item');

            nodeItems.forEach((item) => {
                item.setAttribute('draggable', 'true');

                // Extract node type from onclick attribute
                const onclickAttr = item.getAttribute('onclick');
                if (onclickAttr) {
                    const match = onclickAttr.match(/addNode\('(.+?)'\)/);
                    if (match) {
                        item.setAttribute('data-node-type', match[1]);
                    }
                }

                item.addEventListener('dragstart', (e) => {
                    const type = e.currentTarget.getAttribute('data-node-type');
                    if (type) {
                        draggedNodeType = type;
                        e.currentTarget.classList.add('dragging');
                        e.dataTransfer.effectAllowed = 'copy';
                        e.dataTransfer.setData('text/plain', type);
                    }
                });

                item.addEventListener('dragend', (e) => {
                    e.currentTarget.classList.remove('dragging');
                    draggedNodeType = null;
                });
            });
        }

        // Setup canvas drop zone
        function initCanvasDropZone() {
            const canvas = document.getElementById('canvas');
            const canvasArea = document.querySelector('.canvas-area');

            // Add dragover to both canvas and canvas-area
            const handleDragOver = (e) => {
                e.preventDefault();
                e.stopPropagation();
                e.dataTransfer.dropEffect = 'copy';
                // Add visual feedback
                canvas.classList.add('drag-over');
                if (canvasArea) canvasArea.classList.add('drag-over');
            };

            const handleDragLeave = (e) => {
                // Only remove if leaving the canvas area entirely
                const rect = canvasArea ? canvasArea.getBoundingClientRect() : canvas.getBoundingClientRect();
                if (e.clientX < rect.left || e.clientX > rect.right || e.clientY < rect.top || e.clientY > rect.bottom) {
                    canvas.classList.remove('drag-over');
                    if (canvasArea) canvasArea.classList.remove('drag-over');
                }
            };

            const handleDrop = (e) => {
                e.preventDefault();
                e.stopPropagation();

                // Remove visual feedback
                canvas.classList.remove('drag-over');
                if (canvasArea) canvasArea.classList.remove('drag-over');

                if (draggedNodeType) {
                    const canvasRect = canvas.getBoundingClientRect();
                    // Account for scroll position
                    const scrollLeft = canvasArea ? canvasArea.scrollLeft : 0;
                    const scrollTop = canvasArea ? canvasArea.scrollTop : 0;

                    const x = e.clientX - canvasRect.left + scrollLeft;
                    const y = e.clientY - canvasRect.top + scrollTop;

                    addNode(draggedNodeType, x, y);
                    draggedNodeType = null;
                }
            };

            canvas.addEventListener('dragover', handleDragOver);
            canvas.addEventListener('dragleave', handleDragLeave);
            canvas.addEventListener('drop', handleDrop);

            // Also handle on canvas-area in case drop happens there
            if (canvasArea) {
                canvasArea.addEventListener('dragover', handleDragOver);
                canvasArea.addEventListener('dragleave', handleDragLeave);
                canvasArea.addEventListener('drop', handleDrop);
            }
        }

        // Start dragging existing node
        function startNodeDrag(e) {
            // Prevent if clicking on buttons
            if (e.target.closest('.icon-button') || e.target.closest('.btn')) {
                return;
            }

            // Prevent if dragging connection
            if (e.target.classList.contains('connection-point')) {
                return;
            }

            e.preventDefault();
            e.stopPropagation();

            isDraggingNode = true;
            draggedNode = e.currentTarget.closest('.node-card');
            draggedNode.classList.add('dragging');

            const canvasArea = document.querySelector('.canvas-area');

            // Calculate offset relative to node's current position
            const nodeX = parseInt(draggedNode.style.left) || 0;
            const nodeY = parseInt(draggedNode.style.top) || 0;

            const rect = draggedNode.getBoundingClientRect();
            const canvasRect = document.getElementById('canvas').getBoundingClientRect();

            dragOffsetX = e.clientX - canvasRect.left - nodeX + canvasArea.scrollLeft;
            dragOffsetY = e.clientY - canvasRect.top - nodeY + canvasArea.scrollTop;

            document.addEventListener('mousemove', dragNode);
            document.addEventListener('mouseup', endNodeDrag);
        }

        // Drag node
        function dragNode(e) {
            if (!isDraggingNode || !draggedNode) return;

            const canvasRect = document.getElementById('canvas').getBoundingClientRect();
            const canvasArea = document.querySelector('.canvas-area');

            let x = e.clientX - canvasRect.left - dragOffsetX + canvasArea.scrollLeft;
            let y = e.clientY - canvasRect.top - dragOffsetY + canvasArea.scrollTop;

            // Keep within canvas bounds
            x = Math.max(0, Math.min(x, 2000 - draggedNode.offsetWidth));
            y = Math.max(0, Math.min(y, 2000 - draggedNode.offsetHeight));

            draggedNode.style.left = x + 'px';
            draggedNode.style.top = y + 'px';

            // Update connection lines
            updateAllConnections();
        }

        // End dragging node
        function endNodeDrag(e) {
            if (!isDraggingNode) return;

            isDraggingNode = false;
            if (draggedNode) {
                draggedNode.classList.remove('dragging');
                draggedNode = null;
            }

            document.removeEventListener('mousemove', dragNode);
            document.removeEventListener('mouseup', endNodeDrag);
        }

        // Start dragging connection
        function startConnection(e) {
            // Prevent if already dragging a node
            if (isDraggingNode) {
                return;
            }

            e.preventDefault();
            e.stopPropagation();

            isDraggingConnection = true;
            sourcePoint = e.target;
            sourcePoint.classList.add('active');

            const svg = document.getElementById('connectionsSvg');
            currentLine = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            currentLine.setAttribute('class', 'connection-line dragging');
            currentLine.setAttribute('marker-end', 'url(#arrowhead)');
            svg.appendChild(currentLine);

            document.addEventListener('mousemove', dragConnection);
            document.addEventListener('mouseup', endConnection);

            updateConnectionLine(e);
        }

        // Drag connection line
        function dragConnection(e) {
            if (!isDraggingConnection) return;
            updateConnectionLine(e);
            checkProximityToNodes(e);
        }

        // Update connection line path
        function updateConnectionLine(e) {
            if (!currentLine || !sourcePoint) return;

            const sourceRect = sourcePoint.getBoundingClientRect();
            const canvasRect = document.getElementById('canvas').getBoundingClientRect();

            const startX = sourceRect.left + sourceRect.width / 2 - canvasRect.left;
            const startY = sourceRect.top + sourceRect.height / 2 - canvasRect.top;
            const endX = e.clientX - canvasRect.left;
            const endY = e.clientY - canvasRect.top;

            // Create smooth bezier curve
            const controlPointOffset = Math.abs(endX - startX) / 2;
            const path = `M ${startX} ${startY} C ${startX + controlPointOffset} ${startY}, ${endX - controlPointOffset} ${endY}, ${endX} ${endY}`;

            currentLine.setAttribute('d', path);
        }

        // Check proximity to other nodes
        function checkProximityToNodes(e) {
            const allInputPoints = document.querySelectorAll('.connection-point.input');
            let nearestPoint = null;
            let minDistance = 50; // pixels

            allInputPoints.forEach(point => {
                if (point.getAttribute('data-node-id') === sourcePoint.getAttribute('data-node-id')) {
                    return; // Skip same node
                }

                const rect = point.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;

                const distance = Math.sqrt(
                    Math.pow(e.clientX - centerX, 2) +
                    Math.pow(e.clientY - centerY, 2)
                );

                if (distance < minDistance) {
                    minDistance = distance;
                    nearestPoint = point;
                }
            });

            // Highlight nearest point
            document.querySelectorAll('.connection-point.highlight').forEach(p => {
                p.classList.remove('highlight');
            });

            if (nearestPoint) {
                nearestPoint.classList.add('highlight');
            }
        }

        // End connection drag
        function endConnection(e) {
            if (!isDraggingConnection) return;

            isDraggingConnection = false;
            sourcePoint.classList.remove('active');

            document.removeEventListener('mousemove', dragConnection);
            document.removeEventListener('mouseup', endConnection);

            // Check if we're near a valid input point
            const highlightedPoint = document.querySelector('.connection-point.highlight');

            if (highlightedPoint) {
                // Create permanent connection
                createConnection(sourcePoint, highlightedPoint);
                highlightedPoint.classList.remove('highlight');
            } else {
                // Remove temporary line
                if (currentLine) {
                    currentLine.remove();
                }
            }

            currentLine = null;
            sourcePoint = null;
        }

        // Create permanent connection
        function createConnection(fromPoint, toPoint) {
            const svg = document.getElementById('connectionsSvg');

            // Remove temporary dragging line
            if (currentLine) {
                currentLine.remove();
            }

            // Create permanent line
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            line.setAttribute('class', 'connection-line');
            line.setAttribute('marker-end', 'url(#arrowhead)');
            line.setAttribute('data-from', fromPoint.getAttribute('data-node-id'));
            line.setAttribute('data-to', toPoint.getAttribute('data-node-id'));

            svg.appendChild(line);

            // Store connection
            connections.push({
                line: line,
                from: fromPoint,
                to: toPoint
            });

            // Update line position
            updateAllConnections();

            console.log('Connection created:', fromPoint.getAttribute('data-node-id'), '->', toPoint.getAttribute('data-node-id'));
        }

        // Update all connection lines
        function updateAllConnections() {
            connections.forEach(conn => {
                const fromRect = conn.from.getBoundingClientRect();
                const toRect = conn.to.getBoundingClientRect();
                const canvasRect = document.getElementById('canvas').getBoundingClientRect();

                const startX = fromRect.left + fromRect.width / 2 - canvasRect.left;
                const startY = fromRect.top + fromRect.height / 2 - canvasRect.top;
                const endX = toRect.left + toRect.width / 2 - canvasRect.left;
                const endY = toRect.top + toRect.height / 2 - canvasRect.top;

                const controlPointOffset = Math.abs(endX - startX) / 2;
                const path = `M ${startX} ${startY} C ${startX + controlPointOffset} ${startY}, ${endX - controlPointOffset} ${endY}, ${endX} ${endY}`;

                conn.line.setAttribute('d', path);
            });
        }

        // Highlight connection point
        function highlightConnectionPoint(e) {
            if (isDraggingConnection && sourcePoint) {
                e.target.classList.add('highlight');
            }
        }

        // Remove highlight from connection point
        function unhighlightConnectionPoint(e) {
            e.target.classList.remove('highlight');
        }

        // Update connections when canvas is scrolled or resized
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(updateAllConnections, 100);
        });

        document.querySelector('.canvas-area').addEventListener('scroll', updateAllConnections);

        // Delete node
        function deleteNode(button) {
            if (confirm('¬øEst√°s seguro de eliminar este nodo?')) {
                const nodeCard = button.closest('.node-card');
                const nodeId = nodeCard.getAttribute('data-node-id');

                // Remove connections associated with this node
                connections = connections.filter(conn => {
                    const fromId = conn.from.getAttribute('data-node-id');
                    const toId = conn.to.getAttribute('data-node-id');

                    if (fromId === nodeId || toId === nodeId) {
                        conn.line.remove();
                        return false;
                    }
                    return true;
                });

                // Remove node
                nodeCard.remove();

                // Show empty state if no nodes left
                const canvas = document.getElementById('canvas');
                const nodes = canvas.querySelectorAll('.node-card');
                if (nodes.length === 0) {
                    document.getElementById('emptyState').style.display = 'block';
                }
            }
        }

        // Show/hide right sidebar
        function showRightSidebar() {
            const rightSidebar = document.getElementById('rightSidebar');
            rightSidebar.classList.remove('hidden');
        }

        function closeRightSidebar() {
            const rightSidebar = document.getElementById('rightSidebar');
            rightSidebar.classList.add('hidden');
        }

        // Show preview panel
        function showPreview() {
            const rightSidebar = document.getElementById('rightSidebar');
            const previewBody = document.getElementById('previewBody');

            rightSidebar.classList.remove('hidden');

            // Sample data for preview
            previewBody.innerHTML = `
                <div class="preview-body">
                    <table class="preview-table">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Email</th>
                                <th>Position</th>
                                <th>Status</th>
                                <th>Rol</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Alice Johnson Smith</td>
                                <td>alice@sns.com</td>
                                <td>Financial Analyst</td>
                                <td><span class="status-badge active">Activo</span></td>
                                <td>Gerente de riesgos</td>
                            </tr>
                            <tr>
                                <td>Bob Miller Scott</td>
                                <td>bob@sns.com</td>
                                <td>Software Engineer</td>
                                <td><span class="status-badge pending">Pendiente</span></td>
                                <td>Especialista en seguridad</td>
                            </tr>
                            <tr>
                                <td>Charlie Brown Davis</td>
                                <td>charlie@sns.com</td>
                                <td>Marketing Specialist</td>
                                <td><span class="status-badge fail">Inactivo</span></td>
                                <td>Consultor estrat√©gico</td>
                            </tr>
                            <tr>
                                <td>Diana White Thompson</td>
                                <td>diana@sns.com</td>
                                <td>Product Designer</td>
                                <td><span class="status-badge active">Activo</span></td>
                                <td>Oficial de Cumplimiento</td>
                            </tr>
                            <tr>
                                <td>Ethan Miller Clark</td>
                                <td>ethan@sns.com</td>
                                <td>Data Scientist</td>
                                <td><span class="status-badge pending">Pendiente</span></td>
                                <td>Desarrollador de software</td>
                            </tr>
                            <tr>
                                <td>Fiona Green Taylor</td>
                                <td>fiona@sns.com</td>
                                <td>HR Coordinator</td>
                                <td><span class="status-badge fail">Inactivo</span></td>
                                <td>Desarrollador de software</td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="form-group" style="margin-top: 20px;">
                        <label class="form-label">Columna clasificadora</label>
                        <select class="form-select">
                            <option value="">Selecciona una opci√≥n</option>
                            <option value="col1">Nombre</option>
                            <option value="col2">Email</option>
                            <option value="col3">Position</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Selecciona las columnas para analizar</label>
                        <select class="form-select" multiple style="min-height: 120px;">
                            <option value="col1" selected>Nombre</option>
                            <option value="col2" selected>Email</option>
                            <option value="col3" selected>Position</option>
                            <option value="col4">Status</option>
                            <option value="col5">Rol</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" style="width: 100%;">Guardar</button>
                </div>
            `;
        }


        // Toggle sidebar
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            sidebar.style.display = sidebar.style.display === 'none' ? 'flex' : 'none';
        }

        // Save process
        function saveProcess() {
            alert('Proceso guardado exitosamente!\\n\\nSe han validado:\\n‚Ä¢ Conexiones entre nodos\\n‚Ä¢ Configuraci√≥n de cada nodo\\n‚Ä¢ Flujo l√≥gico del proceso');
        }

        // Open fullscreen editor
        function openFullscreenEditor() {
            alert('Editor de f√≥rmulas en pantalla completa\\n(Por implementar con Monaco Editor)');
        }

        // Load assets based on area
        function loadAssets(area) {
            const assetSelect = event.target.closest('.node-card').querySelector('.form-group:nth-child(3) select');

            const assets = {
                'finanzas': [
                    'Sistema ERP Financiero',
                    'Base de datos contable',
                    'Servidor de reportes'
                ],
                'operaciones': [
                    'Sistema de gesti√≥n operativa',
                    'Almac√©n de datos',
                    'Plataforma de log√≠stica'
                ],
                'ti': [
                    'Infraestructura de servidores',
                    'Red corporativa',
                    'Sistema de respaldos'
                ],
                'rrhh': [
                    'Sistema de n√≥mina',
                    'Base de datos de empleados',
                    'Plataforma de capacitaci√≥n'
                ]
            };

            if (area && assets[area]) {
                assetSelect.innerHTML = '<option value="">Selecciona un activo...</option>' +
                    assets[area].map(asset => `<option value="${asset}">${asset}</option>`).join('');
            } else {
                assetSelect.innerHTML = '<option value="">Primero selecciona un √°rea...</option>';
            }
        }

        // Initialize everything when DOM is ready
        window.addEventListener('load', function() {
            // Add node from dropdown
            const nodeTypeSelect = document.getElementById('nodeTypeSelect');
            if (nodeTypeSelect) {
                nodeTypeSelect.addEventListener('change', function(e) {
                    if (e.target.value) {
                        addNode(e.target.value);
                        e.target.value = '';
                    }
                });
            }

            // Initialize sidebar drag
            initSidebarDrag();

            // Initialize canvas drop zone
            initCanvasDropZone();

            // Load demo nodes for testing
            loadDemoNodes();
        });

        // =====================================================
        // DEMO DATA - Load sample nodes and connections
        // =====================================================
        function loadDemoNodes() {
            // Create demo nodes using the correct type names
            const demoNodes = [
                { type: 'file', x: 80, y: 100 },
                { type: 'asset', x: 80, y: 380 },
                { type: 'prompt', x: 450, y: 220 },
                { type: 'conditional', x: 820, y: 220 },
                { type: 'status', x: 1100, y: 100 },
                { type: 'status', x: 1100, y: 340 }
            ];

            // Add nodes to canvas using the main addNode function
            demoNodes.forEach((node, index) => {
                setTimeout(() => {
                    addNode(node.type, node.x, node.y);
                }, index * 100);
            });

            // Create connections after nodes are loaded
            setTimeout(() => {
                createDemoConnections();
            }, 800);
        }

        // Add a demo node with custom label - SIMPLIFIED VERSION
        function addDemoNode(type, x, y, customLabel, index) {
            const template = nodeTemplates[type];
            if (!template) return;

            const nodeId = 'demo-node-' + index;
            const canvas = document.getElementById('canvas');

            // Initialize node data store
            nodeDataStore[nodeId] = {
                type: type,
                label: customLabel,
                config: {}
            };

            const nodeEl = document.createElement('div');
            nodeEl.className = 'node-card';
            nodeEl.setAttribute('data-node-id', nodeId);
            nodeEl.setAttribute('data-node-type', type);
            nodeEl.style.left = x + 'px';
            nodeEl.style.top = y + 'px';

            // SIMPLIFIED content - only basic info, details go to sidebar
            let customContent = '';

            if (type === 'file') {
                nodeDataStore[nodeId].config = { fileName: null, columns: [], rows: 0 };
                customContent = `
                    <div class="form-group">
                        <div id="fileStatus-${nodeId}" class="node-status-box" style="padding: 16px; background: #fafafa; border: 2px dashed #e0e0e0; border-radius: 8px; text-align: center; cursor: pointer;" onclick="openNodeConfig(this.closest('.node-card'))">
                            <div style="font-size: 28px; margin-bottom: 6px;">üìÅ</div>
                            <div style="font-weight: 500; color: #757575;">Sin archivo</div>
                            <div style="font-size: 11px; color: #10b981; margin-top: 4px;">Click para configurar</div>
                        </div>
                    </div>
                `;
            } else if (type === 'asset') {
                nodeDataStore[nodeId].config = { area: null, assetId: null, assetName: null };
                customContent = `
                    <div class="form-group">
                        <label class="form-label">√Årea</label>
                        <select class="form-select" id="assetAreaSimple-${nodeId}" onchange="updateNodeAssetArea('${nodeId}', this.value)">
                            <option value="">Selecciona...</option>
                            <option value="finanzas">üí∞ Finanzas</option>
                            <option value="operaciones">‚öôÔ∏è Operaciones</option>
                            <option value="ti">üíª TI</option>
                            <option value="rrhh">üë• RRHH</option>
                            <option value="legal">‚öñÔ∏è Legal</option>
                        </select>
                    </div>
                    <div class="form-group" id="assetSelectSimple-${nodeId}" style="display: none;">
                        <label class="form-label">Activo</label>
                        <select class="form-select" id="assetListSimple-${nodeId}" onchange="updateNodeAsset('${nodeId}', this.value)">
                            <option value="">Selecciona...</option>
                        </select>
                    </div>
                    <div id="assetSummary-${nodeId}" style="display: none; padding: 8px; background: #f0fdf4; border-radius: 6px; margin-top: 8px;">
                    </div>
                `;
            } else if (type === 'llm') {
                nodeDataStore[nodeId].config = { model: 'gpt-4-turbo', prompt: '', temperature: 0.7 };
                customContent = `
                    <div class="form-group">
                        <label class="form-label">Modelo</label>
                        <select class="form-select" id="llmModelSimple-${nodeId}" onchange="updateNodeLLMModel('${nodeId}', this.value)">
                            <option value="gpt-4-turbo">üü¢ GPT-4 Turbo</option>
                            <option value="claude-3-opus">üü£ Claude 3 Opus</option>
                            <option value="gemini-pro">üîµ Gemini Pro</option>
                        </select>
                    </div>
                    <div id="llmSummary-${nodeId}" style="padding: 10px; background: #f8fafc; border-radius: 6px; margin-top: 8px;">
                        <div style="display: flex; justify-content: space-between; font-size: 12px;">
                            <span style="color: #757575;">Entradas: <strong id="llmInputs-${nodeId}">0</strong></span>
                            <span style="color: #757575;">Tokens: <strong id="llmTokens-${nodeId}">~0</strong></span>
                        </div>
                        <div style="font-size: 11px; color: #10b981; margin-top: 6px; cursor: pointer;" onclick="openNodeConfig(this.closest('.node-card'))">‚öôÔ∏è Configurar prompt...</div>
                    </div>
                `;
            } else if (type === 'conditional') {
                nodeDataStore[nodeId].config = { variable: 'respuesta_llm.severidad', operator: '==', value: 'alto' };
                customContent = `
                    <div class="form-group">
                        <label class="form-label">Condici√≥n</label>
                        <div id="condPreviewSimple-${nodeId}" style="padding: 10px; background: #fefce8; border: 1px solid #fde047; border-radius: 6px; font-family: monospace; font-size: 11px;">
                            <span style="color: #a16207;">if</span> (severidad == <span style="color: #15803d;">"alto"</span>)
                        </div>
                    </div>
                    <div style="display: flex; gap: 6px; margin-top: 8px;">
                        <div style="flex: 1; padding: 6px; background: #fee2e2; border-radius: 4px; text-align: center; font-size: 11px;">
                            <div style="color: #991b1b;">‚úì True</div>
                        </div>
                        <div style="flex: 1; padding: 6px; background: #d1fae5; border-radius: 4px; text-align: center; font-size: 11px;">
                            <div style="color: #065f46;">‚úó False</div>
                        </div>
                    </div>
                    <div style="font-size: 11px; color: #10b981; margin-top: 8px; text-align: center; cursor: pointer;" onclick="openNodeConfig(this.closest('.node-card'))">‚öôÔ∏è Editar condici√≥n...</div>
                `;
            } else if (type === 'state') {
                const isAlert = customLabel && customLabel.includes('Alta');
                nodeDataStore[nodeId].config = { stateType: isAlert ? 'alert' : 'success', stateName: customLabel || 'Estado', notify: isAlert };
                customContent = `
                    <div class="form-group">
                        <label class="form-label">Tipo de estado</label>
                        <select class="form-select" id="stateTypeSimple-${nodeId}" onchange="updateNodeStateType('${nodeId}', this.value)">
                            <option value="alert" ${isAlert ? 'selected' : ''}>üö® Alerta</option>
                            <option value="success" ${!isAlert ? 'selected' : ''}>‚úÖ OK</option>
                            <option value="warning">‚ö†Ô∏è Advertencia</option>
                            <option value="pending">‚è≥ Pendiente</option>
                        </select>
                    </div>
                    <div id="stateSummary-${nodeId}" style="padding: 8px; background: ${isAlert ? '#fee2e2' : '#d1fae5'}; border-radius: 6px; margin-top: 8px; text-align: center;">
                        <span style="font-size: 20px;">${isAlert ? 'üö®' : '‚úÖ'}</span>
                        <div style="font-size: 12px; font-weight: 500; color: ${isAlert ? '#dc2626' : '#059669'};" id="stateLabel-${nodeId}">${customLabel || 'Estado'}</div>
                    </div>
                    <div style="font-size: 11px; color: #10b981; margin-top: 8px; text-align: center; cursor: pointer;" onclick="openNodeConfig(this.closest('.node-card'))">‚öôÔ∏è Configurar acciones...</div>
                `;
            } else if (type === 'transform') {
                nodeDataStore[nodeId].config = { transformType: 'map', mappings: [] };
                customContent = `
                    <div class="form-group">
                        <label class="form-label">Operaci√≥n</label>
                        <select class="form-select" id="transformTypeSimple-${nodeId}" onchange="updateNodeTransformType('${nodeId}', this.value)">
                            <option value="map">üîÑ Mapear</option>
                            <option value="filter">üîç Filtrar</option>
                            <option value="aggregate">üìä Agregar</option>
                        </select>
                    </div>
                    <div id="transformSummary-${nodeId}" style="padding: 8px; background: #f8fafc; border-radius: 6px; margin-top: 8px; font-size: 12px; color: #757575;">
                        0 transformaciones configuradas
                    </div>
                    <div style="font-size: 11px; color: #10b981; margin-top: 8px; text-align: center; cursor: pointer;" onclick="openNodeConfig(this.closest('.node-card'))">‚öôÔ∏è Configurar...</div>
                `;
            }

            nodeEl.innerHTML = `
                <div class="node-card-title" onmousedown="startNodeDrag(event)">
                    <div class="node-card-title-icon" style="background: ${template.color}">${template.icon}</div>
                    <div class="node-card-title-text">
                        <h3>${customLabel || template.title}</h3>
                        <span>${template.subtitle}</span>
                    </div>
                    <div class="node-card-actions">
                        <button class="icon-button" onclick="openNodeConfig(this.closest('.node-card'))" title="Configurar">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                        </button>
                        <button class="icon-button" onclick="deleteNode(this)" title="Eliminar">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="node-card-body">
                    ${customContent || template.content}
                </div>
                <div class="connection-point input" data-node-id="${nodeId}"
                     onmouseenter="highlightConnectionPoint(event)"
                     onmouseleave="unhighlightConnectionPoint(event)"></div>
                <div class="connection-point output" data-node-id="${nodeId}"
                     onmousedown="startConnection(event)"></div>
            `;

            canvas.appendChild(nodeEl);
        }

        // =====================================================
        // NODE UPDATE FUNCTIONS - Sync between node and sidebar
        // =====================================================

        function updateNodeAssetArea(nodeId, area) {
            nodeDataStore[nodeId].config.area = area;
            const treeContainer = document.getElementById(`assetTreeContainer-${nodeId}`);
            const treeDiv = document.getElementById(`assetTree-${nodeId}`);
            const selectedDiv = document.getElementById(`assetSelected-${nodeId}`);

            if (!area) {
                treeContainer.style.display = 'none';
                selectedDiv.style.display = 'none';
                return;
            }

            // Get assets for selected area
            const assets = assetsDatabase[area] || [];

            // Build tree structure HTML
            const areaIcons = {
                ti: 'üñ•Ô∏è', finanzas: 'üí∞', operaciones: '‚öôÔ∏è',
                rrhh: 'üë•', legal: '‚öñÔ∏è', marketing: 'üì¢'
            };
            const areaNames = {
                ti: 'Tecnolog√≠a', finanzas: 'Finanzas', operaciones: 'Operaciones',
                rrhh: 'Recursos Humanos', legal: 'Legal', marketing: 'Marketing'
            };

            let treeHTML = `
                <div style="padding: 8px;">
                    <div style="display: flex; align-items: center; gap: 6px; padding: 6px; background: #e0f2fe; border-radius: 4px; margin-bottom: 6px;">
                        <span>${areaIcons[area] || 'üìÅ'}</span>
                        <span style="font-weight: 600; font-size: 12px; color: #0369a1;">${areaNames[area] || area}</span>
                    </div>
                    <div style="margin-left: 12px; border-left: 2px solid #e2e8f0; padding-left: 10px;">
            `;

            assets.forEach(asset => {
                const criticalityColors = {
                    'Alta': { bg: '#fee2e2', color: '#991b1b' },
                    'Media': { bg: '#fef3c7', color: '#92400e' },
                    'Baja': { bg: '#d1fae5', color: '#065f46' }
                };
                const critStyle = criticalityColors[asset.criticidad] || criticalityColors['Media'];

                treeHTML += `
                    <div class="asset-tree-item" onclick="selectNodeAsset('${nodeId}', '${asset.id}')"
                         style="display: flex; align-items: center; gap: 8px; padding: 8px; margin: 4px 0; background: #fff; border: 1px solid #e2e8f0; border-radius: 6px; cursor: pointer; transition: all 0.2s;"
                         onmouseover="this.style.borderColor='#10b981'; this.style.background='#f0fdf4';"
                         onmouseout="this.style.borderColor='#e2e8f0'; this.style.background='#fff';">
                        <span style="font-size: 16px;">${asset.icono || 'üì¶'}</span>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-size: 12px; font-weight: 500; color: #1a1a1a; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${asset.nombre}</div>
                            <div style="font-size: 10px; color: #757575;">${asset.tipo}</div>
                        </div>
                        <span style="padding: 2px 6px; background: ${critStyle.bg}; color: ${critStyle.color}; border-radius: 8px; font-size: 9px; font-weight: 600;">${asset.criticidad}</span>
                    </div>
                `;
            });

            treeHTML += `</div></div>`;

            treeDiv.innerHTML = treeHTML;
            treeContainer.style.display = 'block';
            selectedDiv.style.display = 'none';

            // Sync to sidebar if open
            syncToSidebar(nodeId);
        }

        function selectNodeAsset(nodeId, assetId) {
            const area = nodeDataStore[nodeId].config.area;
            const assets = assetsDatabase[area] || [];
            const asset = assets.find(a => a.id === assetId);

            if (!asset) return;

            nodeDataStore[nodeId].config.assetId = assetId;
            nodeDataStore[nodeId].config.assetName = asset.nombre;

            // Hide tree and show selected asset
            const treeContainer = document.getElementById(`assetTreeContainer-${nodeId}`);
            const selectedDiv = document.getElementById(`assetSelected-${nodeId}`);

            treeContainer.style.display = 'none';
            selectedDiv.style.display = 'block';

            // Update selected asset display
            document.getElementById(`assetSelectedIcon-${nodeId}`).textContent = asset.icono || 'üì¶';
            document.getElementById(`assetSelectedName-${nodeId}`).textContent = asset.nombre;

            const areaNames = {
                ti: 'Tecnolog√≠a', finanzas: 'Finanzas', operaciones: 'Operaciones',
                rrhh: 'Recursos Humanos', legal: 'Legal', marketing: 'Marketing'
            };
            document.getElementById(`assetSelectedArea-${nodeId}`).textContent = areaNames[area] + ' ‚Ä¢ ' + asset.tipo;

            // Update criticality badge
            const badge = document.getElementById(`assetSelectedBadge-${nodeId}`);
            const criticalityStyles = {
                'Alta': { bg: '#fee2e2', color: '#991b1b' },
                'Media': { bg: '#fef3c7', color: '#92400e' },
                'Baja': { bg: '#d1fae5', color: '#065f46' }
            };
            const style = criticalityStyles[asset.criticidad] || criticalityStyles['Media'];
            badge.style.background = style.bg;
            badge.style.color = style.color;
            badge.textContent = asset.criticidad;

            syncToSidebar(nodeId);
        }

        // Legacy function for compatibility
        function updateNodeAsset(nodeId, assetId) {
            selectNodeAsset(nodeId, assetId);
        }

        function updateNodeLLMModel(nodeId, model) {
            nodeDataStore[nodeId].config.model = model;
            syncToSidebar(nodeId);
        }

        function updateNodeStateType(nodeId, stateType) {
            nodeDataStore[nodeId].config.stateType = stateType;
            const summary = document.getElementById(`stateSummary-${nodeId}`);
            const label = document.getElementById(`stateLabel-${nodeId}`);

            const styles = {
                alert: { icon: 'üö®', bg: '#fee2e2', color: '#dc2626' },
                success: { icon: '‚úÖ', bg: '#d1fae5', color: '#059669' },
                warning: { icon: '‚ö†Ô∏è', bg: '#fef3c7', color: '#d97706' },
                pending: { icon: '‚è≥', bg: '#f3f4f6', color: '#6b7280' }
            };
            const style = styles[stateType] || styles.success;

            summary.style.background = style.bg;
            summary.querySelector('span').textContent = style.icon;
            label.style.color = style.color;

            syncToSidebar(nodeId);
        }

        function updateNodeTransformType(nodeId, type) {
            nodeDataStore[nodeId].config.transformType = type;
            syncToSidebar(nodeId);
        }

        // Sync node data to sidebar if it's open for this node
        function syncToSidebar(nodeId) {
            if (selectedNodeId === nodeId) {
                loadSidebarFromNodeData(nodeId);
            }
        }

        // Load sidebar content from node data
        function loadSidebarFromNodeData(nodeId) {
            const data = nodeDataStore[nodeId];
            if (!data) return;

            // Update sidebar selects/inputs based on node type and stored data
            // This ensures sidebar reflects current node state
        }

        // =====================================================
        // BRANCHING NODE FUNCTIONS
        // =====================================================

        function updateNodeBranchCount(nodeId, count) {
            const numBranches = parseInt(count);
            if (nodeDataStore[nodeId]) {
                nodeDataStore[nodeId].config.branchCount = numBranches;
                const branches = [];
                for (let i = 1; i <= numBranches; i++) {
                    branches.push('Rama ' + i);
                }
                nodeDataStore[nodeId].config.branches = branches;
            }

            // Update preview
            const preview = document.getElementById('branchPreview-' + nodeId);
            if (preview) {
                preview.innerHTML = branches.map(b =>
                    '<span style="padding: 4px 8px; background: #c6f6d5; border-radius: 4px; font-size: 11px;">' + b + '</span>'
                ).join('');
            }
            syncToSidebar(nodeId);
        }

        function updateNodeBranchStrategy(nodeId, strategy) {
            if (nodeDataStore[nodeId]) {
                nodeDataStore[nodeId].config.strategy = strategy;
            }
            syncToSidebar(nodeId);
        }

        // =====================================================
        // MATH NODE FUNCTIONS
        // =====================================================

        function updateNodeMathFormula(nodeId, formula) {
            if (nodeDataStore[nodeId]) {
                nodeDataStore[nodeId].config.formula = formula;
            }
            syncToSidebar(nodeId);
        }

        function insertMathOp(nodeId, op) {
            const input = document.getElementById('mathFormula-' + nodeId);
            if (input) {
                const cursorPos = input.selectionStart || input.value.length;
                let insertion = op;
                if (op === 'sqrt') {
                    insertion = 'sqrt()';
                } else if (op === '*') {
                    insertion = ' * ';
                } else if (op === '/') {
                    insertion = ' / ';
                } else if (op === '+' || op === '-') {
                    insertion = ' ' + op + ' ';
                }
                input.value = input.value.substring(0, cursorPos) + insertion + input.value.substring(cursorPos);
                input.focus();
                updateNodeMathFormula(nodeId, input.value);
            }
        }

        // =====================================================
        // ML NODE FUNCTIONS
        // =====================================================

        const mlModelInfoData = {
            risk_predictor: { title: 'üéØ Predictor de Riesgos', text: 'Calcula probabilidad de riesgo bas√°ndose en m√∫ltiples variables.' },
            anomaly_detector: { title: 'üîç Detector de Anomal√≠as', text: 'Identifica patrones inusuales con Isolation Forest.' },
            classifier: { title: 'üìä Clasificador', text: 'Categoriza registros en clases predefinidas.' },
            regression: { title: 'üìà Regresi√≥n', text: 'Predice valores num√©ricos continuos.' },
            clustering: { title: 'üé≤ Clustering', text: 'Agrupa elementos similares en clusters.' }
        };

        function updateNodeMLModel(nodeId, model) {
            if (nodeDataStore[nodeId]) {
                nodeDataStore[nodeId].config.model = model;
            }

            const infoDiv = document.getElementById('mlModelInfo-' + nodeId);
            if (infoDiv && model && mlModelInfoData[model]) {
                infoDiv.style.display = 'block';
                infoDiv.innerHTML = '<strong>' + mlModelInfoData[model].title + '</strong><br>' + mlModelInfoData[model].text;
            } else if (infoDiv) {
                infoDiv.style.display = 'none';
            }
            syncToSidebar(nodeId);
        }

        // =====================================================
        // FILE UPLOAD SIMULATION FUNCTIONS
        // =====================================================

        // Sample data for simulation
        const sampleFiles = {
            'empleados.csv': {
                name: 'empleados.csv',
                rows: 1247,
                columns: ['nombre', 'email', 'cargo', 'area', 'fecha_ingreso', 'salario', 'estado', 'supervisor'],
                preview: [
                    { nombre: 'Alice Johnson', email: 'alice@empresa.com', cargo: 'Analista Financiero', area: 'Finanzas', estado: 'Activo' },
                    { nombre: 'Bob Smith', email: 'bob@empresa.com', cargo: 'Desarrollador Senior', area: 'TI', estado: 'Activo' },
                    { nombre: 'Carol Davis', email: 'carol@empresa.com', cargo: 'Gerente de Compliance', area: 'Legal', estado: 'Activo' },
                    { nombre: 'David Wilson', email: 'david@empresa.com', cargo: 'Contador', area: 'Finanzas', estado: 'Licencia' },
                    { nombre: 'Eva Martinez', email: 'eva@empresa.com', cargo: 'Analista de Riesgos', area: 'Legal', estado: 'Activo' }
                ]
            },
            'activos.xlsx': {
                name: 'activos.xlsx',
                rows: 89,
                columns: ['id_activo', 'nombre', 'tipo', 'area', 'valor', 'criticidad', 'responsable'],
                preview: [
                    { id_activo: 'ACT-001', nombre: 'Sistema ERP', tipo: 'Software', area: 'Finanzas', criticidad: 'Alta' },
                    { id_activo: 'ACT-002', nombre: 'Servidor Principal', tipo: 'Hardware', area: 'TI', criticidad: 'Cr√≠tica' },
                    { id_activo: 'ACT-003', nombre: 'Base de Datos Clientes', tipo: 'Datos', area: 'Ventas', criticidad: 'Alta' }
                ]
            },
            'riesgos.csv': {
                name: 'riesgos.csv',
                rows: 156,
                columns: ['id_riesgo', 'descripcion', 'probabilidad', 'impacto', 'estado', 'responsable', 'fecha_identificacion'],
                preview: [
                    { id_riesgo: 'R-001', descripcion: 'Acceso no autorizado', probabilidad: 'Media', impacto: 'Alto', estado: 'Abierto' },
                    { id_riesgo: 'R-002', descripcion: 'P√©rdida de datos', probabilidad: 'Baja', impacto: 'Cr√≠tico', estado: 'Mitigado' },
                    { id_riesgo: 'R-003', descripcion: 'Incumplimiento regulatorio', probabilidad: 'Alta', impacto: 'Alto', estado: 'En proceso' }
                ]
            }
        };

        function triggerFileInput(nodeId) {
            document.getElementById(`fileInput-${nodeId}`).click();
        }

        function handleDragOver(event, nodeId) {
            event.preventDefault();
            const dropZone = document.getElementById(`dropZone-${nodeId}`);
            dropZone.style.borderColor = '#10b981';
            dropZone.style.background = '#f0fdf4';
        }

        function handleDragLeave(event, nodeId) {
            const dropZone = document.getElementById(`dropZone-${nodeId}`);
            dropZone.style.borderColor = '#e0e0e0';
            dropZone.style.background = '#fafafa';
        }

        function handleFileDrop(event, nodeId) {
            event.preventDefault();
            handleDragLeave(event, nodeId);
            simulateFileLoad(nodeId, 'empleados.csv');
        }

        function handleFileSelect(event, nodeId) {
            const fileName = event.target.files[0]?.name || 'empleados.csv';
            simulateFileLoad(nodeId, fileName);
        }

        function simulateFileLoad(nodeId, fileName) {
            const dropZone = document.getElementById(`dropZone-${nodeId}`);
            const uploadArea = document.getElementById(`fileUploadArea-${nodeId}`);
            const loadedArea = document.getElementById(`fileLoadedArea-${nodeId}`);
            const columnsArea = document.getElementById(`columnsArea-${nodeId}`);
            const previewArea = document.getElementById(`previewArea-${nodeId}`);

            // Show loading state
            dropZone.innerHTML = `
                <div style="font-size: 32px; margin-bottom: 8px;">‚è≥</div>
                <div style="font-weight: 500; color: #1a1a1a;">Cargando archivo...</div>
                <div style="width: 80%; height: 6px; background: #e0e0e0; border-radius: 3px; margin: 12px auto 0;">
                    <div id="progressBar-${nodeId}" style="width: 0%; height: 100%; background: #10b981; border-radius: 3px; transition: width 0.3s;"></div>
                </div>
            `;

            // Simulate progress
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 30;
                if (progress > 100) progress = 100;
                document.getElementById(`progressBar-${nodeId}`).style.width = progress + '%';

                if (progress >= 100) {
                    clearInterval(interval);
                    setTimeout(() => showFileLoaded(nodeId, fileName), 300);
                }
            }, 200);
        }

        function showFileLoaded(nodeId, fileName) {
            const uploadArea = document.getElementById(`fileUploadArea-${nodeId}`);
            const loadedArea = document.getElementById(`fileLoadedArea-${nodeId}`);
            const columnsArea = document.getElementById(`columnsArea-${nodeId}`);
            const previewArea = document.getElementById(`previewArea-${nodeId}`);
            const fileInfo = document.getElementById(`fileInfo-${nodeId}`);
            const columnsContainer = document.getElementById(`columnsContainer-${nodeId}`);
            const dataPreview = document.getElementById(`dataPreview-${nodeId}`);

            // Get sample data
            const fileKey = Object.keys(sampleFiles).find(k => fileName.toLowerCase().includes(k.split('.')[0])) || 'empleados.csv';
            const fileData = sampleFiles[fileKey];

            // Hide upload, show loaded
            uploadArea.style.display = 'none';
            loadedArea.style.display = 'block';
            columnsArea.style.display = 'block';
            previewArea.style.display = 'block';

            // File info
            fileInfo.innerHTML = `
                <span style="font-size: 24px;">üìä</span>
                <div style="flex: 1;">
                    <div style="font-weight: 600; color: #166534;">${fileName}</div>
                    <div style="font-size: 12px; color: #757575;">${fileData.rows.toLocaleString()} registros ‚Ä¢ ${fileData.columns.length} columnas</div>
                </div>
                <span style="color: #10b981; font-size: 20px;">‚úì</span>
            `;

            // Columns
            columnsContainer.innerHTML = fileData.columns.map(col => `
                <span style="padding: 4px 8px; background: #e0f2fe; border-radius: 4px; font-size: 12px; color: #0369a1; cursor: pointer;" onclick="this.style.background = this.style.background === 'rgb(224, 242, 254)' ? '#bae6fd' : '#e0f2fe'">${col}</span>
            `).join('');

            // Data preview table
            dataPreview.innerHTML = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f8fafc;">
                            ${Object.keys(fileData.preview[0]).map(h => `<th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e0e0e0; font-weight: 600;">${h}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${fileData.preview.map(row => `
                            <tr>
                                ${Object.values(row).map(v => `<td style="padding: 6px 8px; border-bottom: 1px solid #f0f0f0;">${v}</td>`).join('')}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function clearFile(nodeId) {
            const uploadArea = document.getElementById(`fileUploadArea-${nodeId}`);
            const loadedArea = document.getElementById(`fileLoadedArea-${nodeId}`);
            const columnsArea = document.getElementById(`columnsArea-${nodeId}`);
            const previewArea = document.getElementById(`previewArea-${nodeId}`);
            const dropZone = document.getElementById(`dropZone-${nodeId}`);

            // Reset drop zone
            dropZone.innerHTML = `
                <input type="file" id="fileInput-${nodeId}" accept=".csv,.xlsx,.xls" style="display: none;" onchange="handleFileSelect(event, '${nodeId}')">
                <div style="font-size: 32px; margin-bottom: 8px;">üìÅ</div>
                <div style="font-weight: 500; color: #1a1a1a;">Arrastra un archivo aqu√≠</div>
                <div style="font-size: 12px; color: #757575; margin-top: 4px;">o haz clic para seleccionar</div>
                <div style="font-size: 11px; color: #10b981; margin-top: 8px;">CSV, Excel (.xlsx, .xls)</div>
            `;

            uploadArea.style.display = 'block';
            loadedArea.style.display = 'none';
            columnsArea.style.display = 'none';
            previewArea.style.display = 'none';
        }

        // =====================================================
        // ASSET NODE FUNCTIONS
        // =====================================================

        const assetsDatabase = {
            finanzas: [
                { id: 'fin-001', nombre: 'Sistema ERP Financiero', tipo: 'Software', valor: '$450,000', criticidad: 'Alta', responsable: 'CFO', icono: 'üìä' },
                { id: 'fin-002', nombre: 'Base de datos contable', tipo: 'Datos', valor: '$120,000', criticidad: 'Alta', responsable: 'Controller', icono: 'üíæ' },
                { id: 'fin-003', nombre: 'Servidor de reportes', tipo: 'Hardware', valor: '$85,000', criticidad: 'Media', responsable: 'IT Manager', icono: 'üñ•Ô∏è' },
                { id: 'fin-004', nombre: 'Plataforma bancaria', tipo: 'Software', valor: '$320,000', criticidad: 'Alta', responsable: 'Treasury', icono: 'üè¶' }
            ],
            operaciones: [
                { id: 'ops-001', nombre: 'Sistema de gesti√≥n operativa', tipo: 'Software', valor: '$280,000', criticidad: 'Alta', responsable: 'COO', icono: '‚öôÔ∏è' },
                { id: 'ops-002', nombre: 'Plataforma de log√≠stica', tipo: 'Software', valor: '$150,000', criticidad: 'Alta', responsable: 'Logistics Director', icono: 'üöö' },
                { id: 'ops-003', nombre: 'Almac√©n de datos operativos', tipo: 'Datos', valor: '$95,000', criticidad: 'Media', responsable: 'Data Manager', icono: 'üì¶' },
                { id: 'ops-004', nombre: 'Sistema de inventario', tipo: 'Software', valor: '$75,000', criticidad: 'Media', responsable: 'Warehouse Manager', icono: 'üìã' }
            ],
            ti: [
                { id: 'ti-001', nombre: 'Infraestructura de servidores', tipo: 'Hardware', valor: '$750,000', criticidad: 'Alta', responsable: 'CTO', icono: 'üñ•Ô∏è' },
                { id: 'ti-002', nombre: 'Red corporativa', tipo: 'Infraestructura', valor: '$320,000', criticidad: 'Alta', responsable: 'Network Admin', icono: 'üåê' },
                { id: 'ti-003', nombre: 'Sistema de respaldos', tipo: 'Software', valor: '$180,000', criticidad: 'Alta', responsable: 'Backup Admin', icono: 'üíæ' },
                { id: 'ti-004', nombre: 'Firewall perimetral', tipo: 'Seguridad', valor: '$95,000', criticidad: 'Alta', responsable: 'Security Officer', icono: 'üîí' },
                { id: 'ti-005', nombre: 'Cloud Storage', tipo: 'Infraestructura', valor: '$45,000', criticidad: 'Media', responsable: 'Cloud Admin', icono: '‚òÅÔ∏è' }
            ],
            rrhh: [
                { id: 'rh-001', nombre: 'Sistema de n√≥mina', tipo: 'Software', valor: '$120,000', criticidad: 'Alta', responsable: 'HR Director', icono: 'üí∞' },
                { id: 'rh-002', nombre: 'Base de datos de empleados', tipo: 'Datos', valor: '$85,000', criticidad: 'Alta', responsable: 'HR Manager', icono: 'üë•' },
                { id: 'rh-003', nombre: 'Plataforma de capacitaci√≥n', tipo: 'Software', valor: '$45,000', criticidad: 'Media', responsable: 'Training Manager', icono: 'üìö' },
                { id: 'rh-004', nombre: 'Portal de empleados', tipo: 'Software', valor: '$35,000', criticidad: 'Baja', responsable: 'HR Admin', icono: 'üè¢' }
            ],
            legal: [
                { id: 'leg-001', nombre: 'Sistema de gesti√≥n de contratos', tipo: 'Software', valor: '$180,000', criticidad: 'Alta', responsable: 'Legal Director', icono: 'üìù' },
                { id: 'leg-002', nombre: 'Base de datos regulatoria', tipo: 'Datos', valor: '$95,000', criticidad: 'Alta', responsable: 'Compliance Officer', icono: '‚öñÔ∏è' },
                { id: 'leg-003', nombre: 'Plataforma de compliance', tipo: 'Software', valor: '$220,000', criticidad: 'Alta', responsable: 'Compliance Manager', icono: '‚úÖ' }
            ],
            marketing: [
                { id: 'mkt-001', nombre: 'CRM Marketing', tipo: 'Software', valor: '$150,000', criticidad: 'Media', responsable: 'Marketing Director', icono: 'üì¢' },
                { id: 'mkt-002', nombre: 'Plataforma de email marketing', tipo: 'Software', valor: '$45,000', criticidad: 'Media', responsable: 'Email Manager', icono: 'üìß' },
                { id: 'mkt-003', nombre: 'Analytics Dashboard', tipo: 'Software', valor: '$65,000', criticidad: 'Baja', responsable: 'Analytics Manager', icono: 'üìà' }
            ]
        };

        function loadAssetsForArea(nodeId, area) {
            const assetSelectArea = document.getElementById(`assetSelectArea-${nodeId}`);
            const assetSelect = document.getElementById(`assetSelect-${nodeId}`);
            const assetDetails = document.getElementById(`assetDetails-${nodeId}`);
            const assetProps = document.getElementById(`assetProps-${nodeId}`);

            if (!area) {
                assetSelectArea.style.display = 'none';
                assetDetails.style.display = 'none';
                assetProps.style.display = 'none';
                return;
            }

            const assets = assetsDatabase[area] || [];
            assetSelect.innerHTML = '<option value="">Selecciona un activo...</option>' +
                assets.map(a => `<option value="${a.id}">${a.nombre}</option>`).join('');

            assetSelectArea.style.display = 'block';
            assetDetails.style.display = 'none';
            assetProps.style.display = 'none';
        }

        function selectAsset(nodeId, assetId) {
            const area = document.getElementById(`assetArea-${nodeId}`).value;
            const assetDetails = document.getElementById(`assetDetails-${nodeId}`);
            const assetInfo = document.getElementById(`assetInfo-${nodeId}`);
            const assetProps = document.getElementById(`assetProps-${nodeId}`);
            const assetPropsContainer = document.getElementById(`assetPropsContainer-${nodeId}`);

            if (!assetId) {
                assetDetails.style.display = 'none';
                assetProps.style.display = 'none';
                return;
            }

            const assets = assetsDatabase[area] || [];
            const asset = assets.find(a => a.id === assetId);

            if (!asset) return;

            const criticidadColors = {
                'Cr√≠tica': { bg: '#fee2e2', border: '#fecaca', text: '#dc2626' },
                'Alta': { bg: '#fef3c7', border: '#fde047', text: '#d97706' },
                'Media': { bg: '#e0f2fe', border: '#bae6fd', text: '#0369a1' },
                'Baja': { bg: '#d1fae5', border: '#86efac', text: '#059669' }
            };
            const colors = criticidadColors[asset.criticidad] || criticidadColors['Media'];

            assetInfo.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <span style="font-size: 24px;">üè¶</span>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: #166534;">${asset.nombre}</div>
                        <div style="font-size: 12px; color: #757575;">${asset.tipo} ‚Ä¢ ${asset.valor}</div>
                    </div>
                </div>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <span style="padding: 4px 10px; background: ${colors.bg}; border: 1px solid ${colors.border}; border-radius: 4px; font-size: 11px; color: ${colors.text}; font-weight: 500;">Criticidad: ${asset.criticidad}</span>
                    <span style="padding: 4px 10px; background: #f3f4f6; border-radius: 4px; font-size: 11px; color: #374151;">üë§ ${asset.responsable}</span>
                </div>
            `;

            // Property chips
            const props = ['nombre', 'tipo', 'valor', 'criticidad', 'responsable', 'area'];
            assetPropsContainer.innerHTML = props.map(prop => `
                <span class="prop-chip" style="padding: 6px 10px; background: #d1fae5; border: 1px solid #86efac; border-radius: 4px; font-size: 12px; color: #065f46; cursor: pointer;" onclick="togglePropChip(this)">${prop}</span>
            `).join('');

            assetDetails.style.display = 'block';
            assetProps.style.display = 'block';
        }

        function togglePropChip(chip) {
            if (chip.style.background === 'rgb(209, 250, 229)') {
                chip.style.background = '#f3f4f6';
                chip.style.borderColor = '#e5e7eb';
                chip.style.color = '#6b7280';
            } else {
                chip.style.background = '#d1fae5';
                chip.style.borderColor = '#86efac';
                chip.style.color = '#065f46';
            }
        }

        // =====================================================
        // CONDITIONAL NODE FUNCTIONS
        // =====================================================

        function updateConditionPreview(nodeId) {
            const variable = document.getElementById(`condVar-${nodeId}`)?.value || 'variable';
            const operator = document.getElementById(`condOp-${nodeId}`)?.value || '==';
            const value = document.getElementById(`condValue-${nodeId}`)?.value || 'valor';
            const preview = document.getElementById(`condPreview-${nodeId}`);

            if (preview) {
                let opDisplay = operator;
                if (operator === 'contains') opDisplay = '.contains';

                preview.innerHTML = `
                    <span style="color: #a16207;">if</span> (${variable} ${opDisplay === '.contains' ? '' : opDisplay} ${opDisplay === '.contains' ? `.contains(<span style="color: #15803d;">"${value}"</span>)` : `<span style="color: #15803d;">"${value}"</span>`})
                `;
            }
        }

        // =====================================================
        // LLM NODE FUNCTIONS
        // =====================================================

        function updateLLMConfig(nodeId) {
            const prompt = document.getElementById(`llmPrompt-${nodeId}`)?.value || '';
            const tokens = Math.ceil(prompt.length / 4);
            document.getElementById(`llmTokens-${nodeId}`).textContent = '~' + tokens;
        }

        function testLLMPrompt(nodeId) {
            const model = document.getElementById(`llmModel-${nodeId}`).value;
            const prompt = document.getElementById(`llmPrompt-${nodeId}`).value;

            // Show loading
            const btn = event.target;
            btn.innerHTML = '‚è≥ Ejecutando...';
            btn.disabled = true;

            setTimeout(() => {
                alert(`üß™ PRUEBA COMPLETADA

Modelo: ${model}
Tokens usados: ~${Math.ceil(prompt.length / 4) + 150}
Tiempo: 1.2s

Resultado simulado:
{
  "tipo_riesgo": "Operacional",
  "severidad": "alto",
  "acciones_recomendadas": [
    "Revisar permisos de acceso",
    "Implementar 2FA",
    "Programar auditor√≠a"
  ]
}`);
                btn.innerHTML = 'üß™ Probar prompt';
                btn.disabled = false;
            }, 2000);
        }

        // =====================================================
        // STATE NODE FUNCTIONS
        // =====================================================

        function updateStateStyle(nodeId, stateType) {
            const styles = {
                alert: { icon: 'üö®', bg: '#fee2e2', border: '#fecaca', color: '#dc2626' },
                success: { icon: '‚úÖ', bg: '#d1fae5', border: '#86efac', color: '#059669' },
                warning: { icon: '‚ö†Ô∏è', bg: '#fef3c7', border: '#fde047', color: '#d97706' },
                info: { icon: '‚ÑπÔ∏è', bg: '#e0f2fe', border: '#bae6fd', color: '#0369a1' },
                pending: { icon: '‚è≥', bg: '#f3f4f6', border: '#e5e7eb', color: '#6b7280' }
            };
            // Update icon in header could be done here
        }

        // Create demo connections between nodes
        function createDemoConnections() {
            const connectionPairs = [
                { from: 'node-1', to: 'node-3' }, // File -> LLM
                { from: 'node-2', to: 'node-3' }, // Asset -> LLM
                { from: 'node-3', to: 'node-4' }, // LLM -> Conditional
                { from: 'node-4', to: 'node-5' }, // Conditional -> State 1
                { from: 'node-4', to: 'node-6' }  // Conditional -> State 2
            ];

            connectionPairs.forEach(pair => {
                const fromNode = document.querySelector(`[data-node-id="${pair.from}"] .connection-point.output`);
                const toNode = document.querySelector(`[data-node-id="${pair.to}"] .connection-point.input`);

                if (fromNode && toNode) {
                    createDemoConnection(fromNode, toNode);
                }
            });

            // Update all connection positions
            setTimeout(updateAllConnections, 100);
        }

        // Create a single demo connection
        function createDemoConnection(fromPoint, toPoint) {
            const svg = document.getElementById('connectionsSvg');

            const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            line.setAttribute('class', 'connection-line');
            line.setAttribute('marker-end', 'url(#arrowhead)');
            line.setAttribute('data-from', fromPoint.getAttribute('data-node-id'));
            line.setAttribute('data-to', toPoint.getAttribute('data-node-id'));

            svg.appendChild(line);

            connections.push({
                line: line,
                from: fromPoint,
                to: toPoint
            });
        }

        // =====================================================
        // NODE CONFIGURATION SIDEBAR FUNCTIONS
        // =====================================================

        let selectedNodeId = null;
        let currentNodeConfig = {};

        // Model options by provider
        const modelsByProvider = {
            openai: [
                { value: 'gpt-4-turbo', name: 'GPT-4 Turbo' },
                { value: 'gpt-4', name: 'GPT-4' },
                { value: 'gpt-4o', name: 'GPT-4o' },
                { value: 'gpt-3.5-turbo', name: 'GPT-3.5 Turbo' }
            ],
            anthropic: [
                { value: 'claude-3-opus', name: 'Claude 3 Opus' },
                { value: 'claude-3-sonnet', name: 'Claude 3 Sonnet' },
                { value: 'claude-3-haiku', name: 'Claude 3 Haiku' }
            ],
            google: [
                { value: 'gemini-pro', name: 'Gemini Pro' },
                { value: 'gemini-ultra', name: 'Gemini Ultra' }
            ],
            xai: [
                { value: 'grok-1', name: 'Grok-1' },
                { value: 'grok-2', name: 'Grok-2' }
            ],
            custom: [
                { value: 'custom', name: 'Endpoint personalizado' }
            ]
        };

        // Prompt templates
        const promptTemplates = {
            analisis: `Analiza los siguientes datos y proporciona:

1. An√°lisis cuantitativo
2. Tendencias identificadas
3. Insights clave
4. Recomendaciones

Datos a analizar:
{{datos}}`,
            clasificacion: `Clasifica el siguiente registro seg√∫n estas categor√≠as:

- Tipo de riesgo
- Nivel de prioridad (Alto/Medio/Bajo)
- √Årea responsable
- Nivel de urgencia

Registro:
{{registro}}`,
            extraccion: `Extrae la siguiente informaci√≥n del texto proporcionado:

Campos a extraer:
- Entidades principales
- Fechas relevantes
- Montos/Valores
- Responsables

Texto:
{{texto}}`
        };

        // Open node configuration sidebar
        function openNodeConfig(nodeCard) {
            // Deselect any previously selected node
            document.querySelectorAll('.node-card.selected').forEach(n => n.classList.remove('selected'));

            // Select current node
            nodeCard.classList.add('selected');
            selectedNodeId = nodeCard.getAttribute('data-node-id');
            const nodeType = nodeCard.getAttribute('data-node-type');

            // Get node info
            const nodeTitle = nodeCard.querySelector('.node-card-title-text h3').textContent;
            const nodeIcon = nodeCard.querySelector('.node-card-title-icon').textContent;
            const iconBg = nodeCard.querySelector('.node-card-title-icon').style.background;

            // Update sidebar header
            document.getElementById('configHeaderIcon').textContent = nodeIcon;
            document.getElementById('configHeaderIcon').style.background = iconBg;
            document.getElementById('configHeaderTitle').textContent = nodeTitle;
            document.getElementById('configHeaderSubtitle').textContent = 'ID: ' + selectedNodeId;

            // Update badges based on connections
            updateConnectionBadges();

            // Load node-specific sidebar content
            loadNodeSidebarContent(selectedNodeId, nodeType);

            // Show sidebar
            document.getElementById('nodeConfigSidebar').classList.remove('hidden');

            // Default to config tab for configuration
            switchConfigTab('config');
        }

        // Load sidebar content based on node type
        function loadNodeSidebarContent(nodeId, nodeType) {
            const configBody = document.getElementById('configTabContent');
            const inputBody = document.getElementById('inputTabContent');
            const outputBody = document.getElementById('outputTabContent');
            const nodeData = nodeDataStore[nodeId] || { config: {} };

            // Load CONFIG tab content based on node type
            if (nodeType === 'file') {
                configBody.innerHTML = generateFileConfigContent(nodeId, nodeData);
            } else if (nodeType === 'asset') {
                configBody.innerHTML = generateAssetConfigContent(nodeId, nodeData);
            } else if (nodeType === 'llm') {
                configBody.innerHTML = generateLLMConfigContent(nodeId, nodeData);
            } else if (nodeType === 'conditional') {
                configBody.innerHTML = generateConditionalConfigContent(nodeId, nodeData);
            } else if (nodeType === 'state') {
                configBody.innerHTML = generateStateConfigContent(nodeId, nodeData);
            } else if (nodeType === 'transform') {
                configBody.innerHTML = generateTransformConfigContent(nodeId, nodeData);
            } else if (nodeType === 'branching') {
                configBody.innerHTML = generateBranchingConfigContent(nodeId, nodeData);
            } else if (nodeType === 'math') {
                configBody.innerHTML = generateMathConfigContent(nodeId, nodeData);
            } else if (nodeType === 'ml') {
                configBody.innerHTML = generateMLConfigContent(nodeId, nodeData);
            } else {
                configBody.innerHTML = generateDefaultConfigContent(nodeId, nodeData);
            }

            // Load INPUT tab content (variables from connected nodes)
            inputBody.innerHTML = generateInputTabContent(nodeId);

            // Load OUTPUT tab content
            outputBody.innerHTML = generateOutputTabContent(nodeId, nodeType, nodeData);
        }

        // Generate File node config content
        function generateFileConfigContent(nodeId, nodeData) {
            const hasFile = nodeData.config.fileName;
            return `
                <div class="config-section">
                    <div class="config-section-title">Carga de archivo</div>
                    <div id="sidebarFileUpload" style="padding: 24px; background: #fafafa; border: 2px dashed #e0e0e0; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.3s;" onclick="simulateFileUploadFromSidebar('${nodeId}')" ondragover="event.preventDefault(); this.style.borderColor='#10b981'; this.style.background='#f0fdf4';" ondragleave="this.style.borderColor='#e0e0e0'; this.style.background='#fafafa';" ondrop="event.preventDefault(); simulateFileUploadFromSidebar('${nodeId}')">
                        <div style="font-size: 40px; margin-bottom: 8px;">üìÅ</div>
                        <div style="font-weight: 500; color: #1a1a1a;">Arrastra un archivo aqu√≠</div>
                        <div style="font-size: 12px; color: #757575; margin-top: 4px;">o haz clic para seleccionar</div>
                        <div style="font-size: 11px; color: #10b981; margin-top: 8px;">CSV, Excel (.xlsx, .xls)</div>
                    </div>
                </div>

                <div class="config-section" id="sidebarFileInfo" style="display: ${hasFile ? 'block' : 'none'};">
                    <div class="config-section-title">Archivo cargado</div>
                    <div id="sidebarFileDetails" style="padding: 12px; background: #f0fdf4; border: 1px solid #86efac; border-radius: 6px;">
                    </div>
                </div>

                <div class="config-section" id="sidebarColumnsSection" style="display: ${hasFile ? 'block' : 'none'};">
                    <div class="config-section-title">Columnas detectadas</div>
                    <p class="form-help" style="margin-bottom: 12px;">Selecciona las columnas que deseas usar en el flujo.</p>
                    <div id="sidebarColumnsList" style="display: flex; flex-wrap: wrap; gap: 8px;">
                    </div>
                </div>

                <div class="config-section" id="sidebarPreviewSection" style="display: ${hasFile ? 'block' : 'none'};">
                    <div class="config-section-title">Vista previa de datos</div>
                    <div id="sidebarDataPreview" style="max-height: 200px; overflow: auto; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 11px;">
                    </div>
                </div>
            `;
        }

        // Generate Asset node config content
        function generateAssetConfigContent(nodeId, nodeData) {
            const config = nodeData.config || {};
            return `
                <div class="config-section">
                    <div class="config-section-title">Selecci√≥n de Activo</div>
                    <div class="form-group">
                        <label class="form-label">√Årea organizacional</label>
                        <select class="form-select" id="sidebarAssetArea" onchange="loadSidebarAssets('${nodeId}', this.value)">
                            <option value="">Selecciona un √°rea...</option>
                            <option value="finanzas" ${config.area === 'finanzas' ? 'selected' : ''}>üí∞ Finanzas</option>
                            <option value="operaciones" ${config.area === 'operaciones' ? 'selected' : ''}>‚öôÔ∏è Operaciones</option>
                            <option value="ti" ${config.area === 'ti' ? 'selected' : ''}>üíª Tecnolog√≠a de la Informaci√≥n</option>
                            <option value="rrhh" ${config.area === 'rrhh' ? 'selected' : ''}>üë• Recursos Humanos</option>
                            <option value="legal" ${config.area === 'legal' ? 'selected' : ''}>‚öñÔ∏è Legal y Compliance</option>
                        </select>
                    </div>
                    <div class="form-group" id="sidebarAssetSelect" style="display: ${config.area ? 'block' : 'none'};">
                        <label class="form-label">Activo</label>
                        <select class="form-select" id="sidebarAssetList" onchange="selectSidebarAsset('${nodeId}', this.value)">
                            <option value="">Selecciona un activo...</option>
                        </select>
                    </div>
                </div>

                <div class="config-section" id="sidebarAssetDetails" style="display: ${config.assetId ? 'block' : 'none'};">
                    <div class="config-section-title">Detalle del Activo</div>
                    <div id="sidebarAssetInfo" style="padding: 16px; background: #f0fdf4; border: 1px solid #86efac; border-radius: 8px;">
                    </div>
                </div>

                <div class="config-section" id="sidebarAssetProps" style="display: ${config.assetId ? 'block' : 'none'};">
                    <div class="config-section-title">Propiedades a exponer</div>
                    <p class="form-help" style="margin-bottom: 12px;">Selecciona qu√© propiedades estar√°n disponibles para otros nodos.</p>
                    <div id="sidebarAssetPropsList" style="display: flex; flex-wrap: wrap; gap: 8px;">
                    </div>
                </div>
            `;
        }

        // Generate LLM node config content
        function generateLLMConfigContent(nodeId, nodeData) {
            const config = nodeData.config || {};
            return `
                <div class="config-section">
                    <div class="config-section-title">Modelo de IA</div>
                    <div class="form-group">
                        <label class="form-label">Proveedor</label>
                        <select class="form-select" id="sidebarProvider" onchange="updateSidebarModels(this.value)">
                            <option value="openai">OpenAI</option>
                            <option value="anthropic">Anthropic</option>
                            <option value="google">Google</option>
                            <option value="xai">xAI</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Modelo</label>
                        <select class="form-select" id="sidebarModel">
                            <option value="gpt-4-turbo">GPT-4 Turbo</option>
                            <option value="gpt-4">GPT-4</option>
                            <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                        </select>
                    </div>
                </div>

                <div class="config-section">
                    <div class="config-section-title">Par√°metros</div>
                    <div class="param-slider-group">
                        <div class="param-slider-header">
                            <span class="param-slider-label">Temperature</span>
                            <span class="param-slider-value" id="sidebarTempValue">${config.temperature || 0.7}</span>
                        </div>
                        <input type="range" class="param-slider" min="0" max="2" step="0.1" value="${config.temperature || 0.7}" oninput="document.getElementById('sidebarTempValue').textContent = this.value">
                    </div>
                    <div class="param-slider-group">
                        <div class="param-slider-header">
                            <span class="param-slider-label">Max Tokens</span>
                            <span class="param-slider-value" id="sidebarTokensValue">2048</span>
                        </div>
                        <input type="range" class="param-slider" min="256" max="8192" step="256" value="2048" oninput="document.getElementById('sidebarTokensValue').textContent = this.value">
                    </div>
                </div>

                <div class="config-section">
                    <div class="config-section-title">System Prompt</div>
                    <textarea class="form-textarea" id="sidebarSystemPrompt" style="min-height: 80px;" placeholder="Instrucciones del sistema...">Eres un asistente experto en an√°lisis de riesgos GRC.</textarea>
                </div>

                <div class="config-section">
                    <div class="config-section-title">Prompt de Usuario</div>
                    <div class="prompt-editor-container">
                        <div class="prompt-editor-toolbar">
                            <button class="prompt-toolbar-btn" onclick="insertSidebarVariable()">{{var}}</button>
                            <button class="prompt-toolbar-btn" onclick="insertSidebarTemplate('analisis')">üìä An√°lisis</button>
                            <button class="prompt-toolbar-btn" onclick="insertSidebarTemplate('clasificacion')">üè∑Ô∏è Clasificar</button>
                        </div>
                        <textarea class="prompt-editor-textarea" id="sidebarUserPrompt" style="min-height: 120px;" placeholder="Escribe tu prompt aqu√≠...">${config.prompt || 'Analiza el siguiente registro y determina:\n1. Tipo de riesgo\n2. Severidad\n3. Acciones recomendadas\n\nDatos:\n{{archivo.nombre}}\n{{activo.nombre}}'}</textarea>
                        <div class="prompt-editor-footer">
                            <span>Tokens estimados: <strong id="sidebarTokenCount">~120</strong></span>
                        </div>
                    </div>
                </div>

                <div class="config-section">
                    <div class="config-section-title">Modo de prueba</div>
                    <div class="test-panel">
                        <div class="test-panel-header">
                            <span>üß™</span>
                            <span class="test-panel-title">Probar con datos de muestra</span>
                        </div>
                        <div class="test-actions">
                            <button class="btn-test btn-test-preview" onclick="previewSidebarPrompt('${nodeId}')">üëÅÔ∏è Ver prompt final</button>
                            <button class="btn-test btn-test-run" onclick="runSidebarTest('${nodeId}')">‚ñ∂Ô∏è Ejecutar prueba</button>
                        </div>
                    </div>
                </div>

                <div id="sidebarTestResult" style="display: none;">
                </div>
            `;
        }

        // Generate Conditional node config content
        function generateConditionalConfigContent(nodeId, nodeData) {
            const config = nodeData.config || {};
            return `
                <div class="config-section">
                    <div class="config-section-title">Configuraci√≥n de condici√≥n</div>
                    <div class="form-group">
                        <label class="form-label">Variable a evaluar</label>
                        <select class="form-select" id="sidebarCondVar" onchange="updateSidebarConditionPreview('${nodeId}')">
                            <option value="respuesta_llm.severidad" ${config.variable === 'respuesta_llm.severidad' ? 'selected' : ''}>respuesta_llm.severidad</option>
                            <option value="respuesta_llm.tipo_riesgo" ${config.variable === 'respuesta_llm.tipo_riesgo' ? 'selected' : ''}>respuesta_llm.tipo_riesgo</option>
                            <option value="archivo.area" ${config.variable === 'archivo.area' ? 'selected' : ''}>archivo.area</option>
                            <option value="activo.criticidad" ${config.variable === 'activo.criticidad' ? 'selected' : ''}>activo.criticidad</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Operador</label>
                        <select class="form-select" id="sidebarCondOp" onchange="updateSidebarConditionPreview('${nodeId}')">
                            <option value="==" ${config.operator === '==' ? 'selected' : ''}>== (igual a)</option>
                            <option value="!=" ${config.operator === '!=' ? 'selected' : ''}>!= (diferente de)</option>
                            <option value=">" ${config.operator === '>' ? 'selected' : ''}>‚Ä∫ (mayor que)</option>
                            <option value="<" ${config.operator === '<' ? 'selected' : ''}>‚Äπ (menor que)</option>
                            <option value="contains" ${config.operator === 'contains' ? 'selected' : ''}>contiene</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Valor a comparar</label>
                        <input type="text" class="form-input" id="sidebarCondValue" value="${config.value || 'alto'}" oninput="updateSidebarConditionPreview('${nodeId}')">
                    </div>
                </div>

                <div class="config-section">
                    <div class="config-section-title">Vista previa</div>
                    <div id="sidebarCondPreview" style="padding: 12px; background: #fefce8; border: 1px solid #fde047; border-radius: 6px; font-family: monospace; font-size: 13px;">
                        <span style="color: #a16207;">if</span> (${config.variable || 'severidad'} ${config.operator || '=='} <span style="color: #15803d;">"${config.value || 'alto'}"</span>)
                    </div>
                </div>

                <div class="config-section">
                    <div class="config-section-title">Rutas de salida</div>
                    <div style="display: flex; gap: 12px;">
                        <div style="flex: 1; padding: 12px; background: #fee2e2; border-radius: 8px;">
                            <div style="font-size: 12px; color: #991b1b; margin-bottom: 8px;">‚úì Si es verdadero</div>
                            <input type="text" class="form-input" id="sidebarCondTrue" value="Alerta Alta" style="font-size: 12px;">
                        </div>
                        <div style="flex: 1; padding: 12px; background: #d1fae5; border-radius: 8px;">
                            <div style="font-size: 12px; color: #065f46; margin-bottom: 8px;">‚úó Si es falso</div>
                            <input type="text" class="form-input" id="sidebarCondFalse" value="Revisi√≥n Normal" style="font-size: 12px;">
                        </div>
                    </div>
                </div>
            `;
        }

        // Generate State node config content
        function generateStateConfigContent(nodeId, nodeData) {
            const config = nodeData.config || {};
            return `
                <div class="config-section">
                    <div class="config-section-title">Configuraci√≥n de estado</div>
                    <div class="form-group">
                        <label class="form-label">Tipo de estado</label>
                        <select class="form-select" id="sidebarStateType" onchange="updateSidebarStatePreview('${nodeId}', this.value)">
                            <option value="alert" ${config.stateType === 'alert' ? 'selected' : ''}>üö® Alerta / Urgente</option>
                            <option value="success" ${config.stateType === 'success' ? 'selected' : ''}>‚úÖ Completado / OK</option>
                            <option value="warning" ${config.stateType === 'warning' ? 'selected' : ''}>‚ö†Ô∏è Advertencia</option>
                            <option value="info" ${config.stateType === 'info' ? 'selected' : ''}>‚ÑπÔ∏è Informativo</option>
                            <option value="pending" ${config.stateType === 'pending' ? 'selected' : ''}>‚è≥ Pendiente</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Nombre del estado</label>
                        <input type="text" class="form-input" id="sidebarStateName" value="${config.stateName || ''}" placeholder="Ej: Alerta de Riesgo Alto">
                    </div>
                </div>

                <div class="config-section">
                    <div class="config-section-title">Acciones al llegar a este estado</div>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <label style="display: flex; align-items: center; gap: 10px; padding: 10px; background: #fafafa; border-radius: 6px; cursor: pointer;">
                            <input type="checkbox" id="sidebarNotifyEmail" ${config.notify ? 'checked' : ''}>
                            <span>üìß Enviar notificaci√≥n por email</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px; padding: 10px; background: #fafafa; border-radius: 6px; cursor: pointer;">
                            <input type="checkbox" id="sidebarNotifySlack">
                            <span>üí¨ Notificar en Slack</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px; padding: 10px; background: #fafafa; border-radius: 6px; cursor: pointer;">
                            <input type="checkbox" id="sidebarCreateTask">
                            <span>üìã Crear tarea autom√°tica</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px; padding: 10px; background: #fafafa; border-radius: 6px; cursor: pointer;">
                            <input type="checkbox" id="sidebarLogAudit" checked>
                            <span>üìù Registrar en log de auditor√≠a</span>
                        </label>
                    </div>
                </div>

                <div class="config-section" id="sidebarEmailConfig" style="display: ${config.notify ? 'block' : 'none'};">
                    <div class="config-section-title">Configuraci√≥n de email</div>
                    <div class="form-group">
                        <label class="form-label">Destinatarios</label>
                        <input type="text" class="form-input" id="sidebarRecipients" placeholder="email1@empresa.com, email2@empresa.com">
                    </div>
                </div>
            `;
        }

        // Generate Transform node config content
        function generateTransformConfigContent(nodeId, nodeData) {
            const config = nodeData.config || {};
            return `
                <div class="config-section">
                    <div class="config-section-title">Tipo de transformaci√≥n</div>
                    <div class="form-group">
                        <label class="form-label">Operaci√≥n</label>
                        <select class="form-select" id="sidebarTransformOp" onchange="updateTransformConfig('${nodeId}', this.value)">
                            <option value="filter" ${config.transformType === 'filter' ? 'selected' : ''}>üîç Filtrar registros</option>
                            <option value="map" ${config.transformType === 'map' ? 'selected' : ''}>üîÑ Mapear campos</option>
                            <option value="enrich" ${config.transformType === 'enrich' ? 'selected' : ''}>‚ûï Enriquecer datos</option>
                            <option value="aggregate" ${config.transformType === 'aggregate' ? 'selected' : ''}>üìä Agregar valores</option>
                            <option value="sort" ${config.transformType === 'sort' ? 'selected' : ''}>‚ÜïÔ∏è Ordenar</option>
                            <option value="deduplicate" ${config.transformType === 'deduplicate' ? 'selected' : ''}>üîÉ Eliminar duplicados</option>
                        </select>
                    </div>
                </div>

                <!-- Field Selector Tree -->
                <div class="config-section">
                    <div class="config-section-title" style="display: flex; align-items: center; justify-content: space-between;">
                        <span>Campos de entrada</span>
                        <button onclick="toggleAllFields('${nodeId}')" style="font-size: 10px; padding: 4px 8px; background: #f3e5f5; border: 1px solid #e1bee7; border-radius: 4px; cursor: pointer; color: #7b1fa2;">Seleccionar todos</button>
                    </div>
                    <div class="field-tree" id="sidebarFieldTree-${nodeId}">
                        <div class="field-tree-header">
                            <span>üìÅ Propiedades disponibles</span>
                            <span style="font-size: 10px; color: #94a3b8;" id="fieldCount-${nodeId}">0 seleccionados</span>
                        </div>
                        <div class="field-tree-item">
                            <input type="checkbox" id="field-nombre-${nodeId}" checked onchange="updateFieldCount('${nodeId}')">
                            <span style="color: #7b1fa2;">üìÑ</span>
                            <span style="flex: 1; font-size: 13px;">nombre</span>
                            <span class="field-type-badge string">string</span>
                        </div>
                        <div class="field-tree-item">
                            <input type="checkbox" id="field-monto-${nodeId}" checked onchange="updateFieldCount('${nodeId}')">
                            <span style="color: #7b1fa2;">üî¢</span>
                            <span style="flex: 1; font-size: 13px;">monto</span>
                            <span class="field-type-badge number">number</span>
                        </div>
                        <div class="field-tree-item">
                            <input type="checkbox" id="field-fecha-${nodeId}" checked onchange="updateFieldCount('${nodeId}')">
                            <span style="color: #7b1fa2;">üìÖ</span>
                            <span style="flex: 1; font-size: 13px;">fecha</span>
                            <span class="field-type-badge date">date</span>
                        </div>
                        <div class="field-tree-item">
                            <input type="checkbox" id="field-precio-${nodeId}" onchange="updateFieldCount('${nodeId}')">
                            <span style="color: #7b1fa2;">üî¢</span>
                            <span style="flex: 1; font-size: 13px;">precio</span>
                            <span class="field-type-badge number">number</span>
                        </div>
                        <div class="field-tree-item">
                            <input type="checkbox" id="field-cantidad-${nodeId}" onchange="updateFieldCount('${nodeId}')">
                            <span style="color: #7b1fa2;">üî¢</span>
                            <span style="flex: 1; font-size: 13px;">cantidad</span>
                            <span class="field-type-badge number">number</span>
                        </div>
                        <div class="field-tree-item">
                            <input type="checkbox" id="field-estado-${nodeId}" onchange="updateFieldCount('${nodeId}')">
                            <span style="color: #7b1fa2;">üìÑ</span>
                            <span style="flex: 1; font-size: 13px;">estado</span>
                            <span class="field-type-badge string">string</span>
                        </div>
                    </div>
                </div>

                <!-- Filter Config -->
                <div class="config-section" id="sidebarFilterConfig" style="display: ${config.transformType === 'filter' || !config.transformType ? 'block' : 'none'};">
                    <div class="config-section-title" style="display: flex; align-items: center; justify-content: space-between;">
                        <span>Regla de filtrado</span>
                        <button onclick="openFullscreenEditor('${nodeId}', 'filter')" style="font-size: 10px; padding: 4px 8px; background: #7b1fa2; color: white; border: none; border-radius: 4px; cursor: pointer;">‚õ∂ Pantalla completa</button>
                    </div>
                    <div class="form-group">
                        <input type="text" class="form-input" id="sidebarFilterRule" value="${config.filterRule || ''}" placeholder="prioridad = 'Alta' AND estado != 'Cerrado'">
                        <small style="color: #757575; font-size: 11px; display: block; margin-top: 6px;">Usa sintaxis SQL o expresiones l√≥gicas</small>
                    </div>
                    <div style="padding: 10px; background: #f0f9ff; border-radius: 6px; margin-top: 10px;">
                        <div style="font-size: 11px; color: #1e40af; margin-bottom: 6px;">Ejemplos:</div>
                        <div style="font-size: 11px; color: #6b7280; font-family: monospace;">
                            ‚Ä¢ monto > 1000<br>
                            ‚Ä¢ estado IN ('Activo', 'Pendiente')<br>
                            ‚Ä¢ fecha >= '2024-01-01'
                        </div>
                    </div>
                </div>

                <!-- Map Config -->
                <div class="config-section" id="sidebarMapConfig" style="display: ${config.transformType === 'map' ? 'block' : 'none'};">
                    <div class="config-section-title">Mapeo de campos</div>
                    <div id="sidebarMappingRows">
                        <div class="mapping-row" style="display: grid; grid-template-columns: 1fr auto 1fr auto; gap: 8px; align-items: center; margin-bottom: 8px;">
                            <input type="text" class="form-input" placeholder="Campo origen" value="name" style="font-size: 12px;">
                            <span style="color: #7b1fa2; font-weight: bold;">‚Üí</span>
                            <input type="text" class="form-input" placeholder="Campo destino" value="nombre" style="font-size: 12px;">
                            <button class="icon-button" onclick="this.closest('.mapping-row').remove()" style="width: 28px; height: 28px;">√ó</button>
                        </div>
                        <div class="mapping-row" style="display: grid; grid-template-columns: 1fr auto 1fr auto; gap: 8px; align-items: center; margin-bottom: 8px;">
                            <input type="text" class="form-input" placeholder="Campo origen" value="date" style="font-size: 12px;">
                            <span style="color: #7b1fa2; font-weight: bold;">‚Üí</span>
                            <input type="text" class="form-input" placeholder="Campo destino" value="fecha" style="font-size: 12px;">
                            <button class="icon-button" onclick="this.closest('.mapping-row').remove()" style="width: 28px; height: 28px;">√ó</button>
                        </div>
                    </div>
                    <button class="btn-secondary" onclick="addMappingRow()" style="width: 100%; padding: 8px; margin-top: 8px; font-size: 12px; background: #f3e5f5; border: 1px dashed #7b1fa2; border-radius: 6px; cursor: pointer;">+ Agregar mapeo</button>
                </div>

                <!-- Enrich Config -->
                <div class="config-section" id="sidebarEnrichConfig" style="display: ${config.transformType === 'enrich' ? 'block' : 'none'};">
                    <div class="config-section-title" style="display: flex; align-items: center; justify-content: space-between;">
                        <span>Enriquecer datos</span>
                        <button onclick="openFullscreenEditor('${nodeId}', 'enrich')" style="font-size: 10px; padding: 4px 8px; background: #7b1fa2; color: white; border: none; border-radius: 4px; cursor: pointer;">‚õ∂ Pantalla completa</button>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Nueva columna</label>
                        <input type="text" class="form-input" id="sidebarNewColumn" value="${config.newColumn || ''}" placeholder="total">
                    </div>
                    <div class="form-group">
                        <label class="form-label">F√≥rmula</label>
                        <input type="text" class="form-input" id="sidebarFormula" value="${config.formula || ''}" placeholder="precio * cantidad" style="font-family: monospace;">
                        <small style="color: #757575; font-size: 11px; display: block; margin-top: 6px;">Usa nombres de campos existentes</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Operadores r√°pidos</label>
                        <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 4px;">
                            <button class="operator-btn-mini" onclick="insertToEnrichFormula('+')">+</button>
                            <button class="operator-btn-mini" onclick="insertToEnrichFormula('-')">‚àí</button>
                            <button class="operator-btn-mini" onclick="insertToEnrichFormula('*')">√ó</button>
                            <button class="operator-btn-mini" onclick="insertToEnrichFormula('/')">√∑</button>
                            <button class="operator-btn-mini" onclick="insertToEnrichFormula('^')">^</button>
                            <button class="operator-btn-mini" onclick="insertToEnrichFormula('SQRT()')">‚àö</button>
                        </div>
                    </div>
                </div>

                <!-- Aggregate Config -->
                <div class="config-section" id="sidebarAggConfig" style="display: ${config.transformType === 'aggregate' ? 'block' : 'none'};">
                    <div class="config-section-title">Agregaci√≥n</div>
                    <div class="form-group">
                        <label class="form-label">Funci√≥n</label>
                        <select class="form-select" id="sidebarAggFunc">
                            <option value="sum">SUM - Sumar</option>
                            <option value="avg">AVG - Promedio</option>
                            <option value="count">COUNT - Contar</option>
                            <option value="min">MIN - M√≠nimo</option>
                            <option value="max">MAX - M√°ximo</option>
                            <option value="stdev">STDEV - Desviaci√≥n est√°ndar</option>
                            <option value="variance">VAR - Varianza</option>
                            <option value="median">MEDIAN - Mediana</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Campo a agregar</label>
                        <select class="form-select" id="sidebarAggField">
                            <option value="">Seleccionar campo...</option>
                            <option value="monto">monto (number)</option>
                            <option value="precio">precio (number)</option>
                            <option value="cantidad">cantidad (number)</option>
                            <option value="impacto">impacto (number)</option>
                            <option value="probabilidad">probabilidad (number)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Agrupar por</label>
                        <select class="form-select" id="sidebarGroupBy" multiple style="min-height: 80px;">
                            <option value="nombre">nombre</option>
                            <option value="estado">estado</option>
                            <option value="fecha">fecha</option>
                            <option value="categoria">categoria</option>
                            <option value="region">region</option>
                        </select>
                        <small style="color: #757575; font-size: 11px; display: block; margin-top: 6px;">Ctrl+Click para selecci√≥n m√∫ltiple</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Guardar resultado en</label>
                        <input type="text" class="form-input" id="sidebarAggOutput" value="" placeholder="total_ventas">
                    </div>
                </div>

                <!-- Sort Config -->
                <div class="config-section" id="sidebarSortConfig" style="display: ${config.transformType === 'sort' ? 'block' : 'none'};">
                    <div class="config-section-title">Ordenar</div>
                    <div class="form-group">
                        <label class="form-label">Campo</label>
                        <select class="form-select" id="sidebarSortField">
                            <option value="">Seleccionar campo...</option>
                            <option value="nombre">nombre</option>
                            <option value="monto">monto</option>
                            <option value="fecha">fecha</option>
                            <option value="precio">precio</option>
                            <option value="cantidad">cantidad</option>
                            <option value="estado">estado</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Orden</label>
                        <select class="form-select" id="sidebarSortOrder">
                            <option value="asc">‚Üë Ascendente (A-Z, 0-9)</option>
                            <option value="desc">‚Üì Descendente (Z-A, 9-0)</option>
                        </select>
                    </div>
                </div>

                <!-- Deduplicate Config -->
                <div class="config-section" id="sidebarDeduplicateConfig" style="display: ${config.transformType === 'deduplicate' ? 'block' : 'none'};">
                    <div class="config-section-title">Eliminar duplicados</div>
                    <div class="form-group">
                        <label class="form-label">Campos para comparar</label>
                        <select class="form-select" id="sidebarDedupeFields" multiple style="min-height: 100px;">
                            <option value="nombre" selected>nombre</option>
                            <option value="monto">monto</option>
                            <option value="fecha">fecha</option>
                            <option value="precio">precio</option>
                            <option value="estado">estado</option>
                        </select>
                        <small style="color: #757575; font-size: 11px; display: block; margin-top: 6px;">Los registros con valores iguales en estos campos se consideran duplicados</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Conservar</label>
                        <select class="form-select" id="sidebarDedupeKeep">
                            <option value="first">Primera ocurrencia</option>
                            <option value="last">√öltima ocurrencia</option>
                        </select>
                    </div>
                </div>

                <!-- Preview -->
                <div class="config-section">
                    <div class="config-section-title">Vista previa de transformaci√≥n</div>
                    <div style="display: flex; gap: 12px;">
                        <div style="flex: 1; padding: 12px; background: #fafafa; border-radius: 8px; text-align: center;">
                            <div style="font-size: 11px; color: #757575;">Entrada</div>
                            <div style="font-size: 20px; font-weight: 600; color: #1a1a1a;" id="sidebarTransformIn">1,250</div>
                            <div style="font-size: 10px; color: #757575;">registros</div>
                        </div>
                        <div style="display: flex; align-items: center; color: #7b1fa2; font-size: 20px;">‚Üí</div>
                        <div style="flex: 1; padding: 12px; background: #f0fdf4; border-radius: 8px; text-align: center;">
                            <div style="font-size: 11px; color: #757575;">Salida</div>
                            <div style="font-size: 20px; font-weight: 600; color: #059669;" id="sidebarTransformOut">~450</div>
                            <div style="font-size: 10px; color: #757575;">registros</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Helper function for transform config
        function updateTransformConfig(nodeId, operation) {
            // Hide all configs
            ['Filter', 'Map', 'Enrich', 'Agg', 'Sort', 'Deduplicate'].forEach(type => {
                const el = document.getElementById('sidebar' + type + 'Config');
                if (el) el.style.display = 'none';
            });

            // Show selected config
            const configMap = {
                'filter': 'Filter',
                'map': 'Map',
                'enrich': 'Enrich',
                'aggregate': 'Agg',
                'sort': 'Sort',
                'deduplicate': 'Deduplicate'
            };

            if (configMap[operation]) {
                const el = document.getElementById('sidebar' + configMap[operation] + 'Config');
                if (el) el.style.display = 'block';
            }

            // Update node summary
            const summaryEl = document.getElementById('transformSummary-' + nodeId);
            if (summaryEl) {
                const opNames = {
                    'filter': 'Filtrado',
                    'map': 'Mapeo',
                    'enrich': 'Enriquecimiento',
                    'aggregate': 'Agregaci√≥n',
                    'sort': 'Ordenamiento',
                    'deduplicate': 'Deduplicaci√≥n'
                };
                summaryEl.textContent = opNames[operation] + ' configurado';
            }

            // Update node data
            if (nodeDataStore[nodeId]) {
                nodeDataStore[nodeId].config.transformType = operation;
            }
        }

        // Add mapping row for transform
        function addMappingRow() {
            const container = document.getElementById('sidebarMappingRows');
            if (container) {
                const row = document.createElement('div');
                row.className = 'mapping-row';
                row.style.cssText = 'display: grid; grid-template-columns: 1fr auto 1fr auto; gap: 8px; align-items: center; margin-bottom: 8px;';
                row.innerHTML = '<input type="text" class="form-input" placeholder="Campo origen" style="font-size: 12px;">' +
                    '<span style="color: #7b1fa2; font-weight: bold;">‚Üí</span>' +
                    '<input type="text" class="form-input" placeholder="Campo destino" style="font-size: 12px;">' +
                    '<button class="icon-button" onclick="this.closest(\'.mapping-row\').remove()" style="width: 28px; height: 28px;">√ó</button>';
                container.appendChild(row);
            }
        }

        // =====================================================
        // TRANSFORM NODE - FIELD SELECTOR FUNCTIONS
        // =====================================================

        // Toggle all field checkboxes
        function toggleAllFields(nodeId) {
            const tree = document.getElementById('sidebarFieldTree-' + nodeId);
            if (!tree) return;

            const checkboxes = tree.querySelectorAll('input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);

            checkboxes.forEach(cb => {
                cb.checked = !allChecked;
            });

            updateFieldCount(nodeId);
        }

        // Update field count display
        function updateFieldCount(nodeId) {
            const tree = document.getElementById('sidebarFieldTree-' + nodeId);
            const countEl = document.getElementById('fieldCount-' + nodeId);
            if (!tree || !countEl) return;

            const checkboxes = tree.querySelectorAll('input[type="checkbox"]');
            const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
            countEl.textContent = checkedCount + ' seleccionados';
        }

        // Insert operator to enrich formula
        function insertToEnrichFormula(op) {
            const input = document.getElementById('sidebarFormula');
            if (input) {
                const cursorPos = input.selectionStart || input.value.length;
                let insertion = op;
                if (op === '*') insertion = ' * ';
                else if (op === '/') insertion = ' / ';
                else if (op === '+' || op === '-') insertion = ' ' + op + ' ';
                input.value = input.value.substring(0, cursorPos) + insertion + input.value.substring(cursorPos);
                input.focus();
            }
        }

        // =====================================================
        // FULLSCREEN EDITOR FUNCTIONS
        // =====================================================

        let fullscreenEditorNodeId = null;
        let fullscreenEditorType = null;

        // Open fullscreen editor
        function openFullscreenEditor(nodeId, editorType) {
            fullscreenEditorNodeId = nodeId;
            fullscreenEditorType = editorType;

            const modal = document.getElementById('fullscreenEditorModal');
            const textarea = document.getElementById('fullscreenEditorTextarea');
            const typeLabel = document.getElementById('fullscreenEditorType');

            // Set type label
            const typeLabels = {
                'filter': '- Regla de filtrado',
                'enrich': '- F√≥rmula de enriquecimiento'
            };
            typeLabel.textContent = typeLabels[editorType] || '';

            // Load current value
            if (editorType === 'filter') {
                const filterInput = document.getElementById('sidebarFilterRule');
                textarea.value = filterInput ? filterInput.value : '';
                textarea.placeholder = 'Escribe tu regla de filtrado aqu√≠...\n\nEjemplos:\n  monto > 1000\n  estado = \'Activo\' AND fecha >= \'2024-01-01\'\n  categoria IN (\'A\', \'B\', \'C\')';
            } else if (editorType === 'enrich') {
                const formulaInput = document.getElementById('sidebarFormula');
                textarea.value = formulaInput ? formulaInput.value : '';
                textarea.placeholder = 'Escribe tu f√≥rmula aqu√≠...\n\nEjemplos:\n  precio * cantidad\n  (impacto * probabilidad) / 100\n  SQRT(monto^2 + cantidad^2)';
            }

            modal.classList.remove('hidden');
            textarea.focus();

            // Update preview
            updateFullscreenPreview();
        }

        // Close fullscreen editor
        function closeFullscreenEditor() {
            const modal = document.getElementById('fullscreenEditorModal');
            modal.classList.add('hidden');
            fullscreenEditorNodeId = null;
            fullscreenEditorType = null;
        }

        // Apply fullscreen editor changes
        function applyFullscreenEditor() {
            const textarea = document.getElementById('fullscreenEditorTextarea');
            const value = textarea.value;

            if (fullscreenEditorType === 'filter') {
                const filterInput = document.getElementById('sidebarFilterRule');
                if (filterInput) filterInput.value = value;
            } else if (fullscreenEditorType === 'enrich') {
                const formulaInput = document.getElementById('sidebarFormula');
                if (formulaInput) formulaInput.value = value;
            }

            closeFullscreenEditor();
        }

        // Insert field to fullscreen editor
        function insertFieldToFullscreen(fieldName) {
            const textarea = document.getElementById('fullscreenEditorTextarea');
            if (textarea) {
                const cursorPos = textarea.selectionStart || textarea.value.length;
                textarea.value = textarea.value.substring(0, cursorPos) + fieldName + textarea.value.substring(cursorPos);
                textarea.focus();
                textarea.selectionStart = textarea.selectionEnd = cursorPos + fieldName.length;
                updateFullscreenPreview();
            }
        }

        // Insert operator to fullscreen editor
        function insertOpToFullscreen(op) {
            const textarea = document.getElementById('fullscreenEditorTextarea');
            if (textarea) {
                const cursorPos = textarea.selectionStart || textarea.value.length;
                let insertion = op;

                // Format operators with spaces
                if (['*', '/', '+', '-', '%'].includes(op)) {
                    insertion = ' ' + (op === '*' ? '*' : op === '/' ? '/' : op) + ' ';
                }

                textarea.value = textarea.value.substring(0, cursorPos) + insertion + textarea.value.substring(cursorPos);
                textarea.focus();

                // Position cursor inside parentheses for functions
                if (op.endsWith('()')) {
                    textarea.selectionStart = textarea.selectionEnd = cursorPos + insertion.length - 1;
                } else {
                    textarea.selectionStart = textarea.selectionEnd = cursorPos + insertion.length;
                }

                updateFullscreenPreview();
            }
        }

        // Update fullscreen preview
        function updateFullscreenPreview() {
            const textarea = document.getElementById('fullscreenEditorTextarea');
            const preview = document.getElementById('fullscreenFormulaPreview');

            if (!textarea || !preview) return;

            const value = textarea.value.trim();
            if (!value) {
                preview.textContent = '-';
                return;
            }

            // Simple preview - show the expression with syntax highlighting
            if (fullscreenEditorType === 'filter') {
                preview.innerHTML = value
                    .replace(/AND|OR|NOT|IN|LIKE/gi, '<span style="color: #1e40af; font-weight: 600;">$&</span>')
                    .replace(/'[^']*'/g, '<span style="color: #15803d;">$&</span>')
                    .replace(/[<>=!]+/g, '<span style="color: #dc2626;">$&</span>');
            } else {
                preview.innerHTML = value
                    .replace(/SUM|AVG|MIN|MAX|SQRT|ABS|ROUND|STDEV|VAR|MEDIAN/gi, '<span style="color: #7b1fa2; font-weight: 600;">$&</span>')
                    .replace(/[+\-*/^%]/g, '<span style="color: #dc2626;">$&</span>');
            }
        }

        // Add event listener for textarea to update preview
        document.addEventListener('DOMContentLoaded', function() {
            const textarea = document.getElementById('fullscreenEditorTextarea');
            if (textarea) {
                textarea.addEventListener('input', updateFullscreenPreview);
            }
        });

        // Generate Branching node config content
        function generateBranchingConfigContent(nodeId, nodeData) {
            const config = nodeData.config || {};
            const branches = config.branches || ['Rama 1', 'Rama 2'];
            return `
                <div class="config-section">
                    <div class="config-section-title">Configuraci√≥n de ramas</div>
                    <div class="form-group">
                        <label class="form-label">N√∫mero de ramas paralelas</label>
                        <input type="number" class="form-input" id="sidebarBranchCount" value="${config.branchCount || 2}" min="2" max="10" onchange="updateSidebarBranches('${nodeId}', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Estrategia de ejecuci√≥n</label>
                        <select class="form-select" id="sidebarBranchStrategy">
                            <option value="parallel" ${config.strategy === 'parallel' ? 'selected' : ''}>‚ö° Paralela - Todas a la vez</option>
                            <option value="sequential" ${config.strategy === 'sequential' ? 'selected' : ''}>‚û°Ô∏è Secuencial - Una tras otra</option>
                            <option value="priority" ${config.strategy === 'priority' ? 'selected' : ''}>üéØ Por Prioridad - Orden definido</option>
                            <option value="race" ${config.strategy === 'race' ? 'selected' : ''}>üèÅ Race - Primera que termine</option>
                        </select>
                    </div>
                </div>

                <div class="config-section">
                    <div class="config-section-title">Nombres de ramas</div>
                    <div id="sidebarBranchList">
                        ${branches.map((b, i) => `
                            <div class="form-group" style="margin-bottom: 8px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="padding: 4px 8px; background: #c6f6d5; border-radius: 4px; font-size: 11px; color: #22543d;">‚ñ∏ ${i + 1}</span>
                                    <input type="text" class="form-input" value="${b}" placeholder="Nombre rama ${i + 1}" style="flex: 1;">
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div class="config-section">
                    <div class="config-section-title">Info de estrategia</div>
                    <div style="padding: 12px; background: #e6fffa; border-radius: 8px; font-size: 12px; color: #234e52;">
                        <strong id="strategyTitle">‚ö° Paralela</strong>
                        <p id="strategyDesc" style="margin-top: 6px;">Todas las ramas se ejecutan simult√°neamente. Tiempo total = rama m√°s lenta.</p>
                    </div>
                </div>
            `;
        }

        // Generate Math node config content
        function generateMathConfigContent(nodeId, nodeData) {
            const config = nodeData.config || {};
            return `
                <div class="config-section">
                    <div class="config-section-title">F√≥rmula matem√°tica</div>
                    <div class="form-group">
                        <label class="form-label">Expresi√≥n</label>
                        <input type="text" class="form-input" id="sidebarMathFormula" value="${config.formula || ''}" placeholder="(impacto * probabilidad) / 100" style="font-family: monospace;">
                        <small style="color: #757575; font-size: 11px; display: block; margin-top: 6px;">Variables disponibles del nodo anterior</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Operadores r√°pidos</label>
                        <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 6px;">
                            <button class="operator-btn-mini" onclick="insertSidebarMathOp('+')">+</button>
                            <button class="operator-btn-mini" onclick="insertSidebarMathOp('-')">‚àí</button>
                            <button class="operator-btn-mini" onclick="insertSidebarMathOp('*')">√ó</button>
                            <button class="operator-btn-mini" onclick="insertSidebarMathOp('/')">√∑</button>
                            <button class="operator-btn-mini" onclick="insertSidebarMathOp('^')">^</button>
                            <button class="operator-btn-mini" onclick="insertSidebarMathOp('sqrt')">‚àö</button>
                        </div>
                    </div>
                </div>

                <div class="config-section">
                    <div class="config-section-title">Campo de salida</div>
                    <div class="form-group">
                        <label class="form-label">Nombre del campo resultado</label>
                        <input type="text" class="form-input" id="sidebarMathOutput" value="${config.outputField || 'resultado'}" placeholder="riesgo_calculado">
                    </div>
                </div>

                <div class="config-section">
                    <div class="config-section-title">Ejemplos de f√≥rmulas</div>
                    <div style="padding: 12px; background: #feebc8; border-radius: 8px; font-size: 11px; color: #744210;">
                        <code style="display: block; background: white; padding: 4px 8px; border-radius: 4px; margin-bottom: 4px;">precio * cantidad</code>
                        <code style="display: block; background: white; padding: 4px 8px; border-radius: 4px; margin-bottom: 4px;">(impacto * probabilidad) / 100</code>
                        <code style="display: block; background: white; padding: 4px 8px; border-radius: 4px;">sqrt(x^2 + y^2)</code>
                    </div>
                </div>
            `;
        }

        // Generate ML node config content
        function generateMLConfigContent(nodeId, nodeData) {
            const config = nodeData.config || {};
            return `
                <div class="config-section">
                    <div class="config-section-title">Modelo de Machine Learning</div>
                    <div class="form-group">
                        <label class="form-label">Seleccionar modelo</label>
                        <select class="form-select" id="sidebarMLModel" onchange="updateSidebarMLInfo(this.value)">
                            <option value="">Seleccionar modelo...</option>
                            <option value="risk_predictor" ${config.model === 'risk_predictor' ? 'selected' : ''}>üéØ Predictor de Riesgos</option>
                            <option value="anomaly_detector" ${config.model === 'anomaly_detector' ? 'selected' : ''}>üîç Detector de Anomal√≠as</option>
                            <option value="classifier" ${config.model === 'classifier' ? 'selected' : ''}>üìä Clasificador de Incidentes</option>
                            <option value="regression" ${config.model === 'regression' ? 'selected' : ''}>üìà Regresi√≥n</option>
                            <option value="clustering" ${config.model === 'clustering' ? 'selected' : ''}>üé≤ Clustering</option>
                        </select>
                    </div>
                    <div id="sidebarMLModelInfo" style="display: ${config.model ? 'block' : 'none'}; padding: 12px; background: #e6fffa; border-radius: 8px; margin-top: 10px; border-left: 4px solid #38b2ac;">
                        <div style="font-weight: 600; color: #234e52; margin-bottom: 4px;" id="mlInfoTitle">-</div>
                        <div style="font-size: 12px; color: #2c7a7b;" id="mlInfoDesc">-</div>
                    </div>
                </div>

                <div class="config-section">
                    <div class="config-section-title">Par√°metros</div>
                    <div class="form-group">
                        <label class="form-label">Nivel de confianza m√≠nimo</label>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <input type="range" id="sidebarMLConfidence" min="0" max="100" value="${(config.confidence || 0.85) * 100}" style="flex: 1;" oninput="document.getElementById('sidebarMLConfVal').textContent = this.value + '%'">
                            <span id="sidebarMLConfVal" style="font-weight: 600; color: #234e52; min-width: 40px;">${Math.round((config.confidence || 0.85) * 100)}%</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Acci√≥n si confianza baja</label>
                        <select class="form-select" id="sidebarMLLowConfAction">
                            <option value="alert">üîî Generar alerta</option>
                            <option value="manual">üë§ Revisi√≥n manual</option>
                            <option value="skip">‚è≠Ô∏è Omitir predicci√≥n</option>
                        </select>
                    </div>
                </div>

                <div class="config-section" id="sidebarClusterConfig" style="display: ${config.model === 'clustering' ? 'block' : 'none'};">
                    <div class="config-section-title">Configuraci√≥n de Clustering</div>
                    <div class="form-group">
                        <label class="form-label">N√∫mero de clusters</label>
                        <input type="number" class="form-input" id="sidebarNumClusters" value="3" min="2" max="10">
                    </div>
                </div>

                <div class="config-section">
                    <div class="config-section-title">Variables de entrada (JSON)</div>
                    <textarea class="form-textarea" id="sidebarMLInput" style="font-family: monospace; font-size: 11px;" placeholder='{"activos": 3, "severidad": "alta", "impacto": 8}'></textarea>
                </div>
            `;
        }

        function updateSidebarMLInfo(model) {
            const infoDiv = document.getElementById('sidebarMLModelInfo');
            const titleEl = document.getElementById('mlInfoTitle');
            const descEl = document.getElementById('mlInfoDesc');
            const clusterConfig = document.getElementById('sidebarClusterConfig');

            const mlInfo = {
                risk_predictor: { title: 'üéØ Predictor de Riesgos', desc: 'Calcula la probabilidad de riesgo bas√°ndose en m√∫ltiples variables. Ideal para an√°lisis preventivo.' },
                anomaly_detector: { title: 'üîç Detector de Anomal√≠as', desc: 'Identifica patrones inusuales en datos temporales o m√©tricas. Utiliza Isolation Forest.' },
                classifier: { title: 'üìä Clasificador de Incidentes', desc: 'Categoriza autom√°ticamente registros en clases predefinidas con alta precisi√≥n.' },
                regression: { title: 'üìà Regresi√≥n', desc: 'Predice valores num√©ricos continuos bas√°ndose en variables independientes.' },
                clustering: { title: 'üé≤ Clustering', desc: 'Agrupa elementos similares en clusters. √ötil para segmentaci√≥n y an√°lisis exploratorio.' }
            };

            if (model && mlInfo[model]) {
                infoDiv.style.display = 'block';
                titleEl.textContent = mlInfo[model].title;
                descEl.textContent = mlInfo[model].desc;
                clusterConfig.style.display = model === 'clustering' ? 'block' : 'none';
            } else {
                infoDiv.style.display = 'none';
                clusterConfig.style.display = 'none';
            }
        }

        function insertSidebarMathOp(op) {
            const input = document.getElementById('sidebarMathFormula');
            if (input) {
                const cursorPos = input.selectionStart || input.value.length;
                let insertion = op;
                if (op === 'sqrt') insertion = 'sqrt()';
                else if (op === '*') insertion = ' * ';
                else if (op === '/') insertion = ' / ';
                else if (op === '+' || op === '-') insertion = ' ' + op + ' ';
                input.value = input.value.substring(0, cursorPos) + insertion + input.value.substring(cursorPos);
                input.focus();
            }
        }

        function updateSidebarBranches(nodeId, count) {
            const numBranches = parseInt(count);
            const branchList = document.getElementById('sidebarBranchList');
            if (branchList) {
                let html = '';
                for (let i = 1; i <= numBranches; i++) {
                    html += `
                        <div class="form-group" style="margin-bottom: 8px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="padding: 4px 8px; background: #c6f6d5; border-radius: 4px; font-size: 11px; color: #22543d;">‚ñ∏ ${i}</span>
                                <input type="text" class="form-input" value="Rama ${i}" placeholder="Nombre rama ${i}" style="flex: 1;">
                            </div>
                        </div>
                    `;
                }
                branchList.innerHTML = html;
            }
            // Sync to canvas node
            updateNodeBranchCount(nodeId, count);
        }

        // Generate default config content
        function generateDefaultConfigContent(nodeId, nodeData) {
            return `
                <div class="config-section">
                    <div class="config-section-title">Configuraci√≥n</div>
                    <p style="color: #757575;">Configuraci√≥n espec√≠fica no disponible para este tipo de nodo.</p>
                </div>
            `;
        }

        // Generate INPUT tab content
        function generateInputTabContent(nodeId) {
            return `
                <div class="config-section">
                    <div class="config-section-title">Variables de entrada disponibles</div>
                    <p class="form-help" style="margin-bottom: 12px;">Variables disponibles de nodos conectados.</p>
                    <div class="variable-list" id="sidebarInputVars">
                        <div class="variable-chip selected">
                            <span>archivo.nombre</span>
                            <span class="variable-chip-type">string</span>
                        </div>
                        <div class="variable-chip selected">
                            <span>archivo.email</span>
                            <span class="variable-chip-type">string</span>
                        </div>
                        <div class="variable-chip">
                            <span>activo.nombre</span>
                            <span class="variable-chip-type">string</span>
                        </div>
                        <div class="variable-chip">
                            <span>activo.criticidad</span>
                            <span class="variable-chip-type">string</span>
                        </div>
                    </div>
                </div>

                <div class="config-section">
                    <div class="config-section-title">Nodos conectados</div>
                    <div id="sidebarConnectedNodes">
                        <p style="color: #757575; font-size: 13px;">No hay nodos conectados como entrada.</p>
                    </div>
                </div>
            `;
        }

        // Generate OUTPUT tab content
        function generateOutputTabContent(nodeId, nodeType, nodeData) {
            return `
                <div class="config-section">
                    <div class="config-section-title">Variables de salida</div>
                    <div class="form-group">
                        <label class="form-label">Nombre de variable de salida</label>
                        <input type="text" class="form-input" id="sidebarOutputVar" value="resultado_${nodeType}" placeholder="Nombre de la variable">
                    </div>
                </div>

                <div class="config-section">
                    <div class="config-section-title">Schema de salida</div>
                    <div class="schema-builder" id="sidebarSchemaBuilder">
                        <div class="schema-field">
                            <input type="text" class="schema-field-name" value="resultado" placeholder="Campo">
                            <select class="schema-field-type">
                                <option value="string">String</option>
                                <option value="number">Number</option>
                                <option value="boolean">Boolean</option>
                                <option value="array">Array</option>
                            </select>
                            <label class="schema-field-required">
                                <input type="checkbox" checked> Req.
                            </label>
                            <button class="schema-field-remove" onclick="this.closest('.schema-field').remove()">√ó</button>
                        </div>
                        <button class="add-schema-field" onclick="addSidebarSchemaField()">+ Agregar campo</button>
                    </div>
                </div>
            `;
        }

        // Sidebar helper functions
        function simulateFileUploadFromSidebar(nodeId) {
            const uploadDiv = document.getElementById('sidebarFileUpload');
            uploadDiv.innerHTML = `
                <div style="font-size: 32px; margin-bottom: 8px;">‚è≥</div>
                <div style="font-weight: 500; color: #1a1a1a;">Cargando archivo...</div>
                <div style="width: 80%; height: 6px; background: #e0e0e0; border-radius: 3px; margin: 12px auto 0;">
                    <div id="sidebarProgressBar" style="width: 0%; height: 100%; background: #10b981; border-radius: 3px; transition: width 0.3s;"></div>
                </div>
            `;

            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 30;
                if (progress > 100) progress = 100;
                document.getElementById('sidebarProgressBar').style.width = progress + '%';

                if (progress >= 100) {
                    clearInterval(interval);
                    setTimeout(() => showSidebarFileLoaded(nodeId, 'empleados.csv'), 300);
                }
            }, 200);
        }

        function showSidebarFileLoaded(nodeId, fileName) {
            const fileData = sampleFiles['empleados.csv'];

            // Update node data store
            nodeDataStore[nodeId].config.fileName = fileName;
            nodeDataStore[nodeId].config.columns = fileData.columns;
            nodeDataStore[nodeId].config.rows = fileData.rows;

            // Update node card display
            const fileStatus = document.getElementById(`fileStatus-${nodeId}`);
            if (fileStatus) {
                fileStatus.style.background = '#f0fdf4';
                fileStatus.style.borderColor = '#86efac';
                fileStatus.style.borderStyle = 'solid';
                fileStatus.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 24px;">üìä</span>
                        <div style="text-align: left;">
                            <div style="font-weight: 600; color: #166534;">${fileName}</div>
                            <div style="font-size: 11px; color: #757575;">${fileData.rows} registros ‚Ä¢ ${fileData.columns.length} cols</div>
                        </div>
                        <span style="color: #10b981; margin-left: auto;">‚úì</span>
                    </div>
                `;
            }

            // Update sidebar
            document.getElementById('sidebarFileUpload').innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 32px;">üìä</span>
                    <div style="text-align: left;">
                        <div style="font-weight: 600; color: #166534;">${fileName}</div>
                        <div style="font-size: 12px; color: #757575;">${fileData.rows.toLocaleString()} registros ‚Ä¢ ${fileData.columns.length} columnas</div>
                    </div>
                    <span style="color: #10b981; font-size: 24px; margin-left: auto;">‚úì</span>
                </div>
                <button class="btn btn-secondary" style="width: 100%; margin-top: 12px;" onclick="resetSidebarFileUpload('${nodeId}')">üóëÔ∏è Cambiar archivo</button>
            `;

            document.getElementById('sidebarFileInfo').style.display = 'none';
            document.getElementById('sidebarColumnsSection').style.display = 'block';
            document.getElementById('sidebarPreviewSection').style.display = 'block';

            // Populate columns
            document.getElementById('sidebarColumnsList').innerHTML = fileData.columns.map(col => `
                <span class="variable-chip selected" onclick="this.classList.toggle('selected')">${col}</span>
            `).join('');

            // Populate preview
            document.getElementById('sidebarDataPreview').innerHTML = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f8fafc;">
                            ${Object.keys(fileData.preview[0]).map(h => `<th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #e0e0e0; font-weight: 600;">${h}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${fileData.preview.map(row => `
                            <tr>
                                ${Object.values(row).map(v => `<td style="padding: 6px 8px; border-bottom: 1px solid #f0f0f0;">${v}</td>`).join('')}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function resetSidebarFileUpload(nodeId) {
            nodeDataStore[nodeId].config.fileName = null;
            loadNodeSidebarContent(nodeId, 'file');

            // Reset node card
            const fileStatus = document.getElementById(`fileStatus-${nodeId}`);
            if (fileStatus) {
                fileStatus.style.background = '#fafafa';
                fileStatus.style.borderColor = '#e0e0e0';
                fileStatus.style.borderStyle = 'dashed';
                fileStatus.innerHTML = `
                    <div style="font-size: 28px; margin-bottom: 6px;">üìÅ</div>
                    <div style="font-weight: 500; color: #757575;">Sin archivo</div>
                    <div style="font-size: 11px; color: #10b981; margin-top: 4px;">Click para configurar</div>
                `;
            }
        }

        function loadSidebarAssets(nodeId, area) {
            updateNodeAssetArea(nodeId, area);

            const assetSelectDiv = document.getElementById('sidebarAssetSelect');
            const assetList = document.getElementById('sidebarAssetList');

            if (!area) {
                assetSelectDiv.style.display = 'none';
                return;
            }

            const assets = assetsDatabase[area] || [];
            assetList.innerHTML = '<option value="">Selecciona un activo...</option>' +
                assets.map(a => `<option value="${a.id}">${a.nombre}</option>`).join('');
            assetSelectDiv.style.display = 'block';
        }

        function selectSidebarAsset(nodeId, assetId) {
            updateNodeAsset(nodeId, assetId);

            const area = nodeDataStore[nodeId].config.area;
            const assets = assetsDatabase[area] || [];
            const asset = assets.find(a => a.id === assetId);

            if (!asset) {
                document.getElementById('sidebarAssetDetails').style.display = 'none';
                document.getElementById('sidebarAssetProps').style.display = 'none';
                return;
            }

            document.getElementById('sidebarAssetDetails').style.display = 'block';
            document.getElementById('sidebarAssetProps').style.display = 'block';

            const criticidadColors = {
                'Cr√≠tica': { bg: '#fee2e2', color: '#dc2626' },
                'Alta': { bg: '#fef3c7', color: '#d97706' },
                'Media': { bg: '#e0f2fe', color: '#0369a1' },
                'Baja': { bg: '#d1fae5', color: '#059669' }
            };
            const colors = criticidadColors[asset.criticidad] || criticidadColors['Media'];

            document.getElementById('sidebarAssetInfo').innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                    <span style="font-size: 32px;">üè¶</span>
                    <div>
                        <div style="font-weight: 600; color: #166534; font-size: 16px;">${asset.nombre}</div>
                        <div style="font-size: 13px; color: #757575;">${asset.tipo} ‚Ä¢ ${asset.valor}</div>
                    </div>
                </div>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <span style="padding: 4px 10px; background: ${colors.bg}; border-radius: 4px; font-size: 12px; color: ${colors.color}; font-weight: 500;">Criticidad: ${asset.criticidad}</span>
                    <span style="padding: 4px 10px; background: #f3f4f6; border-radius: 4px; font-size: 12px; color: #374151;">üë§ ${asset.responsable}</span>
                </div>
            `;

            const props = ['nombre', 'tipo', 'valor', 'criticidad', 'responsable', 'area'];
            document.getElementById('sidebarAssetPropsList').innerHTML = props.map(prop => `
                <span class="variable-chip selected" onclick="this.classList.toggle('selected')">${prop}</span>
            `).join('');
        }

        function updateSidebarConditionPreview(nodeId) {
            const variable = document.getElementById('sidebarCondVar').value;
            const operator = document.getElementById('sidebarCondOp').value;
            const value = document.getElementById('sidebarCondValue').value;

            // Update sidebar preview
            document.getElementById('sidebarCondPreview').innerHTML = `
                <span style="color: #a16207;">if</span> (${variable} ${operator} <span style="color: #15803d;">"${value}"</span>)
            `;

            // Update node preview
            const nodePreview = document.getElementById(`condPreviewSimple-${nodeId}`);
            if (nodePreview) {
                const shortVar = variable.split('.').pop();
                nodePreview.innerHTML = `<span style="color: #a16207;">if</span> (${shortVar} ${operator} <span style="color: #15803d;">"${value}"</span>)`;
            }

            // Update data store
            nodeDataStore[nodeId].config.variable = variable;
            nodeDataStore[nodeId].config.operator = operator;
            nodeDataStore[nodeId].config.value = value;
        }

        function runSidebarTest(nodeId) {
            const resultDiv = document.getElementById('sidebarTestResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `
                <div class="result-preview">
                    <div class="result-preview-header">
                        <span>‚è≥</span>
                        <span class="result-preview-title">Ejecutando prueba...</span>
                    </div>
                </div>
            `;

            setTimeout(() => {
                resultDiv.innerHTML = `
                    <div class="result-preview">
                        <div class="result-preview-header">
                            <span>‚úÖ</span>
                            <span class="result-preview-title">Resultado de prueba</span>
                        </div>
                        <div class="result-preview-content">
{
  "tipo_riesgo": "Operacional",
  "severidad": "alto",
  "acciones_recomendadas": [
    "Revisar permisos de acceso",
    "Implementar 2FA",
    "Programar auditor√≠a"
  ]
}
                        </div>
                    </div>
                `;
            }, 2000);
        }

        function previewSidebarPrompt(nodeId) {
            let prompt = document.getElementById('sidebarUserPrompt').value;
            const sampleData = {
                'archivo.nombre': 'Alice Johnson',
                'archivo.email': 'alice@empresa.com',
                'activo.nombre': 'Sistema ERP Financiero'
            };

            Object.keys(sampleData).forEach(key => {
                prompt = prompt.replace(new RegExp('\\{\\{' + key + '\\}\\}', 'g'), sampleData[key]);
            });

            alert('PROMPT FINAL:\n\n' + prompt);
        }

        function addSidebarSchemaField() {
            const builder = document.getElementById('sidebarSchemaBuilder');
            const addBtn = builder.querySelector('.add-schema-field');

            const newField = document.createElement('div');
            newField.className = 'schema-field';
            newField.innerHTML = `
                <input type="text" class="schema-field-name" placeholder="Campo">
                <select class="schema-field-type">
                    <option value="string">String</option>
                    <option value="number">Number</option>
                    <option value="boolean">Boolean</option>
                    <option value="array">Array</option>
                </select>
                <label class="schema-field-required">
                    <input type="checkbox"> Req.
                </label>
                <button class="schema-field-remove" onclick="this.closest('.schema-field').remove()">√ó</button>
            `;
            builder.insertBefore(newField, addBtn);
        }

        // Close node configuration sidebar
        function closeNodeConfig() {
            document.getElementById('nodeConfigSidebar').classList.add('hidden');
            document.querySelectorAll('.node-card.selected').forEach(n => n.classList.remove('selected'));
            selectedNodeId = null;
        }

        // Switch between tabs
        function switchConfigTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.config-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.getAttribute('data-tab') === tabName) {
                    tab.classList.add('active');
                }
            });

            // Update tab content
            document.getElementById('inputTabContent').style.display = tabName === 'input' ? 'block' : 'none';
            document.getElementById('outputTabContent').style.display = tabName === 'output' ? 'block' : 'none';
            document.getElementById('configTabContent').style.display = tabName === 'config' ? 'block' : 'none';
        }

        // Update connection badges
        function updateConnectionBadges() {
            if (!selectedNodeId) return;

            let inputCount = 0;
            let outputCount = 0;

            connections.forEach(conn => {
                if (conn.to.getAttribute('data-node-id') === selectedNodeId) {
                    inputCount++;
                }
                if (conn.from.getAttribute('data-node-id') === selectedNodeId) {
                    outputCount++;
                }
            });

            document.getElementById('inputBadge').textContent = inputCount;
            document.getElementById('outputBadge').textContent = outputCount;
        }

        // Toggle variable selection
        function toggleVariableSelection(chip) {
            chip.classList.toggle('selected');
            updateContextPreview();
            updateSelectedVariablesCount();
        }

        // Update context preview based on selected variables
        function updateContextPreview() {
            const selectedVars = document.querySelectorAll('#inputVariablesList .variable-chip.selected');
            const preview = {};

            selectedVars.forEach(chip => {
                const varName = chip.querySelector('span:first-child').textContent;
                const parts = varName.split('.');

                if (!preview[parts[0]]) {
                    preview[parts[0]] = {};
                }

                // Sample values
                const sampleValues = {
                    'archivo.nombre': 'Alice Johnson Smith',
                    'archivo.email': 'alice@sns.com',
                    'archivo.position': 'Financial Analyst',
                    'archivo.status': 'Activo',
                    'activo.nombre': 'Sistema ERP Financiero',
                    'activo.valor': 150000,
                    'activo.area': 'Finanzas'
                };

                preview[parts[0]][parts[1]] = sampleValues[varName] || 'valor_ejemplo';
            });

            document.getElementById('contextPreview').textContent = JSON.stringify(preview, null, 2);
        }

        // Update selected variables count
        function updateSelectedVariablesCount() {
            const count = document.querySelectorAll('#inputVariablesList .variable-chip.selected').length;
            document.getElementById('inputBadge').textContent = count;
        }

        // Update model options based on provider
        function updateModelOptions(provider) {
            const modelSelect = document.getElementById('modelSelect');
            const models = modelsByProvider[provider] || [];

            modelSelect.innerHTML = models.map(m =>
                `<option value="${m.value}">${m.name}</option>`
            ).join('');
        }

        // Update slider values
        function updateSliderValue(type, value) {
            switch(type) {
                case 'temp':
                    document.getElementById('tempValue').textContent = value;
                    break;
                case 'maxTokens':
                    document.getElementById('maxTokensValue').textContent = value;
                    break;
                case 'topP':
                    document.getElementById('topPValue').textContent = value;
                    break;
            }
        }

        // Toggle system prompt expansion
        function toggleSystemPrompt() {
            const textarea = document.getElementById('systemPromptText');
            const toggle = document.querySelector('.system-prompt-toggle');

            if (textarea.style.minHeight === '200px') {
                textarea.style.minHeight = '80px';
                toggle.textContent = 'Expandir';
            } else {
                textarea.style.minHeight = '200px';
                toggle.textContent = 'Contraer';
            }
        }

        // Insert variable into prompt
        function insertVariable() {
            const textarea = document.getElementById('userPromptText');
            const cursorPos = textarea.selectionStart;
            const textBefore = textarea.value.substring(0, cursorPos);
            const textAfter = textarea.value.substring(cursorPos);

            // Show a simple prompt to select variable (in production, this would be a dropdown)
            const selectedVars = Array.from(document.querySelectorAll('#inputVariablesList .variable-chip.selected'))
                .map(chip => chip.querySelector('span:first-child').textContent);

            if (selectedVars.length === 0) {
                alert('Selecciona variables en la pesta√±a "Entrada" primero');
                return;
            }

            const varName = prompt('Ingresa el nombre de la variable:\n\nDisponibles: ' + selectedVars.join(', '));
            if (varName) {
                textarea.value = textBefore + '{{' + varName + '}}' + textAfter;
                updateTokenCount();
                detectVariables();
            }
        }

        // Insert template
        function insertTemplate(templateName) {
            const template = promptTemplates[templateName];
            if (template) {
                document.getElementById('userPromptText').value = template;
                updateTokenCount();
                detectVariables();
            }
        }

        // Open fullscreen prompt editor
        function openFullscreenPrompt() {
            // In production, this would open a modal with Monaco editor
            alert('Editor de prompt en pantalla completa\n(Por implementar con Monaco Editor)');
        }

        // Update token count (simplified estimation)
        function updateTokenCount() {
            const text = document.getElementById('userPromptText').value;
            // Rough estimation: ~4 chars per token
            const tokens = Math.ceil(text.length / 4);
            document.getElementById('tokenCount').textContent = '~' + tokens;
        }

        // Detect variables in prompt
        function detectVariables() {
            const text = document.getElementById('userPromptText').value;
            const regex = /\{\{([^}]+)\}\}/g;
            const variables = [];
            let match;

            while ((match = regex.exec(text)) !== null) {
                variables.push(match[1]);
            }

            document.getElementById('variablesDetected').textContent =
                variables.length + ' variable' + (variables.length !== 1 ? 's' : '') + ' detectada' + (variables.length !== 1 ? 's' : '');
        }

        // Update output format
        function updateOutputFormat(format) {
            const schemaSection = document.getElementById('schemaBuilderSection');
            schemaSection.style.display = format === 'json' ? 'block' : 'none';
        }

        // Add schema field
        function addSchemaField() {
            const schemaBuilder = document.getElementById('schemaBuilder');
            const addButton = schemaBuilder.querySelector('.add-schema-field');

            const newField = document.createElement('div');
            newField.className = 'schema-field';
            newField.innerHTML = `
                <input type="text" class="schema-field-name" placeholder="Nombre del campo">
                <select class="schema-field-type">
                    <option value="string">String</option>
                    <option value="number">Number</option>
                    <option value="boolean">Boolean</option>
                    <option value="array">Array</option>
                    <option value="object">Object</option>
                </select>
                <label class="schema-field-required">
                    <input type="checkbox"> Req.
                </label>
                <button class="schema-field-remove" onclick="removeSchemaField(this)">√ó</button>
            `;

            schemaBuilder.insertBefore(newField, addButton);
            updateSchemaPreview();
        }

        // Remove schema field
        function removeSchemaField(button) {
            button.closest('.schema-field').remove();
            updateSchemaPreview();
        }

        // Update schema preview
        function updateSchemaPreview() {
            const fields = document.querySelectorAll('#schemaBuilder .schema-field');
            const schema = {};

            fields.forEach(field => {
                const name = field.querySelector('.schema-field-name').value;
                const type = field.querySelector('.schema-field-type').value;
                const required = field.querySelector('.schema-field-required input').checked;

                if (name) {
                    schema[name] = type + (required ? ' (requerido)' : ' (opcional)');
                }
            });

            document.getElementById('schemaPreview').textContent = JSON.stringify(schema, null, 2);

            // Update output badge
            document.getElementById('outputBadge').textContent = Object.keys(schema).length;
        }

        // Preview prompt with sample data
        function previewPrompt() {
            let prompt = document.getElementById('userPromptText').value;

            // Replace variables with sample data
            const sampleData = {
                'archivo.nombre': 'Alice Johnson Smith',
                'archivo.email': 'alice@sns.com',
                'archivo.position': 'Financial Analyst',
                'activo.nombre': 'Sistema ERP Financiero'
            };

            Object.keys(sampleData).forEach(key => {
                prompt = prompt.replace(new RegExp('\\{\\{' + key + '\\}\\}', 'g'), sampleData[key]);
            });

            alert('PROMPT FINAL:\n\n' + prompt);
        }

        // Run test
        function runTest() {
            const resultPreview = document.getElementById('resultPreview');
            const resultContent = document.getElementById('resultPreviewContent');

            // Show loading state
            resultPreview.style.display = 'block';
            resultContent.innerHTML = '<div style="text-align: center; padding: 20px; color: #757575;">‚è≥ Ejecutando prueba...</div>';

            // Simulate API call
            setTimeout(() => {
                const mockResult = {
                    tipo_riesgo: "Operacional",
                    severidad: "Medio",
                    acciones_recomendadas: [
                        "Revisar permisos de acceso al sistema ERP",
                        "Implementar autenticaci√≥n de dos factores",
                        "Programar auditor√≠a de seguridad"
                    ],
                    metadata: {
                        tokens_usados: 245,
                        tiempo_respuesta: "1.2s",
                        modelo: "GPT-4 Turbo"
                    }
                };

                resultContent.textContent = JSON.stringify(mockResult, null, 2);
            }, 2000);
        }

        // Save node configuration
        function saveNodeConfig() {
            if (!selectedNodeId) return;

            // Collect all configuration
            const config = {
                nodeId: selectedNodeId,
                provider: document.getElementById('providerSelect').value,
                model: document.getElementById('modelSelect').value,
                temperature: document.getElementById('temperatureSlider').value,
                maxTokens: document.getElementById('maxTokensSlider').value,
                topP: document.getElementById('topPSlider').value,
                systemPrompt: document.getElementById('systemPromptText').value,
                userPrompt: document.getElementById('userPromptText').value,
                outputFormat: document.getElementById('outputFormatSelect').value,
                outputVariable: document.getElementById('outputVariableName').value,
                errorAction: document.querySelector('input[name="errorAction"]:checked').value,
                selectedInputVariables: Array.from(document.querySelectorAll('#inputVariablesList .variable-chip.selected'))
                    .map(chip => chip.querySelector('span:first-child').textContent)
            };

            // Store configuration
            currentNodeConfig[selectedNodeId] = config;

            console.log('Node configuration saved:', config);

            // Show success message
            alert('Configuraci√≥n guardada correctamente');

            // Close sidebar
            closeNodeConfig();
        }

        // Edit node - opens the config sidebar
        function editNode(button) {
            const nodeCard = button.closest('.node-card');
            openNodeConfig(nodeCard);
        }

        // Add click handler to node cards for opening config
        document.addEventListener('click', function(e) {
            const nodeCard = e.target.closest('.node-card');

            // Don't trigger on buttons or form elements
            if (e.target.closest('.icon-button') ||
                e.target.closest('.btn') ||
                e.target.closest('input') ||
                e.target.closest('select') ||
                e.target.closest('textarea') ||
                e.target.closest('.connection-point')) {
                return;
            }

            // Double-click to open config
            if (nodeCard && e.detail === 2) {
                openNodeConfig(nodeCard);
            }
        });

        // Initialize event listeners for prompt editor
        document.addEventListener('DOMContentLoaded', function() {
            const userPromptText = document.getElementById('userPromptText');
            if (userPromptText) {
                userPromptText.addEventListener('input', function() {
                    updateTokenCount();
                    detectVariables();
                });
            }

            // Initialize schema field change listeners
            document.getElementById('schemaBuilder')?.addEventListener('change', updateSchemaPreview);
            document.getElementById('schemaBuilder')?.addEventListener('input', updateSchemaPreview);
        });
    </script>

    <!-- Fullscreen Editor Modal for Transform Node -->
    <div id="fullscreenEditorModal" class="fullscreen-modal hidden">
        <div class="fullscreen-editor-container">
            <div class="fullscreen-editor-header">
                <div class="fullscreen-editor-title">
                    <span>üîÑ</span>
                    <span>Editor de Transformaci√≥n</span>
                    <span id="fullscreenEditorType" style="font-size: 12px; font-weight: 400; color: #a0aec0; margin-left: 8px;">- F√≥rmula</span>
                </div>
                <button onclick="closeFullscreenEditor()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding: 4px 8px;">&times;</button>
            </div>
            <div class="fullscreen-editor-body">
                <div class="fullscreen-editor-sidebar">
                    <div style="margin-bottom: 16px;">
                        <div style="font-size: 12px; font-weight: 600; color: #64748b; margin-bottom: 8px; text-transform: uppercase;">Campos disponibles</div>
                        <div class="field-tree" id="fullscreenFieldTree">
                            <div class="field-tree-header">
                                <span>üìÅ Datos de entrada</span>
                                <span style="font-size: 10px; color: #94a3b8;">Click para insertar</span>
                            </div>
                            <div class="field-tree-item" onclick="insertFieldToFullscreen('nombre')">
                                <span style="color: #7b1fa2;">üìÑ</span>
                                <span style="flex: 1; font-size: 13px;">nombre</span>
                                <span class="field-type-badge string">string</span>
                            </div>
                            <div class="field-tree-item" onclick="insertFieldToFullscreen('monto')">
                                <span style="color: #7b1fa2;">üî¢</span>
                                <span style="flex: 1; font-size: 13px;">monto</span>
                                <span class="field-type-badge number">number</span>
                            </div>
                            <div class="field-tree-item" onclick="insertFieldToFullscreen('fecha')">
                                <span style="color: #7b1fa2;">üìÖ</span>
                                <span style="flex: 1; font-size: 13px;">fecha</span>
                                <span class="field-type-badge date">date</span>
                            </div>
                            <div class="field-tree-item" onclick="insertFieldToFullscreen('precio')">
                                <span style="color: #7b1fa2;">üî¢</span>
                                <span style="flex: 1; font-size: 13px;">precio</span>
                                <span class="field-type-badge number">number</span>
                            </div>
                            <div class="field-tree-item" onclick="insertFieldToFullscreen('cantidad')">
                                <span style="color: #7b1fa2;">üî¢</span>
                                <span style="flex: 1; font-size: 13px;">cantidad</span>
                                <span class="field-type-badge number">number</span>
                            </div>
                            <div class="field-tree-item" onclick="insertFieldToFullscreen('activo')">
                                <span style="color: #7b1fa2;">‚úì</span>
                                <span style="flex: 1; font-size: 13px;">activo</span>
                                <span class="field-type-badge boolean">bool</span>
                            </div>
                            <div class="field-tree-item" onclick="insertFieldToFullscreen('impacto')">
                                <span style="color: #7b1fa2;">üî¢</span>
                                <span style="flex: 1; font-size: 13px;">impacto</span>
                                <span class="field-type-badge number">number</span>
                            </div>
                            <div class="field-tree-item" onclick="insertFieldToFullscreen('probabilidad')">
                                <span style="color: #7b1fa2;">üî¢</span>
                                <span style="flex: 1; font-size: 13px;">probabilidad</span>
                                <span class="field-type-badge number">number</span>
                            </div>
                        </div>
                    </div>
                    <div style="margin-bottom: 16px;">
                        <div style="font-size: 12px; font-weight: 600; color: #64748b; margin-bottom: 8px; text-transform: uppercase;">Operadores</div>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px;">
                            <button class="operator-btn-mini" onclick="insertOpToFullscreen('+')">+</button>
                            <button class="operator-btn-mini" onclick="insertOpToFullscreen('-')">‚àí</button>
                            <button class="operator-btn-mini" onclick="insertOpToFullscreen('*')">√ó</button>
                            <button class="operator-btn-mini" onclick="insertOpToFullscreen('/')">√∑</button>
                            <button class="operator-btn-mini" onclick="insertOpToFullscreen('^')">^</button>
                            <button class="operator-btn-mini" onclick="insertOpToFullscreen('%')">%</button>
                            <button class="operator-btn-mini" onclick="insertOpToFullscreen('(')">(</button>
                            <button class="operator-btn-mini" onclick="insertOpToFullscreen(')')">)</button>
                        </div>
                    </div>
                    <div>
                        <div style="font-size: 12px; font-weight: 600; color: #64748b; margin-bottom: 8px; text-transform: uppercase;">Funciones</div>
                        <div style="display: flex; flex-direction: column; gap: 4px;">
                            <button style="padding: 8px 12px; background: #f3e5f5; border: 1px solid #e1bee7; border-radius: 6px; cursor: pointer; text-align: left; font-size: 12px;" onclick="insertOpToFullscreen('SUM()')">SUM() - Suma</button>
                            <button style="padding: 8px 12px; background: #f3e5f5; border: 1px solid #e1bee7; border-radius: 6px; cursor: pointer; text-align: left; font-size: 12px;" onclick="insertOpToFullscreen('AVG()')">AVG() - Promedio</button>
                            <button style="padding: 8px 12px; background: #f3e5f5; border: 1px solid #e1bee7; border-radius: 6px; cursor: pointer; text-align: left; font-size: 12px;" onclick="insertOpToFullscreen('MIN()')">MIN() - M√≠nimo</button>
                            <button style="padding: 8px 12px; background: #f3e5f5; border: 1px solid #e1bee7; border-radius: 6px; cursor: pointer; text-align: left; font-size: 12px;" onclick="insertOpToFullscreen('MAX()')">MAX() - M√°ximo</button>
                            <button style="padding: 8px 12px; background: #f3e5f5; border: 1px solid #e1bee7; border-radius: 6px; cursor: pointer; text-align: left; font-size: 12px;" onclick="insertOpToFullscreen('SQRT()')">SQRT() - Ra√≠z cuadrada</button>
                            <button style="padding: 8px 12px; background: #f3e5f5; border: 1px solid #e1bee7; border-radius: 6px; cursor: pointer; text-align: left; font-size: 12px;" onclick="insertOpToFullscreen('ABS()')">ABS() - Valor absoluto</button>
                            <button style="padding: 8px 12px; background: #f3e5f5; border: 1px solid #e1bee7; border-radius: 6px; cursor: pointer; text-align: left; font-size: 12px;" onclick="insertOpToFullscreen('ROUND()')">ROUND() - Redondear</button>
                        </div>
                    </div>
                </div>
                <div class="fullscreen-editor-main">
                    <div style="margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between;">
                        <label style="font-size: 13px; font-weight: 500; color: #374151;">Expresi√≥n</label>
                        <span style="font-size: 11px; color: #6b7280;">Tip: Haz clic en los campos o funciones para insertarlos</span>
                    </div>
                    <textarea id="fullscreenEditorTextarea" class="fullscreen-textarea" placeholder="Escribe tu f√≥rmula aqu√≠...&#10;&#10;Ejemplos:&#10;  precio * cantidad&#10;  (impacto * probabilidad) / 100&#10;  SQRT(monto^2 + cantidad^2)"></textarea>
                    <div style="margin-top: 12px; padding: 12px; background: #fefce8; border: 1px solid #fde047; border-radius: 8px;">
                        <div style="font-size: 11px; font-weight: 600; color: #a16207; margin-bottom: 6px;">Vista previa del resultado</div>
                        <div id="fullscreenFormulaPreview" style="font-family: monospace; font-size: 13px; color: #1a1a1a;">-</div>
                    </div>
                </div>
            </div>
            <div class="fullscreen-editor-footer">
                <button class="btn btn-secondary" onclick="closeFullscreenEditor()">Cancelar</button>
                <button class="btn btn-primary" onclick="applyFullscreenEditor()">‚úì Aplicar cambios</button>
            </div>
        </div>
    </div>
</body>
</html>
