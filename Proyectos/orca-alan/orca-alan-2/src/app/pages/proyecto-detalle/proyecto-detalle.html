<div class="proyecto-detalle-container">
  @if (loading()) {
    <div class="loading-container">
      <i class="pi pi-spin pi-spinner" style="font-size: 2rem"></i>
      <p>Cargando proyecto...</p>
    </div>
  } @else if (project(); as proyecto) {
    <!-- Header -->
    <div class="page-header">
      <div class="header-left">
        <p-button
          icon="pi pi-arrow-left"
          [rounded]="true"
          [text]="true"
          (onClick)="volver()"
          pTooltip="Volver a proyectos"
        />
        <div class="header-info">
          <h1>{{ proyecto.name }}</h1>
          <div class="header-tags">
            <p-tag
              [value]="getStatusLabel(proyecto.status)"
              [severity]="getStatusSeverity(proyecto.status)"
            />
            <p-tag
              [value]="getPriorityLabel(proyecto.priority)"
              [severity]="getPrioritySeverity(proyecto.priority)"
            />
          </div>
        </div>
      </div>
      <div class="header-right">
        <p-button
          label="Editar"
          icon="pi pi-pencil"
          severity="secondary"
          [outlined]="true"
          (onClick)="editarProyecto()"
        />
      </div>
    </div>

    <!-- Tabs -->
    <p-tabs [value]="activeTab()" (valueChange)="onTabChange($event)">
      <p-tablist>
        <p-tab [value]="0">
          <i class="pi pi-th-large"></i>
          Dashboard
        </p-tab>
        <p-tab [value]="1">
          <i class="pi pi-clipboard"></i>
          Planificación
        </p-tab>
        <p-tab [value]="2">
          <i class="pi pi-history"></i>
          Timeline
        </p-tab>
        <p-tab [value]="3">
          <i class="pi pi-bullseye"></i>
          Objetivos y KPIs
        </p-tab>
      </p-tablist>

      <p-tabpanels>
        <!-- Dashboard Tab -->
        <p-tabpanel [value]="0">
          <div class="dashboard-content">
            <!-- Stats Cards -->
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-icon progress">
                  <i class="pi pi-chart-line"></i>
                </div>
                <div class="stat-content">
                  <span class="stat-value">{{ proyecto.progress }}%</span>
                  <span class="stat-label">Progreso</span>
                </div>
              </div>
              <div class="stat-card">
                <div class="stat-icon duration">
                  <i class="pi pi-calendar"></i>
                </div>
                <div class="stat-content">
                  <span class="stat-value">{{ projectDuration }}</span>
                  <span class="stat-label">Días totales</span>
                </div>
              </div>
              <div class="stat-card">
                <div class="stat-icon tasks">
                  <i class="pi pi-check-square"></i>
                </div>
                <div class="stat-content">
                  <span class="stat-value">{{ completedTasks }}/{{ totalTasks }}</span>
                  <span class="stat-label">Tareas completadas</span>
                </div>
              </div>
              <div class="stat-card">
                <div class="stat-icon remaining">
                  <i class="pi pi-clock"></i>
                </div>
                <div class="stat-content">
                  <span class="stat-value" [class.warning]="getDaysRemaining(proyecto.endDate) <= 7" [class.overdue]="getDaysRemaining(proyecto.endDate) < 0">
                    {{ getDaysRemaining(proyecto.endDate) }}
                  </span>
                  <span class="stat-label">Días restantes</span>
                </div>
              </div>
            </div>

            <!-- Info del proyecto -->
            <div class="info-section">
              <p-card header="Información del Proyecto">
                <div class="info-grid">
                  <div class="info-item">
                    <span class="label">Descripción</span>
                    <span class="value">{{ proyecto.description || 'Sin descripción' }}</span>
                  </div>
                  <div class="info-item">
                    <span class="label">Fecha de inicio</span>
                    <span class="value">{{ formatDate(proyecto.startDate) }}</span>
                  </div>
                  <div class="info-item">
                    <span class="label">Fecha de fin</span>
                    <span class="value">{{ formatDate(proyecto.endDate) }}</span>
                  </div>
                  <div class="info-item">
                    <span class="label">Responsable</span>
                    <span class="value">{{ proyecto.responsibleUserId }}</span>
                  </div>
                </div>
              </p-card>
            </div>

            <!-- Progreso general -->
            <div class="progress-section">
              <p-card header="Progreso General">
                <div class="progress-container">
                  <p-progressBar
                    [value]="proyecto.progress"
                    [showValue]="true"
                    [style]="{ height: '24px' }"
                  />
                </div>
                <div class="progress-stats">
                  <div class="progress-stat">
                    <span class="num">{{ completedTasks }}</span>
                    <span class="label">Completadas</span>
                  </div>
                  <div class="progress-stat">
                    <span class="num">{{ pendingTasks }}</span>
                    <span class="label">Pendientes</span>
                  </div>
                  <div class="progress-stat">
                    <span class="num">{{ blockedTasks }}</span>
                    <span class="label">Bloqueadas</span>
                  </div>
                </div>
              </p-card>
            </div>

            <!-- Fases -->
            @if (proyecto.phases && proyecto.phases.length > 0) {
              <div class="phases-section">
                <p-card header="Fases del Proyecto">
                  <div class="phases-grid">
                    @for (fase of proyecto.phases; track fase.id) {
                      <div class="phase-card">
                        <div class="phase-header">
                          <span class="phase-name">{{ fase.name }}</span>
                          <p-tag
                            [value]="fase.status"
                            [severity]="getPhaseStatusSeverity(fase.status)"
                            [style]="{ fontSize: '0.7rem' }"
                          />
                        </div>
                        <p class="phase-description">{{ fase.description || 'Sin descripción' }}</p>
                        <div class="phase-progress">
                          <p-progressBar
                            [value]="fase.progress"
                            [showValue]="false"
                            [style]="{ height: '8px' }"
                          />
                          <span class="progress-text">{{ fase.progress }}%</span>
                        </div>
                        <div class="phase-dates">
                          <span><i class="pi pi-calendar"></i> {{ formatDate(fase.startDate) }} - {{ formatDate(fase.endDate) }}</span>
                        </div>
                      </div>
                    }
                  </div>
                </p-card>
              </div>
            }
          </div>
        </p-tabpanel>

        <!-- Planificación Tab (Gantt, Tareas, Kanban, Calendario) -->
        <p-tabpanel [value]="1">
          <div class="planning-container">
            <!-- View Switcher Toolbar -->
            <div class="planning-view-switcher">
              <div class="view-switcher-left">
                <span class="view-title">
                  <i class="pi pi-clipboard"></i>
                  Planificación del Proyecto
                </span>
              </div>
              <div class="view-switcher-icons">
                <button
                  class="view-icon-btn"
                  [class.active]="activePlanningView() === 'gantt'"
                  (click)="activePlanningView.set('gantt')"
                  pTooltip="Vista Gantt"
                  tooltipPosition="bottom"
                >
                  <i class="pi pi-align-left"></i>
                </button>
                <button
                  class="view-icon-btn"
                  [class.active]="activePlanningView() === 'tareas'"
                  (click)="activePlanningView.set('tareas')"
                  pTooltip="Vista Tareas"
                  tooltipPosition="bottom"
                >
                  <i class="pi pi-list"></i>
                </button>
                <button
                  class="view-icon-btn"
                  [class.active]="activePlanningView() === 'kanban'"
                  (click)="activePlanningView.set('kanban')"
                  pTooltip="Vista Kanban"
                  tooltipPosition="bottom"
                >
                  <i class="pi pi-objects-column"></i>
                </button>
                <button
                  class="view-icon-btn"
                  [class.active]="activePlanningView() === 'calendario'"
                  (click)="activePlanningView.set('calendario')"
                  pTooltip="Vista Calendario"
                  tooltipPosition="bottom"
                >
                  <i class="pi pi-calendar"></i>
                </button>
              </div>
              <div class="view-switcher-right">
                <p-button
                  label="Nueva Tarea"
                  icon="pi pi-plus"
                  size="small"
                  (onClick)="abrirFormularioNuevaTarea()" />
              </div>
            </div>

            <!-- GANTT VIEW -->
            @if (activePlanningView() === 'gantt') {
              <div class="gantt-container-enhanced">
                <!-- Gantt Toolbar -->
                <div class="gantt-toolbar secondary">
                  <div class="gantt-toolbar-left">
                    <span class="gantt-subtitle">{{ ganttItems().length }} elementos</span>
                  </div>
                  <div class="gantt-toolbar-right">
                    <div class="gantt-zoom-controls">
                      <span class="zoom-label">Zoom:</span>
                      <p-button
                        icon="pi pi-minus"
                        [rounded]="true"
                        [text]="true"
                        size="small"
                        (onClick)="ganttZoomOut()"
                        pTooltip="Alejar" />
                      <span class="zoom-level">{{ ganttZoomLevel() }}%</span>
                      <p-button
                        icon="pi pi-plus"
                        [rounded]="true"
                        [text]="true"
                        size="small"
                        (onClick)="ganttZoomIn()"
                        pTooltip="Acercar" />
                    </div>
                    <p-button
                      icon="pi pi-refresh"
                      [rounded]="true"
                      [text]="true"
                      size="small"
                      (onClick)="resetGanttZoom()"
                      pTooltip="Restablecer zoom" />
                  </div>
                </div>

                <!-- Gantt Chart -->
                <div class="gantt-chart-wrapper">
                  @if (ganttItems().length > 0) {
                    <div class="gantt-chart" [style.min-width.%]="ganttZoomLevel()">
                      <!-- Timeline Header -->
                      <div class="gantt-timeline-ruler">
                        <div class="gantt-labels-header">
                          <span>Elemento</span>
                        </div>
                        <div class="gantt-timeline-header">
                          @for (month of ganttMonths(); track month.label) {
                            <div class="gantt-month" [style.width.%]="month.width">
                              <span>{{ month.label }}</span>
                            </div>
                          }
                        </div>
                      </div>

                      <!-- Today Line Indicator -->
                      <div class="gantt-today-line" [style.left]="getTodayPosition()">
                        <div class="today-marker">
                          <span class="today-label">Hoy</span>
                        </div>
                      </div>

                      <!-- Gantt Body -->
                      <div class="gantt-body">
                        @for (item of ganttItems(); track item.id) {
                          <div
                            class="gantt-row"
                            [class.phase-row]="item.type === 'phase'"
                            [class.task-row]="item.type === 'task'"
                            [class.completed]="item.status === 'completed'"
                            [class.dragging-row]="isGanttRowBeingDragged(item.id)"
                            [ngClass]="getGanttDropIndicatorClass(item.id)"
                            draggable="true"
                            (dragstart)="onGanttRowDragStart($event, item)"
                            (dragover)="onGanttRowDragOver($event, item)"
                            (dragleave)="onGanttRowDragLeave($event)"
                            (drop)="onGanttRowDrop($event, item)"
                            (dragend)="onGanttRowDragEnd($event)"
                            (click)="onGanttItemClick(item)"
                          >
                            <div class="gantt-label">
                              <span class="gantt-drag-handle" (mousedown)="$event.stopPropagation()">
                                <i class="pi pi-bars"></i>
                              </span>
                              @if (item.type === 'phase') {
                                <button
                                  class="phase-toggle-btn"
                                  (click)="togglePhaseExpand(item.id); $event.stopPropagation()"
                                  [pTooltip]="isPhaseExpanded(item.id) ? 'Colapsar' : 'Expandir'"
                                >
                                  <i class="pi" [ngClass]="isPhaseExpanded(item.id) ? 'pi-chevron-down' : 'pi-chevron-right'"></i>
                                </button>
                                @if (isPhaseExpanded(item.id)) {
                                  <i class="pi pi-folder-open"></i>
                                } @else {
                                  <i class="pi pi-folder"></i>
                                }
                              } @else {
                                <i class="pi pi-check-square"></i>
                              }
                              <span class="item-name" [pTooltip]="item.name">{{ item.name }}</span>
                              @if (item.type === 'phase') {
                                <span class="phase-task-count" [pTooltip]="getPhaseTaskCount(item.id) + ' tareas'">
                                  ({{ getPhaseTaskCount(item.id) }})
                                </span>
                              }
                              <p-tag
                                [value]="item.progress + '%'"
                                [severity]="getGanttProgressSeverity(item.progress)"
                                styleClass="progress-badge"
                              />
                            </div>
                            <div class="gantt-timeline">
                              <!-- Grid lines -->
                              <div class="gantt-grid-lines">
                                @for (month of ganttMonths(); track month.label) {
                                  <div class="grid-line" [style.width.%]="month.width"></div>
                                }
                              </div>

                              <!-- Bar con drag & resize -->
                              <div
                                class="gantt-bar"
                                [class.dragging]="isGanttItemDragging(item.id)"
                                [style.left]="getItemOffset(item)"
                                [style.width]="getItemWidth(item)"
                                [style.background-color]="item.color"
                                [pTooltip]="getGanttTooltip(item)"
                                tooltipPosition="top"
                              >
                                <!-- Resize handle izquierdo -->
                                <div
                                  class="gantt-resize-handle left"
                                  (mousedown)="onGanttBarMouseDown($event, item, 'left')"
                                ></div>

                                <!-- Área central para drag -->
                                <div
                                  class="gantt-bar-content"
                                  (mousedown)="onGanttBarMouseDown($event, item, 'center')"
                                >
                                  <div class="gantt-progress-fill" [style.width.%]="item.progress"></div>
                                  @if (getItemWidthValue(item) > 8) {
                                    <span class="gantt-bar-label">{{ item.progress }}%</span>
                                  }
                                </div>

                                <!-- Resize handle derecho -->
                                <div
                                  class="gantt-resize-handle right"
                                  (mousedown)="onGanttBarMouseDown($event, item, 'right')"
                                ></div>
                              </div>
                            </div>
                          </div>
                        }
                      </div>

                      <!-- Legend -->
                      <div class="gantt-legend">
                        <div class="legend-item">
                          <div class="legend-color" style="background: #3b82f6"></div>
                          <span>En Progreso</span>
                        </div>
                        <div class="legend-item">
                          <div class="legend-color" style="background: #10b981"></div>
                          <span>Completado</span>
                        </div>
                        <div class="legend-item">
                          <div class="legend-color" style="background: #94a3b8"></div>
                          <span>Pendiente</span>
                        </div>
                        <div class="legend-item">
                          <div class="legend-color" style="background: #ef4444"></div>
                          <span>Bloqueado</span>
                        </div>
                        <div class="legend-item today-legend">
                          <div class="legend-line"></div>
                          <span>Hoy</span>
                        </div>
                      </div>
                    </div>
                  } @else {
                    <div class="empty-state">
                      <i class="pi pi-chart-bar"></i>
                      <h3>Sin elementos</h3>
                      <p>No hay fases o tareas para mostrar en el Gantt</p>
                    </div>
                  }
                </div>
              </div>
            }

            <!-- TAREAS VIEW -->
            @if (activePlanningView() === 'tareas') {
              <div class="tasks-container">
                <!-- Toolbar de tareas -->
                <p-toolbar styleClass="mb-3 secondary-toolbar">
                  <ng-template pTemplate="start">
                    <div class="flex align-items-center gap-3">
                      <p-iconfield>
                        <p-inputicon styleClass="pi pi-search" />
                        <input
                          type="text"
                          pInputText
                          placeholder="Buscar tareas..."
                          [ngModel]="taskSearchFilter()"
                          (ngModelChange)="taskSearchFilter.set($event)"
                          style="width: 220px" />
                      </p-iconfield>
                      <p-select
                        [options]="taskStatusOptions"
                        [ngModel]="taskStatusFilter()"
                        (ngModelChange)="taskStatusFilter.set($event)"
                        optionLabel="label"
                        optionValue="value"
                        placeholder="Todos los estados"
                        [showClear]="true"
                        [style]="{ width: '180px' }" />
                    </div>
                  </ng-template>
                </p-toolbar>

                <!-- Tabla de tareas -->
                <p-card styleClass="table-card">
                  <p-table
                    [value]="filteredTasks()"
                    [paginator]="true"
                    [rows]="10"
                    [rowsPerPageOptions]="[10, 25, 50]"
                    [showCurrentPageReport]="true"
                    currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} tareas"
                    styleClass="p-datatable-sm"
                    [rowHover]="true"
                  >
                    <ng-template pTemplate="header">
                      <tr>
                        <th style="width: 30%">Tarea</th>
                        <th style="width: 12%">Tipo</th>
                        <th style="width: 12%">Estado</th>
                        <th style="width: 10%">Prioridad</th>
                        <th style="width: 12%">Progreso</th>
                        <th style="width: 14%">Vencimiento</th>
                        <th style="width: 10%">Acciones</th>
                      </tr>
                    </ng-template>

                    <ng-template pTemplate="body" let-task>
                      <tr class="task-row" [class.overdue]="isTaskOverdue(task)" (click)="abrirTask(task)">
                        <td>
                          <div class="task-info">
                            <span class="task-title">{{ task.title }}</span>
                            @if (task.description) {
                              <span class="task-description">{{ task.description }}</span>
                            }
                          </div>
                        </td>
                        <td>
                          <span class="task-type">
                            <i [class]="'pi ' + getTaskTypeIcon(task.taskType)"></i>
                            {{ getTaskTypeLabel(task.taskType) }}
                          </span>
                        </td>
                        <td>
                          <p-tag
                            [value]="getTaskStatusLabel(task.status)"
                            [severity]="getTaskStatusSeverity(task.status)" />
                        </td>
                        <td>
                          <p-tag
                            [value]="getPriorityLabel(task.priority)"
                            [severity]="getPrioritySeverity(task.priority)" />
                        </td>
                        <td>
                          <div class="progress-cell">
                            <p-progressBar
                              [value]="task.progress"
                              [showValue]="false"
                              [style]="{ height: '8px' }" />
                            <span>{{ task.progress }}%</span>
                          </div>
                        </td>
                        <td>
                          <div class="dates-cell" [class.overdue]="isTaskOverdue(task)">
                            <span class="due-date">{{ formatDate(task.dueDate) }}</span>
                            @if (isTaskOverdue(task)) {
                              <span class="overdue-badge">Vencida</span>
                            }
                          </div>
                        </td>
                        <td (click)="$event.stopPropagation()">
                          <div class="actions-cell">
                            <p-button
                              icon="pi pi-eye"
                              [rounded]="true"
                              [text]="true"
                              severity="info"
                              size="small"
                              pTooltip="Ver detalle"
                              (onClick)="abrirTask(task)" />
                            <p-button
                              icon="pi pi-pencil"
                              [rounded]="true"
                              [text]="true"
                              severity="secondary"
                              size="small"
                              pTooltip="Editar"
                              (onClick)="abrirFormularioEditarTarea(task)" />
                            <p-button
                              icon="pi pi-trash"
                              [rounded]="true"
                              [text]="true"
                              severity="danger"
                              size="small"
                              pTooltip="Eliminar"
                              (onClick)="confirmarEliminarTarea(task)" />
                          </div>
                        </td>
                      </tr>
                    </ng-template>

                    <ng-template pTemplate="emptymessage">
                      <tr>
                        <td colspan="7">
                          <div class="empty-state">
                            <i class="pi pi-inbox"></i>
                            <h3>No hay tareas</h3>
                            <p>Este proyecto aún no tiene tareas asignadas</p>
                            <p-button
                              label="Crear primera tarea"
                              icon="pi pi-plus"
                              (onClick)="abrirFormularioNuevaTarea()" />
                          </div>
                        </td>
                      </tr>
                    </ng-template>

                    <!-- Pie de tabla -->
                    <ng-template pTemplate="footer">
                      <tr class="font-semibold surface-100">
                        <td colspan="2">
                          <span class="text-900">Totales</span>
                        </td>
                        <td>
                          <div class="flex gap-1 flex-wrap">
                            <p-tag [value]="proyectosService.taskStats().inProgress.toString()" severity="info" styleClass="text-xs" pTooltip="En progreso" />
                            <p-tag [value]="proyectosService.taskStats().completed.toString()" severity="success" styleClass="text-xs" pTooltip="Completadas" />
                          </div>
                        </td>
                        <td colspan="2">
                          @if (overdueTasks > 0) {
                            <p-tag [value]="overdueTasks + ' vencidas'" severity="danger" styleClass="text-xs" />
                          }
                        </td>
                        <td colspan="2">
                          <span class="text-600">{{ filteredTasks().length }} tareas</span>
                        </td>
                      </tr>
                    </ng-template>
                  </p-table>
                </p-card>
              </div>
            }

            <!-- KANBAN VIEW -->
            @if (activePlanningView() === 'kanban') {
              <div class="kanban-container">
                <!-- Kanban Board -->
                <div class="kanban-board" cdkDropListGroup>
                  @for (column of kanbanColumns(); track column.id) {
                    <div class="kanban-column" [class]="column.bgClass">
                      <!-- Column Header -->
                      <div class="kanban-column-header" [style.border-left-color]="column.color">
                        <div class="column-header-info">
                          <i class="pi" [ngClass]="column.icon" [style.color]="column.color"></i>
                          <span class="column-title">{{ column.title }}</span>
                        </div>
                        <span class="column-count" [style.background-color]="getKanbanColumnHeaderColor(column.id)">
                          {{ column.tasks.length }}
                        </span>
                      </div>

                      <!-- Column Content - Drop Zone -->
                      <div
                        class="kanban-column-content"
                        cdkDropList
                        [id]="'kanban-' + column.id"
                        [cdkDropListData]="column.tasks"
                        [cdkDropListConnectedTo]="kanbanColumnIds"
                        (cdkDropListDropped)="onTaskDrop($event, column.id)"
                      >
                        @for (task of column.tasks; track task.id) {
                          <div
                            class="kanban-card"
                            cdkDrag
                            [cdkDragData]="task"
                            [class.overdue]="isTaskOverdue(task)"
                            (click)="abrirTask(task)"
                          >
                            <!-- Drag Preview -->
                            <div class="kanban-card-preview" *cdkDragPreview>
                              <span class="preview-title">{{ task.title }}</span>
                            </div>

                            <!-- Card Content -->
                            <div class="kanban-card-header">
                              <div class="drag-handle-left" cdkDragHandle>
                                <span class="material-icons">drag_indicator</span>
                              </div>
                              <span class="task-title">{{ task.title }}</span>
                              <p-tag
                                [value]="getPriorityLabel(task.priority)"
                                [severity]="getPrioritySeverity(task.priority)"
                                styleClass="priority-tag"
                              />
                            </div>

                            @if (task.description) {
                              <p class="task-description">{{ task.description }}</p>
                            }

                            <!-- Progress -->
                            <div class="kanban-card-progress">
                              <div class="progress-bar-track">
                                <div
                                  class="progress-bar-fill"
                                  [style.width.%]="task.progress"
                                  [style.background-color]="getProgressColor(task.progress)"
                                ></div>
                              </div>
                              <span class="progress-text">{{ task.progress }}%</span>
                            </div>

                            <!-- Footer -->
                            <div class="kanban-card-footer">
                              <div class="task-meta">
                                <span class="task-type">
                                  <i class="pi" [ngClass]="getTaskTypeIcon(task.taskType)"></i>
                                  {{ getTaskTypeLabel(task.taskType) }}
                                </span>
                              </div>
                              <div class="task-dates" [class.overdue]="isTaskOverdue(task)">
                                <i class="pi pi-calendar"></i>
                                <span>{{ formatDate(task.dueDate) }}</span>
                                @if (isTaskOverdue(task)) {
                                  <i class="pi pi-exclamation-triangle overdue-icon"></i>
                                }
                              </div>
                            </div>

                          </div>
                        }

                        <!-- Empty State -->
                        @if (column.tasks.length === 0) {
                          <div class="kanban-empty-column">
                            <i class="pi pi-inbox"></i>
                            <span>Sin tareas</span>
                          </div>
                        }
                      </div>
                    </div>
                  }
                </div>
              </div>
            }

            <!-- CALENDARIO VIEW -->
            @if (activePlanningView() === 'calendario') {
              <div class="calendar-container">
                <!-- Calendar Stats -->
                <div class="calendar-stats">
                  <div class="stat-item">
                    <span class="stat-value">{{ calendarEvents().length }}</span>
                    <span class="stat-label">Total eventos</span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-value">{{ inProgressTasks }}</span>
                    <span class="stat-label">En progreso</span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-value">{{ overdueTasks }}</span>
                    <span class="stat-label">Vencidas</span>
                  </div>
                  <div class="calendar-legend">
                    <div class="legend-item">
                      <span class="legend-dot" style="background: #3b82f6"></span>
                      <span>En Progreso</span>
                    </div>
                    <div class="legend-item">
                      <span class="legend-dot" style="background: #10b981"></span>
                      <span>Completado</span>
                    </div>
                    <div class="legend-item">
                      <span class="legend-dot" style="background: #94a3b8"></span>
                      <span>Pendiente</span>
                    </div>
                    <div class="legend-item">
                      <span class="legend-dot" style="background: #ef4444"></span>
                      <span>Bloqueado</span>
                    </div>
                  </div>
                </div>

                <!-- FullCalendar -->
                <div class="calendar-wrapper">
                  <full-calendar [options]="calendarOptions()" />
                </div>
              </div>
            }
          </div>
        </p-tabpanel>

        <!-- Timeline Tab -->
        <p-tabpanel [value]="2">
          <div class="timeline-container">
            <p-card header="Timeline del Proyecto">
              @if (timelineEvents().length > 0) {
                <p-timeline [value]="timelineEvents()" align="alternate">
                  <ng-template pTemplate="content" let-event>
                    <div class="timeline-event">
                      <h4>{{ event.title }}</h4>
                      <p class="event-date">{{ event.date }}</p>
                      @if (event.description) {
                        <p class="event-description">{{ event.description }}</p>
                      }
                    </div>
                  </ng-template>
                  <ng-template pTemplate="opposite" let-event>
                    <span class="event-type">{{ event.type }}</span>
                  </ng-template>
                  <ng-template pTemplate="marker" let-event>
                    <span class="timeline-marker" [style.background-color]="event.color">
                      <i [class]="event.icon"></i>
                    </span>
                  </ng-template>
                </p-timeline>
              } @else {
                <div class="empty-state">
                  <i class="pi pi-history"></i>
                  <p>No hay eventos en el timeline</p>
                </div>
              }
            </p-card>
          </div>
        </p-tabpanel>

        <!-- Objetivos y KPIs Tab (estilo objetivos-kpis) -->
        <p-tabpanel [value]="3">
          <div class="objetivos-kpis-page">
            <!-- Toolbar -->
            <div class="page-toolbar">
              <div class="toolbar-left">
                <div class="search-input-wrapper">
                  <i class="pi pi-search"></i>
                  <input
                    type="text"
                    placeholder="Buscar objetivo..."
                    [ngModel]="kpiBusquedaObjetivos()"
                    (ngModelChange)="kpiBusquedaObjetivos.set($event)"
                  />
                </div>
              </div>
              <div class="toolbar-right">
                @if (modoObjetivos() === 'ver') {
                  <button class="btn-secondary" (click)="cambiarModoObjetivos('editar')">
                    <i class="pi pi-pencil"></i>
                    Editar
                  </button>
                } @else {
                  <button class="btn-secondary" (click)="cambiarModoObjetivos('ver')">
                    <i class="pi pi-times"></i>
                    Cancelar
                  </button>
                  <button class="btn-primary" (click)="guardarObjetivo()">
                    <i class="pi pi-check"></i>
                    Guardar
                  </button>
                }
              </div>
            </div>

            <!-- Main Content - Two Columns -->
            <div class="main-content">
              <!-- Left Column - Objectives List -->
              <div class="left-column">
                <div class="objetivos-list">
                  @for (objetivo of objetivosFiltrados(); track objetivo.id) {
                    <div
                      class="objetivo-item"
                      [class.selected]="kpiSelectedObjectiveId() === objetivo.id"
                      (click)="seleccionarObjetivo(objetivo.id)"
                    >
                      <div class="objetivo-header">
                        <span class="objetivo-nombre">{{ objetivo.nombre }}</span>
                        <span class="objetivo-tipo" [class]="objetivo.tipo">
                          {{ getTipoObjetivoLabel(objetivo.tipo) }}
                        </span>
                      </div>
                      <div class="objetivo-progress">
                        <div class="progress-bar">
                          <div
                            class="progress-fill"
                            [class]="getObjetivoProgresoColor(objetivo.progreso)"
                            [style.width.%]="objetivo.progreso"
                          ></div>
                        </div>
                        <span class="progress-value">{{ objetivo.progreso }}%</span>
                      </div>
                    </div>
                  } @empty {
                    <div class="empty-state">
                      <i class="pi pi-inbox"></i>
                      <p>No se encontraron objetivos</p>
                    </div>
                  }
                </div>
              </div>

              <!-- Right Column - Objective Detail -->
              <div class="right-column">
                @if (objetivoSeleccionado(); as objetivo) {
                  <!-- Detail Header -->
                  <div class="detail-header">
                    <h2 class="detail-title">Detalle del Objetivo</h2>
                    <div class="header-right">
                      @if (alertasActivasDelObjetivoCount() > 0) {
                        <span class="alertas-badge" [class.critical]="tieneAlertaCriticaActiva()">
                          <i class="pi pi-bell"></i>
                          {{ alertasActivasDelObjetivoCount() }}
                        </span>
                      }
                      @if (modoObjetivos() === 'editar') {
                        <button class="btn-eliminar" (click)="eliminarObjetivo()">
                          <i class="pi pi-trash"></i>
                        </button>
                      }
                    </div>
                  </div>

                  <!-- Tabs de navegación -->
                  <div class="detail-tabs">
                    <button
                      class="tab-btn"
                      [class.active]="kpiTabActivo() === 'kpis'"
                      (click)="kpiTabActivo.set('kpis')">
                      <i class="pi pi-chart-bar"></i>
                      KPIs
                      <span class="tab-count">{{ objetivo.kpis.length }}</span>
                    </button>
                    <button
                      class="tab-btn"
                      [class.active]="kpiTabActivo() === 'alertas'"
                      (click)="kpiTabActivo.set('alertas')">
                      <i class="pi pi-bell"></i>
                      Alertas
                      @if (alertasDelObjetivo().length > 0) {
                        <span class="tab-count" [class.has-active]="tieneAlertasActivas()">
                          {{ alertasDelObjetivo().length }}
                        </span>
                      }
                    </button>
                  </div>

                  <!-- Detail Content -->
                  <div class="detail-content">
                    @if (kpiTabActivo() === 'kpis') {
                      <!-- Nombre -->
                      <div class="detail-section">
                        <label class="detail-label">Nombre</label>
                        @if (editandoObjetivo()) {
                          <input
                            type="text"
                            class="detail-input"
                            [ngModel]="formObjetivoNombre()"
                            (ngModelChange)="formObjetivoNombre.set($event)"
                            placeholder="Nombre del objetivo"
                          />
                        } @else {
                          <p class="detail-value">{{ objetivo.nombre }}</p>
                        }
                      </div>

                      <!-- Descripción -->
                      <div class="detail-section">
                        <label class="detail-label">Descripción</label>
                        @if (editandoObjetivo()) {
                          <textarea
                            class="detail-textarea"
                            [ngModel]="formObjetivoDescripcion()"
                            (ngModelChange)="formObjetivoDescripcion.set($event)"
                            placeholder="Descripción del objetivo"
                            rows="3"
                          ></textarea>
                        } @else {
                          <p class="detail-value">{{ objetivo.descripcion || 'Sin descripción' }}</p>
                        }
                      </div>

                      <!-- Tipo -->
                      <div class="detail-section">
                        <label class="detail-label">Tipo</label>
                        @if (editandoObjetivo()) {
                          <select
                            class="detail-select"
                            [ngModel]="formObjetivoTipo()"
                            (ngModelChange)="formObjetivoTipo.set($event)"
                          >
                            <option value="estrategico">Estratégico</option>
                            <option value="operativo">Operativo</option>
                          </select>
                        } @else {
                          <span class="tipo-badge" [class]="objetivo.tipo">
                            {{ getTipoObjetivoLabel(objetivo.tipo) }}
                          </span>
                        }
                      </div>

                      <!-- Progreso -->
                      <div class="detail-section progress-section">
                        <div class="progress-header">
                          <label class="detail-label">Progreso</label>
                          <span class="progress-value-large">{{ objetivo.progreso }}%</span>
                        </div>
                        <div class="progress-bar-large">
                          <div
                            class="progress-fill"
                            [class]="getObjetivoProgresoColor(objetivo.progreso)"
                            [style.width.%]="objetivo.progreso"
                          ></div>
                        </div>
                      </div>

                      <!-- KPIs Section -->
                      <div class="kpis-section">
                        <div class="kpis-header">
                          <h3>KPIs Asociados</h3>
                          @if (editandoObjetivo() && !nuevoKPI() && !editandoKPIId()) {
                            <button class="btn-add-kpi" (click)="iniciarNuevoKPIForm()">
                              <i class="pi pi-plus"></i>
                              Agregar KPI
                            </button>
                          }
                        </div>

                        <div class="kpis-list">
                          <!-- New KPI Form -->
                          @if (nuevoKPI()) {
                            <div class="kpi-edit-row">
                              <div class="kpi-field nombre">
                                <label>Nombre</label>
                                <input
                                  type="text"
                                  class="kpi-input"
                                  [ngModel]="formKPINombre()"
                                  (ngModelChange)="formKPINombre.set($event)"
                                  placeholder="Nombre del KPI"
                                />
                              </div>
                              <div class="kpi-field actual">
                                <label>Actual</label>
                                <input
                                  type="number"
                                  class="kpi-input"
                                  [ngModel]="formKPIActual()"
                                  (ngModelChange)="formKPIActual.set($event)"
                                />
                              </div>
                              <div class="kpi-field meta">
                                <label>Meta</label>
                                <input
                                  type="number"
                                  class="kpi-input"
                                  [ngModel]="formKPIMeta()"
                                  (ngModelChange)="formKPIMeta.set($event)"
                                />
                              </div>
                              <div class="kpi-field escala">
                                <label>Escala</label>
                                <select
                                  class="kpi-input"
                                  [ngModel]="formKPIEscala()"
                                  (ngModelChange)="formKPIEscala.set($event)"
                                >
                                  @for (escala of escalasKPIOptions; track escala.value) {
                                    <option [value]="escala.value">{{ escala.label }}</option>
                                  }
                                </select>
                              </div>
                              <div class="kpi-field umbral">
                                <label>Umbral %</label>
                                <input
                                  type="number"
                                  class="kpi-input"
                                  [ngModel]="formKPIUmbralAlerta()"
                                  (ngModelChange)="formKPIUmbralAlerta.set($event)"
                                  min="0"
                                  max="100"
                                />
                              </div>
                              <div class="kpi-field direccion">
                                <label>Dirección</label>
                                <select
                                  class="kpi-input"
                                  [ngModel]="formKPIDireccion()"
                                  (ngModelChange)="formKPIDireccion.set($event)"
                                >
                                  @for (dir of direccionKPIOptions; track dir.value) {
                                    <option [value]="dir.value">{{ dir.label }}</option>
                                  }
                                </select>
                              </div>
                              <div class="kpi-actions">
                                <button class="btn-check" (click)="guardarKPIForm()">
                                  <i class="pi pi-check"></i>
                                </button>
                                <button class="btn-x" (click)="cancelarKPIForm()">
                                  <i class="pi pi-times"></i>
                                </button>
                              </div>
                              <!-- Configuración de alertas -->
                              <div class="kpi-alertas-config">
                                <div class="config-row">
                                  <div class="kpi-field umbral-max">
                                    <label>Umbral Máx %</label>
                                    <input
                                      type="number"
                                      class="kpi-input"
                                      [ngModel]="formKPIUmbralMaximo()"
                                      (ngModelChange)="formKPIUmbralMaximo.set($event)"
                                      min="0"
                                      max="100"
                                      placeholder="Opcional"
                                    />
                                  </div>
                                  <div class="kpi-field severidad">
                                    <label>Severidad</label>
                                    <select
                                      class="kpi-input"
                                      [ngModel]="formKPISeveridad()"
                                      (ngModelChange)="formKPISeveridad.set($event)">
                                      @for (sev of severidadKPIOptions; track sev.value) {
                                        <option [value]="sev.value">{{ sev.label }}</option>
                                      }
                                    </select>
                                  </div>
                                  <div class="kpi-field frecuencia">
                                    <label>Frecuencia</label>
                                    <select
                                      class="kpi-input"
                                      [ngModel]="formKPIFrecuencia()"
                                      (ngModelChange)="formKPIFrecuencia.set($event)">
                                      @for (freq of frecuenciaKPIOptions; track freq.value) {
                                        <option [value]="freq.value">{{ freq.label }}</option>
                                      }
                                    </select>
                                  </div>
                                </div>
                                <div class="config-row canales">
                                  <label class="config-label">Canales de Notificación</label>
                                  <div class="channels-group">
                                    <label class="channel-checkbox">
                                      <input
                                        type="checkbox"
                                        [checked]="isChannelSelected('email')"
                                        (change)="toggleChannel('email')"
                                      />
                                      <i class="pi pi-envelope"></i>
                                      Email
                                    </label>
                                    <label class="channel-checkbox">
                                      <input
                                        type="checkbox"
                                        [checked]="isChannelSelected('in-app')"
                                        (change)="toggleChannel('in-app')"
                                      />
                                      <i class="pi pi-bell"></i>
                                      In-App
                                    </label>
                                    <label class="channel-checkbox">
                                      <input
                                        type="checkbox"
                                        [checked]="isChannelSelected('webhook')"
                                        (change)="toggleChannel('webhook')"
                                      />
                                      <i class="pi pi-link"></i>
                                      Webhook
                                    </label>
                                  </div>
                                </div>
                              </div>
                            </div>
                          }

                          @for (kpi of objetivo.kpis; track kpi.id) {
                            @if (editandoKPIId() === kpi.id) {
                              <!-- Edit KPI Form -->
                              <div class="kpi-edit-row">
                                <div class="kpi-field nombre">
                                  <label>Nombre</label>
                                  <input
                                    type="text"
                                    class="kpi-input"
                                    [ngModel]="formKPINombre()"
                                    (ngModelChange)="formKPINombre.set($event)"
                                    placeholder="Nombre del KPI"
                                  />
                                </div>
                                <div class="kpi-field actual">
                                  <label>Actual</label>
                                  <input
                                    type="number"
                                    class="kpi-input"
                                    [ngModel]="formKPIActual()"
                                    (ngModelChange)="formKPIActual.set($event)"
                                  />
                                </div>
                                <div class="kpi-field meta">
                                  <label>Meta</label>
                                  <input
                                    type="number"
                                    class="kpi-input"
                                    [ngModel]="formKPIMeta()"
                                    (ngModelChange)="formKPIMeta.set($event)"
                                  />
                                </div>
                                <div class="kpi-field escala">
                                  <label>Escala</label>
                                  <select
                                    class="kpi-input"
                                    [ngModel]="formKPIEscala()"
                                    (ngModelChange)="formKPIEscala.set($event)"
                                  >
                                    @for (escala of escalasKPIOptions; track escala.value) {
                                      <option [value]="escala.value">{{ escala.label }}</option>
                                    }
                                  </select>
                                </div>
                                <div class="kpi-field umbral">
                                  <label>Umbral %</label>
                                  <input
                                    type="number"
                                    class="kpi-input"
                                    [ngModel]="formKPIUmbralAlerta()"
                                    (ngModelChange)="formKPIUmbralAlerta.set($event)"
                                    min="0"
                                    max="100"
                                  />
                                </div>
                                <div class="kpi-field direccion">
                                  <label>Dirección</label>
                                  <select
                                    class="kpi-input"
                                    [ngModel]="formKPIDireccion()"
                                    (ngModelChange)="formKPIDireccion.set($event)"
                                  >
                                    @for (dir of direccionKPIOptions; track dir.value) {
                                      <option [value]="dir.value">{{ dir.label }}</option>
                                    }
                                  </select>
                                </div>
                                <div class="kpi-actions">
                                  <button class="btn-check" (click)="guardarKPIForm()">
                                    <i class="pi pi-check"></i>
                                  </button>
                                  <button class="btn-x" (click)="cancelarKPIForm()">
                                    <i class="pi pi-times"></i>
                                  </button>
                                </div>
                                <!-- Configuración de alertas -->
                                <div class="kpi-alertas-config">
                                  <div class="config-row">
                                    <div class="kpi-field umbral-max">
                                      <label>Umbral Máx %</label>
                                      <input
                                        type="number"
                                        class="kpi-input"
                                        [ngModel]="formKPIUmbralMaximo()"
                                        (ngModelChange)="formKPIUmbralMaximo.set($event)"
                                        min="0"
                                        max="100"
                                        placeholder="Opcional"
                                      />
                                    </div>
                                    <div class="kpi-field severidad">
                                      <label>Severidad</label>
                                      <select
                                        class="kpi-input"
                                        [ngModel]="formKPISeveridad()"
                                        (ngModelChange)="formKPISeveridad.set($event)">
                                        @for (sev of severidadKPIOptions; track sev.value) {
                                          <option [value]="sev.value">{{ sev.label }}</option>
                                        }
                                      </select>
                                    </div>
                                    <div class="kpi-field frecuencia">
                                      <label>Frecuencia</label>
                                      <select
                                        class="kpi-input"
                                        [ngModel]="formKPIFrecuencia()"
                                        (ngModelChange)="formKPIFrecuencia.set($event)">
                                        @for (freq of frecuenciaKPIOptions; track freq.value) {
                                          <option [value]="freq.value">{{ freq.label }}</option>
                                        }
                                      </select>
                                    </div>
                                  </div>
                                  <div class="config-row canales">
                                    <label class="config-label">Canales de Notificación</label>
                                    <div class="channels-group">
                                      <label class="channel-checkbox">
                                        <input
                                          type="checkbox"
                                          [checked]="isChannelSelected('email')"
                                          (change)="toggleChannel('email')"
                                        />
                                        <i class="pi pi-envelope"></i>
                                        Email
                                      </label>
                                      <label class="channel-checkbox">
                                        <input
                                          type="checkbox"
                                          [checked]="isChannelSelected('in-app')"
                                          (change)="toggleChannel('in-app')"
                                        />
                                        <i class="pi pi-bell"></i>
                                        In-App
                                      </label>
                                      <label class="channel-checkbox">
                                        <input
                                          type="checkbox"
                                          [checked]="isChannelSelected('webhook')"
                                          (change)="toggleChannel('webhook')"
                                        />
                                        <i class="pi pi-link"></i>
                                        Webhook
                                      </label>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            } @else {
                              <!-- View KPI Row -->
                              <div class="kpi-view-row" [class.has-alert]="tieneAlertaKPI(kpi)">
                                <div class="kpi-info">
                                  <div class="kpi-nombre-row">
                                    <span class="kpi-nombre">{{ kpi.nombre }}</span>
                                    <span class="kpi-direccion-tag" [class]="kpi.direccion" [title]="kpi.direccion === 'mayor_mejor' ? 'Mejor si el valor es mayor' : 'Mejor si el valor es menor'">
                                      <i [class]="kpi.direccion === 'mayor_mejor' ? 'pi pi-arrow-up' : 'pi pi-arrow-down'"></i>
                                      {{ getDireccionLabel(kpi.direccion) }}
                                    </span>
                                    @if (tieneAlertaKPI(kpi)) {
                                      <span class="kpi-alert-badge" title="Por debajo del umbral ({{ kpi.umbralAlerta }}%)">
                                        <i class="pi pi-exclamation-triangle"></i>
                                        Alerta
                                      </span>
                                    }
                                  </div>
                                  <div class="kpi-progress">
                                    <div class="progress-bar">
                                      <div
                                        class="progress-fill"
                                        [class]="getObjetivoProgresoColor(getKPIProgreso(kpi))"
                                        [style.width.%]="getKPIProgreso(kpi)"
                                      ></div>
                                    </div>
                                    <span class="progress-text">{{ kpi.actual }}/{{ kpi.meta }} {{ kpi.escala }}</span>
                                  </div>
                                </div>
                                @if (editandoObjetivo()) {
                                  <div class="kpi-actions">
                                    <button class="btn-edit-small" (click)="iniciarEdicionKPIForm(kpi)">
                                      <i class="pi pi-pencil"></i>
                                    </button>
                                    <button class="btn-delete-small" (click)="eliminarKPIForm(kpi.id)">
                                      <i class="pi pi-trash"></i>
                                    </button>
                                  </div>
                                }
                              </div>
                            }
                          } @empty {
                            @if (!nuevoKPI()) {
                              <div class="kpis-empty">
                                <p>No hay KPIs asociados a este objetivo</p>
                              </div>
                            }
                          }
                        </div>
                      </div>
                    } @else {
                      <!-- Alertas Tab -->
                      <div class="alertas-section">
                        <!-- Toolbar de alertas -->
                        <div class="alertas-toolbar">
                          <div class="toolbar-left">
                            <div class="search-input-wrapper small">
                              <i class="pi pi-search"></i>
                              <input
                                type="text"
                                placeholder="Buscar alertas..."
                                [ngModel]="busquedaAlertas()"
                                (ngModelChange)="busquedaAlertas.set($event)"
                              />
                            </div>
                          </div>
                          <div class="toolbar-right">
                            <select
                              class="filter-select"
                              [ngModel]="filtroAlertaSeveridad()"
                              (ngModelChange)="filtroAlertaSeveridad.set($event)">
                              <option [ngValue]="null">Todas las severidades</option>
                              <option value="info">Info</option>
                              <option value="warning">Warning</option>
                              <option value="critical">Critical</option>
                            </select>
                            <select
                              class="filter-select"
                              [ngModel]="filtroAlertaStatus()"
                              (ngModelChange)="filtroAlertaStatus.set($event)">
                              <option [ngValue]="null">Todos los estados</option>
                              <option value="activa">Activas</option>
                              <option value="atendida">Atendidas</option>
                              <option value="resuelta">Resueltas</option>
                            </select>
                          </div>
                        </div>

                        <!-- Lista de alertas -->
                        <div class="alertas-list">
                          @for (alerta of alertasFiltradas(); track alerta.id) {
                            <div class="alerta-card" [class]="alerta.severity" [class.atendida]="alerta.status !== 'activa'">
                              <div class="alerta-severity-indicator"></div>
                              <div class="alerta-content">
                                <div class="alerta-header">
                                  <span class="alerta-kpi">{{ alerta.kpiNombre }}</span>
                                  <span class="alerta-severity-tag" [class]="alerta.severity">
                                    {{ getSeverityLabel(alerta.severity) }}
                                  </span>
                                  <span class="alerta-status-tag" [class]="alerta.status">
                                    {{ getAlertStatusLabel(alerta.status) }}
                                  </span>
                                </div>
                                <p class="alerta-mensaje">{{ alerta.mensaje }}</p>
                                <div class="alerta-meta">
                                  <span class="alerta-valor">
                                    <i class="pi pi-chart-line"></i>
                                    {{ alerta.valorActual }}% / {{ alerta.valorUmbral }}%
                                  </span>
                                  <span class="alerta-fecha">
                                    <i class="pi pi-clock"></i>
                                    {{ formatDateAlertas(alerta.fechaCreacion) }}
                                  </span>
                                </div>
                                @if (alerta.comentarioResolucion) {
                                  <div class="alerta-resolucion">
                                    <i class="pi pi-comment"></i>
                                    {{ alerta.comentarioResolucion }}
                                  </div>
                                }
                              </div>
                              <div class="alerta-actions-col">
                                @if (alerta.status === 'activa') {
                                  <button class="btn-atender" (click)="abrirAtenderAlerta(alerta)">
                                    <i class="pi pi-check"></i>
                                    Atender
                                  </button>
                                }
                                <button class="btn-historial" (click)="verHistorialKPI(alerta.kpiId)" pTooltip="Ver historial">
                                  <i class="pi pi-history"></i>
                                </button>
                              </div>
                            </div>
                          } @empty {
                            <div class="alertas-empty">
                              <i class="pi pi-check-circle"></i>
                              <p>No hay alertas para este objetivo</p>
                            </div>
                          }
                        </div>
                      </div>
                    }
                  </div>
                } @else {
                  <!-- No objective selected -->
                  <div class="no-selection">
                    <div class="no-selection-content">
                      <i class="pi pi-bullseye"></i>
                      <h3>Selecciona un objetivo</h3>
                      <p>Haz clic en un objetivo de la lista para ver sus KPIs y alertas asociadas</p>
                    </div>
                  </div>
                }
              </div>
            </div>
          </div>
        </p-tabpanel>
      </p-tabpanels>
    </p-tabs>
  } @else {
    <div class="error-state">
      <i class="pi pi-exclamation-triangle"></i>
      <h3>Proyecto no encontrado</h3>
      <p>El proyecto que buscas no existe o ha sido eliminado.</p>
      <p-button label="Volver a proyectos" icon="pi pi-arrow-left" (onClick)="volver()" />
    </div>
  }
</div>

<!-- Task Detail Drawer -->
<p-drawer
  [(visible)]="showTaskDrawer"
  [position]="'right'"
  [style]="{ width: '500px' }"
  [modal]="true"
  (onHide)="cerrarTaskDrawer()"
>
  <ng-template pTemplate="header">
    <div class="drawer-header">
      <h3>Detalle de Tarea</h3>
    </div>
  </ng-template>

  @if (selectedTask(); as task) {
    <div class="drawer-content">
      <!-- Info básica -->
      <div class="drawer-section">
        <div class="flex justify-content-between align-items-start mb-2">
          <h4 class="m-0">{{ task.title }}</h4>
          <p-button
            icon="pi pi-pencil"
            [rounded]="true"
            [text]="true"
            severity="secondary"
            pTooltip="Editar tarea"
            (onClick)="abrirFormularioEditarTarea(task)" />
        </div>
        @if (task.description) {
          <p class="description">{{ task.description }}</p>
        }
        <div class="tags-row mt-3">
          <p-tag
            [value]="getTaskStatusLabel(task.status)"
            [severity]="getTaskStatusSeverity(task.status)" />
          <p-tag
            [value]="getPriorityLabel(task.priority)"
            [severity]="getPrioritySeverity(task.priority)" />
          <p-tag
            [value]="getTaskTypeLabel(task.taskType)"
            severity="secondary" />
        </div>
      </div>

      <p-divider />

      <!-- Progreso -->
      <div class="drawer-section">
        <h5>Progreso</h5>
        <div class="progress-big">
          <p-progressBar [value]="task.progress" [showValue]="true" />
        </div>
        <div class="progress-slider mt-3">
          <span class="text-sm text-500">Actualizar progreso:</span>
          <p-slider
            [ngModel]="task.progress"
            (ngModelChange)="actualizarProgresoTarea(task, $event)"
            [step]="5"
            [style]="{ width: '100%' }" />
        </div>
      </div>

      <p-divider />

      <!-- Información -->
      <div class="drawer-section">
        <h5>Información</h5>
        <div class="info-grid">
          <div class="info-item">
            <span class="label">Fase</span>
            <span class="value">{{ task.phase?.name || 'Sin fase' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Responsable</span>
            <span class="value">{{ task.assignedTo }}</span>
          </div>
          <div class="info-item">
            <span class="label">Fecha inicio</span>
            <span class="value">{{ formatDate(task.startDate) }}</span>
          </div>
          <div class="info-item">
            <span class="label">Vencimiento</span>
            <span class="value" [class.overdue]="isTaskOverdue(task)">
              {{ formatDate(task.dueDate) }}
              @if (isTaskOverdue(task)) {
                <i class="pi pi-exclamation-triangle text-red-500 ml-1"></i>
              }
            </span>
          </div>
          @if (task.estimatedHours) {
            <div class="info-item">
              <span class="label">Horas estimadas</span>
              <span class="value">{{ task.estimatedHours }}h</span>
            </div>
          }
          @if (task.actualHours) {
            <div class="info-item">
              <span class="label">Horas reales</span>
              <span class="value">{{ task.actualHours }}h</span>
            </div>
          }
        </div>
      </div>

      <p-divider />

      <!-- Cambiar Estado -->
      <div class="drawer-section">
        <h5>Cambiar Estado</h5>
        <div class="status-buttons">
          @for (status of taskStatusOptions; track status.value) {
            <p-button
              [label]="status.label"
              [severity]="task.status === status.value ? 'primary' : 'secondary'"
              [outlined]="task.status !== status.value"
              size="small"
              (onClick)="cambiarStatusTask(task.id, status.value)" />
          }
        </div>
      </div>

      <p-divider />

      <!-- Acciones -->
      <div class="drawer-section">
        <div class="flex gap-2">
          <p-button
            label="Editar"
            icon="pi pi-pencil"
            severity="secondary"
            [outlined]="true"
            [style]="{ flex: 1 }"
            (onClick)="abrirFormularioEditarTarea(task)" />
          <p-button
            label="Eliminar"
            icon="pi pi-trash"
            severity="danger"
            [outlined]="true"
            [style]="{ flex: 1 }"
            (onClick)="confirmarEliminarTarea(task)" />
        </div>
      </div>
    </div>
  }
</p-drawer>

<!-- Task Form Drawer (Crear/Editar) -->
<p-drawer
  [(visible)]="showTaskFormDrawer"
  [position]="'right'"
  [style]="{ width: '500px' }"
  [modal]="true"
  (onHide)="cerrarFormularioTarea()"
>
  <ng-template pTemplate="header">
    <div class="drawer-header">
      <h3>{{ isEditingTask() ? 'Editar Tarea' : 'Nueva Tarea' }}</h3>
    </div>
  </ng-template>

  <div class="drawer-content">
    @if (taskFormData(); as form) {
      <!-- Título -->
      <div class="field">
        <label for="taskTitle">Título *</label>
        <input
          id="taskTitle"
          type="text"
          pInputText
          [ngModel]="form.title"
          (ngModelChange)="updateTaskFormField('title', $event)"
          placeholder="Título de la tarea"
          class="w-full" />
      </div>

      <!-- Descripción -->
      <div class="field">
        <label for="taskDescription">Descripción</label>
        <textarea
          id="taskDescription"
          pTextarea
          [ngModel]="form.description"
          (ngModelChange)="updateTaskFormField('description', $event)"
          placeholder="Descripción de la tarea"
          [rows]="3"
          class="w-full">
        </textarea>
      </div>

      <!-- Fase -->
      <div class="field">
        <label for="taskPhase">Fase *</label>
        <p-select
          id="taskPhase"
          [options]="phaseOptions()"
          [ngModel]="form.phaseId"
          (ngModelChange)="updateTaskFormField('phaseId', $event)"
          optionLabel="label"
          optionValue="value"
          placeholder="Seleccionar fase"
          [style]="{ width: '100%' }" />
      </div>

      <!-- Tipo de tarea -->
      <div class="field">
        <label for="taskType">Tipo de tarea</label>
        <p-select
          id="taskType"
          [options]="taskTypeOptions"
          [ngModel]="form.taskType"
          (ngModelChange)="updateTaskFormField('taskType', $event)"
          optionLabel="label"
          optionValue="value"
          placeholder="Seleccionar tipo"
          [style]="{ width: '100%' }" />
      </div>

      <!-- Prioridad -->
      <div class="field">
        <label for="taskPriority">Prioridad</label>
        <p-select
          id="taskPriority"
          [options]="priorityOptions"
          [ngModel]="form.priority"
          (ngModelChange)="updateTaskFormField('priority', $event)"
          optionLabel="label"
          optionValue="value"
          placeholder="Seleccionar prioridad"
          [style]="{ width: '100%' }" />
      </div>

      <!-- Fechas -->
      <div class="grid">
        <div class="col-6">
          <div class="field">
            <label for="taskStartDate">Fecha inicio</label>
            <p-datepicker
              id="taskStartDate"
              [ngModel]="form.startDate"
              (ngModelChange)="updateTaskFormField('startDate', $event)"
              dateFormat="yy-mm-dd"
              [showIcon]="true"
              [style]="{ width: '100%' }" />
          </div>
        </div>
        <div class="col-6">
          <div class="field">
            <label for="taskDueDate">Fecha vencimiento</label>
            <p-datepicker
              id="taskDueDate"
              [ngModel]="form.dueDate"
              (ngModelChange)="updateTaskFormField('dueDate', $event)"
              dateFormat="yy-mm-dd"
              [showIcon]="true"
              [style]="{ width: '100%' }" />
          </div>
        </div>
      </div>

      <!-- Horas estimadas -->
      <div class="field">
        <label for="taskHours">Horas estimadas</label>
        <p-inputnumber
          id="taskHours"
          [ngModel]="form.estimatedHours"
          (ngModelChange)="updateTaskFormField('estimatedHours', $event)"
          [min]="0"
          [max]="999"
          suffix=" horas"
          [style]="{ width: '100%' }" />
      </div>

      <!-- Botones -->
      <div class="flex gap-2 mt-4">
        <p-button
          label="Cancelar"
          severity="secondary"
          [outlined]="true"
          [style]="{ flex: 1 }"
          (onClick)="cerrarFormularioTarea()" />
        <p-button
          [label]="isEditingTask() ? 'Actualizar' : 'Crear'"
          icon="pi pi-check"
          [style]="{ flex: 1 }"
          (onClick)="guardarTarea()" />
      </div>
    }
  </div>
</p-drawer>

<!-- Atender Alerta Dialog -->
<p-dialog
  header="Atender Alerta"
  [(visible)]="showAtenderAlertaDialog"
  [modal]="true"
  [style]="{ width: '450px' }"
  [closable]="true"
  (onHide)="cancelarAtencion()"
>
  @if (alertaParaAtender(); as alerta) {
    <div class="atender-alerta-content">
      <div class="alerta-summary">
        <div class="summary-row">
          <span class="label">KPI:</span>
          <span class="value">{{ alerta.kpiNombre }}</span>
        </div>
        <div class="summary-row">
          <span class="label">Severidad:</span>
          <span class="severity-tag" [class]="alerta.severity">
            {{ getSeverityLabel(alerta.severity) }}
          </span>
        </div>
        <div class="summary-row">
          <span class="label">Valor actual:</span>
          <span class="value">{{ alerta.valorActual }}%</span>
        </div>
        <div class="summary-row">
          <span class="label">Umbral:</span>
          <span class="value">{{ alerta.valorUmbral }}%</span>
        </div>
      </div>

      <div class="comentario-section">
        <label class="detail-label">Comentario de atención</label>
        <textarea
          class="detail-textarea"
          [ngModel]="comentarioAtencion()"
          (ngModelChange)="comentarioAtencion.set($event)"
          placeholder="Describe las acciones tomadas para atender esta alerta..."
          rows="4"
        ></textarea>
      </div>
    </div>
  }
  <ng-template pTemplate="footer">
    <button class="btn-cancelar" (click)="cancelarAtencion()">
      Cancelar
    </button>
    <button
      class="btn-primary"
      [disabled]="!comentarioAtencion()"
      (click)="confirmarAtencion()"
    >
      <i class="pi pi-check"></i>
      Confirmar Atención
    </button>
  </ng-template>
</p-dialog>

<p-toast />
<p-confirmDialog />
