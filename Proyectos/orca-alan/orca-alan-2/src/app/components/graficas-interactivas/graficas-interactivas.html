<div class="graficas-interactivas-container" [class.dark-mode]="tema() === 'dark'" [class.modo-widget]="modoWidget">
  <!-- Panel de Configuración (solo si no está en modo widget) -->
  @if (!modoWidget) {
  <div class="config-panel">
    <div class="config-header">
      <h3><i class="pi pi-cog mr-2"></i>Configuración de Gráfica</h3>
      <div class="config-header-actions">
        <p-button
          icon="pi pi-save"
          [rounded]="true"
          [text]="true"
          severity="success"
          (onClick)="abrirDialogGuardar()"
          pTooltip="Guardar configuración"
          tooltipPosition="top" />
      </div>
    </div>

    <!-- Tabs de configuración -->
    <div class="config-tabs">
      <button
        class="config-tab"
        [class.active]="tabActivo() === 'config'"
        (click)="tabActivo.set('config')">
        <i class="pi pi-sliders-h"></i>
        <span>Config</span>
      </button>
      <button
        class="config-tab"
        [class.active]="tabActivo() === 'guardadas'"
        (click)="tabActivo.set('guardadas')">
        <i class="pi pi-bookmark"></i>
        <span>Guardadas</span>
        @if (configuracionesGuardadas().length > 0) {
          <span class="tab-badge">{{ configuracionesGuardadas().length }}</span>
        }
      </button>
      <button
        class="config-tab asistente-tab"
        [class.active]="tabActivo() === 'asistente'"
        (click)="tabActivo.set('asistente')">
        <i class="pi pi-sparkles"></i>
        <span>IA</span>
      </button>
    </div>

    <!-- Tab de Configuración -->
    @if (tabActivo() === 'config') {
    <div class="config-body">
      <!-- PASO 1: Tipo de Gráfica -->
      <div class="config-section">
        <div class="step-header">
          <span class="step-number">1</span>
          <h4><i class="pi pi-chart-pie mr-2"></i>Tipo de Gráfica</h4>
        </div>

        <div class="config-field">
          <p-select
            [options]="tiposGraficaFlat()"
            [ngModel]="tipoGrafica()"
            (ngModelChange)="cambiarTipo($event)"
            optionLabel="label"
            optionValue="value"
            placeholder="Seleccionar tipo de gráfica"
            appendTo="body"
            [style]="{ width: '100%' }">
            <ng-template let-option pTemplate="item">
              <div class="tipo-option">
                <i [class]="getTipoIcon(option.value)" class="mr-2"></i>
                <span>{{ option.label }}</span>
                <small class="tipo-group">({{ option.group }})</small>
              </div>
            </ng-template>
            <ng-template let-option pTemplate="selectedItem">
              <div class="tipo-option">
                <i [class]="getTipoIcon(option.value)" class="mr-2"></i>
                <span>{{ option.label }}</span>
              </div>
            </ng-template>
          </p-select>
        </div>

        <!-- Asistente en Accordion colapsable -->
        <p-accordion [multiple]="true" styleClass="asistente-accordion">
          <p-accordionpanel value="asistente">
            <p-accordionheader>
              <span class="accordion-header-content">
                <i class="pi pi-sparkles mr-2"></i>
                Asistente de Visualización
              </span>
            </p-accordionheader>
            <p-accordioncontent>
              <div class="asistente-content">
                @for (rec of recomendacionesAsistente(); track rec.titulo) {
                  <div class="asistente-item" [class]="'asistente-' + rec.tipo">
                    <div class="asistente-icon">
                      <i [class]="rec.icono"></i>
                    </div>
                    <div class="asistente-texto">
                      <span class="asistente-titulo">{{ rec.titulo }}</span>
                      <p class="asistente-mensaje">{{ rec.mensaje }}</p>
                    </div>
                  </div>
                }
              </div>
            </p-accordioncontent>
          </p-accordionpanel>
        </p-accordion>
      </div>

      <p-divider />

      <!-- PASO 2: Selección de Datos -->
      <div class="config-section">
        <div class="step-header">
          <span class="step-number">2</span>
          <h4><i class="pi pi-database mr-2"></i>Datos</h4>
        </div>

        <!-- Eje X / Categorías (siempre visible) -->
        <div class="config-field">
          <label>
            @if (esGraficaCircular()) {
              Categorías (segmentos)
            } @else {
              Eje X (Categorías)
            }
          </label>
          <p-select
            [options]="camposDisponibles"
            [ngModel]="campoEjeX()"
            (ngModelChange)="onCampoChange($event)"
            optionLabel="label"
            optionValue="value"
            placeholder="Seleccionar campo"
            appendTo="body"
            [style]="{ width: '100%' }">
            <ng-template let-option pTemplate="item">
              <div class="campo-option">
                <span class="campo-label">{{ option.label }}</span>
                <div class="campo-info-tags">
                  @if (option.conteo !== undefined && option.conteo !== null) {
                    <span class="campo-conteo" [class.sin-datos]="option.conteo === 0">
                      {{ option.conteo }} {{ option.conteo === 1 ? 'item' : 'items' }}
                    </span>
                  }
                  <p-tag
                    [value]="option.tipo"
                    [severity]="option.tipo === 'categoria' ? 'info' : option.tipo === 'numerico' ? 'success' : 'warn'"
                    styleClass="campo-tipo-tag" />
                </div>
              </div>
            </ng-template>
            <ng-template let-option pTemplate="selectedItem">
              <div class="campo-option">
                <span>{{ option.label }}</span>
                @if (option.conteo !== undefined && option.conteo !== null) {
                  <span class="campo-conteo-selected">{{ option.conteo }} items</span>
                }
              </div>
            </ng-template>
          </p-select>
          <small class="field-hint">{{ getCampoDescripcion(campoEjeX()) }}</small>
        </div>

        <!-- Eje Y (solo si es necesario) -->
        @if (necesitaEjeY()) {
          <div class="config-field">
            <label>Eje Y (Valores)</label>
            <p-select
              [options]="camposNumericos()"
              [ngModel]="campoEjeY()"
              (ngModelChange)="campoEjeY.set($event)"
              optionLabel="label"
              optionValue="value"
              placeholder="Seleccionar campo numérico"
              appendTo="body"
              [style]="{ width: '100%' }">
              <ng-template let-option pTemplate="item">
                <div class="campo-option">
                  <span class="campo-label">{{ option.label }}</span>
                  <div class="campo-info-tags">
                    @if (option.conteo !== undefined && option.conteo !== null) {
                      <span class="campo-conteo" [class.sin-datos]="option.conteo === 0">
                        {{ option.conteo }} {{ option.conteo === 1 ? 'item' : 'items' }}
                      </span>
                    }
                    <p-tag
                      [value]="option.tipo"
                      [severity]="option.tipo === 'numerico' ? 'success' : 'info'"
                      styleClass="campo-tipo-tag" />
                  </div>
                </div>
              </ng-template>
              <ng-template let-option pTemplate="selectedItem">
                <div class="campo-option">
                  <span>{{ option.label }}</span>
                  @if (option.conteo !== undefined && option.conteo !== null) {
                    <span class="campo-conteo-selected">{{ option.conteo }} items</span>
                  }
                </div>
              </ng-template>
            </p-select>
            <small class="field-hint">Campo numérico para el eje vertical</small>
          </div>
        }

        <!-- Campos recomendados en Accordion -->
        @if (camposRecomendados().length > 0) {
          <p-accordion styleClass="campos-accordion">
            <p-accordionpanel value="campos">
              <p-accordionheader>
                <span class="accordion-header-content">
                  <i class="pi pi-lightbulb mr-2"></i>
                  Campos recomendados
                </span>
              </p-accordionheader>
              <p-accordioncontent>
                <div class="recomendados-chips">
                  @for (campo of camposRecomendados(); track campo.value) {
                    <button
                      class="campo-chip"
                      [class.active]="campoEjeX() === campo.value"
                      [class.sin-datos]="campo.conteo === 0"
                      (click)="onCampoChange(campo.value)"
                      pTooltip="{{ campo.descripcion }}"
                      tooltipPosition="top">
                      {{ campo.label }}
                      @if (campo.conteo !== undefined && campo.conteo !== null) {
                        <span class="chip-count">{{ campo.conteo }}</span>
                      }
                    </button>
                  }
                </div>
              </p-accordioncontent>
            </p-accordionpanel>
          </p-accordion>
        }
      </div>

      <p-divider />

      <!-- PASO 3: Colores -->
      <div class="config-section">
        <div class="step-header">
          <span class="step-number">3</span>
          <h4><i class="pi pi-palette mr-2"></i>Colores</h4>
        </div>

        <div class="config-field">
          <p-select
            [options]="paletasOptions"
            [ngModel]="paletaSeleccionada()"
            (ngModelChange)="cambiarPaleta($event)"
            optionLabel="label"
            optionValue="value"
            placeholder="Seleccionar paleta"
            appendTo="body"
            [style]="{ width: '100%' }">
            <ng-template let-option pTemplate="item">
              <div class="paleta-option">
                <div class="paleta-colores">
                  @for (color of paletas[option.value].slice(0, 5); track $index) {
                    <span class="color-dot" [style.background]="color"></span>
                  }
                </div>
                <div class="paleta-info">
                  <span class="paleta-nombre">{{ option.label }}</span>
                  <small class="paleta-desc">{{ option.descripcion }}</small>
                </div>
              </div>
            </ng-template>
            <ng-template let-option pTemplate="selectedItem">
              <div class="paleta-option-selected">
                <div class="paleta-colores">
                  @for (color of paletas[option.value].slice(0, 5); track $index) {
                    <span class="color-dot" [style.background]="color"></span>
                  }
                </div>
                <span>{{ option.label }}</span>
              </div>
            </ng-template>
          </p-select>
        </div>
      </div>

      <p-divider />

      <!-- PASO 4: Opciones -->
      <div class="config-section">
        <div class="step-header">
          <span class="step-number">4</span>
          <h4><i class="pi pi-sliders-h mr-2"></i>Opciones</h4>
        </div>

        <div class="opciones-toggles tres-items">
          <div class="toggle-item" [class.active]="animaciones()" (click)="toggleAnimaciones()">
            <i class="pi pi-play"></i>
            <span>Animaciones</span>
          </div>
          <div class="toggle-item" [class.active]="mostrarLeyenda()" (click)="toggleLeyenda()">
            <i class="pi pi-list"></i>
            <span>Leyenda</span>
          </div>
          <div class="toggle-item" [class.active]="mostrarDataLabels()" (click)="toggleDataLabels()">
            <i class="pi pi-tag"></i>
            <span>Etiquetas</span>
          </div>
        </div>
      </div>
    </div>
    }

    <!-- Tab de Configuraciones Guardadas -->
    @if (tabActivo() === 'guardadas') {
    <div class="config-body guardadas-body">
      @if (configuracionesGuardadas().length === 0 && !mostrarDialogGuardar()) {
        <div class="empty-guardadas">
          <i class="pi pi-bookmark"></i>
          <h4>No hay configuraciones guardadas</h4>
          <p>Guarda tu configuración actual para reutilizarla después</p>
          <p-button
            label="Guardar actual"
            icon="pi pi-save"
            severity="success"
            (onClick)="abrirDialogGuardar()" />
        </div>
      } @else {
        <!-- Formulario de guardar inline -->
        @if (mostrarDialogGuardar()) {
          <div class="guardar-inline">
            <div class="guardar-inline-header">
              <h4><i class="pi pi-save mr-2"></i>Nueva configuración</h4>
              <p-button
                icon="pi pi-times"
                [rounded]="true"
                [text]="true"
                size="small"
                (onClick)="cerrarDialogGuardar()" />
            </div>
            <div class="guardar-inline-body">
              <div class="guardar-field">
                <label for="nombreConfig">Nombre *</label>
                <input
                  pInputText
                  id="nombreConfig"
                  [ngModel]="nombreConfiguracion()"
                  (ngModelChange)="nombreConfiguracion.set($event)"
                  placeholder="Ej: Riesgos por estado"
                  class="w-full" />
              </div>
              <div class="guardar-field">
                <label for="descConfig">Descripción</label>
                <input
                  pInputText
                  id="descConfig"
                  [ngModel]="descripcionConfiguracion()"
                  (ngModelChange)="descripcionConfiguracion.set($event)"
                  placeholder="Opcional..."
                  class="w-full" />
              </div>
              <div class="guardar-preview">
                <div class="preview-tags">
                  <p-tag [value]="getTipoLabel(tipoGrafica())" severity="info" />
                  <p-tag [value]="campoEjeX()" severity="secondary" />
                  <p-tag [value]="paletaSeleccionada() | titlecase" severity="warn" />
                </div>
              </div>
              <div class="guardar-actions">
                <p-button
                  label="Guardar"
                  icon="pi pi-check"
                  severity="success"
                  size="small"
                  [disabled]="!nombreConfiguracion().trim()"
                  (onClick)="guardarConfiguracionActual()" />
              </div>
            </div>
          </div>
        }

        <!-- Lista de configuraciones -->
        @if (configuracionesGuardadas().length > 0) {
          <div class="guardadas-list">
            @for (config of configuracionesGuardadas(); track config.id) {
              <div class="guardada-item">
                <div class="guardada-info">
                  <div class="guardada-header">
                    <span class="guardada-nombre">{{ config.nombre }}</span>
                    <p-tag
                      [value]="getTipoLabel(config.configuracion.tipoGrafica)"
                      severity="info"
                      styleClass="guardada-tipo" />
                  </div>
                  @if (config.descripcion) {
                    <p class="guardada-desc">{{ config.descripcion }}</p>
                  }
                  <div class="guardada-meta">
                    <span class="guardada-fecha">
                      <i class="pi pi-calendar"></i>
                      {{ formatFecha(config.fechaCreacion) }}
                    </span>
                    <span class="guardada-paleta">
                      <i class="pi pi-palette"></i>
                      {{ config.configuracion.paleta | titlecase }}
                    </span>
                  </div>
                </div>
                <div class="guardada-actions">
                  <p-button
                    icon="pi pi-upload"
                    [rounded]="true"
                    severity="success"
                    pTooltip="Cargar configuración"
                    tooltipPosition="top"
                    (onClick)="cargarConfiguracion(config)" />
                  <p-button
                    icon="pi pi-trash"
                    [rounded]="true"
                    severity="danger"
                    [text]="true"
                    pTooltip="Eliminar"
                    tooltipPosition="top"
                    (onClick)="eliminarConfiguracion(config.id)" />
                </div>
              </div>
            }
          </div>
        }
      }
    </div>
    }

    <!-- Tab de Asistente IA -->
    @if (tabActivo() === 'asistente') {
    <div class="asistente-panel">
      <!-- Header del asistente -->
      <div class="asistente-header">
        <div class="asistente-avatar">
          <i class="pi pi-sparkles"></i>
        </div>
        <div class="asistente-info">
          <span class="asistente-nombre">Asistente de Gráficas</span>
          <span class="asistente-status">
            @if (asistenteEscribiendo()) {
              <span class="typing-indicator">Escribiendo...</span>
            } @else {
              Listo para ayudarte
            }
          </span>
        </div>
        @if (mensajesAsistente().length > 0) {
          <p-button
            icon="pi pi-trash"
            [rounded]="true"
            [text]="true"
            size="small"
            severity="secondary"
            pTooltip="Limpiar chat"
            tooltipPosition="top"
            (onClick)="limpiarChatAsistente()" />
        }
      </div>

      <!-- Área de mensajes -->
      <div class="asistente-mensajes">
        @if (mensajesAsistente().length === 0) {
          <!-- Estado vacío con sugerencias -->
          <div class="asistente-welcome">
            <div class="welcome-icon">
              <i class="pi pi-sparkles"></i>
            </div>
            <h4>¿Cómo puedo ayudarte?</h4>
            <p>Descríbeme qué gráfica necesitas y la configuraré por ti</p>
            <div class="sugerencias-list">
              @for (sugerencia of sugerenciasPredefinidas; track $index) {
                <button class="sugerencia-chip" (click)="usarSugerencia(sugerencia)">
                  {{ sugerencia }}
                </button>
              }
            </div>
          </div>
        } @else {
          <!-- Mensajes del chat -->
          @for (msg of mensajesAsistente(); track msg.id) {
            <div class="mensaje-wrapper" [class.user]="msg.tipo === 'user'">
              <div class="mensaje-bubble" [class.user]="msg.tipo === 'user'" [class.assistant]="msg.tipo === 'assistant'">
                <div class="mensaje-contenido">{{ msg.mensaje }}</div>
                @if (msg.configuracionSugerida) {
                  <div class="mensaje-config-preview">
                    <div class="config-tags">
                      @if (msg.configuracionSugerida.tipoGrafica) {
                        <p-tag [value]="getTipoLabel(msg.configuracionSugerida.tipoGrafica)" severity="info" />
                      }
                      @if (msg.configuracionSugerida.campoEjeX) {
                        <p-tag [value]="msg.configuracionSugerida.campoEjeX" severity="secondary" />
                      }
                      @if (msg.configuracionSugerida.paleta) {
                        <p-tag [value]="msg.configuracionSugerida.paleta | titlecase" severity="warn" />
                      }
                      @if (msg.configuracionSugerida.filtro) {
                        <p-tag [value]="'Filtro: ' + msg.configuracionSugerida.filtro.valor" severity="danger" icon="pi pi-filter" />
                      }
                    </div>
                    <p-button
                      label="Aplicar"
                      icon="pi pi-check"
                      severity="success"
                      size="small"
                      (onClick)="aplicarConfiguracionSugerida(msg.configuracionSugerida)" />
                  </div>
                }
              </div>
              <span class="mensaje-hora">{{ formatHoraAsistente(msg.fecha) }}</span>
            </div>
          }

          <!-- Indicador de escritura -->
          @if (asistenteEscribiendo()) {
            <div class="mensaje-wrapper">
              <div class="mensaje-bubble assistant typing">
                <div class="typing-dots">
                  <span></span>
                  <span></span>
                  <span></span>
                </div>
              </div>
            </div>
          }
        }
      </div>

      <!-- Input del asistente -->
      <div class="asistente-input">
        <input
          pInputText
          [ngModel]="inputAsistente()"
          (ngModelChange)="inputAsistente.set($event)"
          placeholder="Describe la gráfica que necesitas..."
          (keyup.enter)="enviarMensajeAsistente()"
          class="w-full" />
        <p-button
          icon="pi pi-send"
          [rounded]="true"
          severity="success"
          [disabled]="!inputAsistente().trim() || asistenteEscribiendo()"
          (onClick)="enviarMensajeAsistente()" />
      </div>
    </div>
    }
  </div>
  }

  <!-- Área de la Gráfica -->
  <div class="chart-area">
    <div class="chart-header">
      <div class="chart-info">
        @if (filtroActivo()) {
          <p-tag
            [value]="'Filtro: ' + filtroActivo()!.valor"
            severity="danger"
            icon="pi pi-filter"
            styleClass="filtro-tag"
            [style]="{ cursor: 'pointer' }"
            pTooltip="Clic para quitar filtro"
            tooltipPosition="top"
            (click)="quitarFiltro()" />
        }
        <span class="chart-title">{{ titulo }}</span>
        @if (subtitulo) {
          <span class="chart-subtitle">{{ subtitulo }}</span>
        }
      </div>
      <div class="chart-actions">
        <!-- Configurar widget (solo en modo widget) -->
        @if (modoWidget) {
          <p-button
            icon="pi pi-cog"
            [rounded]="true"
            [text]="true"
            (onClick)="configClick.emit()"
            pTooltip="Configurar gráfica"
            tooltipPosition="top" />
        }
        <!-- Anotaciones -->
        <p-button
          icon="pi pi-comments"
          [rounded]="true"
          [text]="true"
          (onClick)="abrirDialogAnotacion()"
          pTooltip="Agregar anotación"
          tooltipPosition="top" />
        <!-- Comparación temporal -->
        <p-button
          icon="pi pi-calendar"
          [rounded]="true"
          [text]="true"
          [severity]="comparacionTemporal().habilitada ? 'success' : 'secondary'"
          (onClick)="abrirDialogComparacion()"
          pTooltip="Comparación temporal"
          tooltipPosition="top" />
        <p-button
          icon="pi pi-refresh"
          [rounded]="true"
          [text]="true"
          (onClick)="resetZoom()"
          pTooltip="Resetear zoom"
          tooltipPosition="top" />
        <!-- Exportar con menú contextual -->
        <p-button
          icon="pi pi-download"
          [rounded]="true"
          [text]="true"
          (onClick)="exportMenu.toggle($event)"
          pTooltip="Exportar gráfica"
          tooltipPosition="top" />
        <p-menu #exportMenu [model]="exportMenuItems" [popup]="true" appendTo="body" />
      </div>
    </div>

    <!-- Drill-down breadcrumbs -->
    @if (drillDownStack().length > 0) {
      <div class="drilldown-breadcrumbs">
        <button class="breadcrumb-item home" (click)="limpiarDrillDown()">
          <i class="pi pi-home"></i>
        </button>
        @for (item of drillDownStack(); track $index) {
          <i class="pi pi-chevron-right breadcrumb-separator"></i>
          <button class="breadcrumb-item" (click)="navegarDrillDown($index)">
            {{ item.valor }}
          </button>
        }
        <button class="breadcrumb-back" (click)="salirDrillDown()" pTooltip="Volver">
          <i class="pi pi-arrow-left"></i>
        </button>
      </div>
    }

    <div class="chart-container" #chartContainer
         (contextmenu)="onChartContextMenu($event)"
         (mousedown)="onChartMouseDown($event)">
      @if (datosSignal().labels.length > 0) {
        <!-- Usar ApexCharts para gráficas avanzadas (Funnel, TreeMap, RadialBar, etc.) -->
        @if (usarApexCharts()) {
          <apx-chart
            [series]="apexChartOptions().series"
            [chart]="apexChartOptions().chart"
            [xaxis]="apexChartOptions().xaxis!"
            [dataLabels]="apexChartOptions().dataLabels!"
            [plotOptions]="apexChartOptions().plotOptions!"
            [legend]="apexChartOptions().legend!"
            [colors]="apexChartOptions().colors!"
            [labels]="apexChartOptions().labels!" />
        } @else {
          <!-- Usar Chart.js (PrimeNG) para gráficas básicas -->
          <p-chart
            [type]="chartType()"
            [data]="chartData()"
            [options]="chartOptions()"
            [style]="{ width: '100%', height: '100%' }" />
        }
      } @else {
        <div class="no-data-message">
          <i class="pi pi-chart-bar"></i>
          <span>Sin datos para mostrar</span>
        </div>
      }
    </div>

    <!-- Menú contextual para drill-down -->
    <p-contextMenu #drillDownMenu [model]="contextMenuItems()" appendTo="body"></p-contextMenu>

    <!-- Lista de anotaciones -->
    @if (anotaciones().length > 0) {
      <div class="anotaciones-list">
        <div class="anotaciones-header">
          <span><i class="pi pi-comments mr-2"></i>Anotaciones ({{ anotaciones().length }})</span>
        </div>
        @for (anotacion of anotaciones(); track anotacion.id) {
          <div class="anotacion-item" [style.border-left-color]="anotacion.color">
            <div class="anotacion-contenido">
              <span class="anotacion-texto">{{ anotacion.texto }}</span>
              <span class="anotacion-meta">{{ anotacion.autor }} - {{ formatFecha(anotacion.fecha) }}</span>
            </div>
            <div class="anotacion-acciones">
              <button class="anotacion-btn" (click)="editarAnotacion(anotacion)">
                <i class="pi pi-pencil"></i>
              </button>
              <button class="anotacion-btn delete" (click)="eliminarAnotacion(anotacion.id)">
                <i class="pi pi-trash"></i>
              </button>
            </div>
          </div>
        }
      </div>
    }

    <!-- Stats rápidos -->
    <div class="chart-stats">
      <div class="stat-item">
        <span class="stat-value">{{ datosSignal().labels.length }}</span>
        <span class="stat-label">Categorías</span>
      </div>
      <div class="stat-item">
        <span class="stat-value">{{ getTotalSeries() | number }}</span>
        <span class="stat-label">Total</span>
      </div>
      <div class="stat-item">
        <span class="stat-value">{{ paletaSeleccionada() | titlecase }}</span>
        <span class="stat-label">Paleta</span>
      </div>
    </div>

    <!-- Tips de interactividad -->
    <div class="interactivity-tips">
      <p-tag icon="pi pi-info-circle" severity="secondary" styleClass="tip-tag">
        <span class="tip-text">
          <strong>Tips:</strong>
          <strong>Clic derecho</strong> para drill-down |
          Clic en leyenda para ocultar series |
          Scroll para zoom |
          Clic en elementos para detalle
        </span>
      </p-tag>
    </div>
  </div>
</div>

<!-- Dialog para nueva anotación -->
<p-dialog
  header="{{ anotacionEditando() ? 'Editar Anotación' : 'Nueva Anotación' }}"
  [(visible)]="mostrarDialogAnotacion"
  [modal]="true"
  [style]="{ width: '400px' }"
  [closable]="true"
  (onHide)="cerrarDialogAnotacion()">
  <div class="anotacion-form">
    <div class="form-field">
      <label for="anotacionTexto">Texto de la anotación</label>
      <textarea
        pTextarea
        id="anotacionTexto"
        rows="3"
        [ngModel]="nuevaAnotacion().texto"
        (ngModelChange)="setAnotacionTexto($event)"
        placeholder="Escribe tu anotación aquí..."
        class="w-full"></textarea>
    </div>
    <div class="form-field">
      <label for="anotacionColor">Color</label>
      <div class="color-picker-row">
        @for (color of ['#3B82F6', '#22C55E', '#EAB308', '#EF4444', '#8B5CF6', '#EC4899']; track color) {
          <button
            class="color-option"
            [class.selected]="nuevaAnotacion().color === color"
            [style.background]="color"
            (click)="setAnotacionColor(color)">
          </button>
        }
      </div>
    </div>
    <div class="form-field">
      <label for="anotacionAutor">Autor</label>
      <input
        pInputText
        id="anotacionAutor"
        [ngModel]="nuevaAnotacion().autor"
        (ngModelChange)="setAnotacionAutor($event)"
        placeholder="Tu nombre"
        class="w-full" />
    </div>
  </div>
  <ng-template pTemplate="footer">
    <p-button
      label="Cancelar"
      icon="pi pi-times"
      severity="secondary"
      [text]="true"
      (onClick)="cerrarDialogAnotacion()" />
    <p-button
      label="{{ anotacionEditando() ? 'Actualizar' : 'Guardar' }}"
      icon="pi pi-check"
      severity="success"
      [disabled]="!nuevaAnotacion().texto?.trim()"
      (onClick)="guardarAnotacion()" />
  </ng-template>
</p-dialog>

<!-- Dialog para comparación temporal -->
<p-dialog
  header="Comparación Temporal"
  [(visible)]="mostrarDialogComparacion"
  [modal]="true"
  [style]="{ width: '500px' }"
  [closable]="true">
  <div class="comparacion-form">
    <p class="comparacion-desc">
      <i class="pi pi-info-circle mr-2"></i>
      Compara datos entre dos periodos de tiempo para identificar tendencias y cambios.
    </p>

    <div class="periodo-config">
      <div class="periodo-item">
        <label><i class="pi pi-calendar mr-2"></i>Periodo 1 (Actual)</label>
        <div class="periodo-dates">
          <span class="periodo-label">{{ comparacionTemporal().periodo1.label }}</span>
        </div>
      </div>
      <div class="periodo-item">
        <label><i class="pi pi-calendar mr-2"></i>Periodo 2 (Comparación)</label>
        <div class="periodo-dates">
          <span class="periodo-label">{{ comparacionTemporal().periodo2.label }}</span>
        </div>
      </div>
    </div>

    <div class="form-field">
      <label>Modo de visualización</label>
      <div class="modo-options">
        <button
          class="modo-btn"
          [class.active]="comparacionTemporal().modo === 'overlay'"
          (click)="setModoComparacion('overlay')">
          <i class="pi pi-clone"></i>
          <span>Superpuesto</span>
        </button>
        <button
          class="modo-btn"
          [class.active]="comparacionTemporal().modo === 'sideBySide'"
          (click)="setModoComparacion('sideBySide')">
          <i class="pi pi-th-large"></i>
          <span>Lado a lado</span>
        </button>
      </div>
    </div>
  </div>
  <ng-template pTemplate="footer">
    @if (comparacionTemporal().habilitada) {
      <p-button
        label="Desactivar"
        icon="pi pi-times"
        severity="danger"
        [text]="true"
        (onClick)="desactivarComparacionTemporal(); mostrarDialogComparacion.set(false)" />
    }
    <p-button
      label="Cancelar"
      icon="pi pi-times"
      severity="secondary"
      [text]="true"
      (onClick)="mostrarDialogComparacion.set(false)" />
    <p-button
      label="Aplicar Comparación"
      icon="pi pi-check"
      severity="success"
      (onClick)="aplicarComparacionTemporal()" />
  </ng-template>
</p-dialog>

<!-- Drawer para crear alerta -->
<p-drawer
  [(visible)]="mostrarDrawerAlerta"
  position="right"
  [style]="{ width: '450px' }"
  [modal]="true"
  [showCloseIcon]="true"
  (onHide)="cerrarDrawerAlerta()">
  <ng-template pTemplate="header">
    <div class="drawer-header-custom">
      <div class="drawer-title">
        <i class="pi pi-bell"></i>
        <span>Crear Alerta por Umbral</span>
      </div>
      <div class="drawer-header-toggle">
        <span class="toggle-label">Activa</span>
        <p-tag [value]="alertaForm().activo ? 'Sí' : 'No'" [severity]="alertaForm().activo ? 'success' : 'secondary'" />
        <p-checkbox [ngModel]="alertaForm().activo" (ngModelChange)="updateAlertaForm('activo', $event)" [binary]="true" />
      </div>
    </div>
  </ng-template>

  <div class="drawer-content">
    <!-- Info de la gráfica preseleccionada -->
    <div class="preselected-info">
      <div class="info-header">
        <i class="pi pi-chart-bar"></i>
        <span>Datos de la gráfica</span>
      </div>
      <div class="info-tags">
        <p-tag [value]="alertaForm().campoSeleccionado" severity="info" icon="pi pi-database" />
        <p-tag [value]="alertaForm().categoriaSeleccionada" severity="warn" icon="pi pi-tag" />
        <p-tag [value]="'Valor: ' + alertaForm().valorUmbral" severity="success" icon="pi pi-hashtag" />
      </div>
    </div>

    <div class="form-grid">
      <!-- Nombre -->
      <div class="form-field full-width">
        <label for="alerta-nombre">Nombre de la alerta *</label>
        <input
          pInputText
          id="alerta-nombre"
          [ngModel]="alertaForm().nombre"
          (ngModelChange)="updateAlertaForm('nombre', $event)"
          placeholder="Ej: Alerta de riesgo alto"
          class="w-full" />
      </div>

      <!-- Descripción -->
      <div class="form-field full-width">
        <label for="alerta-descripcion">Descripción</label>
        <textarea
          pInputText
          id="alerta-descripcion"
          [ngModel]="alertaForm().descripcion"
          (ngModelChange)="updateAlertaForm('descripcion', $event)"
          rows="2"
          placeholder="Descripción opcional de la alerta"
          class="w-full"></textarea>
      </div>

      <!-- Condición -->
      <div class="form-section full-width">
        <h4><i class="pi pi-sliders-h mr-2"></i>Condición de activación</h4>
      </div>

      <!-- Operador -->
      <div class="form-field">
        <label for="alerta-operador">Operador *</label>
        <p-select
          id="alerta-operador"
          [ngModel]="alertaForm().operador"
          (ngModelChange)="updateAlertaForm('operador', $event)"
          [options]="opcionesOperadorAlerta"
          optionLabel="label"
          optionValue="value"
          placeholder="Seleccionar"
          appendTo="body"
          styleClass="w-full" />
      </div>

      <!-- Valor Umbral -->
      <div class="form-field">
        <label for="alerta-umbral">Valor Umbral *</label>
        <p-inputNumber
          id="alerta-umbral"
          [ngModel]="alertaForm().valorUmbral"
          (ngModelChange)="updateAlertaForm('valorUmbral', $event)"
          mode="decimal"
          [minFractionDigits]="0"
          [maxFractionDigits]="2"
          styleClass="w-full" />
      </div>

      <!-- Severidad -->
      <div class="form-field">
        <label for="alerta-severidad">Severidad *</label>
        <p-select
          id="alerta-severidad"
          [ngModel]="alertaForm().severidad"
          (ngModelChange)="updateAlertaForm('severidad', $event)"
          [options]="opcionesSeveridadAlerta"
          optionLabel="label"
          optionValue="value"
          placeholder="Seleccionar"
          appendTo="body"
          styleClass="w-full" />
      </div>

      <!-- Cooldown -->
      <div class="form-field">
        <label for="alerta-cooldown">Cooldown (minutos)</label>
        <p-inputNumber
          id="alerta-cooldown"
          [ngModel]="alertaForm().cooldownMinutos"
          (ngModelChange)="updateAlertaForm('cooldownMinutos', $event)"
          [min]="1"
          [max]="1440"
          styleClass="w-full" />
        <small class="hint">Tiempo mínimo entre alertas</small>
      </div>

      <!-- Canales de Notificación -->
      <div class="form-section full-width">
        <h4><i class="pi pi-send mr-2"></i>Canales de Notificación</h4>
        <div class="checkbox-tags-group">
          <div class="checkbox-tag-item" [class.active]="alertaForm().enviarInApp">
            <p-checkbox [ngModel]="alertaForm().enviarInApp" (ngModelChange)="updateAlertaForm('enviarInApp', $event)" [binary]="true" />
            <p-tag value="In-App" severity="info" icon="pi pi-desktop" />
          </div>
          <div class="checkbox-tag-item" [class.active]="alertaForm().enviarEmail">
            <p-checkbox [ngModel]="alertaForm().enviarEmail" (ngModelChange)="updateAlertaForm('enviarEmail', $event)" [binary]="true" />
            <p-tag value="Email" severity="warn" icon="pi pi-envelope" />
          </div>
        </div>
      </div>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <div class="drawer-footer">
      <p-button
        label="Cancelar"
        icon="pi pi-times"
        [text]="true"
        severity="secondary"
        (onClick)="cerrarDrawerAlerta()" />
      <p-button
        label="Crear Alerta"
        icon="pi pi-check"
        severity="success"
        [disabled]="!alertaForm().nombre.trim()"
        (onClick)="guardarAlerta()" />
    </div>
  </ng-template>
</p-drawer>
