<!-- ============================================================================
     DASHBOARD CUSTOMIZABLE - TEMPLATE
     Con gráficas interactivas, drilldown y configuración de widgets
     ============================================================================ -->

<div class="dashboard-customizable">
  <!-- Toolbar -->
  <div class="dashboard-toolbar">
    <div class="toolbar-left">
      <h2 class="dashboard-title">
        <i class="pi pi-th-large"></i>
        {{ configActual()?.nombre || 'Dashboard' }}
      </h2>
      @if (hasUnsavedChanges()) {
        <span class="unsaved-indicator">
          <i class="pi pi-circle-fill"></i>
          Sin guardar
        </span>
      }
    </div>

    <div class="toolbar-right">
      <!-- Botones de exportación (siempre visibles) -->
      <p-button
        icon="pi pi-download"
        label="Exportar"
        [outlined]="true"
        size="small"
        [loading]="exportingCanvas()"
        (onClick)="exportarDashboardCompleto('pdf')"
        pTooltip="Exportar dashboard como PDF">
      </p-button>

      @if (modoEdicion()) {
        <!-- Acciones modo edición -->
        <p-divider layout="vertical"></p-divider>

        <p-button
          icon="pi pi-plus"
          label="Agregar Widget"
          [outlined]="true"
          size="small"
          (onClick)="abrirCatalogo()">
        </p-button>

        <p-button
          icon="pi pi-cog"
          label="Layout"
          [outlined]="true"
          size="small"
          (onClick)="abrirLayoutConfig()">
        </p-button>

        <p-divider layout="vertical"></p-divider>

        @if (hasUnsavedChanges()) {
          <p-button
            icon="pi pi-times"
            label="Descartar"
            severity="secondary"
            [text]="true"
            size="small"
            (onClick)="descartarCambios()">
          </p-button>
        }

        <p-button
          icon="pi pi-check"
          label="Guardar"
          size="small"
          (onClick)="guardarCambios()">
        </p-button>

        <p-button
          icon="pi pi-times"
          [rounded]="true"
          [text]="true"
          severity="secondary"
          pTooltip="Salir de edición"
          (onClick)="toggleModoEdicion()">
        </p-button>
      } @else {
        <!-- Acciones modo visualización -->
        <p-button
          icon="pi pi-pencil"
          label="Personalizar"
          [outlined]="true"
          size="small"
          (onClick)="toggleModoEdicion()">
        </p-button>
      }
    </div>
  </div>

  <!-- Grid de Widgets (Gridster) -->
  <div class="dashboard-grid" [class.editing]="modoEdicion()">
    <gridster [options]="gridsterOptions()">
      @for (widget of widgets(); track trackByWidgetId($index, widget)) {
        <gridster-item [item]="widget" (click)="onWidgetClick(widget)" [attr.data-widget-id]="widget.id">
          <app-dashboard-widget
            [widget]="widget"
            (onEdit)="editarWidget($event)"
            (onRemove)="eliminarWidget($event)"
            (onDuplicate)="duplicarWidget($event)"
            (onExport)="abrirExportModal($event)">

            <!-- Contenido del widget según tipo -->
            @switch (widget.tipo) {
              @case ('kpi-card') {
                <div class="widget-kpi-card" [style.--kpi-color]="widget.config.kpiConfig?.colorPrimario">
                  <div class="kpi-icon">
                    <i [class]="widget.config.kpiConfig?.icono || 'pi pi-chart-line'"></i>
                  </div>
                  <div class="kpi-content">
                    <div class="kpi-value">
                      {{ getKPIValue(widget.config.kpiType || 'cumplimiento') }}{{ widget.config.kpiConfig?.unidad || '%' }}
                    </div>
                    @if (widget.config.kpiConfig?.mostrarTendencia !== false) {
                      @let trend = getKPITrend(widget.config.kpiType || 'cumplimiento');
                      <div class="kpi-trend" [class.positive]="trend.isPositive" [class.negative]="!trend.isPositive">
                        <i class="pi" [class.pi-arrow-up]="trend.direction === 'up'" [class.pi-arrow-down]="trend.direction === 'down'" [class.pi-minus]="trend.direction === 'neutral'"></i>
                        {{ trend.value }}
                      </div>
                    }
                    @if (widget.config.kpiConfig?.mostrarMeta === true) {
                      <div class="kpi-meta">
                        <span class="meta-label">Meta:</span>
                        <span class="meta-value">{{ widget.config.kpiConfig?.metaValor || 100 }}{{ widget.config.kpiConfig?.unidad || '%' }}</span>
                        <div class="meta-progress">
                          <div class="meta-progress-bar"
                               [style.width.%]="(getKPINumericValue(widget.config.kpiType || 'cumplimiento') / (widget.config.kpiConfig?.metaValor || 100)) * 100"></div>
                        </div>
                      </div>
                    }
                  </div>
                </div>
              }

              @case ('kpi-grid') {
                <div class="widget-kpi-grid">
                  @for (metric of getKPIGridMetrics(); track metric.label) {
                    <div class="kpi-mini-card">
                      <span class="value">{{ metric.value }}</span>
                      <span class="label">{{ metric.label }}</span>
                    </div>
                  }
                </div>
              }

              @case ('table-mini') {
                <div class="widget-table-enhanced">
                  <!-- Barra de filtros y ordenamiento -->
                  <div class="table-toolbar">
                    <div class="table-search">
                      <i class="pi pi-search"></i>
                      <input
                        type="text"
                        placeholder="Buscar..."
                        [ngModel]="tablaFiltroTexto()"
                        (ngModelChange)="tablaFiltroTexto.set($event)" />
                    </div>
                    <div class="table-filters">
                      <p-select
                        [options]="tablaEstadoOptions"
                        [ngModel]="tablaFiltroEstado()"
                        (ngModelChange)="tablaFiltroEstado.set($event)"
                        optionLabel="label"
                        optionValue="value"
                        placeholder="Estado"
                        [style]="{width: '120px'}"
                        size="small">
                      </p-select>
                    </div>
                    <p-button
                      icon="pi pi-download"
                      [rounded]="true"
                      [text]="true"
                      size="small"
                      (onClick)="exportarTabla(widget)"
                      pTooltip="Exportar CSV">
                    </p-button>
                  </div>

                  <!-- Tabla con ordenamiento -->
                  <table class="mini-table sortable">
                    <thead>
                      <tr>
                        <th class="sortable-header" (click)="ordenarTabla('nombre')">
                          Proceso
                          <i class="pi" [class.pi-sort-alt]="tablaOrdenCampo() !== 'nombre'"
                             [class.pi-sort-amount-up]="tablaOrdenCampo() === 'nombre' && tablaOrdenDir() === 'asc'"
                             [class.pi-sort-amount-down]="tablaOrdenCampo() === 'nombre' && tablaOrdenDir() === 'desc'"></i>
                        </th>
                        <th class="sortable-header" (click)="ordenarTabla('estado')">
                          Estado
                          <i class="pi" [class.pi-sort-alt]="tablaOrdenCampo() !== 'estado'"
                             [class.pi-sort-amount-up]="tablaOrdenCampo() === 'estado' && tablaOrdenDir() === 'asc'"
                             [class.pi-sort-amount-down]="tablaOrdenCampo() === 'estado' && tablaOrdenDir() === 'desc'"></i>
                        </th>
                        <th class="sortable-header" (click)="ordenarTabla('cumplimiento')">
                          Cumplimiento
                          <i class="pi" [class.pi-sort-alt]="tablaOrdenCampo() !== 'cumplimiento'"
                             [class.pi-sort-amount-up]="tablaOrdenCampo() === 'cumplimiento' && tablaOrdenDir() === 'asc'"
                             [class.pi-sort-amount-down]="tablaOrdenCampo() === 'cumplimiento' && tablaOrdenDir() === 'desc'"></i>
                        </th>
                      </tr>
                    </thead>
                    <tbody>
                      @for (proc of getTablaFiltradaOrdenada(); track proc.procesoId) {
                        <tr class="clickable" (click)="abrirProcesoDrilldown(proc)">
                          <td class="proceso-nombre">{{ proc.procesoNombre.length > 25 ? proc.procesoNombre.substring(0, 25) + '...' : proc.procesoNombre }}</td>
                          <td>
                            <span class="estado-badge" [class.activo]="proc.estado === 'activo'" [class.borrador]="proc.estado === 'borrador'">
                              {{ proc.estado }}
                            </span>
                          </td>
                          <td class="cumplimiento-cell">
                            <div class="cumplimiento-mini">
                              <span class="cumplimiento-valor">{{ proc.cumplimientoPromedio }}%</span>
                              <div class="cumplimiento-bar-mini">
                                <div class="fill" [style.width.%]="proc.cumplimientoPromedio"></div>
                              </div>
                            </div>
                          </td>
                        </tr>
                      } @empty {
                        <tr>
                          <td colspan="3" class="tabla-vacia">
                            <i class="pi pi-inbox"></i>
                            <span>Sin resultados</span>
                          </td>
                        </tr>
                      }
                    </tbody>
                  </table>

                  <!-- Footer con contador -->
                  <div class="table-footer">
                    <span class="table-count">{{ getTablaFiltradaOrdenada().length }} registros</span>
                  </div>
                </div>
              }

              @case ('actividad-reciente') {
                <div class="widget-actividad-enhanced">
                  <!-- Filtros de actividad -->
                  <div class="actividad-filtros">
                    <div class="filtros-tipo">
                      <button
                        class="filtro-tipo-btn"
                        [class.active]="filtroActividadTipo() === 'todos'"
                        (click)="filtroActividadTipo.set('todos')"
                        pTooltip="Todas">
                        <i class="pi pi-list"></i>
                      </button>
                      <button
                        class="filtro-tipo-btn"
                        [class.active]="filtroActividadTipo() === 'cambios'"
                        (click)="filtroActividadTipo.set('cambios')"
                        pTooltip="Cambios">
                        <i class="pi pi-pencil"></i>
                      </button>
                      <button
                        class="filtro-tipo-btn"
                        [class.active]="filtroActividadTipo() === 'alertas'"
                        (click)="filtroActividadTipo.set('alertas')"
                        pTooltip="Alertas">
                        <i class="pi pi-exclamation-triangle"></i>
                      </button>
                      <button
                        class="filtro-tipo-btn"
                        [class.active]="filtroActividadTipo() === 'nuevos'"
                        (click)="filtroActividadTipo.set('nuevos')"
                        pTooltip="Nuevos">
                        <i class="pi pi-plus-circle"></i>
                      </button>
                    </div>
                    <div class="filtros-secundarios">
                      <p-select
                        [options]="opcionesUsuarioActividad"
                        [ngModel]="filtroActividadUsuario()"
                        (ngModelChange)="filtroActividadUsuario.set($event)"
                        optionLabel="label"
                        optionValue="value"
                        placeholder="Usuario"
                        [style]="{width: '130px'}"
                        size="small">
                      </p-select>
                      <p-select
                        [options]="opcionesPeriodoActividad"
                        [ngModel]="filtroActividadPeriodo()"
                        (ngModelChange)="filtroActividadPeriodo.set($event)"
                        optionLabel="label"
                        optionValue="value"
                        [style]="{width: '110px'}"
                        size="small">
                      </p-select>
                    </div>
                  </div>

                  <!-- Lista de actividades filtrada con drilldown -->
                  <div class="actividad-lista">
                    @for (actividad of getActividadRecienteFiltrada(); track actividad.id || actividad.texto) {
                      <div
                        class="actividad-item-enhanced clickable"
                        [class]="'tipo-' + actividad.tipo"
                        (click)="abrirActividadDrilldown(actividad)">
                        <div class="actividad-icono">
                          <i [class]="actividad.icono + ' ' + actividad.color"></i>
                        </div>
                        <div class="actividad-contenido">
                          <span class="actividad-texto">{{ actividad.texto }}</span>
                          @if (actividad.detalle) {
                            <span class="actividad-detalle">{{ actividad.detalle }}</span>
                          }
                          @if (actividad.usuario) {
                            <span class="actividad-usuario">
                              <i class="pi pi-user"></i>
                              {{ actividad.usuario }}
                            </span>
                          }
                        </div>
                        <div class="actividad-meta">
                          <small class="actividad-tiempo">{{ actividad.tiempo }}</small>
                          <i class="pi pi-chevron-right actividad-arrow"></i>
                        </div>
                      </div>
                    } @empty {
                      <div class="actividad-vacia">
                        <i class="pi pi-inbox"></i>
                        <span>Sin actividades</span>
                      </div>
                    }
                  </div>

                  <!-- Contador -->
                  <div class="actividad-footer">
                    <span class="actividad-contador">
                      {{ getActividadRecienteFiltrada().length }} actividades
                    </span>
                    <p-button
                      icon="pi pi-download"
                      [rounded]="true"
                      [text]="true"
                      size="small"
                      (onClick)="exportarActividades()"
                      pTooltip="Exportar">
                    </p-button>
                  </div>
                </div>
              }

              @case ('calendario') {
                <div class="widget-calendario">
                  <app-calendario-widget
                    [eventos]="eventosCalendario()"
                    [modo]="widget.cols < 3 ? 'compact' : 'full'"
                    [mostrarLeyenda]="widget.rows >= 3"
                    [mostrarResumen]="widget.rows >= 3"
                    (eventoClick)="onCalendarioEventoClick($event)"
                    (fechaClick)="onCalendarioFechaClick($event)">
                  </app-calendario-widget>
                </div>
              }

              @case ('graficas-guardadas') {
                <div class="widget-graficas-guardadas">
                  <app-graficas-guardadas-widget
                    [modo]="widget.cols < 3 ? 'compact' : 'full'"
                    [limite]="widget.config.listLimit || 10"
                    (graficaSeleccionadaEvt)="onGraficaGuardadaSeleccionada($event)"
                    (cargarGraficaEvt)="onCargarGraficaGuardada($event)">
                  </app-graficas-guardadas-widget>
                </div>
              }

              @case ('graficas-interactivas') {
                <div class="widget-graficas-interactivas">
                  <app-graficas-interactivas
                    [modoWidget]="true"
                    [datos]="getGraficaDatosCacheados(widget.id)"
                    [campoInicial]="widget.config.graficaAgrupacion || 'estado'"
                    [titulo]="widget.titulo || 'Análisis'"
                    [subtitulo]="widget.subtitulo || ''"
                    [camposDisponibles]="graficaInteractivaCamposDisponibles()"
                    [valoresFiltrado]="graficaInteractivaValoresFiltrado()"
                    [tipoGraficaExterno]="$any(widget.config.graficaTipo || 'donut')"
                    [paletaExterna]="widget.config.graficaPaleta || 'vibrant'"
                    [animacionesExternas]="widget.config.graficaAnimaciones !== false"
                    [mostrarLeyendaExterna]="widget.config.graficaMostrarLeyenda !== false"
                    [mostrarDataLabelsExterna]="widget.config.graficaMostrarDataLabels === true"
                    [temaExterno]="widget.config.graficaTema || temaActual()"
                    (campoSeleccionado)="onGraficaInteractivaCampoChange($event)"
                    (dataPointClick)="onGraficaInteractivaDataPointClick($event)"
                    (legendClick)="onGraficaInteractivaLegendClick($event)"
                    (filtroAplicado)="onGraficaInteractivaFiltroAplicado($event)">
                  </app-graficas-interactivas>
                </div>
              }

              @default {
                <div class="widget-placeholder">
                  <i class="pi pi-box"></i>
                  <span>Widget: {{ widget.tipo }}</span>
                </div>
              }
            }
          </app-dashboard-widget>
        </gridster-item>
      }
    </gridster>
  </div>
</div>

<!-- ==================== DRAWERS ==================== -->

<!-- Drawer: Catálogo de Widgets -->
<p-drawer [(visible)]="showCatalogoDrawer" position="right" [style]="{width: '400px'}" header="Agregar Widget">
  <div class="catalogo-content">
    <!-- Búsqueda -->
    <div class="catalogo-search">
      <span class="p-input-icon-left w-full">
        <i class="pi pi-search"></i>
        <input type="text" pInputText placeholder="Buscar widgets..."
               [ngModel]="catalogoFiltro()"
               (ngModelChange)="catalogoFiltro.set($event)"
               class="w-full" />
      </span>
    </div>

    <!-- Categorías -->
    <div class="catalogo-categorias">
      @for (cat of categorias; track cat.value) {
        <button class="categoria-btn"
                [class.active]="categoriaActiva() === cat.value"
                (click)="categoriaActiva.set(cat.value)">
          <i [class]="cat.icon"></i>
          {{ cat.label }}
        </button>
      }
    </div>

    <p-divider></p-divider>

    <!-- Lista de Widgets -->
    <div class="catalogo-lista">
      @for (widget of catalogoFiltrado(); track widget.tipo) {
        <div class="catalogo-item" (click)="agregarWidget(widget)">
          <div class="catalogo-item-icon">
            <i [class]="widget.icono"></i>
          </div>
          <div class="catalogo-item-info">
            <span class="catalogo-item-nombre">{{ widget.nombre }}</span>
            <span class="catalogo-item-desc">{{ widget.descripcion }}</span>
          </div>
          <i class="pi pi-plus catalogo-item-add"></i>
        </div>
      } @empty {
        <div class="catalogo-empty">
          <i class="pi pi-inbox"></i>
          <span>No se encontraron widgets</span>
        </div>
      }
    </div>
  </div>
</p-drawer>

<!-- Drawer: Pre-Configuración de Widget (antes de agregar) -->
<p-drawer [(visible)]="showPreConfigDrawer" position="right" [style]="{width: '420px'}">
  <ng-template pTemplate="header">
    <div class="preconfig-header">
      <button class="preconfig-back" (click)="cancelarPreConfig()">
        <i class="pi pi-arrow-left"></i>
      </button>
      <span>Configurar Widget</span>
    </div>
  </ng-template>

  @if (widgetPreConfig()) {
    <div class="preconfig-content">
      <!-- Info del widget seleccionado -->
      <div class="preconfig-widget-info">
        <div class="preconfig-widget-icon">
          <i [class]="widgetPreConfig()!.icono"></i>
        </div>
        <div class="preconfig-widget-details">
          <span class="preconfig-widget-nombre">{{ widgetPreConfig()!.nombre }}</span>
          <span class="preconfig-widget-desc">{{ widgetPreConfig()!.descripcion }}</span>
        </div>
      </div>

      <p-divider></p-divider>

      <!-- Configuración básica -->
      <div class="preconfig-section">
        <h4 class="preconfig-section-title">
          <i class="pi pi-tag"></i>
          Información
        </h4>

        <div class="preconfig-field">
          <label>Título del widget</label>
          <input type="text" pInputText class="w-full"
                 [ngModel]="preConfigTitulo()"
                 (ngModelChange)="preConfigTitulo.set($event)"
                 placeholder="Ingresa un título..." />
        </div>

        <div class="preconfig-field">
          <label>Subtítulo (opcional)</label>
          <input type="text" pInputText class="w-full"
                 [ngModel]="preConfigSubtitulo()"
                 (ngModelChange)="preConfigSubtitulo.set($event)"
                 placeholder="Descripción breve..." />
        </div>
      </div>

      <p-divider></p-divider>

      <!-- Configuración específica según tipo -->
      <div class="preconfig-section">
        <h4 class="preconfig-section-title">
          <i class="pi pi-cog"></i>
          Configuración
        </h4>

        @switch (widgetPreConfig()!.tipo) {
          <!-- KPI Card -->
          @case ('kpi-card') {
            <div class="preconfig-field">
              <label>Tipo de KPI</label>
              <p-select
                [options]="kpiTypeOptions"
                [ngModel]="preConfigKpiType()"
                (ngModelChange)="preConfigKpiType.set($event)"
                optionLabel="label"
                optionValue="value"
                [style]="{width: '100%'}"
                placeholder="Selecciona el tipo de KPI">
              </p-select>
              <small class="preconfig-hint">
                @switch (preConfigKpiType()) {
                  @case ('cumplimiento') { Muestra el porcentaje de cumplimiento general }
                  @case ('procesos') { Muestra la cantidad de procesos activos }
                  @case ('alertas') { Muestra el número de alertas activas }
                  @case ('objetivos') { Muestra KPIs en riesgo o bajo umbral }
                }
              </small>
            </div>
          }

          @case ('actividad-reciente') {
            <div class="preconfig-field">
              <label>Número de actividades a mostrar</label>
              <p-select
                [options]="[
                  {label: '5 actividades', value: 5},
                  {label: '10 actividades', value: 10},
                  {label: '15 actividades', value: 15}
                ]"
                [ngModel]="preConfigListLimit()"
                (ngModelChange)="preConfigListLimit.set($event)"
                optionLabel="label"
                optionValue="value"
                [style]="{width: '100%'}">
              </p-select>
              <small class="preconfig-hint">Últimas acciones y cambios en el sistema</small>
            </div>
          }

          <!-- Tabla -->
          @case ('table-mini') {
            <div class="preconfig-field">
              <label>Fuente de datos</label>
              <p-select
                [options]="tableDataSourceOptions"
                [ngModel]="preConfigTableDataSource()"
                (ngModelChange)="preConfigTableDataSource.set($event)"
                optionLabel="label"
                optionValue="value"
                [style]="{width: '100%'}"
                placeholder="Selecciona qué datos mostrar">
              </p-select>
              <small class="preconfig-hint">
                @switch (preConfigTableDataSource()) {
                  @case ('procesos') { Lista de procesos con cumplimiento y estado }
                  @case ('riesgos') { Riesgos identificados y su estado actual }
                  @case ('results-ml') { Predicciones y resultados de modelos ML }
                  @case ('activos') { Inventario de activos de información }
                  @case ('alertas') { Alertas generadas por el sistema }
                  @case ('incidentes') { Incidentes de seguridad registrados }
                  @case ('kpis') { Indicadores clave de rendimiento }
                  @case ('objetivos') { Objetivos y su progreso actual }
                }
              </small>
            </div>

            <div class="preconfig-field">
              <label>Número de filas a mostrar</label>
              <p-select
                [options]="[
                  {label: '3 filas', value: 3},
                  {label: '5 filas', value: 5},
                  {label: '7 filas', value: 7},
                  {label: '10 filas', value: 10}
                ]"
                [ngModel]="preConfigTableLimit()"
                (ngModelChange)="preConfigTableLimit.set($event)"
                optionLabel="label"
                optionValue="value"
                [style]="{width: '100%'}">
              </p-select>
            </div>
          }

          <!-- Gráficas Interactivas -->
          @case ('graficas-interactivas') {
            <!-- Tabs de configuración -->
            <div class="grafica-config-tabs">
              <button
                class="grafica-tab"
                [class.active]="graficaConfigTab() === 'tipo'"
                (click)="graficaConfigTab.set('tipo')">
                <i class="pi pi-chart-pie"></i>
                <span>Tipo</span>
              </button>
              <button
                class="grafica-tab"
                [class.active]="graficaConfigTab() === 'datos'"
                (click)="graficaConfigTab.set('datos')">
                <i class="pi pi-database"></i>
                <span>Datos</span>
              </button>
              <button
                class="grafica-tab"
                [class.active]="graficaConfigTab() === 'estilo'"
                (click)="graficaConfigTab.set('estilo')">
                <i class="pi pi-palette"></i>
                <span>Estilo</span>
              </button>
              <button
                class="grafica-tab asistente"
                [class.active]="graficaConfigTab() === 'ia'"
                (click)="graficaConfigTab.set('ia')">
                <i class="pi pi-sparkles"></i>
                <span>IA</span>
              </button>
            </div>

            <!-- Tab: Tipo de Gráfica -->
            @if (graficaConfigTab() === 'tipo') {
              <div class="preconfig-field">
                <label>Tipo de Gráfica</label>
                <p-select
                  [options]="tiposGraficaOptions"
                  [ngModel]="preConfigGraficaTipo()"
                  (ngModelChange)="preConfigGraficaTipo.set($event)"
                  optionLabel="label"
                  optionValue="value"
                  optionGroupLabel="label"
                  optionGroupChildren="items"
                  [group]="true"
                  [style]="{width: '100%'}"
                  placeholder="Seleccionar tipo">
                  <ng-template let-group pTemplate="group">
                    <div class="grafica-grupo">
                      <span>{{ group.label }}</span>
                    </div>
                  </ng-template>
                  <ng-template let-item pTemplate="item">
                    <div class="grafica-tipo-item">
                      <i [class]="item.icon" class="mr-2"></i>
                      <span>{{ item.label }}</span>
                    </div>
                  </ng-template>
                </p-select>
                <small class="preconfig-hint">{{ getGraficaTipoDescripcion(preConfigGraficaTipo()) }}</small>
              </div>

              <!-- Recomendación IA -->
              @if (recomendacionTipoGrafica()) {
                <div class="ia-recomendacion">
                  <i class="pi pi-sparkles"></i>
                  <span>{{ recomendacionTipoGrafica() }}</span>
                </div>
              }
            }

            <!-- Tab: Datos -->
            @if (graficaConfigTab() === 'datos') {
              <!-- Fuente de datos -->
              <div class="preconfig-field">
                <label>Fuente de datos</label>
                <p-select
                  [options]="fuentesDatosOptions"
                  [ngModel]="preConfigGraficaFuenteDatos()"
                  (ngModelChange)="onFuenteDatosChange($event)"
                  optionLabel="label"
                  optionValue="value"
                  [style]="{width: '100%'}"
                  placeholder="Seleccionar fuente">
                  <ng-template let-item pTemplate="item">
                    <div class="fuente-option">
                      <i [class]="item.icon"></i>
                      <div class="fuente-info">
                        <span class="fuente-label">{{ item.label }}</span>
                        <span class="fuente-desc">{{ item.descripcion }}</span>
                      </div>
                    </div>
                  </ng-template>
                </p-select>
              </div>

              <!-- Filtros opcionales -->
              <div class="filtros-datos">
                <label>Filtros (opcional)</label>
                <div class="filtros-grid">
                  <p-select
                    [options]="filtrosNivelOptions"
                    [ngModel]="preConfigGraficaFiltroNivel()"
                    (ngModelChange)="preConfigGraficaFiltroNivel.set($event)"
                    optionLabel="label"
                    optionValue="value"
                    [style]="{width: '100%'}"
                    placeholder="Nivel/Área">
                  </p-select>
                  @if (getFiltrosTipoActuales().length > 1) {
                    <p-select
                      [options]="getFiltrosTipoActuales()"
                      [ngModel]="preConfigGraficaFiltroTipo()"
                      (ngModelChange)="preConfigGraficaFiltroTipo.set($event)"
                      optionLabel="label"
                      optionValue="value"
                      [style]="{width: '100%'}"
                      placeholder="Tipo">
                    </p-select>
                  }
                </div>
              </div>

              <p-divider></p-divider>

              <!-- Configuración para gráficas CIRCULARES (pie, donut, radialBar, polarArea, funnel, pyramid, treemap) -->
              @if (getModoConfiguracion(preConfigGraficaTipo()) === 'circular') {
                <div class="config-circular">
                  <div class="config-header-mini">
                    <i class="pi pi-chart-pie"></i>
                    <span>Configuración de gráfica circular</span>
                  </div>

                  <div class="preconfig-field">
                    <label>Agrupar por (segmentos)</label>
                    <p-select
                      [options]="getCamposAgrupacionActuales()"
                      [ngModel]="preConfigGraficaAgrupacion()"
                      (ngModelChange)="preConfigGraficaAgrupacion.set($event)"
                      optionLabel="label"
                      optionValue="value"
                      [style]="{width: '100%'}"
                      placeholder="Campo para segmentos">
                    </p-select>
                    <small class="preconfig-hint">Define cómo se dividen los segmentos de la gráfica</small>
                  </div>

                  <div class="preconfig-field">
                    <label>Mostrar (valores)</label>
                    <p-select
                      [options]="getCamposValorActuales()"
                      [ngModel]="preConfigGraficaValor()"
                      (ngModelChange)="preConfigGraficaValor.set($event)"
                      optionLabel="label"
                      optionValue="value"
                      [style]="{width: '100%'}"
                      placeholder="Valor a mostrar">
                    </p-select>
                    <small class="preconfig-hint">El valor que representa cada segmento</small>
                  </div>
                </div>
              }

              <!-- Configuración para gráficas de EJES (bar, column, line, area, etc.) -->
              @if (getModoConfiguracion(preConfigGraficaTipo()) === 'ejes') {
                <div class="config-ejes">
                  <div class="config-header-mini">
                    <i class="pi pi-chart-bar"></i>
                    <span>Configuración de ejes</span>
                  </div>

                  <div class="preconfig-field">
                    <label>Eje X (categorías)</label>
                    <p-select
                      [options]="getCamposEjeXActuales()"
                      [ngModel]="preConfigGraficaEjeX()"
                      (ngModelChange)="preConfigGraficaEjeX.set($event)"
                      optionLabel="label"
                      optionValue="value"
                      [style]="{width: '100%'}"
                      placeholder="Campo para eje X">
                    </p-select>
                    <small class="preconfig-hint">Las categorías o elementos a comparar</small>
                  </div>

                  <div class="preconfig-field">
                    <label>Eje Y (valores)</label>
                    <p-select
                      [options]="getCamposValorActuales()"
                      [ngModel]="preConfigGraficaEjeY()"
                      (ngModelChange)="preConfigGraficaEjeY.set($event)"
                      optionLabel="label"
                      optionValue="value"
                      [style]="{width: '100%'}"
                      placeholder="Campo para eje Y">
                    </p-select>
                    <small class="preconfig-hint">El valor numérico a graficar</small>
                  </div>

                  <!-- Series (para gráficas agrupadas o apiladas) -->
                  @if (preConfigGraficaTipo() === 'stackedBar' || preConfigGraficaTipo() === 'groupedBar') {
                    <div class="preconfig-field">
                      <label>Agrupar series por (opcional)</label>
                      <p-select
                        [options]="getCamposAgrupacionActuales()"
                        [ngModel]="preConfigGraficaSeries()"
                        (ngModelChange)="preConfigGraficaSeries.set($event)"
                        optionLabel="label"
                        optionValue="value"
                        [style]="{width: '100%'}"
                        [showClear]="true"
                        placeholder="Sin agrupación de series">
                      </p-select>
                      <small class="preconfig-hint">Crea múltiples barras/series por cada categoría</small>
                    </div>
                  }
                </div>
              }

              <!-- Configuración para gráficas AVANZADAS (radar, scatter, heatmap) -->
              @if (getModoConfiguracion(preConfigGraficaTipo()) === 'avanzado') {
                <div class="config-avanzado">
                  <div class="config-header-mini">
                    <i class="pi pi-cog"></i>
                    <span>Configuración avanzada</span>
                  </div>

                  @switch (preConfigGraficaTipo()) {
                    @case ('radar') {
                      <div class="preconfig-field">
                        <label>Variables a comparar</label>
                        <p-select
                          [options]="getCamposAgrupacionActuales()"
                          [ngModel]="preConfigGraficaAgrupacion()"
                          (ngModelChange)="preConfigGraficaAgrupacion.set($event)"
                          optionLabel="label"
                          optionValue="value"
                          [style]="{width: '100%'}">
                        </p-select>
                      </div>
                      <div class="preconfig-field">
                        <label>Valor de cada eje</label>
                        <p-select
                          [options]="getCamposValorActuales()"
                          [ngModel]="preConfigGraficaValor()"
                          (ngModelChange)="preConfigGraficaValor.set($event)"
                          optionLabel="label"
                          optionValue="value"
                          [style]="{width: '100%'}">
                        </p-select>
                      </div>
                    }
                    @case ('scatter') {
                      <div class="preconfig-field">
                        <label>Eje X</label>
                        <p-select
                          [options]="getCamposValorActuales()"
                          [ngModel]="preConfigGraficaEjeX()"
                          (ngModelChange)="preConfigGraficaEjeX.set($event)"
                          optionLabel="label"
                          optionValue="value"
                          [style]="{width: '100%'}">
                        </p-select>
                      </div>
                      <div class="preconfig-field">
                        <label>Eje Y</label>
                        <p-select
                          [options]="getCamposValorActuales()"
                          [ngModel]="preConfigGraficaEjeY()"
                          (ngModelChange)="preConfigGraficaEjeY.set($event)"
                          optionLabel="label"
                          optionValue="value"
                          [style]="{width: '100%'}">
                        </p-select>
                      </div>
                    }
                    @case ('heatmap') {
                      <div class="preconfig-field">
                        <label>Filas</label>
                        <p-select
                          [options]="getCamposAgrupacionActuales()"
                          [ngModel]="preConfigGraficaEjeY()"
                          (ngModelChange)="preConfigGraficaEjeY.set($event)"
                          optionLabel="label"
                          optionValue="value"
                          [style]="{width: '100%'}">
                        </p-select>
                      </div>
                      <div class="preconfig-field">
                        <label>Columnas</label>
                        <p-select
                          [options]="getCamposAgrupacionActuales()"
                          [ngModel]="preConfigGraficaEjeX()"
                          (ngModelChange)="preConfigGraficaEjeX.set($event)"
                          optionLabel="label"
                          optionValue="value"
                          [style]="{width: '100%'}">
                        </p-select>
                      </div>
                      <div class="preconfig-field">
                        <label>Valor (intensidad)</label>
                        <p-select
                          [options]="getCamposValorActuales()"
                          [ngModel]="preConfigGraficaValor()"
                          (ngModelChange)="preConfigGraficaValor.set($event)"
                          optionLabel="label"
                          optionValue="value"
                          [style]="{width: '100%'}">
                        </p-select>
                      </div>
                    }
                  }
                </div>
              }

              <!-- Resumen de configuración -->
              <div class="config-resumen">
                <i class="pi pi-info-circle"></i>
                <span>
                  @if (getModoConfiguracion(preConfigGraficaTipo()) === 'circular') {
                    Gráfica de {{ preConfigGraficaAgrupacion() }} mostrando {{ preConfigGraficaValor() === 'count' ? 'cantidad' : preConfigGraficaValor() }}
                  } @else {
                    {{ preConfigGraficaEjeX() }} vs {{ preConfigGraficaEjeY() }}
                  }
                </span>
              </div>
            }

            <!-- Tab: Estilo -->
            @if (graficaConfigTab() === 'estilo') {
              <div class="preconfig-field">
                <label>Paleta de colores</label>
                <p-select
                  [options]="paletasColoresOptions"
                  [ngModel]="preConfigGraficaPaleta()"
                  (ngModelChange)="preConfigGraficaPaleta.set($event)"
                  optionLabel="label"
                  optionValue="value"
                  [style]="{width: '100%'}">
                  <ng-template let-item pTemplate="item">
                    <div class="paleta-option">
                      <div class="paleta-preview">
                        @for (color of getPaletaColores(item.value).slice(0, 5); track $index) {
                          <span class="color-dot" [style.background]="color"></span>
                        }
                      </div>
                      <span>{{ item.label }}</span>
                    </div>
                  </ng-template>
                  <ng-template let-item pTemplate="selectedItem">
                    <div class="paleta-option">
                      <div class="paleta-preview">
                        @for (color of getPaletaColores(item.value).slice(0, 5); track $index) {
                          <span class="color-dot" [style.background]="color"></span>
                        }
                      </div>
                      <span>{{ item.label }}</span>
                    </div>
                  </ng-template>
                </p-select>
              </div>

              <div class="opciones-grafica">
                <label>Opciones de visualización</label>
                <div class="opciones-toggles">
                  <div class="toggle-item" [class.active]="preConfigGraficaAnimaciones()" (click)="toggleGraficaAnimaciones()">
                    <i class="pi pi-play"></i>
                    <span>Animaciones</span>
                  </div>
                  <div class="toggle-item" [class.active]="preConfigGraficaLeyenda()" (click)="toggleGraficaLeyenda()">
                    <i class="pi pi-list"></i>
                    <span>Leyenda</span>
                  </div>
                  <div class="toggle-item" [class.active]="preConfigGraficaEtiquetas()" (click)="toggleGraficaEtiquetas()">
                    <i class="pi pi-tag"></i>
                    <span>Etiquetas</span>
                  </div>
                </div>
              </div>
            }

            <!-- Tab: Asistente IA -->
            @if (graficaConfigTab() === 'ia') {
              <div class="asistente-preconfig">
                <div class="asistente-header-mini">
                  <i class="pi pi-sparkles"></i>
                  <span>Asistente de Gráficas</span>
                </div>

                <div class="sugerencias-rapidas">
                  <p class="sugerencias-label">Configuraciones sugeridas:</p>
                  @for (sugerencia of sugerenciasGraficaIA; track $index) {
                    <button class="sugerencia-btn" (click)="aplicarSugerenciaGraficaIA(sugerencia)">
                      <i [class]="sugerencia.icon"></i>
                      <span>{{ sugerencia.label }}</span>
                    </button>
                  }
                </div>

                <div class="asistente-input-mini">
                  <input
                    pInputText
                    [ngModel]="inputAsistenteGrafica()"
                    (ngModelChange)="inputAsistenteGrafica.set($event)"
                    placeholder="Describe la gráfica que necesitas..."
                    (keyup.enter)="procesarPeticionAsistenteGrafica()"
                    class="w-full" />
                  <p-button
                    icon="pi pi-send"
                    [rounded]="true"
                    severity="success"
                    size="small"
                    [disabled]="!inputAsistenteGrafica().trim()"
                    (onClick)="procesarPeticionAsistenteGrafica()" />
                </div>

                @if (respuestaAsistenteGrafica()) {
                  <div class="asistente-respuesta">
                    <i class="pi pi-sparkles"></i>
                    <p>{{ respuestaAsistenteGrafica() }}</p>
                  </div>
                }
              </div>
            }
          }

          <!-- Widgets sin configuración específica -->
          @default {
            <div class="preconfig-info-box info">
              <i class="pi pi-info-circle"></i>
              <span>Este widget no requiere configuración adicional.</span>
            </div>
          }
        }
      </div>

      <p-divider></p-divider>

      <!-- Opciones adicionales -->
      <div class="preconfig-section">
        <h4 class="preconfig-section-title">
          <i class="pi pi-sliders-h"></i>
          Opciones
        </h4>

        <div class="preconfig-toggle">
          <label>Mostrar encabezado del widget</label>
          <p-togglebutton
            [ngModel]="preConfigShowHeader()"
            (ngModelChange)="preConfigShowHeader.set($event)"
            onLabel="Sí"
            offLabel="No"
            [style]="{width: '80px'}">
          </p-togglebutton>
        </div>
      </div>

      <!-- Vista previa del tamaño -->
      <div class="preconfig-size-preview">
        <span class="size-label">Tamaño inicial:</span>
        <span class="size-value">
          {{ widgetPreConfig()!.tamanoDefault | titlecase }}
          ({{ widgetPreConfig()!.minCols }}x{{ widgetPreConfig()!.minRows }} celdas)
        </span>
      </div>
    </div>
  }

  <!-- Footer con botones (fuera del @if para que el template se registre correctamente) -->
  <ng-template pTemplate="footer">
    @if (widgetPreConfig()) {
      <div class="preconfig-footer">
        <p-button
          label="Cancelar"
          icon="pi pi-times"
          severity="secondary"
          [text]="true"
          (onClick)="cancelarPreConfig()">
        </p-button>
        <p-button
          label="Agregar al Dashboard"
          icon="pi pi-plus"
          severity="success"
          (onClick)="confirmarYAgregarWidget()">
        </p-button>
      </div>
    }
  </ng-template>
</p-drawer>

<!-- Drawer: Configuración de Widget -->
<p-drawer [(visible)]="showConfigDrawer" position="right" [style]="{width: '400px'}" header="Configurar Widget">
  @if (widgetSeleccionado()) {
    <div class="config-content">
      <!-- Información básica -->
      <div class="config-section">
        <label class="config-label">Título</label>
        <input type="text" pInputText class="w-full"
               [ngModel]="widgetSeleccionado()!.titulo"
               (ngModelChange)="actualizarTituloWidget($event)" />
      </div>

      <div class="config-section">
        <label class="config-label">Subtítulo (opcional)</label>
        <input type="text" pInputText class="w-full"
               [ngModel]="widgetSeleccionado()!.subtitulo || ''"
               (ngModelChange)="actualizarSubtituloWidget($event)" />
      </div>

      <p-divider></p-divider>

      <!-- Configuración específica por tipo -->
      @switch (widgetSeleccionado()!.tipo) {
        @case ('kpi-card') {
          <div class="config-section">
            <label class="config-label">Tipo de KPI</label>
            <p-select
              [options]="kpiTypeOptions"
              [ngModel]="widgetSeleccionado()!.config.kpiType || 'cumplimiento'"
              (ngModelChange)="actualizarKpiType($event)"
              optionLabel="label"
              optionValue="value"
              [style]="{width: '100%'}">
            </p-select>
          </div>
        }

        @case ('table-mini') {
          <div class="config-section">
            <label class="config-label">Límite de filas</label>
            <input type="number" pInputText class="w-full"
                   [ngModel]="widgetSeleccionado()!.config.tableLimit || 5"
                   (ngModelChange)="actualizarListLimit($event)"
                   min="3" max="10" />
          </div>
          <div class="config-info-box">
            <i class="pi pi-info-circle"></i>
            <span>Haz click en una fila para ver el detalle del proceso</span>
          </div>
        }

        @default {
          <div class="config-section">
            <label class="config-label">Tipo de Widget</label>
            <div class="config-value">
              <i [class]="getWidgetIcon(widgetSeleccionado()!.tipo)"></i>
              {{ widgetSeleccionado()!.tipo }}
            </div>
          </div>
        }
      }

      <p-divider></p-divider>

      <!-- Dimensiones -->
      <div class="config-section">
        <label class="config-label">Dimensiones actuales</label>
        <div class="config-dimensions">
          <span>{{ widgetSeleccionado()!.cols }} columnas x {{ widgetSeleccionado()!.rows }} filas</span>
        </div>
        <small class="config-hint">Arrastra los bordes del widget para redimensionar</small>
      </div>
    </div>
  }
</p-drawer>

<!-- Drawer: Configuración de Layout -->
<p-drawer [(visible)]="showLayoutDrawer" position="right" [style]="{width: '380px'}" header="Configuración de Layout">
  <div class="layout-content">
    <div class="config-section">
      <label class="config-label">Columnas</label>
      <p-select
        [options]="columnasOptions"
        [ngModel]="configActual()?.columns"
        (ngModelChange)="actualizarColumnas($event)"
        optionLabel="label"
        optionValue="value"
        [style]="{width: '100%'}">
      </p-select>
    </div>

    <div class="config-section">
      <label class="config-label">Altura de fila (px)</label>
      <input type="number" pInputText class="w-full"
             [ngModel]="configActual()?.rowHeight"
             (ngModelChange)="actualizarRowHeight($event)"
             min="80" max="200" step="10" />
    </div>

    <div class="config-section">
      <label class="config-label">Espaciado (px)</label>
      <input type="number" pInputText class="w-full"
             [ngModel]="configActual()?.gap"
             (ngModelChange)="actualizarGap($event)"
             min="8" max="32" step="4" />
    </div>

    <p-divider></p-divider>

    <div class="config-actions">
      <p-button
        label="Restaurar por defecto"
        icon="pi pi-refresh"
        severity="secondary"
        [outlined]="true"
        (onClick)="restaurarDefecto()"
        [style]="{width: '100%'}">
      </p-button>
    </div>
  </div>
</p-drawer>

<!-- ==================== DRILLDOWN DRAWERS ==================== -->

<!-- Drawer: Drilldown de Proceso -->
<p-drawer [(visible)]="showProcesoDrilldown" position="right" [style]="{width: '480px'}" header="Detalle de Proceso">
  @if (procesoSeleccionado()) {
    <div class="drilldown-content">
      <!-- Header del proceso -->
      <div class="drilldown-header">
        <div class="drilldown-title-section">
          <h3 class="drilldown-title">{{ procesoSeleccionado()!.procesoNombre }}</h3>
          <p-tag [value]="procesoSeleccionado()!.estado" [severity]="procesoSeleccionado()!.estado === 'activo' ? 'success' : 'secondary'"></p-tag>
        </div>
        <div class="drilldown-stats">
          <div class="stat-item">
            <span class="stat-value">{{ procesoSeleccionado()!.cumplimientoPromedio }}%</span>
            <span class="stat-label">Cumplimiento</span>
          </div>
          <div class="stat-item">
            <span class="stat-value">{{ procesoSeleccionado()!.totalObjetivos }}</span>
            <span class="stat-label">Objetivos</span>
          </div>
          <div class="stat-item">
            <span class="stat-value">{{ procesoSeleccionado()!.totalKPIs }}</span>
            <span class="stat-label">KPIs</span>
          </div>
          <div class="stat-item" [class.alert]="procesoSeleccionado()!.alertasActivas > 0">
            <span class="stat-value">{{ procesoSeleccionado()!.alertasActivas }}</span>
            <span class="stat-label">Alertas</span>
          </div>
        </div>
      </div>

      <p-divider></p-divider>

      <!-- Selector de vista -->
      <div class="drilldown-vista">
        <label class="config-label">Ver desglose por:</label>
        <p-select
          [options]="desgloseOptions"
          [ngModel]="drilldownVistaDesglose()"
          (ngModelChange)="drilldownVistaDesglose.set($event)"
          optionLabel="label"
          optionValue="value"
          [style]="{width: '100%'}">
        </p-select>
      </div>

      <!-- Lista de KPIs/Objetivos -->
      <div class="drilldown-lista">
        @for (item of drilldownKPIsData(); track item.id) {
          <div class="drilldown-item">
            <div class="drilldown-item-info">
              <span class="drilldown-item-nombre">{{ item.nombre }}</span>
              <div class="drilldown-item-bar">
                <div class="drilldown-item-fill" [style.width.%]="item.valor" [style.background]="item.color"></div>
              </div>
            </div>
            <span class="drilldown-item-valor" [style.color]="item.color">{{ item.valor }}%</span>
          </div>
        }
      </div>

      <!-- Tendencia -->
      <p-divider></p-divider>
      <div class="drilldown-tendencia">
        <div class="tendencia-header">
          <span class="tendencia-title">Tendencia</span>
          <div class="tendencia-badge" [class.positive]="procesoSeleccionado()!.tendencia === 'up'" [class.negative]="procesoSeleccionado()!.tendencia === 'down'">
            <i [class]="getTendenciaIcon(procesoSeleccionado()!.tendencia)"></i>
            <span>{{ procesoSeleccionado()!.cumplimientoPromedio - procesoSeleccionado()!.cumplimientoAnterior }}%</span>
          </div>
        </div>
        <span class="tendencia-desc">vs período anterior</span>
      </div>
    </div>
  }
</p-drawer>

<!-- Drawer: Drilldown de Alerta -->
<p-drawer [(visible)]="showAlertaDrilldown" position="right" [style]="{width: '440px'}" header="Detalle de Alerta">
  @if (alertaSeleccionada()) {
    <div class="drilldown-content">
      <!-- Severidad -->
      <div class="alerta-drilldown-header">
        <p-tag [value]="alertaSeleccionada()!.severity === 'critical' ? 'CRÍTICA' : alertaSeleccionada()!.severity === 'warning' ? 'ADVERTENCIA' : 'INFO'" [severity]="getSeverityColor(alertaSeleccionada()!.severity)"></p-tag>
        <span class="alerta-fecha">{{ alertaSeleccionada()!.diasAbierto }} días abierta</span>
      </div>

      <!-- Mensaje -->
      <div class="alerta-mensaje">
        <i class="pi pi-exclamation-triangle"></i>
        <span>{{ alertaSeleccionada()!.mensaje }}</span>
      </div>

      <p-divider></p-divider>

      <!-- Detalles -->
      <div class="alerta-detalles">
        <div class="detalle-item">
          <span class="detalle-label">Proceso</span>
          <span class="detalle-value">{{ alertaSeleccionada()!.procesoNombre }}</span>
        </div>
        <div class="detalle-item">
          <span class="detalle-label">Objetivo</span>
          <span class="detalle-value">{{ alertaSeleccionada()!.objetivoNombre }}</span>
        </div>
        <div class="detalle-item">
          <span class="detalle-label">KPI</span>
          <span class="detalle-value">{{ alertaSeleccionada()!.kpiNombre }}</span>
        </div>
      </div>

      <p-divider></p-divider>

      <!-- Valores -->
      <div class="alerta-valores">
        <div class="valor-card">
          <span class="valor-label">Valor Actual</span>
          <span class="valor-number critical">{{ alertaSeleccionada()!.valorActual }}%</span>
        </div>
        <div class="valor-separator">
          <i class="pi pi-arrow-right"></i>
        </div>
        <div class="valor-card">
          <span class="valor-label">Umbral</span>
          <span class="valor-number">{{ alertaSeleccionada()!.valorUmbral }}%</span>
        </div>
      </div>

      <!-- Acciones -->
      <div class="alerta-acciones">
        <p-button label="Marcar como atendida" icon="pi pi-check" [outlined]="true" [style]="{width: '100%'}"></p-button>
      </div>
    </div>
  }
</p-drawer>

<!-- Drawer: Drilldown de Tendencia -->
<p-drawer [(visible)]="showTendenciaDrilldown" position="right" [style]="{width: '440px'}" header="Análisis de Tendencia">
  @if (tendenciaProcesoSeleccionado()) {
    <div class="drilldown-content">
      <!-- Header -->
      <div class="tendencia-drilldown-header">
        <h3>{{ tendenciaProcesoSeleccionado()!.procesoNombre }}</h3>
        <div class="tendencia-badge large" [class.positive]="tendenciaProcesoSeleccionado()!.tendencia === 'up'" [class.negative]="tendenciaProcesoSeleccionado()!.tendencia === 'down'">
          <i [class]="getTendenciaIcon(tendenciaProcesoSeleccionado()!.tendencia)"></i>
          <span>{{ tendenciaProcesoSeleccionado()!.tendencia === 'up' ? 'Mejorando' : tendenciaProcesoSeleccionado()!.tendencia === 'down' ? 'Declinando' : 'Estable' }}</span>
        </div>
      </div>

      <p-divider></p-divider>

      <!-- Comparación -->
      <div class="tendencia-comparacion">
        <div class="periodo-card">
          <span class="periodo-label">Período Anterior</span>
          <span class="periodo-valor">{{ tendenciaProcesoSeleccionado()!.cumplimientoAnterior }}%</span>
        </div>
        <div class="periodo-arrow">
          <i class="pi pi-arrow-right"></i>
        </div>
        <div class="periodo-card actual">
          <span class="periodo-label">Actual</span>
          <span class="periodo-valor">{{ tendenciaProcesoSeleccionado()!.cumplimientoPromedio }}%</span>
        </div>
      </div>

      <!-- Variación -->
      <div class="tendencia-variacion">
        <span class="variacion-label">Variación</span>
        <span class="variacion-valor" [class.positive]="tendenciaProcesoSeleccionado()!.tendencia === 'up'" [class.negative]="tendenciaProcesoSeleccionado()!.tendencia === 'down'">
          {{ tendenciaProcesoSeleccionado()!.tendencia === 'up' ? '+' : '' }}{{ tendenciaProcesoSeleccionado()!.cumplimientoPromedio - tendenciaProcesoSeleccionado()!.cumplimientoAnterior }}%
        </span>
      </div>

      <p-divider></p-divider>

      <!-- Métricas adicionales -->
      <div class="tendencia-metricas">
        <div class="metrica-item">
          <i class="pi pi-bullseye"></i>
          <div class="metrica-info">
            <span class="metrica-label">Objetivos</span>
            <span class="metrica-valor">{{ tendenciaProcesoSeleccionado()!.totalObjetivos }}</span>
          </div>
        </div>
        <div class="metrica-item">
          <i class="pi pi-chart-line"></i>
          <div class="metrica-info">
            <span class="metrica-label">KPIs monitoreados</span>
            <span class="metrica-valor">{{ tendenciaProcesoSeleccionado()!.totalKPIs }}</span>
          </div>
        </div>
        <div class="metrica-item" [class.alert]="tendenciaProcesoSeleccionado()!.alertasActivas > 0">
          <i class="pi pi-bell"></i>
          <div class="metrica-info">
            <span class="metrica-label">Alertas activas</span>
            <span class="metrica-valor">{{ tendenciaProcesoSeleccionado()!.alertasActivas }}</span>
          </div>
        </div>
      </div>
    </div>
  }
</p-drawer>

<!-- Widget Configurator Avanzado (para tablas) -->
<app-widget-configurator
  [visible]="showWidgetConfigurator()"
  [catalogItem]="configuratorCatalogItem()"
  (visibleChange)="showWidgetConfigurator.set($event)"
  (onConfirm)="onWidgetConfigured($event)"
  (onCancel)="onWidgetConfiguratorCancel()">
</app-widget-configurator>

<!-- Modal de Exportación -->
<p-dialog
  header="Exportar Widget"
  [(visible)]="showExportModal"
  [modal]="true"
  [style]="{width: '400px'}"
  [draggable]="false"
  [resizable]="false">

  @if (exportModalWidget()) {
    <div class="export-modal-content">
      <div class="export-widget-preview">
        <i [class]="getWidgetIcon(exportModalWidget()!.tipo)"></i>
        <span>{{ exportModalWidget()!.titulo }}</span>
      </div>

      <p-divider></p-divider>

      <div class="export-format-section">
        <label class="export-label">Selecciona el formato de exportación:</label>
        <div class="export-options">
          @for (option of getExportOptions(exportModalWidget()!); track option.value) {
            <div class="export-option">
              <p-radiobutton
                [inputId]="option.value"
                name="exportFormat"
                [value]="option.value"
                [ngModel]="exportFormat()"
                (ngModelChange)="exportFormat.set($event)">
              </p-radiobutton>
              <label [for]="option.value" class="export-option-label">
                <i [class]="option.icon"></i>
                <span>{{ option.label }}</span>
              </label>
            </div>
          }
        </div>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <div class="export-modal-footer">
        <p-button
          label="Cancelar"
          icon="pi pi-times"
          [text]="true"
          severity="secondary"
          (onClick)="showExportModal.set(false)">
        </p-button>
        <p-button
          label="Exportar"
          icon="pi pi-download"
          (onClick)="exportarWidget()">
        </p-button>
      </div>
    </ng-template>
  }
</p-dialog>

<!-- Drawer: Drilldown de Actividad -->
<p-drawer [(visible)]="showActividadDrilldown" position="right" [style]="{width: '440px'}" header="Detalle de Actividad">
  @if (actividadSeleccionada()) {
    <div class="drilldown-content">
      <!-- Header con tipo -->
      <div class="actividad-drilldown-header">
        <div class="actividad-tipo-badge" [class]="'tipo-' + actividadSeleccionada()!.tipo">
          <i [class]="actividadSeleccionada()!.icono"></i>
          <span>{{ getLabelTipoActividad(actividadSeleccionada()!.tipo || 'cambios') }}</span>
        </div>
        <span class="actividad-fecha-detalle">{{ actividadSeleccionada()!.tiempo }}</span>
      </div>

      <!-- Contenido principal -->
      <div class="actividad-drilldown-main">
        <h3 class="actividad-titulo-detalle">{{ actividadSeleccionada()!.texto }}</h3>
        @if (actividadSeleccionada()!.detalle) {
          <p class="actividad-descripcion-detalle">{{ actividadSeleccionada()!.detalle }}</p>
        }
      </div>

      <p-divider></p-divider>

      <!-- Información adicional -->
      <div class="actividad-info-grid">
        @if (actividadSeleccionada()!.usuario) {
          <div class="info-item">
            <i class="pi pi-user"></i>
            <div class="info-content">
              <span class="info-label">Usuario</span>
              <span class="info-value">{{ actividadSeleccionada()!.usuario }}</span>
            </div>
          </div>
        }

        @if (actividadSeleccionada()!.proceso) {
          <div class="info-item">
            <i class="pi pi-sitemap"></i>
            <div class="info-content">
              <span class="info-label">Proceso</span>
              <span class="info-value">{{ actividadSeleccionada()!.proceso }}</span>
            </div>
          </div>
        }

        @if (actividadSeleccionada()!.entidad) {
          <div class="info-item">
            <i class="pi pi-tag"></i>
            <div class="info-content">
              <span class="info-label">Entidad</span>
              <span class="info-value">{{ actividadSeleccionada()!.entidad }}</span>
            </div>
          </div>
        }

        @if (actividadSeleccionada()!.fechaCompleta) {
          <div class="info-item">
            <i class="pi pi-calendar"></i>
            <div class="info-content">
              <span class="info-label">Fecha y hora</span>
              <span class="info-value">{{ actividadSeleccionada()!.fechaCompleta }}</span>
            </div>
          </div>
        }
      </div>

      @if (actividadSeleccionada()!.cambios && actividadSeleccionada()!.cambios!.length > 0) {
        <p-divider></p-divider>
        <div class="actividad-cambios">
          <h4 class="cambios-titulo">
            <i class="pi pi-history"></i>
            Cambios realizados
          </h4>
          <div class="cambios-lista">
            @for (cambio of actividadSeleccionada()!.cambios; track $index) {
              <div class="cambio-item">
                <span class="cambio-campo">{{ cambio.campo }}</span>
                <div class="cambio-valores">
                  <span class="valor-anterior">{{ cambio.valorAnterior || '—' }}</span>
                  <i class="pi pi-arrow-right"></i>
                  <span class="valor-nuevo">{{ cambio.valorNuevo }}</span>
                </div>
              </div>
            }
          </div>
        </div>
      }
    </div>

    <ng-template pTemplate="footer">
      <div class="actividad-drilldown-footer">
        <p-button
          label="Cerrar"
          [text]="true"
          severity="secondary"
          (onClick)="showActividadDrilldown.set(false)">
        </p-button>
        @if (actividadSeleccionada()!.proceso) {
          <p-button
            label="Ver Proceso"
            icon="pi pi-external-link"
            (onClick)="navegarAProcesoDesdeActividad()">
          </p-button>
        }
      </div>
    </ng-template>
  }
</p-drawer>

<!-- Dialogs -->
<p-confirmDialog></p-confirmDialog>
<p-toast></p-toast>
