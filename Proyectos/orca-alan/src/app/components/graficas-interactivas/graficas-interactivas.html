<div class="graficas-interactivas-container" [class.dark-mode]="tema() === 'dark'" [class.modo-widget]="modoWidget">
  <!-- Panel de Configuración (solo si no está en modo widget) -->
  @if (!modoWidget) {
  <div class="config-panel">
    <div class="config-header">
      <h3><i class="pi pi-cog mr-2"></i>Configuración de Gráfica</h3>
      <div class="config-header-actions">
        <p-button
          icon="pi pi-save"
          [rounded]="true"
          [text]="true"
          severity="success"
          (onClick)="abrirDialogGuardar()"
          pTooltip="Guardar configuración"
          tooltipPosition="top" />
      </div>
    </div>

    <!-- Tabs de configuración -->
    <div class="config-tabs">
      <button
        class="config-tab"
        [class.active]="tabActivo() === 'config'"
        (click)="tabActivo.set('config')">
        <i class="pi pi-sliders-h"></i>
        <span>Config</span>
      </button>
      <button
        class="config-tab"
        [class.active]="tabActivo() === 'guardadas'"
        (click)="tabActivo.set('guardadas')">
        <i class="pi pi-bookmark"></i>
        <span>Guardadas</span>
        @if (configuracionesGuardadas().length > 0) {
          <span class="tab-badge">{{ configuracionesGuardadas().length }}</span>
        }
      </button>
      <button
        class="config-tab asistente-tab"
        [class.active]="tabActivo() === 'asistente'"
        (click)="tabActivo.set('asistente')">
        <i class="pi pi-sparkles"></i>
        <span>IA</span>
      </button>
    </div>

    <!-- Tab de Configuración -->
    @if (tabActivo() === 'config') {
    <div class="config-body">
      <!-- PASO 1: Tipo de Gráfica -->
      <div class="config-section">
        <div class="step-header">
          <span class="step-number">1</span>
          <h4><i class="pi pi-chart-pie mr-2"></i>Tipo de Gráfica</h4>
        </div>

        <div class="config-field">
          <p-select
            [options]="tiposGraficaFlat()"
            [ngModel]="tipoGrafica()"
            (ngModelChange)="cambiarTipo($event)"
            optionLabel="label"
            optionValue="value"
            placeholder="Seleccionar tipo de gráfica"
            appendTo="body"
            [style]="{ width: '100%' }">
            <ng-template let-option pTemplate="item">
              <div class="tipo-option">
                <i [class]="getTipoIcon(option.value)" class="mr-2"></i>
                <span>{{ option.label }}</span>
                <small class="tipo-group">({{ option.group }})</small>
              </div>
            </ng-template>
            <ng-template let-option pTemplate="selectedItem">
              <div class="tipo-option">
                <i [class]="getTipoIcon(option.value)" class="mr-2"></i>
                <span>{{ option.label }}</span>
              </div>
            </ng-template>
          </p-select>
        </div>

        <!-- Asistente en Accordion colapsable -->
        <p-accordion [multiple]="true" styleClass="asistente-accordion">
          <p-accordionpanel value="asistente">
            <p-accordionheader>
              <span class="accordion-header-content">
                <i class="pi pi-sparkles mr-2"></i>
                Asistente de Visualización
              </span>
            </p-accordionheader>
            <p-accordioncontent>
              <div class="asistente-content">
                @for (rec of recomendacionesAsistente(); track rec.titulo) {
                  <div class="asistente-item" [class]="'asistente-' + rec.tipo">
                    <div class="asistente-icon">
                      <i [class]="rec.icono"></i>
                    </div>
                    <div class="asistente-texto">
                      <span class="asistente-titulo">{{ rec.titulo }}</span>
                      <p class="asistente-mensaje">{{ rec.mensaje }}</p>
                    </div>
                  </div>
                }
              </div>
            </p-accordioncontent>
          </p-accordionpanel>
        </p-accordion>
      </div>

      <p-divider />

      <!-- PASO 2: Selección de Datos -->
      <div class="config-section">
        <div class="step-header">
          <span class="step-number">2</span>
          <h4><i class="pi pi-database mr-2"></i>Datos</h4>
        </div>

        <!-- Eje X / Categorías (siempre visible) -->
        <div class="config-field">
          <label>
            @if (esGraficaCircular()) {
              Categorías (segmentos)
            } @else {
              Eje X (Categorías)
            }
          </label>
          <p-select
            [options]="camposDisponibles"
            [ngModel]="campoEjeX()"
            (ngModelChange)="onCampoChange($event)"
            optionLabel="label"
            optionValue="value"
            placeholder="Seleccionar campo"
            appendTo="body"
            [style]="{ width: '100%' }">
            <ng-template let-option pTemplate="item">
              <div class="campo-option">
                <span class="campo-label">{{ option.label }}</span>
                <p-tag
                  [value]="option.tipo"
                  [severity]="option.tipo === 'categoria' ? 'info' : option.tipo === 'numerico' ? 'success' : 'warn'"
                  styleClass="campo-tipo-tag" />
              </div>
            </ng-template>
            <ng-template let-option pTemplate="selectedItem">
              <div class="campo-option">
                <span>{{ option.label }}</span>
              </div>
            </ng-template>
          </p-select>
          <small class="field-hint">{{ getCampoDescripcion(campoEjeX()) }}</small>
        </div>

        <!-- Eje Y (solo si es necesario) -->
        @if (necesitaEjeY()) {
          <div class="config-field">
            <label>Eje Y (Valores)</label>
            <p-select
              [options]="camposNumericos()"
              [ngModel]="campoEjeY()"
              (ngModelChange)="campoEjeY.set($event)"
              optionLabel="label"
              optionValue="value"
              placeholder="Seleccionar campo numérico"
              appendTo="body"
              [style]="{ width: '100%' }">
              <ng-template let-option pTemplate="item">
                <div class="campo-option">
                  <span class="campo-label">{{ option.label }}</span>
                </div>
              </ng-template>
            </p-select>
            <small class="field-hint">Campo numérico para el eje vertical</small>
          </div>
        }

        <!-- Campos recomendados en Accordion -->
        @if (camposRecomendados().length > 0) {
          <p-accordion styleClass="campos-accordion">
            <p-accordionpanel value="campos">
              <p-accordionheader>
                <span class="accordion-header-content">
                  <i class="pi pi-lightbulb mr-2"></i>
                  Campos recomendados
                </span>
              </p-accordionheader>
              <p-accordioncontent>
                <div class="recomendados-chips">
                  @for (campo of camposRecomendados(); track campo.value) {
                    <button
                      class="campo-chip"
                      [class.active]="campoEjeX() === campo.value"
                      (click)="onCampoChange(campo.value)"
                      pTooltip="{{ campo.descripcion }}"
                      tooltipPosition="top">
                      {{ campo.label }}
                    </button>
                  }
                </div>
              </p-accordioncontent>
            </p-accordionpanel>
          </p-accordion>
        }
      </div>

      <p-divider />

      <!-- PASO 3: Colores -->
      <div class="config-section">
        <div class="step-header">
          <span class="step-number">3</span>
          <h4><i class="pi pi-palette mr-2"></i>Colores</h4>
        </div>

        <div class="config-field">
          <p-select
            [options]="paletasOptions"
            [ngModel]="paletaSeleccionada()"
            (ngModelChange)="cambiarPaleta($event)"
            optionLabel="label"
            optionValue="value"
            placeholder="Seleccionar paleta"
            appendTo="body"
            [style]="{ width: '100%' }">
            <ng-template let-option pTemplate="item">
              <div class="paleta-option">
                <div class="paleta-colores">
                  @for (color of paletas[option.value].slice(0, 5); track $index) {
                    <span class="color-dot" [style.background]="color"></span>
                  }
                </div>
                <div class="paleta-info">
                  <span class="paleta-nombre">{{ option.label }}</span>
                  <small class="paleta-desc">{{ option.descripcion }}</small>
                </div>
              </div>
            </ng-template>
            <ng-template let-option pTemplate="selectedItem">
              <div class="paleta-option-selected">
                <div class="paleta-colores">
                  @for (color of paletas[option.value].slice(0, 5); track $index) {
                    <span class="color-dot" [style.background]="color"></span>
                  }
                </div>
                <span>{{ option.label }}</span>
              </div>
            </ng-template>
          </p-select>
        </div>
      </div>

      <p-divider />

      <!-- PASO 4: Opciones -->
      <div class="config-section">
        <div class="step-header">
          <span class="step-number">4</span>
          <h4><i class="pi pi-sliders-h mr-2"></i>Opciones</h4>
        </div>

        <div class="opciones-toggles">
          <div class="toggle-item" [class.active]="animaciones()" (click)="toggleAnimaciones()">
            <i class="pi pi-play"></i>
            <span>Animaciones</span>
          </div>
          <div class="toggle-item" [class.active]="mostrarLeyenda()" (click)="toggleLeyenda()">
            <i class="pi pi-list"></i>
            <span>Leyenda</span>
          </div>
          <div class="toggle-item" [class.active]="mostrarDataLabels()" (click)="toggleDataLabels()">
            <i class="pi pi-tag"></i>
            <span>Etiquetas</span>
          </div>
          <div class="toggle-item" [class.active]="tema() === 'dark'" (click)="toggleTema()">
            <i [class]="tema() === 'dark' ? 'pi pi-sun' : 'pi pi-moon'"></i>
            <span>{{ tema() === 'dark' ? 'Claro' : 'Oscuro' }}</span>
          </div>
        </div>
      </div>
    </div>
    }

    <!-- Tab de Configuraciones Guardadas -->
    @if (tabActivo() === 'guardadas') {
    <div class="config-body guardadas-body">
      @if (configuracionesGuardadas().length === 0 && !mostrarDialogGuardar()) {
        <div class="empty-guardadas">
          <i class="pi pi-bookmark"></i>
          <h4>No hay configuraciones guardadas</h4>
          <p>Guarda tu configuración actual para reutilizarla después</p>
          <p-button
            label="Guardar actual"
            icon="pi pi-save"
            severity="success"
            (onClick)="abrirDialogGuardar()" />
        </div>
      } @else {
        <!-- Formulario de guardar inline -->
        @if (mostrarDialogGuardar()) {
          <div class="guardar-inline">
            <div class="guardar-inline-header">
              <h4><i class="pi pi-save mr-2"></i>Nueva configuración</h4>
              <p-button
                icon="pi pi-times"
                [rounded]="true"
                [text]="true"
                size="small"
                (onClick)="cerrarDialogGuardar()" />
            </div>
            <div class="guardar-inline-body">
              <div class="guardar-field">
                <label for="nombreConfig">Nombre *</label>
                <input
                  pInputText
                  id="nombreConfig"
                  [ngModel]="nombreConfiguracion()"
                  (ngModelChange)="nombreConfiguracion.set($event)"
                  placeholder="Ej: Riesgos por estado"
                  class="w-full" />
              </div>
              <div class="guardar-field">
                <label for="descConfig">Descripción</label>
                <input
                  pInputText
                  id="descConfig"
                  [ngModel]="descripcionConfiguracion()"
                  (ngModelChange)="descripcionConfiguracion.set($event)"
                  placeholder="Opcional..."
                  class="w-full" />
              </div>
              <div class="guardar-preview">
                <div class="preview-tags">
                  <p-tag [value]="getTipoLabel(tipoGrafica())" severity="info" />
                  <p-tag [value]="campoEjeX()" severity="secondary" />
                  <p-tag [value]="paletaSeleccionada() | titlecase" severity="warn" />
                </div>
              </div>
              <div class="guardar-actions">
                <p-button
                  label="Guardar"
                  icon="pi pi-check"
                  severity="success"
                  size="small"
                  [disabled]="!nombreConfiguracion().trim()"
                  (onClick)="guardarConfiguracionActual()" />
              </div>
            </div>
          </div>
        }

        <!-- Lista de configuraciones -->
        @if (configuracionesGuardadas().length > 0) {
          <div class="guardadas-list">
            @for (config of configuracionesGuardadas(); track config.id) {
              <div class="guardada-item">
                <div class="guardada-info">
                  <div class="guardada-header">
                    <span class="guardada-nombre">{{ config.nombre }}</span>
                    <p-tag
                      [value]="getTipoLabel(config.configuracion.tipoGrafica)"
                      severity="info"
                      styleClass="guardada-tipo" />
                  </div>
                  @if (config.descripcion) {
                    <p class="guardada-desc">{{ config.descripcion }}</p>
                  }
                  <div class="guardada-meta">
                    <span class="guardada-fecha">
                      <i class="pi pi-calendar"></i>
                      {{ formatFecha(config.fechaCreacion) }}
                    </span>
                    <span class="guardada-paleta">
                      <i class="pi pi-palette"></i>
                      {{ config.configuracion.paleta | titlecase }}
                    </span>
                  </div>
                </div>
                <div class="guardada-actions">
                  <p-button
                    icon="pi pi-upload"
                    [rounded]="true"
                    severity="success"
                    pTooltip="Cargar configuración"
                    tooltipPosition="top"
                    (onClick)="cargarConfiguracion(config)" />
                  <p-button
                    icon="pi pi-trash"
                    [rounded]="true"
                    severity="danger"
                    [text]="true"
                    pTooltip="Eliminar"
                    tooltipPosition="top"
                    (onClick)="eliminarConfiguracion(config.id)" />
                </div>
              </div>
            }
          </div>
        }
      }
    </div>
    }

    <!-- Tab de Asistente IA -->
    @if (tabActivo() === 'asistente') {
    <div class="asistente-panel">
      <!-- Header del asistente -->
      <div class="asistente-header">
        <div class="asistente-avatar">
          <i class="pi pi-sparkles"></i>
        </div>
        <div class="asistente-info">
          <span class="asistente-nombre">Asistente de Gráficas</span>
          <span class="asistente-status">
            @if (asistenteEscribiendo()) {
              <span class="typing-indicator">Escribiendo...</span>
            } @else {
              Listo para ayudarte
            }
          </span>
        </div>
        @if (mensajesAsistente().length > 0) {
          <p-button
            icon="pi pi-trash"
            [rounded]="true"
            [text]="true"
            size="small"
            severity="secondary"
            pTooltip="Limpiar chat"
            tooltipPosition="top"
            (onClick)="limpiarChatAsistente()" />
        }
      </div>

      <!-- Área de mensajes -->
      <div class="asistente-mensajes">
        @if (mensajesAsistente().length === 0) {
          <!-- Estado vacío con sugerencias -->
          <div class="asistente-welcome">
            <div class="welcome-icon">
              <i class="pi pi-sparkles"></i>
            </div>
            <h4>¿Cómo puedo ayudarte?</h4>
            <p>Descríbeme qué gráfica necesitas y la configuraré por ti</p>
            <div class="sugerencias-list">
              @for (sugerencia of sugerenciasPredefinidas; track $index) {
                <button class="sugerencia-chip" (click)="usarSugerencia(sugerencia)">
                  {{ sugerencia }}
                </button>
              }
            </div>
          </div>
        } @else {
          <!-- Mensajes del chat -->
          @for (msg of mensajesAsistente(); track msg.id) {
            <div class="mensaje-wrapper" [class.user]="msg.tipo === 'user'">
              <div class="mensaje-bubble" [class.user]="msg.tipo === 'user'" [class.assistant]="msg.tipo === 'assistant'">
                <div class="mensaje-contenido">{{ msg.mensaje }}</div>
                @if (msg.configuracionSugerida) {
                  <div class="mensaje-config-preview">
                    <div class="config-tags">
                      @if (msg.configuracionSugerida.tipoGrafica) {
                        <p-tag [value]="getTipoLabel(msg.configuracionSugerida.tipoGrafica)" severity="info" />
                      }
                      @if (msg.configuracionSugerida.campoEjeX) {
                        <p-tag [value]="msg.configuracionSugerida.campoEjeX" severity="secondary" />
                      }
                      @if (msg.configuracionSugerida.paleta) {
                        <p-tag [value]="msg.configuracionSugerida.paleta | titlecase" severity="warn" />
                      }
                      @if (msg.configuracionSugerida.filtro) {
                        <p-tag [value]="'Filtro: ' + msg.configuracionSugerida.filtro.valor" severity="danger" icon="pi pi-filter" />
                      }
                    </div>
                    <p-button
                      label="Aplicar"
                      icon="pi pi-check"
                      severity="success"
                      size="small"
                      (onClick)="aplicarConfiguracionSugerida(msg.configuracionSugerida)" />
                  </div>
                }
              </div>
              <span class="mensaje-hora">{{ formatHoraAsistente(msg.fecha) }}</span>
            </div>
          }

          <!-- Indicador de escritura -->
          @if (asistenteEscribiendo()) {
            <div class="mensaje-wrapper">
              <div class="mensaje-bubble assistant typing">
                <div class="typing-dots">
                  <span></span>
                  <span></span>
                  <span></span>
                </div>
              </div>
            </div>
          }
        }
      </div>

      <!-- Input del asistente -->
      <div class="asistente-input">
        <input
          pInputText
          [ngModel]="inputAsistente()"
          (ngModelChange)="inputAsistente.set($event)"
          placeholder="Describe la gráfica que necesitas..."
          (keyup.enter)="enviarMensajeAsistente()"
          class="w-full" />
        <p-button
          icon="pi pi-send"
          [rounded]="true"
          severity="success"
          [disabled]="!inputAsistente().trim() || asistenteEscribiendo()"
          (onClick)="enviarMensajeAsistente()" />
      </div>
    </div>
    }
  </div>
  }

  <!-- Área de la Gráfica -->
  <div class="chart-area">
    <div class="chart-header">
      <div class="chart-info">
        <p-tag [value]="getTipoLabel(tipoGrafica())" severity="info" styleClass="tipo-tag" />
        @if (filtroActivo()) {
          <p-tag
            [value]="'Filtro: ' + filtroActivo()!.valor"
            severity="danger"
            icon="pi pi-filter"
            styleClass="filtro-tag"
            [style]="{ cursor: 'pointer' }"
            pTooltip="Clic para quitar filtro"
            tooltipPosition="top"
            (click)="quitarFiltro()" />
        }
        <span class="chart-title">{{ titulo }}</span>
        @if (subtitulo) {
          <span class="chart-subtitle">{{ subtitulo }}</span>
        }
      </div>
      <div class="chart-actions">
        <p-button
          icon="pi pi-refresh"
          [rounded]="true"
          [text]="true"
          (onClick)="resetZoom()"
          pTooltip="Resetear zoom"
          tooltipPosition="top" />
        <p-button
          icon="pi pi-image"
          [rounded]="true"
          [text]="true"
          (onClick)="exportarPNG()"
          pTooltip="Exportar PNG"
          tooltipPosition="top" />
        <p-button
          icon="pi pi-download"
          [rounded]="true"
          [text]="true"
          (onClick)="exportarSVG()"
          pTooltip="Exportar SVG"
          tooltipPosition="top" />
      </div>
    </div>

    <div class="chart-container" #chartContainer>
      @if (datosSignal().labels.length > 0) {
        <p-chart
          [type]="chartType()"
          [data]="chartData()"
          [options]="chartOptions()"
          [style]="{ width: '100%', height: '100%' }" />
      } @else {
        <div class="no-data-message">
          <i class="pi pi-chart-bar"></i>
          <span>Sin datos para mostrar</span>
        </div>
      }
    </div>

    <!-- Stats rápidos -->
    <div class="chart-stats">
      <div class="stat-item">
        <span class="stat-value">{{ datosSignal().labels.length }}</span>
        <span class="stat-label">Categorías</span>
      </div>
      <div class="stat-item">
        <span class="stat-value">{{ getTotalSeries() | number }}</span>
        <span class="stat-label">Total</span>
      </div>
      <div class="stat-item">
        <span class="stat-value">{{ paletaSeleccionada() | titlecase }}</span>
        <span class="stat-label">Paleta</span>
      </div>
    </div>

    <!-- Tips de interactividad -->
    <div class="interactivity-tips">
      <p-tag icon="pi pi-info-circle" severity="secondary" styleClass="tip-tag">
        <span class="tip-text">
          <strong>Tips:</strong>
          Clic en leyenda para ocultar series |
          Scroll para zoom |
          Arrastra para pan |
          Clic en elementos para detalle
        </span>
      </p-tag>
    </div>
  </div>
</div>
