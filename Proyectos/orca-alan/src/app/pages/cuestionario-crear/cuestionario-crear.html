<p-toast></p-toast>

<div class="crear-proceso-page">
  <!-- Header -->
  <div class="page-header">
    <h1>Crear cuestionario</h1>
    <p class="page-subtitle">{{ steps()[pasoActual()].descripcion }}</p>
  </div>

  <!-- Stepper -->
  <div class="stepper-container">
    @for (step of steps(); track $index; let i = $index) {
      <div
        class="step-item"
        [class.active]="i === pasoActual()"
        [class.completed]="i < pasoActual()"
        [class.clickable]="i < pasoActual()"
        (click)="irAPaso(i)">
        <div class="step-indicator">
          <div class="step-icon">
            @if (i < pasoActual()) {
              <i class="pi pi-check"></i>
            } @else {
              <i [class]="step.icon"></i>
            }
          </div>
          @if (i < steps().length - 1) {
            <div class="step-line" [class.completed]="i < pasoActual()"></div>
          }
        </div>
        <div class="step-content">
          <span class="step-label">{{ step.label }}</span>
          <span class="step-description">{{ step.descripcion }}</span>
        </div>
      </div>
    }
  </div>

  <!-- Content Card -->
  <div class="content-card">
    <!-- PASO 0: Selección de Método -->
    @if (pasoActual() === 0) {
      <div class="step-panel">
        <h2 class="panel-title">Elige el método de creación</h2>

        <div class="grid justify-content-center">
          <!-- Opción IA -->
          <div class="col-12 md:col-6" style="max-width: 420px;">
            <div class="wizard-method-card wizard-method-ia h-full border-round-xl p-4 cursor-pointer"
                 [class.wizard-method-selected]="metodoCreacion() === 'ia'"
                 (click)="seleccionarMetodo('ia')">

              <!-- Icono -->
              <div class="flex justify-content-center mb-4">
                <div class="wizard-method-icon flex align-items-center justify-content-center border-circle bg-purple-100"
                     style="width: 80px; height: 80px;">
                  <i class="pi pi-sparkles text-purple-500" style="font-size: 2.5rem;"></i>
                </div>
              </div>

              <!-- Título y descripción -->
              <div class="text-center mb-4">
                <h3 class="text-xl font-bold m-0 mb-2 wizard-method-title">Cuestionario IA</h3>
                <p class="text-sm m-0 line-height-3 wizard-method-desc">
                  Genera automáticamente un cuestionario basado en tus requerimientos o documentos
                </p>
              </div>

              <!-- Stats cards -->
              <div class="flex gap-2 mb-4">
                <div class="flex-1 wizard-stat-card border-round-lg p-3">
                  <div class="text-center">
                    <span class="text-lg font-bold wizard-stat-value">89%</span>
                    <p class="text-xs m-0 mt-1 wizard-stat-label">Precisión</p>
                  </div>
                </div>
                <div class="flex-1 wizard-stat-card border-round-lg p-3">
                  <div class="text-center">
                    <span class="text-lg font-bold wizard-stat-value">&lt; 30s</span>
                    <p class="text-xs m-0 mt-1 wizard-stat-label">Tiempo</p>
                  </div>
                </div>
                <div class="flex-1 wizard-stat-card border-round-lg p-3">
                  <div class="text-center">
                    <span class="text-lg font-bold wizard-stat-value">5-50</span>
                    <p class="text-xs m-0 mt-1 wizard-stat-label">Preguntas</p>
                  </div>
                </div>
              </div>

              <!-- Botón -->
              <p-button label="Generar con IA" icon="pi pi-sparkles" iconPos="right"
                        severity="help" styleClass="w-full"
                        (onClick)="seleccionarMetodo('ia'); siguiente(); $event.stopPropagation()" />
            </div>
          </div>

          <!-- Opción Manual -->
          <div class="col-12 md:col-6" style="max-width: 420px;">
            <div class="wizard-method-card wizard-method-manual h-full border-round-xl p-4 cursor-pointer"
                 [class.wizard-method-selected]="metodoCreacion() === 'manual'"
                 (click)="seleccionarMetodo('manual')">

              <!-- Icono -->
              <div class="flex justify-content-center mb-4">
                <div class="wizard-method-icon flex align-items-center justify-content-center border-circle bg-blue-100"
                     style="width: 80px; height: 80px;">
                  <i class="pi pi-pencil text-blue-500" style="font-size: 2.5rem;"></i>
                </div>
              </div>

              <!-- Título y descripción -->
              <div class="text-center mb-4">
                <h3 class="text-xl font-bold m-0 mb-2 wizard-method-title">Manual</h3>
                <p class="text-sm m-0 line-height-3 wizard-method-desc">
                  Diseña tu cuestionario paso a paso con control total sobre cada pregunta y sección
                </p>
              </div>

              <!-- Stats cards -->
              <div class="flex gap-2 mb-4">
                <div class="flex-1 wizard-stat-card border-round-lg p-3">
                  <div class="text-center">
                    <span class="text-lg font-bold wizard-stat-value">100%</span>
                    <p class="text-xs m-0 mt-1 wizard-stat-label">Control</p>
                  </div>
                </div>
                <div class="flex-1 wizard-stat-card border-round-lg p-3">
                  <div class="text-center">
                    <span class="text-lg font-bold wizard-stat-value">10</span>
                    <p class="text-xs m-0 mt-1 wizard-stat-label">Tipos</p>
                  </div>
                </div>
              </div>

              <!-- Botón -->
              <p-button label="Crear manual" icon="pi pi-pencil" iconPos="right"
                        severity="contrast" styleClass="w-full"
                        (onClick)="seleccionarMetodo('manual'); siguiente(); $event.stopPropagation()" />
            </div>
          </div>
        </div>
      </div>
    }

    <!-- PASO 1: Datos Generales -->
    @if (pasoActual() === 1) {
      <div class="step-panel panel-columna-izquierda">
        <h2 class="panel-title">Información del Cuestionario</h2>

        <div class="form-field">
          <label class="field-label">Nombre del Cuestionario *</label>
          <input
            type="text"
            class="field-input"
            [ngModel]="nombreCuestionario()"
            (ngModelChange)="nombreCuestionario.set($event)"
            placeholder="Ej: Evaluación ISO 27001 - Q1 2026">
        </div>

        <div class="form-field">
          <label class="field-label">Descripción</label>
          <textarea
            class="field-textarea"
            [ngModel]="descripcionCuestionario()"
            (ngModelChange)="descripcionCuestionario.set($event)"
            rows="3"
            placeholder="Describe el propósito del cuestionario..."></textarea>
        </div>

        <div class="inline-form-row">
          <div class="form-field flex-1">
            <label class="field-label">Marco Normativo</label>
            <div class="select-wrapper">
              <select
                class="field-select"
                [ngModel]="marcoNormativo()"
                (ngModelChange)="marcoNormativo.set($event)">
                <option value="">Seleccionar marco</option>
                @for (opt of marcoOptions; track opt.value) {
                  <option [value]="opt.value">{{ opt.label }}</option>
                }
              </select>
              <i class="pi pi-chevron-down select-icon"></i>
            </div>
          </div>
          <div class="form-field flex-1">
            <label class="field-label">Periodicidad</label>
            <div class="select-wrapper">
              <select
                class="field-select"
                [ngModel]="periodicidad()"
                (ngModelChange)="periodicidad.set($event)">
                <option value="">Seleccionar periodicidad</option>
                @for (opt of periodicidadOptions; track opt.value) {
                  <option [value]="opt.value">{{ opt.label }}</option>
                }
              </select>
              <i class="pi pi-chevron-down select-icon"></i>
            </div>
          </div>
        </div>
      </div>
    }

    <!-- PASO 2: Configuración IA (solo si eligió IA) -->
    @if (pasoActual() === 2 && metodoCreacion() === 'ia' && !cuestionarioGenerado()) {
      <div class="step-panel panel-columna-izquierda">
        <h2 class="panel-title">Configuración de IA</h2>

        <!-- Tabs de método IA -->
        <div class="tabs-container">
          <button
            class="tab-btn"
            [class.active]="iaMetodo() === 'prompt'"
            (click)="iaMetodo.set('prompt')">
            <i class="pi pi-comment"></i>
            Describir con texto
          </button>
          <button
            class="tab-btn"
            [class.active]="iaMetodo() === 'documento'"
            (click)="iaMetodo.set('documento')">
            <i class="pi pi-file"></i>
            Subir documento
          </button>
        </div>

        <!-- Opción: Prompt -->
        @if (iaMetodo() === 'prompt') {
          <div class="form-field">
            <label class="field-label">Describe el cuestionario que necesitas</label>
            <textarea
              class="field-textarea field-textarea--large"
              [ngModel]="promptIA()"
              (ngModelChange)="promptIA.set($event)"
              rows="6"
              placeholder="Ej: Necesito un cuestionario de evaluación de seguridad de la información basado en ISO 27001, enfocado en controles de acceso y gestión de incidentes. Debe tener preguntas tipo Sí/No y escala de cumplimiento..."></textarea>
            <span class="field-hint">Sé específico sobre el tipo de preguntas, áreas a evaluar y nivel de detalle deseado</span>
          </div>
        }

        <!-- Opción: Documento -->
        @if (iaMetodo() === 'documento') {
          <div class="form-field">
            <label class="field-label">Sube un documento de referencia</label>
            @if (!documentoIA()) {
              <div class="upload-area">
                <p-fileUpload
                  mode="basic"
                  name="documento"
                  accept=".pdf,.doc,.docx,.txt"
                  [maxFileSize]="10000000"
                  chooseLabel="Seleccionar archivo"
                  chooseIcon="pi pi-upload"
                  (onSelect)="onSelectDocumento($event)"
                  styleClass="upload-button">
                </p-fileUpload>
                <p class="upload-hint">PDF, DOC, DOCX o TXT (máx. 10MB)</p>
              </div>
            } @else {
              <div class="documento-preview">
                <div class="documento-info">
                  <i class="pi pi-file-pdf"></i>
                  <span>{{ documentoNombre() }}</span>
                </div>
                <button class="btn-remove" (click)="onRemoveDocumento()">
                  <i class="pi pi-times"></i>
                </button>
              </div>
            }
            <span class="field-hint">La IA analizará el documento para generar preguntas relevantes</span>
          </div>
        }
      </div>
    }

    <!-- PASO 2: Preview del cuestionario generado (IA) -->
    @if (pasoActual() === 2 && metodoCreacion() === 'ia' && cuestionarioGenerado()) {
      <div class="step-panel">
        <div class="preview-header">
          <div class="preview-icon">
            <i class="pi pi-check-circle"></i>
          </div>
          <div>
            <h2 class="panel-title">Cuestionario Generado</h2>
            <p class="panel-subtitle">Revisa el resultado antes de continuar</p>
          </div>
        </div>

        <!-- Resumen general -->
        <div class="preview-summary">
          <div class="summary-header">
            <h3>{{ cuestionarioGenerado()?.nombre }}</h3>
            @if (cuestionarioGenerado()?.marcoNormativo) {
              <span class="marco-tag">{{ cuestionarioGenerado()?.marcoNormativo | uppercase }}</span>
            }
          </div>
          <p class="summary-description">{{ cuestionarioGenerado()?.descripcion }}</p>
          <div class="summary-stats">
            <div class="stat-item">
              <i class="pi pi-list"></i>
              <span>{{ cuestionarioGenerado()?.secciones?.length || 0 }} secciones</span>
            </div>
            <div class="stat-item">
              <i class="pi pi-question-circle"></i>
              <span>{{ cuestionarioGenerado()?.preguntas || 0 }} preguntas</span>
            </div>
          </div>
        </div>

        <!-- Vista previa de secciones -->
        <div class="preview-secciones">
          @for (seccion of cuestionarioGenerado()?.secciones || []; track seccion.id; let i = $index) {
            <div class="seccion-card">
              <div class="seccion-header">
                <div class="seccion-number">{{ i + 1 }}</div>
                <div class="seccion-info">
                  <span class="seccion-nombre">{{ seccion.nombre }}</span>
                  <span class="seccion-peso">Peso: {{ seccion.peso }}%</span>
                </div>
              </div>
              <p class="seccion-descripcion">{{ seccion.descripcion }}</p>
              <div class="preguntas-list">
                @for (pregunta of seccion.preguntas; track pregunta.id; let j = $index) {
                  <div class="pregunta-item">
                    <span class="pregunta-number">{{ j + 1 }}.</span>
                    <div class="pregunta-content">
                      <p class="pregunta-texto">{{ pregunta.texto }}</p>
                      <div class="pregunta-meta">
                        <span class="tipo-tag" [class.tipo-sino]="pregunta.tipo === 'siNoNa'" [class.tipo-escala]="pregunta.tipo === 'escala'">
                          {{ getTipoPreguntaLabel(pregunta.tipo) }}
                        </span>
                        @if (pregunta.requerida) {
                          <span class="requerida-tag">Requerida</span>
                        }
                      </div>
                    </div>
                  </div>
                }
              </div>
            </div>
          }
        </div>
      </div>
    }
  </div>

  <!-- Footer Fixed -->
  <div class="page-footer-fixed">
    <div class="footer-content">
      @if (pasoActual() > 0 && !cuestionarioGenerado()) {
        <button class="btn-atras" (click)="anterior()">
          <i class="pi pi-arrow-left"></i>
          Atrás
        </button>
      } @else if (cuestionarioGenerado()) {
        <button class="btn-atras" (click)="regenerarConIA()">
          <i class="pi pi-refresh"></i>
          Regenerar
        </button>
      } @else {
        <button class="btn-atras" (click)="cancelar()">Cancelar</button>
      }

      @if (cuestionarioGenerado()) {
        <div class="footer-actions-right">
          <button class="btn-secundario" (click)="irAEditor()">
            <i class="pi pi-pencil"></i>
            Editar cuestionario
          </button>
          <button class="btn-guardar" (click)="guardarYVolverALista()">
            <i class="pi pi-check"></i>
            Guardar
          </button>
        </div>
      } @else if (pasoActual() === 2 && metodoCreacion() === 'ia') {
        <button class="btn-guardar btn-ia" (click)="generarConIA()" [disabled]="!puedeAvanzar() || generandoIA()">
          @if (generandoIA()) {
            <i class="pi pi-spin pi-spinner"></i>
            Generando...
          } @else {
            <i class="pi pi-sparkles"></i>
            Generar con IA
          }
        </button>
      } @else {
        <button class="btn-siguiente" (click)="siguiente()" [disabled]="!puedeAvanzar()">
          {{ getBotonSiguienteLabel() }}
        </button>
      }
    </div>
  </div>
</div>
