<p-toast></p-toast>

<div class="crear-proceso-page">
  <!-- Header -->
  <div class="page-header">
    <h1>{{ isEditMode() ? 'Editar Proyecto' : 'Crear proyecto' }}</h1>
    <p class="page-subtitle">{{ steps[pasoActual()].descripcion }}</p>
  </div>

  <!-- Stepper -->
  <div class="stepper-container">
    @for (step of steps; track $index; let i = $index) {
      <div
        class="step-item"
        [class.active]="i === pasoActual()"
        [class.completed]="i < pasoActual()"
        [class.clickable]="i < pasoActual()"
        (click)="irAPaso(i)">
        <div class="step-indicator">
          <div class="step-icon">
            @if (i < pasoActual()) {
              <i class="pi pi-check"></i>
            } @else {
              <i [class]="step.icon"></i>
            }
          </div>
          @if (i < steps.length - 1) {
            <div class="step-line" [class.completed]="i < pasoActual()"></div>
          }
        </div>
        <div class="step-content">
          <span class="step-label">{{ step.label }}</span>
          <span class="step-description">{{ step.descripcion }}</span>
        </div>
      </div>
    }
  </div>

  <!-- Content Card -->
  <div class="content-card">
    <!-- PASO 1: Información Básica -->
    @if (pasoActual() === 0) {
      <div class="step-panel panel-columna-izquierda">
        <h2 class="panel-title">Información Básica</h2>

        <div class="form-field">
          <label class="field-label">Nombre del Proyecto *</label>
          <input
            pInputText
            [ngModel]="nombreProyecto()"
            (ngModelChange)="nombreProyecto.set($event)"
            placeholder="Ej: Implementación Sistema ERP"
            class="w-full">
        </div>

        <div class="form-field">
          <label class="field-label">Descripción</label>
          <textarea
            pTextarea
            [ngModel]="descripcionProyecto()"
            (ngModelChange)="descripcionProyecto.set($event)"
            rows="3"
            placeholder="Describe brevemente el proyecto..."
            class="w-full"></textarea>
        </div>

        <div class="inline-form-row">
          <div class="form-field flex-1">
            <label class="field-label">Fecha de Inicio *</label>
            <p-datepicker
              [ngModel]="fechaInicio()"
              (ngModelChange)="fechaInicio.set($event)"
              dateFormat="dd/mm/yy"
              [showIcon]="true"
              styleClass="w-full" />
          </div>
          <div class="form-field flex-1">
            <label class="field-label">Fecha de Fin *</label>
            <p-datepicker
              [ngModel]="fechaFin()"
              (ngModelChange)="fechaFin.set($event)"
              dateFormat="dd/mm/yy"
              [showIcon]="true"
              [minDate]="fechaInicio()"
              styleClass="w-full" />
          </div>
        </div>

        <div class="inline-form-row">
          <div class="form-field flex-1">
            <label class="field-label">Prioridad</label>
            <p-select
              [options]="prioridadOptions"
              [ngModel]="prioridad()"
              (ngModelChange)="prioridad.set($event)"
              optionLabel="label"
              optionValue="value"
              styleClass="w-full"
            />
          </div>
          <div class="form-field flex-1">
            <label class="field-label">Responsable</label>
            <p-select
              [options]="responsablesOptions()"
              [ngModel]="responsableId()"
              (ngModelChange)="responsableId.set($event)"
              optionLabel="label"
              optionValue="value"
              placeholder="Seleccionar responsable"
              styleClass="w-full"
            />
          </div>
        </div>

        <div class="form-field">
          <label class="field-label">Unidad Organizacional</label>
          <p-select
            [options]="unidadesOptions()"
            [ngModel]="unidadOrganizacionalId()"
            (ngModelChange)="unidadOrganizacionalId.set($event)"
            optionLabel="label"
            optionValue="value"
            placeholder="Seleccionar unidad"
            styleClass="w-full"
          />
        </div>
      </div>
    }

    <!-- PASO 2: Objetivos y KPIs (unificado como proceso-crear) -->
    @if (pasoActual() === 1) {
      <div class="step-panel panel-columna-izquierda">
        <h2 class="panel-title">Objetivos y KPIs</h2>

        <!-- Tabs -->
        <div class="tabs-container">
          <p-selectButton
            [options]="modoObjetivosOptions"
            [ngModel]="modoObjetivos()"
            (ngModelChange)="modoObjetivos.set($event)"
            optionLabel="label"
            optionValue="value"
          />
          @if (modoObjetivos() === 'crear') {
            <p-button
              label="Agregar objetivo"
              icon="pi pi-plus"
              [outlined]="true"
              (onClick)="abrirFormObjetivo()"
              class="ml-auto"
            />
          }
        </div>

        <!-- Modo Seleccionar -->
        @if (modoObjetivos() === 'seleccionar') {
          <div class="form-field">
            <p-select
              [options]="objetivosExistentes()"
              optionLabel="nombre"
              optionValue="id"
              placeholder="Seleccionar Existente"
              styleClass="w-full"
            />
          </div>
        }

        <!-- Formulario inline para nuevo objetivo -->
        @if (mostrarFormObjetivoInline() && !objetivoEditandoId()) {
          <div class="inline-form objetivo-form-inline">
            <div class="inline-form-header">
              <h4>Nuevo Objetivo</h4>
              <p-button icon="pi pi-times" [rounded]="true" [text]="true" severity="secondary" (onClick)="cerrarFormObjetivo()" />
            </div>
            <div class="inline-form-body">
              <div class="inline-form-row">
                <div class="form-field flex-2">
                  <label class="field-label">Nombre *</label>
                  <input
                    pInputText
                    [ngModel]="nuevoObjetivoNombre()"
                    (ngModelChange)="nuevoObjetivoNombre.set($event)"
                    placeholder="Nombre del objetivo"
                    class="w-full">
                </div>
                <div class="form-field flex-1">
                  <label class="field-label">Tipo *</label>
                  <p-select
                    [options]="tipoOptions"
                    [ngModel]="nuevoObjetivoTipo()"
                    (ngModelChange)="nuevoObjetivoTipo.set($event)"
                    optionLabel="label"
                    optionValue="value"
                    styleClass="w-full"
                  />
                </div>
              </div>
              <div class="form-field">
                <label class="field-label">Descripción</label>
                <textarea
                  pTextarea
                  [ngModel]="nuevoObjetivoDescripcion()"
                  (ngModelChange)="nuevoObjetivoDescripcion.set($event)"
                  rows="2"
                  placeholder="Descripción del objetivo"
                  class="w-full"></textarea>
              </div>
            </div>
            <div class="inline-form-actions">
              <p-button label="Cancelar" [text]="true" (onClick)="cerrarFormObjetivo()" />
              <p-button label="Crear" icon="pi pi-check" (onClick)="guardarObjetivo()" />
            </div>
          </div>
        }

        <!-- Lista de Objetivos -->
        <div class="objetivos-lista">
          @if (objetivos().length > 1) {
            <div class="objetivos-collapse-actions">
              <p-button label="Expandir todos" icon="pi pi-angle-double-down" [text]="true" size="small" (onClick)="expandirTodosObjetivos()" />
              <p-button label="Colapsar todos" icon="pi pi-angle-double-up" [text]="true" size="small" (onClick)="colapsarTodosObjetivos()" />
            </div>
          }
          @for (objetivo of objetivos(); track objetivo.id) {
            <div class="objetivo-card" [class.editando]="isEditandoObjetivo(objetivo.id)" [class.colapsado]="isObjetivoColapsado(objetivo.id)">
              <!-- Vista normal del objetivo -->
              @if (!isEditandoObjetivo(objetivo.id)) {
                <div class="objetivo-header objetivo-header-colapsable" (click)="toggleObjetivoColapsado(objetivo.id)">
                  <div class="objetivo-collapse-toggle">
                    <i class="pi" [class.pi-chevron-down]="!isObjetivoColapsado(objetivo.id)" [class.pi-chevron-right]="isObjetivoColapsado(objetivo.id)"></i>
                  </div>
                  <div class="objetivo-info">
                    <h3 class="objetivo-titulo">{{ objetivo.nombre }}</h3>
                    @if (!isObjetivoColapsado(objetivo.id)) {
                      <p class="objetivo-descripcion">{{ objetivo.descripcion }}</p>
                    }
                  </div>
                  <div class="objetivo-actions-top" (click)="$event.stopPropagation()">
                    <p-tag [value]="getTipoLabel(objetivo.tipo)" [severity]="objetivo.tipo === 'estrategico' ? 'info' : 'secondary'" />
                    <p-tag [value]="objetivo.kpis.length + ' KPIs'" severity="secondary" />
                    <p-button label="Editar" [text]="true" size="small" (onClick)="abrirFormObjetivo(objetivo)" />
                    <p-button icon="pi pi-times" [rounded]="true" [text]="true" severity="danger" size="small" (onClick)="eliminarObjetivo(objetivo.id)" />
                  </div>
                </div>

                <!-- Progress bar -->
                @if (!isObjetivoColapsado(objetivo.id)) {
                  <div class="objetivo-progress">
                    <div class="progress-bar">
                      <div class="progress-fill" [style.width.%]="calcularProgresoObjetivo(objetivo)"></div>
                    </div>
                    <span class="progress-label">{{ calcularProgresoObjetivo(objetivo) }}%</span>
                  </div>
                }
              } @else {
                <!-- Formulario inline para editar objetivo -->
                <div class="inline-form-body">
                  <div class="inline-form-row">
                    <div class="form-field flex-2">
                      <label class="field-label">Nombre *</label>
                      <input
                        pInputText
                        [ngModel]="nuevoObjetivoNombre()"
                        (ngModelChange)="nuevoObjetivoNombre.set($event)"
                        placeholder="Nombre del objetivo"
                        class="w-full">
                    </div>
                    <div class="form-field flex-1">
                      <label class="field-label">Tipo *</label>
                      <p-select
                        [options]="tipoOptions"
                        [ngModel]="nuevoObjetivoTipo()"
                        (ngModelChange)="nuevoObjetivoTipo.set($event)"
                        optionLabel="label"
                        optionValue="value"
                        styleClass="w-full"
                      />
                    </div>
                  </div>
                  <div class="form-field">
                    <label class="field-label">Descripción</label>
                    <textarea
                      pTextarea
                      [ngModel]="nuevoObjetivoDescripcion()"
                      (ngModelChange)="nuevoObjetivoDescripcion.set($event)"
                      rows="2"
                      placeholder="Descripción del objetivo"
                      class="w-full"></textarea>
                  </div>
                </div>
                <div class="inline-form-actions">
                  <p-button label="Cancelar" [text]="true" (onClick)="cerrarFormObjetivo()" />
                  <p-button label="Guardar" icon="pi pi-check" (onClick)="guardarObjetivo()" />
                </div>
              }

              <!-- KPIs Section -->
              @if (!isEditandoObjetivo(objetivo.id) && !isObjetivoColapsado(objetivo.id)) {
                <div class="kpis-section">
                  <div class="kpis-header">
                    <span class="kpis-title">
                      KPIs
                      <p-badge [value]="objetivo.kpis.length.toString()" />
                    </span>
                    <p-button label="Agregar KPIs" icon="pi pi-plus" [outlined]="true" size="small" (onClick)="abrirFormKPI(objetivo.id)" />
                  </div>

                  <!-- Formulario inline para nuevo KPI -->
                  @if (isFormKPIVisible(objetivo.id) && !kpiEditandoId()) {
                    <div class="inline-form kpi-form-inline">
                      <div class="inline-form-body">
                        <div class="inline-form-row">
                          <div class="form-field flex-2">
                            <label class="field-label">Nombre *</label>
                            <input
                              pInputText
                              [ngModel]="nuevoKPINombre()"
                              (ngModelChange)="nuevoKPINombre.set($event)"
                              placeholder="Nombre del KPI"
                              class="w-full">
                          </div>
                        </div>
                        <div class="inline-form-row">
                          <div class="form-field flex-1">
                            <label class="field-label">Actual</label>
                            <p-inputNumber
                              [ngModel]="nuevoKPIActual()"
                              (ngModelChange)="nuevoKPIActual.set($event ?? 0)"
                              [min]="0"
                              styleClass="w-full"
                            />
                          </div>
                          <div class="form-field flex-1">
                            <label class="field-label">Meta</label>
                            <p-inputNumber
                              [ngModel]="nuevoKPIMeta()"
                              (ngModelChange)="nuevoKPIMeta.set($event ?? 100)"
                              [min]="0"
                              styleClass="w-full"
                            />
                          </div>
                          <div class="form-field flex-1">
                            <label class="field-label">Unidad</label>
                            <p-select
                              [options]="unidadOptions"
                              [ngModel]="nuevoKPIUnidad()"
                              (ngModelChange)="nuevoKPIUnidad.set($event)"
                              optionLabel="label"
                              optionValue="value"
                              styleClass="w-full"
                            />
                          </div>
                          <div class="form-field flex-1">
                            <label class="field-label">Fórmula</label>
                            <p-select
                              [options]="formulaTypeOptions"
                              [ngModel]="nuevoKPIFormulaType()"
                              (ngModelChange)="nuevoKPIFormulaType.set($event)"
                              optionLabel="label"
                              optionValue="value"
                              styleClass="w-full"
                            />
                          </div>
                        </div>
                      </div>
                      <div class="inline-form-actions">
                        <p-button label="Cancelar" [text]="true" (onClick)="cerrarFormKPI()" />
                        <p-button label="Crear" icon="pi pi-check" (onClick)="guardarKPI(objetivo.id)" />
                      </div>
                    </div>
                  }

                  <!-- Lista de KPIs -->
                  <div class="kpis-lista">
                    @for (kpi of objetivo.kpis; track kpi.id) {
                      <div class="kpi-item">
                        <div class="kpi-info">
                          <div class="kpi-nombre-row">
                            <span class="kpi-nombre">{{ kpi.name }}</span>
                            <p-tag [value]="getFormulaTypeLabel(kpi.formulaType)" severity="secondary" />
                          </div>
                          <div class="kpi-meta">
                            <span class="meta-label">Actual</span>
                            <span class="meta-value">{{ kpi.currentValue }} {{ kpi.unit }}</span>
                            <span class="meta-label">Meta</span>
                            <span class="meta-value">{{ kpi.targetValue }} {{ kpi.unit }}</span>
                          </div>
                          <div class="kpi-progress-bar">
                            <div class="kpi-progress-fill"
                              [style.width.%]="kpi.targetValue > 0 ? (kpi.currentValue / kpi.targetValue * 100) : 0"
                              [style.background]="kpi.currentValue >= kpi.targetValue ? 'var(--green-500)' : 'var(--primary-color)'">
                            </div>
                          </div>
                        </div>
                        <div class="kpi-actions">
                          <p-button label="Editar" [text]="true" size="small" (onClick)="abrirFormKPI(objetivo.id, kpi)" />
                          <p-button icon="pi pi-times" [rounded]="true" [text]="true" severity="danger" size="small" (onClick)="eliminarKPI(objetivo.id, kpi.id)" />
                        </div>
                      </div>
                    }

                    @if (objetivo.kpis.length === 0 && !isFormKPIVisible(objetivo.id)) {
                      <div class="empty-kpis">
                        <span>Sin KPIs definidos</span>
                      </div>
                    }
                  </div>
                </div>
              }
            </div>
          }

          <!-- Empty state -->
          @if (objetivos().length === 0 && !mostrarFormObjetivoInline()) {
            <div class="empty-state">
              <i class="pi pi-bullseye"></i>
              <p>No hay objetivos agregados</p>
              <p-button label="Crear primer objetivo" icon="pi pi-plus" (onClick)="abrirFormObjetivo()" />
            </div>
          }
        </div>
      </div>
    }

    <!-- PASO 3: Revisión -->
    @if (pasoActual() === 2) {
      <div class="step-panel panel-columna-izquierda revision-panel">
        <h2 class="panel-title">Revisión</h2>

        <!-- Resumen en una columna -->
        <div class="revision-single-column">
          <!-- Info básica -->
          <div class="revision-section">
            <div class="section-row">
              <label>Nombre del proyecto</label>
              <span class="section-value">{{ nombreProyecto() || 'Sin nombre' }}</span>
            </div>
            <div class="section-row">
              <label>Prioridad</label>
              <p-tag [value]="getPrioridadLabel(prioridad())" [severity]="getPrioridadSeverity(prioridad())" />
            </div>
            <div class="section-row">
              <label>Duración</label>
              <span class="section-value">{{ duracionProyecto() }} días</span>
            </div>
          </div>

          <!-- Descripción -->
          @if (descripcionProyecto()) {
            <div class="revision-section">
              <label>Descripción</label>
              <div class="descripcion-box">
                {{ descripcionProyecto() }}
              </div>
            </div>
          }

          <!-- Resumen de elementos -->
          <div class="revision-section">
            <label>Elementos del proyecto</label>
            <div class="apetito-resumen">
              <div class="apetito-valores">
                <span><strong>Objetivos:</strong> {{ totalObjetivos() }}</span>
                <span><strong>KPIs:</strong> {{ totalKPIs() }}</span>
              </div>
            </div>
          </div>

          <!-- Objetivos con KPIs -->
          @if (objetivos().length > 0) {
            <div class="revision-section">
              <label>Objetivos y KPIs</label>
              <div class="kpis-section-rev">
                @for (objetivo of objetivos(); track objetivo.id) {
                  <div class="objetivo-rev-card">
                    <div class="objetivo-rev-header">
                      <span class="kpi-nombre-rev">{{ objetivo.nombre }}</span>
                      <p-tag [value]="getTipoLabel(objetivo.tipo)" [severity]="objetivo.tipo === 'estrategico' ? 'info' : 'secondary'" />
                    </div>
                    @if (objetivo.kpis.length > 0) {
                      <div class="kpis-rev-list">
                        @for (kpi of objetivo.kpis; track kpi.id) {
                          <div class="kpi-item-rev">
                            <span class="kpi-nombre-rev">{{ kpi.name }}</span>
                            <div class="kpi-meta-rev">
                              <span>Meta</span> <strong>{{ kpi.targetValue }} {{ kpi.unit }}</strong>
                            </div>
                          </div>
                        }
                      </div>
                    } @else {
                      <span class="sin-kpis">Sin KPIs</span>
                    }
                  </div>
                }
              </div>
            </div>
          }
        </div>
      </div>
    }
  </div>

  <!-- Footer Fixed -->
  <div class="page-footer-fixed">
    <div class="footer-content">
      @if (pasoActual() > 0) {
        <p-button
          label="Atrás"
          icon="pi pi-arrow-left"
          [outlined]="true"
          (onClick)="anterior()"
        />
      } @else {
        <p-button
          label="Cancelar"
          [text]="true"
          (onClick)="cancelar()"
        />
      }

      @if (pasoActual() < 2) {
        <p-button
          label="Siguiente"
          icon="pi pi-arrow-right"
          iconPos="right"
          (onClick)="siguiente()"
        />
      } @else {
        <p-button
          [label]="isEditMode() ? 'Guardar Cambios' : 'Crear Proyecto'"
          icon="pi pi-check"
          (onClick)="guardarProyecto()"
          [loading]="saving()"
          [disabled]="saving()"
        />
      }
    </div>
  </div>
</div>
