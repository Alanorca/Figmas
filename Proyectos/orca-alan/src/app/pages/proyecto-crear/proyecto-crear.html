<div class="proyecto-crear-container">
  <!-- Header -->
  <div class="page-header">
    <div class="header-left">
      <p-button
        icon="pi pi-arrow-left"
        [rounded]="true"
        [text]="true"
        (onClick)="cancelar()"
        pTooltip="Volver a proyectos"
      />
      <div class="header-info">
        <h1>{{ isEditMode() ? 'Editar Proyecto' : 'Nuevo Proyecto' }}</h1>
        <p class="subtitle">{{ steps[pasoActual()].descripcion }}</p>
      </div>
    </div>
  </div>

  <!-- Wizard Steps -->
  <div class="wizard-steps">
    @for (step of steps; track $index; let i = $index) {
      <div
        class="step-item"
        [class.active]="pasoActual() === i"
        [class.completed]="pasoActual() > i"
        [class.disabled]="pasoActual() < i"
        (click)="irAPaso(i)"
      >
        <div class="step-number">
          @if (pasoActual() > i) {
            <i class="pi pi-check"></i>
          } @else {
            <i [class]="step.icon"></i>
          }
        </div>
        <div class="step-label">{{ step.label }}</div>
      </div>
      @if (i < steps.length - 1) {
        <div class="step-connector" [class.completed]="pasoActual() > i"></div>
      }
    }
  </div>

  <!-- Content -->
  <div class="wizard-content">
    <!-- Paso 1: Información Básica -->
    @if (pasoActual() === 0) {
      <div class="step-content">
        <div class="form-section">
          <h3>Información del Proyecto</h3>

          <div class="form-grid">
            <div class="form-field full-width">
              <label for="nombre">Nombre del Proyecto *</label>
              <input
                id="nombre"
                type="text"
                pInputText
                [ngModel]="nombreProyecto()"
                (ngModelChange)="nombreProyecto.set($event)"
                placeholder="Ej: Implementación Sistema ERP"
                class="w-full"
              />
            </div>

            <div class="form-field full-width">
              <label for="descripcion">Descripción</label>
              <textarea
                id="descripcion"
                pInputTextarea
                [ngModel]="descripcionProyecto()"
                (ngModelChange)="descripcionProyecto.set($event)"
                placeholder="Describe brevemente el proyecto..."
                rows="3"
                class="w-full"
              ></textarea>
            </div>

            <div class="form-field">
              <label for="fechaInicio">Fecha de Inicio *</label>
              <p-datepicker
                id="fechaInicio"
                [ngModel]="fechaInicio()"
                (ngModelChange)="fechaInicio.set($event)"
                dateFormat="dd/mm/yy"
                [showIcon]="true"
                styleClass="w-full"
              />
            </div>

            <div class="form-field">
              <label for="fechaFin">Fecha de Fin *</label>
              <p-datepicker
                id="fechaFin"
                [ngModel]="fechaFin()"
                (ngModelChange)="fechaFin.set($event)"
                dateFormat="dd/mm/yy"
                [showIcon]="true"
                [minDate]="fechaInicio()"
                styleClass="w-full"
              />
            </div>

            <div class="form-field">
              <label for="prioridad">Prioridad</label>
              <p-select
                id="prioridad"
                [options]="prioridadOptions"
                [ngModel]="prioridad()"
                (ngModelChange)="prioridad.set($event)"
                optionLabel="label"
                optionValue="value"
                [style]="{ width: '100%' }"
              />
            </div>

            <div class="form-field">
              <label for="responsable">Responsable</label>
              <p-select
                id="responsable"
                [options]="responsablesOptions()"
                [ngModel]="responsableId()"
                (ngModelChange)="responsableId.set($event)"
                optionLabel="label"
                optionValue="value"
                placeholder="Seleccionar responsable"
                [style]="{ width: '100%' }"
              />
            </div>

            <div class="form-field">
              <label for="unidad">Unidad Organizacional</label>
              <p-select
                id="unidad"
                [options]="unidadesOptions()"
                [ngModel]="unidadOrganizacionalId()"
                (ngModelChange)="unidadOrganizacionalId.set($event)"
                optionLabel="label"
                optionValue="value"
                placeholder="Seleccionar unidad"
                [style]="{ width: '100%' }"
              />
            </div>
          </div>

          <!-- Resumen -->
          @if (nombreProyecto()) {
            <div class="summary-card">
              <h4>Resumen</h4>
              <div class="summary-grid">
                <div class="summary-item">
                  <span class="label">Duración</span>
                  <span class="value">{{ duracionProyecto() }} días</span>
                </div>
                <div class="summary-item">
                  <span class="label">Prioridad</span>
                  <p-tag
                    [value]="getPrioridadLabel(prioridad())"
                    [severity]="getPrioridadSeverity(prioridad())"
                  />
                </div>
              </div>
            </div>
          }
        </div>
      </div>
    }

    <!-- Paso 2: Objetivos SMART -->
    @if (pasoActual() === 1) {
      <div class="step-content">
        <div class="form-section">
          <div class="section-header">
            <div>
              <h3>Objetivos SMART</h3>
              <p class="section-description">Define objetivos específicos, medibles, alcanzables, relevantes y temporales.</p>
            </div>
            <p-button
              label="Agregar Objetivo"
              icon="pi pi-plus"
              (onClick)="abrirFormObjetivo()"
            />
          </div>

          <!-- Form Objetivo -->
          @if (mostrarFormObjetivo()) {
            <div class="inline-form">
              <div class="form-grid">
                <div class="form-field full-width">
                  <label>Descripción del Objetivo *</label>
                  <textarea
                    pInputTextarea
                    [ngModel]="nuevoObjetivoDescripcion()"
                    (ngModelChange)="nuevoObjetivoDescripcion.set($event)"
                    placeholder="Describe el objetivo..."
                    rows="2"
                    class="w-full"
                  ></textarea>
                </div>

                <div class="form-field">
                  <label>Categoría SMART</label>
                  <p-select
                    [options]="categoriaOptions"
                    [ngModel]="nuevoObjetivoCategoria()"
                    (ngModelChange)="nuevoObjetivoCategoria.set($event)"
                    optionLabel="label"
                    optionValue="value"
                    [style]="{ width: '100%' }"
                  />
                </div>

                <div class="form-field">
                  <label>Fecha Objetivo</label>
                  <p-datepicker
                    [ngModel]="nuevoObjetivoFecha()"
                    (ngModelChange)="nuevoObjetivoFecha.set($event)"
                    dateFormat="dd/mm/yy"
                    [showIcon]="true"
                    styleClass="w-full"
                  />
                </div>
              </div>

              <div class="form-actions">
                <p-button
                  label="Cancelar"
                  severity="secondary"
                  [text]="true"
                  (onClick)="cerrarFormObjetivo()"
                />
                <p-button
                  [label]="editandoObjetivoId() ? 'Actualizar' : 'Agregar'"
                  icon="pi pi-check"
                  (onClick)="guardarObjetivo()"
                />
              </div>
            </div>
          }

          <!-- Lista de Objetivos -->
          @if (objetivos().length > 0) {
            <div class="items-list">
              @for (objetivo of objetivos(); track objetivo.id) {
                <div class="item-card">
                  <div class="item-icon">
                    <i [class]="getCategoriaIcon(objetivo.category)"></i>
                  </div>
                  <div class="item-content">
                    <div class="item-header">
                      <p-tag
                        [value]="getCategoriaLabel(objetivo.category)"
                        severity="info"
                        [style]="{ fontSize: '0.7rem' }"
                      />
                      @if (objetivo.targetDate) {
                        <span class="item-date">
                          <i class="pi pi-calendar"></i>
                          {{ formatDate(objetivo.targetDate) }}
                        </span>
                      }
                    </div>
                    <p class="item-description">{{ objetivo.description }}</p>
                  </div>
                  <div class="item-actions">
                    <p-button
                      icon="pi pi-pencil"
                      [rounded]="true"
                      [text]="true"
                      severity="secondary"
                      (onClick)="abrirFormObjetivo(objetivo)"
                    />
                    <p-button
                      icon="pi pi-trash"
                      [rounded]="true"
                      [text]="true"
                      severity="danger"
                      (onClick)="eliminarObjetivo(objetivo.id)"
                    />
                  </div>
                </div>
              }
            </div>
          } @else if (!mostrarFormObjetivo()) {
            <div class="empty-state">
              <i class="pi pi-bullseye"></i>
              <p>No hay objetivos definidos</p>
              <p class="hint">Los objetivos SMART ayudan a medir el éxito del proyecto</p>
            </div>
          }
        </div>
      </div>
    }

    <!-- Paso 3: KPIs -->
    @if (pasoActual() === 2) {
      <div class="step-content">
        <div class="form-section">
          <div class="section-header">
            <div>
              <h3>Indicadores Clave (KPIs)</h3>
              <p class="section-description">Define los indicadores que medirán el progreso del proyecto.</p>
            </div>
            <p-button
              label="Agregar KPI"
              icon="pi pi-plus"
              (onClick)="abrirFormKPI()"
            />
          </div>

          <!-- Form KPI -->
          @if (mostrarFormKPI()) {
            <div class="inline-form">
              <div class="form-grid">
                <div class="form-field full-width">
                  <label>Nombre del KPI *</label>
                  <input
                    type="text"
                    pInputText
                    [ngModel]="nuevoKPINombre()"
                    (ngModelChange)="nuevoKPINombre.set($event)"
                    placeholder="Ej: Porcentaje de avance"
                    class="w-full"
                  />
                </div>

                <div class="form-field full-width">
                  <label>Descripción</label>
                  <textarea
                    pInputTextarea
                    [ngModel]="nuevoKPIDescripcion()"
                    (ngModelChange)="nuevoKPIDescripcion.set($event)"
                    placeholder="Describe cómo se calcula..."
                    rows="2"
                    class="w-full"
                  ></textarea>
                </div>

                <div class="form-field">
                  <label>Valor Meta</label>
                  <p-inputNumber
                    [ngModel]="nuevoKPIValorMeta()"
                    (ngModelChange)="nuevoKPIValorMeta.set($event)"
                    [showButtons]="true"
                    [min]="0"
                    [style]="{ width: '100%' }"
                  />
                </div>

                <div class="form-field">
                  <label>Unidad</label>
                  <p-select
                    [options]="unidadOptions"
                    [ngModel]="nuevoKPIUnidad()"
                    (ngModelChange)="nuevoKPIUnidad.set($event)"
                    optionLabel="label"
                    optionValue="value"
                    [style]="{ width: '100%' }"
                  />
                </div>

                <div class="form-field">
                  <label>Tipo de Fórmula</label>
                  <p-select
                    [options]="formulaTypeOptions"
                    [ngModel]="nuevoKPIFormulaType()"
                    (ngModelChange)="nuevoKPIFormulaType.set($event)"
                    optionLabel="label"
                    optionValue="value"
                    [style]="{ width: '100%' }"
                  />
                </div>
              </div>

              <div class="form-actions">
                <p-button
                  label="Cancelar"
                  severity="secondary"
                  [text]="true"
                  (onClick)="cerrarFormKPI()"
                />
                <p-button
                  [label]="editandoKPIId() ? 'Actualizar' : 'Agregar'"
                  icon="pi pi-check"
                  (onClick)="guardarKPI()"
                />
              </div>
            </div>
          }

          <!-- Lista de KPIs -->
          @if (kpis().length > 0) {
            <div class="items-list">
              @for (kpi of kpis(); track kpi.id) {
                <div class="item-card">
                  <div class="item-icon kpi">
                    <i class="pi pi-chart-line"></i>
                  </div>
                  <div class="item-content">
                    <div class="item-header">
                      <span class="item-name">{{ kpi.name }}</span>
                      <p-tag
                        [value]="getFormulaTypeLabel(kpi.formulaType)"
                        severity="secondary"
                        [style]="{ fontSize: '0.7rem' }"
                      />
                    </div>
                    @if (kpi.description) {
                      <p class="item-description">{{ kpi.description }}</p>
                    }
                    <div class="kpi-meta">
                      <span class="kpi-target">
                        <i class="pi pi-flag"></i>
                        Meta: {{ kpi.targetValue }} {{ kpi.unit }}
                      </span>
                    </div>
                  </div>
                  <div class="item-actions">
                    <p-button
                      icon="pi pi-pencil"
                      [rounded]="true"
                      [text]="true"
                      severity="secondary"
                      (onClick)="abrirFormKPI(kpi)"
                    />
                    <p-button
                      icon="pi pi-trash"
                      [rounded]="true"
                      [text]="true"
                      severity="danger"
                      (onClick)="eliminarKPI(kpi.id)"
                    />
                  </div>
                </div>
              }
            </div>
          } @else if (!mostrarFormKPI()) {
            <div class="empty-state">
              <i class="pi pi-chart-line"></i>
              <p>No hay KPIs definidos</p>
              <p class="hint">Los KPIs ayudan a monitorear el rendimiento del proyecto</p>
            </div>
          }
        </div>
      </div>
    }

    <!-- Paso 4: Fases y Revisión -->
    @if (pasoActual() === 3) {
      <div class="step-content">
        <div class="form-section">
          <div class="section-header">
            <div>
              <h3>Fases del Proyecto</h3>
              <p class="section-description">Organiza el proyecto en fases para mejor seguimiento.</p>
            </div>
            <p-button
              label="Agregar Fase"
              icon="pi pi-plus"
              (onClick)="abrirFormFase()"
            />
          </div>

          <!-- Form Fase -->
          @if (mostrarFormFase()) {
            <div class="inline-form">
              <div class="form-grid">
                <div class="form-field full-width">
                  <label>Nombre de la Fase *</label>
                  <input
                    type="text"
                    pInputText
                    [ngModel]="nuevaFaseNombre()"
                    (ngModelChange)="nuevaFaseNombre.set($event)"
                    placeholder="Ej: Análisis y Diseño"
                    class="w-full"
                  />
                </div>

                <div class="form-field full-width">
                  <label>Descripción</label>
                  <textarea
                    pInputTextarea
                    [ngModel]="nuevaFaseDescripcion()"
                    (ngModelChange)="nuevaFaseDescripcion.set($event)"
                    placeholder="Describe las actividades de esta fase..."
                    rows="2"
                    class="w-full"
                  ></textarea>
                </div>

                <div class="form-field">
                  <label>Fecha Inicio</label>
                  <p-datepicker
                    [ngModel]="nuevaFaseInicio()"
                    (ngModelChange)="nuevaFaseInicio.set($event)"
                    dateFormat="dd/mm/yy"
                    [showIcon]="true"
                    [minDate]="fechaInicio()"
                    [maxDate]="fechaFin()"
                    styleClass="w-full"
                  />
                </div>

                <div class="form-field">
                  <label>Fecha Fin</label>
                  <p-datepicker
                    [ngModel]="nuevaFaseFin()"
                    (ngModelChange)="nuevaFaseFin.set($event)"
                    dateFormat="dd/mm/yy"
                    [showIcon]="true"
                    [minDate]="nuevaFaseInicio()"
                    [maxDate]="fechaFin()"
                    styleClass="w-full"
                  />
                </div>

                <div class="form-field">
                  <label>Peso (%)</label>
                  <p-inputNumber
                    [ngModel]="nuevaFasePeso()"
                    (ngModelChange)="nuevaFasePeso.set($event)"
                    [showButtons]="true"
                    [min]="1"
                    [max]="100"
                    suffix="%"
                    [style]="{ width: '100%' }"
                  />
                </div>
              </div>

              <div class="form-actions">
                <p-button
                  label="Cancelar"
                  severity="secondary"
                  [text]="true"
                  (onClick)="cerrarFormFase()"
                />
                <p-button
                  [label]="editandoFaseId() ? 'Actualizar' : 'Agregar'"
                  icon="pi pi-check"
                  (onClick)="guardarFase()"
                />
              </div>
            </div>
          }

          <!-- Lista de Fases -->
          @if (fases().length > 0) {
            <div class="phases-list">
              @for (fase of fases(); track fase.id; let i = $index) {
                <div class="phase-card">
                  <div class="phase-order">
                    <div class="order-controls">
                      <p-button
                        icon="pi pi-chevron-up"
                        [rounded]="true"
                        [text]="true"
                        size="small"
                        [disabled]="i === 0"
                        (onClick)="moverFase(fase.id, 'up')"
                      />
                      <span class="order-number">{{ fase.orderNum }}</span>
                      <p-button
                        icon="pi pi-chevron-down"
                        [rounded]="true"
                        [text]="true"
                        size="small"
                        [disabled]="i === fases().length - 1"
                        (onClick)="moverFase(fase.id, 'down')"
                      />
                    </div>
                  </div>
                  <div class="phase-content">
                    <h4>{{ fase.name }}</h4>
                    @if (fase.description) {
                      <p class="phase-description">{{ fase.description }}</p>
                    }
                    <div class="phase-meta">
                      <span class="phase-dates">
                        <i class="pi pi-calendar"></i>
                        {{ formatDate(fase.startDate) }} - {{ formatDate(fase.endDate) }}
                      </span>
                      <span class="phase-duration">
                        {{ getFaseDuracion(fase) }} días
                      </span>
                      <span class="phase-weight">
                        Peso: {{ fase.weight }}%
                      </span>
                    </div>
                  </div>
                  <div class="phase-actions">
                    <p-button
                      icon="pi pi-pencil"
                      [rounded]="true"
                      [text]="true"
                      severity="secondary"
                      (onClick)="abrirFormFase(fase)"
                    />
                    <p-button
                      icon="pi pi-trash"
                      [rounded]="true"
                      [text]="true"
                      severity="danger"
                      (onClick)="eliminarFase(fase.id)"
                    />
                  </div>
                </div>
              }
            </div>
          } @else if (!mostrarFormFase()) {
            <div class="empty-state">
              <i class="pi pi-list-check"></i>
              <p>No hay fases definidas</p>
              <p class="hint">Las fases ayudan a organizar el trabajo del proyecto</p>
            </div>
          }
        </div>

        <!-- Resumen Final -->
        <p-divider />

        <div class="final-summary">
          <h3>Resumen del Proyecto</h3>
          <div class="summary-cards">
            <div class="summary-card-mini">
              <i class="pi pi-folder"></i>
              <div>
                <span class="label">Proyecto</span>
                <span class="value">{{ nombreProyecto() || 'Sin nombre' }}</span>
              </div>
            </div>
            <div class="summary-card-mini">
              <i class="pi pi-calendar"></i>
              <div>
                <span class="label">Duración</span>
                <span class="value">{{ duracionProyecto() }} días</span>
              </div>
            </div>
            <div class="summary-card-mini">
              <i class="pi pi-bullseye"></i>
              <div>
                <span class="label">Objetivos</span>
                <span class="value">{{ totalObjetivos() }}</span>
              </div>
            </div>
            <div class="summary-card-mini">
              <i class="pi pi-chart-line"></i>
              <div>
                <span class="label">KPIs</span>
                <span class="value">{{ totalKPIs() }}</span>
              </div>
            </div>
            <div class="summary-card-mini">
              <i class="pi pi-list-check"></i>
              <div>
                <span class="label">Fases</span>
                <span class="value">{{ totalFases() }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    }
  </div>

  <!-- Footer Navigation -->
  <div class="wizard-footer">
    <div class="footer-left">
      <p-button
        label="Cancelar"
        severity="secondary"
        [text]="true"
        (onClick)="cancelar()"
      />
    </div>
    <div class="footer-right">
      @if (pasoActual() > 0) {
        <p-button
          label="Anterior"
          icon="pi pi-arrow-left"
          severity="secondary"
          [outlined]="true"
          (onClick)="anterior()"
        />
      }
      @if (pasoActual() < 3) {
        <p-button
          label="Siguiente"
          icon="pi pi-arrow-right"
          iconPos="right"
          (onClick)="siguiente()"
        />
      } @else {
        <p-button
          [label]="saving() ? 'Guardando...' : (isEditMode() ? 'Guardar Cambios' : 'Crear Proyecto')"
          [icon]="saving() ? 'pi pi-spin pi-spinner' : 'pi pi-check'"
          (onClick)="guardarProyecto()"
          [disabled]="saving()"
        />
      }
    </div>
  </div>
</div>

<p-toast />
