<p-toast></p-toast>

<div class="crear-proceso-page">
  <!-- Header -->
  <div class="page-header">
    <h1>Crear proceso</h1>
    <p class="page-subtitle">Ingresa los datos del proceso para realizar el registro y dar seguimiento</p>
  </div>

  <!-- Stepper -->
  <div class="stepper-container">
    @for (step of steps; track $index; let i = $index) {
      <div
        class="step-item"
        [class.active]="i === pasoActual()"
        [class.completed]="i < pasoActual()"
        [class.clickable]="i < pasoActual()"
        (click)="irAPaso(i)">
        <div class="step-indicator">
          <div class="step-icon">
            @if (i < pasoActual()) {
              <i class="pi pi-check"></i>
            } @else {
              <i [class]="step.icon"></i>
            }
          </div>
          @if (i < steps.length - 1) {
            <div class="step-line" [class.completed]="i < pasoActual()"></div>
          }
        </div>
        <div class="step-content">
          <span class="step-label">{{ step.label }}</span>
          <span class="step-description">{{ step.descripcion }}</span>
        </div>
      </div>
    }
  </div>

  <!-- Content Card -->
  <div class="content-card">
    <!-- PASO 1: Información Básica -->
    @if (pasoActual() === 0) {
      <div class="step-panel panel-columna-izquierda">
        <h2 class="panel-title">Información Básica</h2>

        <div class="form-field">
          <label class="field-label">Nombre del Proceso *</label>
          <input
            type="text"
            class="field-input"
            [ngModel]="nombreProceso()"
            (ngModelChange)="nombreProceso.set($event)"
            placeholder="Título descriptivo">
        </div>

        <div class="form-field">
          <label class="field-label">Estado *</label>
          <div class="select-wrapper">
            <select
              class="field-select"
              [ngModel]="tipoProceso()"
              (ngModelChange)="tipoProceso.set($event)">
              <option value="">Seleccionar tipo</option>
              @for (tipo of tiposProcesoOptions; track tipo.value) {
                <option [value]="tipo.value">{{ tipo.label }}</option>
              }
            </select>
            <i class="pi pi-chevron-down select-icon"></i>
          </div>
        </div>

        <div class="form-field">
          <label class="field-label">Descripción detallada *</label>
          <textarea
            class="field-textarea"
            [ngModel]="descripcionProceso()"
            (ngModelChange)="descripcionProceso.set($event)"
            rows="5"
            placeholder="Describe de forma detallada el proceso"></textarea>
        </div>
      </div>
    }

    <!-- PASO 2: Apetito de Riesgo -->
    @if (pasoActual() === 1) {
      <div class="step-panel panel-columna-izquierda apetito-panel">
        <h2 class="panel-title">Apetito de riesgo</h2>

        <!-- Tabs -->
        <div class="tabs-container">
          <button
            class="tab-btn"
            [class.active]="modoApetito() === 'seleccionar'"
            (click)="modoApetito.set('seleccionar')">
            <i class="pi pi-search"></i>
            Seleccionar
          </button>
          <button
            class="tab-btn"
            [class.active]="modoApetito() === 'crear'"
            (click)="modoApetito.set('crear')">
            <i class="pi pi-plus"></i>
            Crear nuevos
          </button>
          <button class="btn-guardar-apetito">Guardar</button>
        </div>

        <!-- Layout: Inputs izquierda | Mapa derecha -->
        <div class="apetito-layout">
          <!-- Columna izquierda: Inputs apilados -->
          <div class="apetito-inputs-columna">
            <div class="form-field">
              <label class="field-label">Estado *</label>
              <div class="select-wrapper">
                <select class="field-select">
                  <option>Contenedor Organizacional</option>
                </select>
                <i class="pi pi-chevron-down select-icon"></i>
              </div>
            </div>

            <div class="input-row">
              <label>Eje Y - Probabilidad</label>
              <div class="input-group">
                <input
                  type="number"
                  [ngModel]="probabilidadInput()"
                  (ngModelChange)="actualizarProbabilidad($event)"
                  min="1"
                  max="10"
                  class="number-input">
                <div class="input-controls">
                  <button (click)="actualizarProbabilidad(probabilidadInput() + 1)">
                    <i class="pi pi-chevron-up"></i>
                  </button>
                  <button (click)="actualizarProbabilidad(probabilidadInput() - 1)">
                    <i class="pi pi-chevron-down"></i>
                  </button>
                </div>
              </div>
            </div>

            <div class="input-row">
              <label>Eje X - Impacto</label>
              <div class="input-group">
                <input
                  type="number"
                  [ngModel]="impactoInput()"
                  (ngModelChange)="actualizarImpacto($event)"
                  min="1"
                  max="10"
                  class="number-input">
                <div class="input-controls">
                  <button (click)="actualizarImpacto(impactoInput() + 1)">
                    <i class="pi pi-chevron-up"></i>
                  </button>
                  <button (click)="actualizarImpacto(impactoInput() - 1)">
                    <i class="pi pi-chevron-down"></i>
                  </button>
                </div>
              </div>
            </div>

            <div class="input-row">
              <label>Apetito de riesgo</label>
              <div class="input-group">
                <input
                  type="number"
                  [ngModel]="apetitoRiesgo()"
                  (ngModelChange)="apetitoRiesgo.set($event)"
                  min="0"
                  max="100"
                  class="number-input">
                <div class="input-controls">
                  <button (click)="incrementarApetito()">
                    <i class="pi pi-chevron-up"></i>
                  </button>
                  <button (click)="decrementarApetito()">
                    <i class="pi pi-chevron-down"></i>
                  </button>
                </div>
              </div>
              <span class="input-hint">%</span>
            </div>
          </div>

          <!-- Columna derecha: Mapa de calor -->
          <div class="apetito-mapa-columna">
            <div class="matriz-tabla-wrapper">
              <div class="matriz-tabla-container">
                <div class="eje-y-titulo">Probabilidad</div>
                <table class="matriz-tabla">
                  <tbody>
                    @for (prob of getProbabilidadArray(); track prob) {
                      <tr>
                        <td class="label-y">{{ prob }}</td>
                        @for (imp of getImpactoArray(); track imp) {
                          <td>
                            <div
                              class="matriz-cell"
                              [class]="getCeldaNivelDinamico(prob, imp)"
                              [class.selected]="isCeldaSeleccionadaDinamica(prob, imp)"
                              [class.dentro-apetito]="estaDentroApetitoDinamico(prob, imp)"
                              (click)="seleccionarCeldaDirecta(prob, imp)">
                              @if (isCeldaSeleccionadaDinamica(prob, imp)) {
                                <div class="cell-marker-apetito">
                                  <span>{{ apetitoRiesgo() }}%</span>
                                </div>
                              }
                            </div>
                          </td>
                        }
                      </tr>
                    }
                    <tr class="fila-labels-x">
                      <td></td>
                      @for (i of getImpactoArray(); track i) {
                        <td class="label-x">{{ i }}</td>
                      }
                    </tr>
                  </tbody>
                </table>
              </div>
              <div class="eje-x-titulo">Impacto</div>
            </div>

            <!-- Leyenda -->
            <div class="matriz-leyenda">
              <div class="leyenda-item">
                <span class="leyenda-color bajo"></span>
                <span>Bajo</span>
              </div>
              <div class="leyenda-item">
                <span class="leyenda-color medio"></span>
                <span>Medio</span>
              </div>
              <div class="leyenda-item">
                <span class="leyenda-color alto"></span>
                <span>Alto</span>
              </div>
              <div class="leyenda-item">
                <span class="leyenda-color critico"></span>
                <span>Crítico</span>
              </div>
              <div class="leyenda-item apetito-legend">
                <span class="leyenda-dentro"></span>
                <span>Dentro del apetito</span>
              </div>
              <div class="leyenda-item fuera-legend">
                <span class="leyenda-fuera"></span>
                <span>Fuera del apetito</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    }

    <!-- PASO 3: Objetivos y KPIs -->
    @if (pasoActual() === 2) {
      <div class="step-panel panel-columna-izquierda">
        <h2 class="panel-title">Objetivos y KPIS</h2>

        <!-- Tabs -->
        <div class="tabs-container">
          <button
            class="tab-btn"
            [class.active]="modoObjetivos() === 'seleccionar'"
            (click)="modoObjetivos.set('seleccionar')">
            <i class="pi pi-search"></i>
            Seleccionar
          </button>
          <button
            class="tab-btn"
            [class.active]="modoObjetivos() === 'crear'"
            (click)="modoObjetivos.set('crear')">
            <i class="pi pi-plus"></i>
            Crear nuevos
          </button>
          @if (modoObjetivos() === 'crear') {
            <button class="btn-agregar-objetivo" (click)="abrirFormObjetivo()">
              <i class="pi pi-plus"></i>
              Agregar objetivo
            </button>
          }
        </div>

        <!-- Modo Seleccionar -->
        @if (modoObjetivos() === 'seleccionar') {
          <div class="form-field">
            <div class="select-wrapper">
              <select class="field-select">
                <option>Seleccionar Existente</option>
                @for (obj of objetivosExistentes(); track obj.id) {
                  <option [value]="obj.id">{{ obj.nombre }}</option>
                }
              </select>
              <i class="pi pi-chevron-down select-icon"></i>
            </div>
          </div>
        }

        <!-- Formulario inline para nuevo objetivo -->
        @if (mostrarFormObjetivoInline() && !objetivoEditandoId()) {
          <div class="inline-form objetivo-form-inline">
            <div class="inline-form-header">
              <h4>Nuevo Objetivo</h4>
              <button class="btn-icon-x" (click)="cerrarFormObjetivo()">
                <i class="pi pi-times"></i>
              </button>
            </div>
            <div class="inline-form-body">
              <div class="inline-form-row">
                <div class="form-field flex-2">
                  <label class="field-label">Nombre *</label>
                  <input
                    type="text"
                    class="field-input"
                    [ngModel]="nuevoObjetivoNombre()"
                    (ngModelChange)="nuevoObjetivoNombre.set($event)"
                    placeholder="Nombre del objetivo">
                </div>
                <div class="form-field flex-1">
                  <label class="field-label">Tipo *</label>
                  <div class="select-wrapper">
                    <select
                      class="field-select"
                      [ngModel]="nuevoObjetivoTipo()"
                      (ngModelChange)="nuevoObjetivoTipo.set($event)">
                      <option value="estrategico">Estratégico</option>
                      <option value="operativo">Operativo</option>
                    </select>
                    <i class="pi pi-chevron-down select-icon"></i>
                  </div>
                </div>
              </div>
              <div class="form-field">
                <label class="field-label">Descripción</label>
                <textarea
                  class="field-textarea"
                  [ngModel]="nuevoObjetivoDescripcion()"
                  (ngModelChange)="nuevoObjetivoDescripcion.set($event)"
                  rows="2"
                  placeholder="Descripción del objetivo"></textarea>
              </div>
            </div>
            <div class="inline-form-actions">
              <button class="btn-cancelar-sm" (click)="cerrarFormObjetivo()">Cancelar</button>
              <button class="btn-guardar-sm" (click)="guardarObjetivo()">Crear</button>
            </div>
          </div>
        }

        <!-- Lista de Objetivos -->
        <div class="objetivos-lista">
          @if (objetivos().length > 1) {
            <div class="objetivos-collapse-actions">
              <button class="btn-collapse-all" (click)="expandirTodosObjetivos()">
                <i class="pi pi-angle-double-down"></i> Expandir todos
              </button>
              <button class="btn-collapse-all" (click)="colapsarTodosObjetivos()">
                <i class="pi pi-angle-double-up"></i> Colapsar todos
              </button>
            </div>
          }
          @for (objetivo of objetivos(); track objetivo.id) {
            <div class="objetivo-card" [class.editando]="isEditandoObjetivo(objetivo.id)" [class.colapsado]="isObjetivoColapsado(objetivo.id)">
              <!-- Vista normal del objetivo -->
              @if (!isEditandoObjetivo(objetivo.id)) {
                <div class="objetivo-header objetivo-header-colapsable" (click)="toggleObjetivoColapsado(objetivo.id)">
                  <div class="objetivo-collapse-toggle">
                    <i class="pi" [class.pi-chevron-down]="!isObjetivoColapsado(objetivo.id)" [class.pi-chevron-right]="isObjetivoColapsado(objetivo.id)"></i>
                  </div>
                  <div class="objetivo-info">
                    <h3 class="objetivo-titulo">{{ objetivo.nombre }}</h3>
                    @if (!isObjetivoColapsado(objetivo.id)) {
                      <p class="objetivo-descripcion">{{ objetivo.descripcion }}</p>
                    }
                  </div>
                  <div class="objetivo-actions-top" (click)="$event.stopPropagation()">
                    <span class="objetivo-tag" [class.estrategico]="objetivo.tipo === 'estrategico'">
                      {{ getTipoLabel(objetivo.tipo) }}
                    </span>
                    <span class="kpis-count-badge">{{ objetivo.kpis.length }} KPIs</span>
                    <button class="btn-icon" (click)="abrirFormObjetivo(objetivo)">Editar</button>
                    <button class="btn-icon-x" (click)="eliminarObjetivo(objetivo.id)">
                      <i class="pi pi-times"></i>
                    </button>
                  </div>
                </div>

                <!-- Progress bar -->
                @if (!isObjetivoColapsado(objetivo.id)) {
                  <div class="objetivo-progress">
                    <div class="progress-bar">
                      <div class="progress-fill" [style.width.%]="objetivo.progreso"></div>
                    </div>
                    <span class="progress-label">{{ objetivo.progreso }}%</span>
                  </div>
                }
              } @else {
                <!-- Formulario inline para editar objetivo -->
                <div class="inline-form-body">
                  <div class="inline-form-row">
                    <div class="form-field flex-2">
                      <label class="field-label">Nombre *</label>
                      <input
                        type="text"
                        class="field-input"
                        [ngModel]="nuevoObjetivoNombre()"
                        (ngModelChange)="nuevoObjetivoNombre.set($event)"
                        placeholder="Nombre del objetivo">
                    </div>
                    <div class="form-field flex-1">
                      <label class="field-label">Tipo *</label>
                      <div class="select-wrapper">
                        <select
                          class="field-select"
                          [ngModel]="nuevoObjetivoTipo()"
                          (ngModelChange)="nuevoObjetivoTipo.set($event)">
                          <option value="estrategico">Estratégico</option>
                          <option value="operativo">Operativo</option>
                        </select>
                        <i class="pi pi-chevron-down select-icon"></i>
                      </div>
                    </div>
                  </div>
                  <div class="form-field">
                    <label class="field-label">Descripción</label>
                    <textarea
                      class="field-textarea"
                      [ngModel]="nuevoObjetivoDescripcion()"
                      (ngModelChange)="nuevoObjetivoDescripcion.set($event)"
                      rows="2"
                      placeholder="Descripción del objetivo"></textarea>
                  </div>
                </div>
                <div class="inline-form-actions">
                  <button class="btn-cancelar-sm" (click)="cerrarFormObjetivo()">Cancelar</button>
                  <button class="btn-guardar-sm" (click)="guardarObjetivo()">Guardar</button>
                </div>
              }

              <!-- KPIs Section -->
              @if (!isEditandoObjetivo(objetivo.id) && !isObjetivoColapsado(objetivo.id)) {
                <div class="kpis-section">
                  <div class="kpis-header">
                    <span class="kpis-title">
                      KPIs
                      <span class="kpis-badge">{{ objetivo.kpis.length }}</span>
                    </span>
                    <button class="btn-agregar-kpi" (click)="abrirFormKPI(objetivo.id)">
                      Agregar KPIs
                      <i class="pi pi-plus"></i>
                    </button>
                  </div>

                  <!-- Formulario inline para nuevo KPI -->
                  @if (isFormKPIVisible(objetivo.id) && !kpiEditandoId()) {
                    <div class="inline-form kpi-form-inline">
                      <div class="inline-form-body">
                        <div class="inline-form-row">
                          <div class="form-field flex-2">
                            <label class="field-label">Nombre *</label>
                            <input
                              type="text"
                              class="field-input"
                              [ngModel]="nuevoKPINombre()"
                              (ngModelChange)="nuevoKPINombre.set($event)"
                              placeholder="Nombre del KPI">
                          </div>
                        </div>
                        <div class="inline-form-row">
                          <div class="form-field flex-1">
                            <label class="field-label">Actual</label>
                            <input
                              type="number"
                              class="field-input"
                              [ngModel]="nuevoKPIActual()"
                              (ngModelChange)="nuevoKPIActual.set($event)"
                              min="0">
                          </div>
                          <div class="form-field flex-1">
                            <label class="field-label">Meta</label>
                            <input
                              type="number"
                              class="field-input"
                              [ngModel]="nuevoKPIMeta()"
                              (ngModelChange)="nuevoKPIMeta.set($event)"
                              min="0">
                          </div>
                          <div class="form-field flex-1">
                            <label class="field-label">Escala</label>
                            <div class="select-wrapper">
                              <select
                                class="field-select"
                                [ngModel]="nuevoKPIEscala()"
                                (ngModelChange)="nuevoKPIEscala.set($event)">
                                @for (escala of escalasOptions; track escala.value) {
                                  <option [value]="escala.value">{{ escala.label }}</option>
                                }
                              </select>
                              <i class="pi pi-chevron-down select-icon"></i>
                            </div>
                          </div>
                          <div class="form-field flex-1">
                            <label class="field-label">Umbral %</label>
                            <input
                              type="number"
                              class="field-input umbral-input"
                              [ngModel]="nuevoKPIUmbralAlerta()"
                              (ngModelChange)="nuevoKPIUmbralAlerta.set($event)"
                              min="0"
                              max="100">
                          </div>
                          <div class="form-field flex-1">
                            <label class="field-label">Alerta</label>
                            <div class="select-wrapper">
                              <select
                                class="field-select"
                                [ngModel]="nuevoKPIDireccion()"
                                (ngModelChange)="nuevoKPIDireccion.set($event)">
                                @for (dir of direccionOptions; track dir.value) {
                                  <option [value]="dir.value">{{ dir.label }}</option>
                                }
                              </select>
                              <i class="pi pi-chevron-down select-icon"></i>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="inline-form-actions">
                        <button class="btn-cancelar-sm" (click)="cerrarFormKPI()">Cancelar</button>
                        <button class="btn-guardar-sm" (click)="guardarKPI()">Crear</button>
                      </div>
                    </div>
                  }

                  @if (objetivo.kpis.length > 0) {
                    <div class="kpis-lista">
                      @for (kpi of objetivo.kpis; track kpi.id) {
                        <div class="kpi-item" [class.editando]="isEditandoKPI(kpi.id)" [class.has-alert]="tieneAlertaKPI(kpi)">
                          @if (!isEditandoKPI(kpi.id) || !isFormKPIVisible(objetivo.id)) {
                            <!-- Vista normal del KPI -->
                            <div class="kpi-info">
                              <div class="kpi-nombre-row">
                                <span class="kpi-nombre">{{ kpi.nombre }}</span>
                                @if (tieneAlertaKPI(kpi)) {
                                  <span class="kpi-alert-badge" title="Por debajo del umbral ({{ kpi.umbralAlerta }}%)">
                                    <i class="pi pi-exclamation-triangle"></i>
                                    Alerta
                                  </span>
                                }
                              </div>
                              <div class="kpi-meta">
                                <span class="meta-label">Actual</span>
                                <span class="meta-value">{{ kpi.actual }}</span>
                                <span class="meta-label">Meta</span>
                                <span class="meta-value">{{ kpi.meta }}</span>
                                <span class="meta-label">{{ kpi.escala }}</span>
                              </div>
                              <div class="kpi-progress-bar">
                                <div class="kpi-progress-fill" [class]="getKPIProgresoColor(kpi)" [style.width.%]="getKPIProgreso(kpi)"></div>
                              </div>
                            </div>
                            <div class="kpi-actions">
                              <button class="btn-icon" (click)="abrirFormKPI(objetivo.id, kpi)">Editar</button>
                              <button class="btn-icon-x" (click)="eliminarKPI(objetivo.id, kpi.id)">
                                <i class="pi pi-times"></i>
                              </button>
                            </div>
                          } @else {
                            <!-- Formulario inline para editar KPI -->
                            <div class="kpi-edit-form">
                              <div class="inline-form-row">
                                <div class="form-field flex-2">
                                  <label class="field-label">Nombre *</label>
                                  <input
                                    type="text"
                                    class="field-input"
                                    [ngModel]="nuevoKPINombre()"
                                    (ngModelChange)="nuevoKPINombre.set($event)"
                                    placeholder="Nombre del KPI">
                                </div>
                              </div>
                              <div class="inline-form-row">
                                <div class="form-field flex-1">
                                  <label class="field-label">Actual</label>
                                  <input
                                    type="number"
                                    class="field-input"
                                    [ngModel]="nuevoKPIActual()"
                                    (ngModelChange)="nuevoKPIActual.set($event)"
                                    min="0">
                                </div>
                                <div class="form-field flex-1">
                                  <label class="field-label">Meta</label>
                                  <input
                                    type="number"
                                    class="field-input"
                                    [ngModel]="nuevoKPIMeta()"
                                    (ngModelChange)="nuevoKPIMeta.set($event)"
                                    min="0">
                                </div>
                                <div class="form-field flex-1">
                                  <label class="field-label">Escala</label>
                                  <div class="select-wrapper">
                                    <select
                                      class="field-select"
                                      [ngModel]="nuevoKPIEscala()"
                                      (ngModelChange)="nuevoKPIEscala.set($event)">
                                      @for (escala of escalasOptions; track escala.value) {
                                        <option [value]="escala.value">{{ escala.label }}</option>
                                      }
                                    </select>
                                    <i class="pi pi-chevron-down select-icon"></i>
                                  </div>
                                </div>
                                <div class="form-field flex-1">
                                  <label class="field-label">Umbral %</label>
                                  <input
                                    type="number"
                                    class="field-input umbral-input"
                                    [ngModel]="nuevoKPIUmbralAlerta()"
                                    (ngModelChange)="nuevoKPIUmbralAlerta.set($event)"
                                    min="0"
                                    max="100">
                                </div>
                                <div class="form-field flex-1">
                                  <label class="field-label">Alerta</label>
                                  <div class="select-wrapper">
                                    <select
                                      class="field-select"
                                      [ngModel]="nuevoKPIDireccion()"
                                      (ngModelChange)="nuevoKPIDireccion.set($event)">
                                      @for (dir of direccionOptions; track dir.value) {
                                        <option [value]="dir.value">{{ dir.label }}</option>
                                      }
                                    </select>
                                    <i class="pi pi-chevron-down select-icon"></i>
                                  </div>
                                </div>
                              </div>
                              <div class="inline-form-actions">
                                <button class="btn-cancelar-sm" (click)="cerrarFormKPI()">Cancelar</button>
                                <button class="btn-guardar-sm" (click)="guardarKPI()">Guardar</button>
                              </div>
                            </div>
                          }
                        </div>
                      }
                    </div>
                  }
                </div>
              }
            </div>
          }

          <!-- Empty state -->
          @if (objetivos().length === 0 && !mostrarFormObjetivoInline()) {
            <div class="empty-state">
              <i class="pi pi-flag"></i>
              <p>No hay objetivos agregados</p>
              <button class="btn-crear-primero" (click)="modoObjetivos.set('crear'); abrirFormObjetivo()">
                <i class="pi pi-plus"></i>
                Crear primer objetivo
              </button>
            </div>
          }
        </div>
      </div>
    }

    <!-- PASO 4: Revisión -->
    @if (pasoActual() === 3) {
      <div class="step-panel panel-columna-izquierda revision-panel">
        <h2 class="panel-title">Revisión</h2>

        <!-- Resumen en una columna -->
        <div class="revision-single-column">
          <!-- Info básica -->
          <div class="revision-section">
            <div class="section-row">
              <label>Nombre del proceso</label>
              <span class="section-value">{{ nombreProceso() }}</span>
            </div>
            <div class="section-row">
              <label>Estado *</label>
              <div class="select-wrapper compact">
                <select class="field-select" [ngModel]="tipoProceso()" disabled>
                  @for (tipo of tiposProcesoOptions; track tipo.value) {
                    <option [value]="tipo.value">{{ tipo.label }}</option>
                  }
                </select>
              </div>
            </div>
          </div>

          <!-- Descripción -->
          <div class="revision-section">
            <label>Descripción detallada *</label>
            <div class="descripcion-box">
              {{ descripcionProceso() }}
            </div>
          </div>

          <!-- Apetito de riesgo resumen -->
          <div class="revision-section">
            <label>Apetito de riesgo</label>
            <div class="apetito-resumen">
              <div class="apetito-valores">
                <span><strong>Probabilidad:</strong> {{ probabilidadInput() }}</span>
                <span><strong>Impacto:</strong> {{ impactoInput() }}</span>
                <span><strong>Apetito:</strong> {{ apetitoRiesgo() }}%</span>
              </div>
            </div>
          </div>

          <!-- Objetivos y KPIs -->
          @if (objetivos().length > 1) {
            <div class="objetivos-collapse-actions revision-collapse-actions">
              <button class="btn-collapse-all" (click)="expandirTodosObjetivos()">
                <i class="pi pi-angle-double-down"></i> Expandir todos
              </button>
              <button class="btn-collapse-all" (click)="colapsarTodosObjetivos()">
                <i class="pi pi-angle-double-up"></i> Colapsar todos
              </button>
            </div>
          }
          @for (objetivo of objetivos(); track objetivo.id) {
            <div class="revision-objetivo" [class.colapsado]="isObjetivoColapsado(objetivo.id)">
              <div class="objetivo-header-rev objetivo-header-colapsable" (click)="toggleObjetivoColapsado(objetivo.id)">
                <div class="objetivo-collapse-toggle">
                  <i class="pi" [class.pi-chevron-down]="!isObjetivoColapsado(objetivo.id)" [class.pi-chevron-right]="isObjetivoColapsado(objetivo.id)"></i>
                </div>
                <span class="objetivo-titulo-rev">{{ objetivo.nombre }}</span>
                <div class="objetivo-header-rev-actions" (click)="$event.stopPropagation()">
                  <span class="objetivo-tag" [class.estrategico]="objetivo.tipo === 'estrategico'">
                    {{ getTipoLabel(objetivo.tipo) }}
                  </span>
                  <span class="kpis-count-badge">{{ objetivo.kpis.length }} KPIs</span>
                </div>
              </div>

              @if (!isObjetivoColapsado(objetivo.id)) {
                <p class="objetivo-desc-rev">{{ objetivo.descripcion }}</p>
                <div class="objetivo-progress-rev">
                  <div class="progress-bar">
                    <div class="progress-fill" [style.width.%]="objetivo.progreso"></div>
                  </div>
                </div>

                <div class="kpis-section-rev">
                  <div class="kpis-header-rev">
                    <span>KPIs <span class="badge">{{ objetivo.kpis.length }}</span></span>
                    <button class="btn-link" (click)="abrirFormKPI(objetivo.id)">Agregar KPIs +</button>
                  </div>

                  @for (kpi of objetivo.kpis; track kpi.id) {
                    <div class="kpi-item-rev">
                      <span class="kpi-nombre-rev">{{ kpi.nombre }}</span>
                      <div class="kpi-meta-rev">
                        <span>Meta</span> <strong>{{ kpi.meta }}%</strong>
                        <span>Escala</span> <strong>{{ kpi.escala }}</strong>
                      </div>
                      <div class="kpi-progress-rev">
                        <div class="kpi-fill-rev" [style.width.%]="kpi.meta"></div>
                      </div>
                      <div class="kpi-actions-rev">
                        <button class="btn-text-sm" (click)="abrirFormKPI(objetivo.id, kpi)">Editar</button>
                        <button class="btn-icon-sm" (click)="eliminarKPI(objetivo.id, kpi.id)">
                          <i class="pi pi-times"></i>
                        </button>
                      </div>
                    </div>
                  }
                </div>
              }
            </div>
          }
        </div>
      </div>
    }
  </div>

  <!-- Footer Fixed -->
  <div class="page-footer-fixed">
    <div class="footer-content">
      @if (pasoActual() > 0) {
        <button class="btn-atras" (click)="anterior()">
          <i class="pi pi-arrow-left"></i>
          Atrás
        </button>
      } @else {
        <button class="btn-atras" (click)="cancelar()">Cancelar</button>
      }

      @if (pasoActual() < 3) {
        <button class="btn-siguiente" (click)="siguiente()">Siguiente</button>
      } @else {
        <button class="btn-guardar" (click)="guardarEIrEditor()">Guardar e ir editor</button>
      }
    </div>
  </div>
</div>

<!-- Drawer Objetivos y KPIs -->
<p-drawer
  [(visible)]="showObjetivosDrawer"
  position="right"
  [style]="{width: '900px'}"
  [modal]="true"
  [dismissible]="true"
  styleClass="objetivos-drawer">

  <ng-template pTemplate="header">
    <div class="drawer-header-custom">
      <h2>Detalle</h2>
      <span class="drawer-subtitle">Orca&#64;Securityby Design</span>
    </div>
  </ng-template>

  <div class="drawer-objetivos-content">
    <!-- Layout de dos columnas -->
    <div class="drawer-two-columns">
      <!-- Columna izquierda: Lista de objetivos -->
      <div class="drawer-left-column">
        <!-- Header con crear y buscar -->
        <div class="drawer-list-header">
          <button class="btn-crear-objetivo-drawer" (click)="crearObjetivoDesdeDrawer()">
            <span>Crear Objetivo</span>
            <i class="pi pi-plus"></i>
          </button>
          <div class="drawer-search">
            <i class="pi pi-search"></i>
            <input
              type="text"
              placeholder="Buscar"
              [ngModel]="busquedaObjetivos()"
              (ngModelChange)="busquedaObjetivos.set($event)">
          </div>
        </div>

        <!-- Lista de objetivos -->
        <div class="drawer-objetivos-lista">
          @for (objetivo of objetivosFiltrados(); track objetivo.id) {
            <div
              class="drawer-objetivo-item"
              [class.selected]="objetivoSeleccionadoId() === objetivo.id"
              (click)="seleccionarObjetivoEnDrawer(objetivo.id)">
              <div class="drawer-objetivo-header">
                <h4>{{ objetivo.nombre }}</h4>
                <div class="drawer-objetivo-meta">
                  <p-tag
                    [value]="getTipoLabel(objetivo.tipo)"
                    [severity]="objetivo.tipo === 'estrategico' ? 'success' : 'info'"
                    styleClass="tag-sm" />
                  <span class="kpi-count">{{ objetivo.kpis.length }}</span>
                </div>
                <i class="pi pi-chevron-right"></i>
              </div>
              <p class="drawer-objetivo-desc">{{ objetivo.descripcion }}</p>
              <div class="drawer-objetivo-progress">
                <div class="progress-track">
                  <div class="progress-fill" [class]="getProgresoColor(objetivo.progreso)" [style.width.%]="objetivo.progreso"></div>
                </div>
              </div>
            </div>
          }

          @if (objetivosFiltrados().length === 0) {
            <div class="drawer-empty-state">
              <i class="pi pi-flag"></i>
              <p>No hay objetivos</p>
              <button class="btn-crear-primero" (click)="crearObjetivoDesdeDrawer()">
                <i class="pi pi-plus"></i>
                Crear primer objetivo
              </button>
            </div>
          }
        </div>
      </div>

      <!-- Columna derecha: Detalle del objetivo seleccionado -->
      <div class="drawer-right-column">
        @if (objetivoSeleccionado(); as obj) {
          <!-- Header del detalle -->
          <div class="drawer-detail-header">
            @if (!drawerEditandoObjetivo()) {
              <!-- Vista de solo lectura -->
              <div class="detail-title-row">
                <h3>{{ obj.nombre }}</h3>
                <p-tag
                  [value]="getTipoLabel(obj.tipo)"
                  [severity]="obj.tipo === 'estrategico' ? 'success' : 'info'" />
              </div>
              <p class="detail-description">{{ obj.descripcion }}</p>
              <div class="detail-progress-section">
                <div class="progress-track-lg">
                  <div class="progress-fill" [class]="getProgresoColor(obj.progreso)" [style.width.%]="obj.progreso"></div>
                </div>
                <span class="progress-label">{{ obj.progreso }}%</span>
              </div>
              <div class="detail-actions">
                <button class="btn-editar" (click)="iniciarEdicionObjetivoDrawer()">Editar</button>
                <button class="btn-eliminar-x" (click)="eliminarObjetivoDrawer()">
                  <i class="pi pi-times"></i>
                </button>
              </div>
            } @else {
              <!-- Modo edición -->
              <div class="detail-edit-form">
                <div class="edit-row">
                  <input
                    type="text"
                    class="edit-input-title"
                    [ngModel]="nuevoObjetivoNombre()"
                    (ngModelChange)="nuevoObjetivoNombre.set($event)"
                    placeholder="Nombre del objetivo">
                  <p-tag
                    [value]="getTipoLabel(nuevoObjetivoTipo())"
                    [severity]="nuevoObjetivoTipo() === 'estrategico' ? 'success' : 'info'" />
                  <button class="btn-collapse-edit" (click)="cancelarEdicionObjetivoDrawer()">
                    <i class="pi pi-chevron-up"></i>
                  </button>
                </div>
                <textarea
                  class="edit-textarea"
                  [ngModel]="nuevoObjetivoDescripcion()"
                  (ngModelChange)="nuevoObjetivoDescripcion.set($event)"
                  rows="3"
                  placeholder="Descripción del objetivo"></textarea>
                <div class="edit-tipo-row">
                  <label>Tipo:</label>
                  <select
                    class="edit-select"
                    [ngModel]="nuevoObjetivoTipo()"
                    (ngModelChange)="nuevoObjetivoTipo.set($event)">
                    <option value="estrategico">Estratégico</option>
                    <option value="operativo">Operativo</option>
                  </select>
                </div>
                <div class="edit-actions">
                  <button class="btn-delete-objetivo" (click)="eliminarObjetivoDrawer()">
                    <i class="pi pi-trash"></i>
                  </button>
                  <div class="edit-actions-right">
                    <button class="btn-cancelar" (click)="cancelarEdicionObjetivoDrawer()">Cancelar</button>
                    <button class="btn-guardar-sm" (click)="guardarObjetivoDrawer()">Guardar</button>
                  </div>
                </div>
              </div>
            }
          </div>

          <!-- KPIs Section -->
          <div class="drawer-kpis-section">
            <div class="kpis-section-header">
              <div class="kpis-title">
                <span>KPIs</span>
                <span class="kpi-badge">{{ obj.kpis.length }}</span>
              </div>
              <button class="btn-agregar-kpi-drawer" (click)="iniciarNuevoKPIDrawer()">
                Agregar KPIs
                <i class="pi pi-plus"></i>
              </button>
            </div>

            <!-- Form para nuevo KPI -->
            @if (drawerNuevoKPI()) {
              <div class="kpi-edit-row">
                <input
                  type="text"
                  class="kpi-input-nombre"
                  [ngModel]="nuevoKPINombre()"
                  (ngModelChange)="nuevoKPINombre.set($event)"
                  placeholder="Nombre del KPI">
                <input
                  type="number"
                  class="kpi-input-actual"
                  [ngModel]="nuevoKPIActual()"
                  (ngModelChange)="nuevoKPIActual.set($event)"
                  min="0"
                  placeholder="Actual">
                <input
                  type="number"
                  class="kpi-input-meta"
                  [ngModel]="nuevoKPIMeta()"
                  (ngModelChange)="nuevoKPIMeta.set($event)"
                  min="0"
                  placeholder="Meta">
                <select
                  class="kpi-select-escala"
                  [ngModel]="nuevoKPIEscala()"
                  (ngModelChange)="nuevoKPIEscala.set($event)">
                  @for (escala of escalasOptions; track escala.value) {
                    <option [value]="escala.value">{{ escala.label }}</option>
                  }
                </select>
                <input
                  type="number"
                  class="kpi-input-umbral"
                  [ngModel]="nuevoKPIUmbralAlerta()"
                  (ngModelChange)="nuevoKPIUmbralAlerta.set($event)"
                  min="0"
                  max="100"
                  placeholder="Umbral %">
                <button class="btn-check" (click)="guardarKPIDrawer()">
                  <i class="pi pi-check"></i>
                </button>
                <button class="btn-x" (click)="cancelarKPIDrawer()">
                  <i class="pi pi-times"></i>
                </button>
              </div>
            }

            <!-- Lista de KPIs -->
            <div class="drawer-kpis-lista">
              @for (kpi of obj.kpis; track kpi.id) {
                <div class="drawer-kpi-item" [class.has-alert]="tieneAlertaKPI(kpi)">
                  @if (drawerEditandoKPIId() === kpi.id) {
                    <!-- Modo edición KPI -->
                    <div class="kpi-edit-row">
                      <input
                        type="text"
                        class="kpi-input-nombre"
                        [ngModel]="nuevoKPINombre()"
                        (ngModelChange)="nuevoKPINombre.set($event)"
                        placeholder="Nombre del KPI">
                      <input
                        type="number"
                        class="kpi-input-actual"
                        [ngModel]="nuevoKPIActual()"
                        (ngModelChange)="nuevoKPIActual.set($event)"
                        min="0"
                        placeholder="Actual">
                      <input
                        type="number"
                        class="kpi-input-meta"
                        [ngModel]="nuevoKPIMeta()"
                        (ngModelChange)="nuevoKPIMeta.set($event)"
                        min="0"
                        placeholder="Meta">
                      <select
                        class="kpi-select-escala"
                        [ngModel]="nuevoKPIEscala()"
                        (ngModelChange)="nuevoKPIEscala.set($event)">
                        @for (escala of escalasOptions; track escala.value) {
                          <option [value]="escala.value">{{ escala.label }}</option>
                        }
                      </select>
                      <input
                        type="number"
                        class="kpi-input-umbral"
                        [ngModel]="nuevoKPIUmbralAlerta()"
                        (ngModelChange)="nuevoKPIUmbralAlerta.set($event)"
                        min="0"
                        max="100"
                        placeholder="Umbral %">
                      <button class="btn-check" (click)="guardarKPIDrawer()">
                        <i class="pi pi-check"></i>
                      </button>
                      <button class="btn-x" (click)="cancelarKPIDrawer()">
                        <i class="pi pi-times"></i>
                      </button>
                    </div>
                  } @else {
                    <!-- Vista KPI -->
                    <div class="kpi-view-row">
                      <div class="kpi-info">
                        <div class="kpi-nombre-row">
                          <h5>{{ kpi.nombre }}</h5>
                          @if (tieneAlertaKPI(kpi)) {
                            <span class="kpi-alert-badge" title="Por debajo del umbral ({{ kpi.umbralAlerta }}%)">
                              <i class="pi pi-exclamation-triangle"></i>
                              Alerta
                            </span>
                          }
                        </div>
                        <div class="kpi-meta-info">
                          <span class="meta-label">Actual</span>
                          <span class="meta-value">{{ kpi.actual }}</span>
                          <span class="meta-label">Meta</span>
                          <span class="meta-value">{{ kpi.meta }}</span>
                          <span class="meta-label">{{ kpi.escala }}</span>
                        </div>
                        <div class="kpi-progress-bar">
                          <div class="kpi-progress-fill" [class]="getKPIProgresoColor(kpi)" [style.width.%]="getKPIProgreso(kpi)"></div>
                        </div>
                      </div>
                      <div class="kpi-actions">
                        <button class="btn-editar-sm" (click)="iniciarEdicionKPIDrawer(kpi)">Editar</button>
                        <button class="btn-x-sm" (click)="eliminarKPIDrawer(kpi.id)">
                          <i class="pi pi-times"></i>
                        </button>
                      </div>
                    </div>
                  }
                </div>
              }

              @if (obj.kpis.length === 0 && !drawerNuevoKPI()) {
                <div class="kpi-empty-state">
                  <p>No hay KPIs agregados</p>
                </div>
              }
            </div>
          </div>
        } @else {
          <!-- No hay objetivo seleccionado -->
          <div class="drawer-no-selection">
            <i class="pi pi-arrow-left"></i>
            <p>Selecciona un objetivo de la lista</p>
          </div>
        }
      </div>
    </div>
  </div>
</p-drawer>

