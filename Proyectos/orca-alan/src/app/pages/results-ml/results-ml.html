<div class="results-ml-container">
  <!-- Vista de búsqueda (cuando no hay entidad seleccionada) -->
  @if (!estado().entidadSeleccionada) {
    <!-- Header -->
    <div class="page-header">
      <h1>Resultados de Inteligencia</h1>
      <p class="page-subtitle">Gestión de insights de IA/ML para activos y procesos</p>
    </div>

    <!-- Toolbar -->
    <p-toolbar styleClass="toolbar-attached">
      <ng-template pTemplate="start">
        <div class="flex align-items-center gap-3">
          <!-- Botón de hallazgos pendientes -->
          @if (totalHallazgosPendientes() > 0) {
            <p-tag
              [value]="totalHallazgosPendientes() + ' pendientes'"
              severity="warn"
              icon="pi pi-bell" />
          }

          <!-- Filtro por tipo de entidad -->
          <p-select
            [options]="tipoEntidadOptions"
            [ngModel]="tipoEntidadFiltro()"
            (ngModelChange)="tipoEntidadFiltro.set($event)"
            optionLabel="label"
            optionValue="value"
            placeholder="Tipo de entidad"
            [style]="{ minWidth: '180px' }"
            appendTo="body">
            <ng-template let-item pTemplate="item">
              <div class="flex align-items-center gap-2">
                <i [class]="item.icon"></i>
                <span>{{ item.label }}</span>
              </div>
            </ng-template>
            <ng-template let-item pTemplate="selectedItem">
              <div class="flex align-items-center gap-2">
                <i [class]="item.icon"></i>
                <span>{{ item.label }}</span>
              </div>
            </ng-template>
          </p-select>
        </div>
      </ng-template>

      <ng-template pTemplate="center">
        <p-iconfield>
          <p-inputicon styleClass="pi pi-search" />
          <input
            type="text"
            pInputText
            placeholder="Buscar en todos los campos..."
            [ngModel]="busquedaEntidad()"
            (ngModelChange)="busquedaEntidad.set($event)"
            style="width: 280px" />
        </p-iconfield>
      </ng-template>

      <ng-template pTemplate="end">
        <div class="flex gap-2 align-items-center">
          <p-button
            icon="pi pi-refresh"
            severity="secondary"
            [rounded]="true"
            [text]="true"
            (onClick)="refrescarDatos()"
            pTooltip="Refrescar"
            tooltipPosition="bottom" />
        </div>
      </ng-template>
    </p-toolbar>

    <!-- Lista de entidades -->
    <p-card styleClass="table-card">
      <p-table
        [value]="entidadesFiltradasPorTipo()"
        [paginator]="true"
        [rows]="10"
        [rowsPerPageOptions]="[10, 25, 50]"
        [showCurrentPageReport]="true"
        currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords}"
        [rowHover]="true"
        styleClass="p-datatable-sm">

        <ng-template pTemplate="header">
          <tr>
            <th pSortableColumn="tipo" style="width: 100px">Tipo <p-sortIcon field="tipo" /></th>
            <th pSortableColumn="nombre">Nombre <p-sortIcon field="nombre" /></th>
            <th pSortableColumn="area">Área <p-sortIcon field="area" /></th>
            <th pSortableColumn="responsable">Responsable <p-sortIcon field="responsable" /></th>
            <th style="width: 150px; text-align: center">Hallazgos Pendientes</th>
            <th style="width: 80px"></th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-entidad>
          <tr class="row-clickable" (click)="seleccionarEntidad(entidad)">
            <td>
              <p-tag
                [value]="entidad.tipo === 'activo' ? 'Activo' : 'Proceso'"
                [icon]="getTipoEntidadIcon(entidad.tipo)"
                [severity]="entidad.tipo === 'activo' ? 'info' : 'success'" />
            </td>
            <td>
              <span class="font-medium">{{ entidad.nombre }}</span>
            </td>
            <td>{{ entidad.area || '-' }}</td>
            <td>{{ entidad.responsable || '-' }}</td>
            <td class="text-center">
              @if (entidad.cantidadHallazgosPendientes > 0) {
                <p-badge
                  [value]="entidad.cantidadHallazgosPendientes.toString()"
                  severity="warn" />
              } @else {
                <span class="text-secondary">-</span>
              }
            </td>
            <td class="text-center">
              <p-button
                icon="pi pi-chevron-right"
                [rounded]="true"
                [text]="true"
                size="small" />
            </td>
          </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="6" class="text-center py-6">
              <div class="empty-state">
                <i class="pi pi-search text-4xl text-secondary mb-3"></i>
                <p class="text-secondary">No se encontraron entidades</p>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </p-card>
  }

  <!-- Vista de resultados (cuando hay entidad seleccionada) -->
  @if (estado().entidadSeleccionada; as entidad) {
    <!-- Header con breadcrumb -->
    <div class="results-header">
      <div class="breadcrumb-nav">
        <p-button
          icon="pi pi-arrow-left"
          label="Volver"
          [text]="true"
          severity="secondary"
          (onClick)="volverABusqueda()" />
        <span class="text-secondary mx-2">/</span>
        <span class="font-medium">{{ entidad.nombre }}</span>
      </div>

      <div class="header-main">
        <div class="header-left">
          <div class="flex align-items-center gap-3 mb-2">
            <p-tag
              [value]="entidad.tipo === 'activo' ? 'Activo' : 'Proceso'"
              [icon]="getTipoEntidadIcon(entidad.tipo)"
              [severity]="entidad.tipo === 'activo' ? 'info' : 'success'" />
            <span class="text-secondary text-sm">{{ entidad.id }}</span>
          </div>
          <h1>{{ entidad.nombre }}</h1>
          @if (entidad.area) {
            <p class="text-secondary">{{ entidad.area }} - {{ entidad.responsable }}</p>
          }
        </div>

        <div class="header-right">
          <!-- Botones eliminados según diseño -->
        </div>
      </div>
    </div>

    <!-- Barra de estadísticas horizontal -->
    @if (resultadoActual(); as resultado) {
      <div class="stats-bar mb-4">
        <div class="stats-chips">
          <p-chip styleClass="stat-chip">
            <i class="pi pi-clock mr-2"></i>
            <span class="stat-label">Último análisis:</span>
            <span class="stat-value">{{ formatearFechaHora(resultado.fechaUltimoAnalisis) }}</span>
          </p-chip>
          <p-chip styleClass="stat-chip stat-tendencia">
            <i class="pi pi-chart-line mr-2"></i>
            <span class="stat-value">{{ resultado.contadores.totalTendencias }}</span>
            <span class="stat-label">Tendencias</span>
          </p-chip>
          <p-chip styleClass="stat-chip stat-mitigacion">
            <i class="pi pi-shield mr-2"></i>
            <span class="stat-value">{{ resultado.contadores.totalMitigaciones }}</span>
            <span class="stat-label">Mitigaciones</span>
          </p-chip>
          <p-chip styleClass="stat-chip stat-oportunidad">
            <i class="pi pi-lightbulb mr-2"></i>
            <span class="stat-value">{{ resultado.contadores.totalOportunidades }}</span>
            <span class="stat-label">Oportunidades</span>
          </p-chip>
          <p-chip styleClass="stat-chip stat-riesgo">
            <i class="pi pi-exclamation-triangle mr-2"></i>
            <span class="stat-value">{{ resultado.contadores.totalRiesgos }}</span>
            <span class="stat-label">Riesgos</span>
          </p-chip>
          <p-chip styleClass="stat-chip stat-pendiente">
            <i class="pi pi-bell mr-2"></i>
            <span class="stat-value">{{ resultado.contadores.pendientes }}</span>
            <span class="stat-label">Pendientes</span>
          </p-chip>
        </div>
      </div>

      <!-- Toolbar de hallazgos -->
      <p-toolbar styleClass="hallazgos-toolbar toolbar-attached">
        <ng-template pTemplate="start">
          <div class="flex align-items-center gap-3">
            <!-- Checkbox de selección masiva -->
            <div class="flex align-items-center gap-2">
              <p-checkbox
                [ngModel]="todosLosHallazgos().length > 0 && hallazgosSeleccionados().length === todosLosHallazgos().length"
                (ngModelChange)="toggleSeleccionTodos($event)"
                [binary]="true"
                inputId="selectAll" />
              @if (hallazgosSeleccionados().length > 0) {
                <p-button
                  [label]="hallazgosSeleccionados().length + ' seleccionados'"
                  icon="pi pi-cog"
                  severity="success"
                  size="small"
                  (onClick)="showAccionesMasivasDrawer.set(true)"
                  pTooltip="Acciones masivas"
                  tooltipPosition="bottom" />
              }
            </div>

            @if (hayFiltrosActivos()) {
              <p-divider layout="vertical" styleClass="mx-1" />
              <p-button
                icon="pi pi-filter-slash"
                label="Limpiar filtros"
                severity="secondary"
                [rounded]="true"
                [text]="true"
                size="small"
                (onClick)="limpiarFiltrosHallazgos()"
                pTooltip="Limpiar filtros"
                tooltipPosition="bottom" />
            }
          </div>
        </ng-template>

        <ng-template pTemplate="center">
          <p-iconfield>
            <p-inputicon styleClass="pi pi-search" />
            <input
              type="text"
              pInputText
              placeholder="Buscar hallazgos..."
              [ngModel]="busquedaHallazgoService()"
              (ngModelChange)="onBusquedaHallazgoServiceChange($event)"
              style="width: 280px" />
          </p-iconfield>
        </ng-template>

        <ng-template pTemplate="end">
        </ng-template>
      </p-toolbar>

      <!-- Tabla unificada de hallazgos -->
      <p-card styleClass="table-card">
        <p-table
          #dtHallazgos
          [value]="todosLosHallazgos()"
          [rowHover]="true"
          [paginator]="true"
          [rows]="10"
          [rowsPerPageOptions]="[10, 25, 50]"
          [showCurrentPageReport]="true"
          currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords}"
          styleClass="p-datatable-sm hallazgos-table"
          [selection]="hallazgosSeleccionados()"
          (selectionChange)="onSelectionChange($event)"
          dataKey="id">
          <ng-template pTemplate="header">
            <tr>
              <th style="width: 50px">
                <p-tableHeaderCheckbox />
              </th>
              <th pSortableColumn="tipoHallazgo" style="width: 150px">
                Tipo <p-sortIcon field="tipoHallazgo" />
              </th>
              <th pSortableColumn="titulo">Título <p-sortIcon field="titulo" /></th>
              <th pSortableColumn="confianza" style="width: 150px">Confianza <p-sortIcon field="confianza" /></th>
              <th pSortableColumn="fechaDeteccion" style="width: 180px">Fecha <p-sortIcon field="fechaDeteccion" /></th>
              <th pSortableColumn="estado" style="width: 140px">Estado <p-sortIcon field="estado" /></th>
              <th style="width: 120px">Acciones</th>
            </tr>
            <tr>
              <th></th>
              <th>
                <p-multiSelect
                  [options]="tipoHallazgoOptions"
                  [ngModel]="filtroTiposHallazgo()"
                  (ngModelChange)="onFiltroTipoChange($event)"
                  optionLabel="label"
                  optionValue="value"
                  placeholder="Todos"
                  appendTo="body"
                  [showHeader]="false"
                  [style]="{ width: '100%' }">
                  <ng-template let-option pTemplate="item">
                    <div class="flex align-items-center gap-2">
                      <i [class]="option.icon"></i>
                      <span>{{ option.label }}</span>
                    </div>
                  </ng-template>
                </p-multiSelect>
              </th>
              <th>
                <input
                  pInputText
                  type="text"
                  [ngModel]="busquedaHallazgoService()"
                  (ngModelChange)="onBusquedaHallazgoServiceChange($event)"
                  placeholder="Buscar..."
                  style="width: 100%" />
              </th>
              <th>
                <p-select
                  [options]="confianzaFilterOptions"
                  [ngModel]="filtroConfianza()"
                  (ngModelChange)="onFiltroConfianzaChange($event)"
                  optionLabel="label"
                  optionValue="value"
                  placeholder="Todos"
                  appendTo="body"
                  [showClear]="true"
                  [style]="{ width: '100%' }" />
              </th>
              <th>
                <p-datePicker
                  [ngModel]="filtroFecha()"
                  (ngModelChange)="onFiltroFechaChange($event)"
                  selectionMode="range"
                  dateFormat="dd/mm/yy"
                  placeholder="Rango de fechas"
                  [showIcon]="true"
                  [showButtonBar]="true"
                  appendTo="body"
                  [style]="{ width: '100%' }" />
              </th>
              <th>
                <p-multiSelect
                  [options]="estadoOptions"
                  [ngModel]="filtroEstadoHallazgo()"
                  (ngModelChange)="onFiltroEstadoChange($event)"
                  optionLabel="label"
                  optionValue="value"
                  placeholder="Todos"
                  appendTo="body"
                  [showHeader]="false"
                  [style]="{ width: '100%' }">
                  <ng-template let-option pTemplate="item">
                    <p-tag [value]="option.label" [severity]="option.severity" />
                  </ng-template>
                </p-multiSelect>
              </th>
              <th>
                @if (hayFiltrosActivos()) {
                  <p-button
                    icon="pi pi-filter-slash"
                    [rounded]="true"
                    [text]="true"
                    severity="secondary"
                    (onClick)="limpiarFiltrosHallazgos()"
                    pTooltip="Limpiar filtros" />
                }
              </th>
            </tr>
          </ng-template>

          <ng-template pTemplate="body" let-hallazgo>
            <tr class="row-clickable" (click)="verDetalleHallazgo(hallazgo)">
              <td (click)="$event.stopPropagation()">
                <p-tableCheckbox [value]="hallazgo" />
              </td>
              <td>
                <p-tag
                  [value]="getTipoHallazgoLabel(hallazgo.tipoHallazgo)"
                  [icon]="getTipoHallazgoIcon(hallazgo.tipoHallazgo)"
                  [severity]="getTipoHallazgoSeverity(hallazgo.tipoHallazgo)" />
              </td>
              <td>
                <div class="hallazgo-titulo">
                  <span class="font-medium">{{ hallazgo.titulo }}</span>
                  <div class="fuentes-badges">
                    @for (fuente of hallazgo.fuentesDatos.slice(0, 2); track fuente) {
                      <p-chip [label]="fuente" styleClass="chip-small" />
                    }
                    @if (hallazgo.fuentesDatos.length > 2) {
                      <span class="text-secondary text-xs">+{{ hallazgo.fuentesDatos.length - 2 }}</span>
                    }
                  </div>
                </div>
              </td>
              <td>
                <div class="flex align-items-center gap-2">
                  <div class="w-6rem bg-gray-200 border-round" style="height: 8px;">
                    <div class="border-round"
                         [class]="hallazgo.confianza >= 80 ? 'bg-green-500' : hallazgo.confianza >= 50 ? 'bg-yellow-500' : 'bg-red-500'"
                         [style.width.%]="hallazgo.confianza"
                         style="height: 100%;"></div>
                  </div>
                  <span class="font-bold">{{ hallazgo.confianza }}%</span>
                </div>
              </td>
              <td>{{ formatearFecha(hallazgo.fechaDeteccion) }}</td>
              <td>
                <p-tag
                  [value]="formatearEstado(hallazgo.estado)"
                  [severity]="getEstadoTag(hallazgo.estado)" />
              </td>
              <td class="actions-cell" (click)="$event.stopPropagation()">
                <div class="flex gap-1">
                  @if (hallazgo.estado === 'pendiente') {
                    <p-button
                      icon="pi pi-check"
                      severity="success"
                      [rounded]="true"
                      [text]="true"
                      size="small"
                      pTooltip="Aprobar"
                      tooltipPosition="top"
                      (onClick)="abrirAprobarDialog(hallazgo)" />
                    <p-button
                      icon="pi pi-times"
                      severity="secondary"
                      [rounded]="true"
                      [text]="true"
                      size="small"
                      pTooltip="Descartar"
                      tooltipPosition="top"
                      (onClick)="abrirDescartarDialog(hallazgo)" />
                  } @else {
                    <p-button
                      icon="pi pi-eye"
                      [rounded]="true"
                      [text]="true"
                      size="small"
                      pTooltip="Ver detalle"
                      tooltipPosition="top"
                      (onClick)="verDetalleHallazgo(hallazgo)" />
                  }
                  <p-button
                    icon="pi pi-comment"
                    severity="info"
                    [rounded]="true"
                    [text]="true"
                    size="small"
                    pTooltip="Agregar contexto"
                    tooltipPosition="top"
                    (onClick)="abrirContextoParaHallazgo(hallazgo)" />
                </div>
              </td>
            </tr>
          </ng-template>

          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="7" class="text-center py-6">
                <div class="empty-state">
                  <i class="pi pi-inbox text-4xl text-secondary mb-3"></i>
                  <p class="text-secondary">No hay hallazgos registrados</p>
                </div>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </p-card>
    }
  }
</div>

<!-- Drawer: Detalle del Hallazgo -->
<p-drawer
  [(visible)]="showDetalleDrawer"
  position="right"
  [style]="{ width: '550px' }"
  header="Detalle del Hallazgo">
  @if (hallazgoSeleccionado(); as hallazgo) {
    <div class="detalle-hallazgo">
      <!-- Header -->
      <div class="detalle-header mb-4">
        <div class="flex align-items-center gap-2 mb-2">
          <p-tag
            [value]="formatearEstado(hallazgo.estado)"
            [severity]="getEstadoTag(hallazgo.estado)" />
          <span class="text-secondary text-sm">{{ hallazgo.id }}</span>
        </div>
        <h2 class="m-0">{{ hallazgo.titulo }}</h2>
      </div>

      <p-divider />

      <!-- Métricas -->
      <div class="metricas-grid mb-4">
        <div class="metrica-item">
          <span class="metrica-label">Confianza</span>
          <div class="flex align-items-center gap-2">
            <div class="flex-1 bg-gray-200 border-round" style="height: 8px;">
              <div class="border-round"
                   [class]="hallazgo.confianza >= 80 ? 'bg-green-500' : hallazgo.confianza >= 50 ? 'bg-yellow-500' : 'bg-red-500'"
                   [style.width.%]="hallazgo.confianza"
                   style="height: 100%;"></div>
            </div>
            <span class="font-bold">{{ hallazgo.confianza }}%</span>
          </div>
        </div>
        <div class="metrica-item">
          <span class="metrica-label">Fecha de detección</span>
          <span class="metrica-value">{{ formatearFechaHora(hallazgo.fechaDeteccion) }}</span>
        </div>
      </div>

      <p-divider />

      <!-- Descripción -->
      <div class="seccion mb-4">
        <h4><i class="pi pi-align-left mr-2"></i>Descripción</h4>
        <p class="text-secondary">{{ hallazgo.descripcion }}</p>
      </div>

      <!-- Fuentes de datos -->
      <div class="seccion mb-4">
        <h4><i class="pi pi-database mr-2"></i>Fuentes de Datos</h4>
        <div class="flex flex-wrap gap-2">
          @for (fuente of hallazgo.fuentesDatos; track fuente) {
            <p-chip [label]="fuente" />
          }
        </div>
      </div>

      <!-- Contenido específico por tipo -->
      @if (hallazgo.tipoHallazgo === 'tendencia') {
        @let tendencia = asTendencia(hallazgo);
        @if (tendencia.metricasEstadisticas && tendencia.metricasEstadisticas.length > 0) {
          <div class="seccion mb-4">
            <h4><i class="pi pi-chart-bar mr-2"></i>Métricas Estadísticas</h4>
            <div class="metricas-estadisticas">
              @for (metrica of tendencia.metricasEstadisticas; track metrica.nombre) {
                <div class="metrica-stat">
                  <span class="stat-label">{{ metrica.nombre }}</span>
                  <span class="stat-value">{{ metrica.valor }}</span>
                </div>
              }
            </div>
          </div>
        }
        @if (tendencia.impactoEstimado) {
          <div class="seccion mb-4">
            <h4><i class="pi pi-exclamation-circle mr-2"></i>Impacto Estimado</h4>
            <p class="text-secondary">{{ tendencia.impactoEstimado }}</p>
          </div>
        }
      }

      @if (hallazgo.tipoHallazgo === 'mitigacion') {
        @let mitigacion = asMitigacion(hallazgo);
        <div class="seccion mb-4">
          <h4><i class="pi pi-shield mr-2"></i>Riesgo Asociado</h4>
          <p class="text-secondary">{{ mitigacion.riesgoAsociado }}</p>
        </div>
        @if (mitigacion.beneficioEsperado) {
          <div class="seccion mb-4">
            <h4><i class="pi pi-star mr-2"></i>Beneficio Esperado</h4>
            <p class="text-secondary">{{ mitigacion.beneficioEsperado }}</p>
          </div>
        }
        @if (mitigacion.justificacionModelo) {
          <div class="seccion mb-4">
            <h4><i class="pi pi-info-circle mr-2"></i>Justificación del Modelo</h4>
            <p class="text-secondary">{{ mitigacion.justificacionModelo }}</p>
          </div>
        }
      }

      @if (hallazgo.tipoHallazgo === 'oportunidad') {
        @let oportunidad = asOportunidad(hallazgo);
        @if (oportunidad.beneficioCuantificado) {
          <div class="seccion mb-4">
            <h4><i class="pi pi-dollar mr-2"></i>Beneficio Cuantificado</h4>
            <p class="text-secondary">{{ oportunidad.beneficioCuantificado }}</p>
          </div>
        }
        @if (oportunidad.riesgosImplementacion) {
          <div class="seccion mb-4">
            <h4><i class="pi pi-exclamation-triangle mr-2"></i>Riesgos de Implementación</h4>
            <p class="text-secondary">{{ oportunidad.riesgosImplementacion }}</p>
          </div>
        }
      }

      @if (hallazgo.tipoHallazgo === 'riesgo') {
        @let riesgo = asRiesgo(hallazgo);
        <div class="seccion mb-4">
          <h4><i class="pi pi-chart-bar mr-2"></i>Evaluación del Riesgo</h4>
          <div class="metricas-estadisticas">
            <div class="metrica-stat">
              <span class="stat-label">Probabilidad</span>
              <span class="stat-value">{{ riesgo.probabilidad }}/5</span>
            </div>
            <div class="metrica-stat">
              <span class="stat-label">Impacto</span>
              <span class="stat-value">{{ riesgo.impacto }}/5</span>
            </div>
          </div>
        </div>
        @if (riesgo.factoresRiesgo && riesgo.factoresRiesgo.length > 0) {
          <div class="seccion mb-4">
            <h4><i class="pi pi-list mr-2"></i>Factores de Riesgo</h4>
            <ul class="pl-4">
              @for (factor of riesgo.factoresRiesgo; track factor) {
                <li class="text-secondary mb-1">{{ factor }}</li>
              }
            </ul>
          </div>
        }
        @if (riesgo.controlSugerido) {
          <div class="seccion mb-4">
            <h4><i class="pi pi-shield mr-2"></i>Control Sugerido</h4>
            <p class="text-secondary">{{ riesgo.controlSugerido }}</p>
          </div>
        }
      }
    </div>

    <ng-template pTemplate="footer">
      @if (hallazgo.estado === 'pendiente') {
        <div class="flex gap-2 w-full">
          <p-button
            label="Descartar"
            icon="pi pi-times"
            severity="secondary"
            [outlined]="true"
            (onClick)="abrirDescartarDialog(hallazgo)"
            class="flex-1" />
          <p-button
            label="Aprobar"
            icon="pi pi-check"
            severity="success"
            (onClick)="abrirAprobarDialog(hallazgo)"
            class="flex-1" />
        </div>
      } @else {
        <p-button
          label="Cerrar"
          (onClick)="showDetalleDrawer.set(false)"
          class="w-full" />
      }
    </ng-template>
  }
</p-drawer>

<!-- Dialog: Aprobar Hallazgo -->
<p-dialog
  header="Aprobar Hallazgo"
  [(visible)]="showAprobarDialog"
  [modal]="true"
  [style]="{ width: '450px' }"
  [draggable]="false">
  @if (hallazgoSeleccionado(); as hallazgo) {
    <div class="aprobar-form">
      <div class="resumen-hallazgo mb-4 p-3 surface-100 border-round">
        <span class="font-medium">{{ hallazgo.titulo }}</span>
      </div>

      <div class="field mb-3">
        <div class="flex align-items-center gap-2">
          <p-checkbox
            [ngModel]="aprobacionForm().crearRiesgo"
            (ngModelChange)="updateAprobacionCrearRiesgo($event)"
            [binary]="true"
            inputId="crearRiesgo" />
          <label for="crearRiesgo" class="cursor-pointer">Crear riesgo en módulo de Riesgos</label>
        </div>
        @if (aprobacionForm().crearRiesgo && estado().entidadSeleccionada?.tipo === 'activo') {
          <small class="text-green-600 mt-1 block ml-4">
            <i class="pi pi-check-circle mr-1"></i>
            Se creará un nuevo riesgo asociado al activo "{{ estado().entidadSeleccionada?.nombre }}"
          </small>
        }
      </div>

      <div class="field mb-3">
        <div class="flex align-items-center gap-2">
          <p-checkbox
            [ngModel]="aprobacionForm().crearTarea"
            (ngModelChange)="updateAprobacionCrearTarea($event)"
            [binary]="true"
            inputId="crearTarea" />
          <label for="crearTarea" class="cursor-pointer">Crear tarea de seguimiento</label>
        </div>
        @if (aprobacionForm().crearTarea) {
          <small class="text-secondary mt-1 block ml-4">
            <i class="pi pi-info-circle mr-1"></i>
            Funcionalidad pendiente de implementación
          </small>
        }
      </div>

      <div class="field">
        <label for="comentarios" class="block mb-2 font-medium">Comentarios (opcional)</label>
        <textarea
          pTextarea
          id="comentarios"
          [ngModel]="aprobacionForm().comentarios"
          (ngModelChange)="updateAprobacionComentarios($event)"
          [rows]="3"
          placeholder="Notas adicionales..."
          class="w-full"></textarea>
      </div>

      <p class="text-secondary text-sm mt-3">
        <i class="pi pi-info-circle mr-1"></i>
        Esta acción registrará feedback positivo para mejorar el modelo.
      </p>
    </div>
  }
  <ng-template pTemplate="footer">
    <p-button
      label="Cancelar"
      [text]="true"
      severity="secondary"
      (onClick)="showAprobarDialog.set(false)" />
    <p-button
      label="Confirmar Aprobación"
      icon="pi pi-check"
      severity="success"
      (onClick)="confirmarAprobacion()" />
  </ng-template>
</p-dialog>

<!-- Dialog: Descartar Hallazgo -->
<p-dialog
  header="Descartar Hallazgo"
  [(visible)]="showDescartarDialog"
  [modal]="true"
  [style]="{ width: '450px' }"
  [draggable]="false">
  @if (hallazgoSeleccionado(); as hallazgo) {
    <div class="descartar-form">
      <div class="resumen-hallazgo mb-4 p-3 surface-100 border-round">
        <span class="font-medium">{{ hallazgo.titulo }}</span>
      </div>

      <div class="field mb-3">
        <label for="motivo" class="block mb-2 font-medium">Motivo del descarte *</label>
        <p-select
          id="motivo"
          [options]="motivosDescarte"
          [ngModel]="descarteForm().motivo"
          (ngModelChange)="updateDescarteMotivo($event)"
          optionLabel="label"
          optionValue="value"
          placeholder="Seleccionar motivo"
          [style]="{ width: '100%' }" />
      </div>

      <div class="field">
        <label for="justificacion" class="block mb-2 font-medium">Justificación *</label>
        <textarea
          pTextarea
          id="justificacion"
          [ngModel]="descarteForm().justificacion"
          (ngModelChange)="updateDescarteJustificacion($event)"
          [rows]="4"
          placeholder="Explica por qué se descarta este hallazgo..."
          class="w-full"></textarea>
      </div>

      <p class="text-secondary text-sm mt-3">
        <i class="pi pi-info-circle mr-1"></i>
        Tu feedback ayudará a mejorar la precisión del modelo en futuras predicciones.
      </p>
    </div>
  }
  <ng-template pTemplate="footer">
    <p-button
      label="Cancelar"
      [text]="true"
      severity="secondary"
      (onClick)="showDescartarDialog.set(false)" />
    <p-button
      label="Confirmar Descarte"
      icon="pi pi-times"
      severity="danger"
      (onClick)="confirmarDescarte()"
      [disabled]="!descarteForm().motivo || !descarteForm().justificacion" />
  </ng-template>
</p-dialog>

<!-- Drawer: Acciones Masivas -->
<p-drawer
  [(visible)]="showAccionesMasivasDrawer"
  position="right"
  [style]="{ width: '400px' }"
  header="Acciones Masivas">
  <div class="acciones-masivas-content">
    <!-- Header con contador -->
    <div class="acciones-masivas-header mb-4">
      <div class="flex align-items-center gap-2 mb-2">
        <p-tag
          [value]="hallazgosSeleccionados().length + ' seleccionados'"
          severity="success"
          icon="pi pi-check-circle" />
      </div>
      <p class="text-secondary text-sm m-0">
        Selecciona una acción para aplicar a los hallazgos seleccionados.
      </p>
    </div>

    <!-- Resumen de selección -->
    <div class="seleccion-resumen mb-4">
      <div class="resumen-item">
        <i class="pi pi-clock text-yellow-600"></i>
        <span>{{ getPendientesEnSeleccion() }} pendientes</span>
      </div>
      <div class="resumen-item">
        <i class="pi pi-check text-green-600"></i>
        <span>{{ hallazgosSeleccionados().length - getPendientesEnSeleccion() }} procesados</span>
      </div>
    </div>

    <p-divider />

    <!-- Acciones disponibles -->
    <div class="acciones-lista">
      <h4 class="text-sm font-semibold mb-3">Acciones disponibles</h4>

      <!-- Solo mostrar si hay pendientes -->
      @if (getPendientesEnSeleccion() > 0) {
        <div class="accion-item mb-3">
          <p-button
            label="Aprobar seleccionados"
            icon="pi pi-check"
            severity="success"
            [outlined]="true"
            [style]="{ width: '100%' }"
            (onClick)="aprobarSeleccionados()"
            pTooltip="Aprobar todos los hallazgos pendientes seleccionados" />
          <small class="text-secondary mt-1 block">
            Aprobará {{ getPendientesEnSeleccion() }} hallazgo(s) pendiente(s)
          </small>
        </div>

        <div class="accion-item mb-3">
          <p-button
            label="Descartar seleccionados"
            icon="pi pi-times"
            severity="secondary"
            [outlined]="true"
            [style]="{ width: '100%' }"
            (onClick)="descartarSeleccionados()"
            pTooltip="Descartar todos los hallazgos pendientes seleccionados" />
          <small class="text-secondary mt-1 block">
            Descartará {{ getPendientesEnSeleccion() }} hallazgo(s) pendiente(s)
          </small>
        </div>
      }

      <p-divider />

      <!-- Agregar contexto - siempre disponible -->
      <div class="accion-item mb-3">
        <p-button
          label="Agregar contexto"
          icon="pi pi-comment"
          severity="info"
          [outlined]="true"
          [style]="{ width: '100%' }"
          (onClick)="abrirContextoMasivo()" />
        <small class="text-secondary mt-1 block">
          Agregará contexto a {{ hallazgosSeleccionados().length }} hallazgo(s)
        </small>
      </div>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <div class="flex justify-content-between w-full">
      <p-button
        label="Limpiar selección"
        icon="pi pi-refresh"
        [text]="true"
        severity="secondary"
        (onClick)="limpiarSeleccion(); showAccionesMasivasDrawer.set(false)" />
      <p-button
        label="Cerrar"
        (onClick)="showAccionesMasivasDrawer.set(false)" />
    </div>
  </ng-template>
</p-drawer>

<!-- Dialog: Confirmar Eliminación Masiva -->
<p-dialog
  header="Confirmar Eliminación"
  [(visible)]="showConfirmDeleteDialog"
  [modal]="true"
  [style]="{ width: '450px' }"
  [draggable]="false">
  <div class="confirm-delete-content">
    <div class="flex align-items-center gap-3 mb-4">
      <i class="pi pi-exclamation-triangle text-4xl text-red-500"></i>
      <div>
        <p class="font-semibold m-0 mb-1">¿Estás seguro de eliminar estos hallazgos?</p>
        <p class="text-secondary m-0">
          Se eliminarán <strong>{{ hallazgosSeleccionados().length }}</strong> hallazgo(s) de forma permanente.
        </p>
      </div>
    </div>

    <div class="surface-100 p-3 border-round">
      <p class="text-sm text-secondary m-0">
        <i class="pi pi-info-circle mr-1"></i>
        Esta acción no se puede deshacer. Los hallazgos eliminados no podrán ser recuperados.
      </p>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <p-button
      label="Cancelar"
      [text]="true"
      severity="secondary"
      (onClick)="showConfirmDeleteDialog.set(false)" />
    <p-button
      label="Eliminar"
      icon="pi pi-trash"
      severity="danger"
      (onClick)="confirmarEliminarSeleccionados()" />
  </ng-template>
</p-dialog>

<!-- Dialog: Agregar Contexto -->
<p-dialog
  header="Agregar Contexto"
  [(visible)]="showContextoDialog"
  [modal]="true"
  [style]="{ width: '500px' }"
  [draggable]="false">
  @if (hallazgoSeleccionado(); as hallazgo) {
    <div class="contexto-form">
      <!-- Resumen del hallazgo -->
      <div class="resumen-hallazgo mb-4 p-3 surface-100 border-round">
        <div class="flex align-items-center gap-2 mb-2">
          <p-tag
            [value]="getTipoHallazgoLabel(hallazgo.tipoHallazgo)"
            [icon]="getTipoHallazgoIcon(hallazgo.tipoHallazgo)"
            [severity]="getTipoHallazgoSeverity(hallazgo.tipoHallazgo)" />
          <span class="text-secondary text-sm">{{ hallazgo.id }}</span>
        </div>
        <span class="font-medium">{{ hallazgo.titulo }}</span>
      </div>

      <!-- Tipo de contexto -->
      <div class="field mb-3">
        <label class="block mb-2 font-medium">Tipo de contexto</label>
        <div class="flex gap-2">
          @for (tipo of tiposContexto; track tipo.value) {
            <p-button
              [label]="tipo.label"
              [icon]="tipo.icon"
              [severity]="contextoForm().tipoContexto === tipo.value ? 'primary' : 'secondary'"
              [outlined]="contextoForm().tipoContexto !== tipo.value"
              size="small"
              (onClick)="updateContextoTipo(tipo.value)" />
          }
        </div>
      </div>

      <!-- Contexto -->
      <div class="field">
        <label for="contextoTexto" class="block mb-2 font-medium">Contexto *</label>
        <textarea
          pTextarea
          id="contextoTexto"
          [ngModel]="contextoForm().contexto"
          (ngModelChange)="updateContextoTexto($event)"
          [rows]="5"
          placeholder="Escribe el contexto adicional para este hallazgo..."
          class="w-full"></textarea>
      </div>

      <p class="text-secondary text-sm mt-3">
        <i class="pi pi-info-circle mr-1"></i>
        El contexto ayuda a enriquecer la información del hallazgo y mejora la precisión del modelo.
      </p>
    </div>
  }
  <ng-template pTemplate="footer">
    <p-button
      label="Cancelar"
      [text]="true"
      severity="secondary"
      (onClick)="showContextoDialog.set(false)" />
    <p-button
      label="Guardar Contexto"
      icon="pi pi-check"
      severity="primary"
      (onClick)="confirmarContexto()"
      [disabled]="!contextoForm().contexto" />
  </ng-template>
</p-dialog>

<!-- Dialog: Agregar Contexto Masivo -->
<p-dialog
  header="Agregar Contexto Masivo"
  [(visible)]="showContextoMasivoDialog"
  [modal]="true"
  [style]="{ width: '500px' }"
  [draggable]="false">
  <div class="contexto-form">
    <!-- Resumen de selección -->
    <div class="resumen-hallazgo mb-4 p-3 surface-100 border-round">
      <div class="flex align-items-center gap-2 mb-2">
        <p-tag
          [value]="hallazgosSeleccionados().length + ' hallazgos seleccionados'"
          severity="success"
          icon="pi pi-check-circle" />
      </div>
      <span class="text-secondary text-sm">Se agregará el mismo contexto a todos los hallazgos seleccionados</span>
    </div>

    <!-- Tipo de contexto -->
    <div class="field mb-3">
      <label class="block mb-2 font-medium">Tipo de contexto</label>
      <div class="flex gap-2">
        @for (tipo of tiposContexto; track tipo.value) {
          <p-button
            [label]="tipo.label"
            [icon]="tipo.icon"
            [severity]="contextoForm().tipoContexto === tipo.value ? 'primary' : 'secondary'"
            [outlined]="contextoForm().tipoContexto !== tipo.value"
            size="small"
            (onClick)="updateContextoTipo(tipo.value)" />
        }
      </div>
    </div>

    <!-- Contexto -->
    <div class="field">
      <label for="contextoMasivoTexto" class="block mb-2 font-medium">Contexto *</label>
      <textarea
        pTextarea
        id="contextoMasivoTexto"
        [ngModel]="contextoForm().contexto"
        (ngModelChange)="updateContextoTexto($event)"
        [rows]="5"
        placeholder="Escribe el contexto adicional para los hallazgos seleccionados..."
        class="w-full"></textarea>
    </div>

    <p class="text-secondary text-sm mt-3">
      <i class="pi pi-info-circle mr-1"></i>
      El contexto ayuda a enriquecer la información y mejora la precisión del modelo.
    </p>
  </div>
  <ng-template pTemplate="footer">
    <p-button
      label="Cancelar"
      [text]="true"
      severity="secondary"
      (onClick)="showContextoMasivoDialog.set(false)" />
    <p-button
      label="Guardar Contexto"
      icon="pi pi-check"
      severity="primary"
      (onClick)="confirmarContextoMasivo()"
      [disabled]="!contextoForm().contexto" />
  </ng-template>
</p-dialog>

