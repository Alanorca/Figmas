<!-- Toast para notificaciones -->
<p-toast />

<div class="tabla-unificada-container">
  <!-- Header -->
  <div class="page-header">
    <h1>Tabla Unificada</h1>
    <p class="page-subtitle">Gestión unificada de Riesgos e Incidentes</p>
  </div>

  <!-- Toolbar -->
  <p-toolbar styleClass="mb-4">
    <ng-template pTemplate="start">
      <div class="flex align-items-center gap-3">
        <!-- Botón de acciones masivas -->
        @if (registrosSeleccionados().length > 0) {
          <p-button
            label="Acciones masivas"
            icon="pi pi-check-square"
            [badge]="registrosSeleccionados().length.toString()"
            badgeSeverity="contrast"
            severity="success"
            [outlined]="true"
            styleClass="btn-acciones-masivas"
            (onClick)="abrirAccionesMasivasDrawer()"
            pTooltip="Editar registros seleccionados"
            tooltipPosition="bottom" />
        }

        <p-select
          [options]="entidadOptions"
          [ngModel]="entidadSeleccionada()"
          (ngModelChange)="onEntidadChange($event)"
          optionLabel="label"
          optionValue="value"
          placeholder="Seleccionar entidad"
          [style]="{ minWidth: '200px' }"
          appendTo="body">
          <ng-template let-item pTemplate="item">
            <div class="flex align-items-center gap-2">
              <i [class]="item.icon"></i>
              <span>{{ item.label }}</span>
            </div>
          </ng-template>
          <ng-template let-item pTemplate="selectedItem">
            <div class="flex align-items-center gap-2">
              <i [class]="item.icon"></i>
              <span>{{ item.label }}</span>
            </div>
          </ng-template>
        </p-select>
      </div>
    </ng-template>

    <ng-template pTemplate="center">
      <p-iconfield>
        <p-inputicon styleClass="pi pi-search" />
        <input
          type="text"
          pInputText
          placeholder="Buscar en todos los campos..."
          (input)="dt.filterGlobal($any($event.target).value, 'contains')"
          style="width: 280px" />
      </p-iconfield>
    </ng-template>

    <ng-template pTemplate="end">
      <div class="flex gap-2 align-items-center">
        <!-- Botón de Ver Relaciones (solo con 1 registro seleccionado) -->
        @if (registrosSeleccionados().length === 1) {
          <p-button
            icon="pi pi-sitemap"
            severity="secondary"
            [rounded]="true"
            [text]="true"
            (onClick)="verRelaciones(registrosSeleccionados()[0])"
            pTooltip="Ver relaciones"
            tooltipPosition="bottom" />
        }

        <!-- Botón de Gráficas (modal completo) -->
        <p-button
          icon="pi pi-chart-bar"
          severity="secondary"
          [rounded]="true"
          [text]="true"
          (onClick)="abrirGraficas()"
          pTooltip="Gráficas avanzadas"
          tooltipPosition="bottom"
          [disabled]="contadores().total === 0" />

        <!-- Botón de Alertas -->
        <p-button
          icon="pi pi-bell"
          severity="secondary"
          [rounded]="true"
          [text]="true"
          (onClick)="showAlertasDialog.set(true)"
          pTooltip="Configurar alertas"
          tooltipPosition="bottom"
          [badge]="getAlertasActivasCount() > 0 ? getAlertasActivasCount().toString() : undefined"
          badgeSeverity="danger" />

        <!-- Menú de Exportaciones -->
        <p-menu #exportMenu [model]="exportMenuItems" [popup]="true" appendTo="body"></p-menu>
        <p-button
          icon="pi pi-download"
          severity="secondary"
          [rounded]="true"
          [text]="true"
          (onClick)="exportMenu.toggle($event)"
          pTooltip="Exportar datos"
          tooltipPosition="bottom" />

        <!-- Botón de Vistas Guardadas -->
        <span class="toolbar-btn-badge">
          <p-button
            icon="pi pi-bookmark"
            severity="secondary"
            [rounded]="true"
            [text]="true"
            (onClick)="showVistasDialog.set(true)"
            pTooltip="Vistas guardadas"
            tooltipPosition="bottom" />
          @if (vistasCompartidas().length > 0) {
            <span class="btn-icon-badge success">{{ vistasCompartidas().length }}</span>
          }
        </span>
      </div>
    </ng-template>
  </p-toolbar>

  <!-- Tabla Principal -->
  <p-card styleClass="table-card">
    <p-table
      #dt
      [value]="datosFiltrados()"
      [columns]="columnasVisibles()"
      [paginator]="true"
      [rows]="10"
      [rowsPerPageOptions]="[10, 25, 50, 100]"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} registros"
      [globalFilterFields]="['descripcion', 'contenedorNombre', 'responsable', 'estado', 'tipoEntidad', 'severidad']"
      [filterDelay]="300"
      [rowHover]="true"
      [resizableColumns]="true"
      [reorderableColumns]="true"
      (onColReorder)="onColReorder($event)"
      columnResizeMode="expand"
      styleClass="p-datatable-sm p-datatable-reorderable"
      [tableStyle]="{ 'min-width': '60rem' }"
      [selection]="registrosSeleccionados()"
      (selectionChange)="onSelectionChange($event)"
      dataKey="id">

      <!-- Headers con filtros -->
      <ng-template pTemplate="header" let-columns>
        <!-- Fila de títulos -->
        <tr>
          <th style="width: 50px">
            <p-tableHeaderCheckbox />
          </th>
          @for (col of columns; track col.field) {
            <th
              [pSortableColumn]="col.sortable ? col.field : undefined"
              [style.width]="col.width"
              pResizableColumn
              pReorderableColumn>
              <div class="column-header">
                <span class="drag-handle-grip" pTooltip="Arrastra para reordenar"></span>
                <span>{{ col.header }}</span>
                @if (col.sortable) {
                  <p-sortIcon [field]="col.field" />
                }
              </div>
            </th>
          }
          <th style="width: 80px">
            <div class="flex align-items-center justify-content-between">
              <span>Acciones</span>
              <p-button
                icon="pi pi-ellipsis-v"
                [rounded]="true"
                [text]="true"
                severity="secondary"
                size="small"
                (onClick)="showColumnasDialog.set(true)"
                pTooltip="Columnas"
                tooltipPosition="left" />
            </div>
          </th>
        </tr>
        <!-- Fila de filtros -->
        <tr>
          <th></th>
          @for (col of columns; track col.field) {
            <th>
              @switch (col.field) {
                @case ('tipoEntidad') {
                  <p-columnFilter field="tipoEntidad" matchMode="in" [showMenu]="false">
                    <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                      <p-multiSelect
                        [ngModel]="value"
                        (ngModelChange)="filter($event)"
                        [options]="tipoEntidadOptions"
                        placeholder="Todos"
                        appendTo="body"
                        [showHeader]="false">
                        <ng-template let-option pTemplate="item">
                          <div class="flex align-items-center gap-2">
                            <i [class]="option.icon"></i>
                            <span>{{ option.label }}</span>
                          </div>
                        </ng-template>
                      </p-multiSelect>
                    </ng-template>
                  </p-columnFilter>
                }
                @case ('estado') {
                  <p-columnFilter field="estado" matchMode="in" [showMenu]="false">
                    <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                      <p-multiSelect
                        [ngModel]="value"
                        (ngModelChange)="filter($event)"
                        [options]="estadoOptions"
                        placeholder="Todos"
                        appendTo="body"
                        [showHeader]="false">
                        <ng-template let-option pTemplate="item">
                          <p-tag [value]="option.label" [severity]="getEstadoTag(option.value)" />
                        </ng-template>
                      </p-multiSelect>
                    </ng-template>
                  </p-columnFilter>
                }
                @case ('severidad') {
                  <p-columnFilter field="severidad" matchMode="in" [showMenu]="false">
                    <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                      <p-multiSelect
                        [ngModel]="value"
                        (ngModelChange)="filter($event)"
                        [options]="severidadOptions"
                        placeholder="Todas"
                        appendTo="body"
                        [showHeader]="false">
                        <ng-template let-option pTemplate="item">
                          <p-tag [value]="option.label" [severity]="getSeveridadTag(option.value)" />
                        </ng-template>
                      </p-multiSelect>
                    </ng-template>
                  </p-columnFilter>
                }
                @case ('nivelRiesgo') {
                  <p-columnFilter field="nivelRiesgo" matchMode="in" display="menu" [showMenu]="true">
                    <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                      <div class="flex flex-column gap-3" style="min-width: 220px">
                        <div class="flex align-items-center gap-2">
                          <p-inputNumber
                            [ngModel]="filtroNivelRiesgoRango()[0]"
                            (ngModelChange)="onNivelRiesgoRangoChange(0, $event, filter)"
                            [min]="1"
                            [max]="25"
                            [showButtons]="true"
                            buttonLayout="horizontal"
                            spinnerMode="horizontal"
                            inputStyleClass="w-3rem text-center"
                            decrementButtonClass="p-button-secondary p-button-text"
                            incrementButtonClass="p-button-secondary p-button-text"
                            incrementButtonIcon="pi pi-plus"
                            decrementButtonIcon="pi pi-minus" />
                          <span class="text-secondary">a</span>
                          <p-inputNumber
                            [ngModel]="filtroNivelRiesgoRango()[1]"
                            (ngModelChange)="onNivelRiesgoRangoChange(1, $event, filter)"
                            [min]="1"
                            [max]="25"
                            [showButtons]="true"
                            buttonLayout="horizontal"
                            spinnerMode="horizontal"
                            inputStyleClass="w-3rem text-center"
                            decrementButtonClass="p-button-secondary p-button-text"
                            incrementButtonClass="p-button-secondary p-button-text"
                            incrementButtonIcon="pi pi-plus"
                            decrementButtonIcon="pi pi-minus" />
                        </div>
                        <p-slider
                          [ngModel]="filtroNivelRiesgoRango()"
                          (ngModelChange)="onNivelRiesgoSliderChange($event, filter)"
                          [range]="true"
                          [min]="1"
                          [max]="25"
                          [step]="1"
                          styleClass="w-full" />
                        <div class="flex justify-content-between text-xs text-secondary">
                          <span>Bajo (1-4)</span>
                          <span>Medio (5-9)</span>
                          <span>Alto (10-14)</span>
                          <span>Critico (15+)</span>
                        </div>
                        <small class="text-secondary text-center">Nivel de Riesgo: {{ filtroNivelRiesgoRango()[0] }} - {{ filtroNivelRiesgoRango()[1] }}</small>
                      </div>
                    </ng-template>
                  </p-columnFilter>
                }
                @case ('fecha') {
                  <p-columnFilter type="date" field="fecha" display="menu" [showMenu]="true">
                    <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                      <p-datePicker
                        [ngModel]="value"
                        (ngModelChange)="filter($event)"
                        dateFormat="dd/mm/yy"
                        placeholder="Filtrar fecha"
                        [showIcon]="true" />
                    </ng-template>
                  </p-columnFilter>
                }
                @case ('probabilidad') {
                  <p-columnFilter type="numeric" field="probabilidad" display="menu" [showMenu]="true">
                    <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                      <div class="flex flex-column gap-2" style="min-width: 180px">
                        <div class="flex align-items-center gap-2">
                          <p-inputNumber
                            [ngModel]="filtroProbabilidadRango()[0]"
                            (ngModelChange)="onProbabilidadRangoChange(0, $event, filter)"
                            [min]="1"
                            [max]="5"
                            [showButtons]="true"
                            buttonLayout="horizontal"
                            spinnerMode="horizontal"
                            inputStyleClass="w-3rem text-center"
                            decrementButtonClass="p-button-secondary p-button-text"
                            incrementButtonClass="p-button-secondary p-button-text"
                            incrementButtonIcon="pi pi-plus"
                            decrementButtonIcon="pi pi-minus" />
                          <span class="text-secondary">a</span>
                          <p-inputNumber
                            [ngModel]="filtroProbabilidadRango()[1]"
                            (ngModelChange)="onProbabilidadRangoChange(1, $event, filter)"
                            [min]="1"
                            [max]="5"
                            [showButtons]="true"
                            buttonLayout="horizontal"
                            spinnerMode="horizontal"
                            inputStyleClass="w-3rem text-center"
                            decrementButtonClass="p-button-secondary p-button-text"
                            incrementButtonClass="p-button-secondary p-button-text"
                            incrementButtonIcon="pi pi-plus"
                            decrementButtonIcon="pi pi-minus" />
                        </div>
                        <p-slider
                          [ngModel]="filtroProbabilidadRango()"
                          (ngModelChange)="onProbabilidadSliderChange($event, filter)"
                          [range]="true"
                          [min]="1"
                          [max]="5"
                          [step]="1"
                          styleClass="w-full" />
                        <small class="text-secondary text-center">Probabilidad: {{ filtroProbabilidadRango()[0] }} - {{ filtroProbabilidadRango()[1] }}</small>
                      </div>
                    </ng-template>
                  </p-columnFilter>
                }
                @case ('impacto') {
                  <p-columnFilter type="numeric" field="impacto" display="menu" [showMenu]="true">
                    <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                      <div class="flex flex-column gap-2" style="min-width: 180px">
                        <div class="flex align-items-center gap-2">
                          <p-inputNumber
                            [ngModel]="filtroImpactoRango()[0]"
                            (ngModelChange)="onImpactoRangoChange(0, $event, filter)"
                            [min]="1"
                            [max]="5"
                            [showButtons]="true"
                            buttonLayout="horizontal"
                            spinnerMode="horizontal"
                            inputStyleClass="w-3rem text-center"
                            decrementButtonClass="p-button-secondary p-button-text"
                            incrementButtonClass="p-button-secondary p-button-text"
                            incrementButtonIcon="pi pi-plus"
                            decrementButtonIcon="pi pi-minus" />
                          <span class="text-secondary">a</span>
                          <p-inputNumber
                            [ngModel]="filtroImpactoRango()[1]"
                            (ngModelChange)="onImpactoRangoChange(1, $event, filter)"
                            [min]="1"
                            [max]="5"
                            [showButtons]="true"
                            buttonLayout="horizontal"
                            spinnerMode="horizontal"
                            inputStyleClass="w-3rem text-center"
                            decrementButtonClass="p-button-secondary p-button-text"
                            incrementButtonClass="p-button-secondary p-button-text"
                            incrementButtonIcon="pi pi-plus"
                            decrementButtonIcon="pi pi-minus" />
                        </div>
                        <p-slider
                          [ngModel]="filtroImpactoRango()"
                          (ngModelChange)="onImpactoSliderChange($event, filter)"
                          [range]="true"
                          [min]="1"
                          [max]="5"
                          [step]="1"
                          styleClass="w-full" />
                        <small class="text-secondary text-center">Impacto: {{ filtroImpactoRango()[0] }} - {{ filtroImpactoRango()[1] }}</small>
                      </div>
                    </ng-template>
                  </p-columnFilter>
                }
                @case ('descripcion') {
                  <p-columnFilter type="text" field="descripcion" [showMenu]="false">
                    <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                      <input
                        pInputText
                        type="text"
                        [ngModel]="value"
                        (ngModelChange)="filter($event)"
                        placeholder="Buscar..."
                        class="p-column-filter" />
                    </ng-template>
                  </p-columnFilter>
                }
                @case ('contenedorNombre') {
                  <p-columnFilter type="text" field="contenedorNombre" [showMenu]="false">
                    <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                      <input
                        pInputText
                        type="text"
                        [ngModel]="value"
                        (ngModelChange)="filter($event)"
                        placeholder="Buscar..."
                        class="p-column-filter" />
                    </ng-template>
                  </p-columnFilter>
                }
                @case ('responsable') {
                  <p-columnFilter type="text" field="responsable" [showMenu]="false">
                    <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                      <input
                        pInputText
                        type="text"
                        [ngModel]="value"
                        (ngModelChange)="filter($event)"
                        placeholder="Buscar..."
                        class="p-column-filter" />
                    </ng-template>
                  </p-columnFilter>
                }
                @default {
                  <p-columnFilter type="text" [field]="col.field" [showMenu]="false">
                    <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                      <input
                        pInputText
                        type="text"
                        [ngModel]="value"
                        (ngModelChange)="filter($event)"
                        placeholder="Buscar..."
                        class="p-column-filter" />
                    </ng-template>
                  </p-columnFilter>
                }
              }
            </th>
          }
          <th>
            <p-button
              icon="pi pi-filter-slash"
              [rounded]="true"
              [text]="true"
              severity="secondary"
              (onClick)="dt.clear()"
              pTooltip="Limpiar filtros" />
          </th>
        </tr>
      </ng-template>

      <!-- Body -->
      <ng-template pTemplate="body" let-registro let-columns="columns">
        <tr
          (click)="!estaEditando(registro.id) && verDetalle(registro)"
          [class.row-clickable]="!estaEditando(registro.id)"
          [class.row-editing]="estaEditando(registro.id)">
          <td (click)="$event.stopPropagation()">
            <p-tableCheckbox [value]="registro" />
          </td>
          @for (col of columns; track col.field) {
            <td (click)="estaEditando(registro.id) && $event.stopPropagation()">
              <!-- Modo edición -->
              @if (estaEditando(registro.id)) {
                @switch (col.field) {
                  @case ('tipoEntidad') {
                    <p-tag
                      [value]="getTipoEntidadLabel(registro.tipoEntidad)"
                      [icon]="getTipoEntidadIcon(registro.tipoEntidad)"
                      [severity]="registro.tipoEntidad === 'riesgo' ? 'warn' : 'danger'" />
                  }
                  @case ('nivelRiesgo') {
                    @if (registro.nivelRiesgo) {
                      <p-tag
                        [value]="getNivelRiesgoLabel(registro.nivelRiesgo) + ' (' + registro.nivelRiesgo + ')'"
                        [severity]="getNivelRiesgoTag(registro.nivelRiesgo)" />
                    } @else {
                      <span class="text-secondary">-</span>
                    }
                  }
                  @case ('contenedorNombre') {
                    <input
                      pInputText
                      [ngModel]="getValorEdicion('contenedorNombre')"
                      (ngModelChange)="setValorEdicion('contenedorNombre', $event)"
                      class="w-full p-inputtext-sm" />
                  }
                  @case ('estado') {
                    <p-select
                      [options]="estadoOptions"
                      [ngModel]="getValorEdicion('estado')"
                      (ngModelChange)="setValorEdicion('estado', $event)"
                      optionLabel="label"
                      optionValue="value"
                      [style]="{ width: '100%' }"
                      appendTo="body" />
                  }
                  @case ('severidad') {
                    <p-select
                      [options]="severidadOptions"
                      [ngModel]="getValorEdicion('severidad')"
                      (ngModelChange)="setValorEdicion('severidad', $event)"
                      optionLabel="label"
                      optionValue="value"
                      [style]="{ width: '100%' }"
                      appendTo="body" />
                  }
                  @case ('fecha') {
                    <p-datePicker
                      [ngModel]="getValorEdicion('fecha')"
                      (ngModelChange)="setValorEdicion('fecha', $event)"
                      dateFormat="dd/mm/yy"
                      [style]="{ width: '100%' }"
                      appendTo="body" />
                  }
                  @case ('probabilidad') {
                    <p-inputNumber
                      [ngModel]="getValorEdicion('probabilidad')"
                      (ngModelChange)="setValorEdicion('probabilidad', $event)"
                      [min]="1"
                      [max]="5"
                      [showButtons]="true"
                      [style]="{ width: '80px' }" />
                  }
                  @case ('impacto') {
                    <p-inputNumber
                      [ngModel]="getValorEdicion('impacto')"
                      (ngModelChange)="setValorEdicion('impacto', $event)"
                      [min]="1"
                      [max]="5"
                      [showButtons]="true"
                      [style]="{ width: '80px' }" />
                  }
                  @case ('responsable') {
                    <input
                      pInputText
                      [ngModel]="getValorEdicion('responsable')"
                      (ngModelChange)="setValorEdicion('responsable', $event)"
                      class="w-full p-inputtext-sm" />
                  }
                  @case ('descripcion') {
                    <input
                      pInputText
                      [ngModel]="getValorEdicion('descripcion')"
                      (ngModelChange)="setValorEdicion('descripcion', $event)"
                      class="w-full p-inputtext-sm" />
                  }
                  @default {
                    <input
                      pInputText
                      [ngModel]="getValorEdicion(col.field) ?? registro[col.field]"
                      (ngModelChange)="setValorEdicion(col.field, $event)"
                      class="w-full p-inputtext-sm" />
                  }
                }
              } @else {
                <!-- Modo visualización -->
                @switch (col.field) {
                  @case ('tipoEntidad') {
                    <p-tag
                      [value]="getTipoEntidadLabel(registro.tipoEntidad)"
                      [icon]="getTipoEntidadIcon(registro.tipoEntidad)"
                      [severity]="registro.tipoEntidad === 'riesgo' ? 'warn' : 'danger'" />
                  }
                  @case ('contenedorNombre') {
                    <div class="contenedor-cell">
                      <p-tag
                        [value]="registro.tipoContenedor === 'activo' ? 'Activo' : 'Proceso'"
                        severity="info"
                        styleClass="contenedor-badge" />
                      <span class="contenedor-nombre" [innerHTML]="highlightText(registro.contenedorNombre)"></span>
                    </div>
                  }
                  @case ('estado') {
                    <p-tag
                      [value]="formatearEstado(registro.estado)"
                      [severity]="getEstadoTag(registro.estado)" />
                  }
                  @case ('fecha') {
                    {{ formatearFecha(registro.fecha) }}
                  }
                  @case ('nivelRiesgo') {
                    @if (registro.nivelRiesgo) {
                      <p-tag
                        [value]="getNivelRiesgoLabel(registro.nivelRiesgo) + ' (' + registro.nivelRiesgo + ')'"
                        [severity]="getNivelRiesgoTag(registro.nivelRiesgo)" />
                    } @else {
                      <span class="text-secondary">-</span>
                    }
                  }
                  @case ('severidad') {
                    @if (registro.severidad) {
                      <p-tag
                        [value]="formatearEstado(registro.severidad)"
                        [severity]="getSeveridadTag(registro.severidad)" />
                    } @else {
                      <span class="text-secondary">-</span>
                    }
                  }
                  @case ('probabilidad') {
                    @if (registro.probabilidad) {
                      <span class="nivel-badge">{{ registro.probabilidad }}/5</span>
                    } @else {
                      <span class="text-secondary">-</span>
                    }
                  }
                  @case ('impacto') {
                    @if (registro.impacto) {
                      <span class="nivel-badge">{{ registro.impacto }}/5</span>
                    } @else {
                      <span class="text-secondary">-</span>
                    }
                  }
                  @case ('responsable') {
                    @if (registro.responsable) {
                      <span [innerHTML]="highlightText(registro.responsable)"></span>
                    } @else {
                      <span class="text-secondary">-</span>
                    }
                  }
                  @case ('descripcion') {
                    @if (registro.descripcion) {
                      <span class="descripcion-text" [innerHTML]="highlightText(registro.descripcion)"></span>
                    } @else {
                      <span class="text-secondary">-</span>
                    }
                  }
                  @default {
                    <span [innerHTML]="highlightText(registro[col.field]?.toString()) || '-'"></span>
                  }
                }
              }
            </td>
          }
          <td class="text-center actions-cell">
            @if (estaEditando(registro.id)) {
              <!-- Botones de edición -->
              <div class="flex gap-1 justify-content-center">
                <p-button
                  icon="pi pi-check"
                  severity="success"
                  [outlined]="true"
                  size="small"
                  pTooltip="Guardar"
                  (onClick)="guardarEdicion(registro, $event)" />
                <p-button
                  icon="pi pi-times"
                  severity="secondary"
                  [outlined]="true"
                  size="small"
                  pTooltip="Cancelar"
                  (onClick)="cancelarEdicion($event)" />
              </div>
            } @else {
              <!-- Menú contextual -->
              <div class="flex justify-content-center">
                <p-menu #menuRegistro [model]="getMenuItemsRegistro(registro)" [popup]="true" appendTo="body"></p-menu>
                <p-button
                  icon="pi pi-ellipsis-v"
                  [text]="true"
                  size="small"
                  (onClick)="menuRegistro.toggle($event); $event.stopPropagation()" />
              </div>
            }
          </td>
        </tr>
      </ng-template>

      <!-- Empty -->
      <ng-template pTemplate="emptymessage" let-columns>
        <tr>
          <td [attr.colspan]="columns.length + 2" class="text-center py-6">
            <div class="empty-state">
              <i class="pi pi-inbox text-4xl text-secondary mb-3"></i>
              <p class="text-secondary">No se encontraron registros</p>
              <p-button
                label="Limpiar filtros"
                [text]="true"
                (onClick)="dt.clear()" />
            </div>
          </td>
        </tr>
      </ng-template>

      <!-- Pie de tabla con totales por columna -->
      <ng-template pTemplate="footer" let-columns>
        <tr class="font-semibold surface-100">
          <td>
            @if (registrosSeleccionados().length > 0) {
              <span class="text-primary text-sm">{{ registrosSeleccionados().length }}</span>
            }
          </td>
          <td>
            <span class="text-900">Totales</span>
          </td>
          <td>
            <div class="flex gap-2">
              <p-tag value="Riesgos" severity="warn" styleClass="text-xs" />
              <span>{{ contadores().riesgos }}</span>
              <p-tag value="Incidentes" severity="danger" styleClass="text-xs" />
              <span>{{ contadores().incidentes }}</span>
            </div>
          </td>
          <td>
            <span class="text-600">{{ contadores().total }} registros</span>
          </td>
          <td>
            <div class="flex gap-1">
              <p-tag [value]="contadores().criticos.toString()" severity="danger" styleClass="text-xs" pTooltip="Críticos" />
              <p-tag [value]="contadores().controlados.toString()" severity="success" styleClass="text-xs" pTooltip="Controlados" />
            </div>
          </td>
          @for (col of columns.slice(4); track col.field) {
            <td></td>
          }
          <td></td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>
</div>

<!-- Drawer: Configuración de Columnas -->
<p-drawer
  [(visible)]="showColumnasDialog"
  position="right"
  [style]="{ width: '380px' }"
  header="Configurar Columnas">
  <div class="columnas-drawer-content">
    <!-- Buscador -->
    <div class="columnas-search mb-3">
      <p-iconfield>
        <p-inputicon styleClass="pi pi-search" />
        <input
          type="text"
          pInputText
          placeholder="Buscar columna..."
          [ngModel]="busquedaColumna()"
          (ngModelChange)="busquedaColumna.set($event)"
          class="w-full" />
      </p-iconfield>
    </div>

    <p class="text-secondary text-sm mb-3">
      <i class="pi pi-info-circle mr-1"></i>
      Arrastra las columnas para cambiar su orden. El orden se sincroniza con la tabla.
    </p>

    <!-- Lista de columnas con drag and drop -->
    <div class="columnas-list">
      @for (col of columnasFiltradas(); track col.field; let i = $index) {
        <div
          class="columna-item"
          [class.dragging]="draggedColumna?.field === col.field"
          [class.drop-target]="draggedColumna && draggedColumna.field !== col.field"
          [attr.data-field]="col.field"
          pDraggable="columnas"
          pDroppable="columnas"
          [dragHandle]="'.drag-handle-config'"
          (onDragStart)="onDragStartEvent($event, col)"
          (onDragEnd)="onDragEnd()"
          (onDrop)="onDropColumnaEvent($event, col)">
          <div class="columna-item-content">
            <i class="pi pi-bars drag-handle-config" pTooltip="Arrastra para reordenar"></i>
            <span class="columna-orden-badge">{{ i + 1 }}</span>
            <p-checkbox
              [ngModel]="col.visible"
              (ngModelChange)="toggleColumnaVisibilidad(col.field)"
              [binary]="true"
              [inputId]="col.field" />
            <label [for]="col.field" class="ml-2 flex-1">
              <span>{{ col.header }}</span>
              <span class="text-secondary text-xs ml-1">({{ col.tipo }})</span>
            </label>
            @if (col.visible) {
              <i class="pi pi-eye text-primary" pTooltip="Visible en tabla"></i>
            } @else {
              <i class="pi pi-eye-slash text-secondary" pTooltip="Oculta"></i>
            }
          </div>
        </div>
      }
      @if (columnasFiltradas().length === 0) {
        <div class="text-center text-secondary py-4">
          <i class="pi pi-search text-2xl mb-2"></i>
          <p class="m-0">No se encontraron columnas</p>
        </div>
      }
    </div>
  </div>

  <ng-template pTemplate="footer">
    <div class="flex justify-content-between w-full">
      <p-button
        label="Restaurar"
        icon="pi pi-refresh"
        [text]="true"
        severity="secondary"
        (onClick)="restaurarColumnas()"
        pTooltip="Restaurar orden y visibilidad por defecto" />
      <p-button
        label="Cerrar"
        icon="pi pi-check"
        (onClick)="showColumnasDialog.set(false)" />
    </div>
  </ng-template>
</p-drawer>

<!-- Dialog: Filtro de Columna -->
<p-dialog
  [header]="'Filtrar por ' + columnaFiltroActual()?.header"
  [(visible)]="showFiltroPopover"
  [modal]="true"
  [style]="{ width: '400px' }"
  [draggable]="false"
  [resizable]="false">
  @if (columnaFiltroActual(); as col) {
    <div class="filtro-config">
      @switch (col.tipo) {
        @case ('texto') {
          <div class="field">
            <label>Operador</label>
            <p-select
              [options]="operadoresTexto"
              [(ngModel)]="filtroTemp().operador"
              optionLabel="label"
              optionValue="value"
              [style]="{ width: '100%' }" />
          </div>
          <div class="field">
            <label>Valor</label>
            <input
              type="text"
              pInputText
              [(ngModel)]="filtroTemp().valor"
              placeholder="Escribe para buscar..."
              class="w-full" />
          </div>
        }

        @case ('numero') {
          <div class="field">
            <label>Operador</label>
            <p-select
              [options]="operadoresNumero"
              [(ngModel)]="filtroTemp().operador"
              optionLabel="label"
              optionValue="value"
              [style]="{ width: '100%' }" />
          </div>

          <!-- Slider de rango doble para operador "entre" -->
          @if (filtroTemp().operador === 'entre') {
            <div class="field slider-rango-container">
              <label>Seleccionar rango</label>
              <div class="slider-valores">
                <span class="slider-valor-min">{{ rangoSliderNumerico()[0] }}</span>
                <span class="slider-valor-max">{{ rangoSliderNumerico()[1] }}</span>
              </div>
              <p-slider
                [(ngModel)]="rangoSliderNumerico"
                [range]="true"
                [min]="rangoColumnaActual().min"
                [max]="rangoColumnaActual().max"
                [step]="rangoColumnaActual().step"
                (ngModelChange)="onSliderRangoChange($event)"
                styleClass="slider-rango-doble" />
              <div class="slider-limites">
                <span>Mín: {{ rangoColumnaActual().min }}</span>
                <span>Máx: {{ rangoColumnaActual().max }}</span>
              </div>
            </div>
            <div class="field valores-exactos">
              <div class="grid">
                <div class="col-6">
                  <label>Desde</label>
                  <p-inputNumber
                    [(ngModel)]="filtroTemp().valor"
                    [min]="rangoColumnaActual().min"
                    [max]="rangoColumnaActual().max"
                    [style]="{ width: '100%' }"
                    (ngModelChange)="rangoSliderNumerico.set([$event, rangoSliderNumerico()[1]])" />
                </div>
                <div class="col-6">
                  <label>Hasta</label>
                  <p-inputNumber
                    [(ngModel)]="filtroTemp().valorHasta"
                    [min]="rangoColumnaActual().min"
                    [max]="rangoColumnaActual().max"
                    [style]="{ width: '100%' }"
                    (ngModelChange)="rangoSliderNumerico.set([rangoSliderNumerico()[0], $event])" />
                </div>
              </div>
            </div>
          } @else {
            <div class="field">
              <label>Valor</label>
              <p-inputNumber
                [(ngModel)]="filtroTemp().valor"
                [style]="{ width: '100%' }" />
            </div>
          }
        }

        @case ('fecha') {
          <div class="field">
            <label>Presets rápidos</label>
            <div class="presets-grid">
              @for (preset of presetsFecha; track preset.value) {
                <p-button
                  [label]="preset.label"
                  [outlined]="true"
                  size="small"
                  (onClick)="aplicarPresetFecha(preset)" />
              }
            </div>
          </div>
          <p-divider />
          <div class="field">
            <label>O seleccionar rango personalizado</label>
            <p-datePicker
              [(ngModel)]="filtroTemp().valor"
              [showIcon]="true"
              [style]="{ width: '100%' }"
              dateFormat="dd/mm/yy"
              placeholder="Fecha desde" />
          </div>
          @if (filtroTemp().operador === 'entre') {
            <div class="field">
              <p-datePicker
                [(ngModel)]="filtroTemp().valorHasta"
                [showIcon]="true"
                [style]="{ width: '100%' }"
                dateFormat="dd/mm/yy"
                placeholder="Fecha hasta" />
            </div>
          }
        }

        @case ('seleccion') {
          <div class="field">
            <label>Seleccionar valores</label>
            @if (col.field === 'estado') {
              <p-multiSelect
                [options]="opcionesEstado()"
                [(ngModel)]="filtroTemp().valoresSeleccionados"
                optionLabel="label"
                optionValue="value"
                placeholder="Seleccionar estados"
                [style]="{ width: '100%' }" />
            } @else if (col.opciones) {
              <p-multiSelect
                [options]="col.opciones"
                [(ngModel)]="filtroTemp().valoresSeleccionados"
                optionLabel="label"
                optionValue="value"
                placeholder="Seleccionar valores"
                [style]="{ width: '100%' }" />
            }
          </div>
        }

        @case ('contenedor') {
          <div class="field">
            <label>Tipo de contenedor</label>
            <div class="flex gap-2 mb-3">
              <p-button
                [outlined]="filtroTipoContenedor() !== 'todos'"
                label="Todos"
                size="small"
                (onClick)="setFiltroTipoContenedor('todos')" />
              <p-button
                [outlined]="filtroTipoContenedor() !== 'activo'"
                label="Activos"
                icon="pi pi-box"
                size="small"
                (onClick)="setFiltroTipoContenedor('activo')" />
              <p-button
                [outlined]="filtroTipoContenedor() !== 'proceso'"
                label="Procesos"
                icon="pi pi-sitemap"
                size="small"
                (onClick)="setFiltroTipoContenedor('proceso')" />
            </div>
          </div>
          <div class="field">
            <label>Buscar activo o proceso</label>
            <p-autoComplete
              [(ngModel)]="filtroTemp().valor"
              [suggestions]="contenedoresFiltrados()"
              (completeMethod)="buscarContenedores($event)"
              (onSelect)="onContenedorSeleccionado($event)"
              field="nombre"
              [dropdown]="true"
              [forceSelection]="false"
              placeholder="Escriba para buscar..."
              styleClass="w-full">
              <ng-template let-item pTemplate="item">
                <div class="flex align-items-center gap-2">
                  <p-tag
                    [value]="item.tipo === 'activo' ? 'Activo' : 'Proceso'"
                    [severity]="item.tipo === 'activo' ? 'info' : 'success'"
                    styleClass="text-xs" />
                  <span>{{ item.nombre }}</span>
                </div>
              </ng-template>
            </p-autoComplete>
          </div>
        }
      }
    </div>
  }
  <ng-template pTemplate="footer">
    <p-button
      label="Cancelar"
      [text]="true"
      (onClick)="showFiltroPopover.set(false)" />
    <p-button
      label="Aplicar"
      icon="pi pi-check"
      (onClick)="aplicarFiltro()" />
  </ng-template>
</p-dialog>

<!-- Dialog: Asistente de Gráficas Interactivas -->
<p-dialog
  header="Gráficas Interactivas"
  [(visible)]="showGraficasDialog"
  [modal]="true"
  [style]="{ width: '95vw', maxWidth: '1400px' }"
  [contentStyle]="{ height: '85vh', padding: '0' }"
  [draggable]="false"
  [resizable]="false"
  styleClass="graficas-dialog">

  <!-- Componente de Gráficas Interactivas -->
  <app-graficas-interactivas
    [datos]="datosGraficaInteractiva()"
    [campoInicial]="columnaGraficaSeleccionada()"
    [titulo]="getTituloGrafica()"
    [subtitulo]="filtroGraficaActivo() ? 'Filtrado: ' + filtroGraficaActivo()!.valor + ' - ' + datosGraficaInteractiva().labels.length + ' categorías' : 'Datos de Riesgos e Incidentes - ' + contadores().total + ' registros'"
    [valoresFiltrado]="valoresFiltradoGrafica()"
    (campoSeleccionado)="onCampoGraficaChange($event)"
    (dataPointClick)="onGraficaDataPointClick($event)"
    (legendClick)="onGraficaLegendClick($event)"
    (filtroAplicado)="onFiltroGraficaAplicado($event)" />

  <ng-template pTemplate="footer">
    <div class="flex justify-content-between w-full">
      <div class="flex gap-2">
        <!-- Guardar como Widget -->
        <p-button
          label="Guardar como Widget"
          icon="pi pi-bookmark"
          severity="secondary"
          [outlined]="true"
          (onClick)="mostrarGuardarWidget()"
          pTooltip="Guardar configuración para el dashboard" />

        <!-- Exportar gráfica a Excel -->
        <p-button
          label="Exportar a Excel"
          icon="pi pi-file-excel"
          severity="success"
          [outlined]="true"
          (onClick)="exportarGraficaExcel()" />
      </div>
      <p-button
        label="Cerrar"
        icon="pi pi-times"
        (onClick)="showGraficasDialog.set(false)" />
    </div>
  </ng-template>
</p-dialog>

<!-- Drawer: Detalle del Registro -->
<p-drawer
  [(visible)]="showDetalleDrawer"
  position="right"
  [style]="{ width: '500px' }"
  header="Detalle del Registro">
  @if (registroSeleccionado(); as registro) {
    <div class="detalle-content">
      <!-- Header del detalle -->
      <div class="detalle-header">
        <p-tag
          [value]="getTipoEntidadLabel(registro.tipoEntidad)"
          [icon]="getTipoEntidadIcon(registro.tipoEntidad)"
          [severity]="registro.tipoEntidad === 'riesgo' ? 'warn' : 'danger'"
          styleClass="mb-2" />
        <h2>{{ registro.titulo || registro.descripcion }}</h2>
        <span class="text-secondary">{{ registro.id }}</span>
      </div>

      <p-divider />

      <!-- Información general -->
      <div class="detalle-section">
        <h4><i class="pi pi-info-circle mr-2"></i>Información General</h4>
        <div class="detalle-grid">
          <div class="detalle-item">
            <span class="detalle-label">Estado</span>
            <p-tag
              [value]="formatearEstado(registro.estado)"
              [severity]="getEstadoTag(registro.estado)" />
          </div>
          <div class="detalle-item">
            <span class="detalle-label">Fecha</span>
            <span>{{ formatearFecha(registro.fecha) }}</span>
          </div>
          <div class="detalle-item">
            <span class="detalle-label">Responsable</span>
            <span>{{ registro.responsable }}</span>
          </div>
        </div>
      </div>

      <p-divider />

      <!-- Activo/Proceso relacionado -->
      <div class="detalle-section">
        <h4><i class="pi pi-link mr-2"></i>Activo/Proceso Relacionado</h4>
        <div class="contenedor-info">
          <p-tag
            [value]="registro.tipoContenedor === 'activo' ? 'Activo' : 'Proceso'"
            severity="info" />
          <span class="ml-2">{{ registro.contenedorNombre }}</span>
        </div>
      </div>

      @if (registro.tipoEntidad === 'riesgo') {
        <p-divider />
        <!-- Información específica de Riesgo -->
        <div class="detalle-section">
          <h4><i class="pi pi-shield mr-2"></i>Evaluación del Riesgo</h4>
          <div class="detalle-grid">
            <div class="detalle-item">
              <span class="detalle-label">Probabilidad</span>
              <span class="nivel-badge">{{ registro.probabilidad }}/5</span>
            </div>
            <div class="detalle-item">
              <span class="detalle-label">Impacto</span>
              <span class="nivel-badge">{{ registro.impacto }}/5</span>
            </div>
            <div class="detalle-item">
              <span class="detalle-label">Nivel de Riesgo</span>
              <p-tag
                [value]="getNivelRiesgoLabel(registro.nivelRiesgo!) + ' (' + registro.nivelRiesgo + ')'"
                [severity]="getNivelRiesgoTag(registro.nivelRiesgo!)" />
            </div>
          </div>
        </div>
      }

      @if (registro.tipoEntidad === 'incidente') {
        <p-divider />
        <!-- Información específica de Incidente -->
        <div class="detalle-section">
          <h4><i class="pi pi-exclamation-triangle mr-2"></i>Detalles del Incidente</h4>
          <div class="detalle-grid">
            <div class="detalle-item">
              <span class="detalle-label">Severidad</span>
              <p-tag
                [value]="formatearEstado(registro.severidad!)"
                [severity]="getSeveridadTag(registro.severidad!)" />
            </div>
            <div class="detalle-item">
              <span class="detalle-label">Reportado por</span>
              <span>{{ registro.reportadoPor }}</span>
            </div>
          </div>
        </div>
      }

      <p-divider />

      <!-- Descripción -->
      <div class="detalle-section">
        <h4><i class="pi pi-align-left mr-2"></i>Descripción</h4>
        <p class="descripcion-texto">{{ registro.descripcion }}</p>
      </div>

      <p-divider />

      <!-- Sistema de Comentarios -->
      <div class="detalle-section comentarios-section">
        <div class="comentarios-header">
          <h4 (click)="mostrandoComentarios.set(!mostrandoComentarios())">
            <i class="pi pi-comments mr-2"></i>
            Comentarios ({{ comentariosRegistro().length }})
            <i [class]="mostrandoComentarios() ? 'pi pi-chevron-up' : 'pi pi-chevron-down'" class="toggle-icon"></i>
          </h4>
        </div>

        @if (mostrandoComentarios()) {
          <!-- Input para nuevo comentario -->
          <div class="nuevo-comentario">
            <div class="comentario-input-wrapper">
              <input
                pInputText
                [ngModel]="nuevoComentario()"
                (ngModelChange)="nuevoComentario.set($event)"
                placeholder="Escribe un comentario..."
                (keyup.enter)="agregarComentario()"
                class="w-full" />
              <p-button
                icon="pi pi-send"
                [rounded]="true"
                size="small"
                [disabled]="!nuevoComentario().trim()"
                (onClick)="agregarComentario()"
                pTooltip="Enviar comentario" />
            </div>
          </div>

          <!-- Lista de comentarios -->
          <div class="comentarios-lista">
            @if (comentariosRegistro().length === 0) {
              <div class="no-comentarios">
                <i class="pi pi-comment"></i>
                <span>No hay comentarios aún</span>
              </div>
            } @else {
              @for (comentario of comentariosRegistro(); track comentario.id) {
                <div class="comentario-item">
                  <div class="comentario-avatar">
                    <i class="pi pi-user"></i>
                  </div>
                  <div class="comentario-contenido">
                    <div class="comentario-meta">
                      <span class="comentario-autor">{{ comentario.autor }}</span>
                      <span class="comentario-fecha">{{ formatearFechaComentario(comentario.fecha) }}</span>
                      @if (comentario.editado) {
                        <span class="comentario-editado">(editado)</span>
                      }
                    </div>

                    @if (comentarioEditandoId() === comentario.id) {
                      <!-- Modo edición -->
                      <div class="comentario-edicion">
                        <input
                          pInputText
                          [ngModel]="comentarioEditandoTexto()"
                          (ngModelChange)="comentarioEditandoTexto.set($event)"
                          (keyup.enter)="guardarEdicionComentario()"
                          (keyup.escape)="cancelarEdicionComentario()"
                          class="w-full" />
                        <div class="comentario-edicion-actions">
                          <p-button
                            icon="pi pi-check"
                            size="small"
                            severity="success"
                            [text]="true"
                            (onClick)="guardarEdicionComentario()" />
                          <p-button
                            icon="pi pi-times"
                            size="small"
                            severity="secondary"
                            [text]="true"
                            (onClick)="cancelarEdicionComentario()" />
                        </div>
                      </div>
                    } @else {
                      <!-- Modo vista -->
                      <p class="comentario-texto">{{ comentario.texto }}</p>
                      <div class="comentario-acciones">
                        <button class="comentario-btn" (click)="iniciarEdicionComentario(comentario)" pTooltip="Editar">
                          <i class="pi pi-pencil"></i>
                        </button>
                        <button class="comentario-btn eliminar" (click)="eliminarComentario(comentario.id)" pTooltip="Eliminar">
                          <i class="pi pi-trash"></i>
                        </button>
                      </div>
                    }
                  </div>
                </div>
              }
            }
          </div>
        }
      </div>

      <p-divider />

      <!-- Historial de Cambios Inline -->
      <div class="detalle-section historial-section">
        <div class="historial-header">
          <h4 (click)="mostrandoHistorial.set(!mostrandoHistorial())">
            <i class="pi pi-history mr-2"></i>
            Historial de Cambios ({{ historialInline().length }})
            <i [class]="mostrandoHistorial() ? 'pi pi-chevron-up' : 'pi pi-chevron-down'" class="toggle-icon"></i>
          </h4>
        </div>

        @if (mostrandoHistorial()) {
          <div class="historial-timeline">
            @for (item of historialInline(); track $index) {
              <div class="historial-item">
                <div class="historial-icono" [style.color]="getHistorialColor(item.accion)">
                  <i [class]="getHistorialIcon(item.accion)"></i>
                </div>
                <div class="historial-contenido">
                  <div class="historial-accion-row">
                    <span class="historial-accion">{{ item.accion }}</span>
                    <span class="historial-fecha">{{ formatearFechaComentario(item.fecha) }}</span>
                  </div>
                  <div class="historial-detalles">{{ item.detalles }}</div>
                  <div class="historial-usuario">
                    <i class="pi pi-user"></i>
                    {{ item.usuario }}
                  </div>
                  @if (item.campo && item.valorAnterior !== undefined) {
                    <div class="historial-cambio">
                      <span class="cambio-campo">{{ item.campo }}:</span>
                      <span class="cambio-anterior">{{ item.valorAnterior }}</span>
                      <i class="pi pi-arrow-right"></i>
                      <span class="cambio-nuevo">{{ item.valorNuevo }}</span>
                    </div>
                  }
                </div>
              </div>
            }
          </div>
        }
      </div>
    </div>

    <!-- Acciones del drawer -->
    <ng-template pTemplate="footer">
      <div class="detalle-acciones">
        <p-button
          label="Editar"
          icon="pi pi-pencil"
          [outlined]="true"
          severity="info"
          (onClick)="editarDesdeDetalle()"
          pTooltip="Editar este registro" />
        <p-button
          label="Historial"
          icon="pi pi-history"
          [outlined]="true"
          severity="secondary"
          (onClick)="verHistorial()"
          pTooltip="Ver historial de cambios" />
        <p-button
          [label]="registroSeleccionado()?.tipoContenedor === 'activo' ? 'Ir al Activo' : 'Ir al Proceso'"
          icon="pi pi-external-link"
          [outlined]="true"
          (onClick)="navegarAlContenedor()" />
        <p-button
          label="Cerrar"
          (onClick)="showDetalleDrawer.set(false)" />
      </div>
    </ng-template>
  }
</p-drawer>

<!-- Drawer: Acciones Masivas -->
<p-drawer
  [(visible)]="showAccionesMasivasDrawer"
  position="right"
  [style]="{ width: '420px' }"
  header="Acciones Masivas">
  <div class="acciones-masivas-content">
    <!-- Header con contador -->
    <div class="acciones-masivas-header mb-4">
      <div class="flex align-items-center gap-2 mb-2">
        <p-tag
          [value]="registrosSeleccionados().length + ' seleccionados'"
          severity="success"
          icon="pi pi-check-circle" />
      </div>
      <p class="text-secondary text-sm m-0">
        Selecciona los campos que deseas modificar y establece los nuevos valores.
      </p>
    </div>

    <!-- Lista de columnas editables -->
    <div class="acciones-masivas-fields">
      @for (col of accionesMasivasColumnas(); track col.field) {
        <div class="accion-masiva-item" [class.active]="isColumnaAccionActiva(col.field)">
          <!-- Header de la columna con toggle -->
          <div
            class="accion-masiva-header"
            (click)="toggleColumnaAccionMasiva(col.field)">
            <div class="flex align-items-center gap-2">
              <p-checkbox
                [ngModel]="isColumnaAccionActiva(col.field)"
                [binary]="true"
                (click)="$event.stopPropagation()" />
              <span class="campo-nombre">{{ col.header }}</span>
              <span class="campo-tipo">{{ col.tipo }}</span>
            </div>
            <i class="pi" [class.pi-chevron-down]="isColumnaAccionActiva(col.field)" [class.pi-chevron-right]="!isColumnaAccionActiva(col.field)"></i>
          </div>

          <!-- Control del campo (se muestra solo si está activo) -->
          @if (isColumnaAccionActiva(col.field)) {
            <div class="accion-masiva-control">
              <label class="control-label">Nuevo valor para {{ col.header }}</label>
              @switch (col.field) {
                @case ('estado') {
                  <p-select
                    [options]="estadoOptions"
                    [ngModel]="getValorAccionMasiva('estado')"
                    (ngModelChange)="actualizarValorAccionMasiva('estado', $event)"
                    optionLabel="label"
                    optionValue="value"
                    placeholder="Seleccionar estado"
                    [style]="{ width: '100%' }"
                    appendTo="body">
                    <ng-template let-option pTemplate="item">
                      <p-tag [value]="option.label" [severity]="getEstadoTag(option.value)" />
                    </ng-template>
                    <ng-template let-option pTemplate="selectedItem">
                      <p-tag [value]="option.label" [severity]="getEstadoTag(option.value)" />
                    </ng-template>
                  </p-select>
                }
                @case ('severidad') {
                  <p-select
                    [options]="severidadOptions"
                    [ngModel]="getValorAccionMasiva('severidad')"
                    (ngModelChange)="actualizarValorAccionMasiva('severidad', $event)"
                    optionLabel="label"
                    optionValue="value"
                    placeholder="Seleccionar severidad"
                    [style]="{ width: '100%' }"
                    appendTo="body">
                    <ng-template let-option pTemplate="item">
                      <p-tag [value]="option.label" [severity]="getSeveridadTag(option.value)" />
                    </ng-template>
                    <ng-template let-option pTemplate="selectedItem">
                      <p-tag [value]="option.label" [severity]="getSeveridadTag(option.value)" />
                    </ng-template>
                  </p-select>
                }
                @case ('fecha') {
                  <p-datePicker
                    [ngModel]="getValorAccionMasiva('fecha')"
                    (ngModelChange)="actualizarValorAccionMasiva('fecha', $event)"
                    [showIcon]="true"
                    dateFormat="dd/mm/yy"
                    placeholder="Seleccionar fecha"
                    [style]="{ width: '100%' }"
                    appendTo="body" />
                }
                @case ('probabilidad') {
                  <p-inputNumber
                    [ngModel]="getValorAccionMasiva('probabilidad')"
                    (ngModelChange)="actualizarValorAccionMasiva('probabilidad', $event)"
                    [min]="1"
                    [max]="5"
                    [showButtons]="true"
                    placeholder="1-5"
                    [style]="{ width: '100%' }" />
                }
                @case ('impacto') {
                  <p-inputNumber
                    [ngModel]="getValorAccionMasiva('impacto')"
                    (ngModelChange)="actualizarValorAccionMasiva('impacto', $event)"
                    [min]="1"
                    [max]="5"
                    [showButtons]="true"
                    placeholder="1-5"
                    [style]="{ width: '100%' }" />
                }
                @default {
                  <!-- Input de texto para campos genéricos -->
                  <input
                    pInputText
                    [ngModel]="getValorAccionMasiva(col.field)"
                    (ngModelChange)="actualizarValorAccionMasiva(col.field, $event)"
                    [placeholder]="'Nuevo valor para ' + col.header"
                    class="w-full" />
                }
              }
            </div>
          }
        </div>
      }
    </div>

    <!-- Acciones adicionales -->
    <p-divider />
    <div class="acciones-adicionales">
      <p-button
        label="Eliminar seleccionados"
        icon="pi pi-trash"
        severity="danger"
        [outlined]="true"
        [style]="{ width: '100%' }"
        (onClick)="eliminarSeleccionados()" />
    </div>
  </div>

  <ng-template pTemplate="footer">
    <div class="flex justify-content-between align-items-center w-full">
      <span class="text-secondary text-sm">
        @if (getCantidadCambiosPendientes() > 0) {
          {{ getCantidadCambiosPendientes() }} campo(s) a modificar
        } @else {
          Selecciona campos para modificar
        }
      </span>
      <div class="flex gap-2">
        <p-button
          label="Cancelar"
          [text]="true"
          severity="secondary"
          (onClick)="showAccionesMasivasDrawer.set(false)" />
        <p-button
          label="Aplicar cambios"
          icon="pi pi-check"
          (onClick)="aplicarAccionesMasivas()"
          [disabled]="getCantidadCambiosPendientes() === 0" />
      </div>
    </div>
  </ng-template>
</p-drawer>

<!-- Dialog: Asignar Responsable Masivo -->
<p-dialog
  header="Asignar Responsable"
  [(visible)]="showAsignarResponsableDialog"
  [modal]="true"
  [style]="{ width: '400px' }"
  [draggable]="false">
  <div class="flex flex-column gap-3">
    <p class="text-secondary m-0">
      Se asignará el responsable a <strong>{{ registrosSeleccionados().length }}</strong> registro(s) seleccionado(s).
    </p>
    <div class="flex flex-column gap-2">
      <label for="nuevoResponsable" class="font-medium">Nuevo Responsable</label>
      <input
        pInputText
        id="nuevoResponsable"
        [ngModel]="nuevoResponsable()"
        (ngModelChange)="nuevoResponsable.set($event)"
        placeholder="Nombre del responsable" />
    </div>
  </div>
  <ng-template pTemplate="footer">
    <p-button
      label="Cancelar"
      [text]="true"
      severity="secondary"
      (onClick)="showAsignarResponsableDialog.set(false)" />
    <p-button
      label="Asignar"
      icon="pi pi-check"
      (onClick)="confirmarAsignarResponsable()"
      [disabled]="!nuevoResponsable()" />
  </ng-template>
</p-dialog>

<!-- Dialog: Cambiar Estado Masivo -->
<p-dialog
  header="Cambiar Estado"
  [(visible)]="showCambiarEstadoDialog"
  [modal]="true"
  [style]="{ width: '400px' }"
  [draggable]="false">
  <div class="flex flex-column gap-3">
    <p class="text-secondary m-0">
      Se cambiará el estado de <strong>{{ registrosSeleccionados().length }}</strong> registro(s) seleccionado(s).
    </p>
    <div class="flex flex-column gap-2">
      <label for="nuevoEstado" class="font-medium">Nuevo Estado</label>
      <p-select
        id="nuevoEstado"
        [options]="estadoOptions"
        [ngModel]="nuevoEstadoMasivo()"
        (ngModelChange)="nuevoEstadoMasivo.set($event)"
        optionLabel="label"
        optionValue="value"
        placeholder="Seleccionar estado"
        [style]="{ width: '100%' }"
        appendTo="body" />
    </div>
  </div>
  <ng-template pTemplate="footer">
    <p-button
      label="Cancelar"
      [text]="true"
      severity="secondary"
      (onClick)="showCambiarEstadoDialog.set(false)" />
    <p-button
      label="Cambiar"
      icon="pi pi-check"
      (onClick)="confirmarCambiarEstado()"
      [disabled]="!nuevoEstadoMasivo()" />
  </ng-template>
</p-dialog>

<!-- Dialog: Historial del Registro -->
<p-dialog
  header="Historial de Cambios"
  [(visible)]="showHistorialDialog"
  [modal]="true"
  [style]="{ width: '550px' }"
  [draggable]="false"
  [resizable]="false">
  @if (registroSeleccionado(); as registro) {
    <div class="historial-header mb-4">
      <p-tag
        [value]="getTipoEntidadLabel(registro.tipoEntidad)"
        [icon]="getTipoEntidadIcon(registro.tipoEntidad)"
        [severity]="registro.tipoEntidad === 'riesgo' ? 'warn' : 'danger'" />
      <span class="ml-2 font-semibold">{{ registro.titulo || registro.descripcion | slice:0:50 }}</span>
    </div>

    <p-timeline [value]="historialRegistro()" styleClass="historial-timeline">
      <ng-template pTemplate="marker" let-evento>
        <span
          class="historial-marker"
          [style.background-color]="getHistorialColor(evento.accion)">
          <i [class]="getHistorialIcon(evento.accion)"></i>
        </span>
      </ng-template>
      <ng-template pTemplate="content" let-evento>
        <div class="historial-evento">
          <div class="historial-evento-header">
            <span class="historial-accion font-semibold">{{ evento.accion }}</span>
            <span class="historial-fecha text-secondary text-sm">
              {{ evento.fecha | date:'dd/MM/yyyy HH:mm' }}
            </span>
          </div>
          <div class="historial-usuario text-sm">
            <i class="pi pi-user mr-1"></i>{{ evento.usuario }}
          </div>
          <div class="historial-detalles text-secondary text-sm mt-1">
            {{ evento.detalles }}
          </div>
        </div>
      </ng-template>
    </p-timeline>
  }
  <ng-template pTemplate="footer">
    <p-button
      label="Cerrar"
      (onClick)="showHistorialDialog.set(false)" />
  </ng-template>
</p-dialog>

<!-- Dialog: Guardar como Widget -->
<p-dialog
  header="Guardar como Widget"
  [(visible)]="showGuardarWidgetDialog"
  [modal]="true"
  [style]="{ width: '450px' }"
  [draggable]="false">
  <div class="flex flex-column gap-3">
    <p class="text-secondary m-0">
      Guarda la configuración actual de la gráfica como un widget para el dashboard.
    </p>
    <div class="flex flex-column gap-2">
      <label for="widgetTitulo" class="font-medium">Título del Widget</label>
      <input
        pInputText
        id="widgetTitulo"
        [(ngModel)]="widgetConfig.titulo"
        placeholder="Ej: Riesgos por Estado" />
    </div>
    <div class="flex flex-column gap-2">
      <label for="widgetDescripcion" class="font-medium">Descripción (opcional)</label>
      <textarea
        pTextarea
        id="widgetDescripcion"
        [(ngModel)]="widgetConfig.descripcion"
        placeholder="Descripción del widget..."
        rows="3"></textarea>
    </div>
    <div class="flex flex-column gap-2">
      <label class="font-medium">Tamaño del Widget</label>
      <div class="flex gap-2">
        <p-button
          label="Pequeño"
          [outlined]="widgetConfig.tamano !== 'pequeño'"
          (onClick)="setWidgetTamano('pequeño')"
          size="small" />
        <p-button
          label="Mediano"
          [outlined]="widgetConfig.tamano !== 'mediano'"
          (onClick)="setWidgetTamano('mediano')"
          size="small" />
        <p-button
          label="Grande"
          [outlined]="widgetConfig.tamano !== 'grande'"
          (onClick)="setWidgetTamano('grande')"
          size="small" />
      </div>
    </div>
  </div>
  <ng-template pTemplate="footer">
    <p-button
      label="Cancelar"
      [text]="true"
      severity="secondary"
      (onClick)="showGuardarWidgetDialog.set(false)" />
    <p-button
      label="Guardar Widget"
      icon="pi pi-check"
      (onClick)="guardarWidget()"
      [disabled]="!widgetConfig.titulo" />
  </ng-template>
</p-dialog>

<!-- Drawer: Configuración de Alertas -->
<p-drawer
  [(visible)]="showAlertasDialog"
  position="right"
  [style]="{ width: '520px' }"
  header="Configuración de Alertas">
  <div class="alertas-drawer-content">
    <!-- Tabs -->
    <p-tabs [(value)]="alertasTabActivo">
      <p-tablist>
        <p-tab value="nueva">
          <i class="pi pi-plus mr-2"></i>
          Nueva Alerta
        </p-tab>
        <p-tab value="lista">
          <span class="tab-icon-badge">
            <i class="pi pi-bell"></i>
            @if (alertas().length > 0) {
              <span class="icon-badge">{{ alertas().length }}</span>
            }
          </span>
          Guardadas
        </p-tab>
      </p-tablist>

      <p-tabpanels>
        <!-- Tab: Nueva Alerta -->
        <p-tabpanel value="nueva">
          <div class="nueva-alerta-form">
            <p class="text-secondary text-sm mb-4">
              <i class="pi pi-info-circle mr-1"></i>
              Configura alertas que se activen cuando los datos cumplan ciertas condiciones.
            </p>

            <div class="flex flex-column gap-3">
              <div class="flex flex-column gap-2">
                <label class="font-medium">Nombre de la alerta</label>
                <input
                  pInputText
                  [(ngModel)]="nuevaAlerta.nombre"
                  placeholder="Ej: Riesgos críticos altos"
                  class="w-full" />
              </div>

              <div class="flex flex-column gap-2">
                <label class="font-medium">Condición de activación</label>
                <div class="flex gap-2 align-items-center flex-wrap">
                  <span class="text-sm">Activar cuando haya</span>
                  <p-select
                    [options]="operadoresUmbral"
                    [(ngModel)]="nuevaAlerta.operadorUmbral"
                    optionLabel="label"
                    optionValue="value"
                    [style]="{ width: '120px' }"
                    appendTo="body" />
                  <p-inputNumber
                    [(ngModel)]="nuevaAlerta.umbral"
                    [min]="1"
                    [showButtons]="true"
                    [style]="{ width: '100px' }" />
                  <span class="text-sm">registros</span>
                </div>
              </div>

              <div class="flex flex-column gap-2">
                <label class="font-medium">Prioridad</label>
                <p-select
                  [options]="prioridadOptions"
                  [(ngModel)]="nuevaAlerta.prioridad"
                  optionLabel="label"
                  optionValue="value"
                  placeholder="Seleccionar prioridad"
                  [style]="{ width: '100%' }"
                  appendTo="body" />
              </div>

              <div class="flex flex-column gap-2">
                <label class="font-medium">Notificar por</label>
                <div class="flex gap-3 flex-wrap">
                  <div class="flex align-items-center gap-2">
                    <p-checkbox
                      [(ngModel)]="nuevaAlerta.notificarEmail"
                      [binary]="true"
                      inputId="notifEmail" />
                    <label for="notifEmail" class="text-sm">Email</label>
                  </div>
                  <div class="flex align-items-center gap-2">
                    <p-checkbox
                      [(ngModel)]="nuevaAlerta.notificarPush"
                      [binary]="true"
                      inputId="notifPush" />
                    <label for="notifPush" class="text-sm">Push</label>
                  </div>
                  <div class="flex align-items-center gap-2">
                    <p-checkbox
                      [(ngModel)]="nuevaAlerta.notificarInApp"
                      [binary]="true"
                      inputId="notifInApp" />
                    <label for="notifInApp" class="text-sm">En App</label>
                  </div>
                </div>
              </div>
            </div>

            <!-- Botón de crear -->
            <div class="mt-4">
              <p-button
                [label]="alertaEditandoId() ? 'Guardar Cambios' : 'Crear Alerta'"
                icon="pi pi-check"
                [style]="{ width: '100%' }"
                (onClick)="crearAlertaYCambiarTab()"
                [disabled]="!nuevaAlerta.nombre || !nuevaAlerta.prioridad" />
            </div>
          </div>
        </p-tabpanel>

        <!-- Tab: Lista de Alertas -->
        <p-tabpanel value="lista">
          <div class="alertas-lista-drawer">
            @if (alertas().length > 0) {
              <div class="alertas-cards">
                @for (alerta of alertas(); track alerta.id) {
                  <div class="alerta-card" [class.inactiva]="!alerta.activa">
                    <!-- Header de la card -->
                    <div class="alerta-card-header">
                      <div class="flex align-items-center gap-2">
                        <i class="pi pi-bell" [class.text-primary]="alerta.activa"></i>
                        <span class="alerta-nombre">{{ alerta.nombre }}</span>
                      </div>
                      <p-toggleswitch
                        [(ngModel)]="alerta.activa"
                        (onChange)="toggleAlertaActiva(alerta)"
                        pTooltip="Activar/Desactivar" />
                    </div>

                    <!-- Body de la card -->
                    <div class="alerta-card-body">
                      <div class="alerta-info-row">
                        <span class="info-label">Prioridad:</span>
                        <p-tag
                          [value]="alerta.prioridad | titlecase"
                          [severity]="getPrioridadSeverity(alerta.prioridad)"
                          styleClass="text-xs" />
                      </div>
                      <div class="alerta-info-row">
                        <span class="info-label">Condición:</span>
                        <span class="info-value">{{ getOperadorLabel(alerta.operadorUmbral) }} {{ alerta.umbral }} registros</span>
                      </div>
                      <div class="alerta-info-row">
                        <span class="info-label">Notificar:</span>
                        <div class="flex gap-1 flex-wrap">
                          @for (notif of alerta.notificarPor; track notif) {
                            <p-tag [value]="notif" severity="info" styleClass="text-xs" />
                          }
                        </div>
                      </div>
                      @if (alerta.vecesActivada > 0) {
                        <div class="alerta-info-row">
                          <span class="info-label">Activaciones:</span>
                          <span class="info-value">{{ alerta.vecesActivada }} veces</span>
                        </div>
                      }
                      @if (alerta.ultimaActivacion) {
                        <div class="alerta-info-row">
                          <span class="info-label">Última:</span>
                          <span class="info-value">{{ alerta.ultimaActivacion | date:'dd/MM/yyyy HH:mm' }}</span>
                        </div>
                      }
                    </div>

                    <!-- Footer de la card -->
                    <div class="alerta-card-footer">
                      <p-button
                        icon="pi pi-pencil"
                        severity="secondary"
                        [text]="true"
                        size="small"
                        (onClick)="editarAlerta(alerta)"
                        pTooltip="Editar" />
                      <p-button
                        icon="pi pi-trash"
                        severity="danger"
                        [text]="true"
                        size="small"
                        (onClick)="eliminarAlerta(alerta.id)"
                        pTooltip="Eliminar" />
                    </div>
                  </div>
                }
              </div>
            } @else {
              <div class="alertas-empty">
                <i class="pi pi-bell-slash text-4xl mb-3 text-secondary"></i>
                <p class="text-secondary mb-2">No hay alertas configuradas</p>
                <p-button
                  label="Crear primera alerta"
                  icon="pi pi-plus"
                  [outlined]="true"
                  size="small"
                  (onClick)="alertasTabActivo = 'nueva'" />
              </div>
            }
          </div>
        </p-tabpanel>
      </p-tabpanels>
    </p-tabs>
  </div>

  <ng-template pTemplate="footer">
    <p-button
      label="Cerrar"
      icon="pi pi-times"
      severity="secondary"
      (onClick)="showAlertasDialog.set(false)" />
  </ng-template>
</p-drawer>

<!-- Dialog: Compartir Vista -->
<p-dialog
  header="Compartir Vista Actual"
  [(visible)]="showCompartirDialog"
  [modal]="true"
  [style]="{ width: '500px' }"
  [draggable]="false">
  <div class="flex flex-column gap-3">
    <p class="text-secondary m-0">
      Genera un enlace para compartir la vista actual con los filtros y configuración aplicados.
    </p>
    <div class="flex flex-column gap-2">
      <label class="font-medium">Nombre de la Vista</label>
      <input
        pInputText
        [(ngModel)]="vistaCompartida.nombre"
        placeholder="Ej: Riesgos críticos Q1" />
    </div>
    <div class="flex flex-column gap-2">
      <label class="font-medium">Descripción (opcional)</label>
      <textarea
        pTextarea
        [(ngModel)]="vistaCompartida.descripcion"
        placeholder="Descripción de la vista..."
        rows="2"></textarea>
    </div>
    <div class="flex flex-column gap-2">
      <label class="font-medium">Fecha de expiración (opcional)</label>
      <p-datePicker
        [(ngModel)]="vistaCompartida.fechaExpiracion"
        [showIcon]="true"
        dateFormat="dd/mm/yy"
        [minDate]="today"
        placeholder="Sin expiración" />
    </div>

    @if (urlVistaCompartida()) {
      <div class="vista-url-container">
        <label class="font-medium">Enlace generado</label>
        <div class="flex gap-2 mt-1">
          <input
            pInputText
            [value]="urlVistaCompartida()"
            readonly
            class="flex-1" />
          <p-button
            icon="pi pi-copy"
            severity="secondary"
            (onClick)="copiarUrlVista()"
            pTooltip="Copiar enlace" />
        </div>
      </div>
    }
  </div>
  <ng-template pTemplate="footer">
    <p-button
      label="Cancelar"
      [text]="true"
      severity="secondary"
      (onClick)="showCompartirDialog.set(false)" />
    @if (!urlVistaCompartida()) {
      <p-button
        label="Generar Enlace"
        icon="pi pi-link"
        (onClick)="generarEnlaceVista()"
        [disabled]="!vistaCompartida.nombre" />
    } @else {
      <p-button
        label="Listo"
        icon="pi pi-check"
        (onClick)="showCompartirDialog.set(false)" />
    }
  </ng-template>
</p-dialog>

<!-- Drawer: Vistas Guardadas -->
<p-drawer
  [(visible)]="showVistasDialog"
  position="right"
  [style]="{ width: '480px' }"
  header="Vistas Guardadas">
  <div class="vistas-drawer-content">
    <!-- Sección para guardar vista actual -->
    <div class="guardar-vista-section">
      @if (!mostrandoFormGuardar()) {
        <p-button
          label="Guardar vista actual"
          icon="pi pi-bookmark"
          [style]="{ width: '100%' }"
          (onClick)="mostrandoFormGuardar.set(true)" />
      } @else {
        <div class="guardar-vista-form">
          <div class="flex flex-column gap-3">
            <div class="flex flex-column gap-2">
              <label class="font-medium">Nombre de la vista</label>
              <input
                pInputText
                [(ngModel)]="nuevaVistaGuardada.nombre"
                placeholder="Ej: Riesgos críticos Q1"
                class="w-full" />
            </div>
            <div class="flex flex-column gap-2">
              <label class="font-medium">Descripción (opcional)</label>
              <textarea
                pTextarea
                [(ngModel)]="nuevaVistaGuardada.descripcion"
                placeholder="Descripción de la vista..."
                rows="2"
                class="w-full"></textarea>
            </div>
            <div class="flex flex-column gap-2">
              <label class="font-medium">Fecha de expiración (opcional)</label>
              <p-datePicker
                [(ngModel)]="nuevaVistaGuardada.fechaExpiracion"
                [showIcon]="true"
                dateFormat="dd/mm/yy"
                [minDate]="today"
                placeholder="Sin expiración"
                [style]="{ width: '100%' }"
                appendTo="body" />
            </div>
            <div class="flex gap-2 justify-content-end">
              <p-button
                label="Cancelar"
                [text]="true"
                severity="secondary"
                (onClick)="cancelarGuardarVista()" />
              <p-button
                label="Guardar"
                icon="pi pi-check"
                (onClick)="guardarVistaActual()"
                [disabled]="!nuevaVistaGuardada.nombre" />
            </div>
          </div>
        </div>
      }
    </div>

    <p-divider />

    <!-- Lista de vistas guardadas -->
    <div class="vistas-lista-drawer">
      @if (vistasCompartidas().length > 0) {
        <div class="vistas-cards">
          @for (vista of vistasCompartidas(); track vista.id) {
            <div class="vista-card" [class.inactiva]="!vista.activa" [class.editando]="vistaEditandoId() === vista.id">
              <!-- Header de la card -->
              <div class="vista-card-header">
                <div class="flex align-items-center gap-2">
                  <i class="pi pi-bookmark text-primary"></i>
                  <span class="vista-nombre">{{ vista.nombre }}</span>
                </div>
                <div class="flex align-items-center gap-1">
                  @if (!vista.activa) {
                    <p-tag value="Inactiva" severity="secondary" styleClass="text-xs" />
                  }
                  @if (vista.fechaExpiracion) {
                    <p-tag
                      [value]="'Expira ' + (vista.fechaExpiracion | date:'dd/MM')"
                      severity="warn"
                      styleClass="text-xs" />
                  }
                </div>
              </div>

              <!-- Formulario de edición in-place -->
              @if (vistaEditandoId() === vista.id) {
                <div class="vista-card-editar">
                  <div class="flex flex-column gap-3">
                    <div class="flex flex-column gap-2">
                      <label class="text-sm font-medium">Nombre</label>
                      <input
                        pInputText
                        [(ngModel)]="vistaEditando.nombre"
                        class="w-full" />
                    </div>
                    <div class="flex flex-column gap-2">
                      <label class="text-sm font-medium">Descripción</label>
                      <textarea
                        pTextarea
                        [(ngModel)]="vistaEditando.descripcion"
                        rows="2"
                        class="w-full"></textarea>
                    </div>
                    <div class="flex flex-column gap-2">
                      <label class="text-sm font-medium">Fecha de expiración</label>
                      <p-datePicker
                        [(ngModel)]="vistaEditando.fechaExpiracion"
                        [showIcon]="true"
                        dateFormat="dd/mm/yy"
                        [minDate]="today"
                        placeholder="Sin expiración"
                        [style]="{ width: '100%' }"
                        appendTo="body" />
                    </div>
                    <div class="flex gap-2 justify-content-end">
                      <p-button
                        label="Cancelar"
                        [text]="true"
                        severity="secondary"
                        size="small"
                        (onClick)="cancelarEditarVista()" />
                      <p-button
                        label="Guardar cambios"
                        icon="pi pi-check"
                        size="small"
                        (onClick)="guardarEdicionVista()" />
                    </div>
                  </div>
                </div>
              } @else {
                <!-- Body de la card -->
                <div class="vista-card-body">
                  @if (vista.descripcion) {
                    <p class="vista-descripcion">{{ vista.descripcion }}</p>
                  }
                  <div class="vista-meta">
                    <span><i class="pi pi-calendar"></i> {{ vista.fechaCreacion | date:'dd/MM/yyyy' }}</span>
                    <span><i class="pi pi-eye"></i> {{ vista.accesos }} accesos</span>
                  </div>
                </div>

                <!-- Sección de compartir in-place -->
                <div class="vista-card-compartir">
                  @if (vistaCompartiendoId() === vista.id) {
                    <div class="compartir-expandido">
                      <label class="text-sm font-medium mb-2 block">Enlace para compartir:</label>
                      <div class="flex gap-2 mb-3">
                        <input
                          pInputText
                          [value]="getUrlVistaGuardada(vista)"
                          readonly
                          class="flex-1 text-sm" />
                        <p-button
                          icon="pi pi-copy"
                          severity="secondary"
                          [outlined]="true"
                          (onClick)="copiarUrlVistaGuardada(vista)"
                          pTooltip="Copiar enlace" />
                      </div>

                      <!-- Enviar por correo -->
                      <div class="enviar-correo-section">
                        <label class="text-sm font-medium mb-2 block">Enviar por correo:</label>
                        <div class="flex gap-2">
                          <input
                            pInputText
                            [(ngModel)]="emailCompartir"
                            placeholder="email@ejemplo.com"
                            class="flex-1 text-sm" />
                          <p-button
                            icon="pi pi-send"
                            severity="primary"
                            [outlined]="true"
                            (onClick)="enviarVistaPorCorreo(vista)"
                            [disabled]="!emailCompartir"
                            pTooltip="Enviar" />
                        </div>
                      </div>

                      <p-button
                        label="Cerrar"
                        [text]="true"
                        size="small"
                        styleClass="mt-3"
                        (onClick)="vistaCompartiendoId.set(null)" />
                    </div>
                  } @else {
                    <p-button
                      label="Compartir enlace"
                      icon="pi pi-share-alt"
                      [text]="true"
                      size="small"
                      (onClick)="vistaCompartiendoId.set(vista.id)" />
                  }
                </div>

                <!-- Footer de la card -->
                <div class="vista-card-footer">
                  <div class="flex gap-2">
                    <p-button
                      icon="pi pi-play"
                      label="Aplicar"
                      severity="success"
                      [outlined]="true"
                      size="small"
                      (onClick)="aplicarVista(vista)" />
                    <p-button
                      icon="pi pi-pencil"
                      severity="secondary"
                      [text]="true"
                      size="small"
                      (onClick)="iniciarEditarVista(vista)"
                      pTooltip="Editar" />
                  </div>
                  <p-button
                    icon="pi pi-trash"
                    severity="danger"
                    [text]="true"
                    size="small"
                    (onClick)="eliminarVista(vista.id)"
                    pTooltip="Eliminar" />
                </div>
              }
            </div>
          }
        </div>
      } @else {
        <div class="vistas-empty">
          <i class="pi pi-bookmark text-4xl mb-3 text-secondary"></i>
          <p class="text-secondary mb-2">No hay vistas guardadas</p>
          <p class="text-sm text-secondary">Guarda la configuración actual para acceder rápidamente</p>
        </div>
      }
    </div>
  </div>

  <ng-template pTemplate="footer">
    <p-button
      label="Cerrar"
      icon="pi pi-times"
      severity="secondary"
      (onClick)="showVistasDialog.set(false)" />
  </ng-template>
</p-drawer>

<!-- Drawer: Exportaciones Programadas -->
<p-drawer
  [(visible)]="showExportacionesDialog"
  position="right"
  [style]="{ width: '520px' }"
  header="Exportaciones Programadas">
  <div class="exportaciones-drawer-content">
    <!-- Tabs -->
    <p-tabs [(value)]="exportacionesTabActivo">
      <p-tablist>
        <p-tab value="nueva">
          <i class="pi pi-plus mr-2"></i>
          Nueva Exportación
        </p-tab>
        <p-tab value="lista">
          <span class="tab-icon-badge">
            <i class="pi pi-list"></i>
            @if (exportacionesProgramadas().length > 0) {
              <span class="icon-badge">{{ exportacionesProgramadas().length }}</span>
            }
          </span>
          Guardadas
        </p-tab>
      </p-tablist>

      <p-tabpanels>
        <!-- Tab: Nueva Exportación -->
        <p-tabpanel value="nueva">
          <div class="nueva-exportacion-form">
            <p class="text-secondary text-sm mb-4">
              <i class="pi pi-info-circle mr-1"></i>
              Programa una exportación automática con los filtros actuales.
            </p>

            <div class="flex flex-column gap-3">
              <div class="flex flex-column gap-2">
                <label class="font-medium">Nombre de la exportación</label>
                <input
                  pInputText
                  [(ngModel)]="nuevaExportacion.nombre"
                  placeholder="Ej: Reporte semanal de riesgos"
                  class="w-full" />
              </div>

              <div class="flex flex-column gap-2">
                <label class="font-medium">Formato de archivo</label>
                <p-select
                  [options]="formatoExportacionOptions"
                  [(ngModel)]="nuevaExportacion.formato"
                  optionLabel="label"
                  optionValue="value"
                  placeholder="Seleccionar formato"
                  [style]="{ width: '100%' }"
                  appendTo="body">
                  <ng-template let-option pTemplate="item">
                    <div class="flex align-items-center gap-2">
                      <i [class]="option.value === 'excel' ? 'pi pi-file-excel text-green-500' : 'pi pi-file text-blue-500'"></i>
                      <span>{{ option.label }}</span>
                    </div>
                  </ng-template>
                  <ng-template let-option pTemplate="selectedItem">
                    <div class="flex align-items-center gap-2">
                      <i [class]="option.value === 'excel' ? 'pi pi-file-excel text-green-500' : 'pi pi-file text-blue-500'"></i>
                      <span>{{ option.label }}</span>
                    </div>
                  </ng-template>
                </p-select>
              </div>

              <div class="flex flex-column gap-2">
                <label class="font-medium">Frecuencia</label>
                <p-select
                  [options]="frecuenciaOptions"
                  [(ngModel)]="nuevaExportacion.frecuencia"
                  optionLabel="label"
                  optionValue="value"
                  placeholder="Seleccionar frecuencia"
                  [style]="{ width: '100%' }"
                  appendTo="body" />
              </div>

              <div class="flex flex-column gap-2">
                <label class="font-medium">Hora de ejecución</label>
                <p-datePicker
                  [(ngModel)]="nuevaExportacion.hora"
                  [timeOnly]="true"
                  [showIcon]="true"
                  placeholder="Seleccionar hora"
                  [style]="{ width: '100%' }"
                  appendTo="body" />
              </div>

              <div class="flex flex-column gap-2">
                <label class="font-medium">Destinatarios</label>
                <input
                  pInputText
                  [(ngModel)]="nuevaExportacion.destinatarios"
                  placeholder="email1@ejemplo.com, email2@ejemplo.com"
                  class="w-full" />
                <small class="text-secondary">Separa los emails con comas</small>
              </div>
            </div>

            <!-- Botón de crear -->
            <div class="mt-4">
              <p-button
                label="Crear Exportación Programada"
                icon="pi pi-check"
                [style]="{ width: '100%' }"
                (onClick)="crearExportacionYCambiarTab()"
                [disabled]="!nuevaExportacion.nombre || !nuevaExportacion.formato || !nuevaExportacion.frecuencia" />
            </div>
          </div>
        </p-tabpanel>

        <!-- Tab: Lista de Exportaciones -->
        <p-tabpanel value="lista">
          <div class="exportaciones-lista">
            @if (exportacionesProgramadas().length > 0) {
              <div class="exportaciones-cards">
                @for (exp of exportacionesProgramadas(); track exp.id) {
                  <div class="exportacion-card" [class.inactiva]="!exp.activa">
                    <!-- Header de la card -->
                    <div class="exportacion-card-header">
                      <div class="flex align-items-center gap-2">
                        <i [class]="exp.formato === 'excel' ? 'pi pi-file-excel text-green-500' : 'pi pi-file text-blue-500'" style="font-size: 1.25rem;"></i>
                        <span class="exportacion-nombre">{{ exp.nombre }}</span>
                      </div>
                      <p-toggleswitch
                        [(ngModel)]="exp.activa"
                        (onChange)="toggleExportacionActiva(exp)"
                        pTooltip="Activar/Desactivar" />
                    </div>

                    <!-- Body de la card -->
                    <div class="exportacion-card-body">
                      <div class="exportacion-info-row">
                        <span class="info-label">Formato:</span>
                        <p-tag [value]="exp.formato | uppercase" [severity]="exp.formato === 'excel' ? 'success' : 'info'" styleClass="text-xs" />
                      </div>
                      <div class="exportacion-info-row">
                        <span class="info-label">Frecuencia:</span>
                        <span class="info-value">{{ exp.frecuencia | titlecase }}</span>
                      </div>
                      <div class="exportacion-info-row">
                        <span class="info-label">Hora:</span>
                        <span class="info-value">{{ exp.hora }}</span>
                      </div>
                      <div class="exportacion-info-row">
                        <span class="info-label">Próxima ejecución:</span>
                        <span class="info-value">{{ exp.proximaEjecucion | date:'dd/MM/yyyy HH:mm' }}</span>
                      </div>
                      @if (exp.destinatarios && exp.destinatarios.length > 0) {
                        <div class="exportacion-info-row">
                          <span class="info-label">Destinatarios:</span>
                          <span class="info-value text-sm">{{ exp.destinatarios.join(', ') }}</span>
                        </div>
                      }
                    </div>

                    <!-- Footer de la card -->
                    <div class="exportacion-card-footer">
                      <p-button
                        icon="pi pi-pencil"
                        severity="secondary"
                        [text]="true"
                        size="small"
                        (onClick)="editarExportacion(exp)"
                        pTooltip="Editar" />
                      <p-button
                        icon="pi pi-trash"
                        severity="danger"
                        [text]="true"
                        size="small"
                        (onClick)="eliminarExportacion(exp.id)"
                        pTooltip="Eliminar" />
                    </div>
                  </div>
                }
              </div>
            } @else {
              <div class="exportaciones-empty">
                <i class="pi pi-calendar text-4xl mb-3 text-secondary"></i>
                <p class="text-secondary mb-2">No hay exportaciones programadas</p>
                <p-button
                  label="Crear primera exportación"
                  icon="pi pi-plus"
                  [outlined]="true"
                  size="small"
                  (onClick)="exportacionesTabActivo = 'nueva'" />
              </div>
            }
          </div>
        </p-tabpanel>
      </p-tabpanels>
    </p-tabs>
  </div>

  <ng-template pTemplate="footer">
    <p-button
      label="Cerrar"
      icon="pi pi-times"
      severity="secondary"
      (onClick)="showExportacionesDialog.set(false)" />
  </ng-template>
</p-drawer>

<!-- Drawer: Visualización de Relaciones -->
<p-drawer
  [(visible)]="showRelacionesDrawer"
  position="right"
  [style]="{ width: '600px' }"
  header="Visualización de Relaciones">
  <div class="relaciones-drawer-content">
    @if (registroRelaciones()) {
      <!-- Header con info del registro -->
      <div class="relaciones-header">
        <div class="registro-info">
          <p-tag
            [value]="getTipoEntidadLabel(registroRelaciones()!.tipoEntidad)"
            [icon]="getTipoEntidadIcon(registroRelaciones()!.tipoEntidad)"
            [severity]="registroRelaciones()!.tipoEntidad === 'riesgo' ? 'warn' : registroRelaciones()!.tipoEntidad === 'incidente' ? 'danger' : 'info'" />
          <span class="registro-nombre">{{ registroRelaciones()!.descripcion || registroRelaciones()!.nombre }}</span>
        </div>
        @if (registroRelaciones()!.contenedorNombre) {
          <span class="registro-contenedor">
            <i class="pi pi-folder mr-1"></i>
            {{ registroRelaciones()!.contenedorNombre }}
          </span>
        }
      </div>

      <!-- Toolbar del grafo -->
      <div class="graph-toolbar">
        <div class="flex gap-2">
          <p-button
            icon="pi pi-search-plus"
            severity="secondary"
            [outlined]="true"
            size="small"
            (onClick)="zoomInGraph()"
            pTooltip="Acercar" />
          <p-button
            icon="pi pi-search-minus"
            severity="secondary"
            [outlined]="true"
            size="small"
            (onClick)="zoomOutGraph()"
            pTooltip="Alejar" />
          <p-button
            icon="pi pi-refresh"
            severity="secondary"
            [outlined]="true"
            size="small"
            (onClick)="resetGraphView()"
            pTooltip="Restablecer vista" />
        </div>
        <span class="zoom-indicator">{{ (graphZoom() * 100) | number:'1.0-0' }}%</span>
      </div>

      <!-- Área del grafo -->
      <div class="graph-container">
        <div
          class="graph-area"
          [style.transform]="'scale(' + graphZoom() + ') translate(' + graphPanX() + 'px, ' + graphPanY() + 'px)'"
          (wheel)="onGraphWheel($event)"
          (mousedown)="onGraphMouseDown($event)"
          (mousemove)="onGraphMouseMove($event)"
          (mouseup)="onGraphMouseUp()"
          (mouseleave)="onGraphMouseUp()">

          @if (graphData() && graphData()!.nodes.length > 0) {
            <svg class="graph-svg" viewBox="0 0 400 400">
              <!-- Líneas de conexión -->
              @for (edge of graphData()!.edges; track edge.source + edge.target) {
                <line
                  [attr.x1]="getEdgeSourcePosition(edge).x"
                  [attr.y1]="getEdgeSourcePosition(edge).y"
                  [attr.x2]="getEdgeTargetPosition(edge).x"
                  [attr.y2]="getEdgeTargetPosition(edge).y"
                  class="graph-edge" />
              }

              <!-- Nodos -->
              @for (node of graphData()!.nodes; track node.id; let i = $index) {
                <g class="graph-node" [attr.transform]="'translate(' + getNodePosition(i, graphData()!.nodes.length, node.type === 'central').x + ',' + getNodePosition(i, graphData()!.nodes.length, node.type === 'central').y + ')'">
                  <circle
                    [attr.r]="node.type === 'central' ? 35 : 25"
                    [attr.fill]="node.color"
                    class="node-circle"
                    [class.central]="node.type === 'central'" />
                  <text
                    class="node-icon"
                    text-anchor="middle"
                    dominant-baseline="central"
                    [attr.font-size]="node.type === 'central' ? '18' : '14'">
                    {{ node.icon }}
                  </text>
                </g>
              }
            </svg>
          } @else {
            <div class="graph-empty">
              <i class="pi pi-sitemap text-4xl mb-2"></i>
              <p>Sin relaciones encontradas</p>
            </div>
          }
        </div>
      </div>

      <!-- Leyenda -->
      <div class="graph-legend">
        <span class="legend-title">Leyenda:</span>
        <div class="legend-items">
          <div class="legend-item">
            <span class="legend-color" style="background: #6366f1;"></span>
            <span>Central</span>
          </div>
          <div class="legend-item">
            <span class="legend-color" style="background: #f59e0b;"></span>
            <span>Riesgo</span>
          </div>
          <div class="legend-item">
            <span class="legend-color" style="background: #ef4444;"></span>
            <span>Incidente</span>
          </div>
          <div class="legend-item">
            <span class="legend-color" style="background: #22c55e;"></span>
            <span>Activo</span>
          </div>
          <div class="legend-item">
            <span class="legend-color" style="background: #3b82f6;"></span>
            <span>Proceso</span>
          </div>
        </div>
      </div>

      <!-- Stats -->
      <div class="graph-stats">
        <span>{{ graphData()?.nodes?.length || 0 }} nodos</span>
        <span class="mx-2">•</span>
        <span>{{ graphData()?.edges?.length || 0 }} relaciones</span>
      </div>
    }
  </div>

  <ng-template pTemplate="footer">
    <p-button
      label="Cerrar"
      icon="pi pi-times"
      severity="secondary"
      (onClick)="showRelacionesDrawer.set(false)" />
  </ng-template>
</p-drawer>
