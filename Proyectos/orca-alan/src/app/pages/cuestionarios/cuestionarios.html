<p-toast />
<p-confirmDialog />

<!-- ==================== VISTA: LISTA DE CUESTIONARIOS ==================== -->
@if (vistaActual() === 'lista') {
<div class="surface-ground min-h-screen">
  <!-- Header Principal -->
  <div class="surface-card px-4 py-3 border-bottom-1 surface-border">
    <div class="flex justify-content-between align-items-center">
      <div>
        <h1 class="text-2xl font-bold text-900 m-0">Cuestionarios</h1>
        <p class="text-500 text-sm m-0 mt-1">Orca&#64;Securityby Design</p>
      </div>
      <div class="flex align-items-center gap-3">
        <p-button label="Ir a Cumplimiento" icon="pi pi-chart-line" severity="secondary" [outlined]="true" (onClick)="irACumplimiento()" />
      </div>
    </div>
  </div>

  <!-- Barra de herramientas -->
  <div class="surface-card px-4 py-3 border-bottom-1 surface-border">
    <div class="flex justify-content-between align-items-center">
      <p-button icon="pi pi-refresh" [rounded]="true" [text]="true" severity="secondary" />
      <p-iconfield style="width: 300px">
        <p-inputicon styleClass="pi pi-search" />
        <input type="text" pInputText placeholder="Buscar" [ngModel]="busqueda()" (ngModelChange)="busqueda.set($event)" class="w-full" />
      </p-iconfield>
      <p-button label="Nuevo Cuestionario" icon="pi pi-plus" (onClick)="crearNuevoCuestionario()" styleClass="bg-teal-500 border-teal-500" />
    </div>
  </div>

  <!-- Contenido Principal: Tabla de Cuestionarios -->
  <div class="p-4">
    <div class="surface-card border-round-lg">
      <p-table
        [value]="cuestionariosFiltrados()"
        [paginator]="true"
        [rows]="10"
        [rowsPerPageOptions]="[5, 10, 20]"
        [showCurrentPageReport]="true"
        currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} cuestionarios"
        styleClass="p-datatable-sm"
        selectionMode="single"
        (onRowSelect)="verDetalleCuestionario($any($event).data)">

        <ng-template #header>
          <tr>
            <th pSortableColumn="nombre" style="width: 25%">
              Nombre <p-sortIcon field="nombre" />
            </th>
            <th pSortableColumn="marcoNormativo" style="width: 12%">
              Marco <p-sortIcon field="marcoNormativo" />
            </th>
            <th pSortableColumn="categoria" style="width: 12%">
              Categoría <p-sortIcon field="categoria" />
            </th>
            <th pSortableColumn="tipo" style="width: 8%">
              Tipo <p-sortIcon field="tipo" />
            </th>
            <th pSortableColumn="preguntas" style="width: 10%">
              Preguntas <p-sortIcon field="preguntas" />
            </th>
            <th pSortableColumn="tasaCompletado" style="width: 12%">
              Cumplimiento <p-sortIcon field="tasaCompletado" />
            </th>
            <th pSortableColumn="estado" style="width: 10%">
              Estado <p-sortIcon field="estado" />
            </th>
            <th style="width: 11%">Acciones</th>
          </tr>
          <tr>
            <th>
              <p-columnFilter type="text" field="nombre" [showMenu]="false" [showClearButton]="false" placeholder="Buscar..." />
            </th>
            <th>
              <p-columnFilter field="marcoNormativo" matchMode="equals" [showMenu]="false" [showClearButton]="false">
                <ng-template #filter let-value let-filterCallback="filterCallback">
                  <p-select [options]="marcosNormativos()" optionLabel="acronimo" optionValue="id" [ngModel]="value" (ngModelChange)="filterCallback($event)" placeholder="Todos" [showClear]="true" styleClass="w-full" />
                </ng-template>
              </p-columnFilter>
            </th>
            <th>
              <p-columnFilter field="categoria" matchMode="equals" [showMenu]="false" [showClearButton]="false">
                <ng-template #filter let-value let-filterCallback="filterCallback">
                  <p-select [options]="categoriaOptions" optionLabel="label" optionValue="value" [ngModel]="value" (ngModelChange)="filterCallback($event)" placeholder="Todas" [showClear]="true" styleClass="w-full" />
                </ng-template>
              </p-columnFilter>
            </th>
            <th>
              <p-columnFilter field="tipo" matchMode="equals" [showMenu]="false" [showClearButton]="false">
                <ng-template #filter let-value let-filterCallback="filterCallback">
                  <p-select [options]="[{label: 'IA', value: 'ia'}, {label: 'Manual', value: 'manual'}]" optionLabel="label" optionValue="value" [ngModel]="value" (ngModelChange)="filterCallback($event)" placeholder="Todos" [showClear]="true" styleClass="w-full" />
                </ng-template>
              </p-columnFilter>
            </th>
            <th></th>
            <th></th>
            <th>
              <p-columnFilter field="estado" matchMode="equals" [showMenu]="false" [showClearButton]="false">
                <ng-template #filter let-value let-filterCallback="filterCallback">
                  <p-select [options]="[{label: 'Publicado', value: 'publicado'}, {label: 'Borrador', value: 'borrador'}, {label: 'Archivado', value: 'archivado'}]" optionLabel="label" optionValue="value" [ngModel]="value" (ngModelChange)="filterCallback($event)" placeholder="Todos" [showClear]="true" styleClass="w-full" />
                </ng-template>
              </p-columnFilter>
            </th>
            <th></th>
          </tr>
        </ng-template>

        <ng-template #body let-cuestionario>
          <tr class="cursor-pointer" (click)="verDetalleCuestionario(cuestionario)">
            <td>
              <div class="flex flex-column">
                <span class="font-semibold text-900">{{ cuestionario.nombre }}</span>
                <span class="text-500 text-xs">{{ cuestionario.descripcion | slice:0:50 }}{{ cuestionario.descripcion?.length > 50 ? '...' : '' }}</span>
              </div>
            </td>
            <td>
              <p-tag [value]="getMarcoNombre(cuestionario.marcoNormativo)" styleClass="text-xs" />
            </td>
            <td>
              <span class="text-900">{{ cuestionario.categoria | titlecase }}</span>
            </td>
            <td>
              <p-tag [value]="cuestionario.tipo === 'ia' ? 'IA' : 'Manual'" [severity]="getTipoSeverity(cuestionario.tipo)" styleClass="text-xs" />
            </td>
            <td>
              <div class="flex align-items-center gap-2">
                <i class="pi pi-question-circle text-500"></i>
                <span>{{ cuestionario.preguntas }}</span>
              </div>
            </td>
            <td>
              <div class="flex align-items-center gap-2">
                <p-progressBar [value]="cuestionario.tasaCompletado" [showValue]="false" styleClass="h-1rem flex-1" />
                <span class="text-sm font-medium">{{ cuestionario.tasaCompletado }}%</span>
              </div>
            </td>
            <td>
              <p-tag [value]="cuestionario.estado | titlecase" [severity]="getEstadoSeverity(cuestionario.estado)" styleClass="text-xs" />
            </td>
            <td class="text-center" (click)="$event.stopPropagation()">
              <p-menu #menuCuestionario [model]="getMenuItemsCuestionario(cuestionario)" [popup]="true" appendTo="body"></p-menu>
              <p-button icon="pi pi-ellipsis-v" [rounded]="true" [text]="true" size="small"
                        (onClick)="menuCuestionario.toggle($event)"></p-button>
            </td>
          </tr>
        </ng-template>

        <ng-template #emptymessage>
          <tr>
            <td colspan="8">
              <div class="flex flex-column align-items-center justify-content-center py-6">
                <i class="pi pi-inbox text-4xl text-300 mb-3"></i>
                <span class="text-500">No se encontraron cuestionarios</span>
                <p-button label="Crear cuestionario" icon="pi pi-plus" class="mt-3" (onClick)="crearNuevoCuestionario()" />
              </div>
            </td>
          </tr>
        </ng-template>

        <!-- Footer con resumen -->
        <ng-template pTemplate="summary">
          <div class="flex flex-wrap gap-4 py-2" style="border-top: 1px solid var(--surface-200);">
            <div class="flex align-items-center gap-2 text-sm">
              <span class="text-500">Total:</span>
              <span class="font-semibold">{{ totalCuestionarios() }}</span>
            </div>
            <div class="flex align-items-center gap-2 text-sm">
              <i class="pi pi-circle-fill text-green-500" style="font-size: 0.5rem"></i>
              <span class="text-500">Activos:</span>
              <span class="font-semibold">{{ totalActivos() }}</span>
            </div>
            <div class="flex align-items-center gap-2 text-sm">
              <i class="pi pi-circle-fill text-orange-500" style="font-size: 0.5rem"></i>
              <span class="text-500">Borradores:</span>
              <span class="font-semibold">{{ totalBorradores() }}</span>
            </div>
            <div class="flex align-items-center gap-2 text-sm">
              <i class="pi pi-question-circle text-blue-500"></i>
              <span class="text-500">Total Preguntas:</span>
              <span class="font-semibold">{{ totalPreguntas() }}</span>
            </div>
          </div>
        </ng-template>
      </p-table>
    </div>
  </div>
</div>
}

<!-- ==================== VISTA: WIZARD NUEVO CUESTIONARIO (Página completa) ==================== -->
@if (vistaActual() === 'wizard') {
<div class="surface-ground min-h-screen">
  <!-- Header con breadcrumb y título -->
  <div class="surface-card border-bottom-1 surface-border px-4 py-3">
    <div class="flex align-items-center gap-2 mb-3">
      <span class="material-icons text-500 cursor-pointer" style="font-size: 1.25rem;" (click)="cancelarWizard()">home</span>
      <span class="text-400">•</span>
      <span class="text-500 text-sm">Cuestionarios</span>
      <span class="text-400">•</span>
      <span class="text-500 text-sm">Nuevo</span>
    </div>
    <div class="flex justify-content-between align-items-center">
      <div>
        <h1 class="text-2xl font-bold text-900 m-0">Nuevo Cuestionario</h1>
        <p class="text-500 text-sm m-0 mt-1">Orca&#64;Securityby Design</p>
      </div>
    </div>
  </div>

  <!-- Contenedor principal -->
  <div class="p-4">
    <!-- Stepper horizontal -->
    <div class="surface-card border-round-xl p-4 mb-4">
      <div class="flex align-items-start justify-content-center gap-6">
        <!-- Paso 1: Método -->
        <div class="flex align-items-start gap-3">
          <div class="flex flex-column align-items-center">
            <div class="wizard-step-icon flex align-items-center justify-content-center border-circle"
                 [class]="wizardPaso() >= 0 ? 'bg-primary' : 'surface-200'"
                 style="width: 40px; height: 40px;">
              <span class="material-icons text-white" style="font-size: 1.25rem;">looks_one</span>
            </div>
            <div class="wizard-step-line mt-2" [class]="wizardPaso() >= 1 ? 'bg-primary' : 'surface-200'" style="width: 2px; height: 40px;"></div>
          </div>
          <div class="flex flex-column">
            <span class="font-semibold text-900" [class]="wizardPaso() >= 0 ? 'text-900' : 'text-500'">Método</span>
            <span class="text-500 text-sm">Selecciona cómo deseas crear tu cuestionario con IA o manualmente</span>
          </div>
        </div>

        <!-- Paso 2: Datos -->
        <div class="flex align-items-start gap-3">
          <div class="flex flex-column align-items-center">
            <div class="wizard-step-icon flex align-items-center justify-content-center border-circle"
                 [class]="wizardPaso() >= 1 ? 'bg-primary' : 'surface-200'"
                 style="width: 40px; height: 40px;">
              <span class="material-icons" [class]="wizardPaso() >= 1 ? 'text-white' : 'text-500'" style="font-size: 1.25rem;">looks_two</span>
            </div>
            <div class="wizard-step-line mt-2" [class]="wizardPaso() >= 2 ? 'bg-primary' : 'surface-200'" style="width: 2px; height: 40px;"></div>
          </div>
          <div class="flex flex-column">
            <span class="font-semibold" [class]="wizardPaso() >= 1 ? 'text-900' : 'text-500'">Datos</span>
            <span class="text-500 text-sm">Nombre y marco normativo</span>
          </div>
        </div>

        <!-- Paso 3: Umbrales -->
        <div class="flex align-items-start gap-3">
          <div class="flex flex-column align-items-center">
            <div class="wizard-step-icon flex align-items-center justify-content-center border-circle"
                 [class]="wizardPaso() >= 2 ? 'bg-primary' : 'surface-200'"
                 style="width: 40px; height: 40px;">
              <span class="material-icons" [class]="wizardPaso() >= 2 ? 'text-white' : 'text-500'" style="font-size: 1.25rem;">looks_3</span>
            </div>
          </div>
          <div class="flex flex-column">
            <span class="font-semibold" [class]="wizardPaso() >= 2 ? 'text-900' : 'text-500'">Umbrales</span>
            <span class="text-500 text-sm">Define rangos de calificación</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Tarjeta de contexto (Contenedor o proceso) -->
    <div class="surface-card border-round-xl p-4 mb-4 shadow-1">
      <div class="flex align-items-center gap-3">
        <div>
          <h3 class="text-lg font-semibold text-900 m-0">Contenedor o proceso</h3>
          <p class="text-500 text-sm m-0 mt-1">Severidad: Alta | Impacto Financiero: $45,000 | Estado: En Resolución</p>
        </div>
      </div>
    </div>

    <!-- Paso 0: Selección de Método -->
    @if (wizardPaso() === 0) {
    <div class="grid">
      <!-- Opción Cuestionario IA -->
      <div class="col-12 md:col-6">
        <div class="wizard-method-card h-full border-round-xl p-4 cursor-pointer transition-all"
             [class]="metodoCreacion() === 'ia' ? 'wizard-method-selected bg-purple-50' : 'surface-card shadow-1 hover:shadow-3'"
             style="background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);"
             (click)="seleccionarMetodoCreacion('ia')">
          <!-- Icono decorativo -->
          <div class="flex justify-content-center mb-4">
            <div class="wizard-method-icon flex align-items-center justify-content-center border-circle bg-purple-100"
                 style="width: 80px; height: 80px;">
              <span class="material-icons text-purple-500" style="font-size: 2.5rem;">psychology</span>
            </div>
          </div>

          <!-- Título y descripción -->
          <div class="text-center mb-4">
            <h3 class="text-xl font-bold text-900 m-0 mb-2">Cuestionario IA</h3>
            <p class="text-500 text-sm m-0 line-height-3">Genera preguntas automáticamente con IA o sube un documento</p>
          </div>

          <!-- Stats cards -->
          <div class="flex gap-2 mb-4">
            <div class="flex-1 surface-card border-round-lg p-3 shadow-1">
              <div class="text-center">
                <span class="text-xl font-bold text-900">89%</span>
                <p class="text-500 text-xs m-0 mt-1">Precisión</p>
              </div>
            </div>
            <div class="flex-1 surface-card border-round-lg p-3 shadow-1">
              <div class="text-center">
                <span class="text-xl font-bold text-900">&lt; 30 seg</span>
                <p class="text-500 text-xs m-0 mt-1">Tiempo Promedio</p>
              </div>
            </div>
            <div class="flex-1 surface-card border-round-lg p-3 shadow-1">
              <div class="text-center">
                <span class="text-xl font-bold text-900">5-50</span>
                <p class="text-500 text-xs m-0 mt-1">Preguntas</p>
              </div>
            </div>
          </div>

          <!-- Botón de acción -->
          <p-button label="Generar análisis con IA" icon="pi pi-sparkles" iconPos="right"
                    severity="help" styleClass="w-full"
                    (onClick)="seleccionarMetodoCreacion('ia'); continuarWizard()" />
        </div>
      </div>

      <!-- Opción Manual -->
      <div class="col-12 md:col-6">
        <div class="wizard-method-card h-full border-round-xl p-4 cursor-pointer transition-all"
             [class]="metodoCreacion() === 'manual' ? 'wizard-method-selected' : 'surface-card shadow-1 hover:shadow-3'"
             style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);"
             (click)="seleccionarMetodoCreacion('manual')">
          <!-- Icono decorativo -->
          <div class="flex justify-content-center mb-4">
            <div class="wizard-method-icon flex align-items-center justify-content-center border-circle bg-blue-100"
                 style="width: 80px; height: 80px;">
              <span class="material-icons text-blue-500" style="font-size: 2.5rem;">edit_note</span>
            </div>
          </div>

          <!-- Título y descripción -->
          <div class="text-center mb-4">
            <h3 class="text-xl font-bold text-900 m-0 mb-2">Manual</h3>
            <p class="text-500 text-sm m-0 line-height-3">Diseña tu cuestionario desde cero agregando secciones y preguntas</p>
          </div>

          <!-- Stats cards -->
          <div class="flex gap-2 mb-4">
            <div class="flex-1 surface-card border-round-lg p-3 shadow-1">
              <div class="text-center">
                <span class="text-xl font-bold text-900">100%</span>
                <p class="text-500 text-xs m-0 mt-1">Control</p>
              </div>
            </div>
            <div class="flex-1 surface-card border-round-lg p-3 shadow-1">
              <div class="text-center">
                <span class="text-xl font-bold text-900">10 tipos</span>
                <p class="text-500 text-xs m-0 mt-1">de preguntas</p>
              </div>
            </div>
          </div>

          <!-- Botón de acción -->
          <p-button label="Crear respuesta manual" icon="pi pi-pencil" iconPos="right"
                    severity="contrast" styleClass="w-full"
                    (onClick)="seleccionarMetodoCreacion('manual'); continuarWizard()" />
        </div>
      </div>
    </div>
    }

    <!-- Paso 1: Datos Generales -->
    @if (wizardPaso() === 1) {
    <div class="surface-card border-round-xl p-4 shadow-1">
      <div class="flex align-items-center gap-3 mb-4">
        <div class="flex align-items-center justify-content-center border-circle bg-blue-100" style="width: 48px; height: 48px;">
          <span class="material-icons text-blue-500">description</span>
        </div>
        <div>
          <h3 class="text-lg font-semibold text-900 m-0">Datos Generales</h3>
          <p class="text-500 text-sm m-0">Información básica del cuestionario</p>
        </div>
      </div>

      <div class="grid">
        <div class="col-12">
          <label class="block font-medium mb-2 text-900">Nombre del cuestionario *</label>
          <input pInputText [ngModel]="wizardDatosGenerales().nombre"
                 (ngModelChange)="actualizarDatosGenerales('nombre', $event)"
                 class="w-full" placeholder="Ej: Evaluación de Controles ISO 27001" />
        </div>
        <div class="col-12">
          <label class="block font-medium mb-2 text-900">Descripción</label>
          <textarea pTextarea [ngModel]="wizardDatosGenerales().descripcion"
                    (ngModelChange)="actualizarDatosGenerales('descripcion', $event)"
                    class="w-full" rows="3" placeholder="Descripción breve del cuestionario..."></textarea>
        </div>
        <div class="col-12 md:col-6">
          <label class="block font-medium mb-2 text-900">Marco Normativo</label>
          <p-select [options]="marcosNormativos()" optionLabel="acronimo" optionValue="id"
                    [ngModel]="wizardDatosGenerales().marcoNormativo"
                    (ngModelChange)="actualizarDatosGenerales('marcoNormativo', $event)"
                    placeholder="Seleccionar marco" styleClass="w-full" [showClear]="true" />
        </div>
        <div class="col-12 md:col-6">
          <label class="block font-medium mb-2 text-900">Tipo de Evaluación</label>
          <p-select [options]="tipoEvaluacionOptions" optionLabel="label" optionValue="value"
                    [ngModel]="wizardDatosGenerales().tipoEvaluacion"
                    (ngModelChange)="actualizarDatosGenerales('tipoEvaluacion', $event)"
                    styleClass="w-full" />
        </div>
      </div>

      <!-- Botones de navegación -->
      <div class="flex justify-content-between mt-4 pt-4 border-top-1 surface-border">
        <p-button label="Anterior" icon="pi pi-arrow-left" severity="secondary" [outlined]="true" (onClick)="volverPasoWizard()" />
        <p-button label="Continuar" icon="pi pi-arrow-right" iconPos="right" (onClick)="continuarWizard()" [disabled]="!puedeAvanzarWizard()" />
      </div>
    </div>
    }

    <!-- Paso 2: Umbrales -->
    @if (wizardPaso() === 2) {
    <div class="surface-card border-round-xl p-4 shadow-1">
      <!-- Header con título -->
      <div class="flex align-items-center gap-3 mb-4">
        <div class="flex align-items-center justify-content-center border-circle bg-orange-100" style="width: 48px; height: 48px;">
          <span class="material-icons text-orange-500">tune</span>
        </div>
        <div>
          <h3 class="text-lg font-semibold text-900 m-0">Definición de Umbrales</h3>
          <p class="text-500 text-sm m-0">Configura los niveles de cumplimiento</p>
        </div>
      </div>

      <!-- Vista previa de progreso (como en Figma) -->
      <div class="surface-card border-round-lg p-4 mb-4">
        <div class="flex justify-content-between align-items-center mb-3">
          <span class="text-2xl font-semibold text-900">85.7%</span>
          <span class="text-500 text-sm">8571 / 10000</span>
        </div>
        <div class="flex w-full border-round overflow-hidden" style="height: 10px; background: linear-gradient(to right, var(--red-500) 0%, var(--red-500) 50%, var(--orange-500) 50%, var(--orange-500) 70%, var(--green-500) 70%, var(--green-500) 100%);">
        </div>
      </div>

      <!-- Cards de umbrales con sliders (diseño Figma) -->
      <div class="flex flex-column gap-3">
        <!-- Deficiente -->
        <div class="surface-card border-round-lg border-1 surface-border flex overflow-hidden">
          <div class="bg-red-500" style="width: 4px;"></div>
          <div class="flex-1 p-3">
            <div class="flex align-items-center justify-content-between">
              <div class="flex-1">
                <span class="font-medium text-900 block mb-1">Deficiente</span>
                <span class="text-500 text-sm block mb-3">Hasta (%)</span>
                <div class="flex align-items-center gap-3">
                  <p-inputNumber [ngModel]="wizardUmbrales().deficiente"
                                 (ngModelChange)="actualizarUmbrales('deficiente', $event)"
                                 [min]="0" [max]="100" styleClass="w-5rem" [showButtons]="false" />
                  <p-slider [ngModel]="wizardUmbrales().deficiente"
                            (ngModelChange)="actualizarUmbrales('deficiente', $event)"
                            [min]="0" [max]="100" styleClass="flex-1" />
                </div>
              </div>
              <div class="text-right ml-4">
                <span class="text-900 font-bold">0% - {{ wizardUmbrales().deficiente }}%</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Aceptable -->
        <div class="surface-card border-round-lg border-1 surface-border flex overflow-hidden">
          <div class="bg-orange-500" style="width: 4px;"></div>
          <div class="flex-1 p-3">
            <div class="flex align-items-center justify-content-between">
              <div class="flex-1">
                <span class="font-medium text-900 block mb-1">Aceptable</span>
                <span class="text-500 text-sm block mb-3">Hasta (%)</span>
                <div class="flex align-items-center gap-3">
                  <p-inputNumber [ngModel]="wizardUmbrales().aceptable"
                                 (ngModelChange)="actualizarUmbrales('aceptable', $event)"
                                 [min]="0" [max]="100" styleClass="w-5rem" [showButtons]="false" />
                  <p-slider [ngModel]="wizardUmbrales().aceptable"
                            (ngModelChange)="actualizarUmbrales('aceptable', $event)"
                            [min]="0" [max]="100" styleClass="flex-1" />
                </div>
              </div>
              <div class="text-right ml-4">
                <span class="text-900 font-bold">{{ wizardUmbrales().deficiente }}% - {{ wizardUmbrales().aceptable }}%</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Sobresaliente -->
        <div class="surface-card border-round-lg border-1 surface-border flex overflow-hidden">
          <div class="bg-green-500" style="width: 4px;"></div>
          <div class="flex-1 p-3">
            <div class="flex align-items-center justify-content-between">
              <div class="flex-1">
                <span class="font-medium text-900 block mb-1">Sobresaliente</span>
                <span class="text-500 text-sm block mb-3">Desde (%)</span>
                <div class="flex align-items-center gap-3">
                  <p-inputNumber [ngModel]="wizardUmbrales().sobresaliente"
                                 (ngModelChange)="actualizarUmbrales('sobresaliente', $event)"
                                 [min]="0" [max]="100" styleClass="w-5rem" [showButtons]="false" />
                  <p-slider [ngModel]="wizardUmbrales().sobresaliente"
                            (ngModelChange)="actualizarUmbrales('sobresaliente', $event)"
                            [min]="0" [max]="100" styleClass="flex-1" />
                </div>
              </div>
              <div class="text-right ml-4">
                <span class="text-900 font-bold">{{ wizardUmbrales().aceptable }}% - 100%</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Botones de navegación -->
      <div class="flex justify-content-between mt-4 pt-4 border-top-1 surface-border">
        <p-button label="Anterior" icon="pi pi-arrow-left" severity="secondary" [outlined]="true" (onClick)="volverPasoWizard()" />
        <div class="flex gap-2">
          @if (metodoCreacion() === 'manual') {
            <p-button label="Crear cuestionario" icon="pi pi-check" (onClick)="continuarWizard()" />
          } @else {
            <p-button label="Continuar a IA" icon="pi pi-sparkles" iconPos="right" severity="help" (onClick)="continuarWizard()" />
          }
        </div>
      </div>
    </div>
    }

    <!-- Paso 3: Configuración IA (solo si eligió IA) -->
    @if (wizardPaso() === 3 && metodoCreacion() === 'ia') {
    <div class="surface-card border-round-xl p-4 shadow-1">
      <div class="flex align-items-center gap-3 mb-4">
        <div class="flex align-items-center justify-content-center border-circle bg-purple-100" style="width: 48px; height: 48px;">
          <span class="material-icons text-purple-500">psychology</span>
        </div>
        <div>
          <h3 class="text-lg font-semibold text-900 m-0">Generación con IA</h3>
          <p class="text-500 text-sm m-0">Elige cómo generar las preguntas</p>
        </div>
      </div>

      <!-- Selector de método IA -->
      <div class="flex gap-3 mb-4">
        <div class="flex-1 p-3 border-round-lg cursor-pointer transition-all"
             [class]="wizardIAMetodo() === 'prompt' ? 'border-2 border-purple-500 bg-purple-50' : 'border-1 surface-border'"
             (click)="wizardIAMetodo.set('prompt')">
          <div class="flex align-items-center gap-2">
            <span class="material-icons text-purple-500">chat</span>
            <span class="font-medium" [class]="wizardIAMetodo() === 'prompt' ? 'text-purple-700' : 'text-700'">Describir con texto</span>
          </div>
        </div>
        <div class="flex-1 p-3 border-round-lg cursor-pointer transition-all"
             [class]="wizardIAMetodo() === 'documento' ? 'border-2 border-purple-500 bg-purple-50' : 'border-1 surface-border'"
             (click)="wizardIAMetodo.set('documento')">
          <div class="flex align-items-center gap-2">
            <span class="material-icons text-purple-500">upload_file</span>
            <span class="font-medium" [class]="wizardIAMetodo() === 'documento' ? 'text-purple-700' : 'text-700'">Subir documento</span>
          </div>
        </div>
      </div>

      <!-- Opción: Prompt -->
      @if (wizardIAMetodo() === 'prompt') {
        <div class="mb-4">
          <label class="block font-medium mb-2 text-900">Describe las preguntas que necesitas</label>
          <textarea pTextarea [(ngModel)]="promptIA" class="w-full" rows="4"
                    placeholder="Ej: Genera 15 preguntas para evaluar el control de accesos según ISO 27001, incluyendo preguntas sobre gestión de contraseñas, autenticación y revisión de permisos..."></textarea>
        </div>
        <div>
          <label class="block text-500 text-sm mb-2">Sugerencias</label>
          <div class="flex flex-wrap gap-2">
            <p-chip label="ISO 27001" styleClass="cursor-pointer" (click)="promptIA.set(promptIA() + ' ISO 27001')" />
            <p-chip label="SOX" styleClass="cursor-pointer" (click)="promptIA.set(promptIA() + ' SOX')" />
            <p-chip label="GDPR" styleClass="cursor-pointer" (click)="promptIA.set(promptIA() + ' GDPR')" />
            <p-chip label="15 preguntas" styleClass="cursor-pointer" (click)="promptIA.set(promptIA() + ' 15 preguntas')" />
          </div>
        </div>
      }

      <!-- Opción: Documento -->
      @if (wizardIAMetodo() === 'documento') {
        <div>
          <label class="block font-medium mb-2 text-900">Sube un documento normativo o de referencia</label>
          <p class="text-500 text-sm mb-3 m-0">La IA analizará el documento y generará preguntas basadas en su contenido.</p>

          @if (!wizardDocumento()) {
            <div class="upload-zone p-4 border-2 border-dashed border-round-lg text-center cursor-pointer transition-all"
                 style="border-color: var(--surface-300);"
                 (click)="fileInputDocumentoWizard.click()">
              <input #fileInputDocumentoWizard type="file" accept=".pdf,.doc,.docx,.txt"
                     style="display: none" (change)="onFileInputChange($event)">
              <span class="material-icons text-4xl text-purple-300 mb-3">cloud_upload</span>
              <p class="m-0 mb-2 font-medium text-700">Arrastra un documento aquí</p>
              <p class="m-0 text-500 text-sm">o haz clic para seleccionar</p>
              <p class="m-0 text-400 text-xs mt-2">PDF, Word, TXT (máx. 10MB)</p>
            </div>
          } @else {
            <div class="flex align-items-center gap-3 p-3 surface-100 border-round">
              <span class="material-icons text-2xl text-red-500">picture_as_pdf</span>
              <div class="flex-1">
                <p class="m-0 font-medium text-900">{{ wizardDocumento()?.name }}</p>
                <p class="m-0 text-500 text-sm">{{ (wizardDocumento()?.size || 0) / 1024 | number:'1.0-0' }} KB</p>
              </div>
              <p-button icon="pi pi-times" severity="danger" [rounded]="true" [text]="true" (onClick)="limpiarDocumentoIA()" />
            </div>
          }
        </div>
      }

      <!-- Botones de navegación -->
      <div class="flex justify-content-between mt-4 pt-4 border-top-1 surface-border">
        <p-button label="Anterior" icon="pi pi-arrow-left" severity="secondary" [outlined]="true" (onClick)="volverPasoWizard()" />
        <p-button label="Generar con IA" icon="pi pi-sparkles" severity="help" [loading]="generandoIA()" (onClick)="generarConIAWizard()" />
      </div>
    </div>
    }

    <!-- Paso 4: Preview del cuestionario generado (IA) -->
    @if (wizardPaso() === 4 && wizardPreviewCuestionario()) {
    <div class="surface-card border-round-xl p-4 shadow-1">
      <div class="flex align-items-center gap-3 mb-4">
        <div class="flex align-items-center justify-content-center border-circle bg-green-100" style="width: 48px; height: 48px;">
          <span class="material-icons text-green-500">check_circle</span>
        </div>
        <div>
          <h3 class="text-lg font-semibold text-900 m-0">Cuestionario Generado</h3>
          <p class="text-500 text-sm m-0">Revisa el resultado antes de continuar</p>
        </div>
      </div>

      <!-- Resumen general -->
      <div class="p-3 surface-100 border-round mb-4">
        <div class="flex align-items-center justify-content-between mb-3">
          <h5 class="m-0 text-900">{{ wizardPreviewCuestionario()?.nombre }}</h5>
          <p-tag severity="info" [value]="(wizardPreviewCuestionario()?.marcoNormativo || '') | uppercase" />
        </div>
        <p class="text-500 text-sm m-0 mb-3">{{ wizardPreviewCuestionario()?.descripcion }}</p>
        <div class="flex gap-4">
          <div class="flex align-items-center gap-2">
            <span class="material-icons text-500" style="font-size: 1.25rem;">list</span>
            <span class="text-sm text-700">{{ wizardPreviewCuestionario()?.secciones?.length || 0 }} secciones</span>
          </div>
          <div class="flex align-items-center gap-2">
            <span class="material-icons text-500" style="font-size: 1.25rem;">help_outline</span>
            <span class="text-sm text-700">{{ wizardPreviewCuestionario()?.preguntas || 0 }} preguntas</span>
          </div>
        </div>
      </div>

      <!-- Vista previa de secciones -->
      <div class="flex flex-column gap-3" style="max-height: 350px; overflow-y: auto;">
        @for (seccion of wizardPreviewCuestionario()?.secciones || []; track seccion.id; let i = $index) {
          <div class="p-3 border-1 surface-border border-round">
            <div class="flex align-items-center justify-content-between mb-2">
              <div class="flex align-items-center gap-2">
                <span class="flex align-items-center justify-content-center border-circle bg-primary text-white text-xs font-bold" style="width: 24px; height: 24px;">{{ i + 1 }}</span>
                <span class="font-medium text-900">{{ seccion.nombre }}</span>
              </div>
              <span class="text-xs text-500">Peso: {{ seccion.peso }}%</span>
            </div>
            <p class="text-500 text-sm m-0 mb-2">{{ seccion.descripcion }}</p>
            <div class="flex flex-column gap-2">
              @for (pregunta of seccion.preguntas; track pregunta.id; let j = $index) {
                <div class="flex align-items-start gap-2 p-2 surface-50 border-round">
                  <span class="text-xs text-500 font-medium" style="min-width: 1.5rem">{{ j + 1 }}.</span>
                  <div class="flex-1">
                    <p class="m-0 text-sm text-700">{{ pregunta.texto }}</p>
                    <div class="flex align-items-center gap-2 mt-1">
                      <p-tag [severity]="pregunta.tipo === 'siNoNa' ? 'success' : pregunta.tipo === 'escala' ? 'info' : 'secondary'"
                             [value]="getTipoPreguntaLabel(pregunta.tipo)" styleClass="text-xs" />
                      @if (pregunta.requerida) {
                        <span class="text-xs text-red-500">Requerida</span>
                      }
                      @if (tieneLogicaCondicional(pregunta)) {
                        <span class="flex align-items-center gap-1 text-xs text-blue-500">
                          <i class="pi pi-sitemap text-xs"></i>
                          Condicional
                        </span>
                      }
                    </div>
                  </div>
                </div>
              }
            </div>
          </div>
        }
      </div>

      <!-- Botones de navegación -->
      <div class="flex justify-content-between mt-4 pt-4 border-top-1 surface-border">
        <p-button label="Regenerar" icon="pi pi-refresh" severity="secondary" [outlined]="true" (onClick)="regenerarConIA()" />
        <p-button label="Editar cuestionario" icon="pi pi-pencil" (onClick)="irAEditorDesdePreview()" />
      </div>
    </div>
    }
  </div>
</div>
}

<!-- ==================== VISTA: DETALLE DEL CUESTIONARIO (Estilo Elementor) ==================== -->
@if (vistaActual() === 'detalle' && cuestionarioSeleccionado()) {
<div class="flex flex-column min-h-screen surface-ground">
  <!-- Header con título y acciones -->
  <div class="surface-card border-bottom-1 surface-border px-4 py-3">
    <div class="flex justify-content-between align-items-center">
      <div class="flex align-items-center gap-3">
        <p-button icon="pi pi-arrow-left" [rounded]="true" [text]="true" (onClick)="volverALista()" pTooltip="Volver a lista" />
        <div>
          <h1 class="text-xl font-bold text-900 m-0">{{ cuestionarioSeleccionado()!.nombre }}</h1>
          <p class="text-500 text-sm m-0 mt-1">Orca&#64;Securityby Design</p>
        </div>
      </div>
      <div class="flex align-items-center gap-2">
        <p-button icon="pi pi-pencil" label="Editar" [outlined]="true" severity="secondary" (onClick)="irAEditorDesdeDetalle()" />
      </div>
    </div>
  </div>

  <!-- Tabs de navegación -->
  <div class="surface-card border-bottom-1 surface-border px-4">
    <div class="flex gap-4">
      <button
        class="py-3 px-2 border-none bg-transparent cursor-pointer text-sm font-medium"
        [class.text-primary]="tabDetalleActivo() === 'componentes'"
        [class.border-bottom-2]="tabDetalleActivo() === 'componentes'"
        [class.border-primary]="tabDetalleActivo() === 'componentes'"
        [class.text-500]="tabDetalleActivo() !== 'componentes'"
        (click)="tabDetalleActivo.set('componentes')">
        Componentes
      </button>
      <button
        class="py-3 px-2 border-none bg-transparent cursor-pointer text-sm font-medium"
        [class.text-primary]="tabDetalleActivo() === 'informacion'"
        [class.border-bottom-2]="tabDetalleActivo() === 'informacion'"
        [class.border-primary]="tabDetalleActivo() === 'informacion'"
        [class.text-500]="tabDetalleActivo() !== 'informacion'"
        (click)="tabDetalleActivo.set('informacion')">
        Información General
      </button>
    </div>
  </div>

  <!-- Contenido principal con dos paneles -->
  <div class="flex flex-1 overflow-hidden">
    <!-- Panel izquierdo: Componentes o Información según tab activo -->
    <div class="w-20rem surface-card border-right-1 surface-border overflow-y-auto" style="min-width: 320px;">
      @if (tabDetalleActivo() === 'componentes') {
        <!-- Lista de secciones/componentes -->
        <div class="p-3">
          <div class="flex justify-content-between align-items-center mb-3">
            <span class="text-sm font-semibold text-700">Secciones</span>
            <span class="text-xs text-500">{{ cuestionarioSeleccionado()!.secciones?.length || 0 }} secciones</span>
          </div>
          <div class="flex flex-column gap-2">
            @for (seccion of cuestionarioSeleccionado()!.secciones; track seccion.id; let i = $index) {
              <div class="p-3 surface-100 border-round cursor-pointer hover:surface-200 transition-colors transition-duration-150"
                   [class.border-left-3]="seccionSeleccionadaIndex() === i"
                   [class.border-primary]="seccionSeleccionadaIndex() === i"
                   (click)="seccionSeleccionadaIndex.set(i)">
                <div class="flex align-items-center gap-2 mb-1">
                  <i class="pi pi-list text-primary text-sm"></i>
                  <span class="font-medium text-900 text-sm">{{ seccion.nombre }}</span>
                </div>
                <div class="flex align-items-center gap-2 text-xs text-500">
                  <span>{{ seccion.preguntas?.length || 0 }} preguntas</span>
                  <span class="text-red-500">Obligatorio</span>
                </div>
              </div>
            } @empty {
              <div class="text-center py-4">
                <i class="pi pi-folder-open text-3xl text-300 mb-2"></i>
                <p class="text-500 text-sm m-0">Sin secciones</p>
              </div>
            }
          </div>
        </div>
      } @else {
        <!-- Información General -->
        <div class="p-3">
          <div class="mb-4">
            <span class="text-xs text-500 block mb-1">Estado</span>
            <p-tag [value]="cuestionarioSeleccionado()!.estado | titlecase" [severity]="getEstadoSeverity(cuestionarioSeleccionado()!.estado)" />
          </div>

          <div class="mb-4">
            <span class="text-xs text-500 block mb-1">Descripción</span>
            <p class="text-900 text-sm m-0">{{ cuestionarioSeleccionado()!.descripcion || 'Sin descripción' }}</p>
          </div>

          <div class="mb-4">
            <span class="text-xs text-500 block mb-1">Marco Normativo</span>
            <p-tag [value]="getMarcoNombre(cuestionarioSeleccionado()!.marcoNormativo)" styleClass="text-xs" />
          </div>

          <div class="mb-4">
            <span class="text-xs text-500 block mb-1">Categoría</span>
            <span class="text-900 text-sm">{{ cuestionarioSeleccionado()!.categoria | titlecase }}</span>
          </div>

          <div class="mb-4">
            <span class="text-xs text-500 block mb-1">Tipo</span>
            <p-tag [value]="cuestionarioSeleccionado()!.tipo === 'ia' ? 'IA' : 'Manual'" [severity]="getTipoSeverity(cuestionarioSeleccionado()!.tipo)" styleClass="text-xs" />
          </div>

          <div class="mb-4">
            <span class="text-xs text-500 block mb-1">Responsable</span>
            <div class="flex align-items-center gap-2">
              <p-avatar icon="pi pi-user" styleClass="bg-primary" shape="circle" size="normal" />
              <span class="text-900 text-sm">Alice Johnson Smith</span>
            </div>
          </div>

          <div class="grid mb-4">
            <div class="col-6">
              <span class="text-xs text-500 block mb-1">Preguntas</span>
              <span class="text-900 font-semibold">{{ cuestionarioSeleccionado()!.preguntas }}</span>
            </div>
            <div class="col-6">
              <span class="text-xs text-500 block mb-1">Respuestas</span>
              <span class="text-900 font-semibold">{{ cuestionarioSeleccionado()!.respuestas }}</span>
            </div>
          </div>

          <div class="mb-4">
            <span class="text-xs text-500 block mb-1">Cumplimiento</span>
            <div class="flex align-items-center gap-2">
              <p-progressBar [value]="cuestionarioSeleccionado()!.tasaCompletado" [showValue]="false" styleClass="h-1rem flex-1" />
              <span class="text-sm font-bold">{{ cuestionarioSeleccionado()!.tasaCompletado }}%</span>
            </div>
          </div>

          <div class="mb-4">
            <span class="text-xs text-500 block mb-1">Fecha Creación</span>
            <span class="text-900 text-sm">{{ cuestionarioSeleccionado()!.fechaCreacion | date:'dd/MM/yyyy' }}</span>
          </div>

          <!-- Umbrales -->
          <div class="surface-100 border-round p-3">
            <span class="text-xs font-semibold text-700 block mb-2">Umbrales de Cumplimiento</span>
            <div class="flex flex-column gap-2">
              <div class="flex align-items-center gap-2">
                <span class="inline-block border-circle bg-green-500" style="width: 10px; height: 10px;"></span>
                <span class="text-600 text-xs flex-1">Sobresaliente</span>
                <span class="text-500 text-xs">{{ cuestionarioSeleccionado()!.umbrales.sobresaliente }}% - 100%</span>
              </div>
              <div class="flex align-items-center gap-2">
                <span class="inline-block border-circle bg-orange-500" style="width: 10px; height: 10px;"></span>
                <span class="text-600 text-xs flex-1">Aceptable</span>
                <span class="text-500 text-xs">{{ cuestionarioSeleccionado()!.umbrales.deficiente }}% - {{ cuestionarioSeleccionado()!.umbrales.aceptable }}%</span>
              </div>
              <div class="flex align-items-center gap-2">
                <span class="inline-block border-circle bg-red-500" style="width: 10px; height: 10px;"></span>
                <span class="text-600 text-xs flex-1">Deficiente</span>
                <span class="text-500 text-xs">0% - {{ cuestionarioSeleccionado()!.umbrales.deficiente }}%</span>
              </div>
            </div>
          </div>
        </div>
      }
    </div>

    <!-- Panel derecho: Preview del cuestionario -->
    <div class="flex-1 surface-100 overflow-y-auto p-4">
      <div class="surface-card border-round-lg shadow-1 mx-auto" style="max-width: 900px;">
        <!-- Header del preview -->
        <div class="p-4 border-bottom-1 surface-border">
          <div class="flex align-items-center justify-content-between">
            <h3 class="text-lg font-bold text-900 m-0">Vista Previa</h3>
            <div class="flex align-items-center gap-2">
              <p-button icon="pi pi-copy" [rounded]="true" [text]="true" severity="help" (onClick)="duplicarCuestionario(cuestionarioSeleccionado()!)" pTooltip="Duplicar" />
              <p-button icon="pi pi-trash" [rounded]="true" [text]="true" severity="danger" (onClick)="eliminarCuestionario(cuestionarioSeleccionado()!)" pTooltip="Eliminar" />
            </div>
          </div>
        </div>

        <!-- Contenido del preview -->
        <div class="p-4">
          @if (tabDetalleActivo() === 'componentes' && cuestionarioSeleccionado()!.secciones?.length) {
            <!-- Mostrar la sección seleccionada -->
            @let seccionActual = cuestionarioSeleccionado()!.secciones[seccionSeleccionadaIndex()];
            @if (seccionActual) {
              <div class="mb-4">
                <h4 class="text-lg font-semibold text-900 m-0 mb-2">{{ seccionActual.nombre }}</h4>
                <span class="text-red-500 text-sm">Obligatorio</span>
              </div>

              <!-- Grid de campos del formulario -->
              <div class="grid">
                @for (pregunta of seccionActual.preguntas; track pregunta.id; let j = $index) {
                  <div class="col-12 md:col-6 mb-4">
                    <label class="block text-700 text-sm font-medium mb-2">
                      {{ pregunta.texto }}
                      @if (pregunta.requerida) {
                        <span class="text-red-500">*</span>
                      }
                    </label>

                    <!-- Campo según tipo -->
                    @switch (pregunta.tipo) {
                      @case ('texto') {
                        <input pInputText class="w-full" [placeholder]="pregunta.placeholder || 'Escribe aquí...'" disabled />
                      }
                      @case ('textoLargo') {
                        <textarea pTextarea class="w-full" rows="3" placeholder="Escribe aquí..." disabled></textarea>
                      }
                      @case ('numero') {
                        <p-inputNumber styleClass="w-full" placeholder="0" [disabled]="true" />
                      }
                      @case ('siNoNa') {
                        <div class="flex gap-4">
                          <div class="flex align-items-center gap-2">
                            <p-radioButton [disabled]="true" />
                            <span class="text-sm">Sí</span>
                          </div>
                          <div class="flex align-items-center gap-2">
                            <p-radioButton [disabled]="true" />
                            <span class="text-sm">No</span>
                          </div>
                          <div class="flex align-items-center gap-2">
                            <p-radioButton [disabled]="true" />
                            <span class="text-sm">N/A</span>
                          </div>
                        </div>
                      }
                      @case ('fecha') {
                        <p-datePicker styleClass="w-full" [disabled]="true" placeholder="dd/mm/aaaa" />
                      }
                      @case ('seleccionUnica') {
                        <p-select [options]="pregunta.opciones || [{label: 'Seleccionar', value: ''}]" styleClass="w-full" [disabled]="true" placeholder="Seleccionar" />
                      }
                      @case ('opcionMultiple') {
                        <p-multiSelect [options]="pregunta.opciones || []" styleClass="w-full" [disabled]="true" placeholder="Seleccionar" />
                      }
                      @case ('escala') {
                        <div class="flex align-items-center gap-2">
                          <span class="text-xs text-500">{{ pregunta.escalaMin || 1 }}</span>
                          <p-slider [min]="pregunta.escalaMin || 1" [max]="pregunta.escalaMax || 10" styleClass="flex-1" [disabled]="true" />
                          <span class="text-xs text-500">{{ pregunta.escalaMax || 10 }}</span>
                        </div>
                      }
                      @case ('archivo') {
                        <div class="p-3 border-1 border-dashed surface-border border-round text-center">
                          <i class="pi pi-upload text-400 text-xl"></i>
                          <p class="text-500 text-sm m-0 mt-2">Subir archivo</p>
                        </div>
                      }
                      @case ('starRating') {
                        <p-rating [stars]="pregunta.maxStars || 5" [disabled]="true" />
                      }
                      @case ('likertScale') {
                        <div class="flex gap-3 flex-wrap">
                          @for (label of (pregunta.likertLabels || ['Muy en desacuerdo', 'En desacuerdo', 'Neutral', 'De acuerdo', 'Muy de acuerdo']); track label) {
                            <div class="flex flex-column align-items-center gap-1">
                              <p-radioButton [disabled]="true" />
                              <span class="text-xs text-500 text-center" style="max-width: 70px;">{{ label }}</span>
                            </div>
                          }
                        </div>
                      }
                      @case ('semanticDiff') {
                        <div class="flex align-items-center gap-3">
                          <span class="text-sm text-700">{{ pregunta.leftAnchor || 'Muy malo' }}</span>
                          <div class="flex gap-2 flex-1 justify-content-center">
                            @for (idx of [1,2,3,4,5,6,7]; track idx) {
                              <p-radioButton [disabled]="true" />
                            }
                          </div>
                          <span class="text-sm text-700">{{ pregunta.rightAnchor || 'Excelente' }}</span>
                        </div>
                      }
                      @case ('ranking') {
                        <div class="flex flex-column gap-2">
                          @for (opcion of (pregunta.opciones || ['Opción 1', 'Opción 2', 'Opción 3']); track opcion; let idx = $index) {
                            <div class="flex align-items-center gap-2 p-2 surface-100 border-round">
                              <i class="pi pi-bars text-400 cursor-move"></i>
                              <span class="text-sm">{{ idx + 1 }}. {{ opcion }}</span>
                            </div>
                          }
                        </div>
                      }
                      @case ('boolean') {
                        <div class="flex gap-4">
                          <div class="flex align-items-center gap-2">
                            <p-radioButton [disabled]="true" />
                            <span class="text-sm">Verdadero</span>
                          </div>
                          <div class="flex align-items-center gap-2">
                            <p-radioButton [disabled]="true" />
                            <span class="text-sm">Falso</span>
                          </div>
                        </div>
                      }
                      @default {
                        <input pInputText class="w-full" placeholder="Campo" disabled />
                      }
                    }
                  </div>
                }
              </div>

              @if (seccionActual.preguntas?.length) {
                <div class="flex align-items-center gap-2 mt-3 pt-3 border-top-1 surface-border">
                  <p-checkbox [binary]="true" [disabled]="true" />
                  <span class="text-sm text-700">Solicitar Revisión</span>
                </div>
              }
            }
          } @else if (tabDetalleActivo() === 'informacion') {
            <!-- Vista de información general en el preview -->
            <div class="text-center py-6">
              <i class="pi pi-info-circle text-5xl text-primary mb-3"></i>
              <h4 class="text-900 font-semibold m-0 mb-2">Información General</h4>
              <p class="text-500 m-0">Selecciona "Componentes" para ver el preview de las secciones</p>
            </div>
          } @else {
            <!-- Sin secciones -->
            <div class="flex flex-column align-items-center justify-content-center py-8">
              <div class="flex align-items-center justify-content-center bg-primary-100 border-circle mb-4" style="width: 80px; height: 80px;">
                <i class="pi pi-folder-open text-4xl text-primary"></i>
              </div>
              <h4 class="text-900 font-semibold m-0 mb-2">Sin secciones</h4>
              <p class="text-500 m-0 mb-4 text-center">Este cuestionario aún no tiene secciones definidas</p>
              <p-button label="Agregar secciones en el editor" icon="pi pi-pencil" (onClick)="irAEditorDesdeDetalle()" />
            </div>
          }
        </div>
      </div>
    </div>
  </div>
</div>
}

<!-- ==================== VISTA: EDITOR DE CUESTIONARIO ==================== -->
@if (vistaActual() === 'editor' && cuestionarioSeleccionado()) {
<div class="flex flex-column min-h-screen surface-ground">
  <!-- Header del editor con acciones -->
  <div class="surface-card border-bottom-1 surface-border px-4 py-2">
    <div class="flex justify-content-between align-items-center">
      <div class="flex align-items-center gap-3">
        <p-button icon="pi pi-arrow-left" [rounded]="true" [text]="true" (onClick)="volverALista()" pTooltip="Volver a lista" />
        <p-button icon="pi pi-eye" [rounded]="true" [text]="true" pTooltip="Vista previa" />
      </div>
      <div class="flex align-items-center gap-3">
        <span class="text-sm text-500">
          <i class="pi pi-search mr-1"></i> Buscar
        </span>
      </div>
      <div class="flex gap-2">
        <p-button label="Guardar" icon="pi pi-save" (onClick)="guardarCuestionarioEditor()" />
        <p-button icon="pi pi-ellipsis-v" [rounded]="true" [text]="true" />
      </div>
    </div>
  </div>

  <!-- Layout de 3 paneles -->
  <div class="flex flex-1 overflow-hidden">
    <!-- Panel Izquierdo: Elementos/Tipos de campo -->
    <div class="w-18rem surface-card border-right-1 surface-border overflow-y-auto p-3" style="min-height: calc(100vh - 52px)">
      <h3 class="text-sm font-semibold text-900 mb-3">Elementos de Cuestionario</h3>

      <!-- Basicos -->
      <div class="mb-4">
        <span class="text-xs font-semibold text-primary uppercase">Basicos</span>
        <div class="flex flex-column gap-1 mt-2">
          <div class="flex align-items-center justify-content-between p-2 border-round hover:surface-100 cursor-pointer"
               pDraggable="pregunta" (onDragStart)="iniciarArrastre('grupo')">
            <div class="flex align-items-center gap-2">
              <i class="pi pi-circle text-500"></i>
              <div>
                <span class="text-sm font-medium">Group</span>
                <p class="text-xs text-500 m-0">The elements below are grouped</p>
              </div>
            </div>
            <i class="pi pi-plus text-primary"></i>
          </div>
          <div class="flex align-items-center justify-content-between p-2 border-round hover:surface-100 cursor-pointer"
               pDraggable="pregunta" (onDragStart)="iniciarArrastre('texto')">
            <div class="flex align-items-center gap-2">
              <i class="pi pi-pencil text-500"></i>
              <div>
                <span class="text-sm font-medium">Text Input</span>
                <p class="text-xs text-500 m-0">Single line text field</p>
              </div>
            </div>
            <i class="pi pi-plus text-primary"></i>
          </div>
          <div class="flex align-items-center justify-content-between p-2 border-round hover:surface-100 cursor-pointer"
               pDraggable="pregunta" (onDragStart)="iniciarArrastre('numero')">
            <div class="flex align-items-center gap-2">
              <i class="pi pi-hashtag text-purple-500"></i>
              <div>
                <span class="text-sm font-medium">Number</span>
                <p class="text-xs text-500 m-0">Numeric input with validation</p>
              </div>
            </div>
            <i class="pi pi-plus text-primary"></i>
          </div>
          <div class="flex align-items-center justify-content-between p-2 border-round hover:surface-100 cursor-pointer"
               pDraggable="pregunta" (onDragStart)="iniciarArrastre('textoLargo')">
            <div class="flex align-items-center gap-2">
              <i class="pi pi-align-left text-500"></i>
              <div>
                <span class="text-sm font-medium">Textarea</span>
                <p class="text-xs text-500 m-0">Multi-line text area</p>
              </div>
            </div>
            <i class="pi pi-plus text-primary"></i>
          </div>
          <div class="flex align-items-center justify-content-between p-2 border-round hover:surface-100 cursor-pointer"
               pDraggable="pregunta" (onDragStart)="iniciarArrastre('siNoNa')">
            <div class="flex align-items-center gap-2">
              <i class="pi pi-check-square text-500"></i>
              <div>
                <span class="text-sm font-medium">Checkbox</span>
                <p class="text-xs text-500 m-0">True/false toggle</p>
              </div>
            </div>
            <i class="pi pi-plus text-primary"></i>
          </div>
          <div class="flex align-items-center justify-content-between p-2 border-round hover:surface-100 cursor-pointer"
               pDraggable="pregunta" (onDragStart)="iniciarArrastre('fecha')">
            <div class="flex align-items-center gap-2">
              <i class="pi pi-calendar text-500"></i>
              <div>
                <span class="text-sm font-medium">Date Picker</span>
                <p class="text-xs text-500 m-0">Date selection field</p>
              </div>
            </div>
            <i class="pi pi-plus text-primary"></i>
          </div>
        </div>
      </div>

      <!-- Seleccion -->
      <div class="mb-4">
        <span class="text-xs font-semibold text-primary uppercase">Choice Fields</span>
        <div class="flex flex-column gap-1 mt-2">
          <div class="flex align-items-center justify-content-between p-2 border-round hover:surface-100 cursor-pointer"
               pDraggable="pregunta" (onDragStart)="iniciarArrastre('seleccionUnica')">
            <div class="flex align-items-center gap-2">
              <i class="pi pi-chevron-down text-500"></i>
              <div>
                <span class="text-sm font-medium">Dropdown</span>
                <p class="text-xs text-500 m-0">Single selection dropdown</p>
              </div>
            </div>
            <i class="pi pi-plus text-primary"></i>
          </div>
          <div class="flex align-items-center justify-content-between p-2 border-round hover:surface-100 cursor-pointer"
               pDraggable="pregunta" (onDragStart)="iniciarArrastre('opcionMultiple')">
            <div class="flex align-items-center gap-2">
              <i class="pi pi-list text-500"></i>
              <div>
                <span class="text-sm font-medium">Multi Select</span>
                <p class="text-xs text-500 m-0">Multiple choice selection</p>
              </div>
            </div>
            <i class="pi pi-plus text-primary"></i>
          </div>
          <div class="flex align-items-center justify-content-between p-2 border-round hover:surface-100 cursor-pointer"
               pDraggable="pregunta" (onDragStart)="iniciarArrastre('radioButtons')">
            <div class="flex align-items-center gap-2">
              <i class="pi pi-circle text-500"></i>
              <div>
                <span class="text-sm font-medium">Radio Buttons</span>
                <p class="text-xs text-500 m-0">Single choice options</p>
              </div>
            </div>
            <i class="pi pi-plus text-primary"></i>
          </div>
        </div>
      </div>

      <!-- Avanzados -->
      <div class="mb-4">
        <span class="text-xs font-semibold text-primary uppercase">Advanced</span>
        <div class="flex flex-column gap-1 mt-2">
          <div class="flex align-items-center justify-content-between p-2 border-round hover:surface-100 cursor-pointer"
               pDraggable="pregunta" (onDragStart)="iniciarArrastre('archivo')">
            <div class="flex align-items-center gap-2">
              <i class="pi pi-upload text-500"></i>
              <div>
                <span class="text-sm font-medium">File Upload</span>
                <p class="text-xs text-500 m-0">Document attachment</p>
              </div>
            </div>
            <i class="pi pi-plus text-primary"></i>
          </div>
          <div class="flex align-items-center justify-content-between p-2 border-round hover:surface-100 cursor-pointer"
               pDraggable="pregunta" (onDragStart)="iniciarArrastre('escala')">
            <div class="flex align-items-center gap-2">
              <i class="pi pi-sliders-h text-500"></i>
              <div>
                <span class="text-sm font-medium">Scale / Rating</span>
                <p class="text-xs text-500 m-0">Numeric scale (1-5, 1-10)</p>
              </div>
            </div>
            <i class="pi pi-plus text-primary"></i>
          </div>
          <div class="flex align-items-center justify-content-between p-2 border-round hover:surface-100 cursor-pointer"
               pDraggable="pregunta" (onDragStart)="iniciarArrastre('calculado')">
            <div class="flex align-items-center gap-2">
              <i class="pi pi-calculator text-500"></i>
              <div>
                <span class="text-sm font-medium">Calculated Field</span>
                <p class="text-xs text-500 m-0">Auto-calculated values</p>
              </div>
            </div>
            <i class="pi pi-plus text-primary"></i>
          </div>
          <div class="flex align-items-center justify-content-between p-2 border-round hover:surface-100 cursor-pointer"
               pDraggable="pregunta" (onDragStart)="iniciarArrastre('url')">
            <div class="flex align-items-center gap-2">
              <i class="pi pi-link text-500"></i>
              <div>
                <span class="text-sm font-medium">URL</span>
                <p class="text-xs text-500 m-0">Website link field</p>
              </div>
            </div>
            <i class="pi pi-plus text-primary"></i>
          </div>
          <div class="flex align-items-center justify-content-between p-2 border-round hover:surface-100 cursor-pointer"
               pDraggable="pregunta" (onDragStart)="iniciarArrastre('starRating')">
            <div class="flex align-items-center gap-2">
              <i class="pi pi-star text-yellow-500"></i>
              <div>
                <span class="text-sm font-medium">Star Rating</span>
                <p class="text-xs text-500 m-0">1-5 or 1-10 stars</p>
              </div>
            </div>
            <i class="pi pi-plus text-primary"></i>
          </div>
          <div class="flex align-items-center justify-content-between p-2 border-round hover:surface-100 cursor-pointer"
               pDraggable="pregunta" (onDragStart)="iniciarArrastre('likertScale')">
            <div class="flex align-items-center gap-2">
              <i class="pi pi-chart-bar text-blue-500"></i>
              <div>
                <span class="text-sm font-medium">Likert Scale</span>
                <p class="text-xs text-500 m-0">Agreement scale (5 options)</p>
              </div>
            </div>
            <i class="pi pi-plus text-primary"></i>
          </div>
          <div class="flex align-items-center justify-content-between p-2 border-round hover:surface-100 cursor-pointer"
               pDraggable="pregunta" (onDragStart)="iniciarArrastre('semanticDiff')">
            <div class="flex align-items-center gap-2">
              <i class="pi pi-arrows-h text-purple-500"></i>
              <div>
                <span class="text-sm font-medium">Semantic Differential</span>
                <p class="text-xs text-500 m-0">Scale between opposites</p>
              </div>
            </div>
            <i class="pi pi-plus text-primary"></i>
          </div>
          <div class="flex align-items-center justify-content-between p-2 border-round hover:surface-100 cursor-pointer"
               pDraggable="pregunta" (onDragStart)="iniciarArrastre('ranking')">
            <div class="flex align-items-center gap-2">
              <i class="pi pi-sort-amount-up text-teal-500"></i>
              <div>
                <span class="text-sm font-medium">Ranking</span>
                <p class="text-xs text-500 m-0">Order by preference</p>
              </div>
            </div>
            <i class="pi pi-plus text-primary"></i>
          </div>
          <div class="flex align-items-center justify-content-between p-2 border-round hover:surface-100 cursor-pointer"
               pDraggable="pregunta" (onDragStart)="iniciarArrastre('boolean')">
            <div class="flex align-items-center gap-2">
              <i class="pi pi-check-square text-green-500"></i>
              <div>
                <span class="text-sm font-medium">True/False</span>
                <p class="text-xs text-500 m-0">Boolean toggle</p>
              </div>
            </div>
            <i class="pi pi-plus text-primary"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Panel Central: Canvas del cuestionario -->
    <div class="flex-1 overflow-y-auto p-4" pDroppable="pregunta" (onDrop)="onDropPreguntaNuevaSeccion()">
      <!-- Header del cuestionario -->
      <div class="mb-4">
        <div class="flex align-items-center gap-2 mb-3">
          <span class="w-2rem h-2rem border-round bg-primary flex align-items-center justify-content-center text-white">
            <i class="pi pi-check"></i>
          </span>
        </div>
        <input pInputText [(ngModel)]="cuestionarioSeleccionado()!.nombre" class="w-full text-xl font-semibold border-none surface-ground mb-2" placeholder="Ingresa el nombre del cuestionario" />
        <input pInputText [(ngModel)]="cuestionarioSeleccionado()!.descripcion" class="w-full text-500 border-none surface-ground" placeholder="Ingresa una descripcion" />
      </div>

      <!-- Secciones y preguntas -->
      @for (seccion of cuestionarioSeleccionado()!.secciones; track seccion.id; let secIdx = $index) {
        <div class="mb-4 surface-card border-round border-1 surface-border p-3">
          <div class="flex align-items-center justify-content-between mb-3">
            <div class="flex align-items-center gap-2">
              <span class="font-semibold text-primary">Seccion {{ secIdx + 1 }}</span>
              <input pInputText [(ngModel)]="seccion.nombre" class="border-none font-medium" style="background: transparent" />
            </div>
            <p-button icon="pi pi-trash" [rounded]="true" [text]="true" severity="danger" size="small" (onClick)="eliminarSeccion(seccion.id)" />
          </div>

          <div class="flex flex-column gap-3" pDroppable="pregunta" (onDrop)="onDropPregunta(seccion.id)">
            @for (pregunta of seccion.preguntas; track pregunta.id; let pIdx = $index) {
              <div class="p-3 border-round surface-50 cursor-pointer" [class.border-primary]="preguntaSeleccionada()?.id === pregunta.id" [class.border-2]="preguntaSeleccionada()?.id === pregunta.id" (click)="seleccionarPregunta(pregunta)">
                <div class="flex align-items-start gap-3">
                  <i class="pi pi-bars text-400 cursor-move mt-1"></i>
                  <div class="flex-1">
                    <div class="flex align-items-center gap-2 mb-2">
                      <span class="text-xs font-semibold text-500 uppercase">{{ getTipoPreguntaLabel(pregunta.tipo) }}</span>
                      @if (tieneLogicaCondicional(pregunta)) {
                        <span class="flex align-items-center gap-1 text-xs text-blue-500" pTooltip="{{ getTextoCondicion(pregunta) }}" tooltipPosition="top">
                          <i class="pi pi-sitemap text-xs"></i>
                          Condicional
                        </span>
                      }
                      <i class="pi pi-trash text-400 hover:text-red-500 cursor-pointer ml-auto" (click)="eliminarPregunta(seccion.id, pIdx); $event.stopPropagation()"></i>
                    </div>
                    <p class="text-sm text-900 mb-2">{{ pregunta.texto || 'Sin texto de pregunta' }}</p>

                    <!-- Preview del campo segun tipo -->
                    @switch (pregunta.tipo) {
                      @case ('texto') {
                        <input pInputText class="w-full" [placeholder]="pregunta.placeholder || 'Escribe aqui...'" disabled />
                      }
                      @case ('textoLargo') {
                        <textarea pTextarea class="w-full" rows="2" [placeholder]="pregunta.placeholder || 'Placeholder'" disabled></textarea>
                      }
                      @case ('numero') {
                        <p-inputNumber styleClass="w-full" [placeholder]="'Monto'" disabled />
                      }
                      @case ('siNoNa') {
                        <p-checkbox [binary]="true" [disabled]="true" label="Se lleno Completo" />
                      }
                      @case ('fecha') {
                        <p-datePicker styleClass="w-full" [disabled]="true" placeholder="Seleccionar fecha" />
                      }
                      @case ('seleccionUnica') {
                        <p-select [options]="pregunta.opciones || []" styleClass="w-full" [disabled]="true" placeholder="Seleccionar opcion..." />
                      }
                    }
                  </div>
                </div>
              </div>
            }

            @if (seccion.preguntas.length === 0) {
              <div class="text-center py-4 border-round border-1 border-dashed surface-border">
                <i class="pi pi-inbox text-2xl text-300 mb-2"></i>
                <p class="text-500 m-0 text-sm">Arrastra elementos aqui</p>
              </div>
            }
          </div>

          <p-button label="Agregar pregunta" icon="pi pi-plus" severity="secondary" size="small" [text]="true" class="mt-3" (onClick)="agregarPreguntaSeccion(seccion.id, 'texto')" />
        </div>
      }

      @if (cuestionarioSeleccionado()!.secciones.length === 0) {
        <div class="flex flex-column align-items-center justify-content-center py-8 surface-card border-round border-1 surface-border border-dashed">
          <i class="pi pi-folder-open text-4xl text-300 mb-3"></i>
          <span class="text-500 mb-3">Arrastra elementos al canvas o crea una seccion</span>
          <p-button label="Crear primera seccion" icon="pi pi-plus" (onClick)="agregarSeccion()" />
        </div>
      }

      <p-button label="Agregar Seccion" icon="pi pi-plus" severity="secondary" [outlined]="true" class="mt-3" (onClick)="agregarSeccion()" />
    </div>

    <!-- Panel Derecho: Propiedades -->
    <div class="w-18rem surface-card border-left-1 surface-border overflow-y-auto p-3" style="min-height: calc(100vh - 52px)">
      <h3 class="text-sm font-semibold text-900 mb-3">Propiedades</h3>

      @if (preguntaSeleccionada()) {
        <p class="text-xs text-500 mb-3">Configure selectd element</p>

        <div class="flex flex-column gap-3">
          <div>
            <label class="block text-xs font-medium text-500 mb-1">Display Label</label>
            <input pInputText [(ngModel)]="preguntaSeleccionada()!.texto" class="w-full" />
          </div>

          <div>
            <label class="block text-xs font-medium text-500 mb-1">Machine Name</label>
            <input pInputText [(ngModel)]="preguntaSeleccionada()!.placeholder" class="w-full" [placeholder]="'Escribe el placeholder'" />
          </div>

          <div>
            <label class="block text-xs font-medium text-500 mb-1">Default Value (Optional)</label>
            <input pInputText class="w-full" placeholder="e.g.,Pending" />
          </div>

          <div>
            <label class="block text-xs font-medium text-500 mb-1">Numero de columnas</label>
            <p-select [options]="[{label: '1 columna', value: 1}, {label: '2 columnas', value: 2}]" optionLabel="label" optionValue="value" styleClass="w-full" />
          </div>

          <div class="flex gap-4">
            <div class="flex align-items-center gap-2">
              <p-radioButton [disabled]="true" />
              <span class="text-sm">Is Calculated?</span>
            </div>
            <div class="flex align-items-center gap-2">
              <p-radioButton [disabled]="true" />
              <span class="text-sm">Is Autoincrement ID?</span>
            </div>
          </div>

          <p-divider />

          <h4 class="text-xs font-semibold text-900 m-0">Validation Rules</h4>
          <div class="flex flex-wrap gap-3">
            <div class="flex align-items-center gap-2">
              <p-checkbox [(ngModel)]="preguntaSeleccionada()!.requerida" [binary]="true" />
              <span class="text-sm">Required Field</span>
            </div>
            <div class="flex align-items-center gap-2">
              <p-checkbox [binary]="true" />
              <span class="text-sm">Must be Unique</span>
            </div>
            <div class="flex align-items-center gap-2">
              <p-checkbox [binary]="true" />
              <span class="text-sm">Searchable</span>
            </div>
          </div>

          <p-divider />

          <h4 class="text-xs font-semibold text-900 m-0">Logica Condicional</h4>
          <div class="flex align-items-center justify-content-between">
            <span class="text-sm">Mostrar solo si se cumple condicion</span>
            <p-toggleSwitch [ngModel]="!!preguntaSeleccionada()!.displayConditionQuestionId"
                            (ngModelChange)="toggleLogicaCondicional($event)" />
          </div>

          @if (preguntaSeleccionada()!.displayConditionQuestionId || logicaCondicionalActiva()) {
            <div class="p-3 surface-100 border-round flex flex-column gap-2">
              <div>
                <label class="block text-xs font-medium text-500 mb-1">Mostrar si la pregunta:</label>
                <p-select [options]="getPreguntasDisponiblesParaCondicion()"
                          optionLabel="label" optionValue="value" styleClass="w-full"
                          [ngModel]="preguntaSeleccionada()!.displayConditionQuestionId"
                          (ngModelChange)="setCondicionPreguntaId($event)"
                          placeholder="Seleccionar pregunta" />
              </div>
              @if (preguntaSeleccionada()!.displayConditionQuestionId) {
                <div>
                  <label class="block text-xs font-medium text-500 mb-1">Es igual a:</label>
                  <p-select [options]="getOpcionesRespuestaCondicion()"
                            optionLabel="label" optionValue="value" styleClass="w-full"
                            [ngModel]="preguntaSeleccionada()!.displayConditionAnswer"
                            (ngModelChange)="setCondicionRespuesta($event)"
                            placeholder="Seleccionar respuesta" />
                </div>
              }
              @if (preguntaSeleccionada()!.displayConditionQuestionId && preguntaSeleccionada()!.displayConditionAnswer) {
                <div class="p-2 bg-blue-50 border-round text-xs text-blue-700">
                  <i class="pi pi-info-circle mr-1"></i>
                  Esta pregunta solo se mostrara cuando la condicion se cumpla
                </div>
              }
            </div>
          }
        </div>
      } @else {
        <!-- Sin seleccion - mostrar config general -->
        <p class="text-xs text-500 mb-3">Configuracion del cuestionario</p>

        <div class="flex flex-column gap-3">
          <div>
            <label class="block text-xs font-medium text-500 mb-1">Marco Normativo</label>
            <p-select [options]="marcosNormativos()" optionLabel="nombre" optionValue="id" [(ngModel)]="cuestionarioSeleccionado()!.marcoNormativo" styleClass="w-full" placeholder="Seleccionar marco" />
          </div>
          <div>
            <label class="block text-xs font-medium text-500 mb-1">Tipo de Evaluacion</label>
            <p-select [options]="tipoEvaluacionOptions" [(ngModel)]="cuestionarioSeleccionado()!.tipoEvaluacion" styleClass="w-full" />
          </div>

          <p-divider />

          <h4 class="text-xs font-semibold text-900 m-0">Umbrales de Evaluacion</h4>
          <div class="flex flex-column gap-2">
            <div class="flex align-items-center gap-2">
              <span class="w-1rem h-1rem border-round bg-red-500"></span>
              <span class="text-sm flex-1">Deficiente</span>
              <p-inputNumber [(ngModel)]="cuestionarioSeleccionado()!.umbrales.deficiente" [min]="0" [max]="100" styleClass="w-4rem" suffix="%" />
            </div>
            <div class="flex align-items-center gap-2">
              <span class="w-1rem h-1rem border-round bg-yellow-500"></span>
              <span class="text-sm flex-1">Aceptable</span>
              <p-inputNumber [(ngModel)]="cuestionarioSeleccionado()!.umbrales.aceptable" [min]="0" [max]="100" styleClass="w-4rem" suffix="%" />
            </div>
            <div class="flex align-items-center gap-2">
              <span class="w-1rem h-1rem border-round bg-green-500"></span>
              <span class="text-sm flex-1">Sobresaliente</span>
              <p-inputNumber [(ngModel)]="cuestionarioSeleccionado()!.umbrales.sobresaliente" [min]="0" [max]="100" styleClass="w-4rem" suffix="%" />
            </div>
          </div>

          <p-divider />

          <h4 class="text-xs font-semibold text-900 m-0">Importar desde documento</h4>
          <p class="text-xs text-500">Sube un documento y genera preguntas automaticamente</p>
          <p-fileUpload mode="basic" chooseLabel="Subir documento" accept=".pdf,.docx,.xlsx" [auto]="true" (onUpload)="onUploadDocumento($event)" styleClass="w-full" />
        </div>
      }
    </div>
  </div>
</div>
}

<!-- ==================== DIALOGS ==================== -->

<p-dialog header="Generar con IA" [(visible)]="showIADialog" [modal]="true" [style]="{width: '600px'}" [draggable]="false">
  <div class="flex flex-column gap-4">
    <div class="p-3 surface-100 border-round">
      <div class="flex align-items-center gap-2 mb-2"><i class="pi pi-sparkles text-purple-500"></i><span class="font-semibold">Asistente IA</span></div>
      <p class="text-500 m-0 text-sm">Describe el cuestionario y la IA generará las preguntas automáticamente.</p>
    </div>
    <div>
      <label class="block font-medium mb-2">Describe tu cuestionario</label>
      <textarea pTextarea [(ngModel)]="promptIA" class="w-full" rows="5" placeholder="Ej: Cuestionario de 20 preguntas para ISO 27001..."></textarea>
    </div>
    <div class="flex flex-wrap gap-2">
      <p-chip label="ISO 27001" styleClass="cursor-pointer" (click)="promptIA.set(promptIA() + ' ISO 27001')" />
      <p-chip label="SOX" styleClass="cursor-pointer" (click)="promptIA.set(promptIA() + ' SOX')" />
      <p-chip label="GDPR" styleClass="cursor-pointer" (click)="promptIA.set(promptIA() + ' GDPR')" />
      <p-chip label="PCI-DSS" styleClass="cursor-pointer" (click)="promptIA.set(promptIA() + ' PCI-DSS')" />
    </div>
  </div>
  <ng-template #footer>
    <p-button label="Cancelar" severity="secondary" [text]="true" (onClick)="showIADialog.set(false)" />
    <p-button label="Generar" icon="pi pi-sparkles" [loading]="generandoIA()" (onClick)="generarConIA()" />
  </ng-template>
</p-dialog>
