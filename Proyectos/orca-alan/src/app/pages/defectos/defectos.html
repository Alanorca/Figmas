<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<div class="page-container">
  <!-- Descripcion oculta para accesibilidad -->
  <span id="defectos-table-desc" class="sr-only">Tabla de defectos con opciones de filtrado, ordenamiento y acciones</span>

  <!-- Header -->
  <div class="page-header">
    <h1>Gestion de Defectos</h1>
    <p class="page-subtitle">Registra y da seguimiento a defectos y no conformidades</p>
  </div>

  <!-- Toolbar -->
  <p-toolbar>
    <ng-template pTemplate="start">
      <div class="flex align-items-center gap-3">
        @if (defectosSeleccionados().length > 0) {
          <p-button
            label="Acciones masivas"
            icon="pi pi-check-square"
            [badge]="defectosSeleccionados().length.toString()"
            badgeSeverity="contrast"
            severity="success"
            [outlined]="true"
            styleClass="btn-acciones-masivas"
            (onClick)="abrirAccionesMasivasDrawer()" />
        }
        <p-iconfield>
          <p-inputicon styleClass="pi pi-search" />
          <input type="text" pInputText
                 placeholder="Buscar defectos..."
                 aria-label="Buscar defectos por titulo, descripcion o estado"
                 style="width: 280px"
                 #dtFilter
                 (input)="dt.filterGlobal(dtFilter.value, 'contains')" />
        </p-iconfield>
      </div>
    </ng-template>
    <ng-template pTemplate="end">
      <p-button label="Registrar Defecto" icon="pi pi-plus" (onClick)="openNewDialog()"></p-button>
    </ng-template>
  </p-toolbar>

  <!-- Table Card -->
  <p-card styleClass="table-card">
    <p-table #dt
             [value]="defectos()"
             [paginator]="true"
             [rows]="10"
             [showCurrentPageReport]="true"
             currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} defectos"
             [globalFilterFields]="['id', 'title', 'description', 'eventStatus']"
             styleClass="p-datatable-striped"
             [selection]="defectosSeleccionados()"
             (selectionChange)="onSelectionChange($event)"
             dataKey="id"
             aria-describedby="defectos-table-desc">
      <ng-template pTemplate="header">
        <tr>
          <th scope="col" style="width: 3rem">
            <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
          </th>
          <th scope="col" pSortableColumn="title">Titulo <p-sortIcon field="title"></p-sortIcon></th>
          <th scope="col" pSortableColumn="description">Descripcion <p-sortIcon field="description"></p-sortIcon></th>
          <th scope="col" pSortableColumn="initialSeverity">Severidad <p-sortIcon field="initialSeverity"></p-sortIcon></th>
          <th scope="col" pSortableColumn="eventStatus">Estado <p-sortIcon field="eventStatus"></p-sortIcon></th>
          <th scope="col" pSortableColumn="initialDate">Fecha <p-sortIcon field="initialDate"></p-sortIcon></th>
          <th scope="col" style="width: 100px">Acciones</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-defecto>
        <tr [class.row-editing]="estaEditando(defecto.id)"
            class="cursor-pointer hover:surface-hover"
            tabindex="0"
            (click)="!estaEditando(defecto.id) && navigateToDetail(defecto)"
            (keydown.enter)="!estaEditando(defecto.id) && navigateToDetail(defecto)">
          <td (click)="$event.stopPropagation()">
            <p-tableCheckbox [value]="defecto"></p-tableCheckbox>
          </td>
          <!-- Titulo -->
          <td class="font-medium">
            @if (estaEditando(defecto.id)) {
              <input pInputText
                     [ngModel]="getValorEdicion('title')"
                     (ngModelChange)="setValorEdicion('title', $event)"
                     [attr.aria-label]="'Editar titulo del defecto ' + defecto.title"
                     class="w-full"
                     (click)="$event.stopPropagation()" />
            } @else {
              {{ defecto.title }}
            }
          </td>
          <!-- Descripcion -->
          <td>
            @if (estaEditando(defecto.id)) {
              <input pInputText
                     [ngModel]="getValorEdicion('description')"
                     (ngModelChange)="setValorEdicion('description', $event)"
                     [attr.aria-label]="'Editar descripcion del defecto ' + defecto.title"
                     class="w-full"
                     (click)="$event.stopPropagation()" />
            } @else {
              <span class="text-color-secondary">{{ defecto.description | slice:0:50 }}{{ defecto.description?.length > 50 ? '...' : '' }}</span>
            }
          </td>
          <!-- Severidad -->
          <td (click)="$event.stopPropagation()">
            @if (estaEditando(defecto.id)) {
              <p-select [options]="severityOptions"
                        [ngModel]="getValorEdicion('initialSeverity')"
                        (ngModelChange)="setValorEdicion('initialSeverity', $event)"
                        aria-label="Seleccionar severidad"
                        [style]="{width: '120px'}" />
            } @else {
              <p-tag [value]="getSeverityLabel(defecto.initialSeverity)" [severity]="getSeveritySeverity(defecto.initialSeverity)"></p-tag>
            }
          </td>
          <!-- Estado -->
          <td (click)="$event.stopPropagation()">
            @if (estaEditando(defecto.id)) {
              <p-select [options]="statusOptions"
                        [ngModel]="getValorEdicion('eventStatus')"
                        (ngModelChange)="setValorEdicion('eventStatus', $event)"
                        aria-label="Seleccionar estado"
                        [style]="{width: '100%'}" />
            } @else {
              <p-tag [value]="getEventStatusLabel(defecto.eventStatus)" [severity]="getEventStatusSeverity(defecto.eventStatus)"></p-tag>
            }
          </td>
          <!-- Fecha -->
          <td class="text-sm text-color-secondary">
            {{ formatDate(defecto.initialDate) }}
          </td>
          <!-- Acciones -->
          <td class="actions-cell" (click)="$event.stopPropagation()">
            @if (estaEditando(defecto.id)) {
              <div class="flex gap-1">
                <p-button icon="pi pi-check" severity="success" [text]="true" size="small"
                          pTooltip="Guardar" (onClick)="guardarEdicion(defecto, $event)" />
                <p-button icon="pi pi-times" severity="secondary" [text]="true" size="small"
                          pTooltip="Cancelar" (onClick)="cancelarEdicion($event)" />
              </div>
            } @else {
              <div class="flex justify-content-center">
                <p-menu #menuDefecto [model]="getMenuItemsDefecto(defecto)" [popup]="true" appendTo="body"></p-menu>
                <p-button icon="pi pi-ellipsis-v"
                          [text]="true"
                          size="small"
                          aria-haspopup="menu"
                          pTooltip="Opciones"
                          (onClick)="menuDefecto.toggle($event)" />
              </div>
            }
          </td>
        </tr>
      </ng-template>
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="7" class="text-center py-4">
            <span class="text-color-secondary">No hay defectos registrados</span>
          </td>
        </tr>
      </ng-template>

      <!-- Pie de tabla con totales por columna -->
      <ng-template pTemplate="footer">
        <tr class="font-semibold surface-ground">
          <td></td>
          <td>
            <span class="text-color">Totales</span>
          </td>
          <td>
            <span class="text-color-secondary">{{ defectos().length }} defectos</span>
          </td>
          <td>
            <div class="flex gap-1">
              <p-tag [value]="defectosCriticos().toString()" severity="danger" styleClass="text-xs" pTooltip="Criticos" />
              <p-tag [value]="defectosAltos().toString()" severity="warn" styleClass="text-xs" pTooltip="Altos" />
            </div>
          </td>
          <td>
            <div class="flex gap-1">
              <p-tag [value]="defectosAbiertos().toString()" severity="danger" styleClass="text-xs" pTooltip="Abiertos" />
              <p-tag [value]="defectosResueltos().toString()" severity="success" styleClass="text-xs" pTooltip="Resueltos" />
            </div>
          </td>
          <td></td>
          <td></td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>
</div>

<!-- Dialog Nuevo Defecto -->
<p-dialog header="Registrar Defecto" [modal]="true" [(visible)]="showDialog" [style]="{width: '550px'}">
  <div class="flex flex-column gap-4">
    <div class="flex flex-column gap-2">
      <label for="title" class="font-medium">Titulo *</label>
      <input pInputText id="title"
             [ngModel]="nuevoDefecto().title"
             (ngModelChange)="updateNuevoDefectoField('title', $event)"
             placeholder="Titulo del defecto" />
    </div>
    @if (subTypeOptions().length > 0) {
      <div class="flex flex-column gap-2">
        <label for="subtype" class="font-medium">Tipo de Defecto</label>
        <p-select id="subtype"
                  [options]="subTypeOptions()"
                  [ngModel]="nuevoDefecto().eventSubTypeId"
                  (ngModelChange)="updateNuevoDefectoField('eventSubTypeId', $event)"
                  placeholder="Seleccionar tipo"
                  [style]="{width: '100%'}"></p-select>
      </div>
    }
    <div class="flex flex-column gap-2">
      <label for="descripcion" class="font-medium">Descripcion del Defecto</label>
      <textarea pTextarea id="descripcion"
                [ngModel]="nuevoDefecto().description"
                (ngModelChange)="updateNuevoDefectoField('description', $event)"
                rows="3"
                placeholder="Describe el defecto en detalle"></textarea>
    </div>
    <div class="grid">
      <div class="col-12 md:col-6">
        <div class="flex flex-column gap-2">
          <label for="severidad" class="font-medium">Severidad</label>
          <p-select id="severidad"
                    [options]="severityOptions"
                    [ngModel]="nuevoDefecto().initialSeverity"
                    (ngModelChange)="updateNuevoDefectoField('initialSeverity', $event)"
                    [style]="{width: '100%'}"></p-select>
        </div>
      </div>
      <div class="col-12 md:col-6">
        <div class="flex flex-column gap-2">
          <label for="estado" class="font-medium">Estado</label>
          <p-select id="estado"
                    [options]="statusOptions"
                    [ngModel]="nuevoDefecto().eventStatus"
                    (ngModelChange)="updateNuevoDefectoField('eventStatus', $event)"
                    [style]="{width: '100%'}"></p-select>
        </div>
      </div>
    </div>
  </div>
  <ng-template pTemplate="footer">
    <p-button label="Cancelar" severity="secondary" [text]="true" (onClick)="showDialog.set(false)"></p-button>
    <p-button label="Registrar" icon="pi pi-check" severity="info" (onClick)="saveDefecto()"></p-button>
  </ng-template>
</p-dialog>

<!-- Drawer Acciones Masivas -->
<p-drawer [(visible)]="showAccionesMasivasDrawer" position="right" [style]="{width: '400px'}" header="Acciones Masivas">
  <div class="flex flex-column gap-4">
    <p class="text-color-secondary m-0">Aplicar cambios a {{ defectosSeleccionados().length }} defectos seleccionados</p>

    <!-- Severidad -->
    <div class="flex flex-column gap-2">
      <label for="masiva-severidad" class="font-medium">Severidad</label>
      <p-select id="masiva-severidad"
                [options]="severityOptions"
                placeholder="Sin cambios"
                [showClear]="true"
                [style]="{width: '100%'}" />
    </div>

    <!-- Estado -->
    <div class="flex flex-column gap-2">
      <label for="masiva-estado" class="font-medium">Estado</label>
      <p-select id="masiva-estado"
                [options]="statusOptions"
                placeholder="Sin cambios"
                [showClear]="true"
                [style]="{width: '100%'}" />
    </div>
  </div>

  <ng-template pTemplate="footer">
    <div class="flex gap-2 justify-content-end">
      <p-button label="Cancelar" severity="secondary" [text]="true"
                (onClick)="showAccionesMasivasDrawer.set(false)" />
      <p-button label="Aplicar cambios" icon="pi pi-check"
                (onClick)="aplicarAccionesMasivas()" />
    </div>
  </ng-template>
</p-drawer>
