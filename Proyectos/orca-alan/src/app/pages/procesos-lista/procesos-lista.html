<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<div class="procesos-lista-container">
  <!-- Header -->
  <div class="page-header">
    <div class="header-left">
      <h1>Procesos</h1>
      <span class="subtitle">Gestiona tus procesos de automatización</span>
    </div>
  </div>

  <!-- Toolbar -->
  <p-toolbar styleClass="mb-4">
    <ng-template pTemplate="start">
      <div class="flex align-items-center gap-3">
        <span class="p-input-icon-left">
          <i class="pi pi-search"></i>
          <input type="text" pInputText placeholder="Buscar procesos..."
                 (input)="dt.filterGlobal($any($event.target).value, 'contains')" style="width: 250px" />
        </span>
        <p-select
          [options]="estadoOptions"
          placeholder="Filtrar por estado"
          [showClear]="true"
          (onChange)="dt.filter($event.value, 'estado', 'equals')"
          [style]="{ width: '180px' }"
          appendTo="body">
        </p-select>
      </div>
    </ng-template>
    <ng-template pTemplate="end">
      <div class="flex gap-2">
        @if (procesosSeleccionados().length > 0) {
          <p-button
            label="Acciones masivas"
            icon="pi pi-check-square"
            [badge]="procesosSeleccionados().length.toString()"
            badgeSeverity="contrast"
            severity="success"
            [outlined]="true"
            styleClass="btn-acciones-masivas"
            (onClick)="abrirAccionesMasivasDrawer()" />
        }
        <p-button
          label="Cargar Demo"
          icon="pi pi-database"
          severity="secondary"
          [outlined]="true"
          pTooltip="Resetear procesos de demostración"
          tooltipPosition="bottom"
          (onClick)="resetDemoData()">
        </p-button>
        <p-button
          label="Nuevo Proceso"
          icon="pi pi-plus"
          (onClick)="crearProceso()">
        </p-button>
      </div>
    </ng-template>
  </p-toolbar>

  <!-- Table Card -->
  <p-card>
    <p-table
      #dt
      [value]="procesos()"
      [paginator]="true"
      [rows]="10"
      [rowsPerPageOptions]="[5, 10, 25, 50]"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} procesos"
      [globalFilterFields]="['nombre', 'descripcion', 'estado']"
      styleClass="p-datatable-sm p-datatable-striped"
      [tableStyle]="{ 'min-width': '70rem' }"
      [(selection)]="procesosSeleccionados"
      (selectionChange)="onSelectionChange($event)"
      dataKey="id">

      <!-- Header -->
      <ng-template pTemplate="header">
        <tr>
          <th style="width: 3rem">
            <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
          </th>
          <th style="width: 80px">ID</th>
          <th pSortableColumn="nombre">
            Nombre
            <p-sortIcon field="nombre"></p-sortIcon>
          </th>
          <th style="width: 120px" pSortableColumn="estado">
            Estado
            <p-sortIcon field="estado"></p-sortIcon>
          </th>
          <th style="width: 120px">Nodos</th>
          <th pSortableColumn="createdAt" style="width: 180px">
            Creado
            <p-sortIcon field="createdAt"></p-sortIcon>
          </th>
          <th pSortableColumn="updatedAt" style="width: 180px">
            Modificado
            <p-sortIcon field="updatedAt"></p-sortIcon>
          </th>
          <th style="width: 100px">Acciones</th>
        </tr>
      </ng-template>

      <!-- Body -->
      <ng-template pTemplate="body" let-proceso>
        <tr [class.row-editing]="estaEditando(proceso.id)">
          <td>
            <p-tableCheckbox [value]="proceso"></p-tableCheckbox>
          </td>
          <td>
            <span class="id-badge">{{ proceso.id.slice(0, 6) }}</span>
          </td>
          <!-- Nombre -->
          <td>
            @if (estaEditando(proceso.id)) {
              <div class="flex flex-column gap-1">
                <input pInputText [ngModel]="getValorEdicion('nombre')"
                       (ngModelChange)="setValorEdicion('nombre', $event)"
                       class="w-full" placeholder="Nombre" />
                <input pInputText [ngModel]="getValorEdicion('descripcion')"
                       (ngModelChange)="setValorEdicion('descripcion', $event)"
                       class="w-full text-sm" placeholder="Descripción" />
              </div>
            } @else {
              <div class="nombre-cell">
                <span class="nombre">{{ proceso.nombre }}</span>
                @if (proceso.descripcion) {
                  <span class="descripcion">{{ proceso.descripcion }}</span>
                }
              </div>
            }
          </td>
          <!-- Estado -->
          <td>
            @if (estaEditando(proceso.id)) {
              <p-select [options]="estadoOptions"
                        [ngModel]="getValorEdicion('estado')"
                        (ngModelChange)="setValorEdicion('estado', $event)"
                        [style]="{width: '100%'}" />
            } @else {
              <p-tag
                [value]="getEstadoLabel(proceso.estado)"
                [severity]="getEstadoSeverity(proceso.estado)">
              </p-tag>
            }
          </td>
          <td>
            <span class="nodes-count">
              <i class="pi pi-sitemap"></i>
              {{ proceso.nodes?.length || 0 }} nodos
            </span>
          </td>
          <td>{{ formatDate(proceso.createdAt) }}</td>
          <td>{{ formatDate(proceso.updatedAt) }}</td>
          <!-- Acciones -->
          <td class="actions-cell">
            @if (estaEditando(proceso.id)) {
              <div class="flex gap-1">
                <p-button icon="pi pi-check" severity="success" [text]="true" size="small"
                          pTooltip="Guardar" (onClick)="guardarEdicion(proceso, $event)" />
                <p-button icon="pi pi-times" severity="secondary" [text]="true" size="small"
                          pTooltip="Cancelar" (onClick)="cancelarEdicion($event)" />
              </div>
            } @else {
              <div class="flex gap-1">
                <p-button icon="pi pi-pencil" [outlined]="true" severity="secondary" size="small"
                          styleClass="btn-edit" pTooltip="Editar"
                          (onClick)="iniciarEdicion(proceso, $event)" />
                <p-menu #menu [model]="getMenuItems(proceso)" [popup]="true" appendTo="body"></p-menu>
                <p-button icon="pi pi-ellipsis-v" [text]="true" size="small"
                          (onClick)="menu.toggle($event)" />
              </div>
            }
          </td>
        </tr>
      </ng-template>

      <!-- Empty -->
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="8">
            <div class="empty-state">
              <i class="pi pi-inbox"></i>
              <p>No hay procesos creados</p>
              <p-button
                label="Crear primer proceso"
                icon="pi pi-plus"
                (onClick)="crearProceso()">
              </p-button>
            </div>
          </td>
        </tr>
      </ng-template>

      <!-- Pie de tabla con totales por columna -->
      <ng-template pTemplate="footer">
        <tr class="font-semibold surface-100">
          <td></td>
          <td>
            <span class="text-900">Totales</span>
          </td>
          <td>
            <span class="text-600">{{ procesos().length }} procesos</span>
          </td>
          <td>
            <div class="flex gap-1">
              <p-tag [value]="getCountByEstado('activo').toString()" severity="success" styleClass="text-xs" pTooltip="Activos" />
              <p-tag [value]="getCountByEstado('borrador').toString()" severity="warn" styleClass="text-xs" pTooltip="Borradores" />
              <p-tag [value]="getCountByEstado('inactivo').toString()" severity="secondary" styleClass="text-xs" pTooltip="Inactivos" />
            </div>
          </td>
          <td>
            <span class="text-primary font-bold">{{ getTotalNodos() }}</span>
          </td>
          <td></td>
          <td></td>
          <td></td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>
</div>

<!-- Drawer de Detalle -->
<p-drawer
  [(visible)]="showDrawer"
  [position]="'right'"
  [style]="{ width: '450px' }"
  header="Detalle del Proceso">

  @if (procesoSeleccionado()) {
    <div class="drawer-content">
      <!-- Info General -->
      <div class="detail-section">
        <h3>Información General</h3>
        <div class="detail-row">
          <span class="label">ID:</span>
          <span class="value">{{ procesoSeleccionado()!.id }}</span>
        </div>
        <div class="detail-row">
          <span class="label">Nombre:</span>
          <span class="value">{{ procesoSeleccionado()!.nombre }}</span>
        </div>
        <div class="detail-row">
          <span class="label">Descripción:</span>
          <span class="value">{{ procesoSeleccionado()!.descripcion || '-' }}</span>
        </div>
        <div class="detail-row">
          <span class="label">Estado:</span>
          <p-tag
            [value]="getEstadoLabel(procesoSeleccionado()!.estado)"
            [severity]="getEstadoSeverity(procesoSeleccionado()!.estado)">
          </p-tag>
        </div>
        <div class="detail-row">
          <span class="label">Versión:</span>
          <span class="value">{{ procesoSeleccionado()!.version }}</span>
        </div>
      </div>

      <p-divider></p-divider>

      <!-- Estadísticas -->
      <div class="detail-section">
        <h3>Estadísticas</h3>
        <div class="stats-grid">
          <div class="stat-item">
            <i class="pi pi-sitemap"></i>
            <span class="stat-number">{{ procesoSeleccionado()!.nodes?.length || 0 }}</span>
            <span class="stat-text">Nodos</span>
          </div>
          <div class="stat-item">
            <i class="pi pi-arrow-right-arrow-left"></i>
            <span class="stat-number">{{ procesoSeleccionado()!.edges?.length || 0 }}</span>
            <span class="stat-text">Conexiones</span>
          </div>
        </div>
      </div>

      <p-divider></p-divider>

      <!-- Fechas -->
      <div class="detail-section">
        <h3>Historial</h3>
        <div class="detail-row">
          <span class="label">Creado:</span>
          <span class="value">{{ formatDate(procesoSeleccionado()!.createdAt) }}</span>
        </div>
        <div class="detail-row">
          <span class="label">Modificado:</span>
          <span class="value">{{ formatDate(procesoSeleccionado()!.updatedAt) }}</span>
        </div>
        <div class="detail-row">
          <span class="label">Creado por:</span>
          <span class="value">{{ procesoSeleccionado()!.createdBy }}</span>
        </div>
      </div>

      <p-divider></p-divider>

      <!-- Cambiar Estado -->
      <div class="detail-section">
        <h3>Cambiar Estado</h3>
        <div class="estado-buttons">
          @for (option of estadoOptions; track option.value) {
            <p-button
              [label]="option.label"
              [severity]="getEstadoSeverity(option.value)"
              [outlined]="procesoSeleccionado()!.estado !== option.value"
              size="small"
              (onClick)="cambiarEstado(procesoSeleccionado()!, option.value)">
            </p-button>
          }
        </div>
      </div>

      <p-divider></p-divider>

      <!-- Acciones -->
      <div class="drawer-actions">
        <p-button
          label="Editar Proceso"
          icon="pi pi-pencil"
          (onClick)="editarProceso(procesoSeleccionado()!); showDrawer.set(false)">
        </p-button>
        <p-button
          label="Duplicar"
          icon="pi pi-copy"
          severity="secondary"
          (onClick)="duplicarProceso(procesoSeleccionado()!); showDrawer.set(false)">
        </p-button>
        @if (procesoSeleccionado()!.estado === 'activo') {
          <p-button
            label="Ejecutar"
            icon="pi pi-play"
            severity="success"
            (onClick)="ejecutarProceso(procesoSeleccionado()!)">
          </p-button>
        }
      </div>
    </div>
  }
</p-drawer>

<!-- Drawer Acciones Masivas -->
<p-drawer [(visible)]="showAccionesMasivasDrawer" position="right" [style]="{width: '400px'}" header="Acciones Masivas">
  <div class="flex flex-column gap-4">
    <p class="text-600 m-0">Aplicar cambios a {{ procesosSeleccionados().length }} procesos seleccionados</p>

    <!-- Estado -->
    <div class="flex flex-column gap-2">
      <label class="font-medium">Estado</label>
      <p-select [options]="estadoOptions" placeholder="Sin cambios" [showClear]="true"
                [style]="{width: '100%'}" />
    </div>
  </div>

  <ng-template pTemplate="footer">
    <div class="flex gap-2 justify-content-end">
      <p-button label="Cancelar" severity="secondary" [text]="true"
                (onClick)="showAccionesMasivasDrawer.set(false)" />
      <p-button label="Aplicar cambios" icon="pi pi-check"
                (onClick)="aplicarAccionesMasivas()" />
    </div>
  </ng-template>
</p-drawer>
