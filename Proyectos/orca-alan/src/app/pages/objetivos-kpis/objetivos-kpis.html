<p-toast />

<div class="objetivos-kpis-page">
  <!-- Header -->
  <header class="page-header">
    <div class="header-left">
      <button class="btn-back" (click)="volver()">
        <i class="pi pi-arrow-left"></i>
      </button>
      <div class="header-titles">
        <h1>{{ modo() === 'editar' ? 'Editar Objetivos y KPIs' : 'Objetivos y KPIs' }}</h1>
        <p class="page-subtitle">{{ procesoNombre() }}</p>
      </div>
    </div>
    <div class="header-actions">
      @if (modo() === 'ver') {
        <button class="btn-secondary" (click)="cambiarModo('editar')">
          <i class="pi pi-pencil"></i>
          Editar
        </button>
      } @else {
        <button class="btn-secondary" (click)="cambiarModo('ver')">
          <i class="pi pi-eye"></i>
          Ver
        </button>
      }
    </div>
  </header>

  <!-- Main Content - Two Columns -->
  <div class="main-content">
    <!-- Left Column - Objectives List -->
    <div class="left-column">
      <div class="search-box">
        <span class="p-input-icon-left">
          <i class="pi pi-search"></i>
          <input
            type="text"
            pInputText
            placeholder="Buscar objetivo..."
            [ngModel]="busquedaObjetivos()"
            (ngModelChange)="busquedaObjetivos.set($event)"
          />
        </span>
      </div>

      <div class="objetivos-list">
        @for (objetivo of objetivosFiltrados(); track objetivo.id) {
          <div
            class="objetivo-item"
            [class.selected]="objetivoSeleccionadoId() === objetivo.id"
            (click)="seleccionarObjetivo(objetivo.id)"
          >
            <div class="objetivo-header">
              <span class="objetivo-nombre">{{ objetivo.nombre }}</span>
              <span class="objetivo-tipo" [class]="objetivo.tipo">
                {{ getTipoLabel(objetivo.tipo) }}
              </span>
            </div>
            <div class="objetivo-progress">
              <div class="progress-bar">
                <div
                  class="progress-fill"
                  [class]="getProgresoColor(objetivo.progreso)"
                  [style.width.%]="objetivo.progreso"
                ></div>
              </div>
              <span class="progress-value">{{ objetivo.progreso }}%</span>
            </div>
          </div>
        } @empty {
          <div class="empty-state">
            <i class="pi pi-inbox"></i>
            <p>No se encontraron objetivos</p>
          </div>
        }
      </div>

      @if (modo() === 'editar') {
        <div class="add-objetivo">
          <button class="btn-add-objetivo" (click)="crearObjetivo()">
            <i class="pi pi-plus"></i>
            Agregar Objetivo
          </button>
        </div>
      }
    </div>

    <!-- Right Column - Objective Detail -->
    <div class="right-column">
      @if (objetivoSeleccionado(); as objetivo) {
        <!-- Detail Header -->
        <div class="detail-header">
          <h2 class="detail-title">Detalle del Objetivo</h2>
          @if (modo() === 'editar') {
            <div class="detail-actions">
              @if (!editandoObjetivo()) {
                <button class="btn-editar" (click)="iniciarEdicionObjetivo()">
                  <i class="pi pi-pencil"></i>
                  Editar
                </button>
                <button class="btn-eliminar" (click)="eliminarObjetivo()">
                  <i class="pi pi-trash"></i>
                </button>
              } @else {
                <button class="btn-guardar" (click)="guardarObjetivo()">
                  <i class="pi pi-check"></i>
                  Guardar
                </button>
                <button class="btn-cancelar" (click)="cancelarEdicionObjetivo()">
                  Cancelar
                </button>
              }
            </div>
          }
        </div>

        <!-- Detail Content -->
        <div class="detail-content">
          <!-- Nombre -->
          <div class="detail-section">
            <label class="detail-label">Nombre</label>
            @if (editandoObjetivo()) {
              <input
                type="text"
                class="detail-input"
                [ngModel]="formNombre()"
                (ngModelChange)="formNombre.set($event)"
                placeholder="Nombre del objetivo"
              />
            } @else {
              <p class="detail-value">{{ objetivo.nombre }}</p>
            }
          </div>

          <!-- Descripción -->
          <div class="detail-section">
            <label class="detail-label">Descripción</label>
            @if (editandoObjetivo()) {
              <textarea
                class="detail-textarea"
                [ngModel]="formDescripcion()"
                (ngModelChange)="formDescripcion.set($event)"
                placeholder="Descripción del objetivo"
                rows="3"
              ></textarea>
            } @else {
              <p class="detail-value">{{ objetivo.descripcion || 'Sin descripción' }}</p>
            }
          </div>

          <!-- Tipo -->
          <div class="detail-section">
            <label class="detail-label">Tipo</label>
            @if (editandoObjetivo()) {
              <select
                class="detail-select"
                [ngModel]="formTipo()"
                (ngModelChange)="formTipo.set($event)"
              >
                <option value="estrategico">Estratégico</option>
                <option value="operativo">Operativo</option>
              </select>
            } @else {
              <span class="tipo-badge" [class]="objetivo.tipo">
                {{ getTipoLabel(objetivo.tipo) }}
              </span>
            }
          </div>

          <!-- Progreso -->
          <div class="detail-section progress-section">
            <div class="progress-header">
              <label class="detail-label">Progreso</label>
              <span class="progress-value-large">{{ objetivo.progreso }}%</span>
            </div>
            <div class="progress-bar-large">
              <div
                class="progress-fill"
                [class]="getProgresoColor(objetivo.progreso)"
                [style.width.%]="objetivo.progreso"
              ></div>
            </div>
          </div>

          <!-- KPIs Section -->
          <div class="kpis-section">
            <div class="kpis-header">
              <h3>KPIs Asociados</h3>
              @if (modo() === 'editar' && !nuevoKPI() && !editandoKPIId()) {
                <button class="btn-add-kpi" (click)="iniciarNuevoKPI()">
                  <i class="pi pi-plus"></i>
                  Agregar KPI
                </button>
              }
            </div>

            <div class="kpis-list">
              <!-- New KPI Form -->
              @if (nuevoKPI()) {
                <div class="kpi-edit-row">
                  <input
                    type="text"
                    class="kpi-input"
                    [ngModel]="formKPINombre()"
                    (ngModelChange)="formKPINombre.set($event)"
                    placeholder="Nombre del KPI"
                  />
                  <input
                    type="number"
                    class="kpi-input meta"
                    [ngModel]="formKPIMeta()"
                    (ngModelChange)="formKPIMeta.set($event)"
                    placeholder="Meta"
                  />
                  <select
                    class="kpi-input escala"
                    [ngModel]="formKPIEscala()"
                    (ngModelChange)="formKPIEscala.set($event)"
                  >
                    @for (escala of escalasOptions; track escala.value) {
                      <option [value]="escala.value">{{ escala.label }}</option>
                    }
                  </select>
                  <div class="kpi-actions">
                    <button class="btn-check" (click)="guardarKPI()">
                      <i class="pi pi-check"></i>
                    </button>
                    <button class="btn-x" (click)="cancelarKPI()">
                      <i class="pi pi-times"></i>
                    </button>
                  </div>
                </div>
              }

              @for (kpi of objetivo.kpis; track kpi.id) {
                @if (editandoKPIId() === kpi.id) {
                  <!-- Edit KPI Form -->
                  <div class="kpi-edit-row">
                    <input
                      type="text"
                      class="kpi-input"
                      [ngModel]="formKPINombre()"
                      (ngModelChange)="formKPINombre.set($event)"
                      placeholder="Nombre del KPI"
                    />
                    <input
                      type="number"
                      class="kpi-input meta"
                      [ngModel]="formKPIMeta()"
                      (ngModelChange)="formKPIMeta.set($event)"
                      placeholder="Meta"
                    />
                    <select
                      class="kpi-input escala"
                      [ngModel]="formKPIEscala()"
                      (ngModelChange)="formKPIEscala.set($event)"
                    >
                      @for (escala of escalasOptions; track escala.value) {
                        <option [value]="escala.value">{{ escala.label }}</option>
                      }
                    </select>
                    <div class="kpi-actions">
                      <button class="btn-check" (click)="guardarKPI()">
                        <i class="pi pi-check"></i>
                      </button>
                      <button class="btn-x" (click)="cancelarKPI()">
                        <i class="pi pi-times"></i>
                      </button>
                    </div>
                  </div>
                } @else {
                  <!-- View KPI Row -->
                  <div class="kpi-view-row">
                    <span class="kpi-nombre">{{ kpi.nombre }}</span>
                    <span class="kpi-meta">{{ kpi.meta }}</span>
                    <span class="kpi-escala">{{ kpi.escala }}</span>
                    @if (modo() === 'editar') {
                      <div class="kpi-actions">
                        <button class="btn-edit-small" (click)="iniciarEdicionKPI(kpi)">
                          <i class="pi pi-pencil"></i>
                        </button>
                        <button class="btn-delete-small" (click)="eliminarKPI(kpi.id)">
                          <i class="pi pi-trash"></i>
                        </button>
                      </div>
                    }
                  </div>
                }
              } @empty {
                @if (!nuevoKPI()) {
                  <div class="kpis-empty">
                    <p>No hay KPIs asociados a este objetivo</p>
                  </div>
                }
              }
            </div>
          </div>
        </div>
      } @else {
        <!-- Empty State -->
        <div class="empty-detail">
          <i class="pi pi-target"></i>
          <p>Selecciona un objetivo para ver su detalle</p>
        </div>
      }
    </div>
  </div>
</div>
