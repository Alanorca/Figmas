// Prisma Schema para Sistema ORCA Completo

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================================
// MÓDULO: USUARIOS Y ROLES
// ============================================================

model Usuario {
  id                    String   @id @default(cuid())
  nombre                String
  apellido              String
  email                 String   @unique
  password              String?
  telefono              String?
  avatar                String?
  estado                String   @default("pendiente")
  departamento          String?
  cargo                 String?
  region                String   @default("MX")

  // Seguridad
  autenticacionDosFactor    Boolean  @default(false)
  cambioPasswordRequerido   Boolean  @default(true)
  sesionesActivas           Int      @default(0)
  maxSesionesPermitidas     Int      @default(3)
  ultimoCambioPassword      DateTime?
  intentosFallidos          Int      @default(0)

  // Fechas
  fechaCreacion         DateTime @default(now())
  fechaExpiracion       DateTime?
  ultimoAcceso          DateTime?
  updatedAt             DateTime @updatedAt

  // Relaciones
  roles                 UsuarioRol[]
  activosAcceso         UsuarioActivo[]
  logsAuditoria         LogAuditoria[]
  respuestasCuestionario RespuestaCuestionario[]

  @@map("usuarios")
}

model Rol {
  id              String       @id @default(cuid())
  nombre          String       @unique
  descripcion     String
  nivelAcceso     String       @default("lectura")
  region          String       @default("MX")
  tipoArbol       String       @default("activos")
  color           String?
  icono           String?
  activo          Boolean      @default(true)
  esRolSistema    Boolean      @default(false)
  fechaCreacion       DateTime @default(now())
  fechaModificacion   DateTime @updatedAt

  usuarios        UsuarioRol[]
  permisos        RolPermiso[]

  @@map("roles")
}

model Permiso {
  id          String   @id @default(cuid())
  codigo      String   @unique
  nombre      String
  descripcion String
  modulo      String
  categoria   String
  activo      Boolean  @default(true)
  padreId     String?
  padre       Permiso? @relation("PermisoJerarquia", fields: [padreId], references: [id])
  hijos       Permiso[] @relation("PermisoJerarquia")
  roles       RolPermiso[]

  @@map("permisos")
}

model Modulo {
  id          String   @id @default(cuid())
  nombre      String   @unique
  descripcion String?
  icono       String?
  orden       Int      @default(0)
  activo      Boolean  @default(true)
  permisoCreacion       Boolean @default(false)
  permisoEdicion        Boolean @default(false)
  permisoVisualizacion  Boolean @default(true)
  permisoEliminacion    Boolean @default(false)

  @@map("modulos")
}

model UsuarioRol {
  usuarioId   String
  rolId       String
  fechaAsignacion DateTime @default(now())
  usuario     Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  rol         Rol     @relation(fields: [rolId], references: [id], onDelete: Cascade)

  @@id([usuarioId, rolId])
  @@map("usuarios_roles")
}

model RolPermiso {
  rolId       String
  permisoId   String
  rol         Rol     @relation(fields: [rolId], references: [id], onDelete: Cascade)
  permiso     Permiso @relation(fields: [permisoId], references: [id], onDelete: Cascade)

  @@id([rolId, permisoId])
  @@map("roles_permisos")
}

model UsuarioActivo {
  usuarioId   String
  activoId    String
  nivelAcceso String @default("lectura")
  usuario     Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  activo      ActivoAcceso  @relation(fields: [activoId], references: [id], onDelete: Cascade)

  @@id([usuarioId, activoId])
  @@map("usuarios_activos")
}

model LogAuditoria {
  id              String   @id @default(cuid())
  accion          String
  entidad         String
  entidadId       String
  entidadNombre   String
  detalles        String?
  ip              String?
  userAgent       String?
  fecha           DateTime @default(now())
  usuarioId       String
  usuario         Usuario  @relation(fields: [usuarioId], references: [id])

  @@map("logs_auditoria")
}

// ============================================================
// MÓDULO: ACTIVOS (Árbol de acceso - mantener compatibilidad)
// ============================================================

model ActivoAcceso {
  id          String   @id @default(cuid())
  nombre      String
  tipo        String
  icono       String?
  nivelAcceso String?
  expanded    Boolean  @default(false)
  padreId     String?
  padre       ActivoAcceso?  @relation("ActivoAccesoJerarquia", fields: [padreId], references: [id])
  hijos       ActivoAcceso[] @relation("ActivoAccesoJerarquia")
  usuarios    UsuarioActivo[]

  @@map("activos_acceso")
}

// ============================================================
// MÓDULO: ACTIVOS DE NEGOCIO
// ============================================================

model PlantillaActivo {
  id          String   @id @default(cuid())
  nombre      String
  tipoActivo  String
  descripcion String
  icono       String?
  color       String?
  propiedades String   // JSON de PropiedadCustomDefinicion[]
  activo      Boolean  @default(true)
  fechaCreacion DateTime @default(now())

  activos     Activo[]

  @@map("plantillas_activo")
}

model Activo {
  id              String   @id @default(cuid())
  nombre          String
  descripcion     String
  tipo            String   // hardware, software, datos, personas, instalaciones
  criticidad      String   // alta, media, baja
  responsable     String
  departamento    String
  fechaRegistro   DateTime @default(now())
  updatedAt       DateTime @updatedAt

  plantillaId     String?
  plantilla       PlantillaActivo? @relation(fields: [plantillaId], references: [id])
  propiedadesCustom String? // JSON de PropiedadCustomValor[]

  riesgos         Riesgo[]
  incidentes      Incidente[]
  defectos        Defecto[]

  @@map("activos")
}

model Riesgo {
  id                  String   @id @default(cuid())
  activoId            String
  activo              Activo   @relation(fields: [activoId], references: [id], onDelete: Cascade)
  descripcion         String
  probabilidad        Int      // 1-5
  impacto             Int      // 1-5
  estado              String   // identificado, evaluado, mitigado, aceptado
  fechaIdentificacion DateTime @default(now())
  responsable         String
  updatedAt           DateTime @updatedAt

  @@map("riesgos")
}

model Incidente {
  id            String   @id @default(cuid())
  activoId      String
  activo        Activo   @relation(fields: [activoId], references: [id], onDelete: Cascade)
  titulo        String
  descripcion   String
  severidad     String   // critica, alta, media, baja
  estado        String   // abierto, en_proceso, resuelto, cerrado
  fechaReporte  DateTime @default(now())
  reportadoPor  String
  updatedAt     DateTime @updatedAt

  @@map("incidentes")
}

model Defecto {
  id              String   @id @default(cuid())
  activoId        String
  activo          Activo   @relation(fields: [activoId], references: [id], onDelete: Cascade)
  titulo          String
  descripcion     String
  tipo            String   // funcional, seguridad, rendimiento, usabilidad
  prioridad       String   // critica, alta, media, baja
  estado          String   // nuevo, confirmado, en_correccion, corregido, verificado
  fechaDeteccion  DateTime @default(now())
  detectadoPor    String
  updatedAt       DateTime @updatedAt

  @@map("defectos")
}

// ============================================================
// MÓDULO: ORGANIGRAMAS
// ============================================================

model Organigrama {
  id            String   @id @default(cuid())
  nombre        String
  descripcion   String
  fechaCreacion DateTime @default(now())
  updatedAt     DateTime @updatedAt

  nodos         NodoOrganigrama[]

  @@map("organigramas")
}

model NodoOrganigrama {
  id            String   @id @default(cuid())
  organigramaId String
  organigrama   Organigrama @relation(fields: [organigramaId], references: [id], onDelete: Cascade)
  nombre        String
  cargo         String
  departamento  String
  email         String
  telefono      String?
  foto          String?
  padreId       String?
  padre         NodoOrganigrama? @relation("NodoOrganigramaJerarquia", fields: [padreId], references: [id])
  subordinados  NodoOrganigrama[] @relation("NodoOrganigramaJerarquia")

  @@map("nodos_organigrama")
}

// ============================================================
// MÓDULO: CUESTIONARIOS Y CUMPLIMIENTO
// ============================================================

model MarcoNormativo {
  id            String   @id @default(cuid())
  nombre        String
  acronimo      String
  version       String
  fechaVigencia DateTime
  descripcion   String
  activo        Boolean  @default(true)
  fechaCreacion DateTime @default(now())

  requisitos    RequisitoNormativo[]
  cuestionarios Cuestionario[]

  @@map("marcos_normativos")
}

model RequisitoNormativo {
  id                  String   @id @default(cuid())
  codigo              String
  nombre              String
  descripcion         String
  marcoId             String
  marco               MarcoNormativo @relation(fields: [marcoId], references: [id], onDelete: Cascade)
  controlesAsociados  String   // JSON array

  @@map("requisitos_normativos")
}

model Cuestionario {
  id                String   @id @default(cuid())
  nombre            String
  descripcion       String
  categoria         String
  tipo              String   // ia, manual
  tipoEvaluacion    String   // autoevaluacion, auditoria_externa, revision_controles
  estado            String   @default("borrador") // borrador, activo, archivado
  marcoNormativoId  String?
  marcoNormativo    MarcoNormativo? @relation(fields: [marcoNormativoId], references: [id])
  periodicidad      String   // unica, mensual, trimestral, semestral, anual
  tasaCompletado    Float    @default(0)
  fechaCreacion     DateTime @default(now())
  fechaModificacion DateTime @updatedAt
  umbrales          String   // JSON {deficiente, aceptable, sobresaliente}
  areasObjetivo     String   // JSON array
  responsables      String   // JSON array

  secciones         Seccion[]
  asignaciones      AsignacionCuestionario[]

  @@map("cuestionarios")
}

model Seccion {
  id              String   @id @default(cuid())
  cuestionarioId  String
  cuestionario    Cuestionario @relation(fields: [cuestionarioId], references: [id], onDelete: Cascade)
  nombre          String
  descripcion     String
  peso            Float    @default(1)
  requerida       Boolean  @default(true)
  orden           Int      @default(0)

  preguntas       Pregunta[]

  @@map("secciones")
}

model Pregunta {
  id                      String   @id @default(cuid())
  seccionId               String
  seccion                 Seccion  @relation(fields: [seccionId], references: [id], onDelete: Cascade)
  texto                   String
  tipo                    String   // texto, textoLargo, boolean, numero, siNoNa, etc.
  requerida               Boolean  @default(true)
  peso                    Float    @default(1)
  opciones                String?  // JSON array
  escalaMin               Int?
  escalaMax               Int?
  ayuda                   String?
  placeholder             String?
  requisitoNormativoId    String?
  controlAsociado         String?
  requiereEvidencia       Boolean  @default(false)
  maxStars                Int?
  leftAnchor              String?
  rightAnchor             String?
  likertLabels            String?  // JSON array
  displayConditionQuestionId String?
  displayConditionAnswer  String?
  logicaCondicional       String?  // JSON
  isCalculated            Boolean  @default(false)
  formula                 String?
  orden                   Int      @default(0)

  respuestas              RespuestaPregunta[]
  hallazgos               Hallazgo[]

  @@map("preguntas")
}

model AsignacionCuestionario {
  id                    String   @id @default(cuid())
  cuestionarioId        String
  cuestionario          Cuestionario @relation(fields: [cuestionarioId], references: [id])
  cuestionarioIds       String?  // JSON array para múltiples
  titulo                String
  descripcion           String?
  tipoRevision          String   // interna, externa
  usuariosAsignados     String   // JSON array de IDs
  usuariosAsignadosNombres String // JSON array
  emailsExternos        String?  // JSON array
  contrasenaAcceso      String?
  activosObjetivo       String   // JSON array
  activosObjetivoNombres String  // JSON array
  procesosObjetivo      String   // JSON array
  procesosObjetivoNombres String // JSON array
  aprobadores           String   // JSON array
  aprobadoresNombres    String   // JSON array
  evaluadosInternos     String?  // JSON array
  evaluadosInternosNombres String? // JSON array
  areaId                String
  areaNombre            String
  responsableId         String
  responsableNombre     String
  fechaAsignacion       DateTime @default(now())
  fechaInicio           DateTime
  fechaVencimiento      DateTime
  estado                String   @default("pendiente") // pendiente, en_progreso, completado, vencido, revisado
  progreso              Float    @default(0)
  instrucciones         String?
  recordatorios         Boolean  @default(true)
  tokenAccesoExterno    String?
  recurrencia           String?  // JSON

  evaluadosExternos     EvaluadoExterno[]
  respuestas            RespuestaCuestionario[]
  mensajesChat          MensajeChat[]

  @@map("asignaciones_cuestionario")
}

model EvaluadoExterno {
  id                String   @id @default(cuid())
  asignacionId      String
  asignacion        AsignacionCuestionario @relation(fields: [asignacionId], references: [id], onDelete: Cascade)
  nombre            String
  email             String
  password          String?
  invitacionEnviada Boolean  @default(false)
  fechaInvitacion   DateTime?
  haRespondido      Boolean  @default(false)
  fechaRespuesta    DateTime?

  @@map("evaluados_externos")
}

model RespuestaCuestionario {
  id                  String   @id @default(cuid())
  asignacionId        String
  asignacion          AsignacionCuestionario @relation(fields: [asignacionId], references: [id], onDelete: Cascade)
  cuestionarioId      String
  respondidoPorId     String
  respondidoPor       Usuario  @relation(fields: [respondidoPorId], references: [id])
  fechaInicio         DateTime @default(now())
  fechaEnvio          DateTime?
  estado              String   @default("borrador") // borrador, enviado, en_revision, aprobado, rechazado
  puntuacionTotal     Float    @default(0)
  nivelCumplimiento   String?  // deficiente, aceptable, sobresaliente
  comentariosGenerales String?

  respuestas          RespuestaPregunta[]

  @@map("respuestas_cuestionario")
}

model RespuestaPregunta {
  id                    String   @id @default(cuid())
  respuestaCuestionarioId String
  respuestaCuestionario RespuestaCuestionario @relation(fields: [respuestaCuestionarioId], references: [id], onDelete: Cascade)
  preguntaId            String
  pregunta              Pregunta @relation(fields: [preguntaId], references: [id])
  valor                 String?  // JSON para valores complejos
  comentario            String?
  archivosAdjuntos      String?  // JSON array
  marcadaParaRevision   Boolean  @default(false)
  estadoRevision        String   @default("pendiente") // pendiente, aprobada, rechazada, requiere_aclaracion
  comentarioRevisor     String?

  evidencias            Evidencia[]

  @@map("respuestas_pregunta")
}

model Evidencia {
  id                  String   @id @default(cuid())
  respuestaPreguntaId String
  respuestaPregunta   RespuestaPregunta @relation(fields: [respuestaPreguntaId], references: [id], onDelete: Cascade)
  nombre              String
  tipo                String
  tamano              Int
  fechaCarga          DateTime @default(now())
  url                 String
  descripcion         String?
  vigencia            DateTime?
  estado              String   @default("vigente") // vigente, proximo_vencer, vencida

  @@map("evidencias")
}

model Hallazgo {
  id                  String   @id @default(cuid())
  preguntaId          String
  pregunta            Pregunta @relation(fields: [preguntaId], references: [id])
  tipo                String   // conformidad, no_conformidad_menor, no_conformidad_mayor, observacion
  descripcion         String
  requisitoNormativo  String?
  accionCorrectiva    String?
  responsable         String
  fechaLimite         DateTime?
  estado              String   @default("abierto") // abierto, en_proceso, cerrado
  fechaCreacion       DateTime @default(now())

  @@map("hallazgos")
}

model MensajeChat {
  id            String   @id @default(cuid())
  asignacionId  String
  asignacion    AsignacionCuestionario @relation(fields: [asignacionId], references: [id], onDelete: Cascade)
  cuestionarioId String?
  activoProcesoId String?
  usuarioId     String
  usuarioNombre String
  usuarioRol    String   // evaluador, aprobador
  mensaje       String
  fecha         DateTime @default(now())
  leido         Boolean  @default(false)

  @@map("mensajes_chat")
}

model AlertaCumplimiento {
  id              String   @id @default(cuid())
  tipo            String   // cuestionario_vencido, evidencia_faltante, control_sin_validar, brecha_cumplimiento
  severidad       String   // critica, alta, media, baja
  titulo          String
  descripcion     String
  entidadId       String
  entidadTipo     String
  fechaGeneracion DateTime @default(now())
  estado          String   @default("activa") // activa, atendida, ignorada
  responsable     String?
  marcoNormativo  String?

  @@map("alertas_cumplimiento")
}

// ============================================================
// MÓDULO: PROCESOS
// ============================================================

model Proceso {
  id          String   @id @default(cuid())
  nombre      String
  descripcion String
  version     String   @default("1.0")
  estado      String   @default("borrador") // borrador, activo, inactivo, archivado
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String

  nodos       ProcessNode[]
  edges       ProcessEdge[]
  objetivos   ObjetivoProceso[]
  kpis        KpiProceso[]

  @@map("procesos")
}

model ProcessNode {
  id          String   @id @default(cuid())
  procesoId   String
  proceso     Proceso  @relation(fields: [procesoId], references: [id], onDelete: Cascade)
  type        String   // activo, csv, transformacion, condicional, llm, branching, estado, matematico, ml, kpi
  label       String
  descripcion String?
  config      String   // JSON de la configuración específica del nodo
  positionX   Float
  positionY   Float

  edgesFrom   ProcessEdge[] @relation("EdgeSource")
  edgesTo     ProcessEdge[] @relation("EdgeTarget")
  kpiHistorico KpiHistorico[]

  @@map("process_nodes")
}

model ProcessEdge {
  id            String   @id @default(cuid())
  procesoId     String
  proceso       Proceso  @relation(fields: [procesoId], references: [id], onDelete: Cascade)
  sourceNodeId  String
  sourceNode    ProcessNode @relation("EdgeSource", fields: [sourceNodeId], references: [id], onDelete: Cascade)
  targetNodeId  String
  targetNode    ProcessNode @relation("EdgeTarget", fields: [targetNodeId], references: [id], onDelete: Cascade)
  sourceHandle  String?
  targetHandle  String?
  label         String?

  @@map("process_edges")
}

model ObjetivoProceso {
  id          String   @id @default(cuid())
  procesoId   String
  proceso     Proceso  @relation(fields: [procesoId], references: [id], onDelete: Cascade)
  nombre      String
  descripcion String
  tipo        String   // estrategico, operativo
  progreso    Float    @default(0)

  kpis        KpiProceso[]

  @@map("objetivos_proceso")
}

model KpiProceso {
  id                      String   @id @default(cuid())
  procesoId               String
  proceso                 Proceso  @relation(fields: [procesoId], references: [id], onDelete: Cascade)
  objetivoId              String?
  objetivo                ObjetivoProceso? @relation(fields: [objetivoId], references: [id])
  nombre                  String
  descripcion             String?
  unidad                  String   // porcentaje, numero, moneda_mxn, etc.
  meta                    Float
  valorActual             Float    @default(0)
  fechaUltimaActualizacion DateTime?
  alertaAdvertencia       Float?
  alertaCritico           Float?
  alertaDireccion         String   @default("menor") // mayor, menor

  historico               KpiHistorico[]

  @@map("kpis_proceso")
}

model KpiHistorico {
  id          String   @id @default(cuid())
  kpiId       String
  kpi         KpiProceso @relation(fields: [kpiId], references: [id], onDelete: Cascade)
  valor       Float
  timestamp   DateTime @default(now())
  procesoId   String
  nodoId      String?
  nodo        ProcessNode? @relation(fields: [nodoId], references: [id])
  metadatos   String?  // JSON

  @@map("kpi_historico")
}

// ============================================================
// MÓDULO: DASHBOARD
// ============================================================

model DashboardConfig {
  id          String   @id @default(cuid())
  nombre      String
  descripcion String?
  isDefault   Boolean  @default(false)
  isLocked    Boolean  @default(false)
  columns     Int      @default(12)
  rowHeight   Int      @default(50)
  gap         Int      @default(10)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?

  widgets     DashboardWidget[]

  @@map("dashboard_configs")
}

model DashboardWidget {
  id          String   @id @default(cuid())
  dashboardId String
  dashboard   DashboardConfig @relation(fields: [dashboardId], references: [id], onDelete: Cascade)
  tipo        String   // kpi-card, kpi-grid, graficas-interactivas, etc.
  titulo      String
  subtitulo   String?
  icono       String?
  config      String   // JSON de configuración del widget
  x           Int
  y           Int
  cols        Int
  rows        Int
  canResize   Boolean  @default(true)
  canDrag     Boolean  @default(true)
  canRemove   Boolean  @default(true)
  canEdit     Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("dashboard_widgets")
}

// ============================================================
// MÓDULO: CATÁLOGOS
// ============================================================

model Catalogo {
  id          String   @id @default(cuid())
  tipo        String   // tipoActivo, criticidad, severidad, estadoRiesgo, etc.
  codigo      String
  nombre      String
  descripcion String?
  orden       Int      @default(0)
  activo      Boolean  @default(true)
  color       String?
  icono       String?
  metadata    String?  // JSON para datos adicionales

  @@unique([tipo, codigo])
  @@map("catalogos")
}

// ============================================================
// MÓDULO: NOTIFICACIONES Y ALERTAS
// ============================================================

// Reglas de notificación por eventos (CREATE, UPDATE, DELETE, APPROVAL, REJECTION)
model NotificationRule {
  id                    String   @id @default(cuid())
  nombre                String
  descripcion           String?
  entidadTipo           String   // ASSET, RISK, INCIDENT, DEFECT, PROCESS, QUESTIONNAIRE, COMPLIANCE_REVIEW, ML_RESULT, ORG_CONTAINER
  eventoTipo            String   // CREATE, UPDATE, DELETE, APPROVAL, REJECTION
  activo                Boolean  @default(true)

  // Destinatarios
  notificarCreador      Boolean  @default(false)
  notificarResponsable  Boolean  @default(true)
  notificarAprobadores  Boolean  @default(false)
  rolesDestino          String?  // JSON array de role IDs
  usuariosDestino       String?  // JSON array de user IDs

  // Canales
  enviarInApp           Boolean  @default(true)
  enviarEmail           Boolean  @default(false)

  // Mensaje
  plantillaMensaje      String?  // Template con placeholders {{entidad.nombre}}
  severidad             String   @default("info") // info, warning, critical

  fechaCreacion         DateTime @default(now())
  fechaModificacion     DateTime @updatedAt

  @@map("notification_rules")
}

// Alertas por umbral (métricas y KPIs)
model AlertRule {
  id                String   @id @default(cuid())
  nombre            String
  descripcion       String?
  entidadTipo       String   // KPI, RISK_COUNT, INCIDENT_COUNT, COMPLIANCE_SCORE
  entidadId         String?  // ID específico del KPI o null para agregados
  metricaNombre     String   // Nombre del campo a monitorear

  // Condición
  operador          String   // GT, LT, GTE, LTE, EQ, NE
  valorUmbral       Float
  tipoAgregacion    String   @default("CURRENT") // CURRENT, COUNT, AVERAGE, SUM, MIN, MAX
  periodoEvaluacion String?  // JSON {cantidad: 7, unidad: 'dias'}

  activo            Boolean  @default(true)

  // Destinatarios
  rolesDestino      String?  // JSON array
  usuariosDestino   String?  // JSON array

  // Canales
  enviarInApp       Boolean  @default(true)
  enviarEmail       Boolean  @default(false)

  severidad         String   @default("warning") // info, warning, critical
  cooldownMinutos   Int      @default(60) // Evitar spam de alertas
  ultimaEjecucion   DateTime?

  fechaCreacion     DateTime @default(now())
  fechaModificacion DateTime @updatedAt

  @@map("alert_rules")
}

// Reglas de vencimiento (recordatorios anticipados)
model ExpirationRule {
  id                   String   @id @default(cuid())
  nombre               String
  descripcion          String?
  entidadTipo          String   // QUESTIONNAIRE_ASSIGNMENT, EVIDENCE, RISK, INCIDENT

  // Configuración de anticipación
  diasAnticipacion     String   // JSON array [30, 15, 7, 1]
  diasDespuesVencido   String?  // JSON array [1, 7, 15]

  activo               Boolean  @default(true)

  // Destinatarios
  notificarResponsable Boolean  @default(true)
  notificarSupervisor  Boolean  @default(false)
  rolesDestino         String?  // JSON array

  // Canales
  enviarInApp          Boolean  @default(true)
  enviarEmail          Boolean  @default(false)

  fechaCreacion        DateTime @default(now())
  fechaModificacion    DateTime @updatedAt

  @@map("expiration_rules")
}

// Notificaciones del usuario (bandeja de entrada)
model Notification {
  id                  String    @id @default(cuid())
  usuarioId           String

  // Contenido
  tipo                String    // NOTIFICATION, ALERT, EXPIRATION_REMINDER, OVERDUE, APPROVAL_REQUEST
  titulo              String
  mensaje             String
  severidad           String    @default("info") // info, warning, critical

  // Referencia a entidad relacionada
  entidadTipo         String?
  entidadId           String?
  entidadNombre       String?

  // Estado
  leida               Boolean   @default(false)
  archivada           Boolean   @default(false)
  enSeguimiento       Boolean   @default(false)

  // Acciones disponibles
  acciones            String?   // JSON [{label, type, action, url}]

  // Attachment
  attachmentTipo      String?   // image, document, link
  attachmentUrl       String?
  attachmentTitulo    String?
  attachmentSubtitulo String?

  // Metadata adicional
  metadata            String?   // JSON para datos adicionales

  // Referencia a regla que la generó
  reglaId             String?
  reglaTipo           String?   // NOTIFICATION_RULE, ALERT_RULE, EXPIRATION_RULE

  fechaCreacion       DateTime  @default(now())
  fechaLeida          DateTime?

  @@index([usuarioId, leida, archivada])
  @@index([usuarioId, fechaCreacion])
  @@map("notifications")
}

// Preferencias de notificación por usuario
model UserNotificationPreferences {
  id                     String   @id @default(cuid())
  usuarioId              String   @unique

  // Preferencias globales
  habilitado             Boolean  @default(true)
  emailHabilitado        Boolean  @default(true)
  inAppHabilitado        Boolean  @default(true)

  // Preferencias por tipo de entidad (JSON)
  preferenciasPorEntidad String?  // {"ASSET": {"inApp": true, "email": false}, ...}

  // Preferencias por severidad
  notificarInfo          Boolean  @default(true)
  notificarWarning       Boolean  @default(true)
  notificarCritical      Boolean  @default(true)

  // Frecuencia de emails
  frecuenciaEmail        String   @default("inmediato") // inmediato, resumen_diario, resumen_semanal
  horaResumen            String   @default("09:00")

  // Horario No Molestar
  horarioNoMolestarHabilitado Boolean @default(false)
  horarioNoMolestarInicio     String?  // "22:00"
  horarioNoMolestarFin        String?  // "08:00"
  horarioNoMolestarDias       String?  // JSON array de días [0,1,2,3,4,5,6] donde 0=Domingo

  // Rate Limiting Global (máximo notificaciones por hora)
  rateLimitHabilitado    Boolean @default(true)
  rateLimitMaxPorHora    Int     @default(100)  // Máximo 100 notificaciones/hora por usuario

  // Preferencias por módulo (JSON)
  preferenciasPorModulo  String?  // {"cuestionarios": {"inApp": true, "email": true}, ...}

  fechaCreacion          DateTime @default(now())
  fechaModificacion      DateTime @updatedAt

  @@map("user_notification_preferences")
}

// Log de notificaciones enviadas
model NotificationLog {
  id             String   @id @default(cuid())
  notificationId String?
  usuarioId      String

  // Detalles del envío
  canal          String   // IN_APP, EMAIL
  estado         String   // SENT, DELIVERED, FAILED, PENDING
  errorMensaje   String?

  // Referencia
  reglaId        String?
  reglaTipo      String?

  metadata       String?  // JSON con datos adicionales

  fechaEnvio     DateTime @default(now())

  @@index([usuarioId, fechaEnvio])
  @@index([estado])
  @@map("notification_logs")
}

// Perfiles de notificación (configuraciones reutilizables)
model NotificationProfile {
  id                String   @id @default(cuid())
  nombre            String
  descripcion       String?

  // Eventos que disparan la notificación
  eventos           String   // JSON: {onCreate: true, onUpdate: false, onDelete: false, onExpiration: false}

  // Selección de entidades
  seleccionEntidades String  // JSON: EntitySelection[] - qué entidades aplican
  filtrosEntidad    String?  // JSON: Condition[] - filtros adicionales

  // Destinatarios
  destinatarios     String   // JSON: RecipientConfig - quiénes reciben

  // Canales de notificación
  canales           String   // JSON: string[] - ["IN_APP", "EMAIL"]

  // Plantilla del mensaje
  plantillaTitulo   String?
  plantillaMensaje  String?
  severidad         String   @default("info") // info, warning, critical

  // Estado
  estado            String   @default("active") // active, inactive, draft

  // Horario No Molestar específico del perfil
  horarioNoMolestar String?  // JSON: {habilitado: boolean, horaInicio: string, horaFin: string, diasSemana: number[]}

  // Metadata
  fechaCreacion     DateTime @default(now())
  fechaModificacion DateTime @updatedAt
  creadoPorId       String?

  @@map("notification_profiles")
}

// ============================================================
// MÓDULO: GESTIÓN DE PROYECTOS Y TAREAS
// ============================================================

model Project {
  id                String   @id @default(cuid())
  name              String
  description       String?
  startDate         DateTime
  endDate           DateTime
  responsibleUserId String
  orgUnitId         String?
  priority          String   @default("medium") // low, medium, high, critical
  status            String   @default("planning") // planning, in_progress, paused, completed, cancelled
  progress          Int      @default(0)

  // Configuración notificaciones
  reminderDays      String   @default("[7,3,1]") // JSON array

  createdAt         DateTime @default(now())
  createdBy         String
  updatedAt         DateTime @updatedAt

  // Relaciones
  objectives        ProjectObjective[]
  kpis              ProjectKPI[]
  phases            ProjectPhase[]
  tasks             Task[]

  @@map("projects")
}

model ProjectObjective {
  id            String    @id @default(cuid())
  projectId     String
  description   String
  category      String    // specific, measurable, achievable, relevant, time_bound
  status        String    @default("pending") // pending, in_progress, achieved, not_achieved
  targetDate    DateTime?
  completedDate DateTime?

  project       Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("project_objectives")
}

model ProjectKPI {
  id           String   @id @default(cuid())
  projectId    String
  name         String
  description  String?
  targetValue  Float
  currentValue Float    @default(0)
  unit         String
  formulaType  String   // count, average, percentage, custom
  formula      String?
  status       String   @default("on_track") // on_track, at_risk, off_track

  project      Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("project_kpis")
}

model ProjectPhase {
  id               String    @id @default(cuid())
  projectId        String
  name             String
  description      String?
  orderNum         Int
  startDate        DateTime
  endDate          DateTime
  actualStartDate  DateTime?
  actualEndDate    DateTime?
  status           String    @default("pending") // pending, in_progress, completed, cancelled
  weight           Int       @default(100)
  dependsOnPhaseId String?
  progress         Int       @default(0)

  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  project          Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  dependsOn        ProjectPhase?  @relation("PhaseDependency", fields: [dependsOnPhaseId], references: [id])
  dependents       ProjectPhase[] @relation("PhaseDependency")
  tasks            Task[]

  @@map("project_phases")
}

model Task {
  id               String    @id @default(cuid())
  projectId        String
  phaseId          String
  title            String
  description      String?

  // Asignación
  assignedTo       String
  assignedBy       String
  assignedAt       DateTime  @default(now())

  // Fechas
  startDate        DateTime
  dueDate          DateTime
  completedDate    DateTime?

  // Progreso
  progress         Int       @default(0)
  status           String    @default("pending") // pending, in_progress, in_review, completed, blocked, cancelled
  priority         String    @default("medium")

  // Esfuerzo
  estimatedHours   Float?
  actualHours      Float?

  // Tipo y vinculación
  taskType         String    @default("manual") // manual, risk_mitigation, opportunity, incident_mitigation, defect_mitigation
  linkedEntityType String?   // RISK, ML_RESULT, INCIDENT, DEFECT
  linkedEntityId   String?

  createdAt        DateTime  @default(now())
  createdBy        String
  updatedAt        DateTime  @updatedAt

  project          Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  phase            ProjectPhase   @relation(fields: [phaseId], references: [id], onDelete: Cascade)
  evidences        TaskEvidence[]
  history          TaskHistory[]

  @@index([projectId, status])
  @@index([assignedTo, status])
  @@index([dueDate])
  @@map("tasks")
}

model TaskEvidence {
  id           String    @id @default(cuid())
  taskId       String
  fileName     String
  fileType     String
  fileSize     Int
  storageUrl   String
  evidenceType String    // document, image, log, screenshot, other
  description  String?
  documentDate DateTime?
  uploadedBy   String
  uploadedAt   DateTime  @default(now())

  task         Task      @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@map("task_evidences")
}

model TaskHistory {
  id        String   @id @default(cuid())
  taskId    String
  userId    String
  action    String   // created, updated, status_changed, assigned, progress_updated
  changes   String?  // JSON
  comment   String?
  timestamp DateTime @default(now())

  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@map("task_history")
}
