---
title: "Revisiones de Cumplimiento Normativo"
sidebar_label: "Revisiones de Cumplimiento"
sidebar_position: 5
---

import ZoomableDiagram from '@site/src/components/ZoomableDiagram';

# Historia de Usuario: Revisiones de Cumplimiento Normativo

## üìã Informaci√≥n General

- **ID**: US-COMPLIANCE-001
- **M√≥dulo**: Gesti√≥n de Cumplimiento / Revisiones
- **Prioridad**: Cr√≠tica
- **Sprint**: Sprint 3-4

## üë§ Historia de Usuario

**Como** Usuario de ORCA SNS
**Quiero** planificar, ejecutar y gestionar revisiones de cumplimiento normativo aplicando cuestionarios a **activos espec√≠ficos o procesos de negocio** (pero no ambos en una misma revisi√≥n), invitando a usuarios internos y externos a responder, aprobando respuestas, y utilizando IA para identificar autom√°ticamente riesgos, incidentes, deficiencias y controles
**Quiero** configurar revisiones recurrentes (diarias, semanales, mensuales, trimestrales, anuales) para automatizar auditor√≠as peri√≥dicas
**Para** asegurar el cumplimiento continuo de normativas (ISO 27001, SOC 2, GDPR, etc.), detectar proactivamente brechas de cumplimiento, y mantener un registro auditable de evaluaciones con identificaci√≥n autom√°tica de hallazgos cr√≠ticos por IA.

## ‚úÖ Criterios de Aceptaci√≥n

### Feature: Selecci√≥n de Tipo de Objetivo (Activos o Procesos)

```gherkin
Scenario: Usuario debe seleccionar tipo de objetivo antes de crear revisi√≥n
  Given un "Director de Cumplimiento" est√° en el m√≥dulo de "Revisiones de Cumplimiento"
  When selecciona "Nueva Revisi√≥n de Cumplimiento"
  Then el sistema muestra un selector con dos opciones mutuamente excluyentes:
    | Opci√≥n                     | Descripci√≥n                                      |
    | Activos                    | Evaluar activos de informaci√≥n (servidores, bases de datos, aplicaciones, etc.) |
    | Procesos                   | Evaluar procesos de negocio (gesti√≥n de cambios, respuesta a incidentes, etc.) |
  And el usuario debe seleccionar una opci√≥n antes de continuar
  And NO es posible seleccionar ambas opciones simult√°neamente
```

```gherkin
Scenario: Crear revisi√≥n orientada a activos
  Given un "Usuario ORCA" seleccion√≥ "Activos" como tipo de objetivo
  When configura la revisi√≥n
  Then el campo "Activos Objetivo" est√° habilitado y es obligatorio
  And el campo "Procesos Objetivo" est√° deshabilitado y oculto
  And el sistema solo permite seleccionar activos del cat√°logo de activos
```

```gherkin
Scenario: Crear revisi√≥n orientada a procesos
  Given un "Usuario ORCA" seleccion√≥ "Procesos" como tipo de objetivo
  When configura la revisi√≥n
  Then el campo "Procesos Objetivo" est√° habilitado y es obligatorio
  And el campo "Activos Objetivo" est√° deshabilitado y oculto
  And el sistema solo permite seleccionar procesos del cat√°logo de procesos
```

```gherkin
Scenario: Validaci√≥n impide mezclar activos y procesos en una revisi√≥n
  Given un usuario intenta crear una revisi√≥n v√≠a API
  When env√≠a una solicitud con targetType: "assets" y processIds no vac√≠o
  Or env√≠a una solicitud con targetType: "processes" y assetIds no vac√≠o
  Then el sistema rechaza la solicitud con error 400
  And muestra mensaje: "Una revisi√≥n no puede evaluar activos y procesos simult√°neamente. Seleccione un solo tipo de objetivo."
```

### Feature: Creaci√≥n de Revisiones de Cumplimiento Internas (Activos)

```gherkin
Scenario: Crear revisi√≥n interna con usuarios de la organizaci√≥n para activos
  Given un "usuario de ORCA" est√° en el m√≥dulo de "Revisiones de Cumplimiento"
  And ha seleccionado "Activos" como tipo de objetivo
  And existen los siguientes recursos:
    | Tipo                      | Nombre                                    |
    | Cuestionario              | "Evaluaci√≥n ISO 27001 - Controles A.8"   |
    | Activos objetivo          | "Servidor-Producci√≥n-01", "Base-Datos-Principal", "Firewall-Perimetral" |
    | Usuarios internos         | "ana.lopez@empresa.com", "carlos.ruiz@empresa.com" |
    | Aprobadores               | "director.ti@empresa.com"                |
  When selecciona "Nueva Revisi√≥n de Cumplimiento"
  And configura la revisi√≥n con los siguientes datos:
    | Campo                      | Valor                                    |
    | T√≠tulo                     | Auditor√≠a Trimestral ISO 27001 Q4 2025   |
    | Tipo de Revisi√≥n           | Interna                                  |
    | Tipo de Objetivo           | Activos                                  |
    | Cuestionarios              | "Evaluaci√≥n ISO 27001 - Controles A.8"   |
    | Activos Objetivo           | "Servidor-Producci√≥n-01", "Base-Datos-Principal", "Firewall-Perimetral" |
    | Usuarios Asignados         | "ana.lopez@empresa.com", "carlos.ruiz@empresa.com" |
    | Aprobadores                | "director.ti@empresa.com"                |
    | Fecha de Inicio            | 2025-12-01                               |
    | Fecha de Vencimiento       | 2025-12-15                               |
    | Estado                     | Pendiente                                |
  And hace clic en "Crear Revisi√≥n"
  Then el sistema crea la revisi√≥n con ID √∫nico y targetType: "assets"
  And genera autom√°ticamente respuestas individuales para cada combinaci√≥n:
    | Usuario                    | Activo                      | Cuestionario                           | Estado      |
    | ana.lopez@empresa.com      | Servidor-Producci√≥n-01      | Evaluaci√≥n ISO 27001 - Controles A.8   | Pendiente   |
    | ana.lopez@empresa.com      | Base-Datos-Principal        | Evaluaci√≥n ISO 27001 - Controles A.8   | Pendiente   |
    | carlos.ruiz@empresa.com    | Firewall-Perimetral         | Evaluaci√≥n ISO 27001 - Controles A.8   | Pendiente   |
  And env√≠a notificaciones internas a los usuarios asignados
  And la revisi√≥n aparece en el dashboard con estado "Pendiente" y progreso "0% (0/3 respuestas)"
```

### Feature: Creaci√≥n de Revisiones de Cumplimiento Internas (Procesos)

```gherkin
Scenario: Crear revisi√≥n interna para evaluar procesos de negocio
  Given un "usuario de ORCA" est√° en el m√≥dulo de "Revisiones de Cumplimiento"
  And ha seleccionado "Procesos" como tipo de objetivo
  And existen los siguientes recursos:
    | Tipo                      | Nombre                                              |
    | Cuestionario              | "Evaluaci√≥n de Madurez de Procesos ITIL"           |
    | Procesos objetivo         | "Gesti√≥n de Cambios", "Gesti√≥n de Incidentes", "Gesti√≥n de Problemas" |
    | Usuarios internos         | "gerente.ti@empresa.com", "analista.procesos@empresa.com" |
    | Aprobadores               | "director.operaciones@empresa.com"                  |
  When configura la revisi√≥n con los siguientes datos:
    | Campo                      | Valor                                              |
    | T√≠tulo                     | Evaluaci√≥n de Madurez ITIL Q4 2025                 |
    | Tipo de Revisi√≥n           | Interna                                            |
    | Tipo de Objetivo           | Procesos                                           |
    | Cuestionarios              | "Evaluaci√≥n de Madurez de Procesos ITIL"          |
    | Procesos Objetivo          | "Gesti√≥n de Cambios", "Gesti√≥n de Incidentes", "Gesti√≥n de Problemas" |
    | Usuarios Asignados         | "gerente.ti@empresa.com", "analista.procesos@empresa.com" |
    | Aprobadores                | "director.operaciones@empresa.com"                  |
    | Fecha de Inicio            | 2025-12-01                                         |
    | Fecha de Vencimiento       | 2025-12-20                                         |
  And hace clic en "Crear Revisi√≥n"
  Then el sistema crea la revisi√≥n con ID √∫nico y targetType: "processes"
  And genera autom√°ticamente respuestas individuales para cada combinaci√≥n proceso √ó usuario:
    | Usuario                         | Proceso                   | Cuestionario                            | Estado      |
    | gerente.ti@empresa.com          | Gesti√≥n de Cambios        | Evaluaci√≥n de Madurez de Procesos ITIL  | Pendiente   |
    | gerente.ti@empresa.com          | Gesti√≥n de Incidentes     | Evaluaci√≥n de Madurez de Procesos ITIL  | Pendiente   |
    | analista.procesos@empresa.com   | Gesti√≥n de Problemas      | Evaluaci√≥n de Madurez de Procesos ITIL  | Pendiente   |
  And env√≠a notificaciones internas a los usuarios asignados
```

```gherkin
Scenario: Usuario interno responde cuestionario de revisi√≥n para un proceso
  Given existe una revisi√≥n "Evaluaci√≥n de Madurez ITIL Q4 2025" con targetType: "processes"
  And "gerente.ti@empresa.com" tiene asignada una respuesta para el proceso "Gesti√≥n de Cambios"
  When "gerente.ti@empresa.com" accede a sus tareas pendientes
  And selecciona "Responder Cuestionario: Gesti√≥n de Cambios"
  And completa las respuestas:
    | Pregunta                                          | Respuesta         | Evidencia                    | Comentarios                |
    | ¬øExiste procedimiento documentado?                | S√≠                | procedimiento_cambios.pdf    | Versi√≥n 3.2 vigente        |
    | Nivel de madurez del proceso (1-5)                | 4                 | -                            | Proceso optimizado         |
    | ¬øSe miden KPIs del proceso?                       | S√≠                | dashboard_kpis.xlsx          | Revisi√≥n mensual           |
  And sube archivos de evidencia
  And hace clic en "Enviar Respuesta"
  Then el sistema calcula el puntaje de cumplimiento autom√°ticamente
  And la respuesta cambia a estado "Enviado" con timestamp
  And se notifica al aprobador "director.operaciones@empresa.com"
```

```gherkin
Scenario: Usuario interno responde cuestionario de revisi√≥n para un activo
  Given existe una revisi√≥n "Auditor√≠a Trimestral ISO 27001 Q4 2025" con targetType: "assets"
  And "ana.lopez@empresa.com" tiene asignada una respuesta para "Servidor-Producci√≥n-01"
  When "ana.lopez@empresa.com" accede a sus tareas pendientes
  And selecciona "Responder Cuestionario: Servidor-Producci√≥n-01"
  And completa las respuestas:
    | Pregunta                                          | Respuesta         | Evidencia                  | Comentarios              |
    | ¬øExiste inventario de activos actualizado?        | S√≠                | inventario_q4.xlsx         | Actualizado mensualmente |
    | Nivel de clasificaci√≥n de informaci√≥n             | Confidencial      | -                          | -                        |
    | Calidad del proceso de gesti√≥n (1-10)             | 8                 | -                          | Mejora continua aplicada |
  And sube archivos de evidencia (3 archivos, 15MB total)
  And hace clic en "Enviar Respuesta"
  Then el sistema calcula el puntaje de cumplimiento autom√°ticamente
  And la respuesta cambia a estado "Enviado" con timestamp
  And se notifica al aprobador "director.ti@empresa.com"
  And el progreso de la revisi√≥n se actualiza: "33% (1/3 respuestas)"
```

### Feature: Creaci√≥n de Revisiones de Cumplimiento Externas

```gherkin
Scenario: Crear revisi√≥n externa e invitar a proveedores por email (para activos)
  Given un "Auditor" est√° en "Nueva Revisi√≥n de Cumplimiento"
  And ha seleccionado "Activos" como tipo de objetivo
  And existen cuestionarios de "Due Diligence de Proveedores"
  And existen activos de tipo "Proveedor Cr√≠tico"
  When selecciona "Tipo de Revisi√≥n: Externa"
  And configura:
    | Campo                      | Valor                                            |
    | T√≠tulo                     | Evaluaci√≥n de Seguridad de Proveedores 2025      |
    | Tipo de Objetivo           | Activos                                          |
    | Cuestionarios              | "Cuestionario de Seguridad para Proveedores"     |
    | Activos Objetivo           | "Proveedor-AWS", "Proveedor-Salesforce"          |
    | Emails Externos            | proveedor1@aws.com, proveedor2@salesforce.com    |
    | Contrase√±a de Acceso       | SecurePass2025!                                  |
    | Aprobadores Internos       | auditor.interno@empresa.com                      |
    | Fecha de Inicio            | 2025-12-05                                       |
    | Fecha de Vencimiento       | 2025-12-20                                       |
  And hace clic en "Crear y Enviar Invitaciones"
  Then el sistema crea la revisi√≥n con reviewType: "external" y targetType: "assets"
  And genera respuestas individuales para cada proveedor
  And env√≠a emails de invitaci√≥n a los proveedores externos con:
    | Elemento del Email          | Contenido                                        |
    | Asunto                      | "Invitaci√≥n: Evaluaci√≥n de Seguridad de Proveedores 2025" |
    | Cuerpo                      | Enlace √∫nico a formulario externo, contrase√±a de acceso |
    | Enlace                      | https://app.ejemplo.com/compliance/external/[reviewId] |
    | Fecha de Vencimiento        | 2025-12-20                                       |
    | Instrucciones               | C√≥mo acceder y completar el cuestionario         |
  And los proveedores NO requieren cuenta en el sistema
  And los proveedores acceden con la contrase√±a proporcionada
```

```gherkin
Scenario: Crear revisi√≥n externa para evaluar procesos de terceros
  Given un "Auditor" est√° en "Nueva Revisi√≥n de Cumplimiento"
  And ha seleccionado "Procesos" como tipo de objetivo
  And existen cuestionarios de "Evaluaci√≥n de Procesos de Terceros"
  And existen procesos de tipo "Proceso Tercerizado"
  When selecciona "Tipo de Revisi√≥n: Externa"
  And configura:
    | Campo                      | Valor                                            |
    | T√≠tulo                     | Evaluaci√≥n de Procesos Tercerizados 2025         |
    | Tipo de Objetivo           | Procesos                                         |
    | Cuestionarios              | "Evaluaci√≥n de Procesos de Terceros"             |
    | Procesos Objetivo          | "Soporte Nivel 1 (Tercerizado)", "Mesa de Ayuda (Tercerizado)" |
    | Emails Externos            | supervisor@tercero.com                           |
    | Contrase√±a de Acceso       | ProcessEval2025!                                 |
    | Aprobadores Internos       | auditor.interno@empresa.com                      |
    | Fecha de Inicio            | 2025-12-05                                       |
    | Fecha de Vencimiento       | 2025-12-20                                       |
  And hace clic en "Crear y Enviar Invitaciones"
  Then el sistema crea la revisi√≥n con reviewType: "external" y targetType: "processes"
  And genera respuestas individuales para cada proceso √ó email externo
```

```gherkin
Scenario: Usuario externo responde cuestionario sin autenticaci√≥n
  Given un proveedor recibe invitaci√≥n para "Evaluaci√≥n de Seguridad de Proveedores 2025"
  When el proveedor abre el enlace del email
  And ingresa la contrase√±a de acceso "SecurePass2025!"
  And el sistema valida la contrase√±a
  Then muestra el formulario de cuestionario externo con:
    | Elemento                    | Estado                                           |
    | Nombre de la Revisi√≥n       | "Evaluaci√≥n de Seguridad de Proveedores 2025"    |
    | Activo Asignado             | "Proveedor-AWS" (nombre visible)                 |
    | Cuestionario                | "Cuestionario de Seguridad para Proveedores"     |
    | Fecha de Vencimiento        | 2025-12-20                                       |
  When el proveedor completa todas las preguntas obligatorias
  And sube certificaciones de seguridad (PDFs de ISO 27001, SOC 2)
  And hace clic en "Enviar Respuesta"
  Then el sistema guarda la respuesta con estado "Enviado"
  And notifica a los aprobadores internos
  And muestra mensaje de confirmaci√≥n al proveedor
  And el proveedor NO puede editar la respuesta despu√©s de enviarla
```

### Feature: Aprobaci√≥n y Rechazo de Respuestas

```gherkin
Scenario: Aprobador revisa y aprueba respuesta de cuestionario
  Given existe una respuesta "Enviado" para "Servidor-Producci√≥n-01"
  And el usuario actual es aprobador de la revisi√≥n
  When el aprobador accede a "Respuestas Pendientes de Aprobaci√≥n"
  And selecciona la respuesta de "ana.lopez@empresa.com" para "Servidor-Producci√≥n-01"
  Then el sistema muestra:
    | Informaci√≥n                  | Detalle                                          |
    | Usuario que respondi√≥        | ana.lopez@empresa.com                            |
    | Activo evaluado              | Servidor-Producci√≥n-01                           |
    | Fecha de env√≠o               | 2025-12-03 10:30 AM                              |
    | Puntaje de cumplimiento      | 85% (Sobresaliente)                              |
    | Respuestas completas         | 12/12                                            |
    | Archivos de evidencia        | 3 archivos (inventario_q4.xlsx, procedimiento.pdf, captura.png) |
  And el aprobador revisa cada respuesta y evidencia
  And hace clic en "Aprobar Respuesta"
  Then el sistema cambia el estado a "Aprobado"
  And registra el timestamp de aprobaci√≥n y el aprobador
  And notifica al usuario que su respuesta fue aprobada
  And el progreso de la revisi√≥n se actualiza
```

```gherkin
Scenario: Aprobador revisa respuesta de evaluaci√≥n de proceso
  Given existe una respuesta "Enviado" para el proceso "Gesti√≥n de Cambios"
  And la revisi√≥n tiene targetType: "processes"
  And el usuario actual es aprobador de la revisi√≥n
  When el aprobador accede a "Respuestas Pendientes de Aprobaci√≥n"
  And selecciona la respuesta para "Gesti√≥n de Cambios"
  Then el sistema muestra:
    | Informaci√≥n                  | Detalle                                          |
    | Usuario que respondi√≥        | gerente.ti@empresa.com                           |
    | Proceso evaluado             | Gesti√≥n de Cambios                               |
    | Fecha de env√≠o               | 2025-12-05 14:00                                 |
    | Puntaje de cumplimiento      | 80% (Sobresaliente)                              |
    | Nivel de madurez             | 4 (Gestionado)                                   |
  And el aprobador puede aprobar o rechazar la respuesta
```

```gherkin
Scenario: Aprobador rechaza respuesta con comentarios
  Given existe una respuesta "Enviado" con evidencia insuficiente
  When el aprobador revisa la respuesta
  And detecta que faltan evidencias cr√≠ticas
  And hace clic en "Rechazar Respuesta"
  And proporciona raz√≥n de rechazo: "Falta evidencia de √∫ltima actualizaci√≥n del inventario. Por favor, adjuntar documento actualizado de noviembre 2025."
  And confirma el rechazo
  Then el sistema cambia el estado a "Rechazado"
  And almacena la raz√≥n de rechazo en rejectionReason
  And notifica al usuario con la raz√≥n espec√≠fica del rechazo
  And la respuesta vuelve a estado "Pendiente" para que el usuario la corrija
  And el usuario puede editar y reenviar la respuesta
```

### Feature: An√°lisis Autom√°tico con IA (Identificaci√≥n de Riesgos, Incidentes, Deficiencias)

```gherkin
Scenario: IA identifica riesgos a partir de respuestas deficientes de cuestionario (Activos)
  Given existe una revisi√≥n "Auditor√≠a ISO 27001 Q4 2025" completada con targetType: "assets"
  And una respuesta para "Servidor-Base-Datos-Principal" tiene las siguientes respuestas:
    | Pregunta                                        | Respuesta         | Puntaje |
    | ¬øExiste pol√≠tica de control de acceso?          | No                | 0       |
    | ¬øSe realizan backups diarios?                   | No                | 0       |
    | ¬øExiste cifrado de datos en reposo?             | No                | 0       |
    | Nivel de cumplimiento de parches de seguridad   | Bajo (1/10)       | 10      |
  And el puntaje de cumplimiento calculado es 10% (Deficiente)
  And el cuestionario tiene configurado autoAssetCreation para tipo "Riesgo"
  When un aprobador aprueba la respuesta
  And el sistema dispara el an√°lisis de IA
  Then la IA analiza las respuestas y el contexto del activo
  And identifica que m√∫ltiples controles cr√≠ticos est√°n ausentes
  And genera autom√°ticamente los siguientes riesgos:
    | Riesgo Identificado                                      | Probabilidad | Impacto | Activo Vinculado              |
    | Riesgo de acceso no autorizado a base de datos          | Alta         | Cr√≠tico | Servidor-Base-Datos-Principal |
    | Riesgo de p√©rdida de datos por falta de backups         | Alta         | Alto    | Servidor-Base-Datos-Principal |
    | Riesgo de exfiltraci√≥n de datos por falta de cifrado    | Media        | Cr√≠tico | Servidor-Base-Datos-Principal |
  And crea activos de tipo "Riesgo" en el sistema con propiedades:
    | Propiedad                  | Valor                                             |
    | Nombre                     | "Riesgo de acceso no autorizado a base de datos"  |
    | Descripci√≥n                | Generada por IA basada en respuestas del cuestionario |
    | Causa Ra√≠z                 | "Ausencia de pol√≠tica de control de acceso"       |
    | Probabilidad               | Alta                                              |
    | Impacto                    | Cr√≠tico                                           |
    | Nivel de Riesgo Inherente  | Cr√≠tico                                           |
    | Activo Vinculado           | Servidor-Base-Datos-Principal                     |
    | Fuente                     | Revisi√≥n de Cumplimiento: "Auditor√≠a ISO 27001 Q4 2025" |
  And notifica al Gestor de Riesgos sobre los nuevos riesgos identificados
  And vincula los riesgos creados a la respuesta del cuestionario
```

```gherkin
Scenario: IA identifica riesgos a partir de respuestas deficientes de cuestionario (Procesos)
  Given existe una revisi√≥n "Evaluaci√≥n de Madurez ITIL Q4 2025" con targetType: "processes"
  And una respuesta para el proceso "Gesti√≥n de Incidentes" tiene las siguientes respuestas:
    | Pregunta                                              | Respuesta         | Puntaje |
    | ¬øExiste procedimiento documentado?                    | No                | 0       |
    | ¬øSe registran todos los incidentes?                   | Parcial           | 5       |
    | ¬øExiste escalamiento definido?                        | No                | 0       |
    | Nivel de madurez del proceso (1-5)                    | 1                 | 20      |
  And el puntaje de cumplimiento calculado es 25% (Deficiente)
  When un aprobador aprueba la respuesta
  And el sistema dispara el an√°lisis de IA
  Then la IA analiza las respuestas y el contexto del proceso
  And genera autom√°ticamente los siguientes riesgos:
    | Riesgo Identificado                                          | Probabilidad | Impacto | Proceso Vinculado        |
    | Riesgo de incidentes no gestionados adecuadamente           | Alta         | Alto    | Gesti√≥n de Incidentes    |
    | Riesgo de escalamiento tard√≠o por falta de procedimiento    | Alta         | Cr√≠tico | Gesti√≥n de Incidentes    |
  And crea activos de tipo "Riesgo" vinculados al proceso evaluado
  And notifica al Gestor de Riesgos sobre los nuevos riesgos identificados
```

```gherkin
Scenario: IA identifica incidentes a partir de respuestas que reportan eventos de seguridad
  Given existe un cuestionario de "Post-Mortem de Incidentes"
  And una respuesta indica:
    | Pregunta                                      | Respuesta                                         |
    | ¬øOcurri√≥ un incidente de seguridad?           | S√≠                                                |
    | Descripci√≥n del incidente                     | "Intento de acceso no autorizado detectado el 15/11/2025" |
    | Impacto del incidente                         | Alto (interrupci√≥n de servicio por 2 horas)       |
    | Tiempo de resoluci√≥n                          | 2 horas                                           |
  And el cuestionario tiene configurado autoAssetCreation para tipo "Incidente"
  When la respuesta es aprobada
  And el sistema ejecuta an√°lisis de IA
  Then la IA detecta que se report√≥ un incidente real
  And crea autom√°ticamente un activo de tipo "Incidente" con:
    | Propiedad                  | Valor                                             |
    | T√≠tulo                     | "Incidente: Intento de acceso no autorizado"      |
    | Descripci√≥n                | Extra√≠da de las respuestas del cuestionario       |
    | Severidad                  | Alta                                              |
    | Impacto Calculado          | Alto                                              |
    | Activo/Proceso Afectado    | Elemento evaluado en el cuestionario (seg√∫n targetType) |
    | Fecha del Incidente        | 15/11/2025                                        |
    | Tiempo de Resoluci√≥n       | 2 horas                                           |
    | Estado                     | Resuelto                                          |
    | Fuente                     | Revisi√≥n de Cumplimiento                          |
  And notifica al Gestor de Incidentes
```

```gherkin
Scenario: IA identifica deficiencias (hallazgos) a partir de cumplimiento parcial
  Given existe una respuesta con puntaje de cumplimiento 55% (Aceptable, pero no Sobresaliente)
  And el cuestionario tiene configurado autoAssetCreation para tipo "Hallazgo"
  And las respuestas indican:
    | Pregunta                                        | Respuesta           |
    | ¬øExiste documentaci√≥n de procedimientos?        | S√≠ (pero desactualizada desde 2023) |
    | ¬øSe realizan auditor√≠as internas?               | S√≠ (cada 2 a√±os, deber√≠a ser anual) |
    | ¬øHay programa de capacitaci√≥n?                  | Parcial (solo para gerentes)        |
  When la IA analiza las respuestas
  Then identifica deficiencias (no cr√≠ticas, pero requieren atenci√≥n):
    | Deficiencia Identificada                                  | Impacto  | Recomendaci√≥n                              |
    | Documentaci√≥n de procedimientos desactualizada            | Medio    | Actualizar documentaci√≥n al menos anualmente |
    | Frecuencia de auditor√≠as internas insuficiente            | Medio    | Implementar auditor√≠as anuales              |
    | Programa de capacitaci√≥n incompleto                       | Bajo     | Extender capacitaci√≥n a todos los niveles   |
  And crea activos de tipo "Hallazgo/Deficiencia" con:
    | Propiedad                  | Valor                                             |
    | Nombre                     | "Documentaci√≥n de procedimientos desactualizada"  |
    | Clasificaci√≥n              | Oportunidad de Mejora                             |
    | Gravedad                   | Media                                             |
    | Recomendaci√≥n              | Generada por IA                                   |
    | Activo/Proceso Vinculado   | Elemento evaluado (seg√∫n targetType de la revisi√≥n) |
    | Fuente                     | Revisi√≥n de Cumplimiento                          |
```

```gherkin
Scenario: IA sugiere controles para mitigar riesgos identificados
  Given la IA identific√≥ el riesgo "Riesgo de acceso no autorizado a base de datos"
  When el Gestor de Riesgos revisa el riesgo creado autom√°ticamente
  Then el riesgo incluye una secci√≥n "Controles Sugeridos por IA":
    | Control Sugerido                                          | Tipo                 |
    | Implementar autenticaci√≥n multifactor para acceso a BD    | Control Preventivo   |
    | Configurar auditor√≠a de logs de acceso a base de datos    | Control Detectivo    |
    | Pol√≠tica de revisi√≥n trimestral de permisos de acceso     | Control Correctivo   |
  And el Gestor puede vincular controles existentes o crear nuevos basados en las sugerencias
  And el sistema calcula el Nivel de Riesgo Residual al vincular controles
```

### Feature: Revisiones de Cumplimiento Recurrentes (Automatizaci√≥n)

```gherkin
Scenario: Configurar revisi√≥n trimestral recurrente para activos
  Given un "Director de Cumplimiento" est√° creando una nueva revisi√≥n
  And ha seleccionado "Activos" como tipo de objetivo
  And configura los datos b√°sicos de la revisi√≥n
  When activa "Recurrencia" y configura:
    | Par√°metro                  | Valor                                            |
    | Frecuencia                 | Trimestral (cada 3 meses)                        |
    | Intervalo                  | 1 (cada trimestre)                               |
    | Fecha de Fin de Recurrencia| 2026-12-31                                       |
    | M√°ximo de Ocurrencias      | 4 (4 trimestres en 2026)                         |
  And guarda la revisi√≥n
  Then el sistema marca la revisi√≥n con recurrence.enabled = true
  And calcula la pr√≥xima fecha de generaci√≥n autom√°tica
  And almacena la configuraci√≥n de recurrencia:
    | Campo                      | Valor                                            |
    | frequency                  | quarterly                                        |
    | interval                   | 1                                                |
    | endDate                    | 2026-12-31                                       |
    | maxOccurrences             | 4                                                |
    | nextScheduledDate          | 2026-03-01 (3 meses despu√©s del inicio)          |
```

```gherkin
Scenario: Configurar revisi√≥n mensual recurrente para procesos
  Given un "Director de Cumplimiento" est√° creando una nueva revisi√≥n
  And ha seleccionado "Procesos" como tipo de objetivo
  And configura los datos b√°sicos de la revisi√≥n para evaluar procesos cr√≠ticos
  When activa "Recurrencia" y configura:
    | Par√°metro                  | Valor                                            |
    | Frecuencia                 | Mensual                                          |
    | Intervalo                  | 1 (cada mes)                                     |
    | Fecha de Fin de Recurrencia| 2026-06-30                                       |
    | M√°ximo de Ocurrencias      | 6                                                |
  And guarda la revisi√≥n
  Then el sistema crea la revisi√≥n con targetType: "processes" y recurrence.enabled = true
  And la recurrencia generar√° nuevas revisiones manteniendo el targetType: "processes"
```

```gherkin
Scenario: Sistema genera autom√°ticamente la siguiente revisi√≥n recurrente
  Given existe una revisi√≥n "Auditor√≠a ISO 27001 Q4 2025" con recurrencia trimestral
  And la revisi√≥n tiene targetType: "assets"
  And la revisi√≥n est√° en estado "Completado"
  And la fecha actual es 2026-03-01 (nextScheduledDate)
  When el sistema ejecuta el proceso de recurrencia programado (cron job o scheduler)
  Then el sistema verifica que shouldGenerateNext() = true
  And genera autom√°ticamente una nueva revisi√≥n:
    | Campo                      | Valor Original                                   | Valor Nueva Revisi√≥n                      |
    | T√≠tulo                     | Auditor√≠a ISO 27001 Q4 2025                      | Auditor√≠a ISO 27001 Q4 2025 (Recurrente)  |
    | Tipo de Objetivo           | assets                                           | assets (se mantiene igual)                |
    | Cuestionarios              | Mismo(s) cuestionario(s)                         | Mismo(s) cuestionario(s)                  |
    | Activos Objetivo           | Mismos activos                                   | Mismos activos                            |
    | Usuarios Asignados         | Mismos usuarios                                  | Mismos usuarios                           |
    | Aprobadores                | Mismos aprobadores                               | Mismos aprobadores                        |
    | Fecha de Inicio            | 2025-12-01                                       | 2026-03-01                                |
    | Fecha de Vencimiento       | 2025-12-15 (duraci√≥n: 14 d√≠as)                   | 2026-03-15 (misma duraci√≥n: 14 d√≠as)      |
    | Estado                     | Completado                                       | Pendiente                                 |
  And actualiza la revisi√≥n original con:
    | Campo                      | Valor Actualizado                                |
    | lastGeneratedDate          | 2026-03-01                                       |
    | nextScheduledDate          | 2026-06-01 (pr√≥ximo trimestre)                   |
  And env√≠a notificaciones a los usuarios asignados de la nueva revisi√≥n
  And el contador de ocurrencias se incrementa (1/4)
```

```gherkin
Scenario: Revisi√≥n recurrente alcanza m√°ximo de ocurrencias y se detiene
  Given existe una revisi√≥n recurrente trimestral con maxOccurrences = 4
  And se han generado autom√°ticamente 3 revisiones (Q1, Q2, Q3 de 2026)
  And la cuarta revisi√≥n (Q4 2026) acaba de completarse
  When el sistema eval√∫a si debe generar la siguiente
  Then verifica que se alcanz√≥ maxOccurrences (4 de 4)
  And shouldGenerateNext() retorna false
  And NO genera una quinta revisi√≥n
  And marca la recurrencia como "Completada"
  And notifica al creador de la revisi√≥n que la serie recurrente finaliz√≥
```

## üîÑ Flujo de Usuario

<ZoomableDiagram
  title="Flujo Completo de Revisiones de Cumplimiento"
  height="1100px"
  chart={`graph TD
    subgraph "Creaci√≥n de Revisi√≥n"
        Start[Usuario selecciona<br/>Nueva Revisi√≥n] --> SelectTargetType{Seleccionar Tipo<br/>de Objetivo}
        SelectTargetType -->|Activos| ConfigAssets[Configurar para Activos]
        SelectTargetType -->|Procesos| ConfigProcesses[Configurar para Procesos]

        ConfigAssets --> ReviewType{Tipo de<br/>Revisi√≥n}
        ConfigProcesses --> ReviewType

        ReviewType -->|Interna| ConfigInternal[Configurar Revisi√≥n Interna]
        ReviewType -->|Externa| ConfigExternal[Configurar Revisi√≥n Externa]

        ConfigInternal --> SelectQuestionnaires[Seleccionar Cuestionarios]
        ConfigExternal --> SelectQuestionnaires
        SelectQuestionnaires --> SelectTargets{Tipo de<br/>Objetivo?}
        SelectTargets -->|Activos| SelectAssets[Seleccionar Activos Objetivo]
        SelectTargets -->|Procesos| SelectProcesses[Seleccionar Procesos Objetivo]
        SelectAssets --> ConfigUsers[Asignar Usuarios<br/>y Aprobadores]
        SelectProcesses --> ConfigUsers
        ConfigUsers --> SetDates[Definir Fechas Inicio/Vencimiento]
        SetDates --> ConfigRecurrence{¬øConfigurar<br/>Recurrencia?}
        ConfigRecurrence -->|S√≠| SetRecurrence[Configurar Frecuencia,<br/>Intervalo, Fecha Fin]
        ConfigRecurrence -->|No| ValidateTargetType{Validar que NO<br/>mezcle Activos<br/>y Procesos}
        SetRecurrence --> ValidateTargetType
        ValidateTargetType -->|V√°lido| CreateReview[Crear Revisi√≥n]
        ValidateTargetType -->|Inv√°lido| ShowError[Mostrar Error:<br/>No mezclar tipos]
        ShowError --> SelectTargetType
        CreateReview --> GenerateResponses[Generar Respuestas Individuales<br/>por cada Objetivo x Usuario]
        GenerateResponses --> SendNotifications{Tipo}
        SendNotifications -->|Interna| NotifyInternal[Notificar Usuarios Internos]
        SendNotifications -->|Externa| SendEmails[Enviar Emails de Invitaci√≥n<br/>con Enlace y Contrase√±a]
    end

    subgraph "Respuesta a Cuestionarios"
        NotifyInternal --> UserAccess[Usuario accede a Tarea Pendiente]
        SendEmails --> ExternalAccess[Usuario Externo abre Enlace]
        ExternalAccess --> ValidatePassword[Validar Contrase√±a de Acceso]
        ValidatePassword --> ShowQuestionnaire[Mostrar Formulario<br/>de Cuestionario]
        UserAccess --> ShowQuestionnaire
        ShowQuestionnaire --> ShowTarget{Mostrar Objetivo}
        ShowTarget -->|Activos| ShowAsset[Mostrar Activo a Evaluar]
        ShowTarget -->|Procesos| ShowProcess[Mostrar Proceso a Evaluar]
        ShowAsset --> AnswerQuestions[Completar Respuestas]
        ShowProcess --> AnswerQuestions
        AnswerQuestions --> UploadEvidence[Subir Archivos de Evidencia<br/>Opcional]
        UploadEvidence --> SubmitResponse[Enviar Respuesta]
        SubmitResponse --> CalculateScore[Calcular Puntaje de<br/>Cumplimiento Autom√°ticamente]
        CalculateScore --> SetStatusSubmitted[Estado: Enviado]
        SetStatusSubmitted --> NotifyApprovers[Notificar Aprobadores]
    end

    subgraph "Aprobaci√≥n de Respuestas"
        NotifyApprovers --> ApproverReview[Aprobador Revisa Respuesta]
        ApproverReview --> ReviewEvidence[Revisar Respuestas<br/>y Evidencias]
        ReviewEvidence --> ApprovalDecision{Decisi√≥n}
        ApprovalDecision -->|Aprobar| ApproveResponse[Aprobar Respuesta]
        ApprovalDecision -->|Rechazar| RejectResponse[Rechazar con Raz√≥n]
        ApproveResponse --> TriggerAI[Disparar An√°lisis de IA]
        RejectResponse --> NotifyUser[Notificar Usuario<br/>con Raz√≥n de Rechazo]
        NotifyUser --> UserAccess
    end

    subgraph "An√°lisis Autom√°tico con IA"
        TriggerAI --> AIAnalysis[IA Analiza Respuestas<br/>y Contexto del Objetivo]
        AIAnalysis --> EvaluateCompliance{Evaluar<br/>Cumplimiento}
        EvaluateCompliance -->|Deficiente<br/>0-30%| IdentifyRisks[Identificar Riesgos Cr√≠ticos]
        EvaluateCompliance -->|Aceptable<br/>31-70%| IdentifyFindings[Identificar Deficiencias<br/>y Oportunidades de Mejora]
        EvaluateCompliance -->|Sobresaliente<br/>71-100%| NoIssues[No se generan hallazgos]
        EvaluateCompliance -->|Incidente<br/>Reportado| IdentifyIncidents[Identificar y Crear Incidente]

        IdentifyRisks --> LinkToTarget{Vincular a<br/>Objetivo}
        IdentifyFindings --> LinkToTarget
        IdentifyIncidents --> LinkToTarget
        LinkToTarget -->|Activos| CreateAssetLinked[Crear Hallazgo<br/>vinculado a Activo]
        LinkToTarget -->|Procesos| CreateProcessLinked[Crear Hallazgo<br/>vinculado a Proceso]

        CreateAssetLinked --> SuggestControls[IA Sugiere Controles<br/>Mitigantes]
        CreateProcessLinked --> SuggestControls
        SuggestControls --> NotifyManagers[Notificar Gestores<br/>Correspondientes]
    end

    subgraph "Gesti√≥n de Recurrencia (Automatizada)"
        CreateReview --> CheckRecurrence{¬øRecurrencia<br/>Habilitada?}
        CheckRecurrence -->|S√≠| ScheduleNext[Programar Pr√≥xima<br/>Generaci√≥n Autom√°tica]
        CheckRecurrence -->|No| EndFlow[Fin]
        ScheduleNext --> ReviewCompleted{Revisi√≥n<br/>Completada?}
        ReviewCompleted -->|No| WaitCompletion[Esperar Completitud]
        ReviewCompleted -->|S√≠| CheckSchedule{Fecha<br/>nextScheduledDate<br/>alcanzada?}
        CheckSchedule -->|No| WaitSchedule[Esperar Fecha]
        CheckSchedule -->|S√≠| ValidateRecurrence{Validar<br/>Condiciones}
        ValidateRecurrence --> CheckEndDate{¬øendDate<br/>alcanzado?}
        ValidateRecurrence --> CheckMaxOccurrences{¬ømaxOccurrences<br/>alcanzado?}
        CheckEndDate -->|S√≠| StopRecurrence[Detener Recurrencia]
        CheckMaxOccurrences -->|S√≠| StopRecurrence
        CheckEndDate -->|No| GenerateNextReview[Generar Nueva Revisi√≥n<br/>con mismo targetType]
        CheckMaxOccurrences -->|No| GenerateNextReview
        GenerateNextReview --> CopyConfiguration[Copiar Configuraci√≥n<br/>Original incl. targetType]
        CopyConfiguration --> CalculateNewDates[Calcular Nuevas Fechas<br/>Inicio/Vencimiento]
        CalculateNewDates --> UpdateOriginal[Actualizar Revisi√≥n Original<br/>lastGeneratedDate, nextScheduledDate]
        UpdateOriginal --> GenerateResponses
        StopRecurrence --> NotifyCreator[Notificar Creador:<br/>Serie Recurrente Completada]
    end

    style Start stroke:#4caf50,stroke-width:2px
    style SelectTargetType stroke:#ff5722,stroke-width:3px
    style ValidateTargetType stroke:#ff5722,stroke-width:2px
    style CreateReview stroke:#2196f3,stroke-width:3px
    style AIAnalysis stroke:#9c27b0,stroke-width:3px,stroke-dasharray: 5 5
    style LinkToTarget stroke:#673ab7,stroke-width:2px
    style CreateAssetLinked stroke:#f44336,stroke-width:2px
    style CreateProcessLinked stroke:#ff9800,stroke-width:2px
    style GenerateNextReview stroke:#00bcd4,stroke-width:3px,stroke-dasharray: 5 5
    style ApproveResponse stroke:#4caf50,stroke-width:2px
    style RejectResponse stroke:#f44336,stroke-width:2px
  `}
/>

## üé® Mockups / Dise√±os

Dise√±os disponibles en Figma (Pendientes de revisi√≥n por UX/UI Designer: Alan Franco)

## üì° Documentaci√≥n T√©cnica Relacionada

### API Endpoints

```typescript
// Revisiones de Cumplimiento - CRUD
POST   /api/compliance/reviews                    // Crear revisi√≥n (interna o externa)
GET    /api/compliance/reviews                    // Listar todas las revisiones
GET    /api/compliance/reviews/:id                // Obtener revisi√≥n por ID
PUT    /api/compliance/reviews/:id                // Actualizar revisi√≥n
DELETE /api/compliance/reviews/:id                // Eliminar revisi√≥n

// Query params para filtrar por tipo de objetivo
GET    /api/compliance/reviews?targetType=assets      // Solo revisiones de activos
GET    /api/compliance/reviews?targetType=processes   // Solo revisiones de procesos

// Respuestas Individuales de Objetivos (Activos o Procesos)
POST   /api/compliance/individual-responses       // Crear/Actualizar respuesta de cuestionario
GET    /api/compliance/individual-responses?reviewId=xxx&targetId=xxx&questionnaireTemplateId=xxx
PUT    /api/compliance/individual-responses/:responseId
POST   /api/compliance/individual-responses/:responseId/submit   // Enviar respuesta
GET    /api/compliance/individual-responses/:responseId/progress // Progreso de respuesta

// Aprobaci√≥n/Rechazo de Respuestas
POST   /api/asset-questionnaire-responses/:id/approve
  Body: { targetId, targetType, questionnaireTemplateId }
POST   /api/asset-questionnaire-responses/:id/reject
  Body: { targetId, targetType, questionnaireTemplateId, reason }

// An√°lisis con IA
POST   /api/asset-questionnaire-responses/:id/ai-analysis
  Body: { targetId, targetType, questionnaireTemplateId }
  Response: {
    risksIdentified: Risk[],
    incidentsIdentified: Incident[],
    findingsIdentified: Finding[],
    controlsSuggested: Control[]
  }

// Revisiones Externas (Acceso P√∫blico)
GET    /api/compliance/external/:reviewId/access
  Query: { password }
  Response: { authorized: boolean, reviewData }
GET    /api/compliance/external/:reviewId/data
  Response: { review, questionnaires, targets (assets o processes seg√∫n targetType) }
POST   /api/compliance/external/:reviewId/response/:responseId
  Body: { answers, evidenceFiles }

// Invitaciones Externas
POST   /api/compliance/external/send-invitation
  Body: {
    reviewId,
    reviewTitle,
    dueDate,
    accessPassword,
    recipientEmail,
    senderName,
    companyName
  }
  Response: { success, messageId }

// Recurrencia (Procesamiento Autom√°tico)
POST   /api/compliance/reviews/process-recurrence  // Endpoint para cron job
  Response: { created: ComplianceReview[], updated: ComplianceReview[] }

// Validaci√≥n de tipo de objetivo
POST   /api/compliance/reviews/validate
  Body: { targetType, targetAssetIds, targetProcessIds }
  Response: { valid: boolean, error?: string }
```

### Reglas de Negocio

1. **Tipo de Objetivo (NUEVA REGLA - CR√çTICA)**:
   - Cada revisi√≥n debe tener un **√∫nico tipo de objetivo**: `assets` (activos) o `processes` (procesos)
   - **NO es posible mezclar activos y procesos en una misma revisi√≥n**
   - Si `targetType = 'assets'`:
     - Solo se puede poblar `targetAssetIds` (array de IDs de activos)
     - `targetProcessIds` debe estar vac√≠o o no existir
   - Si `targetType = 'processes'`:
     - Solo se puede poblar `targetProcessIds` (array de IDs de procesos)
     - `targetAssetIds` debe estar vac√≠o o no existir
   - El sistema debe validar esta restricci√≥n tanto en frontend como en backend
   - Error de validaci√≥n: "Una revisi√≥n no puede evaluar activos y procesos simult√°neamente. Seleccione un solo tipo de objetivo."

2. **Tipos de Revisiones**:
   - **Interna**: Requiere usuarios internos asignados (assignedToUserIds)
   - **Externa**: Requiere emails externos (externalEmails) y contrase√±a de acceso (accessPassword, m√≠nimo 6 caracteres)
   - Ambos tipos requieren al menos un aprobador (approverUserIds)
   - Ambos tipos deben especificar un √∫nico targetType

3. **Generaci√≥n de Respuestas Individuales**:
   - Por cada revisi√≥n creada, el sistema genera autom√°ticamente respuestas individuales
   - F√≥rmula para activos: `# Respuestas = # Cuestionarios √ó # Activos Objetivo √ó # Usuarios`
   - F√≥rmula para procesos: `# Respuestas = # Cuestionarios √ó # Procesos Objetivo √ó # Usuarios`
   - Ejemplo (activos): 2 cuestionarios √ó 3 activos √ó 2 usuarios = 12 respuestas individuales
   - Ejemplo (procesos): 1 cuestionario √ó 4 procesos √ó 3 usuarios = 12 respuestas individuales
   - Cada respuesta tiene su propio ciclo de vida independiente

4. **Estados de Revisi√≥n (ReviewStatus)**:
   - `PENDING`: Revisi√≥n creada, respuestas no completadas
   - `IN_PROGRESS`: Al menos una respuesta enviada
   - `COMPLETED`: Todas las respuestas aprobadas
   - `OVERDUE`: Fecha de vencimiento pasada con respuestas pendientes

5. **Estados de Respuesta (ResponseLifecycleStatus)**:
   - `PENDING`: Respuesta generada, no completada
   - `DRAFT`: Usuario guard√≥ borrador (parcialmente completada)
   - `SUBMITTED`: Usuario envi√≥ respuesta, pendiente de aprobaci√≥n
   - `APPROVED`: Aprobador aprob√≥ la respuesta
   - `REJECTED`: Aprobador rechaz√≥, requiere correcci√≥n
   - `REVISED`: Usuario reenvi√≥ despu√©s de rechazo

6. **C√°lculo de Cumplimiento**:
   - El sistema calcula autom√°ticamente el puntaje al enviar la respuesta
   - Basado en scores de opciones de preguntas (para SINGLE_SELECT, MULTI_SELECT, etc.)
   - F√≥rmula: `(Puntaje Obtenido / Puntaje M√°ximo Posible) √ó 100`
   - Se asigna ComplianceStatus seg√∫n umbrales:
     - `DEFICIENT`: 0-30%
     - `ACCEPTABLE`: 31-70%
     - `OUTSTANDING`: 71-100%

7. **An√°lisis de IA (Auto-Creaci√≥n de Activos)**:
   - Se ejecuta autom√°ticamente al aprobar una respuesta
   - Requiere que el cuestionario tenga configurado `autoAssetCreation.enabled = true`
   - La IA eval√∫a seg√∫n el tipo de activo a crear (assetTypeId):
     - **Riesgos**: Identifica si hay deficiencias en controles, exposiciones no controladas, vulnerabilidades
     - **Incidentes**: Identifica si se reportan eventos de seguridad, interrupciones, brechas
     - **Hallazgos/Deficiencias**: Identifica oportunidades de mejora, cumplimiento parcial
   - Solo crea activos si el an√°lisis detecta hallazgos relevantes (no crea innecesariamente)
   - Los activos creados se vinculan autom√°ticamente al **activo o proceso evaluado** seg√∫n el `targetType` de la revisi√≥n

8. **Evidencias**:
   - Usuarios pueden subir m√∫ltiples archivos de evidencia por pregunta
   - Tipos soportados: PDF, Word, Excel, Im√°genes, Texto
   - Tama√±o m√°ximo por archivo: 50MB
   - Almacenamiento: Firebase Storage
   - Metadata: nombre original, tama√±o, tipo, fecha de carga

9. **Revisiones Externas**:
   - No requieren autenticaci√≥n de usuario
   - Acceso mediante contrase√±a compartida por email
   - El enlace es √∫nico por revisi√≥n
   - Los usuarios externos NO pueden ver otras respuestas
   - Una vez enviada, la respuesta externa no puede editarse (excepto si es rechazada)

10. **Recurrencia**:
    - Frecuencias soportadas: `daily`, `weekly`, `monthly`, `quarterly`, `yearly`
    - Intervalo: N√∫mero de per√≠odos entre ocurrencias (ej: interval=2, frequency=monthly = cada 2 meses)
    - Condiciones de parada:
      - `endDate`: Fecha l√≠mite para generaci√≥n de nuevas revisiones
      - `maxOccurrences`: N√∫mero m√°ximo de ocurrencias (incluyendo la original)
    - Solo se generan nuevas revisiones si la revisi√≥n anterior est√° en estado `COMPLETED`
    - La duraci√≥n entre fecha de inicio y vencimiento se mantiene constante en todas las ocurrencias
    - **Las revisiones recurrentes mantienen el mismo `targetType` de la revisi√≥n original**

11. **Permisos y Notificaciones**:
    - Usuarios asignados reciben notificaci√≥n al crear la revisi√≥n
    - Aprobadores reciben notificaci√≥n al enviar una respuesta
    - Usuario recibe notificaci√≥n al aprobar/rechazar su respuesta
    - Gestores de Riesgos/Incidentes/Cumplimiento reciben notificaci√≥n cuando IA crea activos autom√°ticamente

### Modelo de Datos

```typescript
// Firestore Collection: complianceReviews
interface ComplianceReview {
  id: string;
  title: string;
  questionnaireTemplateIds: string[];              // Array de IDs de cuestionarios

  // NUEVO: Tipo de objetivo (mutuamente excluyente)
  targetType: 'assets' | 'processes';              // REQUERIDO: Define si eval√∫a activos o procesos
  targetAssetIds?: string[];                       // Solo si targetType = 'assets'. Array de IDs de activos
  targetProcessIds?: string[];                     // Solo si targetType = 'processes'. Array de IDs de procesos

  startDate: string;                               // ISO date
  dueDate: string;                                 // ISO date
  assignedToUserId?: string;                       // LEGACY: Usuario √∫nico (obsoleto)
  assignedToUserIds?: string[];                    // NUEVO: M√∫ltiples usuarios (revisiones internas)
  approverUserIds: string[];                       // Aprobadores (requerido para ambos tipos)
  status: ReviewStatus;                            // PENDING, IN_PROGRESS, COMPLETED, OVERDUE
  createdAt: string;                               // ISO date
  createdBy: string;                               // User UUID
  updatedAt: string;                               // ISO date

  // Campos para revisiones externas
  reviewType: 'internal' | 'external';
  externalEmails?: string[];                       // Emails de usuarios externos
  accessPassword?: string;                         // Contrase√±a para acceso externo

  // Recurrencia
  recurrence?: RecurrenceConfig;
}

interface RecurrenceConfig {
  enabled: boolean;
  frequency: 'daily' | 'weekly' | 'monthly' | 'quarterly' | 'yearly';
  interval: number;                                // Ej: 1 = cada per√≠odo, 2 = cada 2 per√≠odos
  endDate?: string;                                // ISO date - fecha l√≠mite de recurrencia
  maxOccurrences?: number;                         // N√∫mero m√°ximo de ocurrencias
  lastGeneratedDate?: string;                      // ISO date - √∫ltima vez que se gener√≥ autom√°ticamente
  nextScheduledDate?: string;                      // ISO date - pr√≥xima fecha de generaci√≥n autom√°tica
}

// Firestore Collection: complianceReviewResponses (renombrado para mayor claridad)
interface ComplianceReviewResponse {
  id: string;
  complianceReviewId: string;
  questionnaireTemplateId: string;

  // NUEVO: Referencia gen√©rica al objetivo evaluado
  targetType: 'asset' | 'process';                 // Tipo de objetivo de esta respuesta
  targetId: string;                                // ID del activo o proceso siendo evaluado
  // LEGACY (mantener por compatibilidad):
  assetId?: string;                                // Deprecated: usar targetId + targetType

  submittedAt: string | null;                      // ISO date - cuando se envi√≥
  answers: Answer[];
  responseStatus: ResponseLifecycleStatus;         // PENDING, DRAFT, SUBMITTED, APPROVED, REJECTED, REVISED
  rejectionReason?: string | null;                 // Raz√≥n si fue rechazada
  achievedScore?: number | null;                   // Puntaje obtenido
  maxPossibleScore?: number | null;                // Puntaje m√°ximo posible
  overallComplianceScore?: number | null;          // Porcentaje de cumplimiento (0-100)
  complianceStatus?: ComplianceStatus | null;      // DEFICIENT, ACCEPTABLE, OUTSTANDING
  reviewedAt?: string | null;                      // ISO date - cuando se aprob√≥/rechaz√≥
  reviewedBy?: string | null;                      // User UUID del aprobador

  // An√°lisis de IA
  aiAnalysisTriggered?: boolean;                   // Si se ejecut√≥ el an√°lisis de IA
  aiAnalysisDate?: string | null;                  // ISO date - cuando se ejecut√≥ el an√°lisis
  assetsCreatedByAI?: string[];                    // IDs de activos creados por IA (Riesgos, Incidentes, Hallazgos)
}

interface Answer {
  questionId: string;
  response: string | string[] | number | boolean | null;
  comments?: string;

  // Evidencia
  evidenceUrl?: string;                            // LEGACY: URL √∫nica (obsoleto)
  evidenceReference?: string;                      // Referencia externa (ticket, documento)
  evidenceFiles?: EvidenceFile[];                  // Array de archivos de evidencia

  // Cumplimiento
  complianceStatus?: ComplianceStatus | null;
  scoreAchieved?: number | null;
  maxScorePossible?: number | null;
}

interface EvidenceFile {
  id: string;
  name: string;                                    // Nombre original del archivo
  url: string;                                     // URL en Firebase Storage
  size: number;                                    // Tama√±o en bytes
  type: string;                                    // MIME type
  uploadedAt: string;                              // ISO date
}

// NUEVO: Interfaz para Proceso (referencia)
interface Process {
  id: string;
  name: string;
  description?: string;
  owner?: string;                                  // Due√±o del proceso
  category?: string;                               // Categor√≠a (ej: ITIL, ISO, Custom)
  status: 'active' | 'inactive' | 'draft';
  createdAt: string;
  updatedAt: string;
}

enum ReviewStatus {
  PENDING = 'Pending',
  IN_PROGRESS = 'In Progress',
  COMPLETED = 'Completed',
  OVERDUE = 'Overdue'
}

enum ResponseLifecycleStatus {
  PENDING = 'Pending',
  DRAFT = 'Draft',
  SUBMITTED = 'Submitted',
  APPROVED = 'Approved',
  REJECTED = 'Rejected',
  REVISED = 'Revised'
}

enum ComplianceStatus {
  DEFICIENT = 'Deficient',
  ACCEPTABLE = 'Acceptable',
  OUTSTANDING = 'Outstanding'
}

// NUEVO: Tipo de objetivo
enum TargetType {
  ASSETS = 'assets',
  PROCESSES = 'processes'
}
```

### Validaci√≥n de Tipo de Objetivo (Backend)

```typescript
// Ejemplo de validaci√≥n en el servicio de creaci√≥n de revisiones
function validateTargetType(review: CreateComplianceReviewDTO): ValidationResult {
  const { targetType, targetAssetIds, targetProcessIds } = review;

  // Validar que targetType est√© presente
  if (!targetType || !['assets', 'processes'].includes(targetType)) {
    return {
      valid: false,
      error: 'El tipo de objetivo es requerido. Debe ser "assets" o "processes".'
    };
  }

  // Validar consistencia seg√∫n targetType
  if (targetType === 'assets') {
    if (!targetAssetIds || targetAssetIds.length === 0) {
      return {
        valid: false,
        error: 'Debe seleccionar al menos un activo cuando el tipo de objetivo es "assets".'
      };
    }
    if (targetProcessIds && targetProcessIds.length > 0) {
      return {
        valid: false,
        error: 'Una revisi√≥n no puede evaluar activos y procesos simult√°neamente. Seleccione un solo tipo de objetivo.'
      };
    }
  }

  if (targetType === 'processes') {
    if (!targetProcessIds || targetProcessIds.length === 0) {
      return {
        valid: false,
        error: 'Debe seleccionar al menos un proceso cuando el tipo de objetivo es "processes".'
      };
    }
    if (targetAssetIds && targetAssetIds.length > 0) {
      return {
        valid: false,
        error: 'Una revisi√≥n no puede evaluar activos y procesos simult√°neamente. Seleccione un solo tipo de objetivo.'
      };
    }
  }

  return { valid: true };
}
```

## üìù Notas Adicionales

### Equipo

- **Product Owner**: Francisco Puente
- **UX/UI Designer**: Alan Franco
- **Frontend Developers**: Cesar Gonzalez, Juan Martinez
- **Backend Developer**: Josue Cardenas
- **AI/ML Engineer**: (Nuevo rol requerido para an√°lisis inteligente de respuestas)
- **DevOps Engineer**: (Para configuraci√≥n de cron jobs de recurrencia)
- **QA Engineer**: Emmanuel Vazquez

### Alcance

#### ‚úÖ Fase 1 incluye:

- Funcionalidad CRUD completa de Revisiones de Cumplimiento
- **Selecci√≥n de tipo de objetivo: Activos O Procesos (mutuamente excluyentes)**
- **Validaci√≥n que impide mezclar activos y procesos en una revisi√≥n**
- Creaci√≥n de revisiones internas con m√∫ltiples usuarios asignados
- Creaci√≥n de revisiones externas con invitaciones por email
- Generaci√≥n autom√°tica de respuestas individuales (cuestionario √ó objetivo √ó usuario)
- Interfaz de respuesta a cuestionarios con soporte de evidencias m√∫ltiples
- Flujo completo de aprobaci√≥n/rechazo de respuestas
- Notificaciones por email para usuarios externos
- Notificaciones internas para usuarios de la plataforma
- C√°lculo autom√°tico de puntajes de cumplimiento
- Estados de ciclo de vida completos (Pending, Draft, Submitted, Approved, Rejected, Revised)
- **An√°lisis Autom√°tico con IA**:
  - Identificaci√≥n de riesgos a partir de respuestas deficientes
  - Identificaci√≥n de incidentes reportados en cuestionarios
  - Identificaci√≥n de deficiencias/hallazgos de cumplimiento parcial
  - Creaci√≥n autom√°tica de activos (Riesgos, Incidentes, Hallazgos) vinculados al activo o proceso evaluado
  - Sugerencias de controles mitigantes para riesgos
  - Sugerencias de acciones correctivas para deficiencias
- **Recurrencia Automatizada**:
  - Configuraci√≥n de revisiones recurrentes (diaria, semanal, mensual, trimestral, anual)
  - Generaci√≥n autom√°tica de revisiones en fechas programadas (manteniendo el targetType)
  - Condiciones de parada (endDate, maxOccurrences)
  - Servicio de procesamiento de recurrencias (RecurrenceService)
- Portal externo sin autenticaci√≥n para proveedores/terceros
- Dashboard de progreso de revisiones en tiempo real

#### ‚è≥ No incluye (Fase 2):

- Generaci√≥n autom√°tica de reportes de auditor√≠a (PDF/Word)
- Comparaci√≥n de revisiones a lo largo del tiempo (trending de cumplimiento)
- An√°lisis predictivo de cumplimiento futuro basado en hist√≥rico
- Delegaci√≥n de respuestas a otros usuarios
- Sistema de comentarios y discusiones en respuestas
- Exportaci√≥n masiva de respuestas a Excel/CSV
- Dashboard ejecutivo de KPIs de cumplimiento

### Roadmap

| Fase     | Fecha Estimada   | Estado        |
|----------|------------------|---------------|
| Fase 1   | 23/diciembre/2025    | En Desarrollo |
| Fase 2   | 30/enero/2026         | Planificado   |

## üè∑Ô∏è Etiquetas

`compliance` `compliance-reviews` `questionnaires` `audit` `grc` `ai-analysis` `risk-management` `incident-management` `findings` `external-users` `email-invitations` `recurrence` `automation` `approval-workflow` `evidence-management` `assets` `processes` `target-type` `sprint-3` `sprint-4`

---

**√öltima actualizaci√≥n**: 24/12/2024